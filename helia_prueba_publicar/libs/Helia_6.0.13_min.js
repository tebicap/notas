(function (root, factory) {(typeof module === 'object' && module.exports) ? module.exports = factory() : root.Helia = factory()}(typeof self !== 'undefined' ? self : this, function () {
"use strict";var Helia=(()=>{var CN=Object.create;var J1=Object.defineProperty;var PN=Object.getOwnPropertyDescriptor;var kN=Object.getOwnPropertyNames;var ON=Object.getPrototypeOf,RN=Object.prototype.hasOwnProperty;var Wn=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports),Nt=(r,e)=>{for(var t in e)J1(r,t,{get:e[t],enumerable:!0})},Xv=(r,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of kN(e))!RN.call(r,o)&&o!==t&&J1(r,o,{get:()=>e[o],enumerable:!(n=PN(e,o))||n.enumerable});return r};var nr=(r,e,t)=>(t=r!=null?CN(ON(r)):{},Xv(e||!r||!r.__esModule?J1(t,"default",{value:r,enumerable:!0}):t,r)),DN=r=>Xv(J1({},"__esModule",{value:!0}),r);var ax=Wn((cG,m6)=>{"use strict";var fL=Object.prototype.hasOwnProperty,qr="~";function ud(){}Object.create&&(ud.prototype=Object.create(null),new ud().__proto__||(qr=!1));function dL(r,e,t){this.fn=r,this.context=e,this.once=t||!1}function sx(r,e,t,n,o){if(typeof t!="function")throw new TypeError("The listener must be a function");var i=new dL(t,n||r,o),s=qr?qr+e:e;return r._events[s]?r._events[s].fn?r._events[s]=[r._events[s],i]:r._events[s].push(i):(r._events[s]=i,r._eventsCount++),r}function dm(r,e){--r._eventsCount===0?r._events=new ud:delete r._events[e]}function Rr(){this._events=new ud,this._eventsCount=0}Rr.prototype.eventNames=function(){var e=[],t,n;if(this._eventsCount===0)return e;for(n in t=this._events)fL.call(t,n)&&e.push(qr?n.slice(1):n);return Object.getOwnPropertySymbols?e.concat(Object.getOwnPropertySymbols(t)):e};Rr.prototype.listeners=function(e){var t=qr?qr+e:e,n=this._events[t];if(!n)return[];if(n.fn)return[n.fn];for(var o=0,i=n.length,s=new Array(i);o<i;o++)s[o]=n[o].fn;return s};Rr.prototype.listenerCount=function(e){var t=qr?qr+e:e,n=this._events[t];return n?n.fn?1:n.length:0};Rr.prototype.emit=function(e,t,n,o,i,s){var a=qr?qr+e:e;if(!this._events[a])return!1;var c=this._events[a],l=arguments.length,f,u;if(c.fn){switch(c.once&&this.removeListener(e,c.fn,void 0,!0),l){case 1:return c.fn.call(c.context),!0;case 2:return c.fn.call(c.context,t),!0;case 3:return c.fn.call(c.context,t,n),!0;case 4:return c.fn.call(c.context,t,n,o),!0;case 5:return c.fn.call(c.context,t,n,o,i),!0;case 6:return c.fn.call(c.context,t,n,o,i,s),!0}for(u=1,f=new Array(l-1);u<l;u++)f[u-1]=arguments[u];c.fn.apply(c.context,f)}else{var d=c.length,h;for(u=0;u<d;u++)switch(c[u].once&&this.removeListener(e,c[u].fn,void 0,!0),l){case 1:c[u].fn.call(c[u].context);break;case 2:c[u].fn.call(c[u].context,t);break;case 3:c[u].fn.call(c[u].context,t,n);break;case 4:c[u].fn.call(c[u].context,t,n,o);break;default:if(!f)for(h=1,f=new Array(l-1);h<l;h++)f[h-1]=arguments[h];c[u].fn.apply(c[u].context,f)}}return!0};Rr.prototype.on=function(e,t,n){return sx(this,e,t,n,!1)};Rr.prototype.once=function(e,t,n){return sx(this,e,t,n,!0)};Rr.prototype.removeListener=function(e,t,n,o){var i=qr?qr+e:e;if(!this._events[i])return this;if(!t)return dm(this,i),this;var s=this._events[i];if(s.fn)s.fn===t&&(!o||s.once)&&(!n||s.context===n)&&dm(this,i);else{for(var a=0,c=[],l=s.length;a<l;a++)(s[a].fn!==t||o&&!s[a].once||n&&s[a].context!==n)&&c.push(s[a]);c.length?this._events[i]=c.length===1?c[0]:c:dm(this,i)}return this};Rr.prototype.removeAllListeners=function(e){var t;return e?(t=qr?qr+e:e,this._events[t]&&dm(this,t)):(this._events=new ud,this._eventsCount=0),this};Rr.prototype.off=Rr.prototype.removeListener;Rr.prototype.addListener=Rr.prototype.on;Rr.prefixed=qr;Rr.EventEmitter=Rr;typeof m6<"u"&&(m6.exports=Rr)});var Ax=Wn((pX,_x)=>{_x.exports=function(r){if(!r)throw Error("hashlru must have a max value, of type number, greater than 0");var e=0,t=Object.create(null),n=Object.create(null);function o(i,s){t[i]=s,e++,e>=r&&(e=0,n=t,t=Object.create(null))}return{has:function(i){return t[i]!==void 0||n[i]!==void 0},remove:function(i){t[i]!==void 0&&(t[i]=void 0),n[i]!==void 0&&(n[i]=void 0)},get:function(i){var s=t[i];if(s!==void 0)return s;if((s=n[i])!==void 0)return o(i,s),s},set:function(i,s){t[i]!==void 0?t[i]=s:o(i,s)},clear:function(){t=Object.create(null),n=Object.create(null)}}}});var LS=Wn(zd=>{(function(){var r,e,t,n,o,i,s,a;a=function(c){var l,f,u,d;return l=(c&255<<24)>>>24,f=(c&255<<16)>>>16,u=(c&65280)>>>8,d=c&255,[l,f,u,d].join(".")},s=function(c){var l,f,u,d,h,m;for(l=[],u=d=0;d<=3&&c.length!==0;u=++d){if(u>0){if(c[0]!==".")throw new Error("Invalid IP");c=c.substring(1)}m=e(c),h=m[0],f=m[1],c=c.substring(f),l.push(h)}if(c.length!==0)throw new Error("Invalid IP");switch(l.length){case 1:if(l[0]>4294967295)throw new Error("Invalid IP");return l[0]>>>0;case 2:if(l[0]>255||l[1]>16777215)throw new Error("Invalid IP");return(l[0]<<24|l[1])>>>0;case 3:if(l[0]>255||l[1]>255||l[2]>65535)throw new Error("Invalid IP");return(l[0]<<24|l[1]<<16|l[2])>>>0;case 4:if(l[0]>255||l[1]>255||l[2]>255||l[3]>255)throw new Error("Invalid IP");return(l[0]<<24|l[1]<<16|l[2]<<8|l[3])>>>0;default:throw new Error("Invalid IP")}},t=function(c){return c.charCodeAt(0)},n=t("0"),i=t("a"),o=t("A"),e=function(c){var l,f,u,d,h;for(d=0,l=10,f="9",u=0,c.length>1&&c[u]==="0"&&(c[u+1]==="x"||c[u+1]==="X"?(u+=2,l=16):"0"<=c[u+1]&&c[u+1]<="9"&&(u++,l=8,f="7")),h=u;u<c.length;){if("0"<=c[u]&&c[u]<=f)d=d*l+(t(c[u])-n)>>>0;else if(l===16)if("a"<=c[u]&&c[u]<="f")d=d*l+(10+t(c[u])-i)>>>0;else if("A"<=c[u]&&c[u]<="F")d=d*l+(10+t(c[u])-o)>>>0;else break;else break;if(d>4294967295)throw new Error("too large");u++}if(u===h)throw new Error("empty octet");return[d,u]},r=(function(){function c(l,f){var u,d,h,m;if(typeof l!="string")throw new Error("Missing `net' parameter");if(f||(m=l.split("/",2),l=m[0],f=m[1]),f||(f=32),typeof f=="string"&&f.indexOf(".")>-1){try{this.maskLong=s(f)}catch(w){throw u=w,new Error("Invalid mask: "+f)}for(d=h=32;h>=0;d=--h)if(this.maskLong===4294967295<<32-d>>>0){this.bitmask=d;break}}else if(f||f===0)this.bitmask=parseInt(f,10),this.maskLong=0,this.bitmask>0&&(this.maskLong=4294967295<<32-this.bitmask>>>0);else throw new Error("Invalid mask: empty");try{this.netLong=(s(l)&this.maskLong)>>>0}catch(w){throw u=w,new Error("Invalid net address: "+l)}if(!(this.bitmask<=32))throw new Error("Invalid mask for ip4: "+f);this.size=Math.pow(2,32-this.bitmask),this.base=a(this.netLong),this.mask=a(this.maskLong),this.hostmask=a(~this.maskLong),this.first=this.bitmask<=30?a(this.netLong+1):this.base,this.last=this.bitmask<=30?a(this.netLong+this.size-2):a(this.netLong+this.size-1),this.broadcast=this.bitmask<=30?a(this.netLong+this.size-1):void 0}return c.prototype.contains=function(l){return typeof l=="string"&&(l.indexOf("/")>0||l.split(".").length!==4)&&(l=new c(l)),l instanceof c?this.contains(l.base)&&this.contains(l.broadcast||l.last):(s(l)&this.maskLong)>>>0===(this.netLong&this.maskLong)>>>0},c.prototype.next=function(l){return l==null&&(l=1),new c(a(this.netLong+this.size*l),this.mask)},c.prototype.forEach=function(l){var f,u,d;for(d=s(this.first),u=s(this.last),f=0;d<=u;)l(a(d),d,f),f++,d++},c.prototype.toString=function(){return this.base+"/"+this.bitmask},c})(),zd.ip2long=s,zd.long2ip=a,zd.Netmask=r}).call(zd)});var L2=Wn((Ple,Dw)=>{var Cle=(function(){typeof Dw<"u"&&(Dw.exports=w);var r=86400,e=3200,t=146097*e/400,n=r*t,o=1e3*n,i=864e13,s=4294967296,a=1e6,c="000000000",l=Math.trunc||function(C){var T=C-C%1;return T==0&&(C<0||C===0&&1/C!=1/0)?-0:T},f=w.prototype,u=(w.fromDate=function(C){return new w(+C)},w.fromInt64BE=V(0,1,2,3,0,4),w.fromInt64LE=V(3,2,1,0,4,0),w.fromString=function(z){var T,K=new w,z=(z+="").replace(/^\s*[+\-]?\d+/,function(I){var I=+I,S=1970+(I-1970)%400;return K.year=I-S,S}).replace(/(?:Z|([+\-]\d{2}):?(\d{2}))$/,function(U,I,S){return I<0&&(S*=-1),T=6e4*(60*+I+ +S),""}).replace(/\.\d+$/,function(U){return K.nano=+(U+c).substr(1,9),""}).split(/\D+/);if(1<z.length?z[1]--:z[1]=0,K.time=T=Date.UTC.apply(Date,z)-(T||0),isNaN(T))throw new TypeError("Invalid Date");return y(K)},w.fromTimeT=function(C){return N(C,0)},f.year=0,f.time=0,f.nano=0,f.addNano=function(C){return this.nano+=+C||0,this},f.getNano=function(){var C=y(this);return(C.time%1e3*a+ +C.nano+1e9)%1e9},f.getTimeT=function(){var T=y(this),C=Math.floor(T.time/1e3),T=T.year;return T&&(C+=T*t*r/e),C},f.getYear=function(){return this.toDate().getUTCFullYear()+this.year},f.toDate=function(){return b(y(this).time)},f.toJSON=function(){return this.toString().replace(/0{1,6}Z$/,"Z")},f.toString=function(C){var T=this,K=T.toDate(),z={H:function(){return Z(K.getUTCHours())},L:function(){return se(K.getUTCMilliseconds(),3)},M:function(){return Z(K.getUTCMinutes())},N:function(){return se(T.getNano(),9)},S:function(){return Z(K.getUTCSeconds())},Y:function(){var U=T.getYear();return 999999<U?"+"+U:9999<U?"+"+se(U,6):0<=U?se(U,4):-999999<=U?"-"+se(-U,6):U},a:function(){return h[K.getUTCDay()]},b:function(){return d[K.getUTCMonth()]},d:function(){return Z(K.getUTCDate())},e:function(){return(function(U){return(9<U?"":" ")+(0|U)})(K.getUTCDate())},m:function(){return Z(K.getUTCMonth()+1)}};return(function U(I){return I.replace(/%./g,function(S){var D=S[1],x=m[D],D=z[D];return x?U(x):D?D():S})})(C||u)},f.writeInt64BE=O(0,1,2,3,0,4),f.writeInt64LE=O(3,2,1,0,4,0),"%Y-%m-%dT%H:%M:%S.%NZ"),d=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],h=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],m={"%":"%",F:"%Y-%m-%d",n:`
`,R:"%H:%M",T:"%H:%M:%S",t:"	",X:"%T",Z:"GMT",z:"+0000"};return w;function w(C,T,K){var z=this;if(!(z instanceof w))return new w(C,T,K);z.time=+C||0,z.nano=+T||0,z.year=+K||0,y(z)}function y(C){var T,K,z,U=C.year,I=C.time,S=C.nano,x=((S<0||a<=S)&&(S-=(K=Math.floor(S/a))*a,I+=K,K=1),U%e);return(I<-i||i<I||x)&&((T=l(I/o))&&(U+=T*e,I-=T*o),(z=b(I)).setUTCFullYear(x+z.getUTCFullYear()),z=(I=+z)+(T=l((U-=x)/e))*o,T&&-i<=z&&z<=i&&(U-=T*e,I=z),K=1),K&&(C.year=U,C.time=I,C.nano=S),C}function b(C){var T=new Date(0);return T.setTime(C),T}function N(U,z){U=+U||0;var K=l((z=(z|0)*s)/n)+l(U/n),z=z%n+U%n,U=l(z/n);return U&&(K+=U,z-=U*n),new w(1e3*z,0,K*e)}function O(C,T,K,z,U,I){return function(x,D){var H=y(this);x=x||new Array(8),Q(x,D|=0);var M=Math.floor(H.time/1e3),H=H.year*(t*r/e),q=l(H/s)+l(M/s),H=H%s+M%s,M=Math.floor(H/s);return M&&(q+=M,H-=M*s),S(x,D+U,q),S(x,D+I,H),x};function S(x,D,q){x[D+C]=q>>24&255,x[D+T]=q>>16&255,x[D+K]=q>>8&255,x[D+z]=255&q}}function V(C,T,K,z,U,I){return function(x,D){Q(x,D|=0);var q=S(x,D+U);return N(S(x,D+I),q)};function S(x,D){return 16777216*x[D+C]+(x[D+T]<<16|x[D+K]<<8|x[D+z])}}function Q(C,T){if(C=C&&C.length,C==null)throw new TypeError("Invalid Buffer");if(C<T+8)throw new RangeError("Out of range")}function Z(C){return(9<C?"":"0")+(0|C)}function se(C,T){return(c+(0|C)).substr(-T)}})()});var vI=Wn((W0e,bI)=>{"use strict";function AK(r){return r>=55296&&r<=56319}function TK(r){return r>=56320&&r<=57343}bI.exports=function(e,t,n){if(typeof t!="string")throw new Error("Input must be string");for(var o=t.length,i=0,s,a,c=0;c<o;c+=1){if(s=t.charCodeAt(c),a=t[c],AK(s)&&TK(t.charCodeAt(c+1))&&(c+=1,a+=t[c]),i+=e(a),i===n)return t.slice(0,c+1);if(i>n)return t.slice(0,c-a.length+1)}return t}});var EI=Wn((z0e,xI)=>{"use strict";function IK(r){return r>=55296&&r<=56319}function CK(r){return r>=56320&&r<=57343}xI.exports=function(e){if(typeof e!="string")throw new Error("Input must be string");for(var t=e.length,n=0,o=null,i=null,s=0;s<t;s++)o=e.charCodeAt(s),CK(o)?i!=null&&IK(i)?n+=1:n+=3:o<=127?n+=1:o>=128&&o<=2047?n+=2:o>=2048&&o<=65535&&(n+=3),i=o;return n}});var _I=Wn((G0e,SI)=>{"use strict";var PK=vI(),kK=EI();SI.exports=PK.bind(null,kK)});var II=Wn((X0e,TI)=>{"use strict";var OK=_I(),RK=/[\/\?<>\\:\*\|"]/g,DK=/[\x00-\x1f\x80-\x9f]/g,NK=/^\.+$/,LK=/^(con|prn|aux|nul|com[0-9]|lpt[0-9])(\..*)?$/i,BK=/[\. ]+$/;function AI(r,e){if(typeof r!="string")throw new Error("Input must be string");var t=r.replace(RK,e).replace(DK,e).replace(NK,e).replace(LK,e).replace(BK,e);return OK(t,255)}TI.exports=function(r,e){var t=e&&e.replacement||"",n=AI(r,t);return t===""?n:AI(n,"")}});var is=Wn(Gu=>{"use strict";var UK="[object ArrayBuffer]",os=class r{static isArrayBuffer(e){return Object.prototype.toString.call(e)===UK}static toArrayBuffer(e){return this.isArrayBuffer(e)?e:e.byteLength===e.buffer.byteLength||e.byteOffset===0&&e.byteLength===e.buffer.byteLength?e.buffer:this.toUint8Array(e.buffer).slice(e.byteOffset,e.byteOffset+e.byteLength).buffer}static toUint8Array(e){return this.toView(e,Uint8Array)}static toView(e,t){if(e.constructor===t)return e;if(this.isArrayBuffer(e))return new t(e);if(this.isArrayBufferView(e))return new t(e.buffer,e.byteOffset,e.byteLength);throw new TypeError("The provided value is not of type '(ArrayBuffer or ArrayBufferView)'")}static isBufferSource(e){return this.isArrayBufferView(e)||this.isArrayBuffer(e)}static isArrayBufferView(e){return ArrayBuffer.isView(e)||e&&this.isArrayBuffer(e.buffer)}static isEqual(e,t){let n=r.toUint8Array(e),o=r.toUint8Array(t);if(n.length!==o.byteLength)return!1;for(let i=0;i<n.length;i++)if(n[i]!==o[i])return!1;return!0}static concat(...e){let t;Array.isArray(e[0])&&!(e[1]instanceof Function)||Array.isArray(e[0])&&e[1]instanceof Function?t=e[0]:e[e.length-1]instanceof Function?t=e.slice(0,e.length-1):t=e;let n=0;for(let s of t)n+=s.byteLength;let o=new Uint8Array(n),i=0;for(let s of t){let a=this.toUint8Array(s);o.set(a,i),i+=a.length}return e[e.length-1]instanceof Function?this.toView(o,e[e.length-1]):o.buffer}},g7="string",FK=/^[0-9a-f\s]+$/i,$K=/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/,jK=/^[a-zA-Z0-9-_]+$/,$g=class{static fromString(e){let t=unescape(encodeURIComponent(e)),n=new Uint8Array(t.length);for(let o=0;o<t.length;o++)n[o]=t.charCodeAt(o);return n.buffer}static toString(e){let t=os.toUint8Array(e),n="";for(let i=0;i<t.length;i++)n+=String.fromCharCode(t[i]);return decodeURIComponent(escape(n))}},no=class{static toString(e,t=!1){let n=os.toArrayBuffer(e),o=new DataView(n),i="";for(let s=0;s<n.byteLength;s+=2){let a=o.getUint16(s,t);i+=String.fromCharCode(a)}return i}static fromString(e,t=!1){let n=new ArrayBuffer(e.length*2),o=new DataView(n);for(let i=0;i<e.length;i++)o.setUint16(i*2,e.charCodeAt(i),t);return n}},jg=class r{static isHex(e){return typeof e===g7&&FK.test(e)}static isBase64(e){return typeof e===g7&&$K.test(e)}static isBase64Url(e){return typeof e===g7&&jK.test(e)}static ToString(e,t="utf8"){let n=os.toUint8Array(e);switch(t.toLowerCase()){case"utf8":return this.ToUtf8String(n);case"binary":return this.ToBinary(n);case"hex":return this.ToHex(n);case"base64":return this.ToBase64(n);case"base64url":return this.ToBase64Url(n);case"utf16le":return no.toString(n,!0);case"utf16":case"utf16be":return no.toString(n);default:throw new Error(`Unknown type of encoding '${t}'`)}}static FromString(e,t="utf8"){if(!e)return new ArrayBuffer(0);switch(t.toLowerCase()){case"utf8":return this.FromUtf8String(e);case"binary":return this.FromBinary(e);case"hex":return this.FromHex(e);case"base64":return this.FromBase64(e);case"base64url":return this.FromBase64Url(e);case"utf16le":return no.fromString(e,!0);case"utf16":case"utf16be":return no.fromString(e);default:throw new Error(`Unknown type of encoding '${t}'`)}}static ToBase64(e){let t=os.toUint8Array(e);if(typeof btoa<"u"){let n=this.ToString(t,"binary");return btoa(n)}else return Buffer.from(t).toString("base64")}static FromBase64(e){let t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!r.isBase64(t))throw new TypeError("Argument 'base64Text' is not Base64 encoded");return typeof atob<"u"?this.FromBinary(atob(t)):new Uint8Array(Buffer.from(t,"base64")).buffer}static FromBase64Url(e){let t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!r.isBase64Url(t))throw new TypeError("Argument 'base64url' is not Base64Url encoded");return this.FromBase64(this.Base64Padding(t.replace(/\-/g,"+").replace(/\_/g,"/")))}static ToBase64Url(e){return this.ToBase64(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/\=/g,"")}static FromUtf8String(e,t=r.DEFAULT_UTF8_ENCODING){switch(t){case"ascii":return this.FromBinary(e);case"utf8":return $g.fromString(e);case"utf16":case"utf16be":return no.fromString(e);case"utf16le":case"usc2":return no.fromString(e,!0);default:throw new Error(`Unknown type of encoding '${t}'`)}}static ToUtf8String(e,t=r.DEFAULT_UTF8_ENCODING){switch(t){case"ascii":return this.ToBinary(e);case"utf8":return $g.toString(e);case"utf16":case"utf16be":return no.toString(e);case"utf16le":case"usc2":return no.toString(e,!0);default:throw new Error(`Unknown type of encoding '${t}'`)}}static FromBinary(e){let t=e.length,n=new Uint8Array(t);for(let o=0;o<t;o++)n[o]=e.charCodeAt(o);return n.buffer}static ToBinary(e){let t=os.toUint8Array(e),n="";for(let o=0;o<t.length;o++)n+=String.fromCharCode(t[o]);return n}static ToHex(e){let t=os.toUint8Array(e),n="",o=t.length;for(let i=0;i<o;i++){let s=t[i];s<16&&(n+="0"),n+=s.toString(16)}return n}static FromHex(e){let t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!r.isHex(t))throw new TypeError("Argument 'hexString' is not HEX encoded");t.length%2&&(t=`0${t}`);let n=new Uint8Array(t.length/2);for(let o=0;o<t.length;o=o+2){let i=t.slice(o,o+2);n[o/2]=parseInt(i,16)}return n.buffer}static ToUtf16String(e,t=!1){return no.toString(e,t)}static FromUtf16String(e,t=!1){return no.fromString(e,t)}static Base64Padding(e){let t=4-e.length%4;if(t<4)for(let n=0;n<t;n++)e+="=";return e}static formatString(e){return e?.replace(/[\n\r\t ]/g,"")||""}};jg.DEFAULT_UTF8_ENCODING="utf8";function KK(r,...e){let t=arguments[0];for(let n=1;n<arguments.length;n++){let o=arguments[n];for(let i in o)t[i]=o[i]}return t}function VK(...r){let e=r.map(o=>o.byteLength).reduce((o,i)=>o+i),t=new Uint8Array(e),n=0;return r.map(o=>new Uint8Array(o)).forEach(o=>{for(let i of o)t[n++]=i}),t.buffer}function HK(r,e){if(!(r&&e)||r.byteLength!==e.byteLength)return!1;let t=new Uint8Array(r),n=new Uint8Array(e);for(let o=0;o<r.byteLength;o++)if(t[o]!==n[o])return!1;return!0}Gu.BufferSourceConverter=os;Gu.Convert=jg;Gu.assign=KK;Gu.combine=VK;Gu.isEqual=HK});var VP=Wn(yi=>{"use strict";Object.defineProperty(yi,"__esModule",{value:!0});yi.parseCookie=jP;yi.parse=jP;yi.stringifyCookie=vH;yi.stringifySetCookie=Gy;yi.serialize=Gy;yi.parseSetCookie=xH;yi.stringifySetCookie=Gy;yi.serialize=Gy;var FP=/^[\u0021-\u003A\u003C\u003E-\u007E]+$/,$P=/^[\u0021-\u003A\u003C-\u007E]*$/,mH=/^([.]?[a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?)([.][a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?)*$/i,gH=/^[\u0020-\u003A\u003D-\u007E]*$/,yH=/^-?\d+$/,wH=Object.prototype.toString,bH=(()=>{let r=function(){};return r.prototype=Object.create(null),r})();function jP(r,e){let t=new bH,n=r.length;if(n<2)return t;let o=e?.decode||KP,i=0;do{let s=db(r,i,n);if(s===-1)break;let a=fb(r,i,n);if(s>a){i=r.lastIndexOf(";",s-1)+1;continue}let c=aa(r,i,s);t[c]===void 0&&(t[c]=o(aa(r,s+1,a))),i=a+1}while(i<n);return t}function vH(r,e){let t=e?.encode||encodeURIComponent,n=[];for(let o of Object.keys(r)){let i=r[o];if(i===void 0)continue;if(!FP.test(o))throw new TypeError(`cookie name is invalid: ${o}`);let s=t(i);if(!$P.test(s))throw new TypeError(`cookie val is invalid: ${i}`);n.push(`${o}=${s}`)}return n.join("; ")}function Gy(r,e,t){let n=typeof r=="object"?r:{...t,name:r,value:String(e)},i=(typeof e=="object"?e:t)?.encode||encodeURIComponent;if(!FP.test(n.name))throw new TypeError(`argument name is invalid: ${n.name}`);let s=n.value?i(n.value):"";if(!$P.test(s))throw new TypeError(`argument val is invalid: ${n.value}`);let a=n.name+"="+s;if(n.maxAge!==void 0){if(!Number.isInteger(n.maxAge))throw new TypeError(`option maxAge is invalid: ${n.maxAge}`);a+="; Max-Age="+n.maxAge}if(n.domain){if(!mH.test(n.domain))throw new TypeError(`option domain is invalid: ${n.domain}`);a+="; Domain="+n.domain}if(n.path){if(!gH.test(n.path))throw new TypeError(`option path is invalid: ${n.path}`);a+="; Path="+n.path}if(n.expires){if(!EH(n.expires)||!Number.isFinite(n.expires.valueOf()))throw new TypeError(`option expires is invalid: ${n.expires}`);a+="; Expires="+n.expires.toUTCString()}if(n.httpOnly&&(a+="; HttpOnly"),n.secure&&(a+="; Secure"),n.partitioned&&(a+="; Partitioned"),n.priority)switch(typeof n.priority=="string"?n.priority.toLowerCase():void 0){case"low":a+="; Priority=Low";break;case"medium":a+="; Priority=Medium";break;case"high":a+="; Priority=High";break;default:throw new TypeError(`option priority is invalid: ${n.priority}`)}if(n.sameSite)switch(typeof n.sameSite=="string"?n.sameSite.toLowerCase():n.sameSite){case!0:case"strict":a+="; SameSite=Strict";break;case"lax":a+="; SameSite=Lax";break;case"none":a+="; SameSite=None";break;default:throw new TypeError(`option sameSite is invalid: ${n.sameSite}`)}return a}function xH(r,e){let t=e?.decode||KP,n=r.length,o=fb(r,0,n),i=db(r,0,o),s=i===-1?{name:"",value:t(aa(r,0,o))}:{name:aa(r,0,i),value:t(aa(r,i+1,o))},a=o+1;for(;a<n;){let c=fb(r,a,n),l=db(r,a,c),f=l===-1?aa(r,a,c):aa(r,a,l),u=l===-1?void 0:aa(r,l+1,c);switch(f.toLowerCase()){case"httponly":s.httpOnly=!0;break;case"secure":s.secure=!0;break;case"partitioned":s.partitioned=!0;break;case"domain":s.domain=u;break;case"path":s.path=u;break;case"max-age":u&&yH.test(u)&&(s.maxAge=Number(u));break;case"expires":if(!u)break;let d=new Date(u);Number.isFinite(d.valueOf())&&(s.expires=d);break;case"priority":if(!u)break;let h=u.toLowerCase();(h==="low"||h==="medium"||h==="high")&&(s.priority=h);break;case"samesite":if(!u)break;let m=u.toLowerCase();(m==="lax"||m==="strict"||m==="none")&&(s.sameSite=m);break}a=c+1}return s}function fb(r,e,t){let n=r.indexOf(";",e);return n===-1?t:n}function db(r,e,t){let n=r.indexOf("=",e);return n<t?n:-1}function aa(r,e,t){let n=e,o=t;do{let i=r.charCodeAt(n);if(i!==32&&i!==9)break}while(++n<o);for(;o>n;){let i=r.charCodeAt(o-1);if(i!==32&&i!==9)break;o--}return r.slice(n,o)}function KP(r){if(r.indexOf("%")===-1)return r;try{return decodeURIComponent(r)}catch{return r}}function EH(r){return wH.call(r)==="[object Date]"}});var EO=Wn(()=>{var xO;(function(r){(function(e){var t=typeof globalThis=="object"||typeof globalThis=="object"?globalThis:typeof self=="object"?self:typeof this=="object"?this:a(),n=o(r);typeof t.Reflect<"u"&&(n=o(t.Reflect,n)),e(n,t),typeof t.Reflect>"u"&&(t.Reflect=r);function o(c,l){return function(f,u){Object.defineProperty(c,f,{configurable:!0,writable:!0,value:u}),l&&l(f,u)}}function i(){try{return Function("return this;")()}catch{}}function s(){try{return(0,eval)("(function() { return this; })()")}catch{}}function a(){return i()||s()}})(function(e,t){var n=Object.prototype.hasOwnProperty,o=typeof Symbol=="function",i=o&&typeof Symbol.toPrimitive<"u"?Symbol.toPrimitive:"@@toPrimitive",s=o&&typeof Symbol.iterator<"u"?Symbol.iterator:"@@iterator",a=typeof Object.create=="function",c={__proto__:[]}instanceof Array,l=!a&&!c,f={create:a?function(){return i6(Object.create(null))}:c?function(){return i6({__proto__:null})}:function(){return i6({})},has:l?function(_,R){return n.call(_,R)}:function(_,R){return R in _},get:l?function(_,R){return n.call(_,R)?_[R]:void 0}:function(_,R){return _[R]}},u=Object.getPrototypeOf(Function),d=typeof Map=="function"&&typeof Map.prototype.entries=="function"?Map:SN(),h=typeof Set=="function"&&typeof Set.prototype.entries=="function"?Set:_N(),m=typeof WeakMap=="function"?WeakMap:AN(),w=o?Symbol.for("@reflect-metadata:registry"):void 0,y=vN(),b=xN(y);function N(_,R,$,J){if(F($)){if(!Pi(_))throw new TypeError;if(!Is(R))throw new TypeError;return U(_,R)}else{if(!Pi(_))throw new TypeError;if(!me(R))throw new TypeError;if(!me(J)&&!F(J)&&!Le(J))throw new TypeError;return Le(J)&&(J=void 0),$=it($),I(_,R,$,J)}}e("decorate",N);function O(_,R){function $(J,Ee){if(!me(J))throw new TypeError;if(!F(Ee)&&!Z1(Ee))throw new TypeError;H(_,R,J,Ee)}return $}e("metadata",O);function V(_,R,$,J){if(!me($))throw new TypeError;return F(J)||(J=it(J)),H(_,R,$,J)}e("defineMetadata",V);function Q(_,R,$){if(!me(R))throw new TypeError;return F($)||($=it($)),S(_,R,$)}e("hasMetadata",Q);function Z(_,R,$){if(!me(R))throw new TypeError;return F($)||($=it($)),x(_,R,$)}e("hasOwnMetadata",Z);function se(_,R,$){if(!me(R))throw new TypeError;return F($)||($=it($)),D(_,R,$)}e("getMetadata",se);function C(_,R,$){if(!me(R))throw new TypeError;return F($)||($=it($)),q(_,R,$)}e("getOwnMetadata",C);function T(_,R){if(!me(_))throw new TypeError;return F(R)||(R=it(R)),M(_,R)}e("getMetadataKeys",T);function K(_,R){if(!me(_))throw new TypeError;return F(R)||(R=it(R)),G(_,R)}e("getOwnMetadataKeys",K);function z(_,R,$){if(!me(R))throw new TypeError;if(F($)||($=it($)),!me(R))throw new TypeError;F($)||($=it($));var J=nd(R,$,!1);return F(J)?!1:J.OrdinaryDeleteMetadata(_,R,$)}e("deleteMetadata",z);function U(_,R){for(var $=_.length-1;$>=0;--$){var J=_[$],Ee=J(R);if(!F(Ee)&&!Le(Ee)){if(!Is(Ee))throw new TypeError;R=Ee}}return R}function I(_,R,$,J){for(var Ee=_.length-1;Ee>=0;--Ee){var $t=_[Ee],Jt=$t(R,$,J);if(!F(Jt)&&!Le(Jt)){if(!me(Jt))throw new TypeError;J=Jt}}return J}function S(_,R,$){var J=x(_,R,$);if(J)return!0;var Ee=o6(R);return Le(Ee)?!1:S(_,Ee,$)}function x(_,R,$){var J=nd(R,$,!1);return F(J)?!1:Ct(J.OrdinaryHasOwnMetadata(_,R,$))}function D(_,R,$){var J=x(_,R,$);if(J)return q(_,R,$);var Ee=o6(R);if(!Le(Ee))return D(_,Ee,$)}function q(_,R,$){var J=nd(R,$,!1);if(!F(J))return J.OrdinaryGetOwnMetadata(_,R,$)}function H(_,R,$,J){var Ee=nd($,J,!0);Ee.OrdinaryDefineOwnMetadata(_,R,$,J)}function M(_,R){var $=G(_,R),J=o6(_);if(J===null)return $;var Ee=M(J,R);if(Ee.length<=0)return $;if($.length<=0)return Ee;for(var $t=new h,Jt=[],$e=0,ae=$;$e<ae.length;$e++){var de=ae[$e],ge=$t.has(de);ge||($t.add(de),Jt.push(de))}for(var be=0,Ke=Ee;be<Ke.length;be++){var de=Ke[be],ge=$t.has(de);ge||($t.add(de),Jt.push(de))}return Jt}function G(_,R){var $=nd(_,R,!1);return $?$.OrdinaryOwnMetadataKeys(_,R):[]}function te(_){if(_===null)return 1;switch(typeof _){case"undefined":return 0;case"boolean":return 2;case"string":return 3;case"symbol":return 4;case"number":return 5;case"object":return _===null?1:6;default:return 6}}function F(_){return _===void 0}function Le(_){return _===null}function Fe(_){return typeof _=="symbol"}function me(_){return typeof _=="object"?_!==null:typeof _=="function"}function He(_,R){switch(te(_)){case 0:return _;case 1:return _;case 2:return _;case 3:return _;case 4:return _;case 5:return _}var $=R===3?"string":R===5?"number":"default",J=rd(_,i);if(J!==void 0){var Ee=J.call(_,$);if(me(Ee))throw new TypeError;return Ee}return ot(_,$==="default"?"number":$)}function ot(_,R){if(R==="string"){var $=_.toString;if(mo($)){var J=$.call(_);if(!me(J))return J}var Ee=_.valueOf;if(mo(Ee)){var J=Ee.call(_);if(!me(J))return J}}else{var Ee=_.valueOf;if(mo(Ee)){var J=Ee.call(_);if(!me(J))return J}var $t=_.toString;if(mo($t)){var J=$t.call(_);if(!me(J))return J}}throw new TypeError}function Ct(_){return!!_}function ze(_){return""+_}function it(_){var R=He(_,3);return Fe(R)?R:ze(R)}function Pi(_){return Array.isArray?Array.isArray(_):_ instanceof Object?_ instanceof Array:Object.prototype.toString.call(_)==="[object Array]"}function mo(_){return typeof _=="function"}function Is(_){return typeof _=="function"}function Z1(_){switch(te(_)){case 3:return!0;case 4:return!0;default:return!1}}function Nl(_,R){return _===R||_!==_&&R!==R}function rd(_,R){var $=_[R];if($!=null){if(!mo($))throw new TypeError;return $}}function Hv(_){var R=rd(_,s);if(!mo(R))throw new TypeError;var $=R.call(_);if(!me($))throw new TypeError;return $}function qv(_){return _.value}function Wv(_){var R=_.next();return R.done?!1:R}function zv(_){var R=_.return;R&&R.call(_)}function o6(_){var R=Object.getPrototypeOf(_);if(typeof _!="function"||_===u||R!==u)return R;var $=_.prototype,J=$&&Object.getPrototypeOf($);if(J==null||J===Object.prototype)return R;var Ee=J.constructor;return typeof Ee!="function"||Ee===_?R:Ee}function bN(){var _;!F(w)&&typeof t.Reflect<"u"&&!(w in t.Reflect)&&typeof t.Reflect.defineMetadata=="function"&&(_=EN(t.Reflect));var R,$,J,Ee=new m,$t={registerProvider:Jt,getProvider:ae,setProvider:ge};return $t;function Jt(be){if(!Object.isExtensible($t))throw new Error("Cannot add provider to a frozen registry.");switch(!0){case _===be:break;case F(R):R=be;break;case R===be:break;case F($):$=be;break;case $===be:break;default:J===void 0&&(J=new h),J.add(be);break}}function $e(be,Ke){if(!F(R)){if(R.isProviderFor(be,Ke))return R;if(!F($)){if($.isProviderFor(be,Ke))return R;if(!F(J))for(var Et=Hv(J);;){var jt=Wv(Et);if(!jt)return;var go=qv(jt);if(go.isProviderFor(be,Ke))return zv(Et),go}}}if(!F(_)&&_.isProviderFor(be,Ke))return _}function ae(be,Ke){var Et=Ee.get(be),jt;return F(Et)||(jt=Et.get(Ke)),F(jt)&&(jt=$e(be,Ke),F(jt)||(F(Et)&&(Et=new d,Ee.set(be,Et)),Et.set(Ke,jt))),jt}function de(be){if(F(be))throw new TypeError;return R===be||$===be||!F(J)&&J.has(be)}function ge(be,Ke,Et){if(!de(Et))throw new Error("Metadata provider not registered.");var jt=ae(be,Ke);if(jt!==Et){if(!F(jt))return!1;var go=Ee.get(be);F(go)&&(go=new d,Ee.set(be,go)),go.set(Ke,Et)}return!0}}function vN(){var _;return!F(w)&&me(t.Reflect)&&Object.isExtensible(t.Reflect)&&(_=t.Reflect[w]),F(_)&&(_=bN()),!F(w)&&me(t.Reflect)&&Object.isExtensible(t.Reflect)&&Object.defineProperty(t.Reflect,w,{enumerable:!1,configurable:!1,writable:!1,value:_}),_}function xN(_){var R=new m,$={isProviderFor:function(de,ge){var be=R.get(de);return F(be)?!1:be.has(ge)},OrdinaryDefineOwnMetadata:Jt,OrdinaryHasOwnMetadata:Ee,OrdinaryGetOwnMetadata:$t,OrdinaryOwnMetadataKeys:$e,OrdinaryDeleteMetadata:ae};return y.registerProvider($),$;function J(de,ge,be){var Ke=R.get(de),Et=!1;if(F(Ke)){if(!be)return;Ke=new d,R.set(de,Ke),Et=!0}var jt=Ke.get(ge);if(F(jt)){if(!be)return;if(jt=new d,Ke.set(ge,jt),!_.setProvider(de,ge,$))throw Ke.delete(ge),Et&&R.delete(de),new Error("Wrong provider for target.")}return jt}function Ee(de,ge,be){var Ke=J(ge,be,!1);return F(Ke)?!1:Ct(Ke.has(de))}function $t(de,ge,be){var Ke=J(ge,be,!1);if(!F(Ke))return Ke.get(de)}function Jt(de,ge,be,Ke){var Et=J(be,Ke,!0);Et.set(de,ge)}function $e(de,ge){var be=[],Ke=J(de,ge,!1);if(F(Ke))return be;for(var Et=Ke.keys(),jt=Hv(Et),go=0;;){var Gv=Wv(jt);if(!Gv)return be.length=go,be;var TN=qv(Gv);try{be[go]=TN}catch(IN){try{zv(jt)}finally{throw IN}}go++}}function ae(de,ge,be){var Ke=J(ge,be,!1);if(F(Ke)||!Ke.delete(de))return!1;if(Ke.size===0){var Et=R.get(ge);F(Et)||(Et.delete(be),Et.size===0&&R.delete(Et))}return!0}}function EN(_){var R=_.defineMetadata,$=_.hasOwnMetadata,J=_.getOwnMetadata,Ee=_.getOwnMetadataKeys,$t=_.deleteMetadata,Jt=new m,$e={isProviderFor:function(ae,de){var ge=Jt.get(ae);return!F(ge)&&ge.has(de)?!0:Ee(ae,de).length?(F(ge)&&(ge=new h,Jt.set(ae,ge)),ge.add(de),!0):!1},OrdinaryDefineOwnMetadata:R,OrdinaryHasOwnMetadata:$,OrdinaryGetOwnMetadata:J,OrdinaryOwnMetadataKeys:Ee,OrdinaryDeleteMetadata:$t};return $e}function nd(_,R,$){var J=y.getProvider(_,R);if(!F(J))return J;if($){if(y.setProvider(_,R,b))return b;throw new Error("Illegal state.")}}function SN(){var _={},R=[],$=(function(){function $e(ae,de,ge){this._index=0,this._keys=ae,this._values=de,this._selector=ge}return $e.prototype["@@iterator"]=function(){return this},$e.prototype[s]=function(){return this},$e.prototype.next=function(){var ae=this._index;if(ae>=0&&ae<this._keys.length){var de=this._selector(this._keys[ae],this._values[ae]);return ae+1>=this._keys.length?(this._index=-1,this._keys=R,this._values=R):this._index++,{value:de,done:!1}}return{value:void 0,done:!0}},$e.prototype.throw=function(ae){throw this._index>=0&&(this._index=-1,this._keys=R,this._values=R),ae},$e.prototype.return=function(ae){return this._index>=0&&(this._index=-1,this._keys=R,this._values=R),{value:ae,done:!0}},$e})(),J=(function(){function $e(){this._keys=[],this._values=[],this._cacheKey=_,this._cacheIndex=-2}return Object.defineProperty($e.prototype,"size",{get:function(){return this._keys.length},enumerable:!0,configurable:!0}),$e.prototype.has=function(ae){return this._find(ae,!1)>=0},$e.prototype.get=function(ae){var de=this._find(ae,!1);return de>=0?this._values[de]:void 0},$e.prototype.set=function(ae,de){var ge=this._find(ae,!0);return this._values[ge]=de,this},$e.prototype.delete=function(ae){var de=this._find(ae,!1);if(de>=0){for(var ge=this._keys.length,be=de+1;be<ge;be++)this._keys[be-1]=this._keys[be],this._values[be-1]=this._values[be];return this._keys.length--,this._values.length--,Nl(ae,this._cacheKey)&&(this._cacheKey=_,this._cacheIndex=-2),!0}return!1},$e.prototype.clear=function(){this._keys.length=0,this._values.length=0,this._cacheKey=_,this._cacheIndex=-2},$e.prototype.keys=function(){return new $(this._keys,this._values,Ee)},$e.prototype.values=function(){return new $(this._keys,this._values,$t)},$e.prototype.entries=function(){return new $(this._keys,this._values,Jt)},$e.prototype["@@iterator"]=function(){return this.entries()},$e.prototype[s]=function(){return this.entries()},$e.prototype._find=function(ae,de){if(!Nl(this._cacheKey,ae)){this._cacheIndex=-1;for(var ge=0;ge<this._keys.length;ge++)if(Nl(this._keys[ge],ae)){this._cacheIndex=ge;break}}return this._cacheIndex<0&&de&&(this._cacheIndex=this._keys.length,this._keys.push(ae),this._values.push(void 0)),this._cacheIndex},$e})();return J;function Ee($e,ae){return $e}function $t($e,ae){return ae}function Jt($e,ae){return[$e,ae]}}function _N(){var _=(function(){function R(){this._map=new d}return Object.defineProperty(R.prototype,"size",{get:function(){return this._map.size},enumerable:!0,configurable:!0}),R.prototype.has=function($){return this._map.has($)},R.prototype.add=function($){return this._map.set($,$),this},R.prototype.delete=function($){return this._map.delete($)},R.prototype.clear=function(){this._map.clear()},R.prototype.keys=function(){return this._map.keys()},R.prototype.values=function(){return this._map.keys()},R.prototype.entries=function(){return this._map.entries()},R.prototype["@@iterator"]=function(){return this.keys()},R.prototype[s]=function(){return this.keys()},R})();return _}function AN(){var _=16,R=f.create(),$=J();return(function(){function ae(){this._key=J()}return ae.prototype.has=function(de){var ge=Ee(de,!1);return ge!==void 0?f.has(ge,this._key):!1},ae.prototype.get=function(de){var ge=Ee(de,!1);return ge!==void 0?f.get(ge,this._key):void 0},ae.prototype.set=function(de,ge){var be=Ee(de,!0);return be[this._key]=ge,this},ae.prototype.delete=function(de){var ge=Ee(de,!1);return ge!==void 0?delete ge[this._key]:!1},ae.prototype.clear=function(){this._key=J()},ae})();function J(){var ae;do ae="@@WeakMap@@"+$e();while(f.has(R,ae));return R[ae]=!0,ae}function Ee(ae,de){if(!n.call(ae,$)){if(!de)return;Object.defineProperty(ae,$,{value:f.create()})}return ae[$]}function $t(ae,de){for(var ge=0;ge<de;++ge)ae[ge]=Math.random()*255|0;return ae}function Jt(ae){if(typeof Uint8Array=="function"){var de=new Uint8Array(ae);return typeof crypto<"u"?crypto.getRandomValues(de):typeof msCrypto<"u"?msCrypto.getRandomValues(de):$t(de,ae),de}return $t(new Array(ae),ae)}function $e(){var ae=Jt(_);ae[6]=ae[6]&79|64,ae[8]=ae[8]&191|128;for(var de="",ge=0;ge<_;++ge){var be=ae[ge];(ge===4||ge===6||ge===8)&&(de+="-"),be<16&&(de+="0"),de+=be.toString(16).toLowerCase()}return de}}function i6(_){return _.__=void 0,delete _.__,_}})})(xO||(xO={}))});var OR=Wn((YNe,I4)=>{var fR,dR,hR,pR,mR,gR,yR,wR,bR,T4,z9,vR,xR,Vf,ER,SR,_R,AR,TR,IR,CR,PR,kR;(function(r){var e=typeof globalThis=="object"?globalThis:typeof self=="object"?self:typeof this=="object"?this:{};typeof define=="function"&&define.amd?define("tslib",["exports"],function(n){r(t(e,t(n)))}):typeof I4=="object"&&typeof I4.exports=="object"?r(t(e,t(I4.exports))):r(t(e));function t(n,o){return n!==e&&(typeof Object.create=="function"?Object.defineProperty(n,"__esModule",{value:!0}):n.__esModule=!0),function(i,s){return n[i]=o?o(i,s):s}}})(function(r){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var o in n)n.hasOwnProperty(o)&&(t[o]=n[o])};fR=function(t,n){e(t,n);function o(){this.constructor=t}t.prototype=n===null?Object.create(n):(o.prototype=n.prototype,new o)},dR=Object.assign||function(t){for(var n,o=1,i=arguments.length;o<i;o++){n=arguments[o];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(t[s]=n[s])}return t},hR=function(t,n){var o={};for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&n.indexOf(i)<0&&(o[i]=t[i]);if(t!=null&&typeof Object.getOwnPropertySymbols=="function")for(var s=0,i=Object.getOwnPropertySymbols(t);s<i.length;s++)n.indexOf(i[s])<0&&Object.prototype.propertyIsEnumerable.call(t,i[s])&&(o[i[s]]=t[i[s]]);return o},pR=function(t,n,o,i){var s=arguments.length,a=s<3?n:i===null?i=Object.getOwnPropertyDescriptor(n,o):i,c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")a=Reflect.decorate(t,n,o,i);else for(var l=t.length-1;l>=0;l--)(c=t[l])&&(a=(s<3?c(a):s>3?c(n,o,a):c(n,o))||a);return s>3&&a&&Object.defineProperty(n,o,a),a},mR=function(t,n){return function(o,i){n(o,i,t)}},gR=function(t,n){if(typeof Reflect=="object"&&typeof Reflect.metadata=="function")return Reflect.metadata(t,n)},yR=function(t,n,o,i){function s(a){return a instanceof o?a:new o(function(c){c(a)})}return new(o||(o=Promise))(function(a,c){function l(d){try{u(i.next(d))}catch(h){c(h)}}function f(d){try{u(i.throw(d))}catch(h){c(h)}}function u(d){d.done?a(d.value):s(d.value).then(l,f)}u((i=i.apply(t,n||[])).next())})},wR=function(t,n){var o={label:0,sent:function(){if(a[0]&1)throw a[1];return a[1]},trys:[],ops:[]},i,s,a,c;return c={next:l(0),throw:l(1),return:l(2)},typeof Symbol=="function"&&(c[Symbol.iterator]=function(){return this}),c;function l(u){return function(d){return f([u,d])}}function f(u){if(i)throw new TypeError("Generator is already executing.");for(;o;)try{if(i=1,s&&(a=u[0]&2?s.return:u[0]?s.throw||((a=s.return)&&a.call(s),0):s.next)&&!(a=a.call(s,u[1])).done)return a;switch(s=0,a&&(u=[u[0]&2,a.value]),u[0]){case 0:case 1:a=u;break;case 4:return o.label++,{value:u[1],done:!1};case 5:o.label++,s=u[1],u=[0];continue;case 7:u=o.ops.pop(),o.trys.pop();continue;default:if(a=o.trys,!(a=a.length>0&&a[a.length-1])&&(u[0]===6||u[0]===2)){o=0;continue}if(u[0]===3&&(!a||u[1]>a[0]&&u[1]<a[3])){o.label=u[1];break}if(u[0]===6&&o.label<a[1]){o.label=a[1],a=u;break}if(a&&o.label<a[2]){o.label=a[2],o.ops.push(u);break}a[2]&&o.ops.pop(),o.trys.pop();continue}u=n.call(t,o)}catch(d){u=[6,d],s=0}finally{i=a=0}if(u[0]&5)throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}},kR=function(t,n,o,i){i===void 0&&(i=o),t[i]=n[o]},bR=function(t,n){for(var o in t)o!=="default"&&!n.hasOwnProperty(o)&&(n[o]=t[o])},T4=function(t){var n=typeof Symbol=="function"&&Symbol.iterator,o=n&&t[n],i=0;if(o)return o.call(t);if(t&&typeof t.length=="number")return{next:function(){return t&&i>=t.length&&(t=void 0),{value:t&&t[i++],done:!t}}};throw new TypeError(n?"Object is not iterable.":"Symbol.iterator is not defined.")},z9=function(t,n){var o=typeof Symbol=="function"&&t[Symbol.iterator];if(!o)return t;var i=o.call(t),s,a=[],c;try{for(;(n===void 0||n-- >0)&&!(s=i.next()).done;)a.push(s.value)}catch(l){c={error:l}}finally{try{s&&!s.done&&(o=i.return)&&o.call(i)}finally{if(c)throw c.error}}return a},vR=function(){for(var t=[],n=0;n<arguments.length;n++)t=t.concat(z9(arguments[n]));return t},xR=function(){for(var t=0,n=0,o=arguments.length;n<o;n++)t+=arguments[n].length;for(var i=Array(t),s=0,n=0;n<o;n++)for(var a=arguments[n],c=0,l=a.length;c<l;c++,s++)i[s]=a[c];return i},Vf=function(t){return this instanceof Vf?(this.v=t,this):new Vf(t)},ER=function(t,n,o){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var i=o.apply(t,n||[]),s,a=[];return s={},c("next"),c("throw"),c("return"),s[Symbol.asyncIterator]=function(){return this},s;function c(m){i[m]&&(s[m]=function(w){return new Promise(function(y,b){a.push([m,w,y,b])>1||l(m,w)})})}function l(m,w){try{f(i[m](w))}catch(y){h(a[0][3],y)}}function f(m){m.value instanceof Vf?Promise.resolve(m.value.v).then(u,d):h(a[0][2],m)}function u(m){l("next",m)}function d(m){l("throw",m)}function h(m,w){m(w),a.shift(),a.length&&l(a[0][0],a[0][1])}},SR=function(t){var n,o;return n={},i("next"),i("throw",function(s){throw s}),i("return"),n[Symbol.iterator]=function(){return this},n;function i(s,a){n[s]=t[s]?function(c){return(o=!o)?{value:Vf(t[s](c)),done:s==="return"}:a?a(c):c}:a}},_R=function(t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var n=t[Symbol.asyncIterator],o;return n?n.call(t):(t=typeof T4=="function"?T4(t):t[Symbol.iterator](),o={},i("next"),i("throw"),i("return"),o[Symbol.asyncIterator]=function(){return this},o);function i(a){o[a]=t[a]&&function(c){return new Promise(function(l,f){c=t[a](c),s(l,f,c.done,c.value)})}}function s(a,c,l,f){Promise.resolve(f).then(function(u){a({value:u,done:l})},c)}},AR=function(t,n){return Object.defineProperty?Object.defineProperty(t,"raw",{value:n}):t.raw=n,t},TR=function(t){if(t&&t.__esModule)return t;var n={};if(t!=null)for(var o in t)Object.hasOwnProperty.call(t,o)&&(n[o]=t[o]);return n.default=t,n},IR=function(t){return t&&t.__esModule?t:{default:t}},CR=function(t,n){if(!n.has(t))throw new TypeError("attempted to get private field on non-instance");return n.get(t)},PR=function(t,n,o){if(!n.has(t))throw new TypeError("attempted to set private field on non-instance");return n.set(t,o),o},r("__extends",fR),r("__assign",dR),r("__rest",hR),r("__decorate",pR),r("__param",mR),r("__metadata",gR),r("__awaiter",yR),r("__generator",wR),r("__exportStar",bR),r("__createBinding",kR),r("__values",T4),r("__read",z9),r("__spread",vR),r("__spreadArrays",xR),r("__await",Vf),r("__asyncGenerator",ER),r("__asyncDelegator",SR),r("__asyncValues",_R),r("__makeTemplateObject",AR),r("__importStar",TR),r("__importDefault",IR),r("__classPrivateFieldGet",CR),r("__classPrivateFieldSet",PR)})});var tz={};Nt(tz,{DEFAULT_SESSION_MAX_PROVIDERS:()=>$8,DEFAULT_SESSION_MIN_PROVIDERS:()=>F8,InsufficientProvidersError:()=>uh,InvalidCodecError:()=>j8,NoRoutersAvailableError:()=>Zs,UnknownCodecError:()=>dh,UnknownHashAlgorithmError:()=>fh,createHelia:()=>ez,heliaDefaults:()=>Vv,libp2pDefaults:()=>n6});var Yv=Symbol.for("@libp2p/connection");var ki=Symbol.for("@libp2p/content-routing");var Hr=class extends Error{static name="AbortError";constructor(e="The operation was aborted"){super(e),this.name="AbortError"}},em=class extends Error{static name="UnexpectedPeerError";constructor(e="Unexpected Peer"){super(e),this.name="UnexpectedPeerError"}},tm=class extends Error{static name="InvalidCryptoExchangeError";constructor(e="Invalid crypto exchange"){super(e),this.name="InvalidCryptoExchangeError"}},P=class extends Error{static name="InvalidParametersError";constructor(e="Invalid parameters"){super(e),this.name="InvalidParametersError"}},Oi=class extends Error{static name="InvalidPublicKeyError";constructor(e="Invalid public key"){super(e),this.name="InvalidPublicKeyError"}},od=class extends Error{static name="InvalidPrivateKeyError";constructor(e="Invalid private key"){super(e),this.name="InvalidPrivateKeyError"}},id=class extends Error{static name="UnsupportedOperationError";constructor(e="Unsupported operation"){super(e),this.name="UnsupportedOperationError"}};var $a=class extends Error{static name="ConnectionClosedError";constructor(e="The connection is closed"){super(e),this.name="ConnectionClosedError"}},Ll=class extends Error{static name="ConnectionFailedError";constructor(e="Connection failed"){super(e),this.name="ConnectionFailedError"}},yo=class extends Error{static name="MuxerClosedError";constructor(e="The muxer is closed"){super(e),this.name="MuxerClosedError"}},Bl=class extends Error{static name="StreamResetError";constructor(e="The stream has been reset"){super(e),this.name="StreamResetError"}};var Go=class extends Error{static name="StreamStateError";constructor(e="The stream is in an invalid state"){super(e),this.name="StreamStateError"}},sd=class extends Error{static name="StreamBufferError";constructor(e="The stream buffer was full"){super(e),this.name="StreamBufferError"}},Xe=class extends Error{static name="NotFoundError";constructor(e="Not found"){super(e),this.name="NotFoundError"}},Ml=class extends Error{static name="InvalidPeerIdError";constructor(e="Invalid PeerID"){super(e),this.name="InvalidPeerIdError"}},Xo=class extends Error{static name="InvalidMultiaddrError";constructor(e="Invalid multiaddr"){super(e),this.name="InvalidMultiaddrError"}},rm=class extends Error{static name="InvalidCIDError";constructor(e="Invalid CID"){super(e),this.name="InvalidCIDError"}},Cs=class extends Error{static name="InvalidMultihashError";constructor(e="Invalid Multihash"){super(e),this.name="InvalidMultihashError"}},Ul=class extends Error{static name="UnsupportedProtocolError";constructor(e="Unsupported protocol error"){super(e),this.name="UnsupportedProtocolError"}},Be=class extends Error{static name="InvalidMessageError";constructor(e="Invalid message"){super(e),this.name="InvalidMessageError"}},ja=class extends Error{static name="ProtocolError";constructor(e="Protocol error"){super(e),this.name="ProtocolError"}},Yo=class extends Error{static name="TimeoutError";constructor(e="Timed out"){super(e),this.name="TimeoutError"}},_n=class extends Error{static name="NotStartedError";constructor(e="Not started"){super(e),this.name="NotStartedError"}};var Ps=class extends Error{static name="DialError";constructor(e="Dial error"){super(e),this.name="DialError"}},Ka=class extends Error{static name="ListenError";constructor(e="Listen error"){super(e),this.name="ListenError"}},ad=class extends Error{static name="LimitedConnectionError";constructor(e="Limited connection"){super(e),this.name="LimitedConnectionError"}},nm=class extends Error{static name="TooManyInboundProtocolStreamsError";constructor(e="Too many inbound protocol streams"){super(e),this.name="TooManyInboundProtocolStreamsError"}},Fl=class extends Error{static name="TooManyOutboundProtocolStreamsError";constructor(e="Too many outbound protocol streams"){super(e),this.name="TooManyOutboundProtocolStreamsError"}},wo=class extends Error{static name="UnsupportedKeyTypeError";constructor(e="Unsupported key type"){super(e),this.name="UnsupportedKeyTypeError"}};var om=class extends Event{data;constructor(e,t){super("message",t),this.data=e}},ks=class extends Event{error;local;constructor(e,t,n){super("close",n),this.error=t,this.local=e}},im=class extends ks{constructor(e,t){super(!0,e,t)}},sm=class extends ks{constructor(e,t){super(!1,e,t)}};var Va=Symbol.for("@libp2p/peer-discovery");var am=Symbol.for("@libp2p/peer-id");function on(r){return!!r?.[am]}var Ri=Symbol.for("@libp2p/peer-routing");var Ha="keep-alive";function cm(r){return r!=null&&typeof r.start=="function"&&typeof r.stop=="function"}async function er(...r){let e=[];for(let t of r)cm(t)&&e.push(t);await Promise.all(e.map(async t=>{t.beforeStart!=null&&await t.beforeStart()})),await Promise.all(e.map(async t=>{await t.start()})),await Promise.all(e.map(async t=>{t.afterStart!=null&&await t.afterStart()}))}async function or(...r){let e=[];for(let t of r)cm(t)&&e.push(t);await Promise.all(e.map(async t=>{t.beforeStop!=null&&await t.beforeStop()})),await Promise.all(e.map(async t=>{await t.stop()})),await Promise.all(e.map(async t=>{t.afterStop!=null&&await t.afterStop()}))}var Os=Symbol.for("@libp2p/transport");var cd;(function(r){r[r.FATAL_ALL=0]="FATAL_ALL",r[r.NO_FATAL=1]="NO_FATAL"})(cd||(cd={}));var _e=class extends EventTarget{#e=new Map;constructor(){super()}listenerCount(e){let t=this.#e.get(e);return t==null?0:t.length}addEventListener(e,t,n){super.addEventListener(e,t,n);let o=this.#e.get(e);o==null&&(o=[],this.#e.set(e,o)),o.push({callback:t,once:(n!==!0&&n!==!1&&n?.once)??!1})}removeEventListener(e,t,n){super.removeEventListener(e.toString(),t??null,n);let o=this.#e.get(e);o!=null&&(o=o.filter(({callback:i})=>i!==t),this.#e.set(e,o))}dispatchEvent(e){let t=super.dispatchEvent(e),n=this.#e.get(e.type);return n==null||(n=n.filter(({once:o})=>!o),this.#e.set(e.type,n)),t}safeDispatchEvent(e,t={}){return this.dispatchEvent(new CustomEvent(e,t))}};var qe=Symbol.for("@libp2p/service-capabilities"),An=Symbol.for("@libp2p/service-dependencies");var f6={};Nt(f6,{base32:()=>ir,base32hex:()=>VN,base32hexpad:()=>qN,base32hexpadupper:()=>WN,base32hexupper:()=>HN,base32pad:()=>jN,base32padupper:()=>KN,base32upper:()=>$N,base32z:()=>zN});var Fz=new Uint8Array(0);function Qv(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function bo(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function Zv(r){return new TextEncoder().encode(r)}function Jv(r){return new TextDecoder().decode(r)}function NN(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var o=0;o<r.length;o++){var i=r.charAt(o),s=i.charCodeAt(0);if(t[s]!==255)throw new TypeError(i+" is ambiguous");t[s]=o}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),f=Math.log(256)/Math.log(a);function u(m){if(m instanceof Uint8Array||(ArrayBuffer.isView(m)?m=new Uint8Array(m.buffer,m.byteOffset,m.byteLength):Array.isArray(m)&&(m=Uint8Array.from(m))),!(m instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(m.length===0)return"";for(var w=0,y=0,b=0,N=m.length;b!==N&&m[b]===0;)b++,w++;for(var O=(N-b)*f+1>>>0,V=new Uint8Array(O);b!==N;){for(var Q=m[b],Z=0,se=O-1;(Q!==0||Z<y)&&se!==-1;se--,Z++)Q+=256*V[se]>>>0,V[se]=Q%a>>>0,Q=Q/a>>>0;if(Q!==0)throw new Error("Non-zero carry");y=Z,b++}for(var C=O-y;C!==O&&V[C]===0;)C++;for(var T=c.repeat(w);C<O;++C)T+=r.charAt(V[C]);return T}function d(m){if(typeof m!="string")throw new TypeError("Expected String");if(m.length===0)return new Uint8Array;var w=0;if(m[w]!==" "){for(var y=0,b=0;m[w]===c;)y++,w++;for(var N=(m.length-w)*l+1>>>0,O=new Uint8Array(N);m[w];){var V=t[m.charCodeAt(w)];if(V===255)return;for(var Q=0,Z=N-1;(V!==0||Q<b)&&Z!==-1;Z--,Q++)V+=a*O[Z]>>>0,O[Z]=V%256>>>0,V=V/256>>>0;if(V!==0)throw new Error("Non-zero carry");b=Q,w++}if(m[w]!==" "){for(var se=N-b;se!==N&&O[se]===0;)se++;for(var C=new Uint8Array(y+(N-se)),T=y;se!==N;)C[T++]=O[se++];return C}}}function h(m){var w=d(m);if(w)return w;throw new Error(`Non-${e} character`)}return{encode:u,decodeUnsafe:d,decode:h}}var LN=NN,BN=LN,ex=BN;var a6=class{name;prefix;baseEncode;constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},c6=class{name;prefix;baseDecode;prefixCodePoint;constructor(e,t,n){this.name=e,this.prefix=t;let o=t.codePointAt(0);if(o===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=o,this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return tx(this,e)}},l6=class{decoders;constructor(e){this.decoders=e}or(e){return tx(this,e)}decode(e){let t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};function tx(r,e){return new l6({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}var u6=class{name;prefix;baseEncode;baseDecode;encoder;decoder;constructor(e,t,n,o){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=o,this.encoder=new a6(e,t,n),this.decoder=new c6(e,t,o)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};function $l({name:r,prefix:e,encode:t,decode:n}){return new u6(r,e,t,n)}function Rs({name:r,prefix:e,alphabet:t}){let{encode:n,decode:o}=ex(t,r);return $l({prefix:e,name:r,encode:n,decode:i=>bo(o(i))})}function MN(r,e,t,n){let o=r.length;for(;r[o-1]==="=";)--o;let i=new Uint8Array(o*t/8|0),s=0,a=0,c=0;for(let l=0;l<o;++l){let f=e[r[l]];if(f===void 0)throw new SyntaxError(`Non-${n} character`);a=a<<t|f,s+=t,s>=8&&(s-=8,i[c++]=255&a>>s)}if(s>=t||(255&a<<8-s)!==0)throw new SyntaxError("Unexpected end of data");return i}function UN(r,e,t){let n=e[e.length-1]==="=",o=(1<<t)-1,i="",s=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],s+=8;s>t;)s-=t,i+=e[o&a>>s];if(s!==0&&(i+=e[o&a<<t-s]),n)for(;(i.length*t&7)!==0;)i+="=";return i}function FN(r){let e={};for(let t=0;t<r.length;++t)e[r[t]]=t;return e}function Lt({name:r,prefix:e,bitsPerChar:t,alphabet:n}){let o=FN(n);return $l({prefix:e,name:r,encode(i){return UN(i,n,t)},decode(i){return MN(i,o,t,r)}})}var ir=Lt({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),$N=Lt({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),jN=Lt({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),KN=Lt({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),VN=Lt({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),HN=Lt({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),qN=Lt({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),WN=Lt({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),zN=Lt({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});var d6={};Nt(d6,{base58btc:()=>ft,base58flickr:()=>GN});var ft=Rs({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),GN=Rs({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var h6={};Nt(h6,{base64:()=>Ht,base64pad:()=>ld,base64url:()=>qa,base64urlpad:()=>XN});var Ht=Lt({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),ld=Lt({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),qa=Lt({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),XN=Lt({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});function YN(r,e){if(typeof r=="string")return QN(r);if(typeof r=="number")return eL(r,e);throw Error(`Value provided to ms() must be a string or number. value=${JSON.stringify(r)}`)}var lm=YN;function QN(r){if(typeof r!="string"||r.length===0||r.length>100)throw Error(`Value provided to ms.parse() must be a string with length between 1 and 99. value=${JSON.stringify(r)}`);let e=/^(?<value>-?\d*\.?\d+) *(?<unit>milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|months?|mo|years?|yrs?|y)?$/i.exec(r);if(!e?.groups)return NaN;let{value:t,unit:n="ms"}=e.groups,o=parseFloat(t),i=n.toLowerCase();switch(i){case"years":case"year":case"yrs":case"yr":case"y":return o*315576e5;case"months":case"month":case"mo":return o*26298e5;case"weeks":case"week":case"w":return o*6048e5;case"days":case"day":case"d":return o*864e5;case"hours":case"hour":case"hrs":case"hr":case"h":return o*36e5;case"minutes":case"minute":case"mins":case"min":case"m":return o*6e4;case"seconds":case"second":case"secs":case"sec":case"s":return o*1e3;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return o;default:throw Error(`Unknown unit "${i}" provided to ms.parse(). value=${JSON.stringify(r)}`)}}function ZN(r){let e=Math.abs(r);return e>=315576e5?`${Math.round(r/315576e5)}y`:e>=26298e5?`${Math.round(r/26298e5)}mo`:e>=6048e5?`${Math.round(r/6048e5)}w`:e>=864e5?`${Math.round(r/864e5)}d`:e>=36e5?`${Math.round(r/36e5)}h`:e>=6e4?`${Math.round(r/6e4)}m`:e>=1e3?`${Math.round(r/1e3)}s`:`${r}ms`}function JN(r){let e=Math.abs(r);return e>=315576e5?Wa(r,e,315576e5,"year"):e>=26298e5?Wa(r,e,26298e5,"month"):e>=6048e5?Wa(r,e,6048e5,"week"):e>=864e5?Wa(r,e,864e5,"day"):e>=36e5?Wa(r,e,36e5,"hour"):e>=6e4?Wa(r,e,6e4,"minute"):e>=1e3?Wa(r,e,1e3,"second"):`${r} ms`}function eL(r,e){if(typeof r!="number"||!Number.isFinite(r))throw Error("Value provided to ms.format() must be of type number.");return e?.long?JN(r):ZN(r)}function Wa(r,e,t,n){let o=e>=t*1.5;return`${Math.round(r/t)} ${n}${o?"s":""}`}function p6(r){t.debug=t,t.default=t,t.coerce=c,t.disable=i,t.enable=o,t.enabled=s,t.humanize=lm,t.destroy=l,Object.keys(r).forEach(f=>{t[f]=r[f]}),t.names=[],t.skips=[],t.formatters={};function e(f){let u=0;for(let d=0;d<f.length;d++)u=(u<<5)-u+f.charCodeAt(d),u|=0;return t.colors[Math.abs(u)%t.colors.length]}t.selectColor=e;function t(f,u){let d,h=null,m,w;function y(...b){if(!y.enabled)return;let N=y,O=Number(new Date),V=O-(d||O);N.diff=V,N.prev=d,N.curr=O,d=O,b[0]=t.coerce(b[0]),typeof b[0]!="string"&&b.unshift("%O");let Q=0;b[0]=b[0].replace(/%([a-zA-Z%])/g,(se,C)=>{if(se==="%%")return"%";Q++;let T=t.formatters[C];if(typeof T=="function"){let K=b[Q];se=T.call(N,K),b.splice(Q,1),Q--}return se}),t.formatArgs.call(N,b),u?.onLog!=null&&u.onLog(...b),(N.log||t.log).apply(N,b)}return y.namespace=f,y.useColors=t.useColors(),y.color=t.selectColor(f),y.extend=n,y.destroy=t.destroy,Object.defineProperty(y,"enabled",{enumerable:!0,configurable:!1,get:()=>h!==null?h:(m!==t.namespaces&&(m=t.namespaces,w=t.enabled(f)),w),set:b=>{h=b}}),typeof t.init=="function"&&t.init(y),y}function n(f,u){let d=t(this.namespace+(typeof u>"u"?":":u)+f);return d.log=this.log,d}function o(f){t.save(f),t.namespaces=f,t.names=[],t.skips=[];let u,d=(typeof f=="string"?f:"").split(/[\s,]+/),h=d.length;for(u=0;u<h;u++)d[u]&&(f=d[u].replace(/\*/g,".*?"),f[0]==="-"?t.skips.push(new RegExp("^"+f.substr(1)+"$")):t.names.push(new RegExp("^"+f+"$")))}function i(){let f=[...t.names.map(a),...t.skips.map(a).map(u=>"-"+u)].join(",");return t.enable(""),f}function s(f){if(f[f.length-1]==="*")return!0;let u,d;for(u=0,d=t.skips.length;u<d;u++)if(t.skips[u].test(f))return!1;for(u=0,d=t.names.length;u<d;u++)if(t.names[u].test(f))return!0;return!1}function a(f){return f.toString().substring(2,f.toString().length-2).replace(/\.\*\?$/,"*")}function c(f){return f instanceof Error?f.stack??f.message:f}function l(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return t.setupFormatters(t.formatters),t.enable(t.load()),t}var um=aL(),tL=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function rL(){return typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs)?!0:typeof navigator<"u"&&navigator.userAgent?.toLowerCase().match(/(edge|trident)\/(\d+)/)!=null?!1:typeof document<"u"&&document.documentElement?.style?.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent?.toLowerCase().match(/firefox\/(\d+)/)!=null&&parseInt(RegExp.$1,10)>=31||typeof navigator<"u"&&navigator.userAgent?.toLowerCase().match(/applewebkit\/(\d+)/)}function nL(r){if(r[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+r[0]+(this.useColors?"%c ":" ")+"+"+lm(this.diff),!this.useColors)return;let e="color: "+this.color;r.splice(1,0,e,"color: inherit");let t=0,n=0;r[0].replace(/%[a-zA-Z%]/g,o=>{o!=="%%"&&(t++,o==="%c"&&(n=t))}),r.splice(n,0,e)}var oL=console.debug??console.log??(()=>{});function iL(r){try{r?um?.setItem("debug",r):um?.removeItem("debug")}catch{}}function sL(){let r;try{r=um?.getItem("debug")}catch{}return!r&&typeof globalThis.process<"u"&&"env"in globalThis.process&&(r=globalThis.process.env.DEBUG),r}function aL(){try{return localStorage}catch{}}function cL(r){r.j=function(e){try{return JSON.stringify(e)}catch(t){return"[UnexpectedJSONParseError]: "+t.message}}}var rx=p6({formatArgs:nL,save:iL,load:sL,useColors:rL,setupFormatters:cL,colors:tL,storage:um,log:oL});var sn=rx;sn.formatters.b=r=>r==null?"undefined":ft.baseEncode(r);sn.formatters.t=r=>r==null?"undefined":ir.baseEncode(r);sn.formatters.m=r=>r==null?"undefined":Ht.baseEncode(r);sn.formatters.p=r=>r==null?"undefined":r.toString();sn.formatters.c=r=>r==null?"undefined":r.toString();sn.formatters.k=r=>r==null?"undefined":r.toString();sn.formatters.a=r=>r==null?"undefined":r.toString();function nx(r,e=""){let t=ox(r.message),n=ox(r.stack);return t!=null&&n!=null?n.includes(t)?`${n.split(`
`).join(`
${e}`)}`:`${t}
${e}${n.split(`
`).join(`
${e}`)}`:n!=null?`${n.split(`
`).join(`
${e}`)}`:t!=null?`${t}`:`${r.toString()}`}function lL(r){return r instanceof AggregateError||r?.name==="AggregateError"&&Array.isArray(r.errors)}function ix(r,e=""){if(lL(r)){let t=nx(r,e);return r.errors.length>0?(e=`${e}    `,t+=`
${e}${r.errors.map(n=>`${ix(n,`${e}`)}`).join(`
${e}`)}`):t+=`
${e}[Error list was empty]`,t.trim()}return nx(r,e)}sn.formatters.e=r=>r==null?"undefined":ix(r);function uL(r){let e=()=>{};return e.enabled=!1,e.color="",e.diff=0,e.log=()=>{},e.namespace=r,e.destroy=()=>!0,e.extend=()=>e,e}function Qo(r){return{forComponent(e){return zn(e,r)}}}function zn(r,e){let t=uL(`${r}:trace`);return sn.enabled(`${r}:trace`)&&sn.names.map(n=>n.toString()).find(n=>n.includes(":trace"))!=null&&(t=sn(`${r}:trace`,e)),Object.assign(sn(r,e),{error:sn(`${r}:error`,e),trace:t,newScope:n=>zn(`${r}:${n}`,e)})}function ox(r){if(r!=null&&(r=r.trim(),r.length!==0))return r}var oe=class extends Event{type;detail;constructor(e,t){super(e),this.type=e,this.detail=t}};var fm=class extends AggregateError{static name="DNSQueryFailedError";name="DNSQueryFailedError"};var g6=nr(ax(),1);var y6=class r extends Error{name="TimeoutError";constructor(e,t){super(e,t),Error.captureStackTrace?.(this,r)}},cx=r=>r.reason??new DOMException("This operation was aborted.","AbortError");function w6(r,e){let{milliseconds:t,fallback:n,message:o,customTimers:i={setTimeout,clearTimeout},signal:s}=e,a,c,f=new Promise((u,d)=>{if(typeof t!="number"||Math.sign(t)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${t}\``);if(s?.aborted){d(cx(s));return}if(s&&(c=()=>{d(cx(s))},s.addEventListener("abort",c,{once:!0})),r.then(u,d),t===Number.POSITIVE_INFINITY)return;let h=new y6;a=i.setTimeout.call(void 0,()=>{if(n){try{u(n())}catch(m){d(m)}return}typeof r.cancel=="function"&&r.cancel(),o===!1?u():o instanceof Error?d(o):(h.message=o??`Promise timed out after ${t} milliseconds`,d(h))},t)}).finally(()=>{f.clear(),c&&s&&s.removeEventListener("abort",c)});return f.clear=()=>{i.clearTimeout.call(void 0,a),a=void 0},f}function b6(r,e,t){let n=0,o=r.length;for(;o>0;){let i=Math.trunc(o/2),s=n+i;t(r[s],e)<=0?(n=++s,o-=i+1):o=i}return n}var fd=class{#e=[];enqueue(e,t){let{priority:n=0,id:o}=t??{},i={priority:n,id:o,run:e};if(this.size===0||this.#e[this.size-1].priority>=n){this.#e.push(i);return}let s=b6(this.#e,i,(a,c)=>c.priority-a.priority);this.#e.splice(s,0,i)}setPriority(e,t){let n=this.#e.findIndex(i=>i.id===e);if(n===-1)throw new ReferenceError(`No promise function with the id "${e}" exists in the queue.`);let[o]=this.#e.splice(n,1);this.enqueue(o.run,{priority:t,id:e})}dequeue(){return this.#e.shift()?.run}filter(e){return this.#e.filter(t=>t.priority===e.priority).map(t=>t.run)}get size(){return this.#e.length}};var za=class extends g6.default{#e;#t;#r=0;#s;#i=!1;#f=!1;#d;#b=0;#g=0;#a;#c;#n;#v;#o=0;#h;#l;#T=1n;#p=new Map;timeout;constructor(e){if(super(),e={carryoverIntervalCount:!1,intervalCap:Number.POSITIVE_INFINITY,interval:0,concurrency:Number.POSITIVE_INFINITY,autoStart:!0,queueClass:fd,...e},!(typeof e.intervalCap=="number"&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${e.intervalCap?.toString()??""}\` (${typeof e.intervalCap})`);if(e.interval===void 0||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${e.interval?.toString()??""}\` (${typeof e.interval})`);if(this.#e=e.carryoverIntervalCount??e.carryoverConcurrencyCount??!1,this.#t=e.intervalCap===Number.POSITIVE_INFINITY||e.interval===0,this.#s=e.intervalCap,this.#d=e.interval,this.#n=new e.queueClass,this.#v=e.queueClass,this.concurrency=e.concurrency,e.timeout!==void 0&&!(Number.isFinite(e.timeout)&&e.timeout>0))throw new TypeError(`Expected \`timeout\` to be a positive finite number, got \`${e.timeout}\` (${typeof e.timeout})`);this.timeout=e.timeout,this.#l=e.autoStart===!1,this.#D()}get#I(){return this.#t||this.#r<this.#s}get#C(){return this.#o<this.#h}#P(){this.#o--,this.#o===0&&this.emit("pendingZero"),this.#y(),this.emit("next")}#k(){this.#_(),this.#S(),this.#c=void 0}get#O(){let e=Date.now();if(this.#a===void 0){let t=this.#b-e;if(t<0){if(this.#g>0){let n=e-this.#g;if(n<this.#d)return this.#x(this.#d-n),!0}this.#r=this.#e?this.#o:0}else return this.#x(t),!0}return!1}#x(e){this.#c===void 0&&(this.#c=setTimeout(()=>{this.#k()},e))}#E(){this.#a&&(clearInterval(this.#a),this.#a=void 0)}#R(){this.#c&&(clearTimeout(this.#c),this.#c=void 0)}#y(){if(this.#n.size===0)return this.#E(),this.emit("empty"),this.#o===0&&(this.#R(),this.emit("idle")),!1;let e=!1;if(!this.#l){let t=!this.#O;if(this.#I&&this.#C){let n=this.#n.dequeue();this.#t||(this.#r++,this.#m()),this.emit("active"),this.#g=Date.now(),n(),t&&this.#S(),e=!0}}return e}#S(){this.#t||this.#a!==void 0||(this.#a=setInterval(()=>{this.#_()},this.#d),this.#b=Date.now()+this.#d)}#_(){this.#r===0&&this.#o===0&&this.#a&&this.#E(),this.#r=this.#e?this.#o:0,this.#w(),this.#m()}#w(){for(;this.#y(););}get concurrency(){return this.#h}set concurrency(e){if(!(typeof e=="number"&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this.#h=e,this.#w()}setPriority(e,t){if(typeof t!="number"||!Number.isFinite(t))throw new TypeError(`Expected \`priority\` to be a finite number, got \`${t}\` (${typeof t})`);this.#n.setPriority(e,t)}async add(e,t={}){return t.id??=(this.#T++).toString(),t={timeout:this.timeout,...t},new Promise((n,o)=>{let i=Symbol(`task-${t.id}`);this.#n.enqueue(async()=>{this.#o++,this.#p.set(i,{id:t.id,priority:t.priority??0,startTime:Date.now(),timeout:t.timeout});let s;try{try{t.signal?.throwIfAborted()}catch(l){throw this.#t||this.#r--,this.#p.delete(i),l}let a=e({signal:t.signal});if(t.timeout&&(a=w6(Promise.resolve(a),{milliseconds:t.timeout,message:`Task timed out after ${t.timeout}ms (queue has ${this.#o} running, ${this.#n.size} waiting)`})),t.signal){let{signal:l}=t;a=Promise.race([a,new Promise((f,u)=>{s=()=>{u(l.reason)},l.addEventListener("abort",s,{once:!0})})])}let c=await a;n(c),this.emit("completed",c)}catch(a){o(a),this.emit("error",a)}finally{s&&t.signal?.removeEventListener("abort",s),this.#p.delete(i),queueMicrotask(()=>{this.#P()})}},t),this.emit("add"),this.#y()})}async addAll(e,t){return Promise.all(e.map(async n=>this.add(n,t)))}start(){return this.#l?(this.#l=!1,this.#w(),this):this}pause(){this.#l=!0}clear(){this.#n=new this.#v,this.#A()}async onEmpty(){this.#n.size!==0&&await this.#u("empty")}async onSizeLessThan(e){this.#n.size<e||await this.#u("next",()=>this.#n.size<e)}async onIdle(){this.#o===0&&this.#n.size===0||await this.#u("idle")}async onPendingZero(){this.#o!==0&&await this.#u("pendingZero")}async onRateLimit(){this.isRateLimited||await this.#u("rateLimit")}async onRateLimitCleared(){this.isRateLimited&&await this.#u("rateLimitCleared")}async onError(){return new Promise((e,t)=>{let n=o=>{this.off("error",n),t(o)};this.on("error",n)})}async#u(e,t){return new Promise(n=>{let o=()=>{t&&!t()||(this.off(e,o),n())};this.on(e,o)})}get size(){return this.#n.size}sizeBy(e){return this.#n.filter(e).length}get pending(){return this.#o}get isPaused(){return this.#l}#D(){this.#t||(this.on("add",()=>{this.#n.size>0&&this.#m()}),this.on("next",()=>{this.#m()}))}#m(){this.#t||this.#f||(this.#f=!0,queueMicrotask(()=>{this.#f=!1,this.#A()}))}#A(){let e=this.#i,t=!this.#t&&this.#r>=this.#s&&this.#n.size>0;t!==e&&(this.#i=t,this.emit(t?"rateLimit":"rateLimitCleared"))}get isRateLimited(){return this.#i}get isSaturated(){return this.#o===this.#h&&this.#n.size>0||this.isRateLimited&&this.#n.size>0}get runningTasks(){return[...this.#p.values()].map(e=>({...e}))}};function hm(r){let e=[Tn.A];return r==null?e:Array.isArray(r)?r.length===0?e:r:[r]}var v6={};Nt(v6,{base10:()=>hL});var hL=Rs({prefix:"9",name:"base10",alphabet:"0123456789"});var x6={};Nt(x6,{base16:()=>pL,base16upper:()=>mL});var pL=Lt({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),mL=Lt({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4});var E6={};Nt(E6,{base2:()=>gL});var gL=Lt({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1});var S6={};Nt(S6,{base256emoji:()=>xL});var lx=Array.from("\u{1F680}\u{1FA90}\u2604\u{1F6F0}\u{1F30C}\u{1F311}\u{1F312}\u{1F313}\u{1F314}\u{1F315}\u{1F316}\u{1F317}\u{1F318}\u{1F30D}\u{1F30F}\u{1F30E}\u{1F409}\u2600\u{1F4BB}\u{1F5A5}\u{1F4BE}\u{1F4BF}\u{1F602}\u2764\u{1F60D}\u{1F923}\u{1F60A}\u{1F64F}\u{1F495}\u{1F62D}\u{1F618}\u{1F44D}\u{1F605}\u{1F44F}\u{1F601}\u{1F525}\u{1F970}\u{1F494}\u{1F496}\u{1F499}\u{1F622}\u{1F914}\u{1F606}\u{1F644}\u{1F4AA}\u{1F609}\u263A\u{1F44C}\u{1F917}\u{1F49C}\u{1F614}\u{1F60E}\u{1F607}\u{1F339}\u{1F926}\u{1F389}\u{1F49E}\u270C\u2728\u{1F937}\u{1F631}\u{1F60C}\u{1F338}\u{1F64C}\u{1F60B}\u{1F497}\u{1F49A}\u{1F60F}\u{1F49B}\u{1F642}\u{1F493}\u{1F929}\u{1F604}\u{1F600}\u{1F5A4}\u{1F603}\u{1F4AF}\u{1F648}\u{1F447}\u{1F3B6}\u{1F612}\u{1F92D}\u2763\u{1F61C}\u{1F48B}\u{1F440}\u{1F62A}\u{1F611}\u{1F4A5}\u{1F64B}\u{1F61E}\u{1F629}\u{1F621}\u{1F92A}\u{1F44A}\u{1F973}\u{1F625}\u{1F924}\u{1F449}\u{1F483}\u{1F633}\u270B\u{1F61A}\u{1F61D}\u{1F634}\u{1F31F}\u{1F62C}\u{1F643}\u{1F340}\u{1F337}\u{1F63B}\u{1F613}\u2B50\u2705\u{1F97A}\u{1F308}\u{1F608}\u{1F918}\u{1F4A6}\u2714\u{1F623}\u{1F3C3}\u{1F490}\u2639\u{1F38A}\u{1F498}\u{1F620}\u261D\u{1F615}\u{1F33A}\u{1F382}\u{1F33B}\u{1F610}\u{1F595}\u{1F49D}\u{1F64A}\u{1F639}\u{1F5E3}\u{1F4AB}\u{1F480}\u{1F451}\u{1F3B5}\u{1F91E}\u{1F61B}\u{1F534}\u{1F624}\u{1F33C}\u{1F62B}\u26BD\u{1F919}\u2615\u{1F3C6}\u{1F92B}\u{1F448}\u{1F62E}\u{1F646}\u{1F37B}\u{1F343}\u{1F436}\u{1F481}\u{1F632}\u{1F33F}\u{1F9E1}\u{1F381}\u26A1\u{1F31E}\u{1F388}\u274C\u270A\u{1F44B}\u{1F630}\u{1F928}\u{1F636}\u{1F91D}\u{1F6B6}\u{1F4B0}\u{1F353}\u{1F4A2}\u{1F91F}\u{1F641}\u{1F6A8}\u{1F4A8}\u{1F92C}\u2708\u{1F380}\u{1F37A}\u{1F913}\u{1F619}\u{1F49F}\u{1F331}\u{1F616}\u{1F476}\u{1F974}\u25B6\u27A1\u2753\u{1F48E}\u{1F4B8}\u2B07\u{1F628}\u{1F31A}\u{1F98B}\u{1F637}\u{1F57A}\u26A0\u{1F645}\u{1F61F}\u{1F635}\u{1F44E}\u{1F932}\u{1F920}\u{1F927}\u{1F4CC}\u{1F535}\u{1F485}\u{1F9D0}\u{1F43E}\u{1F352}\u{1F617}\u{1F911}\u{1F30A}\u{1F92F}\u{1F437}\u260E\u{1F4A7}\u{1F62F}\u{1F486}\u{1F446}\u{1F3A4}\u{1F647}\u{1F351}\u2744\u{1F334}\u{1F4A3}\u{1F438}\u{1F48C}\u{1F4CD}\u{1F940}\u{1F922}\u{1F445}\u{1F4A1}\u{1F4A9}\u{1F450}\u{1F4F8}\u{1F47B}\u{1F910}\u{1F92E}\u{1F3BC}\u{1F975}\u{1F6A9}\u{1F34E}\u{1F34A}\u{1F47C}\u{1F48D}\u{1F4E3}\u{1F942}"),yL=lx.reduce((r,e,t)=>(r[t]=e,r),[]),wL=lx.reduce((r,e,t)=>{let n=e.codePointAt(0);if(n==null)throw new Error(`Invalid character: ${e}`);return r[n]=t,r},[]);function bL(r){return r.reduce((e,t)=>(e+=yL[t],e),"")}function vL(r){let e=[];for(let t of r){let n=t.codePointAt(0);if(n==null)throw new Error(`Invalid character: ${t}`);let o=wL[n];if(o==null)throw new Error(`Non-base256emoji character: ${t}`);e.push(o)}return new Uint8Array(e)}var xL=$l({prefix:"\u{1F680}",name:"base256emoji",encode:bL,decode:vL});var _6={};Nt(_6,{base36:()=>Gn,base36upper:()=>EL});var Gn=Rs({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),EL=Rs({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});var A6={};Nt(A6,{base8:()=>SL});var SL=Lt({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3});var T6={};Nt(T6,{identity:()=>_L});var _L=$l({prefix:"\0",name:"identity",encode:r=>Jv(r),decode:r=>Zv(r)});var pm={};Nt(pm,{code:()=>I6,decode:()=>PL,encode:()=>CL,name:()=>IL});var AL=new TextEncoder,TL=new TextDecoder,IL="json",I6=512;function CL(r){return AL.encode(JSON.stringify(r))}function PL(r){return JSON.parse(TL.decode(r))}var jl={};Nt(jl,{code:()=>Ga,decode:()=>RL,encode:()=>OL,name:()=>kL});var kL="raw",Ga=85;function OL(r){return bo(r)}function RL(r){return bo(r)}var k6={};Nt(k6,{identity:()=>Dr});var Bt={};Nt(Bt,{Digest:()=>Xa,create:()=>Wr,decode:()=>lt,equals:()=>P6,hasCode:()=>QL});var DL=dx,ux=128,NL=127,LL=~NL,BL=Math.pow(2,31);function dx(r,e,t){e=e||[],t=t||0;for(var n=t;r>=BL;)e[t++]=r&255|ux,r/=128;for(;r&LL;)e[t++]=r&255|ux,r>>>=7;return e[t]=r|0,dx.bytes=t-n+1,e}var ML=C6,UL=128,fx=127;function C6(r,n){var t=0,n=n||0,o=0,i=n,s,a=r.length;do{if(i>=a)throw C6.bytes=0,new RangeError("Could not decode varint");s=r[i++],t+=o<28?(s&fx)<<o:(s&fx)*Math.pow(2,o),o+=7}while(s>=UL);return C6.bytes=i-n,t}var FL=Math.pow(2,7),$L=Math.pow(2,14),jL=Math.pow(2,21),KL=Math.pow(2,28),VL=Math.pow(2,35),HL=Math.pow(2,42),qL=Math.pow(2,49),WL=Math.pow(2,56),zL=Math.pow(2,63),GL=function(r){return r<FL?1:r<$L?2:r<jL?3:r<KL?4:r<VL?5:r<HL?6:r<qL?7:r<WL?8:r<zL?9:10},XL={encode:DL,decode:ML,encodingLength:GL},YL=XL,dd=YL;function hd(r,e=0){return[dd.decode(r,e),dd.decode.bytes]}function Kl(r,e,t=0){return dd.encode(r,e,t),e}function Vl(r){return dd.encodingLength(r)}function Wr(r,e){let t=e.byteLength,n=Vl(r),o=n+Vl(t),i=new Uint8Array(o+t);return Kl(r,i,0),Kl(t,i,n),i.set(e,o),new Xa(r,t,e,i)}function lt(r){let e=bo(r),[t,n]=hd(e),[o,i]=hd(e.subarray(n)),s=e.subarray(n+i);if(s.byteLength!==o)throw new Error("Incorrect length");return new Xa(t,o,s,e)}function P6(r,e){if(r===e)return!0;{let t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&Qv(r.bytes,t.bytes)}}var Xa=class{code;size;digest;bytes;constructor(e,t,n,o){this.code=e,this.size=t,this.digest=n,this.bytes=o}};function QL(r,e){return r.code===e}var hx=0,ZL="identity",px=bo;function JL(r,e){if(e?.truncate!=null&&e.truncate!==r.byteLength){if(e.truncate<0||e.truncate>r.byteLength)throw new Error(`Invalid truncate option, must be less than or equal to ${r.byteLength}`);r=r.subarray(0,e.truncate)}return Wr(hx,px(r))}var Dr={code:hx,name:ZL,encode:px,digest:JL};var R6={};Nt(R6,{sha256:()=>St,sha512:()=>gm});var eB=20;function pd({name:r,code:e,encode:t,minDigestLength:n,maxDigestLength:o}){return new O6(r,e,t,n,o)}var O6=class{name;code;encode;minDigestLength;maxDigestLength;constructor(e,t,n,o,i){this.name=e,this.code=t,this.encode=n,this.minDigestLength=o??eB,this.maxDigestLength=i}digest(e,t){if(t?.truncate!=null){if(t.truncate<this.minDigestLength)throw new Error(`Invalid truncate option, must be greater than or equal to ${this.minDigestLength}`);if(this.maxDigestLength!=null&&t.truncate>this.maxDigestLength)throw new Error(`Invalid truncate option, must be less than or equal to ${this.maxDigestLength}`)}if(e instanceof Uint8Array){let n=this.encode(e);return n instanceof Uint8Array?mx(n,this.code,t?.truncate):n.then(o=>mx(o,this.code,t?.truncate))}else throw Error("Unknown type, must be binary type")}};function mx(r,e,t){if(t!=null&&t!==r.byteLength){if(t>r.byteLength)throw new Error(`Invalid truncate option, must be less than or equal to ${r.byteLength}`);r=r.subarray(0,t)}return Wr(e,r)}function yx(r){return async e=>new Uint8Array(await crypto.subtle.digest(r,e))}var St=pd({name:"sha2-256",code:18,encode:yx("SHA-256")}),gm=pd({name:"sha2-512",code:19,encode:yx("SHA-512")});function wx(r,e){let{bytes:t,version:n}=r;switch(n){case 0:return rB(t,D6(r),e??ft.encoder);default:return nB(t,D6(r),e??ir.encoder)}}var bx=new WeakMap;function D6(r){let e=bx.get(r);if(e==null){let t=new Map;return bx.set(r,t),t}return e}var he=class r{code;version;multihash;bytes;"/";constructor(e,t,n,o){this.code=t,this.version=e,this.multihash=n,this.bytes=o,this["/"]=o}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{let{code:e,multihash:t}=this;if(e!==md)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==oB)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return r.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{let{code:e,digest:t}=this.multihash,n=Wr(e,t);return r.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return r.equals(this,e)}static equals(e,t){let n=t;return n!=null&&e.code===n.code&&e.version===n.version&&P6(e.multihash,n.multihash)}toString(e){return wx(this,e)}toJSON(){return{"/":wx(this)}}link(){return this}[Symbol.toStringTag]="CID";[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;let t=e;if(t instanceof r)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){let{version:n,code:o,multihash:i,bytes:s}=t;return new r(n,o,i,s??vx(n,o,i.bytes))}else if(t[iB]===!0){let{version:n,multihash:o,code:i}=t,s=lt(o);return r.create(n,i,s)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==md)throw new Error(`Version 0 CID must use dag-pb (code: ${md}) block encoding`);return new r(e,t,n,n.bytes)}case 1:{let o=vx(e,t,n.bytes);return new r(e,t,n,o)}default:throw new Error("Invalid version")}}static createV0(e){return r.create(0,md,e)}static createV1(e,t){return r.create(1,e,t)}static decode(e){let[t,n]=r.decodeFirst(e);if(n.length!==0)throw new Error("Incorrect length");return t}static decodeFirst(e){let t=r.inspectBytes(e),n=t.size-t.multihashSize,o=bo(e.subarray(n,n+t.multihashSize));if(o.byteLength!==t.multihashSize)throw new Error("Incorrect length");let i=o.subarray(t.multihashSize-t.digestSize),s=new Xa(t.multihashCode,t.digestSize,i,o);return[t.version===0?r.createV0(s):r.createV1(t.codec,s),e.subarray(t.size)]}static inspectBytes(e){let t=0,n=()=>{let[u,d]=hd(e.subarray(t));return t+=d,u},o=n(),i=md;if(o===18?(o=0,t=0):i=n(),o!==0&&o!==1)throw new RangeError(`Invalid CID version ${o}`);let s=t,a=n(),c=n(),l=t+c,f=l-s;return{version:o,codec:i,multihashCode:a,digestSize:c,multihashSize:f,size:l}}static parse(e,t){let[n,o]=tB(e,t),i=r.decode(o);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return D6(i).set(n,e),i}};function tB(r,e){switch(r[0]){case"Q":{let t=e??ft;return[ft.prefix,t.decode(`${ft.prefix}${r}`)]}case ft.prefix:{let t=e??ft;return[ft.prefix,t.decode(r)]}case ir.prefix:{let t=e??ir;return[ir.prefix,t.decode(r)]}case Gn.prefix:{let t=e??Gn;return[Gn.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}}function rB(r,e,t){let{prefix:n}=t;if(n!==ft.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);let o=e.get(n);if(o==null){let i=t.encode(r).slice(1);return e.set(n,i),i}else return o}function nB(r,e,t){let{prefix:n}=t,o=e.get(n);if(o==null){let i=t.encode(r);return e.set(n,i),i}else return o}var md=112,oB=18;function vx(r,e,t){let n=Vl(r),o=n+Vl(e),i=new Uint8Array(o+t.byteLength);return Kl(r,i,0),Kl(e,i,n),i.set(t,o),i}var iB=Symbol.for("@ipld/js-cid/CID");var Ya={...T6,...E6,...A6,...v6,...x6,...f6,..._6,...d6,...h6,...S6},XG={...R6,...k6};function ke(r=0){return new Uint8Array(r)}function Ot(r=0){return new Uint8Array(r)}function Ex(r,e,t,n){return{name:r,prefix:e,encoder:{name:r,prefix:e,encode:t},decoder:{decode:n}}}var xx=Ex("utf8","u",r=>"u"+new TextDecoder("utf8").decode(r),r=>new TextEncoder().encode(r.substring(1))),N6=Ex("ascii","a",r=>{let e="a";for(let t=0;t<r.length;t++)e+=String.fromCharCode(r[t]);return e},r=>{r=r.substring(1);let e=Ot(r.length);for(let t=0;t<r.length;t++)e[t]=r.charCodeAt(t);return e}),sB={utf8:xx,"utf-8":xx,hex:Ya.base16,latin1:N6,ascii:N6,binary:N6,...Ya},ym=sB;function j(r,e="utf8"){let t=ym[e];if(t==null)throw new Error(`Unsupported encoding "${e}"`);return t.encoder.encode(r).substring(1)}var L6=60;function wm(r){return{Status:r.Status??0,TC:r.TC??r.flag_tc??!1,RD:r.RD??r.flag_rd??!1,RA:r.RA??r.flag_ra??!1,AD:r.AD??r.flag_ad??!1,CD:r.CD??r.flag_cd??!1,Question:(r.Question??r.questions??[]).map(e=>({name:e.name,type:Tn[e.type]})),Answer:(r.Answer??r.answers??[]).map(e=>({name:e.name,type:Tn[e.type],TTL:e.TTL??e.ttl??L6,data:e.data instanceof Uint8Array?j(e.data):e.data}))}}var aB=4;function B6(r,e={}){let t=new za({concurrency:e.queryConcurrency??aB});return async(n,o={})=>{let i=new URLSearchParams;i.set("name",n),hm(o.types).forEach(a=>{i.append("type",Tn[a])}),o.onProgress?.(new oe("dns:query",n));let s=await t.add(async()=>{let a=await fetch(`${r}?${i}`,{headers:{accept:"application/dns-json"},signal:o?.signal});if(a.status!==200)throw new Error(`Unexpected HTTP status: ${a.status} - ${a.statusText}`);let c=wm(await a.json());return o.onProgress?.(new oe("dns:response",c)),c},{signal:o.signal});if(s==null)throw new Error("No DNS response received");return s}}function Sx(){return[B6("https://cloudflare-dns.com/dns-query"),B6("https://dns.google/resolve")]}var Tx=nr(Ax(),1);var M6=class{lru;constructor(e){this.lru=(0,Tx.default)(e)}get(e,t){let n=!0,o=[];for(let i of t){let s=this.getAnswers(e,i);if(s.length===0){n=!1;break}o.push(...s)}if(n)return wm({answers:o})}getAnswers(e,t){let n=`${e.toLowerCase()}-${t}`,o=this.lru.get(n);if(o!=null){let i=o.filter(s=>s.expires>Date.now()).map(({expires:s,value:a})=>({...a,TTL:Math.round((s-Date.now())/1e3),type:Tn[a.type]}));return i.length===0&&this.lru.remove(n),i}return[]}add(e,t){let n=`${e.toLowerCase()}-${t.type}`,o=this.lru.get(n)??[];o.push({expires:Date.now()+(t.TTL??L6)*1e3,value:t}),this.lru.set(n,o)}remove(e,t){let n=`${e.toLowerCase()}-${t}`;this.lru.remove(n)}clear(){this.lru.clear()}};function Ix(r){return new M6(r)}var cB=1e3,bm=class{resolvers;cache;constructor(e){this.resolvers={},this.cache=Ix(e.cacheSize??cB),Object.entries(e.resolvers??{}).forEach(([t,n])=>{Array.isArray(n)||(n=[n]),t.endsWith(".")||(t=`${t}.`),this.resolvers[t]=n}),this.resolvers["."]==null&&(this.resolvers["."]=Sx())}async query(e,t={}){let n=hm(t.types),o=t.cached!==!1?this.cache.get(e,n):void 0;if(o!=null)return t.onProgress?.(new oe("dns:cache",o)),o;let i=`${e.split(".").pop()}.`,s=(this.resolvers[i]??this.resolvers["."]).sort(()=>Math.random()>.5?-1:1),a=[];for(let c of s){if(t.signal?.aborted===!0)break;try{let l=await c(e,{...t,types:n});for(let f of l.Answer)this.cache.add(e,f);return l}catch(l){a.push(l),t.onProgress?.(new oe("dns:error",l))}}throw new fm(a,`DNS lookup of ${e} ${n} failed`)}};var Tn;(function(r){r[r.A=1]="A",r[r.CNAME=5]="CNAME",r[r.TXT=16]="TXT",r[r.AAAA=28]="AAAA"})(Tn||(Tn={}));function vm(r={}){return new bm(r)}function lB(r){return r[Symbol.asyncIterator]!=null}function uB(r){if(lB(r))return(async()=>{for await(let e of r);})();for(let e of r);}var an=uB;var gd=class extends Error{constructor(e="An error occurred while signing a message"){super(e),this.name="SigningError"}},yd=class extends Error{constructor(e="An error occurred while verifying a message"){super(e),this.name="VerificationError"}},xm=class extends Error{constructor(e="Missing Web Crypto API"){super(e),this.name="WebCryptoMissingError"}};var Cx={get(r=globalThis){let e=r.crypto;if(e?.subtle==null)throw new xm("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p/blob/main/packages/crypto/README.md#web-crypto-api");return e}};var qt=Cx;function we(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function gt(r,e){e==null&&(e=r.reduce((o,i)=>o+i.length,0));let t=Ot(e),n=0;for(let o of r)t.set(o,n),n+=o.length;return t}var kx=Symbol.for("@achingbrain/uint8arraylist");function Px(r,e){if(e==null||e<0)throw new RangeError("index is out of bounds");let t=0;for(let n of r){let o=t+n.byteLength;if(e<o)return{buf:n,index:e-t};t=o}throw new RangeError("index is out of bounds")}function Hl(r){return!!r?.[kx]}var fe=class r{bufs;length;[kx]=!0;constructor(...e){this.bufs=[],this.length=0,e.length>0&&this.appendAll(e)}*[Symbol.iterator](){yield*this.bufs}get byteLength(){return this.length}append(...e){this.appendAll(e)}appendAll(e){let t=0;for(let n of e)if(n instanceof Uint8Array)t+=n.byteLength,this.bufs.push(n);else if(Hl(n))t+=n.byteLength,this.bufs.push(...n.bufs);else throw new Error("Could not append value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}prepend(...e){this.prependAll(e)}prependAll(e){let t=0;for(let n of e.reverse())if(n instanceof Uint8Array)t+=n.byteLength,this.bufs.unshift(n);else if(Hl(n))t+=n.byteLength,this.bufs.unshift(...n.bufs);else throw new Error("Could not prepend value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}get(e){let t=Px(this.bufs,e);return t.buf[t.index]}set(e,t){let n=Px(this.bufs,e);n.buf[n.index]=t}write(e,t=0){if(e instanceof Uint8Array)for(let n=0;n<e.length;n++)this.set(t+n,e[n]);else if(Hl(e))for(let n=0;n<e.length;n++)this.set(t+n,e.get(n));else throw new Error("Could not write value, must be an Uint8Array or a Uint8ArrayList")}consume(e){if(e=Math.trunc(e),!(Number.isNaN(e)||e<=0)){if(e===this.byteLength){this.bufs=[],this.length=0;return}for(;this.bufs.length>0;)if(e>=this.bufs[0].byteLength)e-=this.bufs[0].byteLength,this.length-=this.bufs[0].byteLength,this.bufs.shift();else{this.bufs[0]=this.bufs[0].subarray(e),this.length-=e;break}}}slice(e,t){let{bufs:n,length:o}=this._subList(e,t);return gt(n,o)}subarray(e,t){let{bufs:n,length:o}=this._subList(e,t);return n.length===1?n[0]:gt(n,o)}sublist(e,t){let{bufs:n,length:o}=this._subList(e,t),i=new r;return i.length=o,i.bufs=[...n],i}_subList(e,t){if(e=e??0,t=t??this.length,e<0&&(e=this.length+e),t<0&&(t=this.length+t),e<0||t>this.length)throw new RangeError("index is out of bounds");if(e===t)return{bufs:[],length:0};if(e===0&&t===this.length)return{bufs:this.bufs,length:this.length};let n=[],o=0;for(let i=0;i<this.bufs.length;i++){let s=this.bufs[i],a=o,c=a+s.byteLength;if(o=c,e>=c)continue;let l=e>=a&&e<c,f=t>a&&t<=c;if(l&&f){if(e===a&&t===c){n.push(s);break}let u=e-a;n.push(s.subarray(u,u+(t-e)));break}if(l){if(e===0){n.push(s);continue}n.push(s.subarray(e-a));continue}if(f){if(t===c){n.push(s);break}n.push(s.subarray(0,t-a));break}n.push(s)}return{bufs:n,length:t-e}}indexOf(e,t=0){if(!Hl(e)&&!(e instanceof Uint8Array))throw new TypeError('The "value" argument must be a Uint8ArrayList or Uint8Array');let n=e instanceof Uint8Array?e:e.subarray();if(t=Number(t??0),isNaN(t)&&(t=0),t<0&&(t=this.length+t),t<0&&(t=0),e.length===0)return t>this.length?this.length:t;let o=n.byteLength;if(o===0)throw new TypeError("search must be at least 1 byte long");let i=256,s=new Int32Array(i);for(let u=0;u<i;u++)s[u]=-1;for(let u=0;u<o;u++)s[n[u]]=u;let a=s,c=this.byteLength-n.byteLength,l=n.byteLength-1,f;for(let u=t;u<=c;u+=f){f=0;for(let d=l;d>=0;d--){let h=this.get(u+d);if(n[d]!==h){f=Math.max(1,d-a[h]);break}}if(f===0)return u}return-1}getInt8(e){let t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getInt8(0)}setInt8(e,t){let n=Ot(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setInt8(0,t),this.write(n,e)}getInt16(e,t){let n=this.subarray(e,e+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt16(0,t)}setInt16(e,t,n){let o=ke(2);new DataView(o.buffer,o.byteOffset,o.byteLength).setInt16(0,t,n),this.write(o,e)}getInt32(e,t){let n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt32(0,t)}setInt32(e,t,n){let o=ke(4);new DataView(o.buffer,o.byteOffset,o.byteLength).setInt32(0,t,n),this.write(o,e)}getBigInt64(e,t){let n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigInt64(0,t)}setBigInt64(e,t,n){let o=ke(8);new DataView(o.buffer,o.byteOffset,o.byteLength).setBigInt64(0,t,n),this.write(o,e)}getUint8(e){let t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getUint8(0)}setUint8(e,t){let n=Ot(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setUint8(0,t),this.write(n,e)}getUint16(e,t){let n=this.subarray(e,e+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint16(0,t)}setUint16(e,t,n){let o=ke(2);new DataView(o.buffer,o.byteOffset,o.byteLength).setUint16(0,t,n),this.write(o,e)}getUint32(e,t){let n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint32(0,t)}setUint32(e,t,n){let o=ke(4);new DataView(o.buffer,o.byteOffset,o.byteLength).setUint32(0,t,n),this.write(o,e)}getBigUint64(e,t){let n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigUint64(0,t)}setBigUint64(e,t,n){let o=ke(8);new DataView(o.buffer,o.byteOffset,o.byteLength).setBigUint64(0,t,n),this.write(o,e)}getFloat32(e,t){let n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat32(0,t)}setFloat32(e,t,n){let o=ke(4);new DataView(o.buffer,o.byteOffset,o.byteLength).setFloat32(0,t,n),this.write(o,e)}getFloat64(e,t){let n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat64(0,t)}setFloat64(e,t,n){let o=ke(8);new DataView(o.buffer,o.byteOffset,o.byteLength).setFloat64(0,t,n),this.write(o,e)}equals(e){if(e==null||!(e instanceof r)||e.bufs.length!==this.bufs.length)return!1;for(let t=0;t<this.bufs.length;t++)if(!we(this.bufs[t],e.bufs[t]))return!1;return!0}static fromUint8Arrays(e,t){let n=new r;return n.bufs=e,t==null&&(t=e.reduce((o,i)=>o+i.byteLength,0)),n.length=t,n}};function B(r,e="utf8"){let t=ym[e];if(t==null)throw new Error(`Unsupported encoding "${e}"`);return t.decoder.decode(`${t.prefix}${r}`)}var dB=parseInt("11111",2),U6=parseInt("10000000",2),hB=parseInt("01111111",2),Ox={0:wd,1:wd,2:pB,3:yB,4:wB,5:gB,6:mB,16:wd,22:wd,48:wd};function Xn(r,e={offset:0}){let t=r[e.offset]&dB;if(e.offset++,Ox[t]!=null)return Ox[t](r,e);throw new Error("No decoder for tag "+t)}function bd(r,e){let t=0;if((r[e.offset]&U6)===U6){let n=r[e.offset]&hB,o="0x";e.offset++;for(let i=0;i<n;i++,e.offset++)o+=r[e.offset].toString(16).padStart(2,"0");t=parseInt(o,16)}else t=r[e.offset],e.offset++;return t}function wd(r,e){bd(r,e);let t=[];for(;!(e.offset>=r.byteLength);){let n=Xn(r,e);if(n===null)break;t.push(n)}return t}function pB(r,e){let t=bd(r,e),n=e.offset,o=e.offset+t,i=[];for(let s=n;s<o;s++)s===n&&r[s]===0||i.push(r[s]);return e.offset+=t,Uint8Array.from(i)}function mB(r,e){let t=bd(r,e),n=e.offset+t,o=r[e.offset];e.offset++;let i=0,s=0;o<40?(i=0,s=o):o<80?(i=1,s=o-40):(i=2,s=o-80);let a=`${i}.${s}`,c=[];for(;e.offset<n;){let l=r[e.offset];if(e.offset++,c.push(l&127),l<128){c.reverse();let f=0;for(let u=0;u<c.length;u++)f+=c[u]<<u*7;a+=`.${f}`,c=[]}}return a}function gB(r,e){return e.offset++,null}function yB(r,e){let t=bd(r,e),n=r[e.offset];e.offset++;let o=r.subarray(e.offset,e.offset+t-1);if(e.offset+=t,n!==0)throw new Error("Unused bits in bit string is unimplemented");return o}function wB(r,e){let t=bd(r,e),n=r.subarray(e.offset,e.offset+t);return e.offset+=t,n}function bB(r){let e=r.toString(16);e.length%2===1&&(e="0"+e);let t=new fe;for(let n=0;n<e.length;n+=2)t.append(Uint8Array.from([parseInt(`${e[n]}${e[n+1]}`,16)]));return t}function Em(r){if(r.byteLength<128)return Uint8Array.from([r.byteLength]);let e=bB(r.byteLength);return new fe(Uint8Array.from([e.byteLength|U6]),e)}function zr(r){let e=new fe,t=128;return(r.subarray()[0]&t)===t&&e.append(Uint8Array.from([0])),e.append(r),new fe(Uint8Array.from([2]),Em(e),e)}function vd(r){let e=Uint8Array.from([0]),t=new fe(e,r);return new fe(Uint8Array.from([3]),Em(t),t)}function Rx(r){return new fe(Uint8Array.from([4]),Em(r),r)}function vo(r,e=48){let t=new fe;for(let n of r)t.append(n);return new fe(Uint8Array.from([e]),Em(t),t)}var Dx="1.2.840.10045.3.1.7",Nx="1.3.132.0.34",Lx="1.3.132.0.35";async function Bx(r="P-256"){let e=await crypto.subtle.generateKey({name:"ECDSA",namedCurve:r},!0,["sign","verify"]);return{publicKey:await crypto.subtle.exportKey("jwk",e.publicKey),privateKey:await crypto.subtle.exportKey("jwk",e.privateKey)}}async function Mx(r,e,t){let n=await crypto.subtle.importKey("jwk",r,{name:"ECDSA",namedCurve:r.crv??"P-256"},!1,["sign"]);t?.signal?.throwIfAborted();let o=await crypto.subtle.sign({name:"ECDSA",hash:{name:"SHA-256"}},n,e.subarray());return t?.signal?.throwIfAborted(),new Uint8Array(o,0,o.byteLength)}async function Ux(r,e,t,n){let o=await crypto.subtle.importKey("jwk",r,{name:"ECDSA",namedCurve:r.crv??"P-256"},!1,["verify"]);n?.signal?.throwIfAborted();let i=await crypto.subtle.verify({name:"ECDSA",hash:{name:"SHA-256"}},o,e,t.subarray());return n?.signal?.throwIfAborted(),i}var vB=Uint8Array.from([6,8,42,134,72,206,61,3,1,7]),xB=Uint8Array.from([6,5,43,129,4,0,34]),EB=Uint8Array.from([6,5,43,129,4,0,35]),Fx={ext:!0,kty:"EC",crv:"P-256"},$x={ext:!0,kty:"EC",crv:"P-384"},jx={ext:!0,kty:"EC",crv:"P-521"},ql=32,Wl=48,zl=66;function Kx(r){let e=Xn(r);return F6(e)}function F6(r){let e=r[1],t=j(e,"base64url"),n=r[2][1][0],o=1,i,s;if(e.byteLength===ql)return i=j(n.subarray(o,o+ql),"base64url"),s=j(n.subarray(o+ql),"base64url"),new Za({...Fx,key_ops:["sign"],d:t,x:i,y:s});if(e.byteLength===Wl)return i=j(n.subarray(o,o+Wl),"base64url"),s=j(n.subarray(o+Wl),"base64url"),new Za({...$x,key_ops:["sign"],d:t,x:i,y:s});if(e.byteLength===zl)return i=j(n.subarray(o,o+zl),"base64url"),s=j(n.subarray(o+zl),"base64url"),new Za({...jx,key_ops:["sign"],d:t,x:i,y:s});throw new P(`Private key length was wrong length, got ${e.byteLength}, expected 32, 48 or 66`)}function $6(r){let e=Xn(r);return Vx(e)}function Vx(r){let e=r[1][1][0],t=1,n,o;if(e.byteLength===ql*2+1)return n=j(e.subarray(t,t+ql),"base64url"),o=j(e.subarray(t+ql),"base64url"),new Qa({...Fx,key_ops:["verify"],x:n,y:o});if(e.byteLength===Wl*2+1)return n=j(e.subarray(t,t+Wl),"base64url"),o=j(e.subarray(t+Wl),"base64url"),new Qa({...$x,key_ops:["verify"],x:n,y:o});if(e.byteLength===zl*2+1)return n=j(e.subarray(t,t+zl),"base64url"),o=j(e.subarray(t+zl),"base64url"),new Qa({...jx,key_ops:["verify"],x:n,y:o});throw new P(`coordinates were wrong length, got ${e.byteLength}, expected 65, 97 or 133`)}function Hx(r){return vo([zr(Uint8Array.from([1])),Rx(B(r.d??"","base64url")),vo([Wx(r.crv)],160),vo([vd(new fe(Uint8Array.from([4]),B(r.x??"","base64url"),B(r.y??"","base64url")))],161)]).subarray()}function qx(r){return vo([zr(Uint8Array.from([1])),vo([Wx(r.crv)],160),vo([vd(new fe(Uint8Array.from([4]),B(r.x??"","base64url"),B(r.y??"","base64url")))],161)]).subarray()}function Wx(r){if(r==="P-256")return vB;if(r==="P-384")return xB;if(r==="P-521")return EB;throw new P(`Invalid curve ${r}`)}async function zx(r="P-256"){let e=await Bx(r);return new Za(e.privateKey)}var Qa=class{type="ECDSA";jwk;_raw;constructor(e){this.jwk=e}get raw(){return this._raw==null&&(this._raw=qx(this.jwk)),this._raw}toMultihash(){return Dr.digest(sr(this))}toCID(){return he.createV1(114,this.toMultihash())}toString(){return ft.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:we(this.raw,e.raw)}async verify(e,t,n){return Ux(this.jwk,t,e,n)}},Za=class{type="ECDSA";jwk;publicKey;_raw;constructor(e){this.jwk=e,this.publicKey=new Qa({crv:e.crv,ext:e.ext,key_ops:["verify"],kty:"EC",x:e.x,y:e.y})}get raw(){return this._raw==null&&(this._raw=Hx(this.jwk)),this._raw}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:we(this.raw,e.raw)}async sign(e,t){return Mx(this.jwk,e,t)}};function Ja(r){return r instanceof Uint8Array||ArrayBuffer.isView(r)&&r.constructor.name==="Uint8Array"}function Nr(r,e=""){if(!Number.isSafeInteger(r)||r<0){let t=e&&`"${e}" `;throw new Error(`${t}expected integer >= 0, got ${r}`)}}function Oe(r,e,t=""){let n=Ja(r),o=r?.length,i=e!==void 0;if(!n||i&&o!==e){let s=t&&`"${t}" `,a=i?` of length ${e}`:"",c=n?`length=${o}`:`type=${typeof r}`;throw new Error(s+"expected Uint8Array"+a+", got "+c)}return r}function Ni(r){if(typeof r!="function"||typeof r.create!="function")throw new Error("Hash must wrapped by utils.createHasher");Nr(r.outputLen),Nr(r.blockLen)}function Gl(r,e=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(e&&r.finished)throw new Error("Hash#digest() has already been called")}function Xx(r,e){Oe(r,void 0,"digestInto() output");let t=e.outputLen;if(r.length<t)throw new Error('"digestInto() output" expected to be of length >='+t)}function Lr(...r){for(let e=0;e<r.length;e++)r[e].fill(0)}function ec(r){return new DataView(r.buffer,r.byteOffset,r.byteLength)}function xo(r,e){return r<<32-e|r>>>e}function Sm(r,e){return r<<e|r>>>32-e>>>0}var Yx=typeof Uint8Array.from([]).toHex=="function"&&typeof Uint8Array.fromHex=="function",SB=Array.from({length:256},(r,e)=>e.toString(16).padStart(2,"0"));function Li(r){if(Oe(r),Yx)return r.toHex();let e="";for(let t=0;t<r.length;t++)e+=SB[r[t]];return e}var Di={_0:48,_9:57,A:65,F:70,a:97,f:102};function Gx(r){if(r>=Di._0&&r<=Di._9)return r-Di._0;if(r>=Di.A&&r<=Di.F)return r-(Di.A-10);if(r>=Di.a&&r<=Di.f)return r-(Di.a-10)}function Bi(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);if(Yx)return Uint8Array.fromHex(r);let e=r.length,t=e/2;if(e%2)throw new Error("hex string expected, got unpadded hex of length "+e);let n=new Uint8Array(t);for(let o=0,i=0;o<t;o++,i+=2){let s=Gx(r.charCodeAt(i)),a=Gx(r.charCodeAt(i+1));if(s===void 0||a===void 0){let c=r[i]+r[i+1];throw new Error('hex string expected, got non-hex character "'+c+'" at index '+i)}n[o]=s*16+a}return n}var _B=async()=>{};async function Qx(r,e,t){let n=Date.now();for(let o=0;o<r;o++){t(o);let i=Date.now()-n;i>=0&&i<e||(await _B(),n+=i)}}function AB(r){if(typeof r!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(r))}function j6(r,e=""){return typeof r=="string"?AB(r):Oe(r,void 0,e)}function cn(...r){let e=0;for(let n=0;n<r.length;n++){let o=r[n];Oe(o),e+=o.length}let t=new Uint8Array(e);for(let n=0,o=0;n<r.length;n++){let i=r[n];t.set(i,o),o+=i.length}return t}function Zx(r,e){if(e!==void 0&&{}.toString.call(e)!=="[object Object]")throw new Error("options must be object or undefined");return Object.assign(r,e)}function xd(r,e={}){let t=(o,i)=>r(i).update(o).digest(),n=r(void 0);return t.outputLen=n.outputLen,t.blockLen=n.blockLen,t.create=o=>r(o),Object.assign(t,e),Object.freeze(t)}function Zo(r=32){let e=typeof globalThis=="object"?globalThis.crypto:null;if(typeof e?.getRandomValues!="function")throw new Error("crypto.getRandomValues must be defined");return e.getRandomValues(new Uint8Array(r))}var K6=r=>({oid:Uint8Array.from([6,9,96,134,72,1,101,3,4,2,r])});function _m(r,e,t){return r&e^~r&t}function Am(r,e,t){return r&e^r&t^e&t}var tc=class{blockLen;outputLen;padOffset;isLE;buffer;view;finished=!1;length=0;pos=0;destroyed=!1;constructor(e,t,n,o){this.blockLen=e,this.outputLen=t,this.padOffset=n,this.isLE=o,this.buffer=new Uint8Array(e),this.view=ec(this.buffer)}update(e){Gl(this),Oe(e);let{view:t,buffer:n,blockLen:o}=this,i=e.length;for(let s=0;s<i;){let a=Math.min(o-this.pos,i-s);if(a===o){let c=ec(e);for(;o<=i-s;s+=o)this.process(c,s);continue}n.set(e.subarray(s,s+a),this.pos),this.pos+=a,s+=a,this.pos===o&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){Gl(this),Xx(e,this),this.finished=!0;let{buffer:t,view:n,blockLen:o,isLE:i}=this,{pos:s}=this;t[s++]=128,Lr(this.buffer.subarray(s)),this.padOffset>o-s&&(this.process(n,0),s=0);for(let u=s;u<o;u++)t[u]=0;n.setBigUint64(o-8,BigInt(this.length*8),i),this.process(n,0);let a=ec(e),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen must be aligned to 32bit");let l=c/4,f=this.get();if(l>f.length)throw new Error("_sha2: outputLen bigger than state");for(let u=0;u<l;u++)a.setUint32(4*u,f[u],i)}digest(){let{buffer:e,outputLen:t}=this;this.digestInto(e);let n=e.slice(0,t);return this.destroy(),n}_cloneInto(e){e||=new this.constructor,e.set(...this.get());let{blockLen:t,buffer:n,length:o,finished:i,destroyed:s,pos:a}=this;return e.destroyed=s,e.finished=i,e.length=o,e.pos=a,o%t&&e.buffer.set(n),e}clone(){return this._cloneInto()}},Mi=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]);var pr=Uint32Array.from([1779033703,4089235720,3144134277,2227873595,1013904242,4271175723,2773480762,1595750129,1359893119,2917565137,2600822924,725511199,528734635,4215389547,1541459225,327033209]);var Tm=BigInt(4294967295),Jx=BigInt(32);function TB(r,e=!1){return e?{h:Number(r&Tm),l:Number(r>>Jx&Tm)}:{h:Number(r>>Jx&Tm)|0,l:Number(r&Tm)|0}}function eE(r,e=!1){let t=r.length,n=new Uint32Array(t),o=new Uint32Array(t);for(let i=0;i<t;i++){let{h:s,l:a}=TB(r[i],e);[n[i],o[i]]=[s,a]}return[n,o]}var V6=(r,e,t)=>r>>>t,H6=(r,e,t)=>r<<32-t|e>>>t,rc=(r,e,t)=>r>>>t|e<<32-t,nc=(r,e,t)=>r<<32-t|e>>>t,Ed=(r,e,t)=>r<<64-t|e>>>t-32,Sd=(r,e,t)=>r>>>t-32|e<<64-t;function Jo(r,e,t,n){let o=(e>>>0)+(n>>>0);return{h:r+t+(o/2**32|0)|0,l:o|0}}var tE=(r,e,t)=>(r>>>0)+(e>>>0)+(t>>>0),rE=(r,e,t,n)=>e+t+n+(r/2**32|0)|0,nE=(r,e,t,n)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0),oE=(r,e,t,n,o)=>e+t+n+o+(r/2**32|0)|0,iE=(r,e,t,n,o)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0)+(o>>>0),sE=(r,e,t,n,o,i)=>e+t+n+o+i+(r/2**32|0)|0;var CB=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),Ds=new Uint32Array(64),q6=class extends tc{constructor(e){super(64,e,8,!1)}get(){let{A:e,B:t,C:n,D:o,E:i,F:s,G:a,H:c}=this;return[e,t,n,o,i,s,a,c]}set(e,t,n,o,i,s,a,c){this.A=e|0,this.B=t|0,this.C=n|0,this.D=o|0,this.E=i|0,this.F=s|0,this.G=a|0,this.H=c|0}process(e,t){for(let u=0;u<16;u++,t+=4)Ds[u]=e.getUint32(t,!1);for(let u=16;u<64;u++){let d=Ds[u-15],h=Ds[u-2],m=xo(d,7)^xo(d,18)^d>>>3,w=xo(h,17)^xo(h,19)^h>>>10;Ds[u]=w+Ds[u-7]+m+Ds[u-16]|0}let{A:n,B:o,C:i,D:s,E:a,F:c,G:l,H:f}=this;for(let u=0;u<64;u++){let d=xo(a,6)^xo(a,11)^xo(a,25),h=f+d+_m(a,c,l)+CB[u]+Ds[u]|0,w=(xo(n,2)^xo(n,13)^xo(n,22))+Am(n,o,i)|0;f=l,l=c,c=a,a=s+h|0,s=i,i=o,o=n,n=h+w|0}n=n+this.A|0,o=o+this.B|0,i=i+this.C|0,s=s+this.D|0,a=a+this.E|0,c=c+this.F|0,l=l+this.G|0,f=f+this.H|0,this.set(n,o,i,s,a,c,l,f)}roundClean(){Lr(Ds)}destroy(){this.set(0,0,0,0,0,0,0,0),Lr(this.buffer)}},W6=class extends q6{A=Mi[0]|0;B=Mi[1]|0;C=Mi[2]|0;D=Mi[3]|0;E=Mi[4]|0;F=Mi[5]|0;G=Mi[6]|0;H=Mi[7]|0;constructor(){super(32)}};var aE=eE(["0x428a2f98d728ae22","0x7137449123ef65cd","0xb5c0fbcfec4d3b2f","0xe9b5dba58189dbbc","0x3956c25bf348b538","0x59f111f1b605d019","0x923f82a4af194f9b","0xab1c5ed5da6d8118","0xd807aa98a3030242","0x12835b0145706fbe","0x243185be4ee4b28c","0x550c7dc3d5ffb4e2","0x72be5d74f27b896f","0x80deb1fe3b1696b1","0x9bdc06a725c71235","0xc19bf174cf692694","0xe49b69c19ef14ad2","0xefbe4786384f25e3","0x0fc19dc68b8cd5b5","0x240ca1cc77ac9c65","0x2de92c6f592b0275","0x4a7484aa6ea6e483","0x5cb0a9dcbd41fbd4","0x76f988da831153b5","0x983e5152ee66dfab","0xa831c66d2db43210","0xb00327c898fb213f","0xbf597fc7beef0ee4","0xc6e00bf33da88fc2","0xd5a79147930aa725","0x06ca6351e003826f","0x142929670a0e6e70","0x27b70a8546d22ffc","0x2e1b21385c26c926","0x4d2c6dfc5ac42aed","0x53380d139d95b3df","0x650a73548baf63de","0x766a0abb3c77b2a8","0x81c2c92e47edaee6","0x92722c851482353b","0xa2bfe8a14cf10364","0xa81a664bbc423001","0xc24b8b70d0f89791","0xc76c51a30654be30","0xd192e819d6ef5218","0xd69906245565a910","0xf40e35855771202a","0x106aa07032bbd1b8","0x19a4c116b8d2d0c8","0x1e376c085141ab53","0x2748774cdf8eeb99","0x34b0bcb5e19b48a8","0x391c0cb3c5c95a63","0x4ed8aa4ae3418acb","0x5b9cca4f7763e373","0x682e6ff3d6b2b8a3","0x748f82ee5defb2fc","0x78a5636f43172f60","0x84c87814a1f0ab72","0x8cc702081a6439ec","0x90befffa23631e28","0xa4506cebde82bde9","0xbef9a3f7b2c67915","0xc67178f2e372532b","0xca273eceea26619c","0xd186b8c721c0c207","0xeada7dd6cde0eb1e","0xf57d4f7fee6ed178","0x06f067aa72176fba","0x0a637dc5a2c898a6","0x113f9804bef90dae","0x1b710b35131c471b","0x28db77f523047d84","0x32caab7b40c72493","0x3c9ebe0a15c9bebc","0x431d67c49c100d4c","0x4cc5d4becb3e42b6","0x597f299cfc657e2a","0x5fcb6fab3ad6faec","0x6c44198c4a475817"].map(r=>BigInt(r))),PB=aE[0],kB=aE[1],Ns=new Uint32Array(80),Ls=new Uint32Array(80),z6=class extends tc{constructor(e){super(128,e,16,!1)}get(){let{Ah:e,Al:t,Bh:n,Bl:o,Ch:i,Cl:s,Dh:a,Dl:c,Eh:l,El:f,Fh:u,Fl:d,Gh:h,Gl:m,Hh:w,Hl:y}=this;return[e,t,n,o,i,s,a,c,l,f,u,d,h,m,w,y]}set(e,t,n,o,i,s,a,c,l,f,u,d,h,m,w,y){this.Ah=e|0,this.Al=t|0,this.Bh=n|0,this.Bl=o|0,this.Ch=i|0,this.Cl=s|0,this.Dh=a|0,this.Dl=c|0,this.Eh=l|0,this.El=f|0,this.Fh=u|0,this.Fl=d|0,this.Gh=h|0,this.Gl=m|0,this.Hh=w|0,this.Hl=y|0}process(e,t){for(let O=0;O<16;O++,t+=4)Ns[O]=e.getUint32(t),Ls[O]=e.getUint32(t+=4);for(let O=16;O<80;O++){let V=Ns[O-15]|0,Q=Ls[O-15]|0,Z=rc(V,Q,1)^rc(V,Q,8)^V6(V,Q,7),se=nc(V,Q,1)^nc(V,Q,8)^H6(V,Q,7),C=Ns[O-2]|0,T=Ls[O-2]|0,K=rc(C,T,19)^Ed(C,T,61)^V6(C,T,6),z=nc(C,T,19)^Sd(C,T,61)^H6(C,T,6),U=nE(se,z,Ls[O-7],Ls[O-16]),I=oE(U,Z,K,Ns[O-7],Ns[O-16]);Ns[O]=I|0,Ls[O]=U|0}let{Ah:n,Al:o,Bh:i,Bl:s,Ch:a,Cl:c,Dh:l,Dl:f,Eh:u,El:d,Fh:h,Fl:m,Gh:w,Gl:y,Hh:b,Hl:N}=this;for(let O=0;O<80;O++){let V=rc(u,d,14)^rc(u,d,18)^Ed(u,d,41),Q=nc(u,d,14)^nc(u,d,18)^Sd(u,d,41),Z=u&h^~u&w,se=d&m^~d&y,C=iE(N,Q,se,kB[O],Ls[O]),T=sE(C,b,V,Z,PB[O],Ns[O]),K=C|0,z=rc(n,o,28)^Ed(n,o,34)^Ed(n,o,39),U=nc(n,o,28)^Sd(n,o,34)^Sd(n,o,39),I=n&i^n&a^i&a,S=o&s^o&c^s&c;b=w|0,N=y|0,w=h|0,y=m|0,h=u|0,m=d|0,{h:u,l:d}=Jo(l|0,f|0,T|0,K|0),l=a|0,f=c|0,a=i|0,c=s|0,i=n|0,s=o|0;let x=tE(K,U,S);n=rE(x,T,z,I),o=x|0}({h:n,l:o}=Jo(this.Ah|0,this.Al|0,n|0,o|0)),{h:i,l:s}=Jo(this.Bh|0,this.Bl|0,i|0,s|0),{h:a,l:c}=Jo(this.Ch|0,this.Cl|0,a|0,c|0),{h:l,l:f}=Jo(this.Dh|0,this.Dl|0,l|0,f|0),{h:u,l:d}=Jo(this.Eh|0,this.El|0,u|0,d|0),{h,l:m}=Jo(this.Fh|0,this.Fl|0,h|0,m|0),{h:w,l:y}=Jo(this.Gh|0,this.Gl|0,w|0,y|0),{h:b,l:N}=Jo(this.Hh|0,this.Hl|0,b|0,N|0),this.set(n,o,i,s,a,c,l,f,u,d,h,m,w,y,b,N)}roundClean(){Lr(Ns,Ls)}destroy(){Lr(this.buffer),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}},G6=class extends z6{Ah=pr[0]|0;Al=pr[1]|0;Bh=pr[2]|0;Bl=pr[3]|0;Ch=pr[4]|0;Cl=pr[5]|0;Dh=pr[6]|0;Dl=pr[7]|0;Eh=pr[8]|0;El=pr[9]|0;Fh=pr[10]|0;Fl=pr[11]|0;Gh=pr[12]|0;Gl=pr[13]|0;Hh=pr[14]|0;Hl=pr[15]|0;constructor(){super(64)}};var Yn=xd(()=>new W6,K6(1));var Bs=xd(()=>new G6,K6(3));var Y6=BigInt(0),X6=BigInt(1);function Ui(r,e=""){if(typeof r!="boolean"){let t=e&&`"${e}" `;throw new Error(t+"expected boolean, got type="+typeof r)}return r}function cE(r){if(typeof r=="bigint"){if(!Im(r))throw new Error("positive bigint expected, got "+r)}else Nr(r);return r}function _d(r){let e=cE(r).toString(16);return e.length&1?"0"+e:e}function lE(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);return r===""?Y6:BigInt("0x"+r)}function Xl(r){return lE(Li(r))}function ei(r){return lE(Li(oc(Oe(r)).reverse()))}function Cm(r,e){Nr(e),r=cE(r);let t=Bi(r.toString(16).padStart(e*2,"0"));if(t.length!==e)throw new Error("number too large");return t}function Ad(r,e){return Cm(r,e).reverse()}function oc(r){return Uint8Array.from(r)}var Im=r=>typeof r=="bigint"&&Y6<=r;function OB(r,e,t){return Im(r)&&Im(e)&&Im(t)&&e<=r&&r<t}function Ms(r,e,t,n){if(!OB(e,t,n))throw new Error("expected valid "+r+": "+t+" <= n < "+n+", got "+e)}function Q6(r){let e;for(e=0;r>Y6;r>>=X6,e+=1);return e}var Td=r=>(X6<<BigInt(r))-X6;function uE(r,e,t){if(Nr(r,"hashLen"),Nr(e,"qByteLen"),typeof t!="function")throw new Error("hmacFn must be a function");let n=y=>new Uint8Array(y),o=Uint8Array.of(),i=Uint8Array.of(0),s=Uint8Array.of(1),a=1e3,c=n(r),l=n(r),f=0,u=()=>{c.fill(1),l.fill(0),f=0},d=(...y)=>t(l,cn(c,...y)),h=(y=o)=>{l=d(i,y),c=d(),y.length!==0&&(l=d(s,y),c=d())},m=()=>{if(f++>=a)throw new Error("drbg: tried max amount of iterations");let y=0,b=[];for(;y<e;){c=d();let N=c.slice();b.push(N),y+=c.length}return cn(...b)};return(y,b)=>{u(),h(y);let N;for(;!(N=b(m()));)h();return u(),N}}function ti(r,e={},t={}){if(!r||typeof r!="object")throw new Error("expected valid options object");function n(i,s,a){let c=r[i];if(a&&c===void 0)return;let l=typeof c;if(l!==s||c===null)throw new Error(`param "${i}" is invalid: expected ${s}, got ${l}`)}let o=(i,s)=>Object.entries(i).forEach(([a,c])=>n(a,c,s));o(e,!1),o(t,!0)}function Yl(r){let e=new WeakMap;return(t,...n)=>{let o=e.get(t);if(o!==void 0)return o;let i=r(t,...n);return e.set(t,i),i}}var Gr=BigInt(0),ar=BigInt(1),ic=BigInt(2),hE=BigInt(3),pE=BigInt(4),mE=BigInt(5),RB=BigInt(7),gE=BigInt(8),DB=BigInt(9),yE=BigInt(16);function Pt(r,e){let t=r%e;return t>=Gr?t:e+t}function _t(r,e,t){let n=r;for(;e-- >Gr;)n*=n,n%=t;return n}function fE(r,e){if(r===Gr)throw new Error("invert: expected non-zero number");if(e<=Gr)throw new Error("invert: expected positive modulus, got "+e);let t=Pt(r,e),n=e,o=Gr,i=ar,s=ar,a=Gr;for(;t!==Gr;){let l=n/t,f=n%t,u=o-s*l,d=i-a*l;n=t,t=f,o=s,i=a,s=u,a=d}if(n!==ar)throw new Error("invert: does not exist");return Pt(o,e)}function J6(r,e,t){if(!r.eql(r.sqr(e),t))throw new Error("Cannot find square root")}function wE(r,e){let t=(r.ORDER+ar)/pE,n=r.pow(e,t);return J6(r,n,e),n}function NB(r,e){let t=(r.ORDER-mE)/gE,n=r.mul(e,ic),o=r.pow(n,t),i=r.mul(e,o),s=r.mul(r.mul(i,ic),o),a=r.mul(i,r.sub(s,r.ONE));return J6(r,a,e),a}function LB(r){let e=Ql(r),t=bE(r),n=t(e,e.neg(e.ONE)),o=t(e,n),i=t(e,e.neg(n)),s=(r+RB)/yE;return(a,c)=>{let l=a.pow(c,s),f=a.mul(l,n),u=a.mul(l,o),d=a.mul(l,i),h=a.eql(a.sqr(f),c),m=a.eql(a.sqr(u),c);l=a.cmov(l,f,h),f=a.cmov(d,u,m);let w=a.eql(a.sqr(f),c),y=a.cmov(l,f,w);return J6(a,y,c),y}}function bE(r){if(r<hE)throw new Error("sqrt is not defined for small field");let e=r-ar,t=0;for(;e%ic===Gr;)e/=ic,t++;let n=ic,o=Ql(r);for(;dE(o,n)===1;)if(n++>1e3)throw new Error("Cannot find square root: probably non-prime P");if(t===1)return wE;let i=o.pow(n,e),s=(e+ar)/ic;return function(c,l){if(c.is0(l))return l;if(dE(c,l)!==1)throw new Error("Cannot find square root");let f=t,u=c.mul(c.ONE,i),d=c.pow(l,e),h=c.pow(l,s);for(;!c.eql(d,c.ONE);){if(c.is0(d))return c.ZERO;let m=1,w=c.sqr(d);for(;!c.eql(w,c.ONE);)if(m++,w=c.sqr(w),m===f)throw new Error("Cannot find square root");let y=ar<<BigInt(f-m-1),b=c.pow(u,y);f=m,u=c.sqr(b),d=c.mul(d,u),h=c.mul(h,b)}return h}}function BB(r){return r%pE===hE?wE:r%gE===mE?NB:r%yE===DB?LB(r):bE(r)}var vE=(r,e)=>(Pt(r,e)&ar)===ar,MB=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function e5(r){let e={ORDER:"bigint",BYTES:"number",BITS:"number"},t=MB.reduce((n,o)=>(n[o]="function",n),e);return ti(r,t),r}function UB(r,e,t){if(t<Gr)throw new Error("invalid exponent, negatives unsupported");if(t===Gr)return r.ONE;if(t===ar)return e;let n=r.ONE,o=e;for(;t>Gr;)t&ar&&(n=r.mul(n,o)),o=r.sqr(o),t>>=ar;return n}function Id(r,e,t=!1){let n=new Array(e.length).fill(t?r.ZERO:void 0),o=e.reduce((s,a,c)=>r.is0(a)?s:(n[c]=s,r.mul(s,a)),r.ONE),i=r.inv(o);return e.reduceRight((s,a,c)=>r.is0(a)?s:(n[c]=r.mul(s,n[c]),r.mul(s,a)),i),n}function dE(r,e){let t=(r.ORDER-ar)/ic,n=r.pow(e,t),o=r.eql(n,r.ONE),i=r.eql(n,r.ZERO),s=r.eql(n,r.neg(r.ONE));if(!o&&!i&&!s)throw new Error("invalid Legendre symbol result");return o?1:i?0:-1}function FB(r,e){e!==void 0&&Nr(e);let t=e!==void 0?e:r.toString(2).length,n=Math.ceil(t/8);return{nBitLength:t,nByteLength:n}}var Z6=class{ORDER;BITS;BYTES;isLE;ZERO=Gr;ONE=ar;_lengths;_sqrt;_mod;constructor(e,t={}){if(e<=Gr)throw new Error("invalid field: expected ORDER > 0, got "+e);let n;this.isLE=!1,t!=null&&typeof t=="object"&&(typeof t.BITS=="number"&&(n=t.BITS),typeof t.sqrt=="function"&&(this.sqrt=t.sqrt),typeof t.isLE=="boolean"&&(this.isLE=t.isLE),t.allowedLengths&&(this._lengths=t.allowedLengths?.slice()),typeof t.modFromBytes=="boolean"&&(this._mod=t.modFromBytes));let{nBitLength:o,nByteLength:i}=FB(e,n);if(i>2048)throw new Error("invalid field: expected ORDER of <= 2048 bytes");this.ORDER=e,this.BITS=o,this.BYTES=i,this._sqrt=void 0,Object.preventExtensions(this)}create(e){return Pt(e,this.ORDER)}isValid(e){if(typeof e!="bigint")throw new Error("invalid field element: expected bigint, got "+typeof e);return Gr<=e&&e<this.ORDER}is0(e){return e===Gr}isValidNot0(e){return!this.is0(e)&&this.isValid(e)}isOdd(e){return(e&ar)===ar}neg(e){return Pt(-e,this.ORDER)}eql(e,t){return e===t}sqr(e){return Pt(e*e,this.ORDER)}add(e,t){return Pt(e+t,this.ORDER)}sub(e,t){return Pt(e-t,this.ORDER)}mul(e,t){return Pt(e*t,this.ORDER)}pow(e,t){return UB(this,e,t)}div(e,t){return Pt(e*fE(t,this.ORDER),this.ORDER)}sqrN(e){return e*e}addN(e,t){return e+t}subN(e,t){return e-t}mulN(e,t){return e*t}inv(e){return fE(e,this.ORDER)}sqrt(e){return this._sqrt||(this._sqrt=BB(this.ORDER)),this._sqrt(this,e)}toBytes(e){return this.isLE?Ad(e,this.BYTES):Cm(e,this.BYTES)}fromBytes(e,t=!1){Oe(e);let{_lengths:n,BYTES:o,isLE:i,ORDER:s,_mod:a}=this;if(n){if(!n.includes(e.length)||e.length>o)throw new Error("Field.fromBytes: expected "+n+" bytes, got "+e.length);let l=new Uint8Array(o);l.set(e,i?0:l.length-e.length),e=l}if(e.length!==o)throw new Error("Field.fromBytes: expected "+o+" bytes, got "+e.length);let c=i?ei(e):Xl(e);if(a&&(c=Pt(c,s)),!t&&!this.isValid(c))throw new Error("invalid field element: outside of range 0..ORDER");return c}invertBatch(e){return Id(this,e)}cmov(e,t,n){return n?t:e}};function Ql(r,e={}){return new Z6(r,e)}function xE(r){if(typeof r!="bigint")throw new Error("field order must be bigint");let e=r.toString(2).length;return Math.ceil(e/8)}function t5(r){let e=xE(r);return e+Math.ceil(e/2)}function r5(r,e,t=!1){Oe(r);let n=r.length,o=xE(e),i=t5(e);if(n<16||n<i||n>1024)throw new Error("expected "+i+"-1024 bytes of input, got "+n);let s=t?ei(r):Xl(r),a=Pt(s,e-ar)+ar;return t?Ad(a,o):Cm(a,o)}var Zl=BigInt(0),sc=BigInt(1);function Cd(r,e){let t=e.negate();return r?t:e}function ac(r,e){let t=Id(r.Fp,e.map(n=>n.Z));return e.map((n,o)=>r.fromAffine(n.toAffine(t[o])))}function AE(r,e){if(!Number.isSafeInteger(r)||r<=0||r>e)throw new Error("invalid window size, expected [1.."+e+"], got W="+r)}function n5(r,e){AE(r,e);let t=Math.ceil(e/r)+1,n=2**(r-1),o=2**r,i=Td(r),s=BigInt(r);return{windows:t,windowSize:n,mask:i,maxNumber:o,shiftBy:s}}function EE(r,e,t){let{windowSize:n,mask:o,maxNumber:i,shiftBy:s}=t,a=Number(r&o),c=r>>s;a>n&&(a-=i,c+=sc);let l=e*n,f=l+Math.abs(a)-1,u=a===0,d=a<0,h=e%2!==0;return{nextN:c,offset:f,isZero:u,isNeg:d,isNegF:h,offsetF:l}}var o5=new WeakMap,TE=new WeakMap;function i5(r){return TE.get(r)||1}function SE(r){if(r!==Zl)throw new Error("invalid wNAF")}var Jl=class{BASE;ZERO;Fn;bits;constructor(e,t){this.BASE=e.BASE,this.ZERO=e.ZERO,this.Fn=e.Fn,this.bits=t}_unsafeLadder(e,t,n=this.ZERO){let o=e;for(;t>Zl;)t&sc&&(n=n.add(o)),o=o.double(),t>>=sc;return n}precomputeWindow(e,t){let{windows:n,windowSize:o}=n5(t,this.bits),i=[],s=e,a=s;for(let c=0;c<n;c++){a=s,i.push(a);for(let l=1;l<o;l++)a=a.add(s),i.push(a);s=a.double()}return i}wNAF(e,t,n){if(!this.Fn.isValid(n))throw new Error("invalid scalar");let o=this.ZERO,i=this.BASE,s=n5(e,this.bits);for(let a=0;a<s.windows;a++){let{nextN:c,offset:l,isZero:f,isNeg:u,isNegF:d,offsetF:h}=EE(n,a,s);n=c,f?i=i.add(Cd(d,t[h])):o=o.add(Cd(u,t[l]))}return SE(n),{p:o,f:i}}wNAFUnsafe(e,t,n,o=this.ZERO){let i=n5(e,this.bits);for(let s=0;s<i.windows&&n!==Zl;s++){let{nextN:a,offset:c,isZero:l,isNeg:f}=EE(n,s,i);if(n=a,!l){let u=t[c];o=o.add(f?u.negate():u)}}return SE(n),o}getPrecomputes(e,t,n){let o=o5.get(t);return o||(o=this.precomputeWindow(t,e),e!==1&&(typeof n=="function"&&(o=n(o)),o5.set(t,o))),o}cached(e,t,n){let o=i5(e);return this.wNAF(o,this.getPrecomputes(o,e,n),t)}unsafe(e,t,n,o){let i=i5(e);return i===1?this._unsafeLadder(e,t,o):this.wNAFUnsafe(i,this.getPrecomputes(i,e,n),t,o)}createCache(e,t){AE(t,this.bits),TE.set(e,t),o5.delete(e)}hasCache(e){return i5(e)!==1}};function IE(r,e,t,n){let o=e,i=r.ZERO,s=r.ZERO;for(;t>Zl||n>Zl;)t&sc&&(i=i.add(o)),n&sc&&(s=s.add(o)),o=o.double(),t>>=sc,n>>=sc;return{p1:i,p2:s}}function _E(r,e,t){if(e){if(e.ORDER!==r)throw new Error("Field.ORDER must match order: Fp == p, Fn == n");return e5(e),e}else return Ql(r,{isLE:t})}function Pm(r,e,t={},n){if(n===void 0&&(n=r==="edwards"),!e||typeof e!="object")throw new Error(`expected valid ${r} CURVE object`);for(let c of["p","n","h"]){let l=e[c];if(!(typeof l=="bigint"&&l>Zl))throw new Error(`CURVE.${c} must be positive bigint`)}let o=_E(e.p,t.Fp,n),i=_E(e.n,t.Fn,n),a=["Gx","Gy","a",r==="weierstrass"?"b":"d"];for(let c of a)if(!o.isValid(e[c]))throw new Error(`CURVE.${c} must be valid field element of CURVE.Fp`);return e=Object.freeze(Object.assign({},e)),{CURVE:e,Fp:o,Fn:i}}function eu(r,e){return function(n){let o=r(n);return{secretKey:o,publicKey:e(o)}}}var Us=BigInt(0),cr=BigInt(1),s5=BigInt(2),$B=BigInt(8);function jB(r,e,t,n){let o=r.sqr(t),i=r.sqr(n),s=r.add(r.mul(e.a,o),i),a=r.add(r.ONE,r.mul(e.d,r.mul(o,i)));return r.eql(s,a)}function CE(r,e={}){let t=Pm("edwards",r,e,e.FpFnLE),{Fp:n,Fn:o}=t,i=t.CURVE,{h:s}=i;ti(e,{},{uvRatio:"function"});let a=s5<<BigInt(o.BYTES*8)-cr,c=y=>n.create(y),l=e.uvRatio||((y,b)=>{try{return{isValid:!0,value:n.sqrt(n.div(y,b))}}catch{return{isValid:!1,value:Us}}});if(!jB(n,i,i.Gx,i.Gy))throw new Error("bad curve params: generator point");function f(y,b,N=!1){let O=N?cr:Us;return Ms("coordinate "+y,b,O,a),b}function u(y){if(!(y instanceof m))throw new Error("EdwardsPoint expected")}let d=Yl((y,b)=>{let{X:N,Y:O,Z:V}=y,Q=y.is0();b==null&&(b=Q?$B:n.inv(V));let Z=c(N*b),se=c(O*b),C=n.mul(V,b);if(Q)return{x:Us,y:cr};if(C!==cr)throw new Error("invZ was invalid");return{x:Z,y:se}}),h=Yl(y=>{let{a:b,d:N}=i;if(y.is0())throw new Error("bad point: ZERO");let{X:O,Y:V,Z:Q,T:Z}=y,se=c(O*O),C=c(V*V),T=c(Q*Q),K=c(T*T),z=c(se*b),U=c(T*c(z+C)),I=c(K+c(N*c(se*C)));if(U!==I)throw new Error("bad point: equation left != right (1)");let S=c(O*V),x=c(Q*Z);if(S!==x)throw new Error("bad point: equation left != right (2)");return!0});class m{static BASE=new m(i.Gx,i.Gy,cr,c(i.Gx*i.Gy));static ZERO=new m(Us,cr,cr,Us);static Fp=n;static Fn=o;X;Y;Z;T;constructor(b,N,O,V){this.X=f("x",b),this.Y=f("y",N),this.Z=f("z",O,!0),this.T=f("t",V),Object.freeze(this)}static CURVE(){return i}static fromAffine(b){if(b instanceof m)throw new Error("extended point not allowed");let{x:N,y:O}=b||{};return f("x",N),f("y",O),new m(N,O,cr,c(N*O))}static fromBytes(b,N=!1){let O=n.BYTES,{a:V,d:Q}=i;b=oc(Oe(b,O,"point")),Ui(N,"zip215");let Z=oc(b),se=b[O-1];Z[O-1]=se&-129;let C=ei(Z),T=N?a:n.ORDER;Ms("point.y",C,Us,T);let K=c(C*C),z=c(K-cr),U=c(Q*K-V),{isValid:I,value:S}=l(z,U);if(!I)throw new Error("bad point: invalid y coordinate");let x=(S&cr)===cr,D=(se&128)!==0;if(!N&&S===Us&&D)throw new Error("bad point: x=0 and x_0=1");return D!==x&&(S=c(-S)),m.fromAffine({x:S,y:C})}static fromHex(b,N=!1){return m.fromBytes(Bi(b),N)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(b=8,N=!0){return w.createCache(this,b),N||this.multiply(s5),this}assertValidity(){h(this)}equals(b){u(b);let{X:N,Y:O,Z:V}=this,{X:Q,Y:Z,Z:se}=b,C=c(N*se),T=c(Q*V),K=c(O*se),z=c(Z*V);return C===T&&K===z}is0(){return this.equals(m.ZERO)}negate(){return new m(c(-this.X),this.Y,this.Z,c(-this.T))}double(){let{a:b}=i,{X:N,Y:O,Z:V}=this,Q=c(N*N),Z=c(O*O),se=c(s5*c(V*V)),C=c(b*Q),T=N+O,K=c(c(T*T)-Q-Z),z=C+Z,U=z-se,I=C-Z,S=c(K*U),x=c(z*I),D=c(K*I),q=c(U*z);return new m(S,x,q,D)}add(b){u(b);let{a:N,d:O}=i,{X:V,Y:Q,Z,T:se}=this,{X:C,Y:T,Z:K,T:z}=b,U=c(V*C),I=c(Q*T),S=c(se*O*z),x=c(Z*K),D=c((V+Q)*(C+T)-U-I),q=x-S,H=x+S,M=c(I-N*U),G=c(D*q),te=c(H*M),F=c(D*M),Le=c(q*H);return new m(G,te,Le,F)}subtract(b){return this.add(b.negate())}multiply(b){if(!o.isValidNot0(b))throw new Error("invalid scalar: expected 1 <= sc < curve.n");let{p:N,f:O}=w.cached(this,b,V=>ac(m,V));return ac(m,[N,O])[0]}multiplyUnsafe(b,N=m.ZERO){if(!o.isValid(b))throw new Error("invalid scalar: expected 0 <= sc < curve.n");return b===Us?m.ZERO:this.is0()||b===cr?this:w.unsafe(this,b,O=>ac(m,O),N)}isSmallOrder(){return this.multiplyUnsafe(s).is0()}isTorsionFree(){return w.unsafe(this,i.n).is0()}toAffine(b){return d(this,b)}clearCofactor(){return s===cr?this:this.multiplyUnsafe(s)}toBytes(){let{x:b,y:N}=this.toAffine(),O=n.toBytes(N);return O[O.length-1]|=b&cr?128:0,O}toHex(){return Li(this.toBytes())}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}}let w=new Jl(m,o.BITS);return m.BASE.precompute(8),m}function PE(r,e,t={}){if(typeof e!="function")throw new Error('"hash" function param is required');ti(t,{},{adjustScalarBytes:"function",randomBytes:"function",domain:"function",prehash:"function",mapToCurve:"function"});let{prehash:n}=t,{BASE:o,Fp:i,Fn:s}=r,a=t.randomBytes||Zo,c=t.adjustScalarBytes||(C=>C),l=t.domain||((C,T,K)=>{if(Ui(K,"phflag"),T.length||K)throw new Error("Contexts/pre-hash are not supported");return C});function f(C){return s.create(ei(C))}function u(C){let T=O.secretKey;Oe(C,O.secretKey,"secretKey");let K=Oe(e(C),2*T,"hashedSecretKey"),z=c(K.slice(0,T)),U=K.slice(T,2*T),I=f(z);return{head:z,prefix:U,scalar:I}}function d(C){let{head:T,prefix:K,scalar:z}=u(C),U=o.multiply(z),I=U.toBytes();return{head:T,prefix:K,scalar:z,point:U,pointBytes:I}}function h(C){return d(C).pointBytes}function m(C=Uint8Array.of(),...T){let K=cn(...T);return f(e(l(K,Oe(C,void 0,"context"),!!n)))}function w(C,T,K={}){C=Oe(C,void 0,"message"),n&&(C=n(C));let{prefix:z,scalar:U,pointBytes:I}=d(T),S=m(K.context,z,C),x=o.multiply(S).toBytes(),D=m(K.context,x,I,C),q=s.create(S+D*U);if(!s.isValid(q))throw new Error("sign failed: invalid s");let H=cn(x,s.toBytes(q));return Oe(H,O.signature,"result")}let y={zip215:!0};function b(C,T,K,z=y){let{context:U,zip215:I}=z,S=O.signature;C=Oe(C,S,"signature"),T=Oe(T,void 0,"message"),K=Oe(K,O.publicKey,"publicKey"),I!==void 0&&Ui(I,"zip215"),n&&(T=n(T));let x=S/2,D=C.subarray(0,x),q=ei(C.subarray(x,S)),H,M,G;try{H=r.fromBytes(K,I),M=r.fromBytes(D,I),G=o.multiplyUnsafe(q)}catch{return!1}if(!I&&H.isSmallOrder())return!1;let te=m(U,M.toBytes(),H.toBytes(),T);return M.add(H.multiplyUnsafe(te)).subtract(G).clearCofactor().is0()}let N=i.BYTES,O={secretKey:N,publicKey:N,signature:2*N,seed:N};function V(C=a(O.seed)){return Oe(C,O.seed,"seed")}function Q(C){return Ja(C)&&C.length===s.BYTES}function Z(C,T){try{return!!r.fromBytes(C,T)}catch{return!1}}let se={getExtendedPublicKey:d,randomSecretKey:V,isValidSecretKey:Q,isValidPublicKey:Z,toMontgomery(C){let{y:T}=r.fromBytes(C),K=O.publicKey,z=K===32;if(!z&&K!==57)throw new Error("only defined for 25519 and 448");let U=z?i.div(cr+T,cr-T):i.div(T-cr,T+cr);return i.toBytes(U)},toMontgomerySecret(C){let T=O.secretKey;Oe(C,T);let K=e(C.subarray(0,T));return c(K).subarray(0,T)}};return Object.freeze({keygen:eu(V,h),getPublicKey:h,sign:w,verify:b,utils:se,Point:r,lengths:O})}var Pd=BigInt(0),tu=BigInt(1),km=BigInt(2);function KB(r){return ti(r,{adjustScalarBytes:"function",powPminus2:"function"}),Object.freeze({...r})}function kE(r){let e=KB(r),{P:t,type:n,adjustScalarBytes:o,powPminus2:i,randomBytes:s}=e,a=n==="x25519";if(!a&&n!=="x448")throw new Error("invalid type");let c=s||Zo,l=a?255:448,f=a?32:56,u=BigInt(a?9:5),d=BigInt(a?121665:39081),h=a?km**BigInt(254):km**BigInt(447),m=a?BigInt(8)*km**BigInt(251)-tu:BigInt(4)*km**BigInt(445)-tu,w=h+m+tu,y=S=>Pt(S,t),b=N(u);function N(S){return Ad(y(S),f)}function O(S){let x=oc(Oe(S,f,"uCoordinate"));return a&&(x[31]&=127),y(ei(x))}function V(S){return ei(o(oc(Oe(S,f,"scalar"))))}function Q(S,x){let D=K(O(x),V(S));if(D===Pd)throw new Error("invalid private or public key received");return N(D)}function Z(S){return Q(S,b)}let se=Z,C=Q;function T(S,x,D){let q=y(S*(x-D));return x=y(x-q),D=y(D+q),{x_2:x,x_3:D}}function K(S,x){Ms("u",S,Pd,t),Ms("scalar",x,h,w);let D=x,q=S,H=tu,M=Pd,G=S,te=tu,F=Pd;for(let Fe=BigInt(l-1);Fe>=Pd;Fe--){let me=D>>Fe&tu;F^=me,{x_2:H,x_3:G}=T(F,H,G),{x_2:M,x_3:te}=T(F,M,te),F=me;let He=H+M,ot=y(He*He),Ct=H-M,ze=y(Ct*Ct),it=ot-ze,Pi=G+te,mo=G-te,Is=y(mo*He),Z1=y(Pi*Ct),Nl=Is+Z1,rd=Is-Z1;G=y(Nl*Nl),te=y(q*y(rd*rd)),H=y(ot*ze),M=y(it*(ot+y(d*it)))}({x_2:H,x_3:G}=T(F,H,G)),{x_2:M,x_3:te}=T(F,M,te);let Le=i(M);return y(H*Le)}let z={secretKey:f,publicKey:f,seed:f},U=(S=c(f))=>(Oe(S,z.seed,"seed"),S),I={randomSecretKey:U};return Object.freeze({keygen:eu(U,se),getSharedSecret:C,getPublicKey:se,scalarMult:Q,scalarMultBase:Z,utils:I,GuBytes:b.slice(),lengths:z})}var VB=BigInt(1),OE=BigInt(2),HB=BigInt(3),qB=BigInt(5),WB=BigInt(8),Om=BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffed"),zB={p:Om,n:BigInt("0x1000000000000000000000000000000014def9dea2f79cd65812631a5cf5d3ed"),h:WB,a:BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffec"),d:BigInt("0x52036cee2b6ffe738cc740797779e89800700a4d4141d8ab75eb4dca135978a3"),Gx:BigInt("0x216936d3cd6e53fec0a4e231fdd6dc5c692cc7609525a7b2c9562d608f25d51a"),Gy:BigInt("0x6666666666666666666666666666666666666666666666666666666666666658")};function DE(r){let e=BigInt(10),t=BigInt(20),n=BigInt(40),o=BigInt(80),i=Om,a=r*r%i*r%i,c=_t(a,OE,i)*a%i,l=_t(c,VB,i)*r%i,f=_t(l,qB,i)*l%i,u=_t(f,e,i)*f%i,d=_t(u,t,i)*u%i,h=_t(d,n,i)*d%i,m=_t(h,o,i)*h%i,w=_t(m,o,i)*h%i,y=_t(w,e,i)*f%i;return{pow_p_5_8:_t(y,OE,i)*r%i,b2:a}}function NE(r){return r[0]&=248,r[31]&=127,r[31]|=64,r}var RE=BigInt("19681161376707505956807079304988542015446066515923890162744021073123829784752");function GB(r,e){let t=Om,n=Pt(e*e*e,t),o=Pt(n*n*e,t),i=DE(r*o).pow_p_5_8,s=Pt(r*n*i,t),a=Pt(e*s*s,t),c=s,l=Pt(s*RE,t),f=a===r,u=a===Pt(-r,t),d=a===Pt(-r*RE,t);return f&&(s=c),(u||d)&&(s=l),vE(s,t)&&(s=Pt(-s,t)),{isValid:f||u,value:s}}var XB=CE(zB,{uvRatio:GB});function YB(r){return PE(XB,Bs,Object.assign({adjustScalarBytes:NE},r))}var kd=YB({});var Od=(()=>{let r=Om;return kE({P:r,type:"x25519",powPminus2:e=>{let{pow_p_5_8:t,b2:n}=DE(e);return Pt(_t(t,HB,r)*n,r)},adjustScalarBytes:NE})})();var cc=32,In=64,a5=32;var ru,LE=(async()=>{try{return await qt.get().subtle.generateKey({name:"Ed25519"},!0,["sign","verify"]),!0}catch{return!1}})();function BE(){let r=kd.utils.randomSecretKey(),e=kd.getPublicKey(r);return{privateKey:tM(r,e),publicKey:e}}async function QB(r,e){let t;r.length===In?t=r.subarray(0,32):t=r;let n={crv:"Ed25519",kty:"OKP",x:j(r.subarray(32),"base64url"),d:j(t,"base64url"),ext:!0,key_ops:["sign"]},o=await qt.get().subtle.importKey("jwk",n,{name:"Ed25519"},!0,["sign"]),i=await qt.get().subtle.sign({name:"Ed25519"},o,e instanceof Uint8Array?e:e.subarray());return new Uint8Array(i,0,i.byteLength)}function ZB(r,e){let t=r.subarray(0,a5);return kd.sign(e instanceof Uint8Array?e:e.subarray(),t)}async function ME(r,e){return ru==null&&(ru=await LE),ru?QB(r,e):ZB(r,e)}async function JB(r,e,t){if(r.buffer instanceof ArrayBuffer){let n=await qt.get().subtle.importKey("raw",r.buffer,{name:"Ed25519"},!1,["verify"]);return await qt.get().subtle.verify({name:"Ed25519"},n,e,t instanceof Uint8Array?t:t.subarray())}throw new TypeError("WebCrypto does not support SharedArrayBuffer for Ed25519 keys")}function eM(r,e,t){return kd.verify(e,t instanceof Uint8Array?t:t.subarray(),r)}async function UE(r,e,t){return ru==null&&(ru=await LE),ru?JB(r,e,t):eM(r,e,t)}function tM(r,e){let t=new Uint8Array(In);for(let n=0;n<a5;n++)t[n]=r[n],t[a5+n]=e[n];return t}function nu(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}var Rd=class{type="Ed25519";raw;constructor(e){this.raw=iu(e,cc)}toMultihash(){return Dr.digest(sr(this))}toCID(){return he.createV1(114,this.toMultihash())}toString(){return ft.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:we(this.raw,e.raw)}verify(e,t,n){n?.signal?.throwIfAborted();let o=UE(this.raw,t,e);return nu(o)?o.then(i=>(n?.signal?.throwIfAborted(),i)):o}},ou=class{type="Ed25519";raw;publicKey;constructor(e,t){this.raw=iu(e,In),this.publicKey=new Rd(t)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:we(this.raw,e.raw)}sign(e,t){t?.signal?.throwIfAborted();let n=ME(this.raw,e);return nu(n)?n.then(o=>(t?.signal?.throwIfAborted(),o)):(t?.signal?.throwIfAborted(),n)}};function c5(r){if(r.length>In){r=iu(r,In+cc);let n=r.subarray(0,In),o=r.subarray(In,r.length);return new ou(n,o)}r=iu(r,In);let e=r.subarray(0,In),t=r.subarray(cc);return new ou(e,t)}function l5(r){return r=iu(r,cc),new Rd(r)}async function $E(){let{privateKey:r,publicKey:e}=BE();return new ou(r,e)}function iu(r,e){if(r=Uint8Array.from(r??[]),r.length!==e)throw new P(`Key must be a Uint8Array of length ${e}, got ${r.length}`);return r}var rM=Math.pow(2,7),nM=Math.pow(2,14),oM=Math.pow(2,21),u5=Math.pow(2,28),f5=Math.pow(2,35),d5=Math.pow(2,42),h5=Math.pow(2,49),st=128,Br=127;function je(r){if(r<rM)return 1;if(r<nM)return 2;if(r<oM)return 3;if(r<u5)return 4;if(r<f5)return 5;if(r<d5)return 6;if(r<h5)return 7;if(Number.MAX_SAFE_INTEGER!=null&&r>Number.MAX_SAFE_INTEGER)throw new RangeError("Could not encode varint");return 8}function su(r,e,t=0){switch(je(r)){case 8:e[t++]=r&255|st,r/=128;case 7:e[t++]=r&255|st,r/=128;case 6:e[t++]=r&255|st,r/=128;case 5:e[t++]=r&255|st,r/=128;case 4:e[t++]=r&255|st,r>>>=7;case 3:e[t++]=r&255|st,r>>>=7;case 2:e[t++]=r&255|st,r>>>=7;case 1:{e[t++]=r&255,r>>>=7;break}default:throw new Error("unreachable")}return e}function iM(r,e,t=0){switch(je(r)){case 8:e.set(t++,r&255|st),r/=128;case 7:e.set(t++,r&255|st),r/=128;case 6:e.set(t++,r&255|st),r/=128;case 5:e.set(t++,r&255|st),r/=128;case 4:e.set(t++,r&255|st),r>>>=7;case 3:e.set(t++,r&255|st),r>>>=7;case 2:e.set(t++,r&255|st),r>>>=7;case 1:{e.set(t++,r&255),r>>>=7;break}default:throw new Error("unreachable")}return e}function p5(r,e){let t=r[e],n=0;if(n+=t&Br,t<st||(t=r[e+1],n+=(t&Br)<<7,t<st)||(t=r[e+2],n+=(t&Br)<<14,t<st)||(t=r[e+3],n+=(t&Br)<<21,t<st)||(t=r[e+4],n+=(t&Br)*u5,t<st)||(t=r[e+5],n+=(t&Br)*f5,t<st)||(t=r[e+6],n+=(t&Br)*d5,t<st)||(t=r[e+7],n+=(t&Br)*h5,t<st))return n;throw new RangeError("Could not decode varint")}function sM(r,e){let t=r.get(e),n=0;if(n+=t&Br,t<st||(t=r.get(e+1),n+=(t&Br)<<7,t<st)||(t=r.get(e+2),n+=(t&Br)<<14,t<st)||(t=r.get(e+3),n+=(t&Br)<<21,t<st)||(t=r.get(e+4),n+=(t&Br)*u5,t<st)||(t=r.get(e+5),n+=(t&Br)*f5,t<st)||(t=r.get(e+6),n+=(t&Br)*d5,t<st)||(t=r.get(e+7),n+=(t&Br)*h5,t<st))return n;throw new RangeError("Could not decode varint")}function Mr(r,e,t=0){return e==null&&(e=Ot(je(r))),e instanceof Uint8Array?su(r,e,t):iM(r,e,t)}function Cn(r,e=0){return r instanceof Uint8Array?p5(r,e):sM(r,e)}var m5=new Float32Array([-0]),Fs=new Uint8Array(m5.buffer);function jE(r,e,t){m5[0]=r,e[t]=Fs[0],e[t+1]=Fs[1],e[t+2]=Fs[2],e[t+3]=Fs[3]}function KE(r,e){return Fs[0]=r[e],Fs[1]=r[e+1],Fs[2]=r[e+2],Fs[3]=r[e+3],m5[0]}var g5=new Float64Array([-0]),Ur=new Uint8Array(g5.buffer);function VE(r,e,t){g5[0]=r,e[t]=Ur[0],e[t+1]=Ur[1],e[t+2]=Ur[2],e[t+3]=Ur[3],e[t+4]=Ur[4],e[t+5]=Ur[5],e[t+6]=Ur[6],e[t+7]=Ur[7]}function HE(r,e){return Ur[0]=r[e],Ur[1]=r[e+1],Ur[2]=r[e+2],Ur[3]=r[e+3],Ur[4]=r[e+4],Ur[5]=r[e+5],Ur[6]=r[e+6],Ur[7]=r[e+7],g5[0]}var aM=BigInt(Number.MAX_SAFE_INTEGER),cM=BigInt(Number.MIN_SAFE_INTEGER),Pn=class r{lo;hi;constructor(e,t){this.lo=e|0,this.hi=t|0}toNumber(e=!1){if(!e&&this.hi>>>31>0){let t=~this.lo+1>>>0,n=~this.hi>>>0;return t===0&&(n=n+1>>>0),-(t+n*4294967296)}return this.lo+this.hi*4294967296}toBigInt(e=!1){if(e)return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n);if(this.hi>>>31){let t=~this.lo+1>>>0,n=~this.hi>>>0;return t===0&&(n=n+1>>>0),-(BigInt(t)+(BigInt(n)<<32n))}return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n)}toString(e=!1){return this.toBigInt(e).toString()}zzEncode(){let e=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^e)>>>0,this.lo=(this.lo<<1^e)>>>0,this}zzDecode(){let e=-(this.lo&1);return this.lo=((this.lo>>>1|this.hi<<31)^e)>>>0,this.hi=(this.hi>>>1^e)>>>0,this}length(){let e=this.lo,t=(this.lo>>>28|this.hi<<4)>>>0,n=this.hi>>>24;return n===0?t===0?e<16384?e<128?1:2:e<2097152?3:4:t<16384?t<128?5:6:t<2097152?7:8:n<128?9:10}static fromBigInt(e){if(e===0n)return lc;if(e<aM&&e>cM)return this.fromNumber(Number(e));let t=e<0n;t&&(e=-e);let n=e>>32n,o=e-(n<<32n);return t&&(n=~n|0n,o=~o|0n,++o>qE&&(o=0n,++n>qE&&(n=0n))),new r(Number(o),Number(n))}static fromNumber(e){if(e===0)return lc;let t=e<0;t&&(e=-e);let n=e>>>0,o=(e-n)/4294967296>>>0;return t&&(o=~o>>>0,n=~n>>>0,++n>4294967295&&(n=0,++o>4294967295&&(o=0))),new r(n,o)}static from(e){return typeof e=="number"?r.fromNumber(e):typeof e=="bigint"?r.fromBigInt(e):typeof e=="string"?r.fromBigInt(BigInt(e)):e.low!=null||e.high!=null?new r(e.low>>>0,e.high>>>0):lc}},lc=new Pn(0,0);lc.toBigInt=function(){return 0n};lc.zzEncode=lc.zzDecode=function(){return this};lc.length=function(){return 1};var qE=4294967296n;function WE(r){let e=0,t=0;for(let n=0;n<r.length;++n)t=r.charCodeAt(n),t<128?e+=1:t<2048?e+=2:(t&64512)===55296&&(r.charCodeAt(n+1)&64512)===56320?(++n,e+=4):e+=3;return e}function zE(r,e,t){if(t-e<1)return"";let o,i=[],s=0,a;for(;e<t;)a=r[e++],a<128?i[s++]=a:a>191&&a<224?i[s++]=(a&31)<<6|r[e++]&63:a>239&&a<365?(a=((a&7)<<18|(r[e++]&63)<<12|(r[e++]&63)<<6|r[e++]&63)-65536,i[s++]=55296+(a>>10),i[s++]=56320+(a&1023)):i[s++]=(a&15)<<12|(r[e++]&63)<<6|r[e++]&63,s>8191&&((o??(o=[])).push(String.fromCharCode.apply(String,i)),s=0);return o!=null?(s>0&&o.push(String.fromCharCode.apply(String,i.slice(0,s))),o.join("")):String.fromCharCode.apply(String,i.slice(0,s))}function y5(r,e,t){let n=t,o,i;for(let s=0;s<r.length;++s)o=r.charCodeAt(s),o<128?e[t++]=o:o<2048?(e[t++]=o>>6|192,e[t++]=o&63|128):(o&64512)===55296&&((i=r.charCodeAt(s+1))&64512)===56320?(o=65536+((o&1023)<<10)+(i&1023),++s,e[t++]=o>>18|240,e[t++]=o>>12&63|128,e[t++]=o>>6&63|128,e[t++]=o&63|128):(e[t++]=o>>12|224,e[t++]=o>>6&63|128,e[t++]=o&63|128);return t-n}function Eo(r,e){return RangeError(`index out of range: ${r.pos} + ${e??1} > ${r.len}`)}function Rm(r,e){return(r[e-4]|r[e-3]<<8|r[e-2]<<16|r[e-1]<<24)>>>0}var w5=class{buf;pos;len;_slice=Uint8Array.prototype.subarray;constructor(e){this.buf=e,this.pos=0,this.len=e.length}uint32(){let e=4294967295;if(e=(this.buf[this.pos]&127)>>>0,this.buf[this.pos++]<128||(e=(e|(this.buf[this.pos]&127)<<7)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<14)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<21)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&15)<<28)>>>0,this.buf[this.pos++]<128))return e;if((this.pos+=5)>this.len)throw this.pos=this.len,Eo(this,10);return e}int32(){return this.uint32()|0}sint32(){let e=this.uint32();return e>>>1^-(e&1)|0}bool(){return this.uint32()!==0}fixed32(){if(this.pos+4>this.len)throw Eo(this,4);return Rm(this.buf,this.pos+=4)}sfixed32(){if(this.pos+4>this.len)throw Eo(this,4);return Rm(this.buf,this.pos+=4)|0}float(){if(this.pos+4>this.len)throw Eo(this,4);let e=KE(this.buf,this.pos);return this.pos+=4,e}double(){if(this.pos+8>this.len)throw Eo(this,4);let e=HE(this.buf,this.pos);return this.pos+=8,e}bytes(){let e=this.uint32(),t=this.pos,n=this.pos+e;if(n>this.len)throw Eo(this,e);return this.pos+=e,t===n?new Uint8Array(0):this.buf.subarray(t,n)}string(){let e=this.bytes();return zE(e,0,e.length)}skip(e){if(typeof e=="number"){if(this.pos+e>this.len)throw Eo(this,e);this.pos+=e}else do if(this.pos>=this.len)throw Eo(this);while((this.buf[this.pos++]&128)!==0);return this}skipType(e){switch(e){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;(e=this.uint32()&7)!==4;)this.skipType(e);break;case 5:this.skip(4);break;default:throw Error(`invalid wire type ${e} at offset ${this.pos}`)}return this}readLongVarint(){let e=new Pn(0,0),t=0;if(this.len-this.pos>4){for(;t<4;++t)if(e.lo=(e.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return e;if(e.lo=(e.lo|(this.buf[this.pos]&127)<<28)>>>0,e.hi=(e.hi|(this.buf[this.pos]&127)>>4)>>>0,this.buf[this.pos++]<128)return e;t=0}else{for(;t<3;++t){if(this.pos>=this.len)throw Eo(this);if(e.lo=(e.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return e}return e.lo=(e.lo|(this.buf[this.pos++]&127)<<t*7)>>>0,e}if(this.len-this.pos>4){for(;t<5;++t)if(e.hi=(e.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return e}else for(;t<5;++t){if(this.pos>=this.len)throw Eo(this);if(e.hi=(e.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return e}throw Error("invalid varint encoding")}readFixed64(){if(this.pos+8>this.len)throw Eo(this,8);let e=Rm(this.buf,this.pos+=4),t=Rm(this.buf,this.pos+=4);return new Pn(e,t)}int64(){return this.readLongVarint().toBigInt()}int64Number(){return this.readLongVarint().toNumber()}int64String(){return this.readLongVarint().toString()}uint64(){return this.readLongVarint().toBigInt(!0)}uint64Number(){let e=p5(this.buf,this.pos);return this.pos+=je(e),e}uint64String(){return this.readLongVarint().toString(!0)}sint64(){return this.readLongVarint().zzDecode().toBigInt()}sint64Number(){return this.readLongVarint().zzDecode().toNumber()}sint64String(){return this.readLongVarint().zzDecode().toString()}fixed64(){return this.readFixed64().toBigInt()}fixed64Number(){return this.readFixed64().toNumber()}fixed64String(){return this.readFixed64().toString()}sfixed64(){return this.readFixed64().toBigInt()}sfixed64Number(){return this.readFixed64().toNumber()}sfixed64String(){return this.readFixed64().toString()}};function b5(r){return new w5(r instanceof Uint8Array?r:r.subarray())}function Ae(r,e,t){let n=b5(r);return e.decode(n,void 0,t)}function v5(r){let e=r??8192,t=e>>>1,n,o=e;return function(s){if(s<1||s>t)return Ot(s);o+s>e&&(n=Ot(e),o=0);let a=n.subarray(o,o+=s);return(o&7)!==0&&(o=(o|7)+1),a}}var uc=class{fn;len;next;val;constructor(e,t,n){this.fn=e,this.len=t,this.next=void 0,this.val=n}};function x5(){}var S5=class{head;tail;len;next;constructor(e){this.head=e.head,this.tail=e.tail,this.len=e.len,this.next=e.states}},lM=v5();function uM(r){return globalThis.Buffer!=null?Ot(r):lM(r)}var Nd=class{len;head;tail;states;constructor(){this.len=0,this.head=new uc(x5,0,0),this.tail=this.head,this.states=null}_push(e,t,n){return this.tail=this.tail.next=new uc(e,t,n),this.len+=t,this}uint32(e){return this.len+=(this.tail=this.tail.next=new _5((e=e>>>0)<128?1:e<16384?2:e<2097152?3:e<268435456?4:5,e)).len,this}int32(e){return e<0?this._push(Dm,10,Pn.fromNumber(e)):this.uint32(e)}sint32(e){return this.uint32((e<<1^e>>31)>>>0)}uint64(e){let t=Pn.fromBigInt(e);return this._push(Dm,t.length(),t)}uint64Number(e){return this._push(su,je(e),e)}uint64String(e){return this.uint64(BigInt(e))}int64(e){return this.uint64(e)}int64Number(e){return this.uint64Number(e)}int64String(e){return this.uint64String(e)}sint64(e){let t=Pn.fromBigInt(e).zzEncode();return this._push(Dm,t.length(),t)}sint64Number(e){let t=Pn.fromNumber(e).zzEncode();return this._push(Dm,t.length(),t)}sint64String(e){return this.sint64(BigInt(e))}bool(e){return this._push(E5,1,e?1:0)}fixed32(e){return this._push(Dd,4,e>>>0)}sfixed32(e){return this.fixed32(e)}fixed64(e){let t=Pn.fromBigInt(e);return this._push(Dd,4,t.lo)._push(Dd,4,t.hi)}fixed64Number(e){let t=Pn.fromNumber(e);return this._push(Dd,4,t.lo)._push(Dd,4,t.hi)}fixed64String(e){return this.fixed64(BigInt(e))}sfixed64(e){return this.fixed64(e)}sfixed64Number(e){return this.fixed64Number(e)}sfixed64String(e){return this.fixed64String(e)}float(e){return this._push(jE,4,e)}double(e){return this._push(VE,8,e)}bytes(e){let t=e.length>>>0;return t===0?this._push(E5,1,0):this.uint32(t)._push(dM,t,e)}string(e){let t=WE(e);return t!==0?this.uint32(t)._push(y5,t,e):this._push(E5,1,0)}fork(){return this.states=new S5(this),this.head=this.tail=new uc(x5,0,0),this.len=0,this}reset(){return this.states!=null?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new uc(x5,0,0),this.len=0),this}ldelim(){let e=this.head,t=this.tail,n=this.len;return this.reset().uint32(n),n!==0&&(this.tail.next=e.next,this.tail=t,this.len+=n),this}finish(){let e=this.head.next,t=uM(this.len),n=0;for(;e!=null;)e.fn(e.val,t,n),n+=e.len,e=e.next;return t}};function E5(r,e,t){e[t]=r&255}function fM(r,e,t){for(;r>127;)e[t++]=r&127|128,r>>>=7;e[t]=r}var _5=class extends uc{next;constructor(e,t){super(fM,e,t),this.next=void 0}};function Dm(r,e,t){for(;r.hi!==0;)e[t++]=r.lo&127|128,r.lo=(r.lo>>>7|r.hi<<25)>>>0,r.hi>>>=7;for(;r.lo>127;)e[t++]=r.lo&127|128,r.lo=r.lo>>>7;e[t++]=r.lo}function Dd(r,e,t){e[t]=r&255,e[t+1]=r>>>8&255,e[t+2]=r>>>16&255,e[t+3]=r>>>24}function dM(r,e,t){e.set(r,t)}globalThis.Buffer!=null&&(Nd.prototype.bytes=function(r){let e=r.length>>>0;return this.uint32(e),e>0&&this._push(hM,e,r),this},Nd.prototype.string=function(r){let e=globalThis.Buffer.byteLength(r);return this.uint32(e),e>0&&this._push(pM,e,r),this});function hM(r,e,t){e.set(r,t)}function pM(r,e,t){r.length<40?y5(r,e,t):e.utf8Write!=null?e.utf8Write(r,t):e.set(B(r),t)}function A5(){return new Nd}function Te(r,e){let t=A5();return e.encode(r,t,{lengthDelimited:!1}),t.finish()}var au;(function(r){r[r.VARINT=0]="VARINT",r[r.BIT64=1]="BIT64",r[r.LENGTH_DELIMITED=2]="LENGTH_DELIMITED",r[r.START_GROUP=3]="START_GROUP",r[r.END_GROUP=4]="END_GROUP",r[r.BIT32=5]="BIT32"})(au||(au={}));function Nm(r,e,t,n){return{name:r,type:e,encode:t,decode:n}}function kt(r){function e(o){if(r[o.toString()]==null)throw new Error("Invalid enum value");return r[o]}let t=function(i,s){let a=e(i);s.int32(a)},n=function(i){let s=i.int32();return e(s)};return Nm("enum",au.VARINT,t,n)}function Ie(r,e){return Nm("message",au.LENGTH_DELIMITED,r,e)}var dt=class extends Error{code="ERR_MAX_LENGTH";name="MaxLengthError"},Ld=class extends Error{code="ERR_MAX_SIZE";name="MaxSizeError"};var wt;(function(r){r.RSA="RSA",r.Ed25519="Ed25519",r.secp256k1="secp256k1",r.ECDSA="ECDSA"})(wt||(wt={}));var T5;(function(r){r[r.RSA=0]="RSA",r[r.Ed25519=1]="Ed25519",r[r.secp256k1=2]="secp256k1",r[r.ECDSA=3]="ECDSA"})(T5||(T5={}));(function(r){r.codec=()=>kt(T5)})(wt||(wt={}));var ri;(function(r){let e;r.codec=()=>(e==null&&(e=Ie((t,n,o={})=>{o.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),wt.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{i.Type=wt.codec().decode(t);break}case 2:{i.Data=t.bytes();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>Te(t,r.codec()),r.decode=(t,n)=>Ae(t,r.codec(),n)})(ri||(ri={}));var Bd;(function(r){let e;r.codec=()=>(e==null&&(e=Ie((t,n,o={})=>{o.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),wt.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{i.Type=wt.codec().decode(t);break}case 2:{i.Data=t.bytes();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>Te(t,r.codec()),r.decode=(t,n)=>Ae(t,r.codec(),n)})(Bd||(Bd={}));function Xr(r){if(isNaN(r)||r<=0)throw new P("random bytes length must be a Number bigger than 0");return Zo(r)}var Ud={};Nt(Ud,{MAX_RSA_KEY_SIZE:()=>I5,generateRSAKeyPair:()=>B5,jwkToJWKKeyPair:()=>ZE,jwkToPkcs1:()=>wM,jwkToPkix:()=>O5,jwkToRSAPrivateKey:()=>L5,pkcs1MessageToJwk:()=>P5,pkcs1MessageToRSAPrivateKey:()=>Lm,pkcs1ToJwk:()=>yM,pkcs1ToRSAPrivateKey:()=>R5,pkixMessageToJwk:()=>k5,pkixMessageToRSAPublicKey:()=>N5,pkixToJwk:()=>bM,pkixToRSAPublicKey:()=>D5});var cu=class{type="RSA";jwk;_raw;_multihash;constructor(e,t){this.jwk=e,this._multihash=t}get raw(){return this._raw==null&&(this._raw=Ud.jwkToPkix(this.jwk)),this._raw}toMultihash(){return this._multihash}toCID(){return he.createV1(114,this._multihash)}toString(){return ft.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:we(this.raw,e.raw)}verify(e,t,n){return QE(this.jwk,t,e,n)}},Md=class{type="RSA";jwk;_raw;publicKey;constructor(e,t){this.jwk=e,this.publicKey=t}get raw(){return this._raw==null&&(this._raw=Ud.jwkToPkcs1(this.jwk)),this._raw}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:we(this.raw,e.raw)}sign(e,t){return YE(this.jwk,e,t)}};var I5=8192,C5=18,mM=1062,gM=Uint8Array.from([48,13,6,9,42,134,72,134,247,13,1,1,1,5,0]);function yM(r){let e=Xn(r);return P5(e)}function P5(r){return{n:j(r[1],"base64url"),e:j(r[2],"base64url"),d:j(r[3],"base64url"),p:j(r[4],"base64url"),q:j(r[5],"base64url"),dp:j(r[6],"base64url"),dq:j(r[7],"base64url"),qi:j(r[8],"base64url"),kty:"RSA"}}function wM(r){if(r.n==null||r.e==null||r.d==null||r.p==null||r.q==null||r.dp==null||r.dq==null||r.qi==null)throw new P("JWK was missing components");return vo([zr(Uint8Array.from([0])),zr(B(r.n,"base64url")),zr(B(r.e,"base64url")),zr(B(r.d,"base64url")),zr(B(r.p,"base64url")),zr(B(r.q,"base64url")),zr(B(r.dp,"base64url")),zr(B(r.dq,"base64url")),zr(B(r.qi,"base64url"))]).subarray()}function bM(r){let e=Xn(r,{offset:0});return k5(e)}function k5(r){let e=Xn(r[1],{offset:0});return{kty:"RSA",n:j(e[0],"base64url"),e:j(e[1],"base64url")}}function O5(r){if(r.n==null||r.e==null)throw new P("JWK was missing components");return vo([gM,vd(vo([zr(B(r.n,"base64url")),zr(B(r.e,"base64url"))]))]).subarray()}function R5(r){let e=Xn(r);return Lm(e)}function Lm(r){let e=P5(r);return L5(e)}function D5(r,e){if(r.byteLength>=mM)throw new Oi("Key size is too large");let t=Xn(r,{offset:0});return N5(t,r,e)}function N5(r,e,t){let n=k5(r);if(t==null){let o=Yn(ri.encode({Type:wt.RSA,Data:e}));t=Wr(C5,o)}return new cu(n,t)}function L5(r){if(eS(r)>I5)throw new P("Key size is too large");let e=ZE(r),t=Yn(ri.encode({Type:wt.RSA,Data:O5(e.publicKey)})),n=Wr(C5,t);return new Md(e.privateKey,new cu(e.publicKey,n))}async function B5(r){if(r>I5)throw new P("Key size is too large");let e=await JE(r),t=Yn(ri.encode({Type:wt.RSA,Data:O5(e.publicKey)})),n=Wr(C5,t);return new Md(e.privateKey,new cu(e.publicKey,n))}function ZE(r){if(r==null)throw new P("Missing key parameter");return{privateKey:r,publicKey:{kty:r.kty,n:r.n,e:r.e}}}async function JE(r,e){let t=await qt.get().subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:r,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign","verify"]);e?.signal?.throwIfAborted();let n=await vM(t,e);return{privateKey:n[0],publicKey:n[1]}}async function YE(r,e,t){let n=await qt.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["sign"]);t?.signal?.throwIfAborted();let o=await qt.get().subtle.sign({name:"RSASSA-PKCS1-v1_5"},n,e instanceof Uint8Array?e:e.subarray());return t?.signal?.throwIfAborted(),new Uint8Array(o,0,o.byteLength)}async function QE(r,e,t,n){let o=await qt.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]);n?.signal?.throwIfAborted();let i=await qt.get().subtle.verify({name:"RSASSA-PKCS1-v1_5"},o,e,t instanceof Uint8Array?t:t.subarray());return n?.signal?.throwIfAborted(),i}async function vM(r,e){if(r.privateKey==null||r.publicKey==null)throw new P("Private and public key are required");let t=await Promise.all([qt.get().subtle.exportKey("jwk",r.privateKey),qt.get().subtle.exportKey("jwk",r.publicKey)]);return e?.signal?.throwIfAborted(),t}function eS(r){if(r.kty!=="RSA")throw new P("invalid key type");if(r.n==null)throw new P("invalid key modulus");return B(r.n,"base64url").length*8}var Bm=class{oHash;iHash;blockLen;outputLen;finished=!1;destroyed=!1;constructor(e,t){if(Ni(e),Oe(t,void 0,"key"),this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;let n=this.blockLen,o=new Uint8Array(n);o.set(t.length>n?e.create().update(t).digest():t);for(let i=0;i<o.length;i++)o[i]^=54;this.iHash.update(o),this.oHash=e.create();for(let i=0;i<o.length;i++)o[i]^=106;this.oHash.update(o),Lr(o)}update(e){return Gl(this),this.iHash.update(e),this}digestInto(e){Gl(this),Oe(e,this.outputLen,"output"),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){let e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||=Object.create(Object.getPrototypeOf(this),{});let{oHash:t,iHash:n,finished:o,destroyed:i,blockLen:s,outputLen:a}=this;return e=e,e.finished=o,e.destroyed=i,e.blockLen=s,e.outputLen=a,e.oHash=t._cloneInto(e.oHash),e.iHash=n._cloneInto(e.iHash),e}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}},$s=(r,e,t)=>new Bm(r,e).update(t).digest();$s.create=(r,e)=>new Bm(r,e);var tS=(r,e)=>(r+(r>=0?e:-e)/rS)/e;function xM(r,e,t){let[[n,o],[i,s]]=e,a=tS(s*r,t),c=tS(-o*r,t),l=r-a*n-c*i,f=-a*o-c*s,u=l<$i,d=f<$i;u&&(l=-l),d&&(f=-f);let h=Td(Math.ceil(Q6(t)/2))+lu;if(l<$i||l>=h||f<$i||f>=h)throw new Error("splitScalar (endomorphism): failed, k="+r);return{k1neg:u,k1:l,k2neg:d,k2:f}}function U5(r){if(!["compact","recovered","der"].includes(r))throw new Error('Signature format must be "compact", "recovered", or "der"');return r}function M5(r,e){let t={};for(let n of Object.keys(e))t[n]=r[n]===void 0?e[n]:r[n];return Ui(t.lowS,"lowS"),Ui(t.prehash,"prehash"),t.format!==void 0&&U5(t.format),t}var F5=class extends Error{constructor(e=""){super(e)}},js={Err:F5,_tlv:{encode:(r,e)=>{let{Err:t}=js;if(r<0||r>256)throw new t("tlv.encode: wrong tag");if(e.length&1)throw new t("tlv.encode: unpadded data");let n=e.length/2,o=_d(n);if(o.length/2&128)throw new t("tlv.encode: long form length too big");let i=n>127?_d(o.length/2|128):"";return _d(r)+i+o+e},decode(r,e){let{Err:t}=js,n=0;if(r<0||r>256)throw new t("tlv.encode: wrong tag");if(e.length<2||e[n++]!==r)throw new t("tlv.decode: wrong tlv");let o=e[n++],i=!!(o&128),s=0;if(!i)s=o;else{let c=o&127;if(!c)throw new t("tlv.decode(long): indefinite length not supported");if(c>4)throw new t("tlv.decode(long): byte length is too big");let l=e.subarray(n,n+c);if(l.length!==c)throw new t("tlv.decode: length bytes not complete");if(l[0]===0)throw new t("tlv.decode(long): zero leftmost byte");for(let f of l)s=s<<8|f;if(n+=c,s<128)throw new t("tlv.decode(long): not minimal encoding")}let a=e.subarray(n,n+s);if(a.length!==s)throw new t("tlv.decode: wrong value length");return{v:a,l:e.subarray(n+s)}}},_int:{encode(r){let{Err:e}=js;if(r<$i)throw new e("integer: negative integers are not allowed");let t=_d(r);if(Number.parseInt(t[0],16)&8&&(t="00"+t),t.length&1)throw new e("unexpected DER parsing assertion: unpadded hex");return t},decode(r){let{Err:e}=js;if(r[0]&128)throw new e("invalid signature integer: negative");if(r[0]===0&&!(r[1]&128))throw new e("invalid signature integer: unnecessary leading zero");return Xl(r)}},toSig(r){let{Err:e,_int:t,_tlv:n}=js,o=Oe(r,void 0,"signature"),{v:i,l:s}=n.decode(48,o);if(s.length)throw new e("invalid signature: left bytes after parsing");let{v:a,l:c}=n.decode(2,i),{v:l,l:f}=n.decode(2,c);if(f.length)throw new e("invalid signature: left bytes after parsing");return{r:t.decode(a),s:t.decode(l)}},hexFromSig(r){let{_tlv:e,_int:t}=js,n=e.encode(2,t.encode(r.r)),o=e.encode(2,t.encode(r.s)),i=n+o;return e.encode(48,i)}},$i=BigInt(0),lu=BigInt(1),rS=BigInt(2),Mm=BigInt(3),EM=BigInt(4);function nS(r,e={}){let t=Pm("weierstrass",r,e),{Fp:n,Fn:o}=t,i=t.CURVE,{h:s,n:a}=i;ti(e,{},{allowInfinityPoint:"boolean",clearCofactor:"function",isTorsionFree:"function",fromBytes:"function",toBytes:"function",endo:"object"});let{endo:c}=e;if(c&&(!n.is0(i.a)||typeof c.beta!="bigint"||!Array.isArray(c.basises)))throw new Error('invalid endo: expected "beta": bigint and "basises": array');let l=iS(n,o);function f(){if(!n.isOdd)throw new Error("compression is not supported: Field does not have .isOdd()")}function u(U,I,S){let{x,y:D}=I.toAffine(),q=n.toBytes(x);if(Ui(S,"isCompressed"),S){f();let H=!n.isOdd(D);return cn(oS(H),q)}else return cn(Uint8Array.of(4),q,n.toBytes(D))}function d(U){Oe(U,void 0,"Point");let{publicKey:I,publicKeyUncompressed:S}=l,x=U.length,D=U[0],q=U.subarray(1);if(x===I&&(D===2||D===3)){let H=n.fromBytes(q);if(!n.isValid(H))throw new Error("bad point: is not on curve, wrong x");let M=w(H),G;try{G=n.sqrt(M)}catch(Le){let Fe=Le instanceof Error?": "+Le.message:"";throw new Error("bad point: is not on curve, sqrt error"+Fe)}f();let te=n.isOdd(G);return(D&1)===1!==te&&(G=n.neg(G)),{x:H,y:G}}else if(x===S&&D===4){let H=n.BYTES,M=n.fromBytes(q.subarray(0,H)),G=n.fromBytes(q.subarray(H,H*2));if(!y(M,G))throw new Error("bad point: is not on curve");return{x:M,y:G}}else throw new Error(`bad point: got length ${x}, expected compressed=${I} or uncompressed=${S}`)}let h=e.toBytes||u,m=e.fromBytes||d;function w(U){let I=n.sqr(U),S=n.mul(I,U);return n.add(n.add(S,n.mul(U,i.a)),i.b)}function y(U,I){let S=n.sqr(I),x=w(U);return n.eql(S,x)}if(!y(i.Gx,i.Gy))throw new Error("bad curve params: generator point");let b=n.mul(n.pow(i.a,Mm),EM),N=n.mul(n.sqr(i.b),BigInt(27));if(n.is0(n.add(b,N)))throw new Error("bad curve params: a or b");function O(U,I,S=!1){if(!n.isValid(I)||S&&n.is0(I))throw new Error(`bad point coordinate ${U}`);return I}function V(U){if(!(U instanceof T))throw new Error("Weierstrass Point expected")}function Q(U){if(!c||!c.basises)throw new Error("no endo");return xM(U,c.basises,o.ORDER)}let Z=Yl((U,I)=>{let{X:S,Y:x,Z:D}=U;if(n.eql(D,n.ONE))return{x:S,y:x};let q=U.is0();I==null&&(I=q?n.ONE:n.inv(D));let H=n.mul(S,I),M=n.mul(x,I),G=n.mul(D,I);if(q)return{x:n.ZERO,y:n.ZERO};if(!n.eql(G,n.ONE))throw new Error("invZ was invalid");return{x:H,y:M}}),se=Yl(U=>{if(U.is0()){if(e.allowInfinityPoint&&!n.is0(U.Y))return;throw new Error("bad point: ZERO")}let{x:I,y:S}=U.toAffine();if(!n.isValid(I)||!n.isValid(S))throw new Error("bad point: x or y not field elements");if(!y(I,S))throw new Error("bad point: equation left != right");if(!U.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0});function C(U,I,S,x,D){return S=new T(n.mul(S.X,U),S.Y,S.Z),I=Cd(x,I),S=Cd(D,S),I.add(S)}class T{static BASE=new T(i.Gx,i.Gy,n.ONE);static ZERO=new T(n.ZERO,n.ONE,n.ZERO);static Fp=n;static Fn=o;X;Y;Z;constructor(I,S,x){this.X=O("x",I),this.Y=O("y",S,!0),this.Z=O("z",x),Object.freeze(this)}static CURVE(){return i}static fromAffine(I){let{x:S,y:x}=I||{};if(!I||!n.isValid(S)||!n.isValid(x))throw new Error("invalid affine point");if(I instanceof T)throw new Error("projective point not allowed");return n.is0(S)&&n.is0(x)?T.ZERO:new T(S,x,n.ONE)}static fromBytes(I){let S=T.fromAffine(m(Oe(I,void 0,"point")));return S.assertValidity(),S}static fromHex(I){return T.fromBytes(Bi(I))}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(I=8,S=!0){return z.createCache(this,I),S||this.multiply(Mm),this}assertValidity(){se(this)}hasEvenY(){let{y:I}=this.toAffine();if(!n.isOdd)throw new Error("Field doesn't support isOdd");return!n.isOdd(I)}equals(I){V(I);let{X:S,Y:x,Z:D}=this,{X:q,Y:H,Z:M}=I,G=n.eql(n.mul(S,M),n.mul(q,D)),te=n.eql(n.mul(x,M),n.mul(H,D));return G&&te}negate(){return new T(this.X,n.neg(this.Y),this.Z)}double(){let{a:I,b:S}=i,x=n.mul(S,Mm),{X:D,Y:q,Z:H}=this,M=n.ZERO,G=n.ZERO,te=n.ZERO,F=n.mul(D,D),Le=n.mul(q,q),Fe=n.mul(H,H),me=n.mul(D,q);return me=n.add(me,me),te=n.mul(D,H),te=n.add(te,te),M=n.mul(I,te),G=n.mul(x,Fe),G=n.add(M,G),M=n.sub(Le,G),G=n.add(Le,G),G=n.mul(M,G),M=n.mul(me,M),te=n.mul(x,te),Fe=n.mul(I,Fe),me=n.sub(F,Fe),me=n.mul(I,me),me=n.add(me,te),te=n.add(F,F),F=n.add(te,F),F=n.add(F,Fe),F=n.mul(F,me),G=n.add(G,F),Fe=n.mul(q,H),Fe=n.add(Fe,Fe),F=n.mul(Fe,me),M=n.sub(M,F),te=n.mul(Fe,Le),te=n.add(te,te),te=n.add(te,te),new T(M,G,te)}add(I){V(I);let{X:S,Y:x,Z:D}=this,{X:q,Y:H,Z:M}=I,G=n.ZERO,te=n.ZERO,F=n.ZERO,Le=i.a,Fe=n.mul(i.b,Mm),me=n.mul(S,q),He=n.mul(x,H),ot=n.mul(D,M),Ct=n.add(S,x),ze=n.add(q,H);Ct=n.mul(Ct,ze),ze=n.add(me,He),Ct=n.sub(Ct,ze),ze=n.add(S,D);let it=n.add(q,M);return ze=n.mul(ze,it),it=n.add(me,ot),ze=n.sub(ze,it),it=n.add(x,D),G=n.add(H,M),it=n.mul(it,G),G=n.add(He,ot),it=n.sub(it,G),F=n.mul(Le,ze),G=n.mul(Fe,ot),F=n.add(G,F),G=n.sub(He,F),F=n.add(He,F),te=n.mul(G,F),He=n.add(me,me),He=n.add(He,me),ot=n.mul(Le,ot),ze=n.mul(Fe,ze),He=n.add(He,ot),ot=n.sub(me,ot),ot=n.mul(Le,ot),ze=n.add(ze,ot),me=n.mul(He,ze),te=n.add(te,me),me=n.mul(it,ze),G=n.mul(Ct,G),G=n.sub(G,me),me=n.mul(Ct,He),F=n.mul(it,F),F=n.add(F,me),new T(G,te,F)}subtract(I){return this.add(I.negate())}is0(){return this.equals(T.ZERO)}multiply(I){let{endo:S}=e;if(!o.isValidNot0(I))throw new Error("invalid scalar: out of range");let x,D,q=H=>z.cached(this,H,M=>ac(T,M));if(S){let{k1neg:H,k1:M,k2neg:G,k2:te}=Q(I),{p:F,f:Le}=q(M),{p:Fe,f:me}=q(te);D=Le.add(me),x=C(S.beta,F,Fe,H,G)}else{let{p:H,f:M}=q(I);x=H,D=M}return ac(T,[x,D])[0]}multiplyUnsafe(I){let{endo:S}=e,x=this;if(!o.isValid(I))throw new Error("invalid scalar: out of range");if(I===$i||x.is0())return T.ZERO;if(I===lu)return x;if(z.hasCache(this))return this.multiply(I);if(S){let{k1neg:D,k1:q,k2neg:H,k2:M}=Q(I),{p1:G,p2:te}=IE(T,x,q,M);return C(S.beta,G,te,D,H)}else return z.unsafe(x,I)}toAffine(I){return Z(this,I)}isTorsionFree(){let{isTorsionFree:I}=e;return s===lu?!0:I?I(T,this):z.unsafe(this,a).is0()}clearCofactor(){let{clearCofactor:I}=e;return s===lu?this:I?I(T,this):this.multiplyUnsafe(s)}isSmallOrder(){return this.multiplyUnsafe(s).is0()}toBytes(I=!0){return Ui(I,"isCompressed"),this.assertValidity(),h(T,this,I)}toHex(I=!0){return Li(this.toBytes(I))}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}}let K=o.BITS,z=new Jl(T,e.endo?Math.ceil(K/2):K);return T.BASE.precompute(8),T}function oS(r){return Uint8Array.of(r?2:3)}function iS(r,e){return{secretKey:e.BYTES,publicKey:1+r.BYTES,publicKeyUncompressed:1+2*r.BYTES,publicKeyHasPrefix:!0,signature:2*e.BYTES}}function SM(r,e={}){let{Fn:t}=r,n=e.randomBytes||Zo,o=Object.assign(iS(r.Fp,t),{seed:t5(t.ORDER)});function i(h){try{let m=t.fromBytes(h);return t.isValidNot0(m)}catch{return!1}}function s(h,m){let{publicKey:w,publicKeyUncompressed:y}=o;try{let b=h.length;return m===!0&&b!==w||m===!1&&b!==y?!1:!!r.fromBytes(h)}catch{return!1}}function a(h=n(o.seed)){return r5(Oe(h,o.seed,"seed"),t.ORDER)}function c(h,m=!0){return r.BASE.multiply(t.fromBytes(h)).toBytes(m)}function l(h){let{secretKey:m,publicKey:w,publicKeyUncompressed:y}=o;if(!Ja(h)||"_lengths"in t&&t._lengths||m===w)return;let b=Oe(h,void 0,"key").length;return b===w||b===y}function f(h,m,w=!0){if(l(h)===!0)throw new Error("first arg must be private key");if(l(m)===!1)throw new Error("second arg must be public key");let y=t.fromBytes(h);return r.fromBytes(m).multiply(y).toBytes(w)}let u={isValidSecretKey:i,isValidPublicKey:s,randomSecretKey:a},d=eu(a,c);return Object.freeze({getPublicKey:c,getSharedSecret:f,keygen:d,Point:r,utils:u,lengths:o})}function sS(r,e,t={}){Ni(e),ti(t,{},{hmac:"function",lowS:"boolean",randomBytes:"function",bits2int:"function",bits2int_modN:"function"}),t=Object.assign({},t);let n=t.randomBytes||Zo,o=t.hmac||((S,x)=>$s(e,S,x)),{Fp:i,Fn:s}=r,{ORDER:a,BITS:c}=s,{keygen:l,getPublicKey:f,getSharedSecret:u,utils:d,lengths:h}=SM(r,t),m={prehash:!0,lowS:typeof t.lowS=="boolean"?t.lowS:!0,format:"compact",extraEntropy:!1},w=a*rS<i.ORDER;function y(S){let x=a>>lu;return S>x}function b(S,x){if(!s.isValidNot0(x))throw new Error(`invalid signature ${S}: out of range 1..Point.Fn.ORDER`);return x}function N(){if(w)throw new Error('"recovered" sig type is not supported for cofactor >2 curves')}function O(S,x){U5(x);let D=h.signature,q=x==="compact"?D:x==="recovered"?D+1:void 0;return Oe(S,q)}class V{r;s;recovery;constructor(x,D,q){if(this.r=b("r",x),this.s=b("s",D),q!=null){if(N(),![0,1,2,3].includes(q))throw new Error("invalid recovery id");this.recovery=q}Object.freeze(this)}static fromBytes(x,D=m.format){O(x,D);let q;if(D==="der"){let{r:te,s:F}=js.toSig(Oe(x));return new V(te,F)}D==="recovered"&&(q=x[0],D="compact",x=x.subarray(1));let H=h.signature/2,M=x.subarray(0,H),G=x.subarray(H,H*2);return new V(s.fromBytes(M),s.fromBytes(G),q)}static fromHex(x,D){return this.fromBytes(Bi(x),D)}assertRecovery(){let{recovery:x}=this;if(x==null)throw new Error("invalid recovery id: must be present");return x}addRecoveryBit(x){return new V(this.r,this.s,x)}recoverPublicKey(x){let{r:D,s:q}=this,H=this.assertRecovery(),M=H===2||H===3?D+a:D;if(!i.isValid(M))throw new Error("invalid recovery id: sig.r+curve.n != R.x");let G=i.toBytes(M),te=r.fromBytes(cn(oS((H&1)===0),G)),F=s.inv(M),Le=Z(Oe(x,void 0,"msgHash")),Fe=s.create(-Le*F),me=s.create(q*F),He=r.BASE.multiplyUnsafe(Fe).add(te.multiplyUnsafe(me));if(He.is0())throw new Error("invalid recovery: point at infinify");return He.assertValidity(),He}hasHighS(){return y(this.s)}toBytes(x=m.format){if(U5(x),x==="der")return Bi(js.hexFromSig(this));let{r:D,s:q}=this,H=s.toBytes(D),M=s.toBytes(q);return x==="recovered"?(N(),cn(Uint8Array.of(this.assertRecovery()),H,M)):cn(H,M)}toHex(x){return Li(this.toBytes(x))}}let Q=t.bits2int||function(x){if(x.length>8192)throw new Error("input is too large");let D=Xl(x),q=x.length*8-c;return q>0?D>>BigInt(q):D},Z=t.bits2int_modN||function(x){return s.create(Q(x))},se=Td(c);function C(S){return Ms("num < 2^"+c,S,$i,se),s.toBytes(S)}function T(S,x){return Oe(S,void 0,"message"),x?Oe(e(S),void 0,"prehashed message"):S}function K(S,x,D){let{lowS:q,prehash:H,extraEntropy:M}=M5(D,m);S=T(S,H);let G=Z(S),te=s.fromBytes(x);if(!s.isValidNot0(te))throw new Error("invalid private key");let F=[C(te),C(G)];if(M!=null&&M!==!1){let He=M===!0?n(h.secretKey):M;F.push(Oe(He,void 0,"extraEntropy"))}let Le=cn(...F),Fe=G;function me(He){let ot=Q(He);if(!s.isValidNot0(ot))return;let Ct=s.inv(ot),ze=r.BASE.multiply(ot).toAffine(),it=s.create(ze.x);if(it===$i)return;let Pi=s.create(Ct*s.create(Fe+it*te));if(Pi===$i)return;let mo=(ze.x===it?0:2)|Number(ze.y&lu),Is=Pi;return q&&y(Pi)&&(Is=s.neg(Pi),mo^=1),new V(it,Is,w?void 0:mo)}return{seed:Le,k2sig:me}}function z(S,x,D={}){let{seed:q,k2sig:H}=K(S,x,D);return uE(e.outputLen,s.BYTES,o)(q,H).toBytes(D.format)}function U(S,x,D,q={}){let{lowS:H,prehash:M,format:G}=M5(q,m);if(D=Oe(D,void 0,"publicKey"),x=T(x,M),!Ja(S)){let te=S instanceof V?", use sig.toBytes()":"";throw new Error("verify expects Uint8Array signature"+te)}O(S,G);try{let te=V.fromBytes(S,G),F=r.fromBytes(D);if(H&&te.hasHighS())return!1;let{r:Le,s:Fe}=te,me=Z(x),He=s.inv(Fe),ot=s.create(me*He),Ct=s.create(Le*He),ze=r.BASE.multiplyUnsafe(ot).add(F.multiplyUnsafe(Ct));return ze.is0()?!1:s.create(ze.x)===Le}catch{return!1}}function I(S,x,D={}){let{prehash:q}=M5(D,m);return x=T(x,q),V.fromBytes(S,"recovered").recoverPublicKey(x).toBytes()}return Object.freeze({keygen:l,getPublicKey:f,getSharedSecret:u,utils:d,lengths:h,Point:r,sign:z,verify:U,recoverPublicKey:I,Signature:V,hash:e})}var j5={p:BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),n:BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),h:BigInt(1),a:BigInt(0),b:BigInt(7),Gx:BigInt("0x79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798"),Gy:BigInt("0x483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8")},_M={beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),basises:[[BigInt("0x3086d221a7d46bcde86c90e49284eb15"),-BigInt("0xe4437ed6010e88286f547fa90abfe4c3")],[BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),BigInt("0x3086d221a7d46bcde86c90e49284eb15")]]};var aS=BigInt(2);function AM(r){let e=j5.p,t=BigInt(3),n=BigInt(6),o=BigInt(11),i=BigInt(22),s=BigInt(23),a=BigInt(44),c=BigInt(88),l=r*r*r%e,f=l*l*r%e,u=_t(f,t,e)*f%e,d=_t(u,t,e)*f%e,h=_t(d,aS,e)*l%e,m=_t(h,o,e)*h%e,w=_t(m,i,e)*m%e,y=_t(w,a,e)*w%e,b=_t(y,c,e)*y%e,N=_t(b,a,e)*w%e,O=_t(N,t,e)*f%e,V=_t(O,s,e)*m%e,Q=_t(V,n,e)*l%e,Z=_t(Q,aS,e);if(!$5.eql($5.sqr(Z),r))throw new Error("Cannot find square root");return Z}var $5=Ql(j5.p,{sqrt:AM}),TM=nS(j5,{Fp:$5,endo:_M}),So=sS(TM,Yn);var cS=32;function lS(r,e,t){let n=St.digest(e instanceof Uint8Array?e:e.subarray());if(nu(n))return n.then(({digest:o})=>(t?.signal?.throwIfAborted(),So.sign(o,r,{prehash:!1,format:"der"}))).catch(o=>{throw o.name==="AbortError"?o:new gd(String(o))});try{return So.sign(n.digest,r,{prehash:!1,format:"der"})}catch(o){throw new gd(String(o))}}function uS(r,e,t,n){let o=St.digest(t instanceof Uint8Array?t:t.subarray());if(nu(o))return o.then(({digest:i})=>(n?.signal?.throwIfAborted(),So.verify(e,i,r,{prehash:!1,format:"der"}))).catch(i=>{throw i.name==="AbortError"?i:new yd(String(i))});try{return n?.signal?.throwIfAborted(),So.verify(e,o.digest,r,{prehash:!1,format:"der"})}catch(i){throw new yd(String(i))}}var Fd=class{type="secp256k1";raw;_key;constructor(e){this._key=hS(e),this.raw=fS(this._key)}toMultihash(){return Dr.digest(sr(this))}toCID(){return he.createV1(114,this.toMultihash())}toString(){return ft.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:we(this.raw,e.raw)}verify(e,t,n){return uS(this._key,t,e,n)}},$d=class{type="secp256k1";raw;publicKey;constructor(e,t){this.raw=dS(e),this.publicKey=new Fd(t??pS(e))}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:we(this.raw,e.raw)}sign(e,t){return lS(this.raw,e,t)}};function K5(r){return new $d(r)}function V5(r){return new Fd(r)}async function mS(){let r=IM();return new $d(r)}function fS(r){return So.Point.fromBytes(r).toBytes()}function dS(r){try{return So.getPublicKey(r,!0),r}catch(e){throw new od(String(e))}}function hS(r){try{return So.Point.fromBytes(r),r}catch(e){throw new Oi(String(e))}}function pS(r){try{return So.getPublicKey(r,!0)}catch(e){throw new od(String(e))}}function IM(){return So.utils.randomSecretKey()}async function uu(r,e){if(r==="Ed25519")return $E();if(r==="secp256k1")return mS();if(r==="RSA")return B5(CM(e));if(r==="ECDSA")return zx(PM(e));throw new wo}function Kt(r,e){let{Type:t,Data:n}=ri.decode(r),o=n??new Uint8Array;switch(t){case wt.RSA:return D5(o,e);case wt.Ed25519:return l5(o);case wt.secp256k1:return V5(o);case wt.ECDSA:return $6(o);default:throw new wo}}function Um(r){let{Type:e,Data:t}=ri.decode(r.digest),n=t??new Uint8Array;switch(e){case wt.Ed25519:return l5(n);case wt.secp256k1:return V5(n);case wt.ECDSA:return $6(n);default:throw new wo}}function sr(r){return ri.encode({Type:wt[r.type],Data:r.raw})}function gS(r){let e=Bd.decode(r),t=e.Data??new Uint8Array;switch(e.Type){case wt.RSA:return R5(t);case wt.Ed25519:return c5(t);case wt.secp256k1:return K5(t);case wt.ECDSA:return Kx(t);default:throw new wo}}function yS(r){if(r.byteLength===In)return c5(r);if(r.byteLength===cS)return K5(r);let e=Xn(r),t=e[2]?.[0];if(t===Dx||t===Nx||t===Lx)return F6(e);if(e.length>8)return Lm(e);throw new P("Could not extract private key from raw bytes")}function fc(r){return Bd.encode({Type:wt[r.type],Data:r.raw})}function CM(r){return r==null?2048:parseInt(r,10)}function PM(r){if(r==="P-256"||r==null)return"P-256";if(r==="P-384")return"P-384";if(r==="P-521")return"P-521";throw new P("Unsupported curve, should be P-256, P-384 or P-521")}async function Fm(r){if(r.type==="RSA")return{privateKey:await crypto.subtle.importKey("jwk",r.jwk,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["sign"]),publicKey:await crypto.subtle.importKey("jwk",r.publicKey.jwk,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["verify"])};if(r.type==="ECDSA")return{privateKey:await crypto.subtle.importKey("jwk",r.jwk,{name:"ECDSA",namedCurve:r.jwk.crv??"P-256"},!0,["sign"]),publicKey:await crypto.subtle.importKey("jwk",r.publicKey.jwk,{name:"ECDSA",namedCurve:r.publicKey.jwk.crv??"P-256"},!0,["verify"])};throw new P("Only RSA and ECDSA keys are supported")}var jd=Uint32Array.from([1732584193,4023233417,2562383102,271733878,3285377520]),Ks=new Uint32Array(80),H5=class extends tc{A=jd[0]|0;B=jd[1]|0;C=jd[2]|0;D=jd[3]|0;E=jd[4]|0;constructor(){super(64,20,8,!1)}get(){let{A:e,B:t,C:n,D:o,E:i}=this;return[e,t,n,o,i]}set(e,t,n,o,i){this.A=e|0,this.B=t|0,this.C=n|0,this.D=o|0,this.E=i|0}process(e,t){for(let c=0;c<16;c++,t+=4)Ks[c]=e.getUint32(t,!1);for(let c=16;c<80;c++)Ks[c]=Sm(Ks[c-3]^Ks[c-8]^Ks[c-14]^Ks[c-16],1);let{A:n,B:o,C:i,D:s,E:a}=this;for(let c=0;c<80;c++){let l,f;c<20?(l=_m(o,i,s),f=1518500249):c<40?(l=o^i^s,f=1859775393):c<60?(l=Am(o,i,s),f=2400959708):(l=o^i^s,f=3395469782);let u=Sm(n,5)+l+a+f+Ks[c]|0;a=s,s=i,i=Sm(o,30),o=n,n=u}n=n+this.A|0,o=o+this.B|0,i=i+this.C|0,s=s+this.D|0,a=a+this.E|0,this.set(n,o,i,s,a)}roundClean(){Lr(Ks)}destroy(){this.set(0,0,0,0,0),Lr(this.buffer)}},wS=xd(()=>new H5);function bS(r,e,t,n){Ni(r);let o=Zx({dkLen:32,asyncTick:10},n),{c:i,dkLen:s,asyncTick:a}=o;if(Nr(i,"c"),Nr(s,"dkLen"),Nr(a,"asyncTick"),i<1)throw new Error("iterations (c) must be >= 1");let c=j6(e,"password"),l=j6(t,"salt"),f=new Uint8Array(s),u=$s.create(r,c),d=u._cloneInto().update(l);return{c:i,dkLen:s,asyncTick:a,DK:f,PRF:u,PRFSalt:d}}function vS(r,e,t,n,o){return r.destroy(),e.destroy(),n&&n.destroy(),Lr(o),t}function xS(r,e,t,n){let{c:o,dkLen:i,DK:s,PRF:a,PRFSalt:c}=bS(r,e,t,n),l,f=new Uint8Array(4),u=ec(f),d=new Uint8Array(a.outputLen);for(let h=1,m=0;m<i;h++,m+=a.outputLen){let w=s.subarray(m,m+a.outputLen);u.setInt32(0,h,!1),(l=c._cloneInto(l)).update(f).digestInto(d),w.set(d.subarray(0,w.length));for(let y=1;y<o;y++){a._cloneInto(l).update(d).digestInto(d);for(let b=0;b<w.length;b++)w[b]^=d[b]}}return vS(a,c,s,l,d)}async function $m(r,e,t,n){let{c:o,dkLen:i,asyncTick:s,DK:a,PRF:c,PRFSalt:l}=bS(r,e,t,n),f,u=new Uint8Array(4),d=ec(u),h=new Uint8Array(c.outputLen);for(let m=1,w=0;w<i;m++,w+=c.outputLen){let y=a.subarray(w,w+c.outputLen);d.setInt32(0,m,!1),(f=l._cloneInto(f)).update(u).digestInto(h),y.set(h.subarray(0,y.length)),await Qx(o-1,s,()=>{c._cloneInto(f).update(h).digestInto(h);for(let b=0;b<y.length;b++)y[b]^=h[b]})}return vS(c,l,a,f,h)}var ES={sha1:wS,"sha2-256":Yn,"sha2-512":Bs};function Kd(r,e,t,n,o){if(o!=="sha1"&&o!=="sha2-256"&&o!=="sha2-512"){let a=Object.keys(ES).join(" / ");throw new P(`Hash '${o}' is unknown or not supported. Must be ${a}`)}let i=ES[o],s=xS(i,r,e,{c:t,dkLen:n});return Ht.encode(s).substring(1)}var q5={32:16777619n,64:1099511628211n,128:309485009821345068724781371n,256:374144419156711147060143317175368453031918731002211n,512:35835915874844867368919076489095108449946327955754392558399825615420669938882575126094039892345713852759n,1024:5016456510113118655434598811035278955030765345404790744303017523831112055108147451509157692220295382716162651878526895249385292291816524375083746691371804094271873160484737966720260389217684476157468082573n},SS={32:2166136261n,64:14695981039346656037n,128:144066263297769815596495629667062367629n,256:100029257958052580907070968620625704837092796014241193945225284501741471925557n,512:9659303129496669498009435400716310466090418745672637896108374329434462657994582932197716438449813051892206539805784495328239340083876191928701583869517785n,1024:14197795064947621068722070641403218320880622795441933960878474914617582723252296732303717722150864096521202355549365628174669108571814760471015076148029755969804077320157692458563003215304957150157403644460363550505412711285966361610267868082893823963790439336411086884584107735010676915n},_S=new globalThis.TextEncoder;function kM(r,e){let t=q5[e],n=SS[e];for(let o=0;o<r.length;o++)n^=BigInt(r[o]),n=BigInt.asUintN(e,n*t);return n}function OM(r,e,t){if(t.length===0)throw new Error("The `utf8Buffer` option must have a length greater than zero");let n=q5[e],o=SS[e],i=r;for(;i.length>0;){let s=_S.encodeInto(i,t);i=i.slice(s.read);for(let a=0;a<s.written;a++)o^=BigInt(t[a]),o=BigInt.asUintN(e,o*n)}return o}function W5(r,{size:e=32,utf8Buffer:t}={}){if(!q5[e])throw new Error("The `size` option must be one of 32, 64, 128, 256, 512, or 1024");if(typeof r=="string"){if(t)return OM(r,e,t);r=_S.encode(r)}return kM(r,e)}var Vd={hash:r=>Number(W5(r,{size:32})),hashV:(r,e)=>RM(Vd.hash(r,e))};function RM(r){let e=r.toString(16);return e.length%2===1&&(e=`0${e}`),B(e,"base16")}var z5=64,_o=class{fp;h;seed;constructor(e,t,n,o=2){if(o>z5)throw new TypeError("Invalid Fingerprint Size");let i=t.hashV(e,n),s=ke(o);for(let a=0;a<s.length;a++)s[a]=i[a];s.length===0&&(s[0]=7),this.fp=s,this.h=t,this.seed=n}hash(){return this.h.hash(this.fp,this.seed)}equals(e){return e?.fp instanceof Uint8Array?we(this.fp,e.fp):!1}};function dc(r,e){return Math.floor(Math.random()*(e-r))+r}var hc=class{contents;constructor(e){this.contents=new Array(e).fill(null)}has(e){if(!(e instanceof _o))throw new TypeError("Invalid Fingerprint");return this.contents.some(t=>e.equals(t))}add(e){if(!(e instanceof _o))throw new TypeError("Invalid Fingerprint");for(let t=0;t<this.contents.length;t++)if(this.contents[t]==null)return this.contents[t]=e,!0;return!0}swap(e){if(!(e instanceof _o))throw new TypeError("Invalid Fingerprint");let t=dc(0,this.contents.length-1),n=this.contents[t];return this.contents[t]=e,n}remove(e){if(!(e instanceof _o))throw new TypeError("Invalid Fingerprint");let t=this.contents.findIndex(n=>e.equals(n));return t>-1?(this.contents[t]=null,!0):!1}};var DM=500,Hd=class{bucketSize;filterSize;fingerprintSize;buckets;count;hash;seed;constructor(e){this.filterSize=e.filterSize,this.bucketSize=e.bucketSize??4,this.fingerprintSize=e.fingerprintSize??2,this.count=0,this.buckets=[],this.hash=e.hash??Vd,this.seed=e.seed??dc(0,Math.pow(2,10))}add(e){typeof e=="string"&&(e=B(e));let t=new _o(e,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(e,this.seed)%this.filterSize,o=(n^t.hash())%this.filterSize;if(this.buckets[n]==null&&(this.buckets[n]=new hc(this.bucketSize)),this.buckets[o]==null&&(this.buckets[o]=new hc(this.bucketSize)),this.buckets[n].add(t)||this.buckets[o].add(t))return this.count++,!0;let i=[n,o],s=i[dc(0,i.length-1)];this.buckets[s]==null&&(this.buckets[s]=new hc(this.bucketSize));for(let a=0;a<DM;a++){let c=this.buckets[s].swap(t);if(c!=null&&(s=(s^c.hash())%this.filterSize,this.buckets[s]==null&&(this.buckets[s]=new hc(this.bucketSize)),this.buckets[s].add(c)))return this.count++,!0}return!1}has(e){typeof e=="string"&&(e=B(e));let t=new _o(e,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(e,this.seed)%this.filterSize,o=this.buckets[n]?.has(t)??!1;if(o)return o;let i=(n^t.hash())%this.filterSize;return this.buckets[i]?.has(t)??!1}remove(e){typeof e=="string"&&(e=B(e));let t=new _o(e,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(e,this.seed)%this.filterSize,o=this.buckets[n]?.remove(t)??!1;if(o)return this.count--,o;let i=(n^t.hash())%this.filterSize,s=this.buckets[i]?.remove(t)??!1;return s&&this.count--,s}get reliable(){return Math.floor(100*(this.count/this.filterSize))<=90}},NM={1:.5,2:.84,4:.95,8:.98};function LM(r=.001){return r>.002?2:r>1e-5?4:8}function AS(r,e=.001){let t=LM(e),n=NM[t],o=Math.round(r/n),i=Math.min(Math.ceil(Math.log2(1/e)+Math.log2(2*t)),z5);return{filterSize:o,bucketSize:t,fingerprintSize:i}}var jm=class{filterSize;bucketSize;fingerprintSize;scale;filterSeries;hash;seed;constructor(e){this.bucketSize=e.bucketSize??4,this.filterSize=e.filterSize??(1<<18)/this.bucketSize,this.fingerprintSize=e.fingerprintSize??2,this.scale=e.scale??2,this.hash=e.hash??Vd,this.seed=e.seed??dc(0,Math.pow(2,10)),this.filterSeries=[new Hd({filterSize:this.filterSize,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed})]}add(e){if(typeof e=="string"&&(e=B(e)),this.has(e))return!0;let t=this.filterSeries.find(n=>n.reliable);if(t==null){let n=this.filterSize*Math.pow(this.scale,this.filterSeries.length);t=new Hd({filterSize:n,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed}),this.filterSeries.push(t)}return t.add(e)}has(e){typeof e=="string"&&(e=B(e));for(let t=0;t<this.filterSeries.length;t++)if(this.filterSeries[t].has(e))return!0;return!1}remove(e){typeof e=="string"&&(e=B(e));for(let t=0;t<this.filterSeries.length;t++)if(this.filterSeries[t].remove(e))return!0;return!1}get count(){return this.filterSeries.reduce((e,t)=>e+t.count,0)}};function Fr(r,e=.001,t){return new jm({...AS(r,e),...t??{}})}function Ce(r){let e=r.getComponents(),t={},n=0;if(e[n]?.name==="ip6zone"&&(t.zone=`${e[n].value}`,n++),e[n].name==="ip4"||e[n].name==="ip6"||e[n].name==="dns"||e[n].name==="dns4"||e[n].name==="dns6"?(t.type=e[n].name,t.host=e[n].value,n++):e[n].name==="dnsaddr"&&(t.type=e[n].name,t.host=`_dnsaddr.${e[n].value}`,n++),(e[n]?.name==="tcp"||e[n]?.name==="udp")&&(t.protocol=e[n].name==="tcp"?"tcp":"udp",t.port=parseInt(`${e[n].value}`),n++),e[n]?.name==="ipcidr"&&(t.type==="ip4"?t.cidr=parseInt(`${e[n].value}`):t.type==="ip6"&&(t.cidr=`${e[n].value}`),n++),t.type==null||t.host==null)throw new P(`Multiaddr ${r} was not an IPv4, IPv6, DNS, DNS4, DNS6 or DNSADDR address`);return e[n]?.name==="tls"&&e[n+1]?.name==="sni"&&(t.sni=e[n+1].value,n+=2),t}var Km=class{index=0;input="";new(e){return this.index=0,this.input=e,this}readAtomically(e){let t=this.index,n=e();return n===void 0&&(this.index=t),n}parseWith(e){let t=e();if(this.index===this.input.length)return t}peekChar(){if(!(this.index>=this.input.length))return this.input[this.index]}readChar(){if(!(this.index>=this.input.length))return this.input[this.index++]}readGivenChar(e){return this.readAtomically(()=>{let t=this.readChar();if(t===e)return t})}readSeparator(e,t,n){return this.readAtomically(()=>{if(!(t>0&&this.readGivenChar(e)===void 0))return n()})}readNumber(e,t,n,o){return this.readAtomically(()=>{let i=0,s=0,a=this.peekChar();if(a===void 0)return;let c=a==="0",l=2**(8*o)-1;for(;;){let f=this.readAtomically(()=>{let u=this.readChar();if(u===void 0)return;let d=Number.parseInt(u,e);if(!Number.isNaN(d))return d});if(f===void 0)break;if(i*=e,i+=f,i>l||(s+=1,t!==void 0&&s>t))return}if(s!==0)return!n&&c&&s>1?void 0:i})}readIPv4Addr(){return this.readAtomically(()=>{let e=new Uint8Array(4);for(let t=0;t<e.length;t++){let n=this.readSeparator(".",t,()=>this.readNumber(10,3,!1,1));if(n===void 0)return;e[t]=n}return e})}readIPv6Addr(){let e=t=>{for(let n=0;n<t.length/2;n++){let o=n*2;if(n<t.length-3){let s=this.readSeparator(":",n,()=>this.readIPv4Addr());if(s!==void 0)return t[o]=s[0],t[o+1]=s[1],t[o+2]=s[2],t[o+3]=s[3],[o+4,!0]}let i=this.readSeparator(":",n,()=>this.readNumber(16,4,!0,2));if(i===void 0)return[o,!1];t[o]=i>>8,t[o+1]=i&255}return[t.length,!1]};return this.readAtomically(()=>{let t=new Uint8Array(16),[n,o]=e(t);if(n===16)return t;if(o||this.readGivenChar(":")===void 0||this.readGivenChar(":")===void 0)return;let i=new Uint8Array(14),s=16-(n+2),[a]=e(i.subarray(0,s));return t.set(i.subarray(0,a),16-a),t})}readIPAddr(){return this.readIPv4Addr()??this.readIPv6Addr()}};var TS=45,BM=15,fu=new Km;function Vm(r){if(!(r.length>BM))return fu.new(r).parseWith(()=>fu.readIPv4Addr())}function Hm(r){if(r.includes("%")&&(r=r.split("%")[0]),!(r.length>TS))return fu.new(r).parseWith(()=>fu.readIPv6Addr())}function du(r,e=!1){if(r.includes("%")&&(r=r.split("%")[0]),r.length>TS)return;let t=fu.new(r).parseWith(()=>fu.readIPAddr());if(t)return e&&t.length===4?Uint8Array.from([0,0,0,0,0,0,0,0,0,0,255,255,t[0],t[1],t[2],t[3]]):t}function IS(r,e,t){let n=0;for(let o of r)if(!(n<e)){if(n>t)break;if(o!==255)return!1;n++}return!0}function CS(r,e,t,n){let o=0;for(let i of r)if(!(o<t)){if(o>n)break;if(i!==e[o])return!1;o++}return!0}function G5(r){switch(r.length){case pc:return r.join(".");case mc:{let e=[];for(let t=0;t<r.length;t++)t%2===0&&e.push(r[t].toString(16).padStart(2,"0")+r[t+1].toString(16).padStart(2,"0"));return e.join(":")}default:throw new Error("Invalid ip length")}}function PS(r){let e=0;for(let[t,n]of r.entries()){if(n===255){e+=8;continue}for(;(n&128)!=0;)e++,n=n<<1;if((n&128)!=0)return-1;for(let o=t+1;o<r.length;o++)if(r[o]!=0)return-1;break}return e}function kS(r){let e="0x";for(let t of r)e+=(t>>4).toString(16)+(t&15).toString(16);return e}var pc=4,mc=16,UJ=parseInt("0xFFFF",16),MM=new Uint8Array([0,0,0,0,0,0,0,0,0,0,255,255]);function qd(r,e){e.length===mc&&r.length===pc&&IS(e,0,11)&&(e=e.slice(12)),e.length===pc&&r.length===mc&&CS(r,MM,0,11)&&(r=r.slice(12));let t=r.length;if(t!=e.length)throw new Error("Failed to mask ip");let n=new Uint8Array(t);for(let o=0;o<t;o++)n[o]=r[o]&e[o];return n}function OS(r,e){if(typeof e=="string"&&(e=du(e)),e==null)throw new Error("Invalid ip");if(e.length!==r.network.length)return!1;for(let t=0;t<e.length;t++)if((r.network[t]&r.mask[t])!==(e[t]&r.mask[t]))return!1;return!0}function X5(r){let[e,t]=r.split("/");if(!e||!t)throw new Error("Failed to parse given CIDR: "+r);let n=pc,o=Vm(e);if(o==null&&(n=mc,o=Hm(e),o==null))throw new Error("Failed to parse given CIDR: "+r);let i=parseInt(t,10);if(Number.isNaN(i)||String(i).length!==t.length||i<0||i>n*8)throw new Error("Failed to parse given CIDR: "+r);let s=Y5(i,8*n);return{network:qd(o,s),mask:s}}function Y5(r,e){if(e!==8*pc&&e!==8*mc)throw new Error("Invalid CIDR mask");if(r<0||r>e)throw new Error("Invalid CIDR mask");let t=e/8,n=new Uint8Array(t);for(let o=0;o<t;o++){if(r>=8){n[o]=255,r-=8;continue}n[o]=255-(255>>r),r=0}return n}var gc=class{constructor(e,t){if(t==null)({network:this.network,mask:this.mask}=X5(e));else{let n=du(e);if(n==null)throw new Error("Failed to parse network");t=String(t);let o=parseInt(t,10);if(Number.isNaN(o)||String(o).length!==t.length||o<0||o>n.length*8){let i=du(t);if(i==null)throw new Error("Failed to parse mask");this.mask=i}else this.mask=Y5(o,8*n.length);this.network=qd(n,this.mask)}}contains(e){return OS({network:this.network,mask:this.mask},e)}toString(){let e=PS(this.mask),t=e!==-1?String(e):kS(this.mask);return G5(this.network)+"/"+t}};function RS(r,e){return new gc(r).contains(e)}function qm(r){try{let e=Ce(r);switch(e.type){case"ip6":return RS("2000::/3",e.host);default:return!1}}catch{return!1}}function DS(r){try{let e=Ce(r);switch(e.type){case"ip4":return e.host.startsWith("169.254.");case"ip6":return e.host.toLowerCase().startsWith("fe80");default:return!1}}catch{return!1}}function NS(r){return/^127\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/i.test(r)||/^::1$/.test(r)}function Wd(r){try{let e=Ce(r);switch(e.type){case"ip4":case"ip6":return NS(e.host);default:return!1}}catch{return!1}}function mr(r){try{return Ce(r),!0}catch{return!1}}function Ao(r){return!!Vm(r)}function Wm(r){return!!Hm(r)}var BS=nr(LS(),1),UM=["0.0.0.0/8","10.0.0.0/8","100.64.0.0/10","127.0.0.0/8","169.254.0.0/16","172.16.0.0/12","192.0.0.0/24","192.0.0.0/29","192.0.0.8/32","192.0.0.9/32","192.0.0.10/32","192.0.0.170/32","192.0.0.171/32","192.0.2.0/24","192.31.196.0/24","192.52.193.0/24","192.88.99.0/24","192.168.0.0/16","192.175.48.0/24","198.18.0.0/15","198.51.100.0/24","203.0.113.0/24","240.0.0.0/4","255.255.255.255/32"],FM=UM.map(r=>new BS.Netmask(r));function Q5(r){for(let e of FM)if(e.contains(r))return!0;return!1}function $M(r){return/^::ffff:([0-9a-fA-F]{1,4}):([0-9a-fA-F]{1,4})$/.test(r)}function jM(r){let e=r.split(":");if(e.length<2)return!1;let t=e[e.length-1].padStart(4,"0"),n=e[e.length-2].padStart(4,"0"),o=`${parseInt(n.substring(0,2),16)}.${parseInt(n.substring(2),16)}.${parseInt(t.substring(0,2),16)}.${parseInt(t.substring(2),16)}`;return Q5(o)}function KM(r){return/^::ffff:([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(r)}function VM(r){let e=r.split(":"),t=e[e.length-1];return Q5(t)}function HM(r){return/^::$/.test(r)||/^::1$/.test(r)||/^64:ff9b::([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(r)||/^100::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001:2[0-9a-fA-F]:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001:db8:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2002:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^f[c-d]([0-9a-fA-F]{2,2}):/i.test(r)||/^fe[8-9a-bA-B][0-9a-fA-F]:/i.test(r)||/^ff([0-9a-fA-F]{2,2}):/i.test(r)}function hu(r){if(Ao(r))return Q5(r);if($M(r))return jM(r);if(KM(r))return VM(r);if(Wm(r))return HM(r)}function Mt(r){try{let e=Ce(r);switch(e.type){case"ip4":case"ip6":return hu(e.host)??!1;default:return e.host==="localhost"}}catch{return!1}}function Ve(){let r={};return r.promise=new Promise((e,t)=>{r.resolve=e,r.reject=t}),r}var zm=class{buffer;mask;top;btm;next;constructor(e){if(!(e>0)||(e-1&e)!==0)throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}push(e){return this.buffer[this.top]!==void 0?!1:(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){let e=this.buffer[this.btm];if(e!==void 0)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}isEmpty(){return this.buffer[this.btm]===void 0}},pu=class{size;hwm;head;tail;constructor(e={}){this.hwm=e.splitLimit??16,this.head=new zm(this.hwm),this.tail=this.head,this.size=0}calculateSize(e){return e?.byteLength!=null?e.byteLength:1}push(e){if(e?.value!=null&&(this.size+=this.calculateSize(e.value)),!this.head.push(e)){let t=this.head;this.head=t.next=new zm(2*this.head.buffer.length),this.head.push(e)}}shift(){let e=this.tail.shift();if(e===void 0&&this.tail.next!=null){let t=this.tail.next;this.tail.next=null,this.tail=t,e=this.tail.shift()}return e?.value!=null&&(this.size-=this.calculateSize(e.value)),e}isEmpty(){return this.head.isEmpty()}};var Z5=class extends Error{type;code;constructor(e,t){super(e??"The operation was aborted"),this.type="aborted",this.code=t??"ABORT_ERR"}};function gr(r={}){return qM(t=>{let n=t.shift();if(n==null)return{done:!0};if(n.error!=null)throw n.error;return{done:n.done===!0,value:n.value}},r)}function qM(r,e){e=e??{};let t=e.onEnd,n=new pu,o,i,s,a=Ve(),c=async()=>{try{return n.isEmpty()?s?{done:!0}:await new Promise((y,b)=>{i=N=>{i=null,n.push(N);try{y(r(n))}catch(O){b(O)}return o}}):r(n)}finally{n.isEmpty()&&queueMicrotask(()=>{a.resolve(),a=Ve()})}},l=y=>i!=null?i(y):(n.push(y),o),f=y=>(n=new pu,i!=null?i({error:y}):(n.push({error:y}),o)),u=y=>{if(s)return o;if(e?.objectMode!==!0&&y?.byteLength==null)throw new Error("objectMode was not true but tried to push non-Uint8Array value");return l({done:!1,value:y})},d=y=>s?o:(s=!0,y!=null?f(y):l({done:!0})),h=()=>(n=new pu,d(),{done:!0}),m=y=>(d(y),{done:!0});if(o={[Symbol.asyncIterator](){return this},next:c,return:h,throw:m,push:u,end:d,get readableLength(){return n.size},onEmpty:async y=>{let b=y?.signal;if(b?.throwIfAborted(),n.isEmpty())return;let N,O;b!=null&&(N=new Promise((V,Q)=>{O=()=>{Q(new Z5)},b.addEventListener("abort",O)}));try{await Promise.race([a.promise,N])}finally{O!=null&&b!=null&&b?.removeEventListener("abort",O)}}},t==null)return o;let w=o;return o={[Symbol.asyncIterator](){return this},next(){return w.next()},throw(y){return w.throw(y),t!=null&&(t(y),t=void 0),{done:!0}},return(){return w.return(),t!=null&&(t(),t=void 0),{done:!0}},push:u,end(y){return w.end(y),t!=null&&(t(y),t=void 0),o},get readableLength(){return w.readableLength},onEmpty:y=>w.onEmpty(y)},o}var J5=class extends Error{constructor(e){super(e),this.name="TimeoutError"}},e8=class extends Error{constructor(e){super(),this.name="AbortError",this.message=e}},MS=r=>globalThis.DOMException===void 0?new e8(r):new DOMException(r),US=r=>{let e=r.reason===void 0?MS("This operation was aborted."):r.reason;return e instanceof Error?e:MS(e)};function t8(r,e){let{milliseconds:t,fallback:n,message:o,customTimers:i={setTimeout,clearTimeout}}=e,s,a,l=new Promise((f,u)=>{if(typeof t!="number"||Math.sign(t)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${t}\``);if(e.signal){let{signal:h}=e;h.aborted&&u(US(h)),a=()=>{u(US(h))},h.addEventListener("abort",a,{once:!0})}if(t===Number.POSITIVE_INFINITY){r.then(f,u);return}let d=new J5;s=i.setTimeout.call(void 0,()=>{if(n){try{f(n())}catch(h){u(h)}return}typeof r.cancel=="function"&&r.cancel(),o===!1?f():o instanceof Error?u(o):(d.message=o??`Promise timed out after ${t} milliseconds`,u(d))},t),(async()=>{try{f(await r)}catch(h){u(h)}})()}).finally(()=>{l.clear(),a&&e.signal&&e.signal.removeEventListener("abort",a)});return l.clear=()=>{i.clearTimeout.call(void 0,s),s=void 0},l}var WM=r=>{let e=r.addEventListener||r.on||r.addListener,t=r.removeEventListener||r.off||r.removeListener;if(!e||!t)throw new TypeError("Emitter is not compatible");return{addListener:e.bind(r),removeListener:t.bind(r)}};function zM(r,e,t){let n,o=new Promise((i,s)=>{if(t={rejectionEvents:["error"],multiArgs:!1,rejectionMultiArgs:!1,resolveImmediately:!1,...t},!(t.count>=0&&(t.count===Number.POSITIVE_INFINITY||Number.isInteger(t.count))))throw new TypeError("The `count` option should be at least 0 or more");t.signal?.throwIfAborted();let a=[e].flat(),c=[],{addListener:l,removeListener:f}=WM(r),u=async(...h)=>{let m=t.multiArgs?h:h[0];if(t.filter)try{if(!await t.filter(m))return}catch(w){n(),s(w);return}c.push(m),t.count===c.length&&(n(),i(c))},d=(...h)=>{n(),s(t.rejectionMultiArgs?h:h[0])};n=()=>{for(let h of a)f(h,u);for(let h of t.rejectionEvents)a.includes(h)||f(h,d)};for(let h of a)l(h,u);for(let h of t.rejectionEvents)a.includes(h)||l(h,d);t.signal&&t.signal.addEventListener("abort",()=>{d(t.signal.reason)},{once:!0}),t.resolveImmediately&&i(c)});if(o.cancel=n,typeof t.timeout=="number"){let i=t8(o,{milliseconds:t.timeout});return i.cancel=()=>{n(),i.clear()},i}return o}function Qn(r,e,t){typeof t=="function"&&(t={filter:t}),t={...t,count:1,resolveImmediately:!1};let n=zM(r,e,t),o=n.then(i=>i[0]);return o.cancel=n.cancel,o}function ji(r,e){let t,n=function(){let o=function(){t=void 0,r()};clearTimeout(t),t=setTimeout(o,e)};return n.start=()=>{},n.stop=()=>{clearTimeout(t)},n}var Gm=class extends Error{remainingPoints;msBeforeNext;consumedPoints;isFirstInDuration;constructor(e="Rate limit exceeded",t){super(e),this.name="RateLimitError",this.remainingPoints=t.remainingPoints,this.msBeforeNext=t.msBeforeNext,this.consumedPoints=t.consumedPoints,this.isFirstInDuration=t.isFirstInDuration}},Xm=class extends Error{static name="QueueFullError";constructor(e="The queue was full"){super(e),this.name="QueueFullError"}},yc=class extends Error{static name="UnexpectedEOFError";name="UnexpectedEOFError"},Ym=class extends Error{static name="MaxEarlyStreamsError";name="MaxEarlyStreamsError"},Qm=class extends Error{static name="StreamClosedError";name="StreamClosedError"};function GM(r){return r.reason}async function ut(r,e,t){if(e==null)return r;let n=t?.translateError??GM;if(e.aborted)return r.catch(()=>{}),Promise.reject(n(e));let o;try{return await Promise.race([r,new Promise((i,s)=>{o=()=>{s(n(e))},e.addEventListener("abort",o)})])}finally{o!=null&&e.removeEventListener("abort",o)}}var Zm=class{deferred;signal;constructor(e){this.signal=e,this.deferred=Ve(),this.onAbort=this.onAbort.bind(this),this.signal?.addEventListener("abort",this.onAbort)}onAbort(){this.deferred.reject(this.signal?.reason??new Hr)}cleanup(){this.signal?.removeEventListener("abort",this.onAbort)}};function XM(){return`${parseInt(String(Math.random()*1e9),10).toString()}${Date.now()}`}var Jm=class{id;fn;options;recipients;status;timeline;controller;constructor(e,t){this.id=XM(),this.status="queued",this.fn=e,this.options=t,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,this.controller.signal,this.onAbort=this.onAbort.bind(this)}abort(e){this.controller.abort(e)}onAbort(){this.recipients.reduce((t,n)=>t&&n.signal?.aborted===!0,!0)&&(this.controller.abort(new Hr),this.cleanup())}async join(e={}){let t=new Zm(e.signal);return this.recipients.push(t),e.signal?.addEventListener("abort",this.onAbort),t.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();let e=await ut(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach(t=>{t.deferred.resolve(e)}),this.status="complete"}catch(e){this.recipients.forEach(t=>{t.deferred.reject(e)}),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach(e=>{e.cleanup(),e.signal?.removeEventListener("abort",this.onAbort)})}};var yr=class extends _e{concurrency;maxSize;queue;pending;sort;paused;constructor(e={}){super(),this.concurrency=e.concurrency??Number.POSITIVE_INFINITY,this.maxSize=e.maxSize??Number.POSITIVE_INFINITY,this.pending=0,this.paused=!1,e.metricName!=null&&e.metrics?.registerMetricGroup(e.metricName,{calculate:()=>({size:this.queue.length,running:this.pending,queued:this.queue.length-this.pending})}),this.sort=e.sort,this.queue=[],this.emitEmpty=ji(this.emitEmpty.bind(this),1),this.emitIdle=ji(this.emitIdle.bind(this),1)}emitEmpty(){this.size===0&&this.safeDispatchEvent("empty")}emitIdle(){this.running===0&&this.safeDispatchEvent("idle")}pause(){this.paused=!0}resume(){this.paused&&(this.paused=!1,this.tryToStartAnother())}tryToStartAnother(){if(this.paused)return!1;if(this.size===0)return this.emitEmpty(),this.running===0&&this.emitIdle(),!1;if(this.pending<this.concurrency){let e;for(let t of this.queue)if(t.status==="queued"){e=t;break}return e==null?!1:(this.safeDispatchEvent("active"),this.pending++,e.run().finally(()=>{for(let t=0;t<this.queue.length;t++)if(this.queue[t]===e){this.queue.splice(t,1);break}this.pending--,this.tryToStartAnother(),this.safeDispatchEvent("next")}),!0)}return!1}enqueue(e){this.queue.push(e),this.sort!=null&&this.queue.sort(this.sort)}async add(e,t){if(t?.signal?.throwIfAborted(),this.size===this.maxSize)throw new Xm;let n=new Jm(e,t);return this.enqueue(n),this.safeDispatchEvent("add"),this.tryToStartAnother(),n.join(t).then(o=>(this.safeDispatchEvent("completed",{detail:o}),this.safeDispatchEvent("success",{detail:{job:n,result:o}}),o)).catch(o=>{if(n.status==="queued"){for(let i=0;i<this.queue.length;i++)if(this.queue[i]===n){this.queue.splice(i,1);break}}throw this.safeDispatchEvent("failure",{detail:{job:n,error:o}}),o})}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach(e=>{e.abort(new Hr)}),this.clear()}async onEmpty(e){this.size!==0&&await Qn(this,"empty",e)}async onSizeLessThan(e,t){this.size<e||await Qn(this,"next",{...t,filter:()=>this.size<e})}async onIdle(e){this.pending===0&&this.size===0||await Qn(this,"idle",e)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(e){e?.signal?.throwIfAborted();let t=gr({objectMode:!0}),n=c=>{c!=null?this.abort():this.clear(),t.end(c)},o=c=>{c.detail!=null&&t.push(c.detail)},i=c=>{n(c.detail.error)},s=()=>{n()},a=()=>{n(new Hr("Queue aborted"))};this.addEventListener("completed",o),this.addEventListener("failure",i),this.addEventListener("idle",s),e?.signal?.addEventListener("abort",a);try{yield*t}finally{this.removeEventListener("completed",o),this.removeEventListener("failure",i),this.removeEventListener("idle",s),e?.signal?.removeEventListener("abort",a),n()}}};var YM=Math.pow(2,20)*4,Vs=class extends _e{status;timeline;inactivityTimeout;maxReadBufferLength;maxWriteBufferLength;log;direction;maxMessageSize;readStatus;writeStatus;remoteReadStatus;remoteWriteStatus;writableNeedsDrain;readBuffer;writeBuffer;sendingData;onDrainPromise;constructor(e){super(),this.status="open",this.log=e.log,this.direction=e.direction??"outbound",this.inactivityTimeout=e.inactivityTimeout??12e4,this.maxReadBufferLength=e.maxReadBufferLength??YM,this.maxWriteBufferLength=e.maxWriteBufferLength,this.maxMessageSize=e.maxMessageSize,this.readBuffer=new fe,this.writeBuffer=new fe,this.readStatus="readable",this.remoteReadStatus="readable",this.writeStatus="writable",this.remoteWriteStatus="writable",this.sendingData=!1,this.writableNeedsDrain=!1,this.timeline={open:Date.now()},this.processSendQueue=this.processSendQueue.bind(this);let t=()=>{this.writableNeedsDrain&&(this.log.trace("drain event received, continue sending data"),this.writableNeedsDrain=!1,this.processSendQueue()),this.onDrainPromise?.resolve()};this.addEventListener("drain",t);let n=o=>{this.onDrainPromise?.reject(o.error??new Qm)};this.addEventListener("close",n)}get readBufferLength(){return this.readBuffer.byteLength}get writeBufferLength(){return this.writeBuffer.byteLength}async onDrain(e){return this.writableNeedsDrain!==!0?Promise.resolve():(this.onDrainPromise==null&&(this.onDrainPromise=Promise.withResolvers()),ut(this.onDrainPromise.promise,e?.signal))}async*[Symbol.asyncIterator](){if(this.readStatus!=="readable"&&this.readStatus!=="paused")return;let e=gr(),t=i=>{e.push(i.data)};this.addEventListener("message",t);let n=i=>{e.end(i.error)};this.addEventListener("close",n);let o=()=>{e.end()};this.addEventListener("remoteCloseWrite",o);try{yield*e}finally{this.removeEventListener("message",t),this.removeEventListener("close",n),this.removeEventListener("remoteCloseWrite",o)}}isReadable(){return this.status==="open"}send(e){if(this.writeStatus==="closed"||this.writeStatus==="closing")throw new Go(`Cannot write to a stream that is ${this.writeStatus}`);return this.log.trace("append %d bytes to write buffer",e.byteLength),this.writeBuffer.append(e),this.processSendQueue()}abort(e){if(!(this.status==="aborted"||this.status==="reset"||this.status==="closed")){this.log.error("abort with error - %e",e),this.status="aborted",this.readBuffer.byteLength>0&&this.readBuffer.consume(this.readBuffer.byteLength),this.writeBuffer.byteLength>0&&(this.writeBuffer.consume(this.writeBuffer.byteLength),this.safeDispatchEvent("idle")),this.writeStatus="closed",this.remoteWriteStatus="closed",this.readStatus="closed",this.remoteReadStatus="closed",this.timeline.close=Date.now();try{this.sendReset(e)}catch(t){this.log("failed to send reset to remote - %e",t)}this.dispatchEvent(new im(e))}}pause(){if(this.readStatus==="closed"||this.readStatus==="closing")throw new Go("Cannot pause a stream that is closing/closed");this.readStatus!=="paused"&&(this.readStatus="paused",this.sendPause())}resume(){if(this.readStatus==="closed"||this.readStatus==="closing")throw new Go("Cannot resume a stream that is closing/closed");this.readStatus!=="readable"&&(this.readStatus="readable",this.dispatchReadBuffer(),this.sendResume())}push(e){if(this.readStatus==="closed"||this.readStatus==="closing")throw new Go(`Cannot push data onto a stream that is ${this.readStatus}`);if(e.byteLength!==0){if(this.readBuffer.append(e),this.readStatus==="paused"||this.listenerCount("message")===0){this.checkReadBufferLength();return}setTimeout(()=>{this.dispatchReadBuffer()},0)}}unshift(e){if(this.readStatus==="closed"||this.readStatus==="closing")throw new Go(`Cannot push data onto a stream that is ${this.readStatus}`);if(e.byteLength!==0){if(this.readBuffer.prepend(e),this.readStatus==="paused"||this.listenerCount("message")===0){this.checkReadBufferLength();return}setTimeout(()=>{this.dispatchReadBuffer()},0)}}onData(e){if(e.byteLength!==0){if(this.readStatus==="closing"||this.readStatus==="closed"){this.log("ignoring data - read status %s",this.readStatus);return}this.readBuffer.append(e),this.dispatchReadBuffer()}}addEventListener(...e){super.addEventListener.apply(this,e),e[0]==="message"&&this.readBuffer.byteLength>0&&queueMicrotask(()=>{this.dispatchReadBuffer()})}onRemoteReset(){this.log("remote reset"),this.status="reset",this.writeStatus="closed",this.remoteWriteStatus="closed",this.remoteReadStatus="closed",this.timeline.close=Date.now(),this.readBuffer.byteLength===0&&(this.readStatus="closed");let e=new Bl;this.dispatchEvent(new sm(e))}onTransportClosed(e){this.log("transport closed"),this.readStatus==="readable"&&this.readBuffer.byteLength===0&&(this.log("close readable end after transport closed and read buffer is empty"),this.readStatus="closed"),this.remoteReadStatus!=="closed"&&(this.remoteReadStatus="closed"),this.remoteWriteStatus!=="closed"&&(this.remoteWriteStatus="closed"),this.writeStatus!=="closed"&&(this.writeStatus="closed"),e!=null?this.abort(e):(this.status==="open"||this.status==="closing")&&(this.timeline.close=Date.now(),this.status="closed",this.writeStatus="closed",this.remoteWriteStatus="closed",this.remoteReadStatus="closed",this.dispatchEvent(new ks))}onRemoteCloseWrite(){this.remoteWriteStatus!=="closed"&&(this.log.trace("on remote close write"),this.remoteWriteStatus="closed",this.safeDispatchEvent("remoteCloseWrite"),this.writeStatus==="closed"&&this.onTransportClosed())}onRemoteCloseRead(){this.log.trace("on remote close read"),this.remoteReadStatus="closed",this.writeBuffer.byteLength>0&&(this.writeBuffer.consume(this.writeBuffer.byteLength),this.safeDispatchEvent("idle"))}processSendQueue(){if(this.writableNeedsDrain)return this.log.trace("not processing send queue as drain is required"),this.checkWriteBufferLength(),!1;if(this.writeBuffer.byteLength===0)return this.log.trace("not processing send queue as no bytes to send"),!0;if(this.sendingData)return this.log.trace("not processing send queue as already sending data"),!0;this.sendingData=!0,this.log.trace("processing send queue with %d queued bytes",this.writeBuffer.byteLength);try{let e=!0,t=this.writeBuffer.byteLength,n=0;for(;this.writeBuffer.byteLength>0;){let o=Math.min(this.maxMessageSize??this.writeBuffer.byteLength,this.writeBuffer.byteLength);if(o===0){e=!1;break}let i=this.writeBuffer.sublist(0,o),s=new fe(i);this.writeBuffer.consume(i.byteLength);let a=this.sendData(i);if(e=a.canSendMore,n+=a.sentBytes,a.sentBytes!==s.byteLength&&(s.consume(a.sentBytes),this.writeBuffer.prepend(s)),!e)break}return e||(this.log.trace("sent %d/%d bytes, pausing sending because underlying stream is full, %d bytes left in the write buffer",n,t,this.writeBuffer.byteLength),this.writableNeedsDrain=!0,this.checkWriteBufferLength()),this.writeBuffer.byteLength===0&&this.safeDispatchEvent("idle"),e}finally{this.sendingData=!1}}dispatchReadBuffer(){try{if(this.listenerCount("message")===0){this.log.trace("not dispatching pause buffer as there are no listeners for the message event");return}if(this.readBuffer.byteLength===0){this.log.trace("not dispatching pause buffer as there is no data to dispatch");return}if(this.readStatus==="paused"){this.log.trace("not dispatching pause buffer we are paused");return}if(this.readStatus==="closing"||this.readStatus==="closed"){this.log("dropping %d bytes because the readable end is %s",this.readBuffer.byteLength,this.readStatus),this.readBuffer.consume(this.readBuffer.byteLength);return}let e=this.readBuffer.sublist();this.readBuffer.consume(e.byteLength),this.dispatchEvent(new om(e))}finally{this.readBuffer.byteLength===0&&this.remoteWriteStatus==="closed"&&(this.log("close readable end after dispatching read buffer and remote writable end is closed"),this.readStatus="closed"),this.checkReadBufferLength()}}checkReadBufferLength(){this.readBuffer.byteLength>this.maxReadBufferLength&&this.abort(new sd(`Read buffer length of ${this.readBuffer.byteLength} exceeded limit of ${this.maxReadBufferLength}, read status is ${this.readStatus}`))}checkWriteBufferLength(){this.maxWriteBufferLength!=null&&this.writeBuffer.byteLength>this.maxWriteBufferLength&&this.abort(new sd(`Write buffer length of ${this.writeBuffer.byteLength} exceeded limit of ${this.maxWriteBufferLength}, write status is ${this.writeStatus}`))}onMuxerNeedsDrain(){this.writableNeedsDrain=!0}onMuxerDrain(){this.safeDispatchEvent("drain")}};var Hs=class extends Vs{remoteAddr;metricPrefix;metrics;constructor(e){super(e),this.metricPrefix=e.metricPrefix??"",this.metrics=e.metrics,this.remoteAddr=e.remoteAddr,this.addEventListener("close",t=>{this.metrics?.increment({[`${this.metricPrefix}end`]:!0}),t.error!=null?t.local?this.metrics?.increment({[`${this.metricPrefix}abort`]:!0}):this.metrics?.increment({[`${this.metricPrefix}reset`]:!0}):t.local?this.metrics?.increment({[`${this.metricPrefix}_local_close`]:!0}):this.metrics?.increment({[`${this.metricPrefix}_remote_close`]:!0})})}async close(e){this.status==="open"&&(this.status="closing",this.writeStatus="closing",this.remoteWriteStatus="closing",this.remoteReadStatus="closing",(this.sendingData||this.writeBuffer.byteLength>0)&&(this.log("waiting for write queue to become idle before closing writable end of stream, %d unsent bytes",this.writeBuffer.byteLength),await Qn(this,"idle",{...e,rejectionEvents:["close"]})),this.writableNeedsDrain&&(this.log("waiting for write queue to drain before closing writable end of stream, %d unsent bytes",this.writeBuffer.byteLength),await Qn(this,"drain",{...e,rejectionEvents:["close"]})),await this.sendClose(e),this.onTransportClosed())}};function e0(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}var qs=class extends _e{streams;protocol;status;log;maConn;streamOptions;earlyStreams;maxEarlyStreams;metrics;constructor(e,t){super(),this.maConn=e,this.protocol=t.protocol,this.streams=[],this.earlyStreams=[],this.status="open",this.log=e.log.newScope(t.name),this.streamOptions=t.streamOptions,this.maxEarlyStreams=t.maxEarlyStreams??10,this.metrics=t.metrics;let n=s=>{try{this.onData(s.data)}catch(a){this.abort(a),this.maConn.abort(a)}};this.maConn.addEventListener("message",n);let o=()=>{this.log("underlying stream drained, signal %d streams to continue writing",this.streams.length),this.streams.forEach(s=>{s.onMuxerDrain()})};this.maConn.addEventListener("drain",o);let i=()=>{this.log("underlying stream closed with status %s and %d streams",this.status,this.streams.length),this.onTransportClosed()};this.maConn.addEventListener("close",i)}send(e){let t=this.maConn.send(e);return t===!1&&(this.log("underlying stream saturated, signal %d streams to pause writing",this.streams.length),this.streams.forEach(n=>{n.onMuxerNeedsDrain()})),t}async close(e){this.status==="closed"||this.status==="closing"||(this.status="closing",await ut(Promise.all([...this.streams].map(async t=>{await t.close(e)})),e?.signal),this.status="closed")}abort(e){this.status!=="closed"&&(this.status="closing",[...this.streams].forEach(t=>{t.abort(e)}),this.status="closed")}onTransportClosed(e){this.status="closing";try{[...this.streams].forEach(t=>{t.onTransportClosed(e)})}catch(t){this.abort(t)}this.status="closed"}async createStream(e){if(this.status!=="open")throw new yo;let t=this.onCreateStream({...this.streamOptions,...e});return e0(t)&&(t=await t),this.streams.push(t),this.cleanUpStream(t),t}onRemoteStream(e){if(this.streams.push(e),this.cleanUpStream(e),this.listenerCount("stream")===0){this.earlyStreams.push(e),this.earlyStreams.length>this.maxEarlyStreams&&this.abort(new Ym(`Too many early streams were opened - ${this.earlyStreams.length}/${this.maxEarlyStreams}`));return}this.safeDispatchEvent("stream",{detail:e})}cleanUpStream(e){let t=n=>{let o=this.streams.findIndex(i=>i===e);o!==-1&&this.streams.splice(o,1),n.error!=null?n.local?this.metrics?.increment({[`${e.direction}_stream_reset`]:!0}):this.metrics?.increment({[`${e.direction}_stream_abort`]:!0}):this.metrics?.increment({[`${e.direction}_stream_end`]:!0})};e.addEventListener("close",t),this.metrics?.increment({[`${e.direction}_stream`]:!0})}addEventListener(...e){super.addEventListener.apply(this,e),e[0]==="stream"&&this.earlyStreams.length>0&&queueMicrotask(()=>{this.earlyStreams.forEach(t=>{this.safeDispatchEvent("stream",{detail:t})}),this.earlyStreams=[]})}};var Ws=class extends Vs{id;protocol;constructor(e){super(e),this.id=e.id,this.protocol=e.protocol??""}async close(e){this.writeStatus==="closing"||this.writeStatus==="closed"||(this.writeStatus="closing",(this.sendingData||this.writeBuffer.byteLength>0)&&(this.log("waiting for write queue to become idle before closing writable end of stream, %d unsent bytes",this.writeBuffer.byteLength),await Qn(this,"idle",{...e,rejectionEvents:["close"]})),this.writableNeedsDrain&&(this.log("waiting for write queue to drain before closing writable end of stream, %d unsent bytes, sending %s",this.writeBuffer.byteLength,this.sendingData),await Qn(this,"drain",{...e,rejectionEvents:["close"]}),this.log("write queue drained, closing writable end of stream, %d unsent bytes, sending %s",this.writeBuffer.byteLength,this.sendingData)),await this.sendCloseWrite(e),this.writeStatus="closed",this.log("closed writable end gracefully"),this.remoteWriteStatus==="closed"&&this.onTransportClosed())}async closeRead(e){this.readStatus==="closing"||this.readStatus==="closed"||(this.readBuffer.byteLength>0&&this.readBuffer.consume(this.readBuffer.byteLength),this.readStatus="closing",await this.sendCloseRead(e),this.readStatus="closed",this.log("closed readable end gracefully"))}};function De(r){let e=new globalThis.AbortController;function t(){e.abort();for(let i of r)i?.removeEventListener!=null&&i.removeEventListener("abort",t)}for(let i of r){if(i?.aborted===!0){t();break}i?.addEventListener!=null&&i.addEventListener("abort",t)}function n(){for(let i of r)i?.removeEventListener!=null&&i.removeEventListener("abort",t)}let o=e.signal;return o.clear=n,o}var mu=class{movingAverage;variance;deviation;forecast;timeSpan;previousTime;constructor(e){this.timeSpan=e,this.movingAverage=0,this.variance=0,this.deviation=0,this.forecast=0}alpha(e,t){return 1-Math.exp(-(e-t)/this.timeSpan)}push(e,t=Date.now()){if(this.previousTime!=null){let n=this.alpha(t,this.previousTime),o=e-this.movingAverage,i=n*o;this.movingAverage=n*e+(1-n)*this.movingAverage,this.variance=(1-n)*(this.variance+o*i),this.deviation=Math.sqrt(this.variance),this.forecast=this.movingAverage+n*o}else this.movingAverage=e;this.previousTime=t}};var QM=1.2,ZM=2,JM=5e3,eU=6e4,tU=5e3,To=class{success;failure;next;metric;timeoutMultiplier;failureMultiplier;minTimeout;maxTimeout;constructor(e={}){let t=e.interval??tU;this.success=new mu(t),this.failure=new mu(t),this.next=new mu(t),this.failureMultiplier=e.failureMultiplier??ZM,this.timeoutMultiplier=e.timeoutMultiplier??QM,this.minTimeout=e.minTimeout??JM,this.maxTimeout=e.maxTimeout??eU,e.metricName!=null&&(this.metric=e.metrics?.registerMetricGroup(e.metricName))}getTimeoutSignal(e={}){let t=Math.round(this.next.movingAverage*(e.timeoutFactor??this.timeoutMultiplier));t<this.minTimeout&&(t=this.minTimeout),t>this.maxTimeout&&(t=this.maxTimeout);let n=AbortSignal.timeout(t),o=De([e.signal,n]);return o.start=Date.now(),o.timeout=t,o}cleanUp(e){let t=Date.now()-e.start;e.aborted?(this.failure.push(t),this.next.push(t*this.failureMultiplier),this.metric?.update({failureMovingAverage:this.failure.movingAverage,failureDeviation:this.failure.deviation,failureForecast:this.failure.forecast,failureVariance:this.failure.variance,failure:t})):(this.success.push(t),this.next.push(t),this.metric?.update({successMovingAverage:this.success.movingAverage,successDeviation:this.success.deviation,successForecast:this.success.forecast,successVariance:this.success.variance,success:t}))}};var wr=class extends Error{static name="InvalidMultiaddrError";name="InvalidMultiaddrError"},Ki=class extends Error{static name="ValidationError";name="ValidationError"},t0=class extends Error{static name="InvalidParametersError";name="InvalidParametersError"},r0=class extends Error{static name="UnknownProtocolError";name="UnknownProtocolError"};function n8(r){return e=>j(e,r)}function o8(r){return e=>B(e,r)}function gu(r){return new DataView(r.buffer).getUint16(r.byteOffset).toString()}function wc(r){let e=new ArrayBuffer(2);return new DataView(e).setUint16(0,typeof r=="string"?parseInt(r):r),new Uint8Array(e)}function FS(r){let e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==16)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion address.`);let t=B(e[0],"base32"),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");let o=wc(n);return gt([t,o],t.length+o.length)}function $S(r){let e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==56)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion3 address.`);let t=ir.decode(`b${e[0]}`),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");let o=wc(n);return gt([t,o],t.length+o.length)}function i8(r){let e=r.subarray(0,r.length-2),t=r.subarray(r.length-2),n=j(e,"base32"),o=gu(t);return`${n}:${o}`}var s8=function(r){r=r.toString().trim();let e=new Uint8Array(4);return r.split(/\./g).forEach((t,n)=>{let o=parseInt(t,10);if(isNaN(o)||o<0||o>255)throw new wr("Invalid byte value in IP address");e[n]=o}),e},jS=function(r){let e=0;r=r.toString().trim();let t=r.split(":",8),n;for(n=0;n<t.length;n++){let i=Ao(t[n]),s;i&&(s=s8(t[n]),t[n]=j(s.subarray(0,2),"base16")),s!=null&&++n<8&&t.splice(n,0,j(s.subarray(2,4),"base16"))}if(t[0]==="")for(;t.length<8;)t.unshift("0");else if(t[t.length-1]==="")for(;t.length<8;)t.push("0");else if(t.length<8){for(n=0;n<t.length&&t[n]!=="";n++);let i=[n,1];for(n=9-t.length;n>0;n--)i.push("0");t.splice.apply(t,i)}let o=new Uint8Array(e+16);for(n=0;n<t.length;n++){t[n]===""&&(t[n]="0");let i=parseInt(t[n],16);if(isNaN(i)||i<0||i>65535)throw new wr("Invalid byte value in IP address");o[e++]=i>>8&255,o[e++]=i&255}return o},KS=function(r){if(r.byteLength!==4)throw new wr("IPv4 address was incorrect length");let e=[];for(let t=0;t<r.byteLength;t++)e.push(r[t]);return e.join(".")},VS=function(r){if(r.byteLength!==16)throw new wr("IPv6 address was incorrect length");let e=[];for(let n=0;n<r.byteLength;n+=2){let o=r[n],i=r[n+1],s=`${o.toString(16).padStart(2,"0")}${i.toString(16).padStart(2,"0")}`;e.push(s)}let t=e.join(":");try{let n=new URL(`http://[${t}]`);return n.hostname.substring(1,n.hostname.length-1)}catch{throw new wr(`Invalid IPv6 address "${t}"`)}};function HS(r){try{let e=new URL(`http://[${r}]`);return e.hostname.substring(1,e.hostname.length-1)}catch{throw new wr(`Invalid IPv6 address "${r}"`)}}var r8=Object.values(Ya).map(r=>r.decoder),rU=(function(){let r=r8[0].or(r8[1]);return r8.slice(2).forEach(e=>r=r.or(e)),r})();function qS(r){return rU.decode(r)}function WS(r){return e=>r.encoder.encode(e)}function nU(r){if(parseInt(r).toString()!==r)throw new Ki("Value must be an integer")}function oU(r){if(r<0)throw new Ki("Value must be a positive integer, or zero")}function iU(r){return e=>{if(e>r)throw new Ki(`Value must be smaller than or equal to ${r}`)}}function sU(...r){return e=>{for(let t of r)t(e)}}var Gd=sU(nU,oU,iU(65535));var lr=-1,a8=class{protocolsByCode=new Map;protocolsByName=new Map;getProtocol(e){let t;if(typeof e=="string"?t=this.protocolsByName.get(e):t=this.protocolsByCode.get(e),t==null)throw new r0(`Protocol ${e} was unknown`);return t}addProtocol(e){this.protocolsByCode.set(e.code,e),this.protocolsByName.set(e.name,e),e.aliases?.forEach(t=>{this.protocolsByName.set(t,e)})}removeProtocol(e){let t=this.protocolsByCode.get(e);t!=null&&(this.protocolsByCode.delete(t.code),this.protocolsByName.delete(t.name),t.aliases?.forEach(n=>{this.protocolsByName.delete(n)}))}},qi=new a8,xU=[{code:4,name:"ip4",size:32,valueToBytes:s8,bytesToValue:KS,validate:r=>{if(!Ao(r))throw new Ki(`Invalid IPv4 address "${r}"`)}},{code:6,name:"tcp",size:16,valueToBytes:wc,bytesToValue:gu,validate:Gd},{code:273,name:"udp",size:16,valueToBytes:wc,bytesToValue:gu,validate:Gd},{code:33,name:"dccp",size:16,valueToBytes:wc,bytesToValue:gu,validate:Gd},{code:41,name:"ip6",size:128,valueToBytes:jS,bytesToValue:VS,stringToValue:HS,validate:r=>{if(!Wm(r))throw new Ki(`Invalid IPv6 address "${r}"`)}},{code:42,name:"ip6zone",size:lr},{code:43,name:"ipcidr",size:8,bytesToValue:n8("base10"),valueToBytes:o8("base10")},{code:53,name:"dns",size:lr},{code:54,name:"dns4",size:lr},{code:55,name:"dns6",size:lr},{code:56,name:"dnsaddr",size:lr},{code:132,name:"sctp",size:16,valueToBytes:wc,bytesToValue:gu,validate:Gd},{code:301,name:"udt"},{code:302,name:"utp"},{code:400,name:"unix",size:lr,stringToValue:r=>decodeURIComponent(r),valueToString:r=>encodeURIComponent(r)},{code:421,name:"p2p",aliases:["ipfs"],size:lr,bytesToValue:n8("base58btc"),valueToBytes:r=>r.startsWith("Q")||r.startsWith("1")?o8("base58btc")(r):he.parse(r).multihash.bytes},{code:444,name:"onion",size:96,bytesToValue:i8,valueToBytes:FS},{code:445,name:"onion3",size:296,bytesToValue:i8,valueToBytes:$S},{code:446,name:"garlic64",size:lr},{code:447,name:"garlic32",size:lr},{code:448,name:"tls"},{code:449,name:"sni",size:lr},{code:454,name:"noise"},{code:460,name:"quic"},{code:461,name:"quic-v1"},{code:465,name:"webtransport"},{code:466,name:"certhash",size:lr,bytesToValue:WS(qa),valueToBytes:qS},{code:480,name:"http"},{code:481,name:"http-path",size:lr,stringToValue:r=>`/${decodeURIComponent(r)}`,valueToString:r=>encodeURIComponent(r.substring(1))},{code:443,name:"https"},{code:477,name:"ws"},{code:478,name:"wss"},{code:479,name:"p2p-websocket-star"},{code:277,name:"p2p-stardust"},{code:275,name:"p2p-webrtc-star"},{code:276,name:"p2p-webrtc-direct"},{code:280,name:"webrtc-direct"},{code:281,name:"webrtc"},{code:290,name:"p2p-circuit"},{code:777,name:"memory",size:lr}];xU.forEach(r=>{qi.addProtocol(r)});function zS(r){let e=[],t=0;for(;t<r.length;){let n=Cn(r,t),o=qi.getProtocol(n),i=je(n),s=EU(o,r,t+i),a=0;s>0&&o.size===lr&&(a=je(s));let c=i+a+s,l={code:n,name:o.name,bytes:r.subarray(t,t+c)};if(s>0){let f=t+i+a,u=r.subarray(f,f+s);l.value=o.bytesToValue?.(u)??j(u)}e.push(l),t+=c}return e}function GS(r){let e=0,t=[];for(let n of r){if(n.bytes==null){let o=qi.getProtocol(n.code),i=je(n.code),s,a=0,c=0;n.value!=null&&(s=o.valueToBytes?.(n.value)??B(n.value),a=s.byteLength,o.size===lr&&(c=je(a)));let l=new Uint8Array(i+c+a),f=0;su(n.code,l,f),f+=i,s!=null&&(o.size===lr&&(su(a,l,f),f+=c),l.set(s,f)),n.bytes=l}t.push(n.bytes),e+=n.bytes.byteLength}return gt(t,e)}function XS(r){if(r.charAt(0)!=="/")throw new wr('String multiaddr must start with "/"');let e=[],t="protocol",n="",o="";for(let i=1;i<r.length;i++){let s=r.charAt(i);s!=="/"&&(t==="protocol"?o+=r.charAt(i):n+=r.charAt(i));let a=i===r.length-1;if(s==="/"||a){let c=qi.getProtocol(o);if(t==="protocol"){if(c.size==null||c.size===0){e.push({code:c.code,name:c.name}),n="",o="",t="protocol";continue}else if(a)throw new wr(`Component ${o} was missing value`);t="value"}else if(t==="value"){let l={code:c.code,name:c.name};if(c.size!=null&&c.size!==0){if(n==="")throw new wr(`Component ${o} was missing value`);l.value=c.stringToValue?.(n)??n}e.push(l),n="",o="",t="protocol"}}}if(o!==""&&n!=="")throw new wr("Incomplete multiaddr");return e}function YS(r){return`/${r.flatMap(e=>{if(e.value==null)return e.name;let t=qi.getProtocol(e.code);if(t==null)throw new wr(`Unknown protocol code ${e.code}`);return[e.name,t.valueToString?.(e.value)??e.value]}).join("/")}`}function EU(r,e,t){return r.size==null||r.size===0?0:r.size>0?r.size/8:Cn(e,t)}var SU=Symbol.for("nodejs.util.inspect.custom"),g8=Symbol.for("@multiformats/multiaddr");function _U(r){if(r==null&&(r="/"),oi(r))return r.getComponents();if(r instanceof Uint8Array)return zS(r);if(typeof r=="string")return r=r.replace(/\/(\/)+/,"/").replace(/(\/)+$/,""),r===""&&(r="/"),XS(r);if(Array.isArray(r))return r;throw new wr("Must be a string, Uint8Array, Component[], or another Multiaddr")}var s0=class r{[g8]=!0;#e;#t;#r;constructor(e="/",t={}){this.#e=_U(e),t.validate!==!1&&AU(this)}get bytes(){return this.#r==null&&(this.#r=GS(this.#e)),this.#r}toString(){return this.#t==null&&(this.#t=YS(this.#e)),this.#t}toJSON(){return this.toString()}getComponents(){return[...this.#e.map(e=>({...e}))]}encapsulate(e){let t=new r(e);return new r([...this.#e,...t.getComponents()],{validate:!1})}decapsulate(e){let t=e.toString(),n=this.toString(),o=n.lastIndexOf(t);if(o<0)throw new t0(`Address ${this.toString()} does not contain subaddress: ${t}`);return new r(n.slice(0,o),{validate:!1})}decapsulateCode(e){let t;for(let n=this.#e.length-1;n>-1;n--)if(this.#e[n].code===e){t=n;break}return new r(this.#e.slice(0,t),{validate:!1})}equals(e){return we(this.bytes,e.bytes)}[SU](){return`Multiaddr(${this.toString()})`}};function AU(r){r.getComponents().forEach(e=>{let t=qi.getProtocol(e.code);e.value!=null&&t.validate?.(e.value)})}function oi(r){return!!r?.[g8]}function ie(r){return new s0(r)}var y8=class{readNext;haveNext;ended;nextResult;error;constructor(){this.ended=!1,this.readNext=Ve(),this.haveNext=Ve()}[Symbol.asyncIterator](){return this}async next(){if(this.nextResult==null&&await this.haveNext.promise,this.nextResult==null)throw new Error("HaveNext promise resolved but nextResult was undefined");let e=this.nextResult;return this.nextResult=void 0,this.readNext.resolve(),this.readNext=Ve(),e}async throw(e){return this.ended=!0,this.error=e,e!=null&&(this.haveNext.promise.catch(()=>{}),this.haveNext.reject(e)),{done:!0,value:void 0}}async return(){let e={done:!0,value:void 0};return this.ended=!0,this.nextResult=e,this.haveNext.resolve(),e}async push(e,t){await this._push(e,t)}async end(e,t){e!=null?await this.throw(e):await this._push(void 0,t)}async _push(e,t){if(e!=null&&this.ended)throw this.error??new Error("Cannot push value onto an ended pushable");for(;this.nextResult!=null;)await this.readNext.promise;e!=null?this.nextResult={done:!1,value:e}:(this.ended=!0,this.nextResult={done:!0,value:void 0}),this.haveNext.resolve(),this.haveNext=Ve(),await ut(this.readNext.promise,t?.signal,t)}};function QS(){return new y8}function TU(r){return r[Symbol.asyncIterator]!=null}async function IU(r,e,t){try{await Promise.all(r.map(async n=>{for await(let o of n)await e.push(o,{signal:t}),t.throwIfAborted()})),await e.end(void 0,{signal:t})}catch(n){await e.end(n,{signal:t}).catch(()=>{})}}async function*CU(r){let e=new AbortController,t=QS();IU(r,t,e.signal).catch(()=>{});try{yield*t}finally{e.abort()}}function*PU(r){for(let e of r)yield*e}function kU(...r){let e=[];for(let t of r)TU(t)||e.push(t);return e.length===r.length?PU(e):CU(r)}var Yr=kU;function vu(r,...e){if(r==null)throw new Error("Empty pipeline");if(w8(r)){let n=r;r=()=>n.source}else if(JS(r)||ZS(r)){let n=r;r=()=>n}let t=[r,...e];if(t.length>1&&w8(t[t.length-1])&&(t[t.length-1]=t[t.length-1].sink),t.length>2)for(let n=1;n<t.length-1;n++)w8(t[n])&&(t[n]=RU(t[n]));return OU(...t)}var OU=(...r)=>{let e;for(;r.length>0;)e=r.shift()(e);return e},ZS=r=>r?.[Symbol.asyncIterator]!=null,JS=r=>r?.[Symbol.iterator]!=null,w8=r=>r==null?!1:r.sink!=null&&r.source!=null,RU=r=>e=>{let t=r.sink(e);if(t?.then!=null){let n=gr({objectMode:!0});t.then(()=>{n.end()},s=>{n.end(s)});let o,i=r.source;if(ZS(i))o=async function*(){yield*i,n.end()};else if(JS(i))o=function*(){yield*i,n.end()};else throw new Error("Unknown duplex source type - must be Iterable or AsyncIterable");return Yr(n,o())}return r.source};var DU=4194304,a0=class extends Error{static name="UnwrappedError";name="UnwrappedError"},eh=class extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MSG_LENGTH"},v8=class extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"},x8=class extends Error{name="InvalidDataLengthLengthError";code="ERR_MSG_LENGTH_TOO_LONG"};function NU(r){return typeof r?.closeRead=="function"}function LU(r){return typeof r?.close=="function"}function b8(r){return NU(r)?r.remoteWriteStatus!=="writable"&&r.readBufferLength===0:LU(r)?r.status!=="open":!1}function BU(r){return r?.addEventListener!=null&&r?.removeEventListener!=null&&r?.send!=null&&r?.push!=null&&r?.log!=null}function c0(r,e){let t=e?.maxBufferSize??DU,n=new fe,o,i=!1;if(!BU(r))throw new P("Argument should be a Stream or a Multiaddr");let s=f=>{if(n.append(f.data),n.byteLength>t){let u=n.byteLength;n.consume(n.byteLength),o?.reject(new Error(`Read buffer overflow - ${u} > ${t}`))}o?.resolve()};r.addEventListener("message",s);let a=f=>{f.error!=null?o?.reject(f.error):o?.resolve()};r.addEventListener("close",a);let c=()=>{o?.resolve()};r.addEventListener("remoteCloseWrite",c);let l={readBuffer:n,async read(f){if(i===!0)throw new a0("Stream was unwrapped");if(b8(r)){if(f?.bytes==null)return null;if(n.byteLength<f.bytes)throw r.log.error("closed after reading %d/%d bytes",n.byteLength,f.bytes),new yc(`Unexpected EOF - stream closed after reading ${n.byteLength}/${f.bytes} bytes`)}let u=f?.bytes??1;for(o=Promise.withResolvers();;){if(n.byteLength>=u){o.resolve();break}if(await ut(o.promise,f?.signal),b8(r)){if(n.byteLength===0&&f?.bytes==null)return null;break}o=Promise.withResolvers()}let d=f?.bytes??n.byteLength;if(n.byteLength<d){if(b8(r))throw r.log.error("closed while reading %d/%d bytes",n.byteLength,d),new yc(`Unexpected EOF - stream closed while reading ${n.byteLength}/${d} bytes`);return l.read(f)}let h=n.sublist(0,d);return n.consume(d),h},async write(f,u){if(i===!0)throw new a0("Stream was unwrapped");r.send(f)||await Qn(r,"drain",{signal:u?.signal,rejectionEvents:["close"]})},unwrap(){return i||(i=!0,r.removeEventListener("message",s),r.removeEventListener("close",a),r.removeEventListener("remoteCloseWrite",c),n.byteLength>0&&(r.log("stream unwrapped with %d unread bytes",n.byteLength),r.push(n))),r}};return l}function Gs(r,e={}){let t=c0(r,e);e.maxDataLength!=null&&e.maxLengthLength==null&&(e.maxLengthLength=je(e.maxDataLength));let n=e?.lengthDecoder??Cn,o=e?.lengthEncoder??Mr;return{async read(s){let a=-1,c=new fe;for(;;){let f=await t.read({...s,bytes:1});if(f==null)break;c.append(f);try{a=n(c)}catch(u){if(u instanceof RangeError)continue;throw u}if(a<0)throw new eh("Invalid message length");if(e?.maxLengthLength!=null&&c.byteLength>e.maxLengthLength)throw new x8(`Message length length too long - ${c.byteLength} > ${e.maxLengthLength}`);if(a>-1)break}if(e?.maxDataLength!=null&&a>e.maxDataLength)throw new v8(`Message length too long - ${a} > ${e.maxDataLength}`);let l=await t.read({...s,bytes:a});if(l==null)throw r.log.error("tried to read %d bytes but the stream closed",a),new yc(`Unexpected EOF - tried to read ${a} bytes but the stream closed`);if(l.byteLength!==a)throw r.log.error("read %d/%d bytes before the stream closed",l.byteLength,a),new yc(`Unexpected EOF - read ${l.byteLength}/${a} bytes before the stream closed`);return l},async write(s,a){await t.write(new fe(o(s.byteLength),s),a)},async writeV(s,a){let c=new fe(...s.flatMap(l=>[o(l.byteLength),l]));await t.write(c,a)},unwrap(){return t.unwrap()}}}function bt(r,e){let t=Gs(r,e),n={read:async(o,i)=>{let s=await t.read(i);return o.decode(s)},write:async(o,i,s)=>{await t.write(i.encode(o),s)},writeV:async(o,i,s)=>{await t.writeV(o.map(a=>i.encode(a)),s)},pb:o=>({read:async i=>n.read(o,i),write:async(i,s)=>n.write(i,o,s),writeV:async(i,s)=>n.writeV(i,o,s),unwrap:()=>n}),unwrap:()=>t.unwrap()};return n}var MU=1024*1024*4,UU=1024*1024*4,l0=class{buffer;maxBufferSize;lengthDecoder;maxDataLength;encodingLength;constructor(e={}){this.buffer=new fe,this.maxBufferSize=e.maxBufferSize??MU,this.maxDataLength=e.maxDataLength??UU,this.lengthDecoder=e.lengthDecoder??Cn,this.encodingLength=e.encodingLength??je}*decode(e){if(this.buffer.append(e),this.buffer.byteLength>this.maxBufferSize)throw new P(`Buffer length limit exceeded - ${this.buffer.byteLength}/${this.maxBufferSize}`);for(;;){let t;try{t=this.lengthDecoder(this.buffer)}catch(i){if(i instanceof RangeError)break;throw i}if(t<0||t>this.maxDataLength)throw new eh("Invalid message length");let n=this.encodingLength(t),o=n+t;if(this.buffer.byteLength>=o){let i=this.buffer.sublist(n,o);this.buffer.consume(o),i.byteLength>0&&(yield i)}else break}}};var FU=["string","number","bigint","symbol"],$U=["Function","Generator","AsyncGenerator","GeneratorFunction","AsyncGeneratorFunction","AsyncFunction","Observable","Array","Buffer","Object","RegExp","Date","Error","Map","Set","WeakMap","WeakSet","ArrayBuffer","SharedArrayBuffer","DataView","Promise","URL","HTMLElement","Int8Array","Uint8Array","Uint8ClampedArray","Int16Array","Uint16Array","Int32Array","Uint32Array","Float32Array","Float64Array","BigInt64Array","BigUint64Array"];function e_(r){if(r===null)return"null";if(r===void 0)return"undefined";if(r===!0||r===!1)return"boolean";let e=typeof r;if(FU.includes(e))return e;if(e==="function")return"Function";if(Array.isArray(r))return"Array";if(jU(r))return"Buffer";let t=KU(r);return t||"Object"}function jU(r){return r&&r.constructor&&r.constructor.isBuffer&&r.constructor.isBuffer.call(null,r)}function KU(r){let e=Object.prototype.toString.call(r).slice(8,-1);if($U.includes(e))return e}var v=class{constructor(e,t,n){this.major=e,this.majorEncoded=e<<5,this.name=t,this.terminal=n}toString(){return`Type[${this.major}].${this.name}`}compare(e){return this.major<e.major?-1:this.major>e.major?1:0}};v.uint=new v(0,"uint",!0);v.negint=new v(1,"negint",!0);v.bytes=new v(2,"bytes",!0);v.string=new v(3,"string",!0);v.array=new v(4,"array",!1);v.map=new v(5,"map",!1);v.tag=new v(6,"tag",!1);v.float=new v(7,"float",!0);v.false=new v(7,"false",!0);v.true=new v(7,"true",!0);v.null=new v(7,"null",!0);v.undefined=new v(7,"undefined",!0);v.break=new v(7,"break",!0);var W=class{constructor(e,t,n){this.type=e,this.value=t,this.encodedLength=n,this.encodedBytes=void 0,this.byteValue=void 0}toString(){return`Token[${this.type}].${this.value}`}};var xu=globalThis.process&&!globalThis.process.browser&&globalThis.Buffer&&typeof globalThis.Buffer.isBuffer=="function",VU=new TextDecoder,HU=new TextEncoder;function u0(r){return xu&&globalThis.Buffer.isBuffer(r)}function th(r){return r instanceof Uint8Array?u0(r)?new Uint8Array(r.buffer,r.byteOffset,r.byteLength):r:Uint8Array.from(r)}var o_=xu?(r,e,t)=>t-e>64?globalThis.Buffer.from(r.subarray(e,t)).toString("utf8"):r_(r,e,t):(r,e,t)=>t-e>64?VU.decode(r.subarray(e,t)):r_(r,e,t),f0=xu?r=>r.length>64?globalThis.Buffer.from(r):t_(r):r=>r.length>64?HU.encode(r):t_(r),ii=r=>Uint8Array.from(r),Eu=xu?(r,e,t)=>u0(r)?new Uint8Array(r.subarray(e,t)):r.slice(e,t):(r,e,t)=>r.slice(e,t),i_=xu?(r,e)=>(r=r.map(t=>t instanceof Uint8Array?t:globalThis.Buffer.from(t)),th(globalThis.Buffer.concat(r,e))):(r,e)=>{let t=new Uint8Array(e),n=0;for(let o of r)n+o.length>t.length&&(o=o.subarray(0,t.length-n)),t.set(o,n),n+=o.length;return t},s_=xu?r=>globalThis.Buffer.allocUnsafe(r):r=>new Uint8Array(r);function d0(r,e){if(u0(r)&&u0(e))return r.compare(e);for(let t=0;t<r.length;t++)if(r[t]!==e[t])return r[t]<e[t]?-1:1;return 0}function t_(r){let e=[],t=0;for(let n=0;n<r.length;n++){let o=r.charCodeAt(n);o<128?e[t++]=o:o<2048?(e[t++]=o>>6|192,e[t++]=o&63|128):(o&64512)===55296&&n+1<r.length&&(r.charCodeAt(n+1)&64512)===56320?(o=65536+((o&1023)<<10)+(r.charCodeAt(++n)&1023),e[t++]=o>>18|240,e[t++]=o>>12&63|128,e[t++]=o>>6&63|128,e[t++]=o&63|128):(e[t++]=o>>12|224,e[t++]=o>>6&63|128,e[t++]=o&63|128)}return e}function r_(r,e,t){let n=[];for(;e<t;){let o=r[e],i=null,s=o>239?4:o>223?3:o>191?2:1;if(e+s<=t){let a,c,l,f;switch(s){case 1:o<128&&(i=o);break;case 2:a=r[e+1],(a&192)===128&&(f=(o&31)<<6|a&63,f>127&&(i=f));break;case 3:a=r[e+1],c=r[e+2],(a&192)===128&&(c&192)===128&&(f=(o&15)<<12|(a&63)<<6|c&63,f>2047&&(f<55296||f>57343)&&(i=f));break;case 4:a=r[e+1],c=r[e+2],l=r[e+3],(a&192)===128&&(c&192)===128&&(l&192)===128&&(f=(o&15)<<18|(a&63)<<12|(c&63)<<6|l&63,f>65535&&f<1114112&&(i=f))}}i===null?(i=65533,s=1):i>65535&&(i-=65536,n.push(i>>>10&1023|55296),i=56320|i&1023),n.push(i),e+=s}return E8(n)}var n_=4096;function E8(r){let e=r.length;if(e<=n_)return String.fromCharCode.apply(String,r);let t="",n=0;for(;n<e;)t+=String.fromCharCode.apply(String,r.slice(n,n+=n_));return t}var qU=256,rh=class{constructor(e=qU){this.chunkSize=e,this.cursor=0,this.maxCursor=-1,this.chunks=[],this._initReuseChunk=null}reset(){this.cursor=0,this.maxCursor=-1,this.chunks.length&&(this.chunks=[]),this._initReuseChunk!==null&&(this.chunks.push(this._initReuseChunk),this.maxCursor=this._initReuseChunk.length-1)}push(e){let t=this.chunks[this.chunks.length-1];if(this.cursor+e.length<=this.maxCursor+1){let o=t.length-(this.maxCursor-this.cursor)-1;t.set(e,o)}else{if(t){let o=t.length-(this.maxCursor-this.cursor)-1;o<t.length&&(this.chunks[this.chunks.length-1]=t.subarray(0,o),this.maxCursor=this.cursor-1)}e.length<64&&e.length<this.chunkSize?(t=s_(this.chunkSize),this.chunks.push(t),this.maxCursor+=t.length,this._initReuseChunk===null&&(this._initReuseChunk=t),t.set(e,0)):(this.chunks.push(e),this.maxCursor+=e.length)}this.cursor+=e.length}toBytes(e=!1){let t;if(this.chunks.length===1){let n=this.chunks[0];e&&this.cursor>n.length/2?(t=this.cursor===n.length?n:n.subarray(0,this.cursor),this._initReuseChunk=null,this.chunks=[]):t=Eu(n,0,this.cursor)}else t=i_(this.chunks,this.cursor);return e&&this.reset(),t}};var ye="CBOR decode error:",Wi="CBOR encode error:",nh=[];nh[23]=1;nh[24]=2;nh[25]=3;nh[26]=5;nh[27]=9;function zi(r,e,t){if(r.length-e<t)throw new Error(`${ye} not enough data for type`)}var ur=[24,256,65536,4294967296,BigInt("18446744073709551616")];function kn(r,e,t){zi(r,e,1);let n=r[e];if(t.strict===!0&&n<ur[0])throw new Error(`${ye} integer encoded in more bytes than necessary (strict decode)`);return n}function On(r,e,t){zi(r,e,2);let n=r[e]<<8|r[e+1];if(t.strict===!0&&n<ur[1])throw new Error(`${ye} integer encoded in more bytes than necessary (strict decode)`);return n}function Rn(r,e,t){zi(r,e,4);let n=r[e]*16777216+(r[e+1]<<16)+(r[e+2]<<8)+r[e+3];if(t.strict===!0&&n<ur[2])throw new Error(`${ye} integer encoded in more bytes than necessary (strict decode)`);return n}function Dn(r,e,t){zi(r,e,8);let n=r[e]*16777216+(r[e+1]<<16)+(r[e+2]<<8)+r[e+3],o=r[e+4]*16777216+(r[e+5]<<16)+(r[e+6]<<8)+r[e+7],i=(BigInt(n)<<BigInt(32))+BigInt(o);if(t.strict===!0&&i<ur[3])throw new Error(`${ye} integer encoded in more bytes than necessary (strict decode)`);if(i<=Number.MAX_SAFE_INTEGER)return Number(i);if(t.allowBigInt===!0)return i;throw new Error(`${ye} integers outside of the safe integer range are not supported`)}function a_(r,e,t,n){return new W(v.uint,kn(r,e+1,n),2)}function c_(r,e,t,n){return new W(v.uint,On(r,e+1,n),3)}function l_(r,e,t,n){return new W(v.uint,Rn(r,e+1,n),5)}function u_(r,e,t,n){return new W(v.uint,Dn(r,e+1,n),9)}function Zn(r,e){return br(r,0,e.value)}function br(r,e,t){if(t<ur[0]){let n=Number(t);r.push([e|n])}else if(t<ur[1]){let n=Number(t);r.push([e|24,n])}else if(t<ur[2]){let n=Number(t);r.push([e|25,n>>>8,n&255])}else if(t<ur[3]){let n=Number(t);r.push([e|26,n>>>24&255,n>>>16&255,n>>>8&255,n&255])}else{let n=BigInt(t);if(n<ur[4]){let o=[e|27,0,0,0,0,0,0,0],i=Number(n&BigInt(4294967295)),s=Number(n>>BigInt(32)&BigInt(4294967295));o[8]=i&255,i=i>>8,o[7]=i&255,i=i>>8,o[6]=i&255,i=i>>8,o[5]=i&255,o[4]=s&255,s=s>>8,o[3]=s&255,s=s>>8,o[2]=s&255,s=s>>8,o[1]=s&255,r.push(o)}else throw new Error(`${ye} encountered BigInt larger than allowable range`)}}Zn.encodedSize=function(e){return br.encodedSize(e.value)};br.encodedSize=function(e){return e<ur[0]?1:e<ur[1]?2:e<ur[2]?3:e<ur[3]?5:9};Zn.compareTokens=function(e,t){return e.value<t.value?-1:e.value>t.value?1:0};function f_(r,e,t,n){return new W(v.negint,-1-kn(r,e+1,n),2)}function d_(r,e,t,n){return new W(v.negint,-1-On(r,e+1,n),3)}function h_(r,e,t,n){return new W(v.negint,-1-Rn(r,e+1,n),5)}var S8=BigInt(-1),p_=BigInt(1);function m_(r,e,t,n){let o=Dn(r,e+1,n);if(typeof o!="bigint"){let i=-1-o;if(i>=Number.MIN_SAFE_INTEGER)return new W(v.negint,i,9)}if(n.allowBigInt!==!0)throw new Error(`${ye} integers outside of the safe integer range are not supported`);return new W(v.negint,S8-BigInt(o),9)}function h0(r,e){let t=e.value,n=typeof t=="bigint"?t*S8-p_:t*-1-1;br(r,e.type.majorEncoded,n)}h0.encodedSize=function(e){let t=e.value,n=typeof t=="bigint"?t*S8-p_:t*-1-1;return n<ur[0]?1:n<ur[1]?2:n<ur[2]?3:n<ur[3]?5:9};h0.compareTokens=function(e,t){return e.value<t.value?1:e.value>t.value?-1:0};function oh(r,e,t,n){zi(r,e,t+n);let o=Eu(r,e+t,e+t+n);return new W(v.bytes,o,t+n)}function g_(r,e,t,n){return oh(r,e,1,t)}function y_(r,e,t,n){return oh(r,e,2,kn(r,e+1,n))}function w_(r,e,t,n){return oh(r,e,3,On(r,e+1,n))}function b_(r,e,t,n){return oh(r,e,5,Rn(r,e+1,n))}function v_(r,e,t,n){let o=Dn(r,e+1,n);if(typeof o=="bigint")throw new Error(`${ye} 64-bit integer bytes lengths not supported`);return oh(r,e,9,o)}function p0(r){return r.encodedBytes===void 0&&(r.encodedBytes=r.type===v.string?f0(r.value):r.value),r.encodedBytes}function Su(r,e){let t=p0(e);br(r,e.type.majorEncoded,t.length),r.push(t)}Su.encodedSize=function(e){let t=p0(e);return br.encodedSize(t.length)+t.length};Su.compareTokens=function(e,t){return zU(p0(e),p0(t))};function zU(r,e){return r.length<e.length?-1:r.length>e.length?1:d0(r,e)}function ih(r,e,t,n,o){let i=t+n;zi(r,e,i);let s=new W(v.string,o_(r,e+t,e+i),i);return o.retainStringBytes===!0&&(s.byteValue=Eu(r,e+t,e+i)),s}function x_(r,e,t,n){return ih(r,e,1,t,n)}function E_(r,e,t,n){return ih(r,e,2,kn(r,e+1,n),n)}function S_(r,e,t,n){return ih(r,e,3,On(r,e+1,n),n)}function __(r,e,t,n){return ih(r,e,5,Rn(r,e+1,n),n)}function A_(r,e,t,n){let o=Dn(r,e+1,n);if(typeof o=="bigint")throw new Error(`${ye} 64-bit integer string lengths not supported`);return ih(r,e,9,o,n)}var T_=Su;function _u(r,e,t,n){return new W(v.array,n,t)}function I_(r,e,t,n){return _u(r,e,1,t)}function C_(r,e,t,n){return _u(r,e,2,kn(r,e+1,n))}function P_(r,e,t,n){return _u(r,e,3,On(r,e+1,n))}function k_(r,e,t,n){return _u(r,e,5,Rn(r,e+1,n))}function O_(r,e,t,n){let o=Dn(r,e+1,n);if(typeof o=="bigint")throw new Error(`${ye} 64-bit integer array lengths not supported`);return _u(r,e,9,o)}function R_(r,e,t,n){if(n.allowIndefinite===!1)throw new Error(`${ye} indefinite length items not allowed`);return _u(r,e,1,1/0)}function m0(r,e){br(r,v.array.majorEncoded,e.value)}m0.compareTokens=Zn.compareTokens;m0.encodedSize=function(e){return br.encodedSize(e.value)};function Au(r,e,t,n){return new W(v.map,n,t)}function D_(r,e,t,n){return Au(r,e,1,t)}function N_(r,e,t,n){return Au(r,e,2,kn(r,e+1,n))}function L_(r,e,t,n){return Au(r,e,3,On(r,e+1,n))}function B_(r,e,t,n){return Au(r,e,5,Rn(r,e+1,n))}function M_(r,e,t,n){let o=Dn(r,e+1,n);if(typeof o=="bigint")throw new Error(`${ye} 64-bit integer map lengths not supported`);return Au(r,e,9,o)}function U_(r,e,t,n){if(n.allowIndefinite===!1)throw new Error(`${ye} indefinite length items not allowed`);return Au(r,e,1,1/0)}function g0(r,e){br(r,v.map.majorEncoded,e.value)}g0.compareTokens=Zn.compareTokens;g0.encodedSize=function(e){return br.encodedSize(e.value)};function F_(r,e,t,n){return new W(v.tag,t,1)}function $_(r,e,t,n){return new W(v.tag,kn(r,e+1,n),2)}function j_(r,e,t,n){return new W(v.tag,On(r,e+1,n),3)}function K_(r,e,t,n){return new W(v.tag,Rn(r,e+1,n),5)}function V_(r,e,t,n){return new W(v.tag,Dn(r,e+1,n),9)}function y0(r,e){br(r,v.tag.majorEncoded,e.value)}y0.compareTokens=Zn.compareTokens;y0.encodedSize=function(e){return br.encodedSize(e.value)};var JU=20,eF=21,tF=22,rF=23;function H_(r,e,t,n){if(n.allowUndefined===!1)throw new Error(`${ye} undefined values are not supported`);return n.coerceUndefinedToNull===!0?new W(v.null,null,1):new W(v.undefined,void 0,1)}function q_(r,e,t,n){if(n.allowIndefinite===!1)throw new Error(`${ye} indefinite length items not allowed`);return new W(v.break,void 0,1)}function _8(r,e,t){if(t){if(t.allowNaN===!1&&Number.isNaN(r))throw new Error(`${ye} NaN values are not supported`);if(t.allowInfinity===!1&&(r===1/0||r===-1/0))throw new Error(`${ye} Infinity values are not supported`)}return new W(v.float,r,e)}function W_(r,e,t,n){return _8(A8(r,e+1),3,n)}function z_(r,e,t,n){return _8(T8(r,e+1),5,n)}function G_(r,e,t,n){return _8(Z_(r,e+1),9,n)}function w0(r,e,t){let n=e.value;if(n===!1)r.push([v.float.majorEncoded|JU]);else if(n===!0)r.push([v.float.majorEncoded|eF]);else if(n===null)r.push([v.float.majorEncoded|tF]);else if(n===void 0)r.push([v.float.majorEncoded|rF]);else{let o,i=!1;(!t||t.float64!==!0)&&(Y_(n),o=A8(Co,1),n===o||Number.isNaN(n)?(Co[0]=249,r.push(Co.slice(0,3)),i=!0):(Q_(n),o=T8(Co,1),n===o&&(Co[0]=250,r.push(Co.slice(0,5)),i=!0))),i||(nF(n),o=Z_(Co,1),Co[0]=251,r.push(Co.slice(0,9)))}}w0.encodedSize=function(e,t){let n=e.value;if(n===!1||n===!0||n===null||n===void 0)return 1;if(!t||t.float64!==!0){Y_(n);let o=A8(Co,1);if(n===o||Number.isNaN(n))return 3;if(Q_(n),o=T8(Co,1),n===o)return 5}return 9};var X_=new ArrayBuffer(9),Jn=new DataView(X_,1),Co=new Uint8Array(X_,0);function Y_(r){if(r===1/0)Jn.setUint16(0,31744,!1);else if(r===-1/0)Jn.setUint16(0,64512,!1);else if(Number.isNaN(r))Jn.setUint16(0,32256,!1);else{Jn.setFloat32(0,r);let e=Jn.getUint32(0),t=(e&2139095040)>>23,n=e&8388607;if(t===255)Jn.setUint16(0,31744,!1);else if(t===0)Jn.setUint16(0,(r&2147483648)>>16|n>>13,!1);else{let o=t-127;o<-24?Jn.setUint16(0,0):o<-14?Jn.setUint16(0,(e&2147483648)>>16|1<<24+o,!1):Jn.setUint16(0,(e&2147483648)>>16|o+15<<10|n>>13,!1)}}}function A8(r,e){if(r.length-e<2)throw new Error(`${ye} not enough data for float16`);let t=(r[e]<<8)+r[e+1];if(t===31744)return 1/0;if(t===64512)return-1/0;if(t===32256)return NaN;let n=t>>10&31,o=t&1023,i;return n===0?i=o*2**-24:n!==31?i=(o+1024)*2**(n-25):i=o===0?1/0:NaN,t&32768?-i:i}function Q_(r){Jn.setFloat32(0,r,!1)}function T8(r,e){if(r.length-e<4)throw new Error(`${ye} not enough data for float32`);let t=(r.byteOffset||0)+e;return new DataView(r.buffer,t,4).getFloat32(0,!1)}function nF(r){Jn.setFloat64(0,r,!1)}function Z_(r,e){if(r.length-e<8)throw new Error(`${ye} not enough data for float64`);let t=(r.byteOffset||0)+e;return new DataView(r.buffer,t,8).getFloat64(0,!1)}w0.compareTokens=Zn.compareTokens;function Ye(r,e,t){throw new Error(`${ye} encountered invalid minor (${t}) for major ${r[e]>>>5}`)}function b0(r){return()=>{throw new Error(`${ye} ${r}`)}}var ne=[];for(let r=0;r<=23;r++)ne[r]=Ye;ne[24]=a_;ne[25]=c_;ne[26]=l_;ne[27]=u_;ne[28]=Ye;ne[29]=Ye;ne[30]=Ye;ne[31]=Ye;for(let r=32;r<=55;r++)ne[r]=Ye;ne[56]=f_;ne[57]=d_;ne[58]=h_;ne[59]=m_;ne[60]=Ye;ne[61]=Ye;ne[62]=Ye;ne[63]=Ye;for(let r=64;r<=87;r++)ne[r]=g_;ne[88]=y_;ne[89]=w_;ne[90]=b_;ne[91]=v_;ne[92]=Ye;ne[93]=Ye;ne[94]=Ye;ne[95]=b0("indefinite length bytes/strings are not supported");for(let r=96;r<=119;r++)ne[r]=x_;ne[120]=E_;ne[121]=S_;ne[122]=__;ne[123]=A_;ne[124]=Ye;ne[125]=Ye;ne[126]=Ye;ne[127]=b0("indefinite length bytes/strings are not supported");for(let r=128;r<=151;r++)ne[r]=I_;ne[152]=C_;ne[153]=P_;ne[154]=k_;ne[155]=O_;ne[156]=Ye;ne[157]=Ye;ne[158]=Ye;ne[159]=R_;for(let r=160;r<=183;r++)ne[r]=D_;ne[184]=N_;ne[185]=L_;ne[186]=B_;ne[187]=M_;ne[188]=Ye;ne[189]=Ye;ne[190]=Ye;ne[191]=U_;for(let r=192;r<=215;r++)ne[r]=F_;ne[216]=$_;ne[217]=j_;ne[218]=K_;ne[219]=V_;ne[220]=Ye;ne[221]=Ye;ne[222]=Ye;ne[223]=Ye;for(let r=224;r<=243;r++)ne[r]=b0("simple values are not supported");ne[244]=Ye;ne[245]=Ye;ne[246]=Ye;ne[247]=H_;ne[248]=b0("simple values are not supported");ne[249]=W_;ne[250]=z_;ne[251]=G_;ne[252]=Ye;ne[253]=Ye;ne[254]=Ye;ne[255]=q_;var Po=[];for(let r=0;r<24;r++)Po[r]=new W(v.uint,r,1);for(let r=-1;r>=-24;r--)Po[31-r]=new W(v.negint,r,1);Po[64]=new W(v.bytes,new Uint8Array(0),1);Po[96]=new W(v.string,"",1);Po[128]=new W(v.array,0,1);Po[160]=new W(v.map,0,1);Po[244]=new W(v.false,!1,1);Po[245]=new W(v.true,!0,1);Po[246]=new W(v.null,null,1);function I8(r){switch(r.type){case v.false:return ii([244]);case v.true:return ii([245]);case v.null:return ii([246]);case v.bytes:return r.value.length?void 0:ii([64]);case v.string:return r.value===""?ii([96]):void 0;case v.array:return r.value===0?ii([128]):void 0;case v.map:return r.value===0?ii([160]):void 0;case v.uint:return r.value<24?ii([Number(r.value)]):void 0;case v.negint:if(r.value>=-24)return ii([31-Number(r.value)])}}var iF={float64:!1,mapSorter:cF,quickEncodeToken:I8},eA=Object.freeze({float64:!0,mapSorter:lF,quickEncodeToken:I8});function sF(){let r=[];return r[v.uint.major]=Zn,r[v.negint.major]=h0,r[v.bytes.major]=Su,r[v.string.major]=T_,r[v.array.major]=m0,r[v.map.major]=g0,r[v.tag.major]=y0,r[v.float.major]=w0,r}var P8=sF(),C8=new rh,x0=class r{constructor(e,t){this.obj=e,this.parent=t}includes(e){let t=this;do if(t.obj===e)return!0;while(t=t.parent);return!1}static createCheck(e,t){if(e&&e.includes(t))throw new Error(`${Wi} object contains circular references`);return new r(t,e)}},Xs={null:new W(v.null,null),undefined:new W(v.undefined,void 0),true:new W(v.true,!0),false:new W(v.false,!1),emptyArray:new W(v.array,0),emptyMap:new W(v.map,0)},Ys={number(r,e,t,n){return!Number.isInteger(r)||!Number.isSafeInteger(r)?new W(v.float,r):r>=0?new W(v.uint,r):new W(v.negint,r)},bigint(r,e,t,n){return r>=BigInt(0)?new W(v.uint,r):new W(v.negint,r)},Uint8Array(r,e,t,n){return new W(v.bytes,r)},string(r,e,t,n){return new W(v.string,r)},boolean(r,e,t,n){return r?Xs.true:Xs.false},null(r,e,t,n){return Xs.null},undefined(r,e,t,n){return Xs.undefined},ArrayBuffer(r,e,t,n){return new W(v.bytes,new Uint8Array(r))},DataView(r,e,t,n){return new W(v.bytes,new Uint8Array(r.buffer,r.byteOffset,r.byteLength))},Array(r,e,t,n){if(!r.length)return t.addBreakTokens===!0?[Xs.emptyArray,new W(v.break)]:Xs.emptyArray;n=x0.createCheck(n,r);let o=[],i=0;for(let s of r)o[i++]=v0(s,t,n);return t.addBreakTokens?[new W(v.array,r.length),o,new W(v.break)]:[new W(v.array,r.length),o]},Object(r,e,t,n){let o=e!=="Object",i=o?r.keys():Object.keys(r),s=o?r.size:i.length;if(!s)return t.addBreakTokens===!0?[Xs.emptyMap,new W(v.break)]:Xs.emptyMap;n=x0.createCheck(n,r);let a=[],c=0;for(let l of i)a[c++]=[v0(l,t,n),v0(o?r.get(l):r[l],t,n)];return aF(a,t),t.addBreakTokens?[new W(v.map,s),a,new W(v.break)]:[new W(v.map,s),a]}};Ys.Map=Ys.Object;Ys.Buffer=Ys.Uint8Array;for(let r of"Uint8Clamped Uint16 Uint32 Int8 Int16 Int32 BigUint64 BigInt64 Float32 Float64".split(" "))Ys[`${r}Array`]=Ys.DataView;function v0(r,e={},t){let n=e_(r),o=e&&e.typeEncoders&&e.typeEncoders[n]||Ys[n];if(typeof o=="function"){let s=o(r,n,e,t);if(s!=null)return s}let i=Ys[n];if(!i)throw new Error(`${Wi} unsupported type: ${n}`);return i(r,n,e,t)}function aF(r,e){e.mapSorter&&r.sort(e.mapSorter)}function cF(r,e){let t=Array.isArray(r[0])?r[0][0]:r[0],n=Array.isArray(e[0])?e[0][0]:e[0];if(t.type!==n.type)return t.type.compare(n.type);let o=t.type.major,i=P8[o].compareTokens(t,n);return i===0&&console.warn("WARNING: complex key types used, CBOR key sorting guarantees are gone"),i}function lF(r,e){if(r[0]instanceof W&&e[0]instanceof W){let t=r[0],n=e[0];return t._keyBytes||(t._keyBytes=J_(t.value)),n._keyBytes||(n._keyBytes=J_(n.value)),d0(t._keyBytes,n._keyBytes)}throw new Error("rfc8949MapSorter: complex key types are not supported yet")}function J_(r){return E0(r,P8,eA)}function tA(r,e,t,n){if(Array.isArray(e))for(let o of e)tA(r,o,t,n);else t[e.type.major](r,e,n)}function E0(r,e,t){let n=v0(r,t);if(!Array.isArray(n)&&t.quickEncodeToken){let o=t.quickEncodeToken(n);if(o)return o;let i=e[n.type.major];if(i.encodedSize){let s=i.encodedSize(n,t),a=new rh(s);if(i(a,n,t),a.chunks.length!==1)throw new Error(`Unexpected error: pre-calculated length for ${n} was wrong`);return th(a.chunks[0])}}return C8.reset(),tA(C8,n,e,t),C8.toBytes(!0)}function Qs(r,e){return e=Object.assign({},iF,e),E0(r,P8,e)}var uF={strict:!1,allowIndefinite:!0,allowUndefined:!0,allowBigInt:!0},S0=class{constructor(e,t={}){this._pos=0,this.data=e,this.options=t}pos(){return this._pos}done(){return this._pos>=this.data.length}next(){let e=this.data[this._pos],t=Po[e];if(t===void 0){let n=ne[e];if(!n)throw new Error(`${ye} no decoder for major type ${e>>>5} (byte 0x${e.toString(16).padStart(2,"0")})`);let o=e&31;t=n(this.data,this._pos,o,this.options)}return this._pos+=t.encodedLength,t}},sh=Symbol.for("DONE"),_0=Symbol.for("BREAK");function fF(r,e,t){let n=[];for(let o=0;o<r.value;o++){let i=Tu(e,t);if(i===_0){if(r.value===1/0)break;throw new Error(`${ye} got unexpected break to lengthed array`)}if(i===sh)throw new Error(`${ye} found array but not enough entries (got ${o}, expected ${r.value})`);n[o]=i}return n}function dF(r,e,t){let n=t.useMaps===!0,o=n?void 0:{},i=n?new Map:void 0;for(let s=0;s<r.value;s++){let a=Tu(e,t);if(a===_0){if(r.value===1/0)break;throw new Error(`${ye} got unexpected break to lengthed map`)}if(a===sh)throw new Error(`${ye} found map but not enough entries (got ${s} [no key], expected ${r.value})`);if(n!==!0&&typeof a!="string")throw new Error(`${ye} non-string keys not supported (got ${typeof a})`);if(t.rejectDuplicateMapKeys===!0&&(n&&i.has(a)||!n&&a in o))throw new Error(`${ye} found repeat map key "${a}"`);let c=Tu(e,t);if(c===sh)throw new Error(`${ye} found map but not enough entries (got ${s} [no value], expected ${r.value})`);n?i.set(a,c):o[a]=c}return n?i:o}function Tu(r,e){if(r.done())return sh;let t=r.next();if(t.type===v.break)return _0;if(t.type.terminal)return t.value;if(t.type===v.array)return fF(t,r,e);if(t.type===v.map)return dF(t,r,e);if(t.type===v.tag){if(e.tags&&typeof e.tags[t.value]=="function"){let n=Tu(r,e);return e.tags[t.value](n)}throw new Error(`${ye} tag not supported (${t.value})`)}throw new Error("unsupported")}function k8(r,e){if(!(r instanceof Uint8Array))throw new Error(`${ye} data to decode must be a Uint8Array`);e=Object.assign({},uF,e);let t=e.tokenizer||new S0(r,e),n=Tu(t,e);if(n===sh)throw new Error(`${ye} did not find any content to decode`);if(n===_0)throw new Error(`${ye} got unexpected break`);return[n,r.subarray(t.pos())]}function Nn(r,e){let[t,n]=k8(r,e);if(n.length>0)throw new Error(`${ye} too many terminals, data makes no sense`);return t}var A0=class extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MSG_LENGTH"},Iu=class extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"},T0=class extends Error{name="InvalidDataLengthLengthError";code="ERR_MSG_LENGTH_TOO_LONG"},ah=class extends Error{name="UnexpectedEOFError";code="ERR_UNEXPECTED_EOF"};function I0(r){return r[Symbol.asyncIterator]!=null}function rA(r,e){if(r.byteLength>e)throw new Iu("Message length too long")}var P0=r=>{let e=je(r),t=Ot(e);return Mr(r,t),P0.bytes=e,t};P0.bytes=0;function Gi(r,e){e=e??{};let t=e.lengthEncoder??P0,n=e?.maxDataLength??4194304;function*o(i){rA(i,n);let s=t(i.byteLength);s instanceof Uint8Array?yield s:yield*s,i instanceof Uint8Array?yield i:yield*i}return I0(r)?(async function*(){for await(let i of r)yield*o(i)})():(function*(){for(let i of r)yield*o(i)})()}Gi.single=(r,e)=>{e=e??{};let t=e.lengthEncoder??P0,n=e?.maxDataLength??4194304;return rA(r,n),new fe(t(r.byteLength),r)};var xc;(function(r){r[r.LENGTH=0]="LENGTH",r[r.DATA=1]="DATA"})(xc||(xc={}));var R8=r=>{let e=Cn(r);return R8.bytes=je(e),e};R8.bytes=0;function Ec(r,e){let t=new fe,n=xc.LENGTH,o=-1,i=e?.lengthDecoder??R8,s=e?.maxLengthLength??8,a=e?.maxDataLength??4194304;function*c(){for(;t.byteLength>0;){if(n===xc.LENGTH)try{if(o=i(t),o<0)throw new A0("Invalid message length");if(o>a)throw new Iu("Message length too long");let l=i.bytes;t.consume(l),e?.onLength!=null&&e.onLength(o),n=xc.DATA}catch(l){if(l instanceof RangeError){if(t.byteLength>s)throw new T0("Message length length too long");break}throw l}if(n===xc.DATA){if(t.byteLength<o)break;let l=t.sublist(0,o);t.consume(o),e?.onData!=null&&e.onData(l),yield l,n=xc.LENGTH}}}return I0(r)?(async function*(){for await(let l of r)t.append(l),yield*c();if(t.byteLength>0)throw new ah("Unexpected end of input")})():(function*(){for(let l of r)t.append(l),yield*c();if(t.byteLength>0)throw new ah("Unexpected end of input")})()}Ec.fromReader=(r,e)=>{let t=1,n=(async function*(){for(;;)try{let{done:i,value:s}=await r.next(t);if(i===!0)return;s!=null&&(yield s)}catch(i){if(i.code==="ERR_UNDER_READ")return{done:!0,value:null};throw i}finally{t=1}})();return Ec(n,{...e??{},onLength:i=>{t=i}})};var oA=Symbol.for("sindresorhus/unlimited-timeout#brand");function iA(r,e,...t){if(typeof r!="function")throw new TypeError("Expected callback to be a function");e??=0,e=Number(e);let n=!1,o={[oA]:!0,id:void 0,cleared:!1,ref(){return n=!1,o.id?.ref?.(),o},unref(){return n=!0,o.id?.unref?.(),o}};if(e===Number.POSITIVE_INFINITY||e>Number.MAX_SAFE_INTEGER)return o;(!Number.isFinite(e)||e<0)&&(e=0);let i=performance.now()+e,s=a=>{o.cleared||(a<=2147483647?(o.id=globalThis.setTimeout(()=>{o.cleared||r(...t)},a),n&&o.id?.unref?.()):(o.id=globalThis.setTimeout(()=>{let c=performance.now(),l=Math.max(0,i-c);s(l)},2147483647),n&&o.id?.unref?.()))};return s(e),o}function sA(r){!r||typeof r!="object"||!r[oA]||(r.cleared=!0,r.id!==void 0&&(globalThis.clearTimeout(r.id),r.id=void 0))}var pF=new WeakMap;function mF({clearTimeout:r,setTimeout:e}={}){return(t,{value:n,signal:o}={})=>{if(o?.aborted)return Promise.reject(o.reason);let i,s,a,c=r??clearTimeout,l=()=>{c(i),a(o.reason)},f=()=>{o&&o.removeEventListener("abort",l)},u=new Promise((d,h)=>{s=()=>{f(),d(n)},a=h,i=(e??setTimeout)(s,t)});return o&&o.addEventListener("abort",l,{once:!0}),pF.set(u,()=>{c(i),i=null,s()}),u}}var gF=mF({setTimeout:iA,clearTimeout:sA}),aA=gF;var vr=class extends yr{has(e){return this.find(e)!=null}find(e){return this.queue.find(t=>e.equals(t.options.peerId))}};var k0=class extends yr{constructor(e={}){super({...e,sort:(t,n)=>t.options.priority>n.options.priority?-1:t.options.priority<n.options.priority?1:0})}};var Cu=class{memoryStorage;points;duration;blockDuration;keyPrefix;constructor(e={}){this.points=e.points??4,this.duration=e.duration??1,this.blockDuration=e.blockDuration??0,this.keyPrefix=e.keyPrefix??"rlflx",this.memoryStorage=new D8}consume(e,t=1,n={}){let o=this.getKey(e),i=this._getKeySecDuration(n),s=this.memoryStorage.incrby(o,t,i);if(s.remainingPoints=Math.max(this.points-s.consumedPoints,0),s.consumedPoints>this.points)throw this.blockDuration>0&&s.consumedPoints<=this.points+t&&(s=this.memoryStorage.set(o,s.consumedPoints,this.blockDuration)),new Gm("Rate limit exceeded",s);return s}penalty(e,t=1,n={}){let o=this.getKey(e),i=this._getKeySecDuration(n),s=this.memoryStorage.incrby(o,t,i);return s.remainingPoints=Math.max(this.points-s.consumedPoints,0),s}reward(e,t=1,n={}){let o=this.getKey(e),i=this._getKeySecDuration(n),s=this.memoryStorage.incrby(o,-t,i);return s.remainingPoints=Math.max(this.points-s.consumedPoints,0),s}block(e,t){let n=t*1e3,o=this.points+1;return this.memoryStorage.set(this.getKey(e),o,t),{remainingPoints:0,msBeforeNext:n===0?-1:n,consumedPoints:o,isFirstInDuration:!1}}set(e,t,n=0){let o=(n>=0?n:this.duration)*1e3;return this.memoryStorage.set(this.getKey(e),t,n),{remainingPoints:0,msBeforeNext:o===0?-1:o,consumedPoints:t,isFirstInDuration:!1}}get(e){let t=this.memoryStorage.get(this.getKey(e));return t!=null&&(t.remainingPoints=Math.max(this.points-t.consumedPoints,0)),t}delete(e){this.memoryStorage.delete(this.getKey(e))}_getKeySecDuration(e){return e?.customDuration!=null&&e.customDuration>=0?e.customDuration:this.duration}getKey(e){return this.keyPrefix.length>0?`${this.keyPrefix}:${e}`:e}parseKey(e){return e.substring(this.keyPrefix.length)}},D8=class{storage;constructor(){this.storage=new Map}incrby(e,t,n){let o=this.storage.get(e);if(o!=null){let i=o.expiresAt!=null?o.expiresAt.getTime()-new Date().getTime():-1;return o.expiresAt==null||i>0?(o.value+=t,{remainingPoints:0,msBeforeNext:i,consumedPoints:o.value,isFirstInDuration:!1}):this.set(e,t,n)}return this.set(e,t,n)}set(e,t,n){let o=n*1e3,i=this.storage.get(e);i!=null&&clearTimeout(i.timeoutId);let s={value:t,expiresAt:o>0?new Date(Date.now()+o):void 0};return this.storage.set(e,s),o>0&&(s.timeoutId=setTimeout(()=>{this.storage.delete(e)},o),s.timeoutId.unref!=null&&s.timeoutId.unref()),{remainingPoints:0,msBeforeNext:o===0?-1:o,consumedPoints:s.value,isFirstInDuration:!0}}get(e){let t=this.storage.get(e);if(t!=null)return{remainingPoints:0,msBeforeNext:t.expiresAt!=null?t.expiresAt.getTime()-new Date().getTime():-1,consumedPoints:t.value,isFirstInDuration:!1}}delete(e){let t=this.storage.get(e);return t!=null?(t.timeoutId!=null&&clearTimeout(t.timeoutId),this.storage.delete(e),!0):!1}};function Pu(r,e,t){let n,o,i=!1;function s(){let l={signal:o.signal};if(t?.timeout!=null){let f=De([o.signal,AbortSignal.timeout(t.timeout)]);l.signal=f}i=!0,Promise.resolve().then(async()=>{await r(l)}).catch(()=>{}).finally(()=>{i=!1,!o.signal.aborted&&(n=setTimeout(s,e))})}let a=ji(s,t?.debounce??100),c=!1;return{setInterval:l=>{e!==l&&(e=l,n!=null&&(clearTimeout(n),n=setTimeout(s,e)))},setTimeout:l=>{t??={},t.timeout=l},run:()=>{i||(clearTimeout(n),a())},start:()=>{c||(c=!0,o=new AbortController,o.signal,t?.runImmediately===!0?queueMicrotask(()=>{s()}):n=setTimeout(s,e))},stop:()=>{clearTimeout(n),o?.abort(),c=!1}}}var N8=class extends Map{metric;constructor(e){super();let{name:t,metrics:n}=e;this.metric=n.registerMetric(t),this.updateComponentMetric()}set(e,t){return super.set(e,t),this.updateComponentMetric(),this}delete(e){let t=super.delete(e);return this.updateComponentMetric(),t}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}};function Wt(r){let{name:e,metrics:t}=r,n;return t!=null?n=new N8({name:e,metrics:t}):n=new Map,n}var Xi="/",cA=new TextEncoder().encode(Xi),O0=cA[0],ht=class r{_buf;constructor(e,t){if(typeof e=="string")this._buf=B(e);else if(e instanceof Uint8Array)this._buf=e;else throw new Error("Invalid key, should be String of Uint8Array");if(t==null&&(t=!0),t&&this.clean(),this._buf.byteLength===0||this._buf[0]!==O0)throw new Error("Invalid key")}toString(e="utf8"){return j(this._buf,e)}uint8Array(){return this._buf}get[Symbol.toStringTag](){return`Key(${this.toString()})`}static withNamespaces(e){return new r(e.join(Xi))}static random(){return new r(Math.random().toString().substring(2))}static asKey(e){return e instanceof Uint8Array||typeof e=="string"?new r(e):typeof e.uint8Array=="function"?new r(e.uint8Array()):null}clean(){if((this._buf==null||this._buf.byteLength===0)&&(this._buf=cA),this._buf[0]!==O0){let e=new Uint8Array(this._buf.byteLength+1);e.fill(O0,0,1),e.set(this._buf,1),this._buf=e}for(;this._buf.byteLength>1&&this._buf[this._buf.byteLength-1]===O0;)this._buf=this._buf.subarray(0,-1)}less(e){let t=this.list(),n=e.list();for(let o=0;o<t.length;o++){if(n.length<o+1)return!1;let i=t[o],s=n[o];if(i<s)return!0;if(i>s)return!1}return t.length<n.length}reverse(){return r.withNamespaces(this.list().slice().reverse())}namespaces(){return this.list()}baseNamespace(){let e=this.namespaces();return e[e.length-1]}list(){return this.toString().split(Xi).slice(1)}type(){return yF(this.baseNamespace())}name(){return wF(this.baseNamespace())}instance(e){return new r(this.toString()+":"+e)}path(){let e=this.parent().toString();return e.endsWith(Xi)||(e+=Xi),e+=this.type(),new r(e)}parent(){let e=this.list();return e.length===1?new r(Xi):new r(e.slice(0,-1).join(Xi))}child(e){return this.toString()===Xi?e:e.toString()===Xi?this:new r(this.toString()+e.toString(),!1)}isAncestorOf(e){return e.toString()===this.toString()?!1:e.toString().startsWith(this.toString())}isDecendantOf(e){return e.toString()===this.toString()?!1:this.toString().startsWith(e.toString())}isTopLevel(){return this.list().length===1}concat(...e){return r.withNamespaces([...this.namespaces(),...bF(e.map(t=>t.namespaces()))])}};function yF(r){let e=r.split(":");return e.length<2?"":e.slice(0,-1).join(":")}function wF(r){let e=r.split(":");return e[e.length-1]}function bF(r){return[].concat(...r)}function vF(r){return r[Symbol.asyncIterator]!=null}function xF(r){if(vF(r))return(async()=>{let n=new Uint8Array(0);for await(let o of r)n=gt([n,o],n.length+o.length);return n})();let e=[],t=0;for(let n of r)e.push(n),t+=n.byteLength;return gt(e,t)}var R0=xF;function D0({enumerable:r=!0,configurable:e=!1}={}){return{enumerable:r,configurable:e,writable:!1}}function*EF(r,e){if(e!=null&&typeof e=="object")if(Array.isArray(e))for(let[t,n]of e.entries()){let o=[...r,t],i=he.asCID(n);i!=null?yield[o.join("/"),i]:typeof n=="object"&&(yield*L8(n,o))}else{let t=he.asCID(e);t!=null?yield[r.join("/"),t]:yield*L8(e,r)}}function*L8(r,e){if(r==null||r instanceof Uint8Array)return;let t=he.asCID(r);t!=null&&(yield[e.join("/"),t]);for(let[n,o]of Object.entries(r)){let i=[...e,n];yield*EF(i,o)}}function*SF(r,e){if(Array.isArray(e))for(let[t,n]of e.entries()){let o=[...r,t];yield o.join("/"),typeof n=="object"&&he.asCID(n)==null&&(yield*B8(n,o))}else yield*B8(e,r)}function*B8(r,e){if(!(r==null||typeof r!="object"))for(let[t,n]of Object.entries(r)){let o=[...e,t];yield o.join("/"),n!=null&&!(n instanceof Uint8Array)&&typeof n=="object"&&he.asCID(n)==null&&(yield*SF(o,n))}}function _F(r,e){let t=r;for(let[n,o]of e.entries()){if(t=t[o],t==null)throw new Error(`Object has no property at ${e.slice(0,n+1).map(s=>`[${JSON.stringify(s)}]`).join("")}`);let i=he.asCID(t);if(i!=null)return{value:i,remaining:e.slice(n+1).join("/")}}return{value:t}}var M8=class{cid;bytes;value;asBlock;constructor({cid:e,bytes:t,value:n}){if(e==null||t==null||typeof n>"u")throw new Error("Missing required argument");this.cid=e,this.bytes=t,this.value=n,this.asBlock=this,Object.defineProperties(this,{cid:D0(),bytes:D0(),value:D0(),asBlock:D0()})}links(){return L8(this.value,[])}tree(){return B8(this.value,[])}get(e="/"){return _F(this.value,e.split("/").filter(Boolean))}};function lA({bytes:r,cid:e,value:t,codec:n}){let o=t!==void 0?t:n?.decode(r);if(o===void 0)throw new Error('Missing required argument, must either provide "value" or "codec"');return new M8({cid:e,bytes:r,value:o})}var N0=class extends Error{static name="AlreadyPinnedError";name="AlreadyPinnedError"},ch=class extends Error{static name="BlockPinnedError";name="BlockPinnedError"},L0=class extends Error{static name="InvalidDatastoreVersionError";name="InvalidDatastoreVersionError"},B0=class extends Error{static name="InvalidConfigurationError";name="InvalidConfigurationError"},M0=class extends AggregateError{static name="GetFailedError";name="GetFailedError"},U0=class extends AggregateError{static name="LoadBlockFailedError";name="LoadBlockFailedError"},lh=class extends Error{static name="BlockNotFoundWhileOfflineError";name="BlockNotFoundWhileOfflineError"};var dA="/pin/",uA="/pinned-block/",U8=Gn,fA=1;function F0(r){return r.version===0&&(r=r.toV1()),new ht(`${dA}${r.toString(U8)}`)}var $0=class{datastore;blockstore;getCodec;constructor(e,t,n){this.datastore=e,this.blockstore=t,this.getCodec=n}async*add(e,t={}){let n=F0(e);if(await this.datastore.has(n))throw new N0("Already pinned");let o=Math.round(t.depth??1/0);if(o<0)throw new P("Depth must be greater than or equal to 0");let i=new yr({concurrency:fA});for await(let a of this.#e(e,i,{...t,depth:o}))await this.#t(a,c=>c.pinnedBy.find(l=>we(l,e.bytes))!=null?!1:(c.pinCount++,c.pinnedBy.push(e.bytes),!0),t),yield a;let s={depth:o,metadata:t.metadata??{}};await this.datastore.put(n,Qs(s),t)}async*#e(e,t,n){if(n.depth===-1)return;let o=await this.getCodec(e.code),i=await R0(this.blockstore.get(e,n)),s=lA({bytes:i,cid:e,codec:o});yield e;for(let[,a]of s.links())yield*await t.add(async()=>this.#e(a,t,{...n,depth:n.depth-1}))}async#t(e,t,n){let o=new ht(`${uA}${U8.encode(e.multihash.bytes)}`),i={pinCount:0,pinnedBy:[]};try{i=Nn(await this.datastore.get(o,n))}catch(a){if(a.name!=="NotFoundError")throw a}if(t(i)){if(i.pinCount===0&&await this.datastore.has(o)){await this.datastore.delete(o);return}await this.datastore.put(o,Qs(i),n),n.onProgress?.(new oe("helia:pin:add",e))}}async*rm(e,t={}){let n=F0(e),o=await this.datastore.get(n,t),i=Nn(o);await this.datastore.delete(n,t);let s=new yr({concurrency:fA});for await(let a of this.#e(e,s,{...t,depth:i.depth}))await this.#t(a,c=>(c.pinCount--,c.pinnedBy=c.pinnedBy.filter(l=>we(l,e.bytes)),!0),{...t,depth:i.depth}),yield a}async*ls(e={}){for await(let{key:t,value:n}of this.datastore.query({prefix:dA+(e.cid!=null?`${e.cid.toString(Gn)}`:"")},e)){let o=he.parse(t.toString().substring(5),Gn),i=Nn(n);yield{cid:o,...i}}}async isPinned(e,t={}){let n=new ht(`${uA}${U8.encode(e.multihash.bytes)}`);return this.datastore.has(n,t)}async get(e,t){let n=F0(e),o=await this.datastore.get(n,t);return Nn(o)}async setMetadata(e,t,n){let o=F0(e),i=await this.datastore.get(o,n),s=Nn(i);s.metadata=t??{},await this.datastore.put(o,Qs(s),n)}};var F8=1,$8=5;var uh=class extends Error{static name="InsufficientProvidersError";constructor(e="Insufficient providers found"){super(e),this.name="InsufficientProvidersError"}},Zs=class extends Error{static name="NoRoutersAvailableError";constructor(e="No routers available"){super(e),this.name="NoRoutersAvailableError"}},fh=class extends Error{static name="UnknownHashAlgorithmError";constructor(e="Unknown hash algorithm"){super(e),this.name="UnknownHashAlgorithmError"}},dh=class extends Error{static name="UnknownCodecError";constructor(e="Unknown codec"){super(e),this.name="UnknownCodecError"}},j8=class extends Error{static name="InvalidCodecError";constructor(e="Invalid codec"){super(e),this.name="InvalidCodecError"}};var AF=5,j0=class{log;routers;providerLookupConcurrency;constructor(e,t){this.log=e.logger.forComponent("helia:routing"),this.routers=t.routers??[],this.providerLookupConcurrency=t.providerLookupConcurrency??AF,this.findProviders=e.metrics?.traceFunction("helia.routing.findProviders",this.findProviders.bind(this),{optionsIndex:1})??this.findProviders,this.provide=e.metrics?.traceFunction("helia.routing.provide",this.provide.bind(this),{optionsIndex:1})??this.provide,this.cancelReprovide=e.metrics?.traceFunction("helia.routing.cancelReprovide",this.cancelReprovide.bind(this),{optionsIndex:1})??this.cancelReprovide,this.put=e.metrics?.traceFunction("helia.routing.put",this.put.bind(this),{optionsIndex:2})??this.put,this.get=e.metrics?.traceFunction("helia.routing.get",this.get.bind(this),{optionsIndex:1})??this.get,this.findPeer=e.metrics?.traceFunction("helia.routing.findPeer",this.findPeer.bind(this),{optionsIndex:1})??this.findPeer,this.getClosestPeers=e.metrics?.traceFunction("helia.routing.getClosestPeers",this.getClosestPeers.bind(this),{optionsIndex:1})??this.getClosestPeers}async start(){await er(...this.routers)}async stop(){await or(...this.routers)}async*findProviders(e,t={}){if(this.routers.length===0)throw new Zs("No content routers available");let n=new vr({concurrency:this.providerLookupConcurrency}),o=0,i=[],s=this,a=0;this.log("findProviders for %c start using routers %s",e,this.routers.map(l=>l.toString()).join(", "));let c=Sc(this.routers,"findProviders").map(async function*(l){let f=0;try{for await(let u of l.findProviders(e,t))f++,yield u}catch(u){i.push(u)}finally{s.log("router %s found %d providers for %c",l,f,e),a++,a===c.length&&n.size===0&&n.emitIdle()}});for await(let l of Yr(n.toGenerator(),...c))if(l!=null){if(l.multiaddrs.length===0){if(n.find(l.id)!=null)continue;n.add(async()=>{try{let f=await this.findPeer(l.id,t);return f.multiaddrs.length===0?null:{...f,protocols:l.protocols,routing:l.routing}}catch(f){return this.log.error("could not load multiaddrs for peer %p - %e",l.id,f),null}},{peerId:l.id,signal:t.signal}).catch(f=>{this.log.error("could not load multiaddrs for peer %p - %e",l.id,f)});continue}o++,yield l}this.log("findProviders finished, found %d providers for %c",o,e)}async provide(e,t={}){if(this.routers.length===0)throw new Zs("No content routers available");await Promise.all(Sc(this.routers,"provide").map(async n=>{await n.provide(e,t)}))}async cancelReprovide(e,t={}){await Promise.all(Sc(this.routers,"cancelReprovide").map(async n=>{await n.cancelReprovide(e,t)}))}async put(e,t,n){await Promise.all(Sc(this.routers,"put").map(async o=>{await o.put(e,t,n)}))}async get(e,t){let n=[],o;try{o=await Promise.any(Sc(this.routers,"get").map(async i=>{try{return await i.get(e,t)}catch(s){this.log("router %s failed with %e",i,s),n.push(s)}}))}catch{}if(o==null)throw new M0(n,`Failed to get value key ${j(e,"base58btc")}`);return o}async findPeer(e,t){if(this.routers.length===0)throw new Zs("No peer routers available");let n=this,o=Yr(...Sc(this.routers,"findPeer").map(i=>(async function*(){try{yield await i.findPeer(e,t)}catch(s){n.log.error(s)}})()));for await(let i of o)if(i!=null)return i;throw new Xe("Could not find peer in routing")}async*getClosestPeers(e,t={}){if(this.routers.length===0)throw new Zs("No peer routers available");for await(let n of Yr(...Sc(this.routers,"getClosestPeers").map(o=>o.getClosestPeers(e,t))))n!=null&&(yield n)}};function Sc(r,e){return r.filter(t=>t[e]!=null)}var Ln=class extends Error{static name="AbortError";name="AbortError";constructor(e="The operation was aborted",...t){super(e,...t)}};async function Qr(r,e,t,n){let o=new Ln(n?.errorMessage);n?.errorCode!=null&&(o.code=n.errorCode);let i=n?.errorEvent??"error";return t?.aborted===!0?Promise.reject(o):new Promise((s,a)=>{function c(){V8(t,"abort",u),V8(r,e,l),V8(r,i,f)}let l=d=>{try{if(n?.filter?.(d)===!1)return}catch(h){c(),a(h);return}c(),s(d)},f=d=>{if(c(),d instanceof Error){a(d);return}a(d.detail??n?.error??new Error(`The "${n?.errorEvent}" event was emitted but the event had no '.detail' field. Pass an 'error' option to race-event to change this message.`))},u=()=>{c(),a(o)};K8(t,"abort",u),K8(r,e,l),K8(r,i,f)})}function K8(r,e,t){r!=null&&(hA(r)?r.addEventListener(e,t):r.addListener(e,t))}function V8(r,e,t){r!=null&&(hA(r)?r.removeEventListener(e,t):r.removeListener(e,t))}function hA(r){return typeof r.addEventListener=="function"&&typeof r.removeEventListener=="function"}var K0=class extends Error{static name="QueueFullError";constructor(e="The queue was full"){super(e),this.name="QueueFullError"}};var V0=class{deferred;signal;constructor(e){this.signal=e,this.deferred=Promise.withResolvers(),this.onAbort=this.onAbort.bind(this),this.signal?.addEventListener("abort",this.onAbort)}onAbort(){this.deferred.reject(this.signal?.reason??new Ln)}cleanup(){this.signal?.removeEventListener("abort",this.onAbort)}};function TF(){return`${parseInt(String(Math.random()*1e9),10).toString()}${Date.now()}`}var H0=class{id;fn;options;recipients;status;timeline;controller;constructor(e,t){this.id=TF(),this.status="queued",this.fn=e,this.options=t,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,this.controller.signal,this.onAbort=this.onAbort.bind(this)}abort(e){this.controller.abort(e)}onAbort(){this.recipients.reduce((t,n)=>t&&n.signal?.aborted===!0,!0)&&(this.controller.abort(new Ln),this.cleanup())}async join(e={}){let t=new V0(e.signal);return this.recipients.push(t),e.signal?.addEventListener("abort",this.onAbort),t.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();let e=await ut(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach(t=>{t.deferred.resolve(e)}),this.status="complete"}catch(e){this.recipients.forEach(t=>{t.deferred.reject(e)}),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach(e=>{e.cleanup(),e.signal?.removeEventListener("abort",this.onAbort)})}};function H8(r,e){let t,n=function(){let o=function(){t=void 0,r()};clearTimeout(t),t=setTimeout(o,e)};return n.start=()=>{},n.stop=()=>{clearTimeout(t)},n}var hh=class extends _e{concurrency;maxSize;queue;pending;sort;autoStart;constructor(e={}){super(),this.concurrency=e.concurrency??Number.POSITIVE_INFINITY,this.maxSize=e.maxSize??Number.POSITIVE_INFINITY,this.pending=0,this.autoStart=e.autoStart??!0,this.sort=e.sort,this.queue=[],this.emitEmpty=H8(this.emitEmpty.bind(this),1),this.emitIdle=H8(this.emitIdle.bind(this),1)}[Symbol.asyncIterator](){return this.toGenerator()}emitEmpty(){this.size===0&&this.safeDispatchEvent("empty")}emitIdle(){this.running===0&&this.safeDispatchEvent("idle")}tryToStartAnother(){if(this.size===0)return this.emitEmpty(),this.running===0&&this.emitIdle(),!1;if(this.pending<this.concurrency){let e;for(let t of this.queue)if(t.status==="queued"){e=t;break}return e==null?!1:(this.safeDispatchEvent("active"),this.pending++,e.run().finally(()=>{for(let t=0;t<this.queue.length;t++)if(this.queue[t]===e){this.queue.splice(t,1);break}this.pending--,this.safeDispatchEvent("next"),this.autoStart&&this.tryToStartAnother()}),!0)}return!1}enqueue(e){this.queue.push(e),this.sort!=null&&this.queue.sort(this.sort)}start(){this.autoStart===!1&&(this.autoStart=!0,this.tryToStartAnother())}pause(){this.autoStart=!1}async add(e,t){if(t?.signal?.throwIfAborted(),this.size===this.maxSize)throw new K0;let n=new H0(e,t);return this.enqueue(n),this.safeDispatchEvent("add"),this.autoStart&&this.tryToStartAnother(),n.join(t).then(o=>(this.safeDispatchEvent("success",{detail:{job:n,result:o}}),o)).catch(o=>{if(n.status==="queued"){for(let i=0;i<this.queue.length;i++)if(this.queue[i]===n){this.queue.splice(i,1);break}}throw this.safeDispatchEvent("failure",{detail:{job:n,error:o}}),o})}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach(e=>{e.abort(new Ln)}),this.clear()}async onEmpty(e){this.size!==0&&await Qr(this,"empty",e?.signal)}async onSizeLessThan(e,t){this.size<e||await Qr(this,"next",t?.signal,{filter:()=>this.size<e})}async onIdle(e){this.pending===0&&this.size===0||await Qr(this,"idle",e?.signal)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(e){e?.signal?.throwIfAborted();let t=gr({objectMode:!0}),n=c=>{c!=null?this.abort():this.clear(),t.end(c)},o=c=>{c.detail!=null&&t.push(c.detail.result)},i=c=>{n(c.detail.error)},s=()=>{n()},a=()=>{n(new Ln("Queue aborted"))};this.addEventListener("success",o),this.addEventListener("failure",i),this.addEventListener("idle",s),e?.signal?.addEventListener("abort",a);try{yield*t}finally{this.removeEventListener("success",o),this.removeEventListener("failure",i),this.removeEventListener("idle",s),e?.signal?.removeEventListener("abort",a),n()}}};var q0="lock:worker:request-read",W0="lock:worker:abort-read-request",z0="lock:worker:release-read",G0="lock:master:grant-read",X0="lock:master:error-read",Y0="lock:worker:request-write",Q0="lock:worker:abort-write-request",Z0="lock:worker:release-write",J0="lock:master:grant-write",e2="lock:master:error-write",t2="lock:worker:finalize",r2="mortice",pA={singleProcess:!1};var q8=(r,e,t,n,o,i,s,a,c)=>l=>{if(l.data==null)return;let f={type:l.data.type,name:l.data.name,identifier:l.data.identifier};f.type===o&&r.safeDispatchEvent(t,{detail:{name:f.name,identifier:f.identifier,handler:async()=>{e.postMessage({type:c,name:f.name,identifier:f.identifier}),await new Promise(u=>{let d=h=>{if(h?.data==null)return;let m={type:h.data.type,name:h.data.name,identifier:h.data.identifier};m.type===a&&m.identifier===f.identifier&&(e.removeEventListener("message",d),u())};e.addEventListener("message",d)})},onError:u=>{e.postMessage({type:s,name:f.name,identifier:f.identifier,error:{message:u.message,name:u.name,stack:u.stack}})}}}),f.type===i&&r.safeDispatchEvent(n,{detail:{name:f.name,identifier:f.identifier}}),f.type===t2&&r.safeDispatchEvent("finalizeRequest",{detail:{name:f.name}})};var mA=(r=10)=>Math.random().toString().substring(2,r+2);var n2=class{name;channel;constructor(e){this.name=e,this.channel=new BroadcastChannel(r2)}readLock(e){return this.sendRequest(q0,W0,G0,X0,z0,e)}writeLock(e){return this.sendRequest(Y0,Q0,J0,e2,Z0,e)}finalize(){this.channel.postMessage({type:t2,name:this.name}),this.channel.close()}async sendRequest(e,t,n,o,i,s){s?.signal?.throwIfAborted();let a=mA();return this.channel.postMessage({type:e,identifier:a,name:this.name}),new Promise((c,l)=>{let f=()=>{this.channel.postMessage({type:t,identifier:a,name:this.name})};s?.signal?.addEventListener("abort",f,{once:!0});let u=d=>{if(d.data?.identifier===a&&(d.data?.type===n&&(this.channel.removeEventListener("message",u),s?.signal?.removeEventListener("abort",f),c(()=>{this.channel.postMessage({type:i,identifier:a,name:this.name})})),d.data.type===o)){this.channel.removeEventListener("message",u),s?.signal?.removeEventListener("abort",f);let h=new Error;d.data.error!=null&&(h.message=d.data.error.message,h.name=d.data.error.name,h.stack=d.data.error.stack),l(h)}};this.channel.addEventListener("message",u)})}};var gA=r=>{if(r=Object.assign({},pA,r),!!globalThis.document||r.singleProcess){let t=new BroadcastChannel(r2),n=new _e;return t.addEventListener("message",q8(n,t,"requestReadLock","abortReadLockRequest",q0,W0,X0,z0,G0)),t.addEventListener("message",q8(n,t,"requestWriteLock","abortWriteLockRequest",Y0,Q0,e2,Z0,J0)),n}return new n2(r.name)};var _c=new Map,ph;function yA(r){return typeof r?.readLock=="function"&&typeof r?.writeLock=="function"}function IF(r){if(ph==null&&(ph=gA(r),!yA(ph))){let e=ph;e.addEventListener("requestReadLock",t=>{let n=t.detail.name,o=t.detail.identifier,i=_c.get(n);if(i==null)return;let s=new AbortController,a=c=>{c.detail.name!==n||c.detail.identifier!==o||s.abort()};e.addEventListener("abortReadLockRequest",a),i.readLock({signal:s.signal}).then(async c=>{await t.detail.handler().finally(()=>{c()})}).catch(c=>{t.detail.onError(c)}).finally(()=>{e.removeEventListener("abortReadLockRequest",a)})}),e.addEventListener("requestWriteLock",t=>{let n=t.detail.name,o=t.detail.identifier,i=_c.get(n);if(i==null)return;let s=new AbortController,a=c=>{c.detail.name!==n||c.detail.identifier!==o||s.abort()};e.addEventListener("abortWriteLockRequest",a),i.writeLock({signal:s.signal}).then(async c=>{await t.detail.handler().finally(()=>{c()})}).catch(c=>{t.detail.onError(c)}).finally(()=>{e.removeEventListener("abortWriteLockRequest",a)})}),e.addEventListener("finalizeRequest",t=>{let n=t.detail.name,o=_c.get(n);o?.finalize()})}return ph}async function W8(r,e){let t,n,o=new Promise((s,a)=>{t=s,n=a}),i=()=>{n(new Ln)};return e?.signal?.addEventListener("abort",i,{once:!0}),r.add(async()=>{await new Promise(s=>{t(()=>{e?.signal?.removeEventListener("abort",i),s()})})},{signal:e?.signal}).catch(s=>{n(s)}),o}var wA=(r,e)=>{let t=_c.get(r);if(t!=null)return t;let n=IF(e);if(yA(n))return t=n,_c.set(r,t),t;let o=new hh({concurrency:1}),i;return t={async readLock(s){if(i!=null)return W8(i,s);i=new hh({concurrency:e.concurrency,autoStart:!1});let a=i,c=W8(i,s);return o.add(async()=>{a.start(),await a.onIdle().then(()=>{i===a&&(i=null)})}),c},async writeLock(s){return i=null,W8(o,s)},finalize:()=>{_c.delete(r)},queue:o},_c.set(r,t),e.autoFinalize===!0&&o.addEventListener("idle",()=>{t.finalize()},{once:!0}),t};var CF={name:"lock",concurrency:1/0,singleProcess:!1,autoFinalize:!1};function mh(r){let e=Object.assign({},CF,r);return wA(e.name,e)}var o2=class{lock;child;pins;started;constructor(e,t,n={}){this.child=e,this.pins=t,this.lock=mh({singleProcess:n.holdGcLock}),this.started=!1}isStarted(){return this.started}async start(){await er(this.child),this.started=!0}async stop(){await or(this.child),this.started=!1}unwrap(){return this.child}async put(e,t,n={}){n?.signal?.throwIfAborted();let o=await this.lock.readLock();try{return await this.child.put(e,t,n)}finally{o()}}async*putMany(e,t={}){t?.signal?.throwIfAborted();let n=await this.lock.readLock();try{yield*this.child.putMany(e,t)}finally{n()}}async*get(e,t={}){t?.signal?.throwIfAborted();let n=await this.lock.readLock();try{yield*this.child.get(e,t)}finally{n()}}async*getMany(e,t={}){t?.signal?.throwIfAborted();let n=await this.lock.readLock();try{yield*this.child.getMany(e,t)}finally{n()}}async delete(e,t={}){t?.signal?.throwIfAborted();let n=await this.lock.writeLock();try{if(await this.pins.isPinned(e))throw new ch("Block was pinned - please unpin and try again");await this.child.delete(e,t)}finally{n()}}async*deleteMany(e,t={}){t?.signal?.throwIfAborted();let n=await this.lock.writeLock();try{let o=this;yield*this.child.deleteMany((async function*(){for await(let i of e){if(await o.pins.isPinned(i))throw new ch("Block was pinned - please unpin and try again");yield i}})(),t)}finally{n()}}async has(e,t={}){t?.signal?.throwIfAborted();let n=await this.lock.readLock();try{return await this.child.has(e,t)}finally{n()}}async*getAll(e={}){e?.signal?.throwIfAborted();let t=await this.lock.readLock();try{yield*this.child.getAll(e)}finally{t()}}createSession(e,t){return t?.signal?.throwIfAborted(),this.child.createSession(e,t)}};var z8=new ht("/version"),bA=1;async function vA(r){if(!await r.has(z8)){await r.put(z8,B(`${bA}`));return}let e=await r.get(z8),t=j(e);if(parseInt(t,10)!==bA)throw new L0("Invalid datastore version, a datastore migration may be required")}var Y8={};Nt(Y8,{code:()=>X8,decode:()=>UF,decodeOptions:()=>LF,encode:()=>MF,encodeOptions:()=>DF,name:()=>BF,toByteView:()=>EA});var xA=42;function EA(r){return r instanceof ArrayBuffer?new Uint8Array(r,0,r.byteLength):r}function PF(r){if(r.asCID!==r&&r["/"]!==r.bytes)return null;let e=he.asCID(r);if(!e)return null;let t=new Uint8Array(e.bytes.byteLength+1);return t.set(e.bytes,1),[new W(v.tag,xA),new W(v.bytes,t)]}function kF(){throw new Error("`undefined` is not supported by the IPLD Data Model and cannot be encoded")}function OF(r){if(Number.isNaN(r))throw new Error("`NaN` is not supported by the IPLD Data Model and cannot be encoded");if(r===1/0||r===-1/0)throw new Error("`Infinity` and `-Infinity` is not supported by the IPLD Data Model and cannot be encoded");return null}function RF(r){for(let e of r.keys())if(typeof e!="string"||e.length===0)throw new Error("Non-string Map keys are not supported by the IPLD Data Model and cannot be encoded");return null}var G8={float64:!0,typeEncoders:{Map:RF,Object:PF,undefined:kF,number:OF}},DF={...G8,typeEncoders:{...G8.typeEncoders}};function NF(r){if(r[0]!==0)throw new Error("Invalid CID for CBOR tag 42; expected leading 0x00");return he.decode(r.subarray(1))}var i2={allowIndefinite:!1,coerceUndefinedToNull:!0,allowNaN:!1,allowInfinity:!1,allowBigInt:!0,strict:!0,useMaps:!1,rejectDuplicateMapKeys:!0,tags:[]};i2.tags[xA]=NF;var LF={...i2,tags:i2.tags.slice()},BF="dag-cbor",X8=113,MF=r=>Qs(r,G8),UF=r=>Nn(EA(r),i2);var nw={};Nt(nw,{code:()=>rw,decode:()=>_A,encode:()=>SA,format:()=>XF,name:()=>GF,parse:()=>QF,stringify:()=>XF});var Q8=class extends Array{constructor(){super(),this.inRecursive=[]}prefix(e){let t=this.inRecursive[this.inRecursive.length-1];t&&(t.type===v.array&&(t.elements++,t.elements!==1&&e.push([44])),t.type===v.map&&(t.elements++,t.elements!==1&&(t.elements%2===1?e.push([44]):e.push([58]))))}[v.uint.major](e,t){this.prefix(e);let n=String(t.value),o=[];for(let i=0;i<n.length;i++)o[i]=n.charCodeAt(i);e.push(o)}[v.negint.major](e,t){this[v.uint.major](e,t)}[v.bytes.major](e,t){throw new Error(`${Wi} unsupported type: Uint8Array`)}[v.string.major](e,t){this.prefix(e);let n=f0(JSON.stringify(t.value));e.push(n.length>32?th(n):n)}[v.array.major](e,t){this.prefix(e),this.inRecursive.push({type:v.array,elements:0}),e.push([91])}[v.map.major](e,t){this.prefix(e),this.inRecursive.push({type:v.map,elements:0}),e.push([123])}[v.tag.major](e,t){}[v.float.major](e,t){if(t.type.name==="break"){let s=this.inRecursive.pop();if(s){if(s.type===v.array)e.push([93]);else if(s.type===v.map)e.push([125]);else throw new Error("Unexpected recursive type; this should not happen!");return}throw new Error("Unexpected break; this should not happen!")}if(t.value===void 0)throw new Error(`${Wi} unsupported type: undefined`);if(this.prefix(e),t.type.name==="true"){e.push([116,114,117,101]);return}else if(t.type.name==="false"){e.push([102,97,108,115,101]);return}else if(t.type.name==="null"){e.push([110,117,108,108]);return}let n=String(t.value),o=[],i=!1;for(let s=0;s<n.length;s++)o[s]=n.charCodeAt(s),!i&&(o[s]===46||o[s]===101||o[s]===69)&&(i=!0);i||(o.push(46),o.push(48)),e.push(o)}};function FF(r,e){if(Array.isArray(r[0])||Array.isArray(e[0]))throw new Error(`${Wi} complex map keys are not supported`);let t=r[0],n=e[0];if(t.type!==v.string||n.type!==v.string)throw new Error(`${Wi} non-string map keys are not supported`);if(t<n)return-1;if(t>n)return 1;throw new Error(`${Wi} unexpected duplicate map keys, this is not supported`)}var $F={addBreakTokens:!0,mapSorter:FF};function Z8(r,e){return e=Object.assign({},$F,e),E0(r,new Q8,e)}var ku=class{constructor(e,t={}){this._pos=0,this.data=e,this.options=t,this.modeStack=["value"],this.lastToken=""}pos(){return this._pos}done(){return this._pos>=this.data.length}ch(){return this.data[this._pos]}currentMode(){return this.modeStack[this.modeStack.length-1]}skipWhitespace(){let e=this.ch();for(;e===32||e===9||e===13||e===10;)e=this.data[++this._pos]}expect(e){if(this.data.length-this._pos<e.length)throw new Error(`${ye} unexpected end of input at position ${this._pos}`);for(let t=0;t<e.length;t++)if(this.data[this._pos++]!==e[t])throw new Error(`${ye} unexpected token at position ${this._pos}, expected to find '${String.fromCharCode(...e)}'`)}parseNumber(){let e=this._pos,t=!1,n=!1,o=a=>{for(;!this.done();){let c=this.ch();if(a.includes(c))this._pos++;else break}};if(this.ch()===45&&(t=!0,this._pos++),this.ch()===48)if(this._pos++,this.ch()===46)this._pos++,n=!0;else return new W(v.uint,0,this._pos-e);if(o([48,49,50,51,52,53,54,55,56,57]),t&&this._pos===e+1)throw new Error(`${ye} unexpected token at position ${this._pos}`);if(!this.done()&&this.ch()===46){if(n)throw new Error(`${ye} unexpected token at position ${this._pos}`);n=!0,this._pos++,o([48,49,50,51,52,53,54,55,56,57])}!this.done()&&(this.ch()===101||this.ch()===69)&&(n=!0,this._pos++,!this.done()&&(this.ch()===43||this.ch()===45)&&this._pos++,o([48,49,50,51,52,53,54,55,56,57]));let i=String.fromCharCode.apply(null,this.data.subarray(e,this._pos)),s=parseFloat(i);return n?new W(v.float,s,this._pos-e):this.options.allowBigInt!==!0||Number.isSafeInteger(s)?new W(s>=0?v.uint:v.negint,s,this._pos-e):new W(s>=0?v.uint:v.negint,BigInt(i),this._pos-e)}parseString(){if(this.ch()!==34)throw new Error(`${ye} unexpected character at position ${this._pos}; this shouldn't happen`);this._pos++;for(let i=this._pos,s=0;i<this.data.length&&s<65536;i++,s++){let a=this.data[i];if(a===92||a<32||a>=128)break;if(a===34){let c=String.fromCharCode.apply(null,this.data.subarray(this._pos,i));return this._pos=i+1,new W(v.string,c,s)}}let e=this._pos,t=[],n=()=>{if(this._pos+4>=this.data.length)throw new Error(`${ye} unexpected end of unicode escape sequence at position ${this._pos}`);let i=0;for(let s=0;s<4;s++){let a=this.ch();if(a>=48&&a<=57)a-=48;else if(a>=97&&a<=102)a=a-97+10;else if(a>=65&&a<=70)a=a-65+10;else throw new Error(`${ye} unexpected unicode escape character at position ${this._pos}`);i=i*16+a,this._pos++}return i},o=()=>{let i=this.ch(),s=null,a=i>239?4:i>223?3:i>191?2:1;if(this._pos+a>this.data.length)throw new Error(`${ye} unexpected unicode sequence at position ${this._pos}`);let c,l,f,u;switch(a){case 1:i<128&&(s=i);break;case 2:c=this.data[this._pos+1],(c&192)===128&&(u=(i&31)<<6|c&63,u>127&&(s=u));break;case 3:c=this.data[this._pos+1],l=this.data[this._pos+2],(c&192)===128&&(l&192)===128&&(u=(i&15)<<12|(c&63)<<6|l&63,u>2047&&(u<55296||u>57343)&&(s=u));break;case 4:c=this.data[this._pos+1],l=this.data[this._pos+2],f=this.data[this._pos+3],(c&192)===128&&(l&192)===128&&(f&192)===128&&(u=(i&15)<<18|(c&63)<<12|(l&63)<<6|f&63,u>65535&&u<1114112&&(s=u))}s===null?(s=65533,a=1):s>65535&&(s-=65536,t.push(s>>>10&1023|55296),s=56320|s&1023),t.push(s),this._pos+=a};for(;!this.done();){let i=this.ch(),s;switch(i){case 92:if(this._pos++,this.done())throw new Error(`${ye} unexpected string termination at position ${this._pos}`);switch(s=this.ch(),this._pos++,s){case 34:case 39:case 92:case 47:t.push(s);break;case 98:t.push(8);break;case 116:t.push(9);break;case 110:t.push(10);break;case 102:t.push(12);break;case 114:t.push(13);break;case 117:t.push(n());break;default:throw new Error(`${ye} unexpected string escape character at position ${this._pos}`)}break;case 34:return this._pos++,new W(v.string,E8(t),this._pos-e);default:if(i<32)throw new Error(`${ye} invalid control character at position ${this._pos}`);i<128?(t.push(i),this._pos++):o()}}throw new Error(`${ye} unexpected end of string at position ${this._pos}`)}parseValue(){switch(this.ch()){case 123:return this.modeStack.push("obj-start"),this._pos++,new W(v.map,1/0,1);case 91:return this.modeStack.push("array-start"),this._pos++,new W(v.array,1/0,1);case 34:return this.parseString();case 110:return this.expect([110,117,108,108]),new W(v.null,null,4);case 102:return this.expect([102,97,108,115,101]),new W(v.false,!1,5);case 116:return this.expect([116,114,117,101]),new W(v.true,!0,4);case 45:case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:return this.parseNumber();default:throw new Error(`${ye} unexpected character at position ${this._pos}`)}}next(){switch(this.skipWhitespace(),this.currentMode()){case"value":return this.modeStack.pop(),this.parseValue();case"array-value":{if(this.modeStack.pop(),this.ch()===93)return this._pos++,this.skipWhitespace(),new W(v.break,void 0,1);if(this.ch()!==44)throw new Error(`${ye} unexpected character at position ${this._pos}, was expecting array delimiter but found '${String.fromCharCode(this.ch())}'`);return this._pos++,this.modeStack.push("array-value"),this.skipWhitespace(),this.parseValue()}case"array-start":return this.modeStack.pop(),this.ch()===93?(this._pos++,this.skipWhitespace(),new W(v.break,void 0,1)):(this.modeStack.push("array-value"),this.skipWhitespace(),this.parseValue());case"obj-key":if(this.ch()===125)return this.modeStack.pop(),this._pos++,this.skipWhitespace(),new W(v.break,void 0,1);if(this.ch()!==44)throw new Error(`${ye} unexpected character at position ${this._pos}, was expecting object delimiter but found '${String.fromCharCode(this.ch())}'`);this._pos++,this.skipWhitespace();case"obj-start":{if(this.modeStack.pop(),this.ch()===125)return this._pos++,this.skipWhitespace(),new W(v.break,void 0,1);let e=this.parseString();if(this.skipWhitespace(),this.ch()!==58)throw new Error(`${ye} unexpected character at position ${this._pos}, was expecting key/value delimiter ':' but found '${String.fromCharCode(this.ch())}'`);return this._pos++,this.modeStack.push("obj-value"),e}case"obj-value":return this.modeStack.pop(),this.modeStack.push("obj-key"),this.skipWhitespace(),this.parseValue();default:throw new Error(`${ye} unexpected parse state at position ${this._pos}; this shouldn't happen`)}}};function J8(r,e){return e=Object.assign({tokenizer:new ku(r,e)},e),Nn(r,e)}function KF(r){return r instanceof ArrayBuffer?new Uint8Array(r,0,r.byteLength):r}function VF(r){if(r.asCID!==r&&r["/"]!==r.bytes)return null;let e=he.asCID(r);if(!e)return null;let t=e.toString();return[new W(v.map,1/0,1),new W(v.string,"/",1),new W(v.string,t,t.length),new W(v.break,void 0,1)]}function s2(r){let e=Ht.encode(r).slice(1);return[new W(v.map,1/0,1),new W(v.string,"/",1),new W(v.map,1/0,1),new W(v.string,"bytes",5),new W(v.string,e,e.length),new W(v.break,void 0,1),new W(v.break,void 0,1)]}function ko(r){return s2(new Uint8Array(r.buffer,r.byteOffset,r.byteLength))}function HF(r){return s2(new Uint8Array(r))}function qF(){throw new Error("`undefined` is not supported by the IPLD Data Model and cannot be encoded")}function WF(r){if(Number.isNaN(r))throw new Error("`NaN` is not supported by the IPLD Data Model and cannot be encoded");if(r===1/0||r===-1/0)throw new Error("`Infinity` and `-Infinity` is not supported by the IPLD Data Model and cannot be encoded");return null}var zF={typeEncoders:{Object:VF,Buffer:s2,Uint8Array:s2,Int8Array:ko,Uint16Array:ko,Int16Array:ko,Uint32Array:ko,Int32Array:ko,Float32Array:ko,Float64Array:ko,Uint8ClampedArray:ko,BigInt64Array:ko,BigUint64Array:ko,DataView:ko,ArrayBuffer:HF,undefined:qF,number:WF}},ew=class extends ku{constructor(e,t){super(e,t),this.tokenBuffer=[]}done(){return this.tokenBuffer.length===0&&super.done()}_next(){return this.tokenBuffer.length>0?this.tokenBuffer.pop():super.next()}next(){let e=this._next();if(e.type===v.map){let t=this._next();if(t.type===v.string&&t.value==="/"){let n=this._next();if(n.type===v.string){if(this._next().type!==v.break)throw new Error("Invalid encoded CID form");return this.tokenBuffer.push(n),new W(v.tag,42,0)}if(n.type===v.map){let o=this._next();if(o.type===v.string&&o.value==="bytes"){let i=this._next();if(i.type===v.string){for(let a=0;a<2;a++)if(this._next().type!==v.break)throw new Error("Invalid encoded Bytes form");let s=Ht.decode(`m${i.value}`);return new W(v.bytes,s,i.value.length)}this.tokenBuffer.push(i)}this.tokenBuffer.push(o)}this.tokenBuffer.push(n)}this.tokenBuffer.push(t)}return e}},tw={allowIndefinite:!1,allowUndefined:!1,allowNaN:!1,allowInfinity:!1,allowBigInt:!0,strict:!0,useMaps:!1,rejectDuplicateMapKeys:!0,tags:[]};tw.tags[42]=he.parse;var GF="dag-json",rw=297,SA=r=>Z8(r,zF),_A=r=>{let e=KF(r),t=Object.assign(tw,{tokenizer:new ew(e,tw)});return J8(e,t)},XF=r=>YF.decode(SA(r));var YF=new TextDecoder,QF=r=>_A(ZF.encode(r)),ZF=new TextEncoder;var lw={};Nt(lw,{code:()=>cw,createLink:()=>NA,createNode:()=>DA,decode:()=>f$,encode:()=>u$,name:()=>l$,prepare:()=>sw,validate:()=>aw});var JF=new TextDecoder;function ow(r,e){let t=0;for(let n=0;;n+=7){if(n>=64)throw new Error("protobuf: varint overflow");if(e>=r.length)throw new Error("protobuf: unexpected end of data");let o=r[e++];if(t+=n<28?(o&127)<<n:(o&127)*2**n,o<128)break}return[t,e]}function a2(r,e){let t;[t,e]=ow(r,e);let n=e+t;if(t<0||n<0)throw new Error("protobuf: invalid length");if(n>r.length)throw new Error("protobuf: unexpected end of data");return[r.subarray(e,n),n]}function AA(r,e){let t;return[t,e]=ow(r,e),[t&7,t>>3,e]}function e$(r){let e={},t=r.length,n=0;for(;n<t;){let o,i;if([o,i,n]=AA(r,n),i===1){if(e.Hash)throw new Error("protobuf: (PBLink) duplicate Hash section");if(o!==2)throw new Error(`protobuf: (PBLink) wrong wireType (${o}) for Hash`);if(e.Name!==void 0)throw new Error("protobuf: (PBLink) invalid order, found Name before Hash");if(e.Tsize!==void 0)throw new Error("protobuf: (PBLink) invalid order, found Tsize before Hash");[e.Hash,n]=a2(r,n)}else if(i===2){if(e.Name!==void 0)throw new Error("protobuf: (PBLink) duplicate Name section");if(o!==2)throw new Error(`protobuf: (PBLink) wrong wireType (${o}) for Name`);if(e.Tsize!==void 0)throw new Error("protobuf: (PBLink) invalid order, found Tsize before Name");let s;[s,n]=a2(r,n),e.Name=JF.decode(s)}else if(i===3){if(e.Tsize!==void 0)throw new Error("protobuf: (PBLink) duplicate Tsize section");if(o!==0)throw new Error(`protobuf: (PBLink) wrong wireType (${o}) for Tsize`);[e.Tsize,n]=ow(r,n)}else throw new Error(`protobuf: (PBLink) invalid fieldNumber, expected 1, 2 or 3, got ${i}`)}if(n>t)throw new Error("protobuf: (PBLink) unexpected end of data");return e}function TA(r){let e=r.length,t=0,n,o=!1,i;for(;t<e;){let a,c;if([a,c,t]=AA(r,t),a!==2)throw new Error(`protobuf: (PBNode) invalid wireType, expected 2, got ${a}`);if(c===1){if(i)throw new Error("protobuf: (PBNode) duplicate Data section");[i,t]=a2(r,t),n&&(o=!0)}else if(c===2){if(o)throw new Error("protobuf: (PBNode) duplicate Links section");n||(n=[]);let l;[l,t]=a2(r,t),n.push(e$(l))}else throw new Error(`protobuf: (PBNode) invalid fieldNumber, expected 1 or 2, got ${c}`)}if(t>e)throw new Error("protobuf: (PBNode) unexpected end of data");let s={};return i&&(s.Data=i),s.Links=n||[],s}var CA=new TextEncoder,IA=2**32,t$=2**31;function r$(r,e){let t=e.length;if(typeof r.Tsize=="number"){if(r.Tsize<0)throw new Error("Tsize cannot be negative");if(!Number.isSafeInteger(r.Tsize))throw new Error("Tsize too large for encoding");t=gh(e,t,r.Tsize)-1,e[t]=24}if(typeof r.Name=="string"){let n=CA.encode(r.Name);t-=n.length,e.set(n,t),t=gh(e,t,n.length)-1,e[t]=18}return r.Hash&&(t-=r.Hash.length,e.set(r.Hash,t),t=gh(e,t,r.Hash.length)-1,e[t]=10),e.length-t}function PA(r){let e=o$(r),t=new Uint8Array(e),n=e;if(r.Data&&(n-=r.Data.length,t.set(r.Data,n),n=gh(t,n,r.Data.length)-1,t[n]=10),r.Links)for(let o=r.Links.length-1;o>=0;o--){let i=r$(r.Links[o],t.subarray(0,n));n-=i,n=gh(t,n,i)-1,t[n]=18}return t}function n$(r){let e=0;if(r.Hash){let t=r.Hash.length;e+=1+t+Ou(t)}if(typeof r.Name=="string"){let t=CA.encode(r.Name).length;e+=1+t+Ou(t)}return typeof r.Tsize=="number"&&(e+=1+Ou(r.Tsize)),e}function o$(r){let e=0;if(r.Data){let t=r.Data.length;e+=1+t+Ou(t)}if(r.Links)for(let t of r.Links){let n=n$(t);e+=1+n+Ou(n)}return e}function gh(r,e,t){e-=Ou(t);let n=e;for(;t>=t$;)r[e++]=t&127|128,t/=128;for(;t>=128;)r[e++]=t&127|128,t>>>=7;return r[e]=t,n}function Ou(r){return r%2===0&&r++,Math.floor((i$(r)+6)/7)}function i$(r){let e=0;return r>=IA&&(r=Math.floor(r/IA),e=32),r>=65536&&(r>>>=16,e+=16),r>=256&&(r>>>=8,e+=8),e+s$[r]}var s$=[0,1,2,2,3,3,3,3,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8];var a$=["Data","Links"],c$=["Hash","Name","Tsize"],iw=new TextEncoder;function OA(r,e){if(r===e)return 0;let t=r.Name?iw.encode(r.Name):[],n=e.Name?iw.encode(e.Name):[],o=t.length,i=n.length;for(let s=0,a=Math.min(o,i);s<a;++s)if(t[s]!==n[s]){o=t[s],i=n[s];break}return o<i?-1:i<o?1:0}function kA(r,e){return!Object.keys(r).some(t=>!e.includes(t))}function RA(r){if(typeof r.asCID=="object"){let t=he.asCID(r);if(!t)throw new TypeError("Invalid DAG-PB form");return{Hash:t}}if(typeof r!="object"||Array.isArray(r))throw new TypeError("Invalid DAG-PB form");let e={};if(r.Hash){let t=he.asCID(r.Hash);try{t||(typeof r.Hash=="string"?t=he.parse(r.Hash):r.Hash instanceof Uint8Array&&(t=he.decode(r.Hash)))}catch(n){throw new TypeError(`Invalid DAG-PB form: ${n.message}`)}t&&(e.Hash=t)}if(!e.Hash)throw new TypeError("Invalid DAG-PB form");return typeof r.Name=="string"&&(e.Name=r.Name),typeof r.Tsize=="number"&&(e.Tsize=r.Tsize),e}function sw(r){if((r instanceof Uint8Array||typeof r=="string")&&(r={Data:r}),typeof r!="object"||Array.isArray(r))throw new TypeError("Invalid DAG-PB form");let e={};if(r.Data!==void 0)if(typeof r.Data=="string")e.Data=iw.encode(r.Data);else if(r.Data instanceof Uint8Array)e.Data=r.Data;else throw new TypeError("Invalid DAG-PB form");if(r.Links!==void 0)if(Array.isArray(r.Links))e.Links=r.Links.map(RA),e.Links.sort(OA);else throw new TypeError("Invalid DAG-PB form");else e.Links=[];return e}function aw(r){if(!r||typeof r!="object"||Array.isArray(r)||r instanceof Uint8Array||r["/"]&&r["/"]===r.bytes)throw new TypeError("Invalid DAG-PB form");if(!kA(r,a$))throw new TypeError("Invalid DAG-PB form (extraneous properties)");if(r.Data!==void 0&&!(r.Data instanceof Uint8Array))throw new TypeError("Invalid DAG-PB form (Data must be bytes)");if(!Array.isArray(r.Links))throw new TypeError("Invalid DAG-PB form (Links must be a list)");for(let e=0;e<r.Links.length;e++){let t=r.Links[e];if(!t||typeof t!="object"||Array.isArray(t)||t instanceof Uint8Array||t["/"]&&t["/"]===t.bytes)throw new TypeError("Invalid DAG-PB form (bad link)");if(!kA(t,c$))throw new TypeError("Invalid DAG-PB form (extraneous properties on link)");if(t.Hash===void 0)throw new TypeError("Invalid DAG-PB form (link must have a Hash)");if(t.Hash==null||!t.Hash["/"]||t.Hash["/"]!==t.Hash.bytes)throw new TypeError("Invalid DAG-PB form (link Hash must be a CID)");if(t.Name!==void 0&&typeof t.Name!="string")throw new TypeError("Invalid DAG-PB form (link Name must be a string)");if(t.Tsize!==void 0){if(typeof t.Tsize!="number"||t.Tsize%1!==0)throw new TypeError("Invalid DAG-PB form (link Tsize must be an integer)");if(t.Tsize<0)throw new TypeError("Invalid DAG-PB form (link Tsize cannot be negative)")}if(e>0&&OA(t,r.Links[e-1])===-1)throw new TypeError("Invalid DAG-PB form (links must be sorted by Name bytes)")}}function DA(r,e=[]){return sw({Data:r,Links:e})}function NA(r,e,t){return RA({Hash:t,Name:r,Tsize:e})}function LA(r){return r instanceof ArrayBuffer?new Uint8Array(r,0,r.byteLength):r}var l$="dag-pb",cw=112;function u$(r){aw(r);let e={};return r.Links&&(e.Links=r.Links.map(t=>{let n={};return t.Hash&&(n.Hash=t.Hash.bytes),t.Name!==void 0&&(n.Name=t.Name),t.Tsize!==void 0&&(n.Tsize=t.Tsize),n})),r.Data&&(e.Data=r.Data),PA(e)}function f$(r){let e=LA(r),t=TA(e),n={};return t.Data&&(n.Data=t.Data),t.Links&&(n.Links=t.Links.map(o=>{let i={};try{i.Hash=he.decode(o.Hash)}catch{}if(!i.Hash)throw new Error("Invalid Hash field found in link, expected CID");return o.Name!==void 0&&(i.Name=o.Name),o.Tsize!==void 0&&(i.Tsize=o.Tsize),i})),n}function Ru(r){return r?.then!=null}function BA(r=[],e){let t={[cw]:lw,[Ga]:jl,[X8]:Y8,[rw]:nw,[I6]:pm};return r.forEach(n=>{t[n.code]=n}),async n=>{let o=t[n];if(o==null&&e!=null){let i=e(n);Ru(i)?o=await i:o=i,t[o.code]=o}if(o!=null)return o;throw new dh(`Could not load codec for ${n}`)}}function MA(r=[],e){let t={[St.code]:St,[gm.code]:gm,[Dr.code]:Dr};return r.forEach(n=>{t[n.code]=n}),async n=>{let o=t[n];if(o==null&&e!=null){let i=e(n);Ru(i)?o=await i:o=i,t[o.code]=o}if(o!=null)return o;throw new fh(`No hasher configured for multihash code 0x${n.toString(16)}, please configure one. You can look up which hash this is at https://github.com/multiformats/multicodec/blob/master/table.csv`)}}var eo=class r extends Error{static name="NotFoundError";static code="ERR_NOT_FOUND";name=r.name;code=r.code;constructor(e="Not Found"){super(e)}};var Yi=class{has(e,t){return Promise.reject(new Error(".has is not implemented"))}put(e,t,n){return Promise.reject(new Error(".put is not implemented"))}async*putMany(e,t){for await(let{cid:n,bytes:o}of e)await this.put(n,o,t),yield n}get(e,t){throw new Error(".get is not implemented")}async*getMany(e,t){for await(let n of e)yield{cid:n,bytes:this.get(n,t)}}delete(e,t){return Promise.reject(new Error(".delete is not implemented"))}async*deleteMany(e,t){for await(let n of e)await this.delete(n,t),yield n}async*getAll(e){throw new Error(".getAll is not implemented")}};var c2=0,Du=class extends Error{static name="IdentityHashDigestTooLongError";name="IdentityHashDigestTooLongError"},l2=class extends Yi{child;maxDigestLength;constructor(e,t){super(),this.child=e,this.maxDigestLength=t?.maxDigestLength}put(e,t,n){if(e.multihash.code===c2){if(this.maxDigestLength!=null&&e.multihash.digest.byteLength>this.maxDigestLength)throw new Du(`Identity digest too long - ${e.multihash.digest.byteLength} > this.maxDigestLength`);return n?.signal?.throwIfAborted(),e}return this.child==null?(n?.signal?.throwIfAborted(),e):this.child.put(e,t,n)}*get(e,t){if(e.multihash.code===c2){if(this.maxDigestLength!=null&&e.multihash.digest.byteLength>this.maxDigestLength)throw new Du(`Identity digest too long - ${e.multihash.digest.byteLength} > this.maxDigestLength`);t?.signal?.throwIfAborted(),yield e.multihash.digest;return}if(this.child==null)throw t?.signal?.throwIfAborted(),new eo;yield*this.child.get(e,t)}has(e,t){if(e.multihash.code===c2){if(this.maxDigestLength!=null&&e.multihash.digest.byteLength>this.maxDigestLength)throw new Du(`Identity digest too long - ${e.multihash.digest.byteLength} > this.maxDigestLength`);return t?.signal?.throwIfAborted(),!0}return this.child==null?(t?.signal?.throwIfAborted(),!1):this.child.has(e,t)}delete(e,t){if(e.code===c2){if(this.maxDigestLength!=null&&e.multihash.digest.byteLength>this.maxDigestLength)throw new Du(`Identity digest too long - ${e.multihash.digest.byteLength} > this.maxDigestLength`);t?.signal?.throwIfAborted();return}if(this.child!=null)return this.child.delete(e,t)}*getAll(e){this.child!=null&&(yield*this.child.getAll(e)),e?.signal?.throwIfAborted()}};function d$(r){let[e,t]=r[Symbol.asyncIterator]!=null?[r[Symbol.asyncIterator](),Symbol.asyncIterator]:[r[Symbol.iterator](),Symbol.iterator],n=[];return{peek:()=>e.next(),push:o=>{n.push(o)},next:()=>n.length>0?{done:!1,value:n.shift()}:e.next(),[t](){return this}}}var Nu=d$;function h$(r){return r[Symbol.asyncIterator]!=null}function p$(r,e){let t=0;if(h$(r))return(async function*(){for await(let c of r)await e(c,t++)&&(yield c)})();let n=Nu(r),{value:o,done:i}=n.next();if(i===!0)return(function*(){})();let s=e(o,t++);if(typeof s.then=="function")return(async function*(){await s&&(yield o);for(let c of n)await e(c,t++)&&(yield c)})();let a=e;return(function*(){s===!0&&(yield o);for(let c of n)a(c,t++)&&(yield c)})()}var Oo=p$;function m$(r){return r[Symbol.asyncIterator]!=null}function UA(r){return r?.then!=null}function g$(r,e){let t=0;if(m$(r))return(async function*(){for await(let c of r){let l=e(c,t++);UA(l)&&await l,yield c}})();let n=Nu(r),{value:o,done:i}=n.next();if(i===!0)return(function*(){})();let s=e(o,t++);if(typeof s?.then=="function")return(async function*(){await s,yield o;for(let c of n){let l=e(c,t++);UA(l)&&await l,yield c}})();let a=e;return(function*(){yield o;for(let c of n)a(c,t++),yield c})()}var uw=g$;var y$=128,u2=class{child;getHasher;log;logger;components;constructor(e,t={}){this.log=e.logger.forComponent("helia:networked-storage"),this.logger=e.logger,this.components=e,this.child=new l2(e.blockstore,{maxDigestLength:t.maxIdentityHashDigestLength??y$}),this.getHasher=e.getHasher}async put(e,t,n={}){return await this.child.has(e,n)?(n.onProgress?.(new oe("blocks:put:duplicate",e)),e):(n.onProgress?.(new oe("blocks:put:providers:notify",e)),await Promise.all(this.components.blockBrokers.map(async o=>o.announce?.(e,n))),n.onProgress?.(new oe("blocks:put:blockstore:put",e)),this.child.put(e,t,n))}async*putMany(e,t={}){let n=Oo(e,async({cid:i})=>{let s=await this.child.has(i,t);return s&&t.onProgress?.(new oe("blocks:put-many:duplicate",i)),!s}),o=uw(n,async({cid:i})=>{t.onProgress?.(new oe("blocks:put-many:providers:notify",i)),await Promise.all(this.components.blockBrokers.map(async s=>s.announce?.(i,t)))});t.onProgress?.(new oe("blocks:put-many:blockstore:put-many")),yield*this.child.putMany(o,t)}async*get(e,t={}){let n=await this.child.has(e,t),o=t.offline===!0;if(!n){if(o)throw new lh("The block was present in the blockstore and the node is running offline so cannot fetch it");let i=await this.getHasher(e.multihash.code);t?.signal?.throwIfAborted(),t.onProgress?.(new oe("blocks:get:providers:get",e));let s=await FA(e,this.components.blockBrokers,i,{...t,log:this.log});t.onProgress?.(new oe("blocks:get:blockstore:put",e)),await this.child.put(e,s,t),t.onProgress?.(new oe("blocks:get:providers:notify",e)),await Promise.all(this.components.blockBrokers.map(async a=>a.announce?.(e,t))),yield s;return}t.onProgress?.(new oe("blocks:get:blockstore:get",e)),yield*this.child.get(e,t)}async*getMany(e,t={}){t.onProgress?.(new oe("blocks:get-many:blockstore:get-many")),yield*this.child.getMany(uw(e,async n=>{let o=await this.child.has(n,t),i=t.offline===!0;if(!o){if(i)throw new lh("The block was present in the blockstore and the node is running offline so cannot fetch it");let s=await this.getHasher(n.multihash.code);t?.signal?.throwIfAborted(),t.onProgress?.(new oe("blocks:get-many:providers:get",n));let a=await FA(n,this.components.blockBrokers,s,{...t,log:this.log});t.onProgress?.(new oe("blocks:get-many:blockstore:put",n)),await this.child.put(n,a,t),t.onProgress?.(new oe("blocks:get-many:providers:notify",n)),await Promise.all(this.components.blockBrokers.map(async c=>c.announce?.(n,t)))}}))}async delete(e,t={}){t.onProgress?.(new oe("blocks:delete:blockstore:delete",e)),await this.child.delete(e,t)}async*deleteMany(e,t={}){t.onProgress?.(new oe("blocks:delete-many:blockstore:delete-many")),yield*this.child.deleteMany((async function*(){for await(let n of e)yield n})(),t)}async has(e,t={}){return this.child.has(e,t)}async*getAll(e={}){e.onProgress?.(new oe("blocks:get-all:blockstore:get-many")),yield*this.child.getAll(e)}},f2=class extends u2{started;constructor(e,t={}){super(e,t),this.started=!1}isStarted(){return this.started}async start(){await er(this.child,...this.components.blockBrokers),this.started=!0}async stop(){await or(this.child,...this.components.blockBrokers),this.started=!1}unwrap(){return this.child}createSession(e,t){let n=this.components.blockBrokers.map(o=>o.createSession==null?o:o.createSession(t));return new fw({blockstore:this.child,blockBrokers:n,getHasher:this.getHasher,logger:this.logger},{root:e})}},fw=class extends u2{closeController;constructor(e,t){super(e),this.closeController=new AbortController,this.closeController.signal,this.log=e.logger.forComponent(`helia:session-storage:${t.root}`)}close(){this.closeController.abort()}async put(e,t,n={}){let o=De([this.closeController.signal,n.signal]);try{return await super.put(e,t,{...n,signal:o})}finally{o.clear()}}async*putMany(e,t={}){let n=De([this.closeController.signal,t.signal]);try{yield*super.putMany(e,{...t,signal:n})}finally{n.clear()}}async*get(e,t={}){let n=De([this.closeController.signal,t.signal]);try{yield*super.get(e,{...t,signal:n})}finally{n.clear()}}async*getMany(e,t={}){let n=De([this.closeController.signal,t.signal]);try{yield*super.getMany(e,{...t,signal:n})}finally{n.clear()}}async delete(e,t={}){let n=De([this.closeController.signal,t.signal]);try{await super.delete(e,{...t,signal:n})}finally{n.clear()}}async*deleteMany(e,t={}){let n=De([this.closeController.signal,t.signal]);try{yield*super.deleteMany(e,{...t,signal:n})}finally{n.clear()}}async has(e,t={}){let n=De([this.closeController.signal,t.signal]);try{return await super.has(e,{...t,signal:n})}finally{n.clear()}}async*getAll(e={}){let t=De([this.closeController.signal,e.signal]);try{yield*super.getAll({...e,signal:t})}finally{t.clear()}}};function w$(r){return typeof r.retrieve=="function"}var b$=(r,e)=>{if(e==null)throw new P(`No hasher configured for multihash code 0x${r.multihash.code.toString(16)}, please configure one. You can look up which hash this is at https://github.com/multiformats/multicodec/blob/master/table.csv`);return async t=>{let n,o=e.digest(t,{truncate:r.multihash.digest.byteLength});if(Ru(o)?n=await o:n=o,!we(n.digest,r.multihash.digest))throw new Cs("Hash of downloaded block did not match multihash from passed CID")}};async function FA(r,e,t,n){let o=b$(r,t),i=new AbortController,s=De([i.signal,n.signal]);i.signal;let a=[];for(let c of e)w$(c)&&a.push(c);if(a.length===0)throw new B0(`No block brokers capable of retrieving blocks are configured, the CID ${r} cannot be fetched from the network`);try{return await Promise.any(a.map(async c=>{try{let l=!1,f=await c.retrieve(r,{...n,signal:s,validateFn:async u=>{await o(u),n.signal?.throwIfAborted(),l=!0}});return l||(await o(f),n.signal?.throwIfAborted()),f}catch(l){throw n.log.error("could not retrieve verified block for %c - %e",r,l),l}}))}catch(c){throw new U0(c.errors,`Failed to load block for ${r}`)}finally{i.abort(),s.clear()}}var Ac=class extends _e{initialPeerSearchComplete;requests;name;log;logger;minProviders;maxProviders;providers;evictionFilter;initialProviders;constructor(e,t){super(),this.name=t.name,this.logger=e.logger,this.log=e.logger.forComponent(this.name),this.requests=new Map,this.minProviders=t.minProviders??1,this.maxProviders=t.maxProviders??5,this.providers=[],this.evictionFilter=Fr(this.maxProviders),this.initialProviders=t.providers??[]}async retrieve(e,t={}){let n=Ht.encode(e.multihash.bytes),o=this.requests.get(n);if(o!=null)return this.log("join existing request for %c",e),o;let i=Ve();if(this.requests.set(n,i.promise),this.providers.length===0){let f=!1;this.initialPeerSearchComplete==null&&(f=!0,this.log=this.logger.forComponent(`${this.name}:${e}`),this.initialPeerSearchComplete=this.findProviders(e,this.minProviders,t));try{await ut(this.initialPeerSearchComplete,t.signal),f&&this.log("found initial session peers for %c",e)}catch(u){throw f&&this.log("failed to find initial session peers for %c - %e",e,u),this.requests.delete(n),i.reject(u),u}}let s=!1,a=new yr({concurrency:this.maxProviders});a.addEventListener("failure",f=>{this.log.error("error querying provider %s, evicting from session - %e",f.detail.job.options.provider,f.detail.error),this.evict(f.detail.job.options.provider)}),a.addEventListener("success",f=>{s=!0,i.resolve(f.detail.result)}),a.addEventListener("idle",()=>{if(s){this.log.trace("session idle, found block");return}if(t.signal?.aborted===!0){this.log.trace("session idle, signal aborted");return}Promise.resolve().then(async()=>{this.log("no session peers had block for for %c, finding new providers",e);for(let f=0;f<this.minProviders&&this.providers.length!==0;f++){let u=this.providers[Math.floor(Math.random()*this.providers.length)];this.evict(u)}await this.findProviders(e,this.minProviders,t),this.log("found new providers re-retrieving %c",e),this.requests.delete(n),i.resolve(await this.retrieve(e,t))}).catch(f=>{this.log.error("could not find new providers for %c - %e",e,f),i.reject(f)})});let c=f=>{a.add(async()=>this.queryProvider(e,f.detail,t),{provider:f.detail}).catch(u=>{t.signal?.aborted!==!0&&this.log.error("error retrieving session block for %c - %e",e,u)})};this.addEventListener("provider",c),Promise.all([...this.providers].map(async f=>a.add(async()=>this.queryProvider(e,f,t),{provider:f}))).catch(f=>{t.signal?.aborted!==!0&&this.log.error("error retrieving session block for %c - %e",e,f)});let l=()=>{i.reject(new Hr(t.signal?.reason??"Session aborted")),a.abort()};t.signal?.addEventListener("abort",l);try{return await ut(i.promise,t.signal)}finally{this.removeEventListener("provider",c),t.signal?.removeEventListener("abort",l),a.clear(),this.requests.delete(n)}}evict(e){this.evictionFilter.add(this.toEvictionKey(e));let t=this.providers.findIndex(n=>this.equals(n,e));t!==-1&&this.providers.splice(t,1)}isEvicted(e){return this.evictionFilter.has(this.toEvictionKey(e))}hasProvider(e){return!!(this.providers.find(t=>this.equals(t,e))!=null||this.isEvicted(e))}async findProviders(e,t,n){let o=Ve(),i=0;return Promise.resolve().then(async()=>{if(this.log("finding %d-%d new provider(s) for %c",t,this.maxProviders,e),this.initialProviders.length>0)for(;i<t&&this.initialProviders.length>0;){let s=this.initialProviders.pop();if(s==null)break;let a=await this.convertToProvider(s,n);if(n.signal?.aborted===!0)break;if(a!=null&&!this.hasProvider(a)&&(this.log("found %d/%d new providers",i,this.maxProviders),this.providers.push(a),this.safeDispatchEvent("provider",{detail:a}),i++,i===t&&(this.log("session is ready"),o.resolve()),this.providers.length===this.maxProviders)){this.log("found max session peers",i);break}}if(i<this.maxProviders)for await(let s of this.findNewProviders(e,n)){if(i===this.maxProviders||n.signal?.aborted===!0)break;if(!this.hasProvider(s)&&(this.log("found %d/%d new providers",i,this.maxProviders),this.providers.push(s),this.safeDispatchEvent("provider",{detail:s}),i++,i===t&&(this.log("session is ready"),o.resolve()),this.providers.length===this.maxProviders)){this.log("found max session peers",i);break}}if(this.log("found %d/%d new session peers",i,this.maxProviders),i<t)throw new uh(`Found ${i} of ${t} ${this.name} providers for ${e}`)}).catch(s=>{this.log.error("error searching routing for potential session peers for %c - %e",e,s),o.reject(s)}),o.promise}};var d2=class{libp2p;blockstore;datastore;events;pins;logger;routing;getCodec;getHasher;dns;metrics;log;constructor(e){this.logger=e.logger??Qo(),this.log=this.logger.forComponent("helia"),this.getHasher=MA(e.hashers,e.loadHasher),this.getCodec=BA(e.codecs,e.loadCodec),this.dns=e.dns??vm(),this.metrics=e.metrics,this.libp2p=e.libp2p,this.events=new _e;let t={blockstore:e.blockstore,datastore:e.datastore,logger:this.logger,libp2p:this.libp2p,blockBrokers:[],getHasher:this.getHasher,getCodec:this.getCodec,dns:this.dns,metrics:this.metrics,...e.components??{}};this.routing=t.routing=new j0(t,{routers:(e.routers??[]).flatMap(o=>{typeof o=="function"&&(o=o(t));let i=[o],s=v$(o);s!=null&&i.push(s);let a=x$(o);return a!=null&&i.push(a),i}),providerLookupConcurrency:e.providerLookupConcurrency});let n=new f2(t,e);this.pins=new $0(e.datastore,n,this.getCodec),this.blockstore=new o2(n,this.pins,{holdGcLock:e.holdGcLock??!0}),this.datastore=e.datastore,t.blockBrokers=e.blockBrokers.map(o=>o(t))}async start(){await vA(this.datastore),await er(this.blockstore,this.datastore,this.routing,this.libp2p),this.events.dispatchEvent(new CustomEvent("start",{detail:this}))}async stop(){await or(this.blockstore,this.datastore,this.routing,this.libp2p),this.events.dispatchEvent(new CustomEvent("stop",{detail:this}))}async gc(e={}){let t=await this.blockstore.lock.writeLock();try{let n=this,o=this.blockstore.unwrap();this.log("gc start"),await an(o.deleteMany((async function*(){for await(let{cid:i}of o.getAll())try{if(await n.pins.isPinned(i,e))continue;yield i,e.onProgress?.(new oe("helia:gc:deleted",i))}catch(s){n.log.error("error during gc - %e",s),e.onProgress?.(new oe("helia:gc:error",s))}})()))}finally{t()}this.log("gc finished")}};function v$(r){return r?.[ki]}function x$(r){return r?.[Ri]}function E$(r){return r[Symbol.asyncIterator]!=null}function S$(r,e){let t=0;if(E$(r))return(async function*(){for await(let c of r)yield e(c,t++)})();let n=Nu(r),{value:o,done:i}=n.next();if(i===!0)return(function*(){})();let s=e(o,t++);if(typeof s.then=="function")return(async function*(){yield await s;for(let c of n)yield e(c,t++)})();let a=e;return(function*(){yield s;for(let c of n)yield a(c,t++)})()}var to=S$;function _$(r){return r[Symbol.asyncIterator]!=null}function A$(r,e){return _$(r)?(async function*(){let t=0;if(!(e<1)){for await(let n of r)if(yield n,t++,t===e)return}})():(function*(){let t=0;if(!(e<1)){for(let n of r)if(yield n,t++,t===e)return}})()}var Js=A$;var yh="/ipfs/bitswap/1.2.0";var Vt;(function(r){r.WantBlock="WantBlock",r.WantHave="WantHave"})(Vt||(Vt={}));var dw;(function(r){r[r.WantBlock=0]="WantBlock",r[r.WantHave=1]="WantHave"})(dw||(dw={}));(function(r){r.codec=()=>kt(dw)})(Vt||(Vt={}));var Lu;(function(r){let e;r.codec=()=>(e==null&&(e=Ie((t,n,o={})=>{o.lengthDelimited!==!1&&n.fork(),t.cid!=null&&t.cid.byteLength>0&&(n.uint32(10),n.bytes(t.cid)),t.priority!=null&&t.priority!==0&&(n.uint32(16),n.int32(t.priority)),t.cancel!=null&&(n.uint32(24),n.bool(t.cancel)),t.wantType!=null&&(n.uint32(32),Vt.codec().encode(t.wantType,n)),t.sendDontHave!=null&&(n.uint32(40),n.bool(t.sendDontHave)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={cid:ke(0),priority:0},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{i.cid=t.bytes();break}case 2:{i.priority=t.int32();break}case 3:{i.cancel=t.bool();break}case 4:{i.wantType=Vt.codec().decode(t);break}case 5:{i.sendDontHave=t.bool();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>Te(t,r.codec()),r.decode=(t,n)=>Ae(t,r.codec(),n)})(Lu||(Lu={}));var h2;(function(r){let e;r.codec=()=>(e==null&&(e=Ie((t,n,o={})=>{if(o.lengthDelimited!==!1&&n.fork(),t.entries!=null)for(let i of t.entries)n.uint32(10),Lu.codec().encode(i,n);t.full!=null&&(n.uint32(16),n.bool(t.full)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={entries:[]},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{if(o.limits?.entries!=null&&i.entries.length===o.limits.entries)throw new dt('Decode error - map field "entries" had too many elements');i.entries.push(Lu.codec().decode(t,t.uint32(),{limits:o.limits?.entries$}));break}case 2:{i.full=t.bool();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>Te(t,r.codec()),r.decode=(t,n)=>Ae(t,r.codec(),n)})(h2||(h2={}));var Bu;(function(r){let e;r.codec=()=>(e==null&&(e=Ie((t,n,o={})=>{o.lengthDelimited!==!1&&n.fork(),t.prefix!=null&&t.prefix.byteLength>0&&(n.uint32(10),n.bytes(t.prefix)),t.data!=null&&t.data.byteLength>0&&(n.uint32(18),n.bytes(t.data)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={prefix:ke(0),data:ke(0)},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{i.prefix=t.bytes();break}case 2:{i.data=t.bytes();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>Te(t,r.codec()),r.decode=(t,n)=>Ae(t,r.codec(),n)})(Bu||(Bu={}));var ro;(function(r){r.HaveBlock="HaveBlock",r.DoNotHaveBlock="DoNotHaveBlock"})(ro||(ro={}));var p2;(function(r){r[r.HaveBlock=0]="HaveBlock",r[r.DoNotHaveBlock=1]="DoNotHaveBlock"})(p2||(p2={}));(function(r){r.codec=()=>kt(p2)})(ro||(ro={}));var Mu;(function(r){let e;r.codec=()=>(e==null&&(e=Ie((t,n,o={})=>{o.lengthDelimited!==!1&&n.fork(),t.cid!=null&&t.cid.byteLength>0&&(n.uint32(10),n.bytes(t.cid)),t.type!=null&&p2[t.type]!==0&&(n.uint32(16),ro.codec().encode(t.type,n)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={cid:ke(0),type:ro.HaveBlock},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{i.cid=t.bytes();break}case 2:{i.type=ro.codec().decode(t);break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>Te(t,r.codec()),r.decode=(t,n)=>Ae(t,r.codec(),n)})(Mu||(Mu={}));var Tc;(function(r){let e;r.codec=()=>(e==null&&(e=Ie((t,n,o={})=>{if(o.lengthDelimited!==!1&&n.fork(),t.wantlist!=null&&(n.uint32(10),h2.codec().encode(t.wantlist,n)),t.blocks!=null)for(let i of t.blocks)n.uint32(26),Bu.codec().encode(i,n);if(t.blockPresences!=null)for(let i of t.blockPresences)n.uint32(34),Mu.codec().encode(i,n);t.pendingBytes!=null&&t.pendingBytes!==0&&(n.uint32(40),n.int32(t.pendingBytes)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={blocks:[],blockPresences:[],pendingBytes:0},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{i.wantlist=h2.codec().decode(t,t.uint32(),{limits:o.limits?.wantlist});break}case 3:{if(o.limits?.blocks!=null&&i.blocks.length===o.limits.blocks)throw new dt('Decode error - map field "blocks" had too many elements');i.blocks.push(Bu.codec().decode(t,t.uint32(),{limits:o.limits?.blocks$}));break}case 4:{if(o.limits?.blockPresences!=null&&i.blockPresences.length===o.limits.blockPresences)throw new dt('Decode error - map field "blockPresences" had too many elements');i.blockPresences.push(Mu.codec().decode(t,t.uint32(),{limits:o.limits?.blockPresences$}));break}case 5:{i.pendingBytes=t.int32();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>Te(t,r.codec()),r.decode=(t,n)=>Ae(t,r.codec(),n)})(Tc||(Tc={}));function $A(r,e){for(let[t,n]of e.wantlist.entries()){let o=r.wantlist.get(t);o!=null&&(o.priority>n.priority&&(n.priority=o.priority),n.cancel=n.cancel??o.cancel,n.wantType=n.wantType??o.wantType,n.sendDontHave=n.sendDontHave??o.sendDontHave),r.wantlist.set(t,n)}for(let[t,n]of e.blockPresences.entries())r.blockPresences.set(t,n);for(let[t,n]of e.blocks.entries())r.blocks.set(t,n);return e.full&&!r.full&&(r.full=!0),r}var m2=class extends Error{static name="BlockTooLargeError";constructor(e="Block too large"){super(e),this.name="BlockTooLargeError"}};var T$=4193648,I$=T$+16;function*jA(r,e){let t=[...r.wantlist.values()],n=[...r.blockPresences.values()],o=[...r.blocks.values()],i=0,s=0,a=0,c=!1;for(;;){let l={wantlist:{full:r.full??!1,entries:[]},blockPresences:[],blocks:[],pendingBytes:0},f=Tc.encode(l).byteLength,{added:u,hasMore:d,newSize:h}=hw(o,l.blocks,a,e,f,C$);a+=u,f=h;let m=d;({added:u,hasMore:d,newSize:h}=hw(n,l.blockPresences,s,e,f,P$)),s+=u,f=h;let w=d;if({added:u,hasMore:d,newSize:h}=hw(t,l.wantlist.entries,i,e,f,k$),i+=u,f=h,c=!m&&!w&&!d,c||(l.wantlist.full=!1),yield Tc.encode(l),c)break}}function hw(r,e,t,n,o,i){let s=0,a=!1;for(let c=t;c<r.length;c++){let l=r[c],f=i(l);if(f>I$)throw new m2("Cannot send block as after encoding it is over the max message size");let u=o+f;if(u>n){a=!0;break}e.push(l),s++,o=u}return{hasMore:a,added:s,newSize:o}}function C$(r){return pw(3,Bu.encode(r))}function P$(r){return pw(4,Mu.encode(r))}function k$(r){return pw(1,Lu.encode(r))}function pw(r,e){let t=je(r),n=je(e.byteLength);return t+n+e.byteLength}var g2=class extends _e{log;libp2p;routing;protocols;running;maxInboundStreams;maxOutboundStreams;messageReceiveTimeout;registrarIds;metrics;sendQueue;runOnLimitedConnections;maxOutgoingMessageSize;maxIncomingMessageSize;constructor(e,t={}){super(),this.log=e.logger.forComponent("helia:bitswap:network"),this.libp2p=e.libp2p,this.routing=e.routing,this.protocols=t.protocols??[yh],this.registrarIds=[],this.running=!1,this._onStream=this._onStream.bind(this),this.maxInboundStreams=t.maxInboundStreams??1024,this.maxOutboundStreams=t.maxOutboundStreams??1024,this.messageReceiveTimeout=t.messageReceiveTimeout??5e3,this.runOnLimitedConnections=t.runOnLimitedConnections??!1,this.maxIncomingMessageSize=t.maxIncomingMessageSize??4194304,this.maxOutgoingMessageSize=t.maxOutgoingMessageSize??t.maxIncomingMessageSize??4194304,this.metrics={blocksSent:e.metrics?.registerCounter("helia_bitswap_sent_blocks_total"),dataSent:e.metrics?.registerCounter("helia_bitswap_sent_data_bytes_total")},this.sendQueue=new vr({concurrency:t.messageSendConcurrency??50,metrics:e.metrics,metricName:"helia_bitswap_message_send_queue"})}async start(){if(this.running)return;this.running=!0,await this.libp2p.handle(this.protocols,this._onStream,{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:this.runOnLimitedConnections});let e={onConnect:t=>{this.safeDispatchEvent("peer:connected",{detail:t})},onDisconnect:t=>{this.safeDispatchEvent("peer:disconnected",{detail:t})}};this.registrarIds=[];for(let t of this.protocols)this.registrarIds.push(await this.libp2p.register(t,e));this.libp2p.getConnections().forEach(t=>{this.safeDispatchEvent("peer:connected",{detail:t.remotePeer})})}async stop(){if(this.running=!1,await this.libp2p.unhandle(this.protocols),this.registrarIds!=null){for(let e of this.registrarIds)this.libp2p.unregister(e);this.registrarIds=[]}}_onStream(e,t){this.running&&Promise.resolve().then(async()=>{this.log("incoming new bitswap %s stream from %p",e.protocol,t.remotePeer);let n=()=>{e.status==="open"?e.abort(new Yo(`Incoming Bitswap stream timed out after ${this.messageReceiveTimeout}ms`)):this.log("stream aborted with status %s",e.status)},o=AbortSignal.timeout(this.messageReceiveTimeout);o.addEventListener("abort",n),await e.close({signal:o});let i=gr();e.addEventListener("message",s=>{i.push(s.data)}),e.addEventListener("remoteCloseWrite",()=>{i.end()}),e.addEventListener("close",s=>{s.error!=null&&i.end(s.error)});for await(let s of Ec(i,{maxDataLength:this.maxIncomingMessageSize}))try{let a=Tc.decode(s);this.log("incoming new bitswap %s message from %p on stream",e.protocol,t.remotePeer,e.id),this.safeDispatchEvent("bitswap:message",{detail:{peer:t.remotePeer,message:a}}),o.removeEventListener("abort",n),o=AbortSignal.timeout(this.messageReceiveTimeout),o.addEventListener("abort",n)}catch(a){this.log.error("error reading incoming bitswap message from %p on stream - %e",t.remotePeer,e.id,a),e.abort(a);break}}).catch(n=>{this.log.error("error handling incoming stream from %p - %e",t.remotePeer,n),e.abort(n)})}async*findProviders(e,t){t?.onProgress?.(new oe("bitswap:find-providers",e));for await(let n of this.routing.findProviders(e,t)){if(!await this.libp2p.isDialable(n.multiaddrs,{runOnLimitedConnection:this.runOnLimitedConnections})){this.log("skipping peer %p as they are not dialable - %a[]",n.id,n.multiaddrs);continue}t?.onProgress?.(new oe("bitswap:found-provider",{type:"bitswap",cid:e,provider:n,routing:n.routing})),yield n}}async findAndConnect(e,t){t?.providers!=null&&await Promise.all(t.providers.map(async n=>this.connectTo(n).catch(o=>{this.log.error("could not connect to supplied provider - %e",o)}))),await an(to(Js(this.findProviders(e,t),t?.maxProviders??3),async n=>this.connectTo(n.id,t))).catch(n=>{this.log.error(n)})}async sendMessage(e,t,n){if(!this.running)throw new Error("network isn't running");let o=this.sendQueue.queue.find(i=>e.equals(i.options.peerId)&&i.status==="queued");if(o!=null){o.options.message=$A(o.options.message,t),await o.join({signal:n?.signal});return}await this.sendQueue.add(async i=>{let s=i?.message;if(s==null)throw new P("No message to send");this.log("sendMessage to %p",e),i?.onProgress?.(new oe("bitswap:network:send-wantlist",e));let a=await this.libp2p.dialProtocol(e,yh,i);await a.closeRead();try{for(let c of jA(s,this.maxOutgoingMessageSize))a.send(Gi.single(c))||await a.onDrain(i);await a.close(i)}catch(c){i?.onProgress?.(new oe("bitswap:network:send-wantlist:error",{peer:e,error:c})),this.log.error("error sending message to %p - %e",e,c),a.abort(c)}this._updateSentStats(s.blocks)},{peerId:e,signal:n?.signal,message:t})}async connectTo(e,t){if(!this.running)throw new _n("Network isn't running");t?.onProgress?.(new oe("bitswap:network:dial",e));let[n]=await Promise.all([this.libp2p.dial(e,t),Qr(this.libp2p,"peer:identify",t?.signal,{filter:o=>{if(!o.detail.peerId.equals(e))return!1;if(o.detail.protocols.includes(yh))return!0;throw new Ul(`${e} did not support ${yh}`)}})]);return n}_updateSentStats(e){let t=0;for(let n of e.values())t+=n.data.byteLength;this.metrics.dataSent?.increment(t),this.metrics.blocksSent?.increment(e.size)}};var KA=Symbol.for("nodejs.util.inspect.custom"),F$=114,wh=class{type;multihash;publicKey;string;constructor(e){this.type=e.type,this.multihash=e.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[am]=!0;toString(){return this.string==null&&(this.string=ft.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return he.createV1(F$,this.multihash)}toJSON(){return this.toString()}equals(e){if(e==null)return!1;if(e instanceof Uint8Array)return we(this.multihash.bytes,e);if(typeof e=="string")return this.toString()===e;if(e?.toMultihash()?.bytes!=null)return we(this.multihash.bytes,e.toMultihash().bytes);throw new Error("not valid Id")}[KA](){return`PeerId(${this.toString()})`}},bh=class extends wh{type="RSA";publicKey;constructor(e){super({...e,type:"RSA"}),this.publicKey=e.publicKey}},vh=class extends wh{type="Ed25519";publicKey;constructor(e){super({...e,type:"Ed25519"}),this.publicKey=e.publicKey}},xh=class extends wh{type="secp256k1";publicKey;constructor(e){super({...e,type:"secp256k1"}),this.publicKey=e.publicKey}},$$=2336,Eh=class{type="url";multihash;publicKey;url;constructor(e){this.url=e.toString(),this.multihash=Dr.digest(B(this.url))}[KA](){return`PeerId(${this.url})`}[am]=!0;toString(){return this.toCID().toString()}toMultihash(){return this.multihash}toCID(){return he.createV1($$,this.toMultihash())}toJSON(){return this.toString()}equals(e){return e==null?!1:(e instanceof Uint8Array&&(e=j(e)),e.toString()===this.toString())}};var j$=114,VA=2336;function yt(r,e){let t;if(r.charAt(0)==="1"||r.charAt(0)==="Q")t=lt(ft.decode(`z${r}`));else{if(r.startsWith("k51qzi5uqu5")||r.startsWith("kzwfwjn5ji4")||r.startsWith("k2k4r8")||r.startsWith("bafz"))return Ro(he.parse(r));if(e==null)throw new P('Please pass a multibase decoder for strings that do not start with "1" or "Q"');t=lt(e.decode(r))}return zt(t)}function si(r){if(r.type==="Ed25519")return new vh({multihash:r.toCID().multihash,publicKey:r});if(r.type==="secp256k1")return new xh({multihash:r.toCID().multihash,publicKey:r});if(r.type==="RSA")return new bh({multihash:r.toCID().multihash,publicKey:r});throw new wo}function HA(r){return si(r.publicKey)}function zt(r){if(V$(r))return new bh({multihash:r});if(K$(r))try{let e=Um(r);if(e.type==="Ed25519")return new vh({multihash:r,publicKey:e});if(e.type==="secp256k1")return new xh({multihash:r,publicKey:e})}catch{let t=j(r.digest);return new Eh(new URL(t))}throw new Cs("Supplied PeerID Multihash is invalid")}function Ro(r){if(r?.multihash==null||r.version==null||r.version===1&&r.code!==j$&&r.code!==VA)throw new rm("Supplied PeerID CID is invalid");if(r.code===VA){let e=j(r.multihash.digest);return new Eh(new URL(e))}return zt(r.multihash)}function K$(r){return r.code===Dr.code}function V$(r){return r.code===St.code}function Ic(r,e){let t={[Symbol.iterator]:()=>t,next:()=>{let n=r.next(),o=n.value;return n.done===!0||o==null?{done:!0,value:void 0}:{done:!1,value:e(o)}}};return t}function y2(r){let e=lt(ft.decode(`z${r}`));return zt(e)}var $r=class{map;constructor(e){if(this.map=new Map,e!=null)for(let[t,n]of e.entries())this.map.set(t.toString(),{key:t,value:n})}[Symbol.iterator](){return this.entries()}clear(){this.map.clear()}delete(e){return this.map.delete(e.toString())}entries(){return Ic(this.map.entries(),e=>[e[1].key,e[1].value])}forEach(e){this.map.forEach((t,n)=>{e(t.value,t.key,this)})}get(e){return this.map.get(e.toString())?.value}has(e){return this.map.has(e.toString())}set(e,t){this.map.set(e.toString(),{key:e,value:t})}keys(){return Ic(this.map.values(),e=>e.key)}values(){return Ic(this.map.values(),e=>e.value)}get size(){return this.map.size}};var Bn=class r{set;constructor(e){if(this.set=new Set,e!=null)for(let t of e)this.set.add(t.toString())}get size(){return this.set.size}[Symbol.iterator](){return this.values()}add(e){this.set.add(e.toString())}clear(){this.set.clear()}delete(e){this.set.delete(e.toString())}entries(){return Ic(this.set.entries(),e=>{let t=y2(e[0]);return[t,t]})}forEach(e){this.set.forEach(t=>{let n=y2(t);e(n,n,this)})}has(e){return this.set.has(e.toString())}values(){return Ic(this.set.values(),e=>y2(e))}intersection(e){let t=new r;for(let n of e)this.has(n)&&t.add(n);return t}difference(e){let t=new r;for(let n of this)e.has(n)||t.add(n);return t}union(e){let t=new r;for(let n of e)t.add(n);for(let n of this)t.add(n);return t}};function mw(){return new Bn}var w2=class{filter;constructor(e,t){this.filter=Fr(e,t)}has(e){return this.filter.has(e.toMultihash().bytes)}add(e){this.filter.add(e.toMultihash().bytes)}remove(e){this.filter.remove?.(e.toMultihash().bytes)}};function gw(r,e=.001){return new w2(r,e)}var yw=class extends $r{metric;constructor(e){super();let{name:t,metrics:n}=e;this.metric=n.registerMetric(t),this.updateComponentMetric()}set(e,t){return super.set(e,t),this.updateComponentMetric(),this}delete(e){let t=super.delete(e);return this.updateComponentMetric(),t}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}};function Qi(r){let{name:e,metrics:t}=r,n;return t!=null?n=new yw({name:e,metrics:t}):n=new $r,n}var Zi=class{full;pendingBytes;wantlist;blocks;blockPresences;constructor(e=!1,t=0){this.full=e,this.wantlist=new Map,this.blocks=new Map,this.blockPresences=new Map,this.pendingBytes=0}addWantlistEntry(e,t){let n=Ht.encode(e.multihash.bytes);this.wantlist.set(n,t)}addBlockPresence(e,t){let n=Ht.encode(e.multihash.bytes);this.blockPresences.set(n,t)}addBlock(e,t){let n=Ht.encode(e.multihash.bytes);this.blocks.set(n,t)}};function H$(r){let e=new Uint8Array(r.reduce((n,o)=>n+je(o),0)),t=0;for(let n of r)e=Mr(n,e,t),t+=je(n);return e}var qA=H$;function ww(r){return qA([r.version,r.code,r.multihash.code,r.multihash.digest.byteLength])}var b2=class{peerId;blockstore;network;wants;exchangeCount;bytesSent;bytesReceived;lastExchange;maxSizeReplaceHasWithBlock;log;constructor(e,t){this.peerId=e.peerId,this.blockstore=e.blockstore,this.network=e.network,this.wants=new Map,this.log=e.logger.forComponent(`helia:bitswap:ledger:${e.peerId}`),this.exchangeCount=0,this.bytesSent=0,this.bytesReceived=0,this.maxSizeReplaceHasWithBlock=t.maxSizeReplaceHasWithBlock??1024}sentBytes(e){this.exchangeCount++,this.lastExchange=new Date().getTime(),this.bytesSent+=e}receivedBytes(e){this.exchangeCount++,this.lastExchange=new Date().getTime(),this.bytesReceived+=e}debtRatio(){return this.bytesSent/(this.bytesReceived+1)}async sendBlocksToPeer(e){let t=new Zi,n=new Set;for(let[o,i]of this.wants.entries())try{let s=await R0(this.blockstore.get(i.cid,e));i.wantType===Vt.WantHave?s.byteLength<this.maxSizeReplaceHasWithBlock?(this.log("sending have and block for %c",i.cid),n.add(o),t.addBlock(i.cid,{data:s,prefix:ww(i.cid)})):(this.log("sending have for %c",i.cid),t.addBlockPresence(i.cid,{cid:i.cid.bytes,type:ro.HaveBlock})):(this.log("sending block for %c",i.cid),n.add(o),t.addBlock(i.cid,{data:s,prefix:ww(i.cid)}))}catch(s){if(s.name!=="NotFoundError")throw s;if(this.log("do not have block for %c",i.cid),!i.sendDontHave||i.sentDoNotHave===!0)continue;i.sentDoNotHave=!0,t.addBlockPresence(i.cid,{cid:i.cid.bytes,type:ro.DoNotHaveBlock})}if(t.blocks.size>0||t.blockPresences.size>0){this.log("sending message"),await this.network.sendMessage(this.peerId,t,e),this.log("sent message"),this.sentBytes([...t.blocks.values()].reduce((o,i)=>o+i.data.byteLength,0));for(let o of n)this.wants.delete(o)}}};var v2=class{blockstore;network;ledgerMap;maxSizeReplaceHasWithBlock;log;logger;constructor(e,t={}){this.blockstore=e.blockstore,this.network=e.network,this.maxSizeReplaceHasWithBlock=t.maxSizeReplaceHasWithBlock,this.log=e.logger.forComponent("helia:bitswap:peer-want-lists"),this.logger=e.logger,this.ledgerMap=Qi({name:"helia_bitswap_ledger_map",metrics:e.metrics}),this.network.addEventListener("bitswap:message",n=>{this.receiveMessage(n.detail.peer,n.detail.message).catch(o=>{this.log.error("error receiving bitswap message from %p - %e",n.detail.peer,o)})}),this.network.addEventListener("peer:disconnected",n=>{this.peerDisconnected(n.detail)})}ledgerForPeer(e){let t=this.ledgerMap.get(e);if(t!=null)return{peer:t.peerId,value:t.debtRatio(),sent:t.bytesSent,received:t.bytesReceived,exchanged:t.exchangeCount}}wantListForPeer(e){let t=this.ledgerMap.get(e);if(t!=null)return[...t.wants.values()]}peers(){return Array.from(this.ledgerMap.values()).map(e=>e.peerId)}async receiveMessage(e,t){let n=this.ledgerMap.get(e);if(n==null&&(n=new b2({peerId:e,blockstore:this.blockstore,network:this.network,logger:this.logger},{maxSizeReplaceHasWithBlock:this.maxSizeReplaceHasWithBlock}),this.ledgerMap.set(e,n)),n.receivedBytes(t.blocks?.reduce((o,i)=>o+i.data.byteLength,0)??0),t.wantlist!=null){t.wantlist.full===!0&&n.wants.clear();for(let o of t.wantlist.entries){let i=he.decode(o.cid),s=j(i.multihash.bytes,"base64");o.cancel===!0?(this.log("peer %p cancelled want of block for %c",e,i),n.wants.delete(s)):(o.wantType===Vt.WantHave?this.log("peer %p wanted block presence for %c",e,i):this.log("peer %p wanted block for %c",e,i),n.wants.set(s,{cid:i,priority:o.priority,wantType:o.wantType??Vt.WantBlock,sendDontHave:o.sendDontHave??!1}))}}this.log("send blocks to peer"),await n.sendBlocksToPeer()}async receivedBlock(e,t){let n=j(e.multihash.bytes,"base64"),o=[];for(let i of this.ledgerMap.values())i.wants.has(n)&&o.push(i);await Promise.all(o.map(async i=>i.sendBlocksToPeer(t)))}peerDisconnected(e){this.ledgerMap.delete(e)}};var bw=class extends Ac{wantList;network;libp2p;constructor(e,t){super(e,{...t,name:"helia:bitswap:session"}),this.wantList=e.wantList,this.network=e.network,this.libp2p=e.libp2p}async queryProvider(e,t,n){this.log("sending WANT-BLOCK for %c to %p",e,t);let o=await this.wantList.wantSessionBlock(e,t,n);if(this.log("%p %s %c",t,o.has?"has":"does not have",e),o.has&&o.block!=null)return o.block;throw new Error("Provider did not have block")}async*findNewProviders(e,t={}){for await(let n of this.network.findProviders(e,t))yield n.id}toEvictionKey(e){return e.toMultihash().bytes}equals(e,t){return e.equals(t)}async convertToProvider(e,t){return on(e)?e:(await this.libp2p.dial(e,t)).remotePeer}};function WA(r,e){return new bw(r,e)}var x2=class{blocksReceived;duplicateBlocksReceived;dataReceived;duplicateDataReceived;constructor(e){this.blocksReceived=e.metrics?.registerMetricGroup("helia_bitswap_received_blocks"),this.duplicateBlocksReceived=e.metrics?.registerMetricGroup("helia_bitswap_duplicate_received_blocks"),this.dataReceived=e.metrics?.registerMetricGroup("helia_bitswap_data_received_bytes"),this.duplicateDataReceived=e.metrics?.registerMetricGroup("helia_bitswap_duplicate_data_received_bytes")}updateBlocksReceived(e=1,t){let n={global:e};t!=null&&(n[t.toString()]=e),this.blocksReceived?.increment(n)}updateDuplicateBlocksReceived(e=1,t){let n={global:e};t!=null&&(n[t.toString()]=e),this.duplicateBlocksReceived?.increment(n)}updateDataReceived(e,t){let n={global:e};t!=null&&(n[t.toString()]=e),this.dataReceived?.increment(n)}updateDuplicateDataReceived(e,t){let n={global:e};t!=null&&(n[t.toString()]=e),this.duplicateDataReceived?.increment(n)}};function q$(r){if(!(r instanceof Uint8Array))throw new Error("arg needs to be a Uint8Array");let e=[];for(;r.length>0;){let t=Cn(r);e.push(t),r=r.slice(je(t))}return e}var zA=q$;var E2=class extends _e{peers;wants;network;log;sendMessagesDelay;sendMessagesTimeout;hashLoader;sendingMessages;constructor(e,t={}){super(),this.peers=Qi({name:"helia_bitswap_peers",metrics:e.metrics}),this.wants=Wt({name:"helia_bitswap_wantlist",metrics:e.metrics}),this.network=e.network,this.sendMessagesDelay=t.sendMessagesDelay??10,this.log=e.logger.forComponent("helia:bitswap:wantlist"),this.hashLoader=t.hashLoader,this.network.addEventListener("bitswap:message",n=>{this.receiveMessage(n.detail.peer,n.detail.message).catch(o=>{this.log.error("error receiving bitswap message from %p - %e",n.detail.peer,o)})}),this.network.addEventListener("peer:connected",n=>{this.peerConnected(n.detail).catch(o=>{this.log.error("error processing newly connected bitswap peer %p - %e",n.detail,o)})}),this.network.addEventListener("peer:disconnected",n=>{this.peerDisconnected(n.detail)})}async addEntry(e,t){let n=j(e.multihash.bytes,"base64"),o=this.wants.get(n);o==null&&(o={cid:e,priority:t.priority??1,wantType:t.wantType??Vt.WantBlock,cancel:!1,sendDontHave:!0},this.wants.set(n,o)),o.wantType===Vt.WantHave&&t.wantType===Vt.WantBlock&&(o.wantType=Vt.WantBlock),await this.sendMessagesDebounced();try{return t.wantType===Vt.WantBlock?(await Qr(this,"block",t?.signal,{filter:a=>we(e.multihash.digest,a.detail.cid.multihash.digest),errorMessage:"Want was aborted"})).detail:(await Qr(this,"presence",t?.signal,{filter:s=>we(e.multihash.digest,s.detail.cid.multihash.digest),errorMessage:"Want was aborted"})).detail}finally{t.signal?.aborted===!0&&(this.log("want for %c was aborted, cancelling want",e),o.cancel=!0,await this.sendMessagesDebounced())}}async sendMessagesDebounced(){await this.sendingMessages?.promise,clearTimeout(this.sendMessagesTimeout),this.sendMessagesTimeout=setTimeout(()=>{this.sendMessages().catch(e=>{this.log("error sending messages to peers - %e",e)})},this.sendMessagesDelay)}async sendMessages(){this.sendingMessages=Ve(),await Promise.all([...this.peers.entries()].map(async([e,t])=>{let n=new Set,o=new Zi;for(let[i,s]of this.wants.entries())t.has(i)||s.cancel||(n.add(i),o.addWantlistEntry(s.cid,{cid:s.cid.bytes,priority:s.priority,wantType:s.wantType,cancel:s.cancel,sendDontHave:s.sendDontHave}));if(o.wantlist.size!==0)try{await this.network.sendMessage(e,o);for(let i of n)t.add(i)}catch(i){this.log.error("error sending full wantlist to new peer - %e",i)}})).catch(e=>{this.log.error("error sending messages - %e",e)});for(let[e,t]of this.wants)if(t.cancel){this.wants.delete(e);for(let n of this.peers.values())n.delete(e)}this.sendingMessages.resolve()}has(e){let t=j(e.multihash.bytes,"base64");return this.wants.has(t)}async wantSessionPresence(e,t,n={}){let o=new Zi;return o.addWantlistEntry(e,{cid:e.bytes,sendDontHave:!0,wantType:Vt.WantHave,priority:1}),await this.network.sendMessage(t,o),(await Qr(this,"presence",n.signal,{filter:s=>t.equals(s.detail.sender)&&we(e.multihash.digest,s.detail.cid.multihash.digest)})).detail}async wantBlock(e,t={}){return this.addEntry(e,{...t,wantType:Vt.WantBlock})}async wantSessionBlock(e,t,n={}){let o=new Zi;return o.addWantlistEntry(e,{cid:e.bytes,sendDontHave:!0,wantType:Vt.WantBlock,priority:1}),await this.network.sendMessage(t,o),(await Qr(this,"presence",n.signal,{filter:s=>t.equals(s.detail.sender)&&we(e.multihash.digest,s.detail.cid.multihash.digest)})).detail}async receivedBlock(e,t){let n=j(e.multihash.bytes,"base64"),o=this.wants.get(n);o!=null&&(o.cancel=!0,await this.sendMessagesDebounced())}async receiveMessage(e,t){this.log("received message from %p with %d blocks",e,t.blocks.length);let n=!1;for(let o of t.blocks){if(o.prefix==null||o.data==null)continue;let i=zA(o.prefix),s=i[0],a=i[1],c=i[2],l=i[3],f=c===St.code?St:await this.hashLoader?.getHasher(c);if(f==null){this.log.error("unknown hash algorithm",c);continue}let u=f.digest(o.data,{truncate:l});u.then!=null&&(u=await u);let d=he.create(s===0?0:1,a,u);this.log("received block from %p for %c",e,d),this.safeDispatchEvent("block",{detail:{sender:e,cid:d,block:o.data}}),this.safeDispatchEvent("presence",{detail:{sender:e,cid:d,has:!0,block:o.data}});let h=j(d.multihash.bytes,"base64"),m=this.wants.get(h);m!=null&&(m.cancel=!0,n=!0)}for(let{cid:o,type:i}of t.blockPresences){let s=he.decode(o);this.log("received %s from %p for %c",i,e,s),this.safeDispatchEvent("presence",{detail:{sender:e,cid:s,has:i===ro.HaveBlock}})}n&&await this.sendMessagesDebounced()}async peerConnected(e){let t=new Set,n=new Zi(!0);for(let[o,i]of this.wants.entries())i.cancel||(t.add(o),n.addWantlistEntry(i.cid,{cid:i.cid.bytes,priority:1,wantType:Vt.WantBlock,cancel:!1,sendDontHave:!1}));if(n.wantlist.size===0){this.peers.set(e,t);return}try{await this.network.sendMessage(e,n),this.peers.set(e,t)}catch(o){this.log.error("error sending full wantlist to new peer %p - %e",e,o)}}peerDisconnected(e){this.peers.delete(e)}start(){}stop(){this.peers.clear(),clearTimeout(this.sendMessagesTimeout)}};var S2=class{log;logger;stats;network;blockstore;peerWantLists;wantList;libp2p;constructor(e,t={}){this.logger=e.logger,this.log=e.logger.forComponent("helia:bitswap"),this.blockstore=e.blockstore,this.libp2p=e.libp2p,this.stats=new x2(e),this.network=new g2(e,t),this.peerWantLists=new v2({...e,network:this.network},t),this.wantList=new E2({...e,network:this.network},t)}createSession(e={}){return WA({wantList:this.wantList,network:this.network,logger:this.logger,libp2p:this.libp2p},e)}async want(e,t={}){let n=new AbortController,o=De([n.signal,t.signal]);n.signal,this.network.findAndConnect(e,{...t,signal:o}).catch(i=>{n.signal.aborted||this.log.error("error during finding and connect for cid %c - %e",e,i)});try{let i=await this.wantList.wantBlock(e,{...t,signal:o});return t.onProgress?.(new oe("bitswap:block",{cid:e,sender:i.sender})),i.block}finally{n.abort(),o.clear()}}async notify(e,t={}){await Promise.all([this.peerWantLists.receivedBlock(e,t),this.wantList.receivedBlock(e,t)])}getWantlist(){return[...this.wantList.wants.values()].filter(e=>!e.cancel).map(e=>({cid:e.cid,priority:e.priority,wantType:e.wantType}))}getPeerWantlist(e){return this.peerWantLists.wantListForPeer(e)}async start(){this.wantList.start(),await this.network.start()}async stop(){this.wantList.stop(),await this.network.stop()}};var GA=(r,e={})=>new S2(r,e);var vw=class{bitswap;started;constructor(e,t={}){let{getHasher:n}=e;this.bitswap=GA(e,{hashLoader:{getHasher:async o=>n(o)},...t}),this.started=!1}isStarted(){return this.started}async start(){await this.bitswap.start(),this.started=!0}async stop(){await this.bitswap.stop(),this.started=!1}async announce(e,t){await this.bitswap.notify(e,t)}async retrieve(e,t={}){return this.bitswap.want(e,t)}createSession(e){let t=this.bitswap.createSession(e);return{announce:async(n,o)=>{await this.bitswap.notify(n,o)},retrieve:async(n,o)=>t.retrieve(n,o)}}};function xw(r={}){return e=>new vw(e,r)}var W$=[6,53,56,54,55];function XA(r){return ZA("sni",r)?.value}function YA(r){let e=ZA("tcp",r)?.value;return e==null?"":`:${e}`}function ZA(r,e){return e.find(t=>t.name===r)}function QA(r){return r.some(({code:e})=>e===448)}function Do(r,e){let t=JA[r.name];if(t==null)throw new Error(`Can't interpret protocol ${r.name}`);let n=t(r,e);return r.code===41?`[${n}]`:n}var JA={ip4:(r,e)=>r.value,ip6:(r,e)=>e.length===0?r.value:`[${r.value}]`,tcp:(r,e)=>{let t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`tcp://${Do(t,e)}:${r.value}`},udp:(r,e)=>{let t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`udp://${Do(t,e)}:${r.value}`},dnsaddr:(r,e)=>r.value,dns4:(r,e)=>r.value,dns6:(r,e)=>r.value,dns:(r,e)=>r.value,ipfs:(r,e)=>{let t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`${Do(t,e)}`},p2p:(r,e)=>{let t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`${Do(t,e)}`},http:(r,e)=>{let t=QA(e),n=XA(e),o=YA(e);if(t&&n!=null)return`https://${n}${o}`;let i=t?"https://":"http://",s=e.pop();if(s==null)throw new Error("Unexpected end of multiaddr");let a=Do(s,e);return a=a?.replace("tcp://",""),`${i}${a}`},"http-path":(r,e)=>{let t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");let n=Do(t,e),o=decodeURIComponent(r.value??"");return`${n}${o}`},tls:(r,e)=>{let t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return Do(t,e)},sni:(r,e)=>{let t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return Do(t,e)},https:(r,e)=>{let t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");let n=Do(t,e);return n=n?.replace("tcp://",""),`https://${n}`},ws:(r,e)=>{let t=QA(e),n=XA(e),o=YA(e);if(t&&n!=null)return`wss://${n}${o}`;let i=t?"wss://":"ws://",s=e.pop();if(s==null)throw new Error("Unexpected end of multiaddr");let a=Do(s,e);return a=a?.replace("tcp://",""),`${i}${a}`},wss:(r,e)=>{let t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");let n=Do(t,e);return n=n?.replace("tcp://",""),`wss://${n}`}};function ea(r,e){let n=ie(r).getComponents(),o=n.pop();if(o==null)throw new Error("Unexpected end of multiaddr");let i=JA[o.name];if(i==null)throw new Error(`No interpreter found for ${o.name}`);let s=i(o,n)??"";return e?.assumeHttp!==!1&&W$.includes(o.code)&&(s=s.replace(/^.*:\/\//,""),o.value==="443"?s=`https://${s}`:s=`http://${s}`),(s.startsWith("http://")||s.startsWith("https://")||s.startsWith("ws://")||s.startsWith("wss://"))&&(s=new URL(s).toString(),s.endsWith("/")&&(s=s.substring(0,s.length-1))),s}var at=r=>({match:e=>{let t=e[0];return t==null||t.code!==r||t.value!=null?!1:e.slice(1)}}),Pe=(r,e)=>({match:t=>{let n=t[0];return n?.code!==r||n.value==null||e!=null&&n.value!==e?!1:t.slice(1)}}),eT=r=>({match:e=>r.match(e)===!1?e:!1}),We=r=>({match:e=>{let t=r.match(e);return t===!1?e:t}}),jr=(...r)=>({match:e=>{let t;for(let n of r){let o=n.match(e);o!==!1&&(t==null||o.length<t.length)&&(t=o)}return t??!1}}),Qe=(...r)=>({match:e=>{for(let t of r){let n=t.match(e);if(n===!1)return!1;e=n}return e}});function ct(...r){function e(o){if(o==null)return!1;let i=o.getComponents();for(let s of r){let a=s.match(i);if(a===!1)return!1;i=a}return i}function t(o){return e(o)!==!1}function n(o){let i=e(o);return i===!1?!1:i.length===0}return{matchers:r,matches:t,exactMatch:n}}var z$=Pe(421),tT=ct(z$),A2=Pe(54),T2=Pe(55),I2=Pe(56),Sw=Pe(53),Wce=ct(A2,We(Pe(421))),zce=ct(T2,We(Pe(421))),Gce=ct(I2,We(Pe(421))),C2=ct(jr(Sw,I2,A2,T2),We(Pe(421))),rT=Qe(Pe(4),We(Pe(43))),nT=Qe(We(Pe(42)),Pe(41),We(Pe(43))),_w=jr(rT,nT),Cc=jr(_w,Sw,A2,T2,I2),oT=ct(jr(_w,Qe(jr(Sw,I2,A2,T2),We(Pe(421))))),Aw=ct(rT),Tw=ct(nT),iT=ct(_w),Iw=Qe(Cc,Pe(6)),Sh=Qe(Cc,Pe(273)),Pc=ct(Qe(Iw,We(Pe(421)))),Xce=ct(Sh),Cw=Qe(Sh,at(460),We(Pe(421))),P2=Qe(Sh,at(461),We(Pe(421))),G$=jr(Cw,P2),Yce=ct(Cw),sT=ct(P2),Ew=jr(Cc,Iw,Sh,Cw,P2),aT=jr(Qe(Ew,at(477),We(Pe(421)))),Ji=ct(aT),cT=jr(Qe(Ew,at(478),We(Pe(421))),Qe(Ew,at(448),We(Pe(449)),at(477),We(Pe(421)))),kc=ct(cT),lT=Qe(Sh,at(280),We(Pe(466)),We(Pe(466)),We(Pe(421))),_h=ct(lT),uT=Qe(P2,at(465),We(Pe(466)),We(Pe(466)),We(Pe(421))),Pw=ct(uT),_2=jr(aT,cT,Qe(Iw,We(Pe(421))),Qe(G$,We(Pe(421))),Qe(Cc,We(Pe(421))),lT,uT,Pe(421)),Uu=ct(_2),X$=Qe(We(_2),at(290),eT(at(281)),We(Pe(421))),fr=ct(X$),Y$=jr(Qe(_2,at(290),at(281),We(Pe(421))),Qe(_2,at(281),We(Pe(421))),Qe(at(281),We(Pe(421)))),Ah=ct(Y$),Q$=jr(Qe(Cc,Pe(6),at(480),We(Pe(421))),Qe(Cc,at(480),We(Pe(421)))),fT=ct(Q$),Z$=Qe(Cc,jr(Qe(Pe(6,"443"),at(480)),Qe(Pe(6),at(443)),Qe(Pe(6),at(448),at(480)),Qe(at(448),at(480)),at(448),at(443)),We(Pe(421))),dT=ct(Z$),J$=jr(Qe(Pe(777),We(Pe(421)))),Qce=ct(J$),ej=jr(Qe(Pe(400),We(Pe(421)))),Zce=ct(ej);function kw(r,e,t){return r.filter(n=>{if(dT.matches(n)||e&&fT.matches(n))return t||C2.matches(n)?!0:Mt(n)===!1;if(!e&&t){let{host:o}=Ce(n);if(o==="127.0.0.1"||o==="localhost"||o.endsWith(".localhost"))return!0}return!1})}async function*k2(r,e,t,n,o,i={}){for await(let s of e.findProviders(r,i)){let a=kw(s.multiaddrs,n,o);if(a.length===0)continue;let c=ea(a[0]),l={type:"trustless-gateway",cid:r,url:c.toString(),routing:s.routing};i?.onProgress?.(new oe("trustless-gateway:found-provider",l)),yield new Fu(c,{logger:t,transformRequestInit:i.transformRequestInit})}}async function hT(r,e,t){let{signal:n,log:o}=t??{},i=r.headers.get("content-length");if(i!=null){let c=parseInt(i,10);if(c>e)throw o?.error("content-length header (%d) is greater than the limit (%d)",c,e),r.body!=null&&await r.body.cancel().catch(l=>{o?.error("error cancelling response body after content-length check - %e",l)}),new Error(`Content-Length header (${c}) is greater than the limit (${e}).`)}let s=r.body?.getReader();if(s==null)throw new Error("Response body is not readable");let a=new fe;try{for(;;){if(n?.aborted===!0)throw new Error("Response body read was aborted.");let{done:c,value:l}=await s.read();if(c)break;if(a.append(l),a.byteLength>e)throw new Error(`Response body is greater than the limit (${e}), received ${a.byteLength} bytes.`)}}finally{s.cancel().catch(c=>{o?.error("error cancelling reader - %e",c)}).finally(()=>{s.releaseLock()})}return a.subarray()}var Fu=class{url;#e=0;#t=0;#r=0;#s=0;#i=new Map;log;transformRequestInit;constructor(e,{logger:t,transformRequestInit:n}){this.url=e instanceof URL?e:new URL(e),this.transformRequestInit=n,this.log=t.forComponent(`helia:trustless-gateway-block-broker:${this.url.hostname}`)}#f(e){let t=e.multihash.bytes;return Ht.encode(t)}async getRawBlock(e,{signal:t,maxSize:n=pT}={}){let o=new URL(this.url.toString());if(o.pathname=`/ipfs/${e.toString()}`,o.search="?format=raw",t?.aborted===!0)throw new Error(`Signal to fetch raw block for CID ${e} from gateway ${this.url} was aborted prior to fetch`);let i=this.#f(e),s=new AbortController,a=()=>{s.abort()};t?.addEventListener("abort",a);try{let c=this.#i.get(i);if(c==null){this.#e++;let l={signal:s.signal,headers:{Accept:"application/vnd.ipld.raw"},cache:"force-cache"},f=this.transformRequestInit!=null?await this.transformRequestInit(l):l,u=new Headers(f.headers);this.log(`sending request
%s %s HTTP/1.1
%s
`,f.method??"GET",o,[...u.entries()].map(([d,h])=>`${d}: ${h}`).join(`
`)),c=fetch(o.toString(),f).then(async d=>{if(this.log(`received response
HTTP/1.1 %d %s
%s
`,d.status,d.statusText,[...d.headers.entries()].map(([m,w])=>`${m}: ${w}`).join(`
`)),!d.ok)throw this.#t++,new Error(`Unable to fetch raw block for CID ${e} from gateway ${this.url}, recieved ${d.status} ${d.statusText}`);let h=await hT(d,n,{signal:s.signal,log:this.log});return this.#s++,h}),this.#i.set(i,c)}return await c}catch(c){throw t?.aborted===!0?new Error(`Fetching raw block for CID ${e} from gateway ${this.url} was aborted`):(this.#t++,new Error(`Unable to fetch raw block for CID ${e} - ${c.message}`))}finally{t?.removeEventListener("abort",a),this.#i.delete(i)}}reliability(){return this.#e===0?1:this.#r>0?-1/0:this.#s/(this.#e+this.#t*3)}incrementInvalidBlocks(){this.#r++}getStats(){return{attempts:this.#e,errors:this.#t,invalidBlocks:this.#r,successes:this.#s,pendingResponses:this.#i.size}}toString(){return`TrustlessGateway(${this.url})`}};var Ow=class extends Ac{routing;allowInsecure;allowLocal;transformRequestInit;constructor(e,t){super(e,{...t,name:"helia:trustless-gateway:session"}),this.routing=e.routing,this.allowInsecure=t.allowInsecure??O2,this.allowLocal=t.allowLocal??R2,this.transformRequestInit=t.transformRequestInit}async queryProvider(e,t,n){this.log("fetching BLOCK for %c from %s",e,t.url);let o=await t.getRawBlock(e,n);return this.log.trace("got block for %c from %s",e,t.url),await n.validateFn?.(o),o}async*findNewProviders(e,t={}){yield*k2(e,this.routing,this.logger,this.allowInsecure,this.allowLocal,{...t,transformRequestInit:this.transformRequestInit})}toEvictionKey(e){return e.url.toString()}equals(e,t){return e.url.toString()===t.url.toString()}async convertToProvider(e,t){if(on(e))return;let n=kw(Array.isArray(e)?e:[e],this.allowInsecure,this.allowLocal);if(n.length===0)return;let o=ea(n[0]);return new Fu(o,{logger:this.logger,transformRequestInit:this.transformRequestInit})}};function mT(r,e){return new Ow(r,e)}var D2=class{allowInsecure;allowLocal;transformRequestInit;routing;log;logger;constructor(e,t={}){this.log=e.logger.forComponent("helia:trustless-gateway-block-broker"),this.logger=e.logger,this.routing=e.routing,this.allowInsecure=t.allowInsecure??O2,this.allowLocal=t.allowLocal??R2,this.transformRequestInit=t.transformRequestInit}async retrieve(e,t={}){let n=[];for await(let o of k2(e,this.routing,this.logger,this.allowInsecure,this.allowLocal,{...t,transformRequestInit:this.transformRequestInit})){this.log("getting block for %c from %s",e,o.url);try{let i=await o.getRawBlock(e,t);this.log.trace("got block for %c from %s",e,o.url);try{await t.validateFn?.(i)}catch(s){this.log.error("failed to validate block for %c from %s - %e",e,o.url,s);continue}return i}catch(i){if(this.log.error("failed to get block for %c from %s - %e",e,o.url,i),i instanceof Error?n.push(i):n.push(new Error(`Unable to fetch raw block for CID ${e} from gateway ${o.url}`)),t.signal?.aborted===!0){this.log.trace("request aborted while fetching raw block for CID %c from gateway %s",e,o.url);break}}}throw n.length>0?new AggregateError(n,`Unable to fetch raw block for CID ${e} from any gateway`):new Error(`Unable to fetch raw block for CID ${e} from any gateway`)}createSession(e={}){return mT({logger:this.logger,routing:this.routing},{...e,allowLocal:this.allowLocal,allowInsecure:this.allowInsecure,transformRequestInit:this.transformRequestInit})}};var O2=!1,R2=!1,pT=2097152;function Rw(r={}){return e=>new D2(e,r)}async function*N2(r,e={}){let t=r.getReader();try{for(;;){let n=await t.read();if(n.done)return;yield n.value}}finally{e.preventCancel!==!0&&await t.cancel(),t.releaseLock()}}var sj=nr(L2(),1);var No=class extends Error{static name="SignatureVerificationError";constructor(e="Record signature verification failed"){super(e),this.name="SignatureVerificationError"}},B2=class extends Error{static name="RecordExpiredError";constructor(e="Record has expired"){super(e),this.name="RecordExpiredError"}},$u=class extends Error{static name="UnsupportedValidityError";constructor(e="The validity type is unsupported"){super(e),this.name="UnsupportedValidityError"}},M2=class extends Error{static name="RecordTooLargeError";constructor(e="The record is too large"){super(e),this.name="RecordTooLargeError"}},U2=class extends Error{static name="InvalidValueError";constructor(e="Value must be a valid content path starting with /"){super(e),this.name="InvalidValueError"}},F2=class extends Error{static name="InvalidRecordDataError";constructor(e="Invalid record data"){super(e),this.name="InvalidRecordDataError"}},Th=class extends Error{static name="InvalidEmbeddedPublicKeyError";constructor(e="Invalid embedded public key"){super(e),this.name="InvalidEmbeddedPublicKeyError"}};var un;(function(r){let e;(function(o){o.EOL="EOL"})(e=r.ValidityType||(r.ValidityType={}));let t;(function(o){o[o.EOL=0]="EOL"})(t||(t={})),(function(o){o.codec=()=>kt(t)})(e=r.ValidityType||(r.ValidityType={}));let n;r.codec=()=>(n==null&&(n=Ie((o,i,s={})=>{s.lengthDelimited!==!1&&i.fork(),o.value!=null&&(i.uint32(10),i.bytes(o.value)),o.signatureV1!=null&&(i.uint32(18),i.bytes(o.signatureV1)),o.validityType!=null&&(i.uint32(24),r.ValidityType.codec().encode(o.validityType,i)),o.validity!=null&&(i.uint32(34),i.bytes(o.validity)),o.sequence!=null&&(i.uint32(40),i.uint64(o.sequence)),o.ttl!=null&&(i.uint32(48),i.uint64(o.ttl)),o.pubKey!=null&&(i.uint32(58),i.bytes(o.pubKey)),o.signatureV2!=null&&(i.uint32(66),i.bytes(o.signatureV2)),o.data!=null&&(i.uint32(74),i.bytes(o.data)),s.lengthDelimited!==!1&&i.ldelim()},(o,i,s={})=>{let a={},c=i==null?o.len:o.pos+i;for(;o.pos<c;){let l=o.uint32();switch(l>>>3){case 1:{a.value=o.bytes();break}case 2:{a.signatureV1=o.bytes();break}case 3:{a.validityType=r.ValidityType.codec().decode(o);break}case 4:{a.validity=o.bytes();break}case 5:{a.sequence=o.uint64();break}case 6:{a.ttl=o.uint64();break}case 7:{a.pubKey=o.bytes();break}case 8:{a.signatureV2=o.bytes();break}case 9:{a.data=o.bytes();break}default:{o.skipType(l&7);break}}}return a})),n),r.encode=o=>Te(o,r.codec()),r.decode=(o,i)=>Ae(o,r.codec(),i)})(un||(un={}));var tj=zn("ipns:utils"),gT=B("/ipns/");var rj=0,nj=18;function yT(r){let e;if(r.pubKey!=null)try{e=Kt(r.pubKey)}catch(t){throw tj.error(t),t}if(e!=null)return e}function wT(r){let e=B("ipns-signature:");return gt([e,r])}function Ih(r){return"signatureV1"in r?un.encode({value:B(r.value),signatureV1:r.signatureV1,validityType:r.validityType,validity:B(r.validity),sequence:r.sequence,ttl:r.ttl,pubKey:r.pubKey,signatureV2:r.signatureV2,data:r.data}):un.encode({pubKey:r.pubKey,signatureV2:r.signatureV2,data:r.data})}function ai(r){let e=un.decode(r);if(e.sequence!=null&&(e.sequence=BigInt(e.sequence)),e.ttl!=null&&(e.ttl=BigInt(e.ttl)),e.signatureV2==null||e.data==null)throw new No("Missing data or signatureV2");let t=bT(e.data),n=oj(t.Value),o=j(t.Validity);if(e.value!=null&&e.signatureV1!=null)return ij(e),{value:n,validityType:un.ValidityType.EOL,validity:o,sequence:t.Sequence,ttl:t.TTL,pubKey:e.pubKey,signatureV1:e.signatureV1,signatureV2:e.signatureV2,data:e.data};if(e.signatureV2!=null)return{value:n,validityType:un.ValidityType.EOL,validity:o,sequence:t.Sequence,ttl:t.TTL,pubKey:e.pubKey,signatureV2:e.signatureV2,data:e.data};throw new Error("invalid record: does not include signatureV1 or signatureV2")}function Ch(r){return gt([gT,r.bytes])}function ju(r){let e=lt(r.slice(gT.length));if(!$2(e,rj)&&!$2(e,nj))throw new Cs("Multihash in IPNS key was not identity or sha2-256");return e}function bT(r){let e=Nn(r);if(e.ValidityType===0)e.ValidityType=un.ValidityType.EOL;else throw new $u("The validity type is unsupported");return Number.isInteger(e.Sequence)&&(e.Sequence=BigInt(e.Sequence)),Number.isInteger(e.TTL)&&(e.TTL=BigInt(e.TTL)),e}function oj(r){let e=j(r).trim();if(e.startsWith("/"))return e;try{return`/ipfs/${he.decode(r).toV1().toString()}`}catch{}try{return`/ipfs/${he.parse(e).toV1().toString()}`}catch{}throw new U2("Value must be a valid content path starting with /")}function ij(r){if(r.data==null)throw new F2("Record data is missing");let e=bT(r.data);if(!we(e.Value,r.value??new Uint8Array(0)))throw new No('Field "value" did not match between protobuf and CBOR');if(!we(e.Validity,r.validity??new Uint8Array(0)))throw new No('Field "validity" did not match between protobuf and CBOR');if(e.ValidityType!==r.validityType)throw new No('Field "validityType" did not match between protobuf and CBOR');if(e.Sequence!==r.sequence)throw new No('Field "sequence" did not match between protobuf and CBOR');if(e.TTL!==r.ttl)throw new No('Field "ttl" did not match between protobuf and CBOR')}function $2(r,e){return r.code===e}var zle=zn("ipns"),Gle=300*1e9,aj="/ipns/",Xle=aj.length;var vT=nr(L2(),1);var j2=zn("ipns:validator"),cj=1024*10;async function lj(r,e){let t=ai(e),n;try{let o=wT(t.data);n=await r.verify(o,t.signatureV2)}catch{n=!1}if(!n)throw j2.error("record signature verification failed"),new No("Record signature verification failed");if(t.validityType===un.ValidityType.EOL){if(vT.default.fromString(t.validity).toDate().getTime()<Date.now())throw j2.error("record has expired"),new B2("record has expired")}else if(t.validityType!=null)throw j2.error("the validity type is unsupported"),new $u("The validity type is unsupported");j2("ipns record for %s is valid",t.value)}async function K2(r,e){if(e.byteLength>cj)throw new M2("The record is too large");let t=ju(r),n;$2(t,0)&&(n=Um(t));let o=ai(e),i=yT(o)??n;if(i==null)throw new Th("Could not extract public key from IPNS record or routing key");let s=Ch(i.toMultihash());if(!we(s,r))throw new Th("Embedded public key did not match routing key");await lj(i,e)}var V2=class extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MESSAGE_LENGTH"};async function*Ph(r,e={}){let t=/\r?\n/,n=new TextDecoder("utf8"),o="";for await(let i of r){if(typeof i=="string"&&(i=new TextEncoder().encode(i)),Hl(i)&&(i=i.subarray()),o+=n.decode(i,{stream:!0}),o.length>(e?.maxMessageLength??o.length))throw new V2("Incoming message too long");let s=o.split(t);o=s.pop()??"";for(let a=0;a<s.length;a++)yield JSON.parse(s[a])}o+=n.decode(),o!==""&&(yield JSON.parse(o))}var Ku=class extends Error{static name="InvalidRequestError";constructor(e="Invalid request"){super(e),this.name="InvalidRequestError"}},Lo=class extends Error{static name="BadResponseError";constructor(e="Bad response"){super(e),this.name="BadResponseError"}};function uj(r){return r[Symbol.asyncIterator]!=null}function fj(r){if(uj(r))return(async()=>{for await(let e of r)return e})();for(let e of r)return e}var xT=fj;var ET=B("/ipns/");function ST(r){return we(r.subarray(0,ET.byteLength),ET)}var H2=class{client;constructor(e){this.client=e}async*findProviders(e,t={}){try{yield*to(this.client.getProviders(e,t),n=>({id:n.ID,multiaddrs:n.Addrs??[],routing:"delegated-http-routing-v1"}))}catch(n){if(n instanceof Xe)return;throw n}}async provide(){}async cancelReprovide(){}async put(e,t,n){if(!ST(e))return;let o=ju(e),i=he.createV1(114,o),s=ai(t);await this.client.putIPNS(i,s,n)}async get(e,t){if(!ST(e))throw new Xe("Not found");let n=ju(e),o=he.createV1(114,n);try{let i=await this.client.getIPNS(o,t);return Ih(i)}catch(i){throw i.name==="BadResponseError"?new Xe("Not found"):i}}toString(){return`DelegatedRoutingV1HttpApiClientContentRouting(${this.client.url})`}},q2=class{client;constructor(e){this.client=e}async findPeer(e,t={}){let n=await xT(this.client.getPeers(e,t));if(n!=null)return{id:n.ID,multiaddrs:n.Addrs??[]};throw new Xe("Not found")}async*getClosestPeers(e,t={}){}toString(){return`DelegatedRoutingV1HttpApiClientPeerRouting(${this.client.url})`}};var W2={concurrentRequests:4,timeout:3e4,cacheTTL:300*1e3,cacheName:"delegated-routing-v1-cache"},z2=class{url;started;httpQueue;shutDownController;timeout;contentRouting;peerRouting;filterAddrs;filterProtocols;inFlightRequests;cacheName;cache;cacheTTL;log;constructor(e,t){this.log=e.logger.forComponent("delegated-routing-v1-http-api-client"),this.started=!1,this.shutDownController=new AbortController,this.shutDownController.signal,this.httpQueue=new za({concurrency:t.concurrentRequests??W2.concurrentRequests}),this.inFlightRequests=new Map,this.url=t.url instanceof URL?t.url:new URL(t.url),this.timeout=t.timeout??W2.timeout,this.filterAddrs=t.filterAddrs,this.filterProtocols=t.filterProtocols,this.contentRouting=new H2(this),this.peerRouting=new q2(this),this.cacheName=t.cacheName??W2.cacheName,this.cacheTTL=t.cacheTTL??W2.cacheTTL}get[ki](){return this.contentRouting}get[Ri](){return this.peerRouting}isStarted(){return this.started}async start(){this.started||(this.started=!0,this.cacheTTL>0&&(this.cache=await globalThis.caches?.open(this.cacheName),this.cache!=null&&this.log("cache enabled with ttl %d",this.cacheTTL)))}async stop(){this.httpQueue.clear(),this.shutDownController.abort(),await globalThis.caches?.delete(this.cacheName),this.started=!1}async*getProviders(e,t={}){this.log("getProviders starts: %c",e);let n=AbortSignal.timeout(this.timeout),o=De([this.shutDownController.signal,n,t.signal]);let i=Ve(),s=Ve(),a=0;this.httpQueue.add(async()=>(i.resolve(),s.promise));try{await i.promise;let c=new URL(`${this.url}routing/v1/providers/${e}`);this.#t(c,t.filterAddrs,t.filterProtocols);let l={headers:{accept:"application/x-ndjson, application/json;q=0.8"},signal:o},f=await this.#r(c.toString(),l);if(!f.ok){if(f.status===404)return;throw f.status===422?new Ku("Request does not conform to schema or semantic constraints"):new Lo(`Unexpected status code: ${f.status}`)}let u=f.headers.get("Content-Type");if(u==null)throw new Lo("No Content-Type header received");if(f.body==null){if(u!=="application/x-ndjson")throw new Lo("Routing response had no body");return}if(u.startsWith("application/json")){let h=(await f.json()).Providers??[];for(let m of h){let w=this.#e(m);w!=null&&(a++,yield w)}}else if(u.includes("application/x-ndjson"))for await(let d of Ph(N2(f.body))){let h=this.#e(d);h!=null&&(a++,yield h)}else throw new Lo(`Unsupported Content-Type: ${u}`)}finally{o.clear(),s.resolve(),this.log("getProviders finished found %d providers for %c",a,e)}}async*getPeers(e,t={}){this.log("getPeers starts: %c",e);let n=AbortSignal.timeout(this.timeout),o=De([this.shutDownController.signal,n,t.signal]);let i=Ve(),s=Ve();this.httpQueue.add(async()=>(i.resolve(),s.promise));try{await i.promise;let a=new URL(`${this.url}routing/v1/peers/${e.toCID().toString()}`);this.#t(a,t.filterAddrs,t.filterProtocols);let c={headers:{Accept:"application/x-ndjson"},signal:o},l=await this.#r(a.toString(),c);if(l.status===404)return;if(l.status===422)throw new Ku("Request does not conform to schema or semantic constraints");if(l.body==null)throw new Lo("Routing response had no body");if(l.headers.get("Content-Type")?.startsWith("application/json")){let d=(await l.json()).Peers??[];for(let h of d){let m=this.#e(h);m!=null&&(yield m)}}else for await(let u of Ph(N2(l.body))){let d=this.#e(u);d!=null&&(yield d)}}catch(a){this.log.error("getPeers errored - %e",a)}finally{o.clear(),s.resolve(),this.log("getPeers finished: %c",e)}}async getIPNS(e,t={}){this.log("getIPNS starts: %s",e);let n=AbortSignal.timeout(this.timeout),o=De([this.shutDownController.signal,n,t.signal]);let i=Ve(),s=Ve();this.httpQueue.add(async()=>(i.resolve(),s.promise));let a=`${this.url}routing/v1/ipns/${e}`;try{await i.promise;let c={headers:{Accept:"application/vnd.ipfs.ipns-record"},signal:o},l=await this.#r(a,c);if(this.log("getIPNS GET %s %d",a,l.status),l.status===404)throw new Xe("No matching records found");if(l.status===422)throw new Ku("Request does not conform to schema or semantic constraints");if(!l.ok)throw new Lo(`Unexpected status code: ${l.status}`);let f=l.headers.get("Content-Type");if(f==null||!f.includes("application/vnd.ipfs.ipns-record"))throw new Xe("No matching records found");if(l.body==null)throw new Lo("GET ipns response had no body");let u=await l.arrayBuffer(),d=new Uint8Array(u,0,u.byteLength);return t.validate!==!1&&await K2(Ch(e.multihash),d),ai(d)}catch(c){throw this.log.error("getIPNS GET %s error - %e",a,c),c}finally{o.clear(),s.resolve(),this.log("getIPNS finished: %s",e)}}async putIPNS(e,t,n={}){this.log("putIPNS starts: %c",e);let o=AbortSignal.timeout(this.timeout),i=De([this.shutDownController.signal,o,n.signal]);let s=Ve(),a=Ve();this.httpQueue.add(async()=>(s.resolve(),a.promise));let c=`${this.url}routing/v1/ipns/${e}`;try{await s.promise;let l=Ih(t),f={method:"PUT",headers:{"Content-Type":"application/vnd.ipfs.ipns-record"},body:l,signal:i},u=await this.#r(c,f);if(this.log("putIPNS PUT %s %d",c,u.status),u.status!==200)throw new Lo("PUT ipns response had status other than 200")}catch(l){throw this.log.error("putIPNS PUT %s error - %e",c,l.stack),l}finally{i.clear(),a.resolve(),this.log("putIPNS finished: %c",e)}}#e(e){try{let t=[],n=e.Addrs?.map(ie)??[];return e.Protocols!=null&&t.push(...e.Protocols),e.Protocol!=null&&(t.push(e.Protocol),delete e.Protocol),{...e,Schema:"peer",ID:yt(e.ID),Addrs:n,Protocols:t}}catch(t){this.log.error("could not conform record to peer schema - %e",t)}}#t(e,t,n){if(t!=null||this.filterAddrs!=null){let o=t?.join(",")??this.filterAddrs?.join(",")??"";o!==""&&e.searchParams.set("filter-addrs",o)}if(n!=null||this.filterProtocols!=null){let o=n?.join(",")??this.filterProtocols?.join(",")??"";o!==""&&e.searchParams.set("filter-protocols",o)}}async#r(e,t){let n=t.method??"GET",o=`${n}-${e}`;if(n==="GET"){let c=await this.cache?.match(e);if(c!=null){if(parseInt(c.headers.get("x-cache-expires")??"0",10)>Date.now())return this.log("returning cached response for %s",o),this.logResponse(c),c;this.log("evicting cached response for %s",o),await this.cache?.delete(e)}else this.cache!=null&&this.log("cache miss for %s",o)}let i=this.inFlightRequests.get(o);if(i!=null){let c=await i;return this.log("deduplicating outgoing request for %s",o),c.clone()}this.log("outgoing request:"),this.logRequest(e,t);let s=fetch(e,t).then(async c=>{if(this.log("incoming response:"),this.logResponse(c),this.cache!=null&&c.ok&&n==="GET"){let l=Date.now()+this.cacheTTL,f=new Headers(c.headers);f.set("x-cache-expires",l.toString());let u=new Response(c.clone().body,{status:c.status,statusText:c.statusText,headers:f});await this.cache.put(e,u)}return c}).finally(()=>{this.inFlightRequests.delete(o)});return this.inFlightRequests.set(o,s),await s}toString(){return`DefaultDelegatedRoutingV1HttpApiClient(${this.url})`}logRequest(e,t){let n=new Headers(t.headers);this.log("%s %s HTTP/1.1",t.method??"GET",e);for(let[o,i]of n.entries())this.log("%s: %s",o,i)}logResponse(e){this.log("HTTP/1.1 %d %s",e.status,e.statusText);for(let[t,n]of e.headers.entries())this.log("%s: %s",t,n)}};function _T(r,e={}){return new z2({logger:Qo()},{...e,url:new URL(r)})}function Nw(){return{filterProtocols:["unknown","transport-bitswap","transport-ipfs-gateway-http"],filterAddrs:["https","webtransport","webrtc","webrtc-direct","wss","tls"]}}var AT="[a-fA-F\\d:]",ta=r=>r&&r.includeBoundaries?`(?:(?<=\\s|^)(?=${AT})|(?<=${AT})(?=\\s|$))`:"",Bo="(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)(?:\\.(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)){3}",Gt="[a-fA-F\\d]{1,4}",G2=`
(?:
(?:${Gt}:){7}(?:${Gt}|:)|                                    // 1:2:3:4:5:6:7::  1:2:3:4:5:6:7:8
(?:${Gt}:){6}(?:${Bo}|:${Gt}|:)|                             // 1:2:3:4:5:6::    1:2:3:4:5:6::8   1:2:3:4:5:6::8  1:2:3:4:5:6::1.2.3.4
(?:${Gt}:){5}(?::${Bo}|(?::${Gt}){1,2}|:)|                   // 1:2:3:4:5::      1:2:3:4:5::7:8   1:2:3:4:5::8    1:2:3:4:5::7:1.2.3.4
(?:${Gt}:){4}(?:(?::${Gt}){0,1}:${Bo}|(?::${Gt}){1,3}|:)| // 1:2:3:4::        1:2:3:4::6:7:8   1:2:3:4::8      1:2:3:4::6:7:1.2.3.4
(?:${Gt}:){3}(?:(?::${Gt}){0,2}:${Bo}|(?::${Gt}){1,4}|:)| // 1:2:3::          1:2:3::5:6:7:8   1:2:3::8        1:2:3::5:6:7:1.2.3.4
(?:${Gt}:){2}(?:(?::${Gt}){0,3}:${Bo}|(?::${Gt}){1,5}|:)| // 1:2::            1:2::4:5:6:7:8   1:2::8          1:2::4:5:6:7:1.2.3.4
(?:${Gt}:){1}(?:(?::${Gt}){0,4}:${Bo}|(?::${Gt}){1,6}|:)| // 1::              1::3:4:5:6:7:8   1::8            1::3:4:5:6:7:1.2.3.4
(?::(?:(?::${Gt}){0,5}:${Bo}|(?::${Gt}){1,7}|:))             // ::2:3:4:5:6:7:8  ::2:3:4:5:6:7:8  ::8             ::1.2.3.4
)(?:%[0-9a-zA-Z]{1,})?                                             // %eth0            %1
`.replace(/\s*\/\/.*$/gm,"").replace(/\n/g,"").trim(),dj=new RegExp(`(?:^${Bo}$)|(?:^${G2}$)`),hj=new RegExp(`^${Bo}$`),pj=new RegExp(`^${G2}$`),Lw=r=>r&&r.exact?dj:new RegExp(`(?:${ta(r)}${Bo}${ta(r)})|(?:${ta(r)}${G2}${ta(r)})`,"g");Lw.v4=r=>r&&r.exact?hj:new RegExp(`${ta(r)}${Bo}${ta(r)}`,"g");Lw.v6=r=>r&&r.exact?pj:new RegExp(`${ta(r)}${G2}${ta(r)}`,"g");var Bw=Lw;function Mw(r){let e=(...t)=>r(...t);return Object.defineProperty(e,"name",{value:`functionTimeout(${r.name||"<anonymous>"})`,configurable:!0}),e}function TT(){return!1}var{toString:mj}=Object.prototype;function Uw(r){return mj.call(r)==="[object RegExp]"}var IT={global:"g",ignoreCase:"i",multiline:"m",dotAll:"s",sticky:"y",unicode:"u"};function Fw(r,e={}){if(!Uw(r))throw new TypeError("Expected a RegExp instance");let t=Object.keys(IT).map(o=>(typeof e[o]=="boolean"?e[o]:r[o])?IT[o]:"").join(""),n=new RegExp(e.source||r.source,t);return n.lastIndex=typeof e.lastIndex=="number"?e.lastIndex:r.lastIndex,n}function $w(r,e,{timeout:t}={}){try{return Mw(()=>Fw(r).test(e),{timeout:t})()}catch(n){if(TT(n))return!1;throw n}}var gj=15,yj=45,CT={timeout:400};function jw(r){return r.length>yj?!1:$w(Bw.v6({exact:!0}),r,CT)}function PT(r){return r.length>gj?!1:$w(Bw.v4({exact:!0}),r,CT)}var kT={http:"80",https:"443",ws:"80",wss:"443"},wj=["http","https","ws","wss"];function X2(r,e){e=e??{};let t=e.defaultDnsType??"dns",{scheme:n,hostname:o,port:i,path:s}=bj(r),a=[vj(o,t),xj(i,n),Ej(n)];s!=null&&a.push(Sj(s));let c="/"+a.filter(l=>!!l).reduce((l,f)=>l.concat(f),[]).join("/");return ie(c)}function bj(r){let[e]=r.split(":");wj.includes(e)||(r="http"+r.substring(e.length));let{protocol:t,hostname:n,port:o,pathname:i,search:s}=new URL(r);if(o==null||o===""){let c=_j(e);c!=null&&(o=c),c==null&&t==="http:"&&(o="80")}let a;return i!=null&&i!==""&&i!=="/"&&(i.startsWith("/")&&(i=i.substring(1)),a=i),s!=null&&s!==""&&(a=a??"",a+=s),{scheme:e,hostname:n,port:o,path:a}}function vj(r,e){if(!(r==null||r==="")){if(PT(r))return["ip4",r];if(jw(r))return["ip6",r];if(r[0]==="["){let t=r.substring(1,r.length-1);if(jw(t))return["ip6",t]}return[e,r]}}function xj(r,e){if(!(r==null||r===""))return e==="udp"?["udp",r]:["tcp",r]}function Ej(r){if(r.match(/^tcp$|^udp$/)==null)return r==="https"?["/tls/http"]:r==="wss"?["/tls/ws"]:[r]}function Sj(r){if(!(r==null||r===""))return["http-path",encodeURIComponent(r)]}function _j(r){if(!(r==null||r===""||kT[r]==null))return kT[r]}var Aj=["https://trustless-gateway.link","https://4everland.io"],Tj=2336;function Ij(r){return r=r.toString(),{id:Ro(he.createV1(Tj,Dr.digest(B(r)))),multiaddrs:[X2(r)]}}function Cj(r){return new URL(j(r.id.toMultihash().digest))}var Kw=class{gateways;shuffle;constructor(e={}){this.gateways=(e.gateways??Aj).map(t=>Ij(t)),this.shuffle=e.shuffle??!0}async*findProviders(e,t){yield*(this.shuffle?this.gateways.toSorted(()=>Math.random()>.5?1:-1):this.gateways).map(n=>({...n,protocols:["transport-ipfs-gateway-http"],routing:"http-gateway-routing"}))}toString(){return`HTTPGatewayRouter([${this.gateways.map(e=>Cj(e)).join(", ")}])`}};function Vw(r={}){return new Kw(r)}var Hw=class{libp2p;constructor(e){this.libp2p=e}async provide(e,t){await this.libp2p.contentRouting.provide(e,t)}async cancelReprovide(e,t){await this.libp2p.contentRouting.cancelReprovide(e,t)}async*findProviders(e,t){yield*this.libp2p.contentRouting.findProviders(e,t)}async put(e,t,n){await this.libp2p.contentRouting.put(e,t,n)}async get(e,t){return this.libp2p.contentRouting.get(e,t)}async findPeer(e,t){return this.libp2p.peerRouting.findPeer(e,t)}async*getClosestPeers(e,t){yield*this.libp2p.peerRouting.getClosestPeers(e,t)}toString(){return"Libp2pRouter()"}};function qw(r){return new Hw(r)}function Pj(r){return r[Symbol.asyncIterator]!=null}function kj(r){if(Pj(r))return(async()=>{let t=[];for await(let n of r)t.push(n);return t})();let e=[];for(let t of r)e.push(t);return e}var es=kj;function Oj(r){return typeof r?.then=="function"}var kh=class extends Yi{data;constructor(){super(),this.data=new Map}put(e,t,n){n?.signal?.throwIfAborted();let o;if(t instanceof Uint8Array)o=[t];else{let i=es(t);if(Oj(i))return i.then(s=>this._put(e,s,n));o=i}return this._put(e,o,n)}_put(e,t,n){return n?.signal?.throwIfAborted(),this.data.set(ir.encode(e.multihash.bytes),t),e}*get(e,t){t?.signal?.throwIfAborted();let n=this.data.get(ir.encode(e.multihash.bytes));if(n==null)throw new eo;yield*n}has(e,t){return t?.signal?.throwIfAborted(),this.data.has(ir.encode(e.multihash.bytes))}async delete(e,t){t?.signal?.throwIfAborted(),this.data.delete(ir.encode(e.multihash.bytes))}*getAll(e){e?.signal?.throwIfAborted();for(let[t,n]of this.data.entries())yield{cid:he.createV1(Ga,lt(ir.decode(t))),bytes:(async function*(){yield*n})()},e?.signal?.throwIfAborted()}};var Nfe=zn("blockstore:core:tiered");var OT="SHARDING";function Dj(r){return r[Symbol.asyncIterator]!=null}function Nj(r,e){return Dj(r)?(async function*(){yield*(await es(r)).sort(e)})():(function*(){yield*es(r).sort(e)})()}var Y2=Nj;var ts=class{put(e,t,n){return Promise.reject(new Error(".put is not implemented"))}get(e,t){return Promise.reject(new Error(".get is not implemented"))}has(e,t){return Promise.reject(new Error(".has is not implemented"))}delete(e,t){return Promise.reject(new Error(".delete is not implemented"))}async*putMany(e,t={}){for await(let{key:n,value:o}of e)await this.put(n,o,t),yield n}async*getMany(e,t={}){for await(let n of e)yield{key:n,value:await this.get(n,t)}}async*deleteMany(e,t={}){for await(let n of e)await this.delete(n,t),yield n}batch(){let e=[],t=[];return{put(n,o){e.push({key:n,value:o})},delete(n){t.push(n)},commit:async n=>{await an(this.putMany(e,n)),e=[],await an(this.deleteMany(t,n)),t=[]}}}async*_all(e,t){throw new Error("._all is not implemented")}async*_allKeys(e,t){throw new Error("._allKeys is not implemented")}query(e,t){let n=this._all(e,t);if(e.prefix!=null){let o=e.prefix;n=Oo(n,i=>i.key.toString().startsWith(o))}if(Array.isArray(e.filters)&&(n=e.filters.reduce((o,i)=>Oo(o,i),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((o,i)=>Y2(o,i),n)),e.offset!=null){let o=0,i=e.offset;n=Oo(n,()=>o++>=i)}return e.limit!=null&&(n=Js(n,e.limit)),n}queryKeys(e,t){let n=this._allKeys(e,t);if(e.prefix!=null){let o=e.prefix;n=Oo(n,i=>i.toString().startsWith(o))}if(Array.isArray(e.filters)&&(n=e.filters.reduce((o,i)=>Oo(o,i),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((o,i)=>Y2(o,i),n)),e.offset!=null){let o=e.offset,i=0;n=Oo(n,()=>i++>=o)}return e.limit!=null&&(n=Js(n,e.limit)),n}};var Oc=class extends ts{data;constructor(){super(),this.data=new Map}put(e,t,n){return n?.signal?.throwIfAborted(),this.data.set(e.toString(),t),e}get(e,t){t?.signal?.throwIfAborted();let n=this.data.get(e.toString());if(n==null)throw new eo;return n}has(e,t){return t?.signal?.throwIfAborted(),this.data.has(e.toString())}delete(e,t){t?.signal?.throwIfAborted(),this.data.delete(e.toString())}*_all(e,t){t?.signal?.throwIfAborted();for(let[n,o]of this.data.entries())yield{key:new ht(n),value:o},t?.signal?.throwIfAborted()}*_allKeys(e,t){t?.signal?.throwIfAborted();for(let n of this.data.keys())yield new ht(n),t?.signal?.throwIfAborted()}};var dde=new ht(OT);var Tde=zn("datastore:core:tiered");async function DT(r){if(r.connectionProtector===null&&globalThis.process?.env?.LIBP2P_FORCE_PNET!=null)throw new P("Private network is enforced, but no protector was provided");return r}var Oh;(function(r){let e;r.codec=()=>(e==null&&(e=Ie((t,n,o={})=>{o.lengthDelimited!==!1&&n.fork(),t.publicKey!=null&&t.publicKey.byteLength>0&&(n.uint32(10),n.bytes(t.publicKey)),t.payloadType!=null&&t.payloadType.byteLength>0&&(n.uint32(18),n.bytes(t.payloadType)),t.payload!=null&&t.payload.byteLength>0&&(n.uint32(26),n.bytes(t.payload)),t.signature!=null&&t.signature.byteLength>0&&(n.uint32(42),n.bytes(t.signature)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={publicKey:ke(0),payloadType:ke(0),payload:ke(0),signature:ke(0)},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{i.publicKey=t.bytes();break}case 2:{i.payloadType=t.bytes();break}case 3:{i.payload=t.bytes();break}case 5:{i.signature=t.bytes();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>Te(t,r.codec()),r.decode=(t,n)=>Ae(t,r.codec(),n)})(Oh||(Oh={}));var Q2=class extends Error{constructor(e="Invalid signature"){super(e),this.name="InvalidSignatureError"}};var Mn=class r{static createFromProtobuf=e=>{let t=Oh.decode(e),n=Kt(t.publicKey);return new r({publicKey:n,payloadType:t.payloadType,payload:t.payload,signature:t.signature})};static seal=async(e,t,n)=>{if(t==null)throw new Error("Missing private key");let o=e.domain,i=e.codec,s=e.marshal(),a=NT(o,i,s),c=await t.sign(a.subarray(),n);return new r({publicKey:t.publicKey,payloadType:i,payload:s,signature:c})};static openAndCertify=async(e,t,n)=>{let o=r.createFromProtobuf(e);if(!await o.validate(t,n))throw new Q2("Envelope signature is not valid for the given domain");return o};publicKey;payloadType;payload;signature;marshaled;constructor(e){let{publicKey:t,payloadType:n,payload:o,signature:i}=e;this.publicKey=t,this.payloadType=n,this.payload=o,this.signature=i}marshal(){return this.marshaled==null&&(this.marshaled=Oh.encode({publicKey:sr(this.publicKey),payloadType:this.payloadType,payload:this.payload.subarray(),signature:this.signature})),this.marshaled}equals(e){return e==null?!1:we(this.marshal(),e.marshal())}async validate(e,t){let n=NT(e,this.payloadType,this.payload);return this.publicKey.verify(n.subarray(),this.signature,t)}},NT=(r,e,t)=>{let n=B(r),o=Mr(n.byteLength),i=Mr(e.length),s=Mr(t.length);return new fe(o,n,i,e,s,t)};var LT="libp2p-peer-record",BT=Uint8Array.from([3,1]);var Rh;(function(r){let e;(function(n){let o;n.codec=()=>(o==null&&(o=Ie((i,s,a={})=>{a.lengthDelimited!==!1&&s.fork(),i.multiaddr!=null&&i.multiaddr.byteLength>0&&(s.uint32(10),s.bytes(i.multiaddr)),a.lengthDelimited!==!1&&s.ldelim()},(i,s,a={})=>{let c={multiaddr:ke(0)},l=s==null?i.len:i.pos+s;for(;i.pos<l;){let f=i.uint32();switch(f>>>3){case 1:{c.multiaddr=i.bytes();break}default:{i.skipType(f&7);break}}}return c})),o),n.encode=i=>Te(i,n.codec()),n.decode=(i,s)=>Ae(i,n.codec(),s)})(e=r.AddressInfo||(r.AddressInfo={}));let t;r.codec=()=>(t==null&&(t=Ie((n,o,i={})=>{if(i.lengthDelimited!==!1&&o.fork(),n.peerId!=null&&n.peerId.byteLength>0&&(o.uint32(10),o.bytes(n.peerId)),n.seq!=null&&n.seq!==0n&&(o.uint32(16),o.uint64(n.seq)),n.addresses!=null)for(let s of n.addresses)o.uint32(26),r.AddressInfo.codec().encode(s,o);i.lengthDelimited!==!1&&o.ldelim()},(n,o,i={})=>{let s={peerId:ke(0),seq:0n,addresses:[]},a=o==null?n.len:n.pos+o;for(;n.pos<a;){let c=n.uint32();switch(c>>>3){case 1:{s.peerId=n.bytes();break}case 2:{s.seq=n.uint64();break}case 3:{if(i.limits?.addresses!=null&&s.addresses.length===i.limits.addresses)throw new dt('Decode error - map field "addresses" had too many elements');s.addresses.push(r.AddressInfo.codec().decode(n,n.uint32(),{limits:i.limits?.addresses$}));break}default:{n.skipType(c&7);break}}}return s})),t),r.encode=n=>Te(n,r.codec()),r.decode=(n,o)=>Ae(n,r.codec(),o)})(Rh||(Rh={}));function MT(r,e){let t=(n,o)=>n.toString().localeCompare(o.toString());return r.length!==e.length?!1:(e.sort(t),r.sort(t).every((n,o)=>e[o].equals(n)))}var Zr=class r{static createFromProtobuf=e=>{let t=Rh.decode(e),n=zt(lt(t.peerId)),o=(t.addresses??[]).map(s=>ie(s.multiaddr)),i=t.seq;return new r({peerId:n,multiaddrs:o,seqNumber:i})};static DOMAIN=LT;static CODEC=BT;peerId;multiaddrs;seqNumber;domain=r.DOMAIN;codec=r.CODEC;marshaled;constructor(e){let{peerId:t,multiaddrs:n,seqNumber:o}=e;this.peerId=t,this.multiaddrs=n??[],this.seqNumber=o??BigInt(Date.now())}marshal(){return this.marshaled==null&&(this.marshaled=Rh.encode({peerId:this.peerId.toMultihash().bytes,seq:BigInt(this.seqNumber),addresses:this.multiaddrs.map(e=>({multiaddr:e.bytes}))})),this.marshaled}equals(e){return!(!(e instanceof r)||!this.peerId.equals(e.peerId)||this.seqNumber!==e.seqNumber||!MT(this.multiaddrs,e.multiaddrs))}};var rs;(function(r){let e;(function(o){let i;o.codec=()=>(i==null&&(i=Ie((s,a,c={})=>{c.lengthDelimited!==!1&&a.fork(),s.key!=null&&s.key!==""&&(a.uint32(10),a.string(s.key)),s.value!=null&&s.value.byteLength>0&&(a.uint32(18),a.bytes(s.value)),c.lengthDelimited!==!1&&a.ldelim()},(s,a,c={})=>{let l={key:"",value:ke(0)},f=a==null?s.len:s.pos+a;for(;s.pos<f;){let u=s.uint32();switch(u>>>3){case 1:{l.key=s.string();break}case 2:{l.value=s.bytes();break}default:{s.skipType(u&7);break}}}return l})),i),o.encode=s=>Te(s,o.codec()),o.decode=(s,a)=>Ae(s,o.codec(),a)})(e=r.Peer$metadataEntry||(r.Peer$metadataEntry={}));let t;(function(o){let i;o.codec=()=>(i==null&&(i=Ie((s,a,c={})=>{c.lengthDelimited!==!1&&a.fork(),s.key!=null&&s.key!==""&&(a.uint32(10),a.string(s.key)),s.value!=null&&(a.uint32(18),J2.codec().encode(s.value,a)),c.lengthDelimited!==!1&&a.ldelim()},(s,a,c={})=>{let l={key:""},f=a==null?s.len:s.pos+a;for(;s.pos<f;){let u=s.uint32();switch(u>>>3){case 1:{l.key=s.string();break}case 2:{l.value=J2.codec().decode(s,s.uint32(),{limits:c.limits?.value});break}default:{s.skipType(u&7);break}}}return l})),i),o.encode=s=>Te(s,o.codec()),o.decode=(s,a)=>Ae(s,o.codec(),a)})(t=r.Peer$tagsEntry||(r.Peer$tagsEntry={}));let n;r.codec=()=>(n==null&&(n=Ie((o,i,s={})=>{if(s.lengthDelimited!==!1&&i.fork(),o.addresses!=null)for(let a of o.addresses)i.uint32(10),Z2.codec().encode(a,i);if(o.protocols!=null)for(let a of o.protocols)i.uint32(18),i.string(a);if(o.publicKey!=null&&(i.uint32(34),i.bytes(o.publicKey)),o.peerRecordEnvelope!=null&&(i.uint32(42),i.bytes(o.peerRecordEnvelope)),o.metadata!=null&&o.metadata.size!==0)for(let[a,c]of o.metadata.entries())i.uint32(50),r.Peer$metadataEntry.codec().encode({key:a,value:c},i);if(o.tags!=null&&o.tags.size!==0)for(let[a,c]of o.tags.entries())i.uint32(58),r.Peer$tagsEntry.codec().encode({key:a,value:c},i);o.updated!=null&&(i.uint32(64),i.uint64Number(o.updated)),s.lengthDelimited!==!1&&i.ldelim()},(o,i,s={})=>{let a={addresses:[],protocols:[],metadata:new Map,tags:new Map},c=i==null?o.len:o.pos+i;for(;o.pos<c;){let l=o.uint32();switch(l>>>3){case 1:{if(s.limits?.addresses!=null&&a.addresses.length===s.limits.addresses)throw new dt('Decode error - map field "addresses" had too many elements');a.addresses.push(Z2.codec().decode(o,o.uint32(),{limits:s.limits?.addresses$}));break}case 2:{if(s.limits?.protocols!=null&&a.protocols.length===s.limits.protocols)throw new dt('Decode error - map field "protocols" had too many elements');a.protocols.push(o.string());break}case 4:{a.publicKey=o.bytes();break}case 5:{a.peerRecordEnvelope=o.bytes();break}case 6:{if(s.limits?.metadata!=null&&a.metadata.size===s.limits.metadata)throw new Ld('Decode error - map field "metadata" had too many elements');let f=r.Peer$metadataEntry.codec().decode(o,o.uint32());a.metadata.set(f.key,f.value);break}case 7:{if(s.limits?.tags!=null&&a.tags.size===s.limits.tags)throw new Ld('Decode error - map field "tags" had too many elements');let f=r.Peer$tagsEntry.codec().decode(o,o.uint32(),{limits:{value:s.limits?.tags$value}});a.tags.set(f.key,f.value);break}case 8:{a.updated=o.uint64Number();break}default:{o.skipType(l&7);break}}}return a})),n),r.encode=o=>Te(o,r.codec()),r.decode=(o,i)=>Ae(o,r.codec(),i)})(rs||(rs={}));var Z2;(function(r){let e;r.codec=()=>(e==null&&(e=Ie((t,n,o={})=>{o.lengthDelimited!==!1&&n.fork(),t.multiaddr!=null&&t.multiaddr.byteLength>0&&(n.uint32(10),n.bytes(t.multiaddr)),t.isCertified!=null&&(n.uint32(16),n.bool(t.isCertified)),t.observed!=null&&(n.uint32(24),n.uint64Number(t.observed)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={multiaddr:ke(0)},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{i.multiaddr=t.bytes();break}case 2:{i.isCertified=t.bool();break}case 3:{i.observed=t.uint64Number();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>Te(t,r.codec()),r.decode=(t,n)=>Ae(t,r.codec(),n)})(Z2||(Z2={}));var J2;(function(r){let e;r.codec=()=>(e==null&&(e=Ie((t,n,o={})=>{o.lengthDelimited!==!1&&n.fork(),t.value!=null&&t.value!==0&&(n.uint32(8),n.uint32(t.value)),t.expiry!=null&&(n.uint32(16),n.uint64(t.expiry)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={value:0},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{i.value=t.uint32();break}case 2:{i.expiry=t.uint64();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>Te(t,r.codec()),r.decode=(t,n)=>Ae(t,r.codec(),n)})(J2||(J2={}));function Lj(r,e){if(r.publicKey!=null||e.publicKey==null)return r;let t;r.type==="RSA"&&(t=r.toMultihash());let n=Kt(e.publicKey,t);return si(n)}function UT(r,e,t){let n=rs.decode(e);return Vu(r,n,t)}function Vu(r,e,t){let n=new Map,o=BigInt(Date.now());for(let[i,s]of e.tags.entries())s.expiry!=null&&s.expiry<o||n.set(i,s);return{...e,id:Lj(r,e),addresses:e.addresses.filter(({observed:i})=>i!=null&&i>Date.now()-t).map(({multiaddr:i,isCertified:s})=>({multiaddr:ie(i),isCertified:s??!1})),metadata:e.metadata,peerRecordEnvelope:e.peerRecordEnvelope??void 0,tags:n}}function FT(r,e){return Bj(r.addresses,e.addresses)&&Mj(r.protocols,e.protocols)&&Uj(r.publicKey,e.publicKey)&&Fj(r.peerRecordEnvelope,e.peerRecordEnvelope)&&$j(r.metadata,e.metadata)&&jj(r.tags,e.tags)}function Bj(r,e){return jT(r,e,(t,n)=>!(t.isCertified!==n.isCertified||!we(t.multiaddr,n.multiaddr)))}function Mj(r,e){return jT(r,e,(t,n)=>t===n)}function Uj(r,e){return $T(r,e)}function Fj(r,e){return $T(r,e)}function $j(r,e){return KT(r,e,(t,n)=>we(t,n))}function jj(r,e){return KT(r,e,(t,n)=>t.value===n.value&&t.expiry===n.expiry)}function $T(r,e){return r==null&&e==null?!0:r!=null&&e!=null?we(r,e):!1}function jT(r,e,t){if(r.length!==e.length)return!1;for(let n=0;n<r.length;n++)if(!t(r[n],e[n]))return!1;return!0}function KT(r,e,t){if(r.size!==e.size)return!1;for(let[n,o]of r.entries()){let i=e.get(n);if(i==null||!t(o,i))return!1}return!0}var Ww="/peers/";function Dh(r){if(!on(r)||r.type==null)throw new P("Invalid PeerId");let e=r.toCID().toString();return new ht(`${Ww}${e}`)}async function VT(r,e,t,n,o){let i=new Map;for(let s of t){if(s==null)continue;if(s.multiaddr instanceof Uint8Array&&(s.multiaddr=ie(s.multiaddr)),!oi(s.multiaddr))throw new P("Multiaddr was invalid");if(!await e(r,s.multiaddr,o))continue;let a=s.isCertified??!1,c=s.multiaddr.toString(),l=i.get(c);l!=null?s.isCertified=l.isCertified||a:i.set(c,{multiaddr:s.multiaddr,isCertified:a})}return[...i.values()].sort((s,a)=>s.multiaddr.toString().localeCompare(a.multiaddr.toString())).map(({isCertified:s,multiaddr:a})=>{let c=a.getComponents().find(l=>l.code===421)?.value;return r.equals(c)&&(a=a.decapsulate(ie(`/p2p/${r}`))),{isCertified:s,multiaddr:a.bytes}})}async function tg(r,e,t,n){if(e==null)throw new P("Invalid PeerData");if(e.publicKey!=null&&r.publicKey!=null&&!e.publicKey.equals(r.publicKey))throw new P("publicKey bytes do not match peer id publicKey bytes");let o=n.existingPeer?.peer;if(o!=null&&!r.equals(o.id))throw new P("peer id did not match existing peer id");let i=o?.addresses??[],s=new Set(o?.protocols??[]),a=o?.metadata??new Map,c=o?.tags??new Map,l=o?.peerRecordEnvelope;if(t==="patch"){if((e.multiaddrs!=null||e.addresses!=null)&&(i=[],e.multiaddrs!=null&&i.push(...e.multiaddrs.map(d=>({isCertified:!1,multiaddr:d}))),e.addresses!=null&&i.push(...e.addresses)),e.protocols!=null&&(s=new Set(e.protocols)),e.metadata!=null){let d=e.metadata instanceof Map?[...e.metadata.entries()]:Object.entries(e.metadata);a=eg(d,{validate:HT})}if(e.tags!=null){let d=e.tags instanceof Map?[...e.tags.entries()]:Object.entries(e.tags);c=eg(d,{validate:qT,map:WT})}e.peerRecordEnvelope!=null&&(l=e.peerRecordEnvelope)}if(t==="merge"){if(e.multiaddrs!=null&&i.push(...e.multiaddrs.map(d=>({isCertified:!1,multiaddr:d}))),e.addresses!=null&&i.push(...e.addresses),e.protocols!=null&&(s=new Set([...s,...e.protocols])),e.metadata!=null){let d=e.metadata instanceof Map?[...e.metadata.entries()]:Object.entries(e.metadata);for(let[h,m]of d)m==null?a.delete(h):a.set(h,m);a=eg([...a.entries()],{validate:HT})}if(e.tags!=null){let d=e.tags instanceof Map?[...e.tags.entries()]:Object.entries(e.tags),h=new Map(c);for(let[m,w]of d)w==null?h.delete(m):h.set(m,w);c=eg([...h.entries()],{validate:qT,map:WT})}e.peerRecordEnvelope!=null&&(l=e.peerRecordEnvelope)}let f;o?.id.publicKey!=null?f=sr(o.id.publicKey):e.publicKey!=null?f=sr(e.publicKey):r.publicKey!=null&&(f=sr(r.publicKey));let u={addresses:await VT(r,n.addressFilter??(async()=>!0),i,n.existingPeer?.peerPB.addresses,n),protocols:[...s.values()].sort((d,h)=>d.localeCompare(h)),metadata:a,tags:c,publicKey:f,peerRecordEnvelope:l};return u.addresses.forEach(d=>{d.observed=n.existingPeer?.peerPB.addresses?.find(h=>we(h.multiaddr,h.multiaddr))?.observed??Date.now()}),r.type!=="RSA"&&delete u.publicKey,u}function eg(r,e){let t=new Map;for(let[n,o]of r)o!=null&&e.validate(n,o);for(let[n,o]of r.sort(([i],[s])=>i.localeCompare(s)))o!=null&&t.set(n,e.map?.(n,o)??o);return t}function HT(r,e){if(typeof r!="string")throw new P("Metadata key must be a string");if(!(e instanceof Uint8Array))throw new P("Metadata value must be a Uint8Array")}function qT(r,e){if(typeof r!="string")throw new P("Tag name must be a string");if(e.value!=null){if(parseInt(`${e.value}`,10)!==e.value)throw new P("Tag value must be an integer");if(e.value<0||e.value>100)throw new P("Tag value must be between 0-100")}if(e.ttl!=null){if(parseInt(`${e.ttl}`,10)!==e.ttl)throw new P("Tag ttl must be an integer");if(e.ttl<0)throw new P("Tag ttl must be between greater than 0")}}function WT(r,e){let t;e.expiry!=null&&(t=e.expiry),e.ttl!=null&&(t=BigInt(Date.now()+Number(e.ttl)));let n={value:e.value??0};return t!=null&&(n.expiry=t),n}function zT(r){let e=r.toString().split("/")[2],t=he.parse(e,ir);return Ro(t)}function zw(r,e,t){let n=zT(r);return UT(n,e,t)}function Kj(r,e){return{prefix:Ww,filters:(r.filters??[]).map(t=>({key:n,value:o})=>t(zw(n,o,e))),orders:(r.orders??[]).map(t=>(n,o)=>t(zw(n.key,n.value,e),zw(o.key,o.value,e)))}}var rg=class{peerId;datastore;locks;addressFilter;log;maxAddressAge;maxPeerAge;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:peer-store"),this.peerId=e.peerId,this.datastore=e.datastore,this.addressFilter=t.addressFilter,this.locks=Qi({name:"libp2p_peer_store_locks",metrics:e.metrics}),this.maxAddressAge=t.maxAddressAge??36e5,this.maxPeerAge=t.maxPeerAge??216e5}getLock(e){let t=this.locks.get(e);return t==null&&(t={refs:0,lock:mh({name:e.toString(),singleProcess:!0})},this.locks.set(e,t)),t.refs++,t}maybeRemoveLock(e,t){t.refs--,t.refs===0&&(t.lock.finalize(),this.locks.delete(e))}async getReadLock(e,t){let n=this.getLock(e);try{let o=await n.lock.readLock(t);return()=>{o(),this.maybeRemoveLock(e,n)}}catch(o){throw this.maybeRemoveLock(e,n),o}}async getWriteLock(e,t){let n=this.getLock(e);try{let o=await n.lock.writeLock(t);return()=>{o(),this.maybeRemoveLock(e,n)}}catch(o){throw this.maybeRemoveLock(e,n),o}}async has(e,t){try{return await this.load(e,t),!0}catch(n){if(n.name!=="NotFoundError")throw n}return!1}async delete(e,t){this.peerId.equals(e)||await this.datastore.delete(Dh(e),t)}async load(e,t){let n=Dh(e),o=await this.datastore.get(n,t),i=rs.decode(o);if(this.#r(e,i))throw await this.datastore.delete(n,t),new Xe;return Vu(e,i,this.peerId.equals(e)?1/0:this.maxAddressAge)}async save(e,t,n){let o=await this.#e(e,n),i=await tg(e,t,"patch",{...n,addressFilter:this.addressFilter});return this.#t(e,i,o)}async patch(e,t,n){let o=await this.#e(e,n),i=await tg(e,t,"patch",{...n,addressFilter:this.addressFilter,existingPeer:o});return this.#t(e,i,o)}async merge(e,t,n){let o=await this.#e(e,n),i=await tg(e,t,"merge",{addressFilter:this.addressFilter,existingPeer:o});return this.#t(e,i,o)}async*all(e){for await(let{key:t,value:n}of this.datastore.query(Kj(e??{},this.maxAddressAge),e)){let o=zT(t);if(o.equals(this.peerId))continue;let i=rs.decode(n);if(this.#r(o,i)){await this.datastore.delete(t,e);continue}yield Vu(o,i,this.peerId.equals(o)?1/0:this.maxAddressAge)}}async#e(e,t){try{let n=Dh(e),o=await this.datastore.get(n,t),i=rs.decode(o);if(this.#r(e,i))throw await this.datastore.delete(n,t),new Xe;return{peerPB:i,peer:Vu(e,i,this.maxAddressAge)}}catch(n){n.name!=="NotFoundError"&&this.log.error("invalid peer data found in peer store - %e",n)}}async#t(e,t,n,o){t.updated=Date.now();let i=rs.encode(t);return await this.datastore.put(Dh(e),i,o),{peer:Vu(e,t,this.maxAddressAge),previous:n?.peer,updated:n==null||!FT(t,n.peerPB)}}#r(e,t){if(t.updated==null)return!0;if(this.peerId.equals(e))return!1;let n=t.updated<Date.now()-this.maxPeerAge,o=Date.now()-this.maxAddressAge,i=t.addresses.filter(s=>s.observed!=null&&s.observed>o);return n&&i.length===0}};var Gw=class{store;events;peerId;log;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:peer-store"),this.events=e.events,this.peerId=e.peerId,this.store=new rg(e,t)}[Symbol.toStringTag]="@libp2p/peer-store";async forEach(e,t){for await(let n of this.store.all(t))e(n)}async all(e){return es(this.store.all(e))}async delete(e,t){let n=await this.store.getReadLock(e,t);try{await this.store.delete(e,t)}finally{n()}}async has(e,t){let n=await this.store.getReadLock(e,t);try{return await this.store.has(e,t)}finally{this.log.trace("has release read lock"),n?.()}}async get(e,t){let n=await this.store.getReadLock(e,t);try{return await this.store.load(e,t)}finally{n?.()}}async getInfo(e,t){let n=await this.get(e,t);return{id:n.id,multiaddrs:n.addresses.map(({multiaddr:o})=>o)}}async save(e,t,n){let o=await this.store.getWriteLock(e,n);try{let i=await this.store.save(e,t,n);return this.#e(e,i),i.peer}finally{o?.()}}async patch(e,t,n){let o=await this.store.getWriteLock(e,n);try{let i=await this.store.patch(e,t,n);return this.#e(e,i),i.peer}finally{o?.()}}async merge(e,t,n){let o=await this.store.getWriteLock(e,n);try{let i=await this.store.merge(e,t,n);return this.#e(e,i),i.peer}finally{o?.()}}async consumePeerRecord(e,t,n){let o=on(t)?t:on(t?.expectedPeer)?t.expectedPeer:void 0,i=on(t)||t===void 0?n:t,s=await Mn.openAndCertify(e,Zr.DOMAIN,i),a=Ro(s.publicKey.toCID());if(o?.equals(a)===!1)return this.log("envelope peer id was not the expected peer id - expected: %p received: %p",o,a),!1;let c=Zr.createFromProtobuf(s.payload),l;try{l=await this.get(a,i)}catch(f){if(f.name!=="NotFoundError")throw f}if(l?.peerRecordEnvelope!=null){let f=Mn.createFromProtobuf(l.peerRecordEnvelope),u=Zr.createFromProtobuf(f.payload);if(u.seqNumber>=c.seqNumber)return this.log("sequence number was lower or equal to existing sequence number - stored: %d received: %d",u.seqNumber,c.seqNumber),!1}return await this.patch(c.peerId,{peerRecordEnvelope:e,addresses:c.multiaddrs.map(f=>({isCertified:!0,multiaddr:f}))},i),!0}#e(e,t){t.updated&&(this.peerId.equals(e)?this.events.safeDispatchEvent("self:peer:update",{detail:t}):this.events.safeDispatchEvent("peer:update",{detail:t}))}};function GT(r,e={}){return new Gw(r,e)}var XT=864e13;var ng=class{log;mappings;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:dns-mappings"),this.mappings=Wt({name:"libp2p_address_manager_dns_mappings",metrics:e.metrics})}has(e){let t=Ce(e),n=t.host;(t.type==="ip4"||t.type==="ip6")&&t.sni!=null&&(n=t.sni);for(let o of this.mappings.values())if(o.domain===n)return!0;return!1}add(e,t){t.forEach(n=>{this.log("add DNS mapping %s to %s",n,e);let o=hu(n)===!0;this.mappings.set(n,{domain:e,verified:o,expires:o?XT-Date.now():0,lastVerified:o?XT-Date.now():void 0})})}remove(e){let t=Ce(e);if(t.type!=="ip4"&&t.type!=="ip6")return!1;let n=!1;for(let[o,i]of this.mappings.entries())i.domain===t.sni&&(this.log("removing %s to %s DNS mapping %e",o,i.domain),this.mappings.delete(o),n=n||i.verified);return n}getAll(e){let t=[];for(let n=0;n<e.length;n++){let o=e[n].multiaddr;if(!mr(o))continue;let i=Ce(o);for(let[s,a]of this.mappings.entries()){if(i.host!==s)continue;let c=this.maybeAddSNIComponent(o,a.domain);c!=null&&(e.splice(n,1),n--,t.push({multiaddr:c,verified:a.verified,type:"dns-mapping",expires:a.expires,lastVerified:a.lastVerified}))}}return t}maybeAddSNIComponent(e,t){let n=e.getComponents();for(let o=0;o<n.length;o++)if(n[o].code===448&&n[o+1]?.code!==449)return n.splice(o+1,0,{name:"sni",code:449,value:t}),ie(n)}confirm(e,t){let n=Ce(e),o=n.host;(n.type==="ip4"||n.type==="ip6")&&n.sni!=null&&(o=n.sni);let i=!1;for(let[s,a]of this.mappings.entries())a.domain===o&&(this.log("marking %s to %s DNS mapping as verified",s,a.domain),i=a.verified,a.verified=!0,a.expires=Date.now()+t,a.lastVerified=Date.now());return i}unconfirm(e,t){let n=Ce(e);if(n.type!=="ip4"&&n.type!=="ip6")return!1;let o=n.sni??n.host,i=!1;for(let[s,a]of this.mappings.entries())a.domain===o&&(this.log("removing verification of %s to %s DNS mapping",s,a.domain),i=i||a.verified,a.verified=!1,a.expires=Date.now()+t);return i}};var og=class{log;mappings;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:ip-mappings"),this.mappings=Wt({name:"libp2p_address_manager_ip_mappings",metrics:e.metrics})}has(e){let t=Ce(e);if(t.type!=="ip4"&&t.type!=="ip6")return!1;for(let n of this.mappings.values())for(let o of n)if(o.externalIp===t.host)return!0;return!1}add(e,t,n,o=t,i="tcp"){let s=`${e}-${t}-${i}`,a=this.mappings.get(s)??[],c={internalIp:e,internalPort:t,externalIp:n,externalPort:o,externalFamily:Ao(n)?4:6,protocol:i,verified:!1,expires:0};a.push(c),this.mappings.set(s,a)}remove(e){let t=Ce(e);if(t.type!=="ip4"&&t.type!=="ip6")return!1;let n=!1;for(let[o,i]of this.mappings.entries()){for(let s=0;s<i.length;s++){let a=i[s];a.externalIp===t.host&&a.externalPort===t.port&&a.protocol===t.protocol&&(this.log("removing %s:%s to %s:%s %s IP mapping",a.externalIp,a.externalPort,t.host,t.port,t.protocol),n=n||a.verified,i.splice(s,1),s--)}i.length===0&&this.mappings.delete(o)}return n}getAll(e){let t=[];for(let{multiaddr:n}of e){if(!mr(n))continue;let o=Ce(n);if(o.type!=="ip4"&&o.type!=="ip6")continue;let i;if(o.protocol==="tcp"?i=`${o.host}-${o.port}-tcp`:o.protocol==="udp"&&(i=`${o.host}-${o.port}-udp`),i==null)continue;let s=this.mappings.get(i);if(s!=null)for(let a of s)t.push({multiaddr:this.maybeOverrideIp(n,a.externalIp,a.externalFamily,a.protocol,a.externalPort),verified:a.verified,type:"ip-mapping",expires:a.expires,lastVerified:a.lastVerified})}return t}maybeOverrideIp(e,t,n,o,i){let s=e.getComponents(),a=s.findIndex(l=>l.code===4||l.code===41),c=s.findIndex(l=>l.name===o);return a>-1&&c>-1?(s[a].value=t,s[a].code=n===4?4:41,s[c].value=`${i}`,ie(s)):e}confirm(e,t){if(!mr(e))return!1;let n=Ce(e),o=!1;for(let i of this.mappings.values())for(let s of i)s.externalIp===n.host&&(this.log("marking %s to %s IP mapping as verified",s.internalIp,s.externalIp),o=s.verified,s.verified=!0,s.expires=Date.now()+t,s.lastVerified=Date.now());return o}unconfirm(e,t){if(!mr(e))return!1;let n=Ce(e),o=!1;for(let i of this.mappings.values())for(let s=0;s<i.length;s++){let a=i[s];a.externalIp===n.host&&a.externalPort===n.port&&a.protocol===n.protocol&&(this.log("removing verification of %s:%s to %s:%s %s IP mapping",a.externalIp,a.externalPort,n.host,n.port,n.protocol),o=o||a.verified,a.verified=!1,a.expires=Date.now()+t)}return o}};var Vj={maxObservedAddresses:10},ig=class{log;addresses;maxObservedAddresses;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:observed-addresses"),this.addresses=Wt({name:"libp2p_address_manager_observed_addresses",metrics:e.metrics}),this.maxObservedAddresses=t.maxObservedAddresses??Vj.maxObservedAddresses}has(e){return this.addresses.has(e.toString())}removePrefixed(e){for(let t of this.addresses.keys())t.toString().startsWith(e)&&this.addresses.delete(t)}add(e){this.addresses.size!==this.maxObservedAddresses&&(Mt(e)||DS(e)||(this.log("adding observed address %a",e),this.addresses.set(e.toString(),{verified:!1,expires:0})))}getAll(){return Array.from(this.addresses).map(([e,t])=>({multiaddr:ie(e),verified:t.verified,type:"observed",expires:t.expires,lastVerified:t.lastVerified}))}remove(e){let t=this.addresses.get(e.toString())?.verified??!1;return this.log("removing observed address %a",e),this.addresses.delete(e.toString()),t}confirm(e,t){let n=e.toString(),o=this.addresses.get(n)??{verified:!1,expires:Date.now()+t,lastVerified:Date.now()},i=o.verified;return o.verified=!0,o.expires=Date.now()+t,o.lastVerified=Date.now(),this.log("marking observed address %a as verified",n),this.addresses.set(n,o),i}};var Hj={maxObservedAddresses:10},sg=class{log;addresses;maxObservedAddresses;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:observed-addresses"),this.addresses=Wt({name:"libp2p_address_manager_transport_addresses",metrics:e.metrics}),this.maxObservedAddresses=t.maxObservedAddresses??Hj.maxObservedAddresses}get(e,t){if(Mt(e))return{multiaddr:e,verified:!0,type:"transport",expires:Date.now()+t,lastVerified:Date.now()};let n=this.toKey(e),o=this.addresses.get(n);return o==null&&(o={verified:!mr(e),expires:0},this.addresses.set(n,o)),{multiaddr:e,verified:o.verified,type:"transport",expires:o.expires,lastVerified:o.lastVerified}}has(e){let t=this.toKey(e);return this.addresses.has(t)}remove(e){let t=this.toKey(e),n=this.addresses.get(t)?.verified??!1;return this.log("removing observed address %a",e),this.addresses.delete(t),n}confirm(e,t){let n=this.toKey(e),o=this.addresses.get(n)??{verified:!1,expires:0,lastVerified:0},i=o.verified;return o.verified=!0,o.expires=Date.now()+t,o.lastVerified=Date.now(),this.addresses.set(n,o),i}unconfirm(e,t){let n=this.toKey(e),o=this.addresses.get(n)??{verified:!1,expires:0},i=o.verified;return o.verified=!1,o.expires=Date.now()+t,this.addresses.set(n,o),i}toKey(e){if(!mr(e))return e.toString();let t=Ce(e);return`${t.host}-${t.port}-${t.protocol}`}};var YT=6e4,QT={maxObservedAddresses:10,addressVerificationTTL:YT*10,addressVerificationRetry:YT*5},qj=r=>r;function Xw(r,e){let t=r.getComponents().findLast(n=>n.code===421)?.value;return t!=null&&yt(t).equals(e)&&(r=r.decapsulate(ie(`/p2p/${e.toString()}`))),r}var ag=class{log;components;listen;announce;appendAnnounce;announceFilter;observed;dnsMappings;ipMappings;transportAddresses;observedAddressFilter;addressVerificationTTL;addressVerificationRetry;constructor(e,t={}){let{listen:n=[],announce:o=[],appendAnnounce:i=[]}=t;this.components=e,this.log=e.logger.forComponent("libp2p:address-manager"),this.listen=n.map(s=>s.toString()),this.announce=new Set(o.map(s=>s.toString())),this.appendAnnounce=new Set(i.map(s=>s.toString())),this.observed=new ig(e,t),this.dnsMappings=new ng(e,t),this.ipMappings=new og(e,t),this.transportAddresses=new sg(e,t),this.announceFilter=t.announceFilter??qj,this.observedAddressFilter=Fr(1024),this.addressVerificationTTL=t.addressVerificationTTL??QT.addressVerificationTTL,this.addressVerificationRetry=t.addressVerificationRetry??QT.addressVerificationRetry,this._updatePeerStoreAddresses=ji(this._updatePeerStoreAddresses.bind(this),1e3),e.events.addEventListener("transport:listening",()=>{this._updatePeerStoreAddresses()}),e.events.addEventListener("transport:close",()=>{this._updatePeerStoreAddresses()})}[Symbol.toStringTag]="@libp2p/address-manager";_updatePeerStoreAddresses(){let e=this.getAddresses().map(t=>t.getComponents().findLast(n=>n.code===421)?.value===this.components.peerId.toString()?t.decapsulate(`/p2p/${this.components.peerId.toString()}`):t);this.components.peerStore.patch(this.components.peerId,{multiaddrs:e}).catch(t=>{this.log.error("error updating addresses - %e",t)})}getListenAddrs(){return Array.from(this.listen).map(e=>ie(e))}getAnnounceAddrs(){return Array.from(this.announce).map(e=>ie(e))}getAppendAnnounceAddrs(){return Array.from(this.appendAnnounce).map(e=>ie(e))}getObservedAddrs(){return this.observed.getAll().map(e=>e.multiaddr)}addObservedAddr(e){let t=Ce(e),n;switch(t.type){case"ip4":{n=`${t.host}:${t.port}`;break}case"ip6":{n=`[${t.host}]:${t.port}`;break}default:return}this.observedAddressFilter.has(n)||(this.observedAddressFilter.add(n),e=Xw(e,this.components.peerId),!this.ipMappings.has(e)&&(this.dnsMappings.has(e)||this.observed.add(e)))}confirmObservedAddr(e,t){e=Xw(e,this.components.peerId);let n=!0;(t?.type==="transport"||this.transportAddresses.has(e))&&!this.transportAddresses.confirm(e,t?.ttl??this.addressVerificationTTL)&&n&&(n=!1),(t?.type==="dns-mapping"||this.dnsMappings.has(e))&&!this.dnsMappings.confirm(e,t?.ttl??this.addressVerificationTTL)&&n&&(n=!1),(t?.type==="ip-mapping"||this.ipMappings.has(e))&&!this.ipMappings.confirm(e,t?.ttl??this.addressVerificationTTL)&&n&&(n=!1),(t?.type==="observed"||this.observed.has(e))&&(this.maybeUpgradeToIPMapping(e)?(this.ipMappings.confirm(e,t?.ttl??this.addressVerificationTTL),n=!1):!this.observed.confirm(e,t?.ttl??this.addressVerificationTTL)&&n&&(n=!1)),n||this._updatePeerStoreAddresses()}removeObservedAddr(e,t){e=Xw(e,this.components.peerId);let n=!1;this.observed.has(e)&&!this.observed.remove(e)&&n&&(n=!1),this.transportAddresses.has(e)&&!this.transportAddresses.unconfirm(e,t?.ttl??this.addressVerificationRetry)&&n&&(n=!1),this.dnsMappings.has(e)&&!this.dnsMappings.unconfirm(e,t?.ttl??this.addressVerificationRetry)&&n&&(n=!1),this.ipMappings.has(e)&&!this.ipMappings.unconfirm(e,t?.ttl??this.addressVerificationRetry)&&n&&(n=!1),n&&this._updatePeerStoreAddresses()}getAddresses(){let e=new Set,t=this.getAddressesWithMetadata().filter(n=>{if(!n.verified)return!1;let o=n.multiaddr.toString();return e.has(o)?!1:(e.add(o),!0)}).map(n=>n.multiaddr);return this.announceFilter(t.map(n=>{let o=ie(n);return o.getComponents().pop()?.value===this.components.peerId.toString()?o:o.encapsulate(`/p2p/${this.components.peerId.toString()}`)}))}getAddressesWithMetadata(){let e=this.getAnnounceAddrs();if(e.length>0)return this.components.transportManager.getListeners().forEach(o=>{o.updateAnnounceAddrs(e)}),e.map(o=>({multiaddr:o,verified:!0,type:"announce",expires:Date.now()+this.addressVerificationTTL,lastVerified:Date.now()}));let t=[];t=t.concat(this.components.transportManager.getAddrs().map(o=>this.transportAddresses.get(o,this.addressVerificationTTL)));let n=this.getAppendAnnounceAddrs();return n.length>0&&(this.components.transportManager.getListeners().forEach(o=>{o.updateAnnounceAddrs(n)}),t=t.concat(n.map(o=>({multiaddr:o,verified:!0,type:"announce",expires:Date.now()+this.addressVerificationTTL,lastVerified:Date.now()})))),t=t.concat(this.observed.getAll()),t=t.concat(this.ipMappings.getAll(t)),t=t.concat(this.dnsMappings.getAll(t)),t}addDNSMapping(e,t){this.dnsMappings.add(e,t)}removeDNSMapping(e){this.dnsMappings.remove(ie(`/dns/${e}`))&&this._updatePeerStoreAddresses()}addPublicAddressMapping(e,t,n,o=t,i="tcp"){this.ipMappings.add(e,t,n,o,i),this.observed.removePrefixed(`/ip${Ao(n)?4:6}/${n}/${i}/${o}`)}removePublicAddressMapping(e,t,n,o=t,i="tcp"){this.ipMappings.remove(ie(`/ip${Ao(n)?4:6}/${n}/${i}/${o}`))&&this._updatePeerStoreAddresses()}maybeUpgradeToIPMapping(e){if(this.ipMappings.has(e)||!mr(e))return!1;let t=Ce(e);if(t.type!=="ip4"||hu(t.host)===!0)return!1;let n=this.components.transportManager.getListeners(),o=[i=>Ji.exactMatch(i)||kc.exactMatch(i),i=>Pc.exactMatch(i),i=>sT.exactMatch(i)];for(let i of o){if(!i(e))continue;let s=n.filter(l=>l.getAddrs().filter(f=>Ce(f).type==="ip4"&&i(f)).length>0);if(s.length!==1)continue;let a=s[0].getAddrs().filter(l=>!Wd(l)).pop();if(a==null)continue;let c=Ce(a);return c.port==null?!1:(this.observed.remove(e),this.ipMappings.add(c.host,c.port,t.host,t.port,t.protocol),!0)}return!1}};var ZT;(function(r){r.NOT_STARTED_YET="The libp2p node is not started yet",r.NOT_FOUND="Not found"})(ZT||(ZT={}));var cg=class extends Error{constructor(e="Missing service"){super(e),this.name="MissingServiceError"}},lg=class extends Error{constructor(e="Unmet service dependencies"){super(e),this.name="UnmetServiceDependenciesError"}},Hu=class extends Error{constructor(e="No content routers available"){super(e),this.name="NoContentRoutersError"}},Nh=class extends Error{constructor(e="No peer routers available"){super(e),this.name="NoPeerRoutersError"}},ug=class extends Error{constructor(e="Should not try to find self"){super(e),this.name="QueriedForSelfError"}},fg=class extends Error{constructor(e="Unhandled protocol error"){super(e),this.name="UnhandledProtocolError"}},dg=class extends Error{constructor(e="Duplicate protocol handler error"){super(e),this.name="DuplicateProtocolHandlerError"}},Lh=class extends Error{constructor(e="Dial denied error"){super(e),this.name="DialDeniedError"}},hg=class extends Error{constructor(e="No transport was configured to listen on this address"){super(e),this.name="UnsupportedListenAddressError"}},pg=class extends Error{constructor(e="Configured listen addresses could not be listened on"){super(e),this.name="UnsupportedListenAddressesError"}},mg=class extends Error{constructor(e="No valid addresses"){super(e),this.name="NoValidAddressesError"}},gg=class extends Error{constructor(e="Connection intercepted"){super(e),this.name="ConnectionInterceptedError"}},yg=class extends Error{constructor(e="Connection denied"){super(e),this.name="ConnectionDeniedError"}},ra=class extends Error{constructor(e="Stream is not multiplexed"){super(e),this.name="MuxerUnavailableError"}},Rc=class extends Error{constructor(e="Encryption failed"){super(e),this.name="EncryptionFailedError"}},wg=class extends Error{constructor(e="Transport unavailable"){super(e),this.name="TransportUnavailableError"}},bg=class extends Error{constructor(e="Max recursive depth reached"){super(e),this.name="RecursionLimitError"}};var Yw=class{components={};_started=!1;constructor(e={}){this.components={};for(let[t,n]of Object.entries(e))this.components[t]=n;this.components.logger==null&&(this.components.logger=Qo())}isStarted(){return this._started}async _invokeStartableMethod(e){await Promise.all(Object.values(this.components).filter(t=>cm(t)).map(async t=>{await t[e]?.()}))}async beforeStart(){await this._invokeStartableMethod("beforeStart")}async start(){await this._invokeStartableMethod("start"),this._started=!0}async afterStart(){await this._invokeStartableMethod("afterStart")}async beforeStop(){await this._invokeStartableMethod("beforeStop")}async stop(){await this._invokeStartableMethod("stop"),this._started=!1}async afterStop(){await this._invokeStartableMethod("afterStop")}},Wj=["metrics","connectionProtector","dns"],zj=["components","isStarted","beforeStart","start","afterStart","beforeStop","stop","afterStop","then","_invokeStartableMethod"];function JT(r={}){let e=new Yw(r);return new Proxy(e,{get(n,o,i){if(typeof o=="string"&&!zj.includes(o)){let s=e.components[o];if(s==null&&!Wj.includes(o))throw new cg(`${o} not set`);return s}return Reflect.get(n,o,i)},set(n,o,i){return typeof o=="string"?e.components[o]=i:Reflect.set(n,o,i),!0}})}function eI(r){let e={};for(let t of Object.values(r.components))for(let n of Gj(t))e[n]=!0;for(let t of Object.values(r.components))for(let n of Xj(t))if(e[n]!==!0)throw new lg(`Service "${Yj(t)}" required capability "${n}" but it was not provided by any component, you may need to add additional configuration when creating your node.`)}function Gj(r){return Array.isArray(r?.[qe])?r[qe]:[]}function Xj(r){return Array.isArray(r?.[An])?r[An]:[]}function Yj(r){return r?.[Symbol.toStringTag]??r?.toString()??"unknown"}function tI(r={}){return r.denyDialMultiaddr==null&&(r.denyDialMultiaddr=e=>Ji.matches(e)?!0:Mt(e)),r}var Qw=class extends Error{constructor(e){super(e),this.name="TimeoutError"}},Zw=class extends Error{constructor(e){super(),this.name="AbortError",this.message=e}},rI=r=>globalThis.DOMException===void 0?new Zw(r):new DOMException(r),nI=r=>{let e=r.reason===void 0?rI("This operation was aborted."):r.reason;return e instanceof Error?e:rI(e)};function Jw(r,e){let{milliseconds:t,fallback:n,message:o,customTimers:i={setTimeout,clearTimeout}}=e,s,a,l=new Promise((f,u)=>{if(typeof t!="number"||Math.sign(t)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${t}\``);if(e.signal){let{signal:h}=e;h.aborted&&u(nI(h)),a=()=>{u(nI(h))},h.addEventListener("abort",a,{once:!0})}if(t===Number.POSITIVE_INFINITY){r.then(f,u);return}let d=new Qw;s=i.setTimeout.call(void 0,()=>{if(n){try{f(n())}catch(h){u(h)}return}typeof r.cancel=="function"&&r.cancel(),o===!1?f():o instanceof Error?u(o):(d.message=o??`Promise timed out after ${t} milliseconds`,u(d))},t),(async()=>{try{f(await r)}catch(h){u(h)}})()}).finally(()=>{l.clear(),a&&e.signal&&e.signal.removeEventListener("abort",a)});return l.clear=()=>{i.clearTimeout.call(void 0,s),s=void 0},l}var Qj=r=>{let e=r.addEventListener||r.on||r.addListener,t=r.removeEventListener||r.off||r.removeListener;if(!e||!t)throw new TypeError("Emitter is not compatible");return{addListener:e.bind(r),removeListener:t.bind(r)}};function Zj(r,e,t){let n,o=new Promise((i,s)=>{if(t={rejectionEvents:["error"],multiArgs:!1,rejectionMultiArgs:!1,resolveImmediately:!1,...t},!(t.count>=0&&(t.count===Number.POSITIVE_INFINITY||Number.isInteger(t.count))))throw new TypeError("The `count` option should be at least 0 or more");t.signal?.throwIfAborted();let a=[e].flat(),c=[],{addListener:l,removeListener:f}=Qj(r),u=async(...h)=>{let m=t.multiArgs?h:h[0];if(t.filter)try{if(!await t.filter(m))return}catch(w){n(),s(w);return}c.push(m),t.count===c.length&&(n(),i(c))},d=(...h)=>{n(),s(t.rejectionMultiArgs?h:h[0])};n=()=>{for(let h of a)f(h,u);for(let h of t.rejectionEvents)a.includes(h)||f(h,d)};for(let h of a)l(h,u);for(let h of t.rejectionEvents)a.includes(h)||l(h,d);t.signal&&t.signal.addEventListener("abort",()=>{d(t.signal.reason)},{once:!0}),t.resolveImmediately&&i(c)});if(o.cancel=n,typeof t.timeout=="number"){let i=Jw(o,{milliseconds:t.timeout});return i.cancel=()=>{n(),i.clear()},i}return o}function Bh(r,e,t){typeof t=="function"&&(t={filter:t}),t={...t,count:1,resolveImmediately:!1};let n=Zj(r,e,t),o=n.then(i=>i[0]);return o.cancel=n.cancel,o}function vg(r){if(on(r))return{peerId:r,multiaddrs:[]};let e=Array.isArray(r)?r:[r],t;if(e.length>0){let n=e[0].getComponents().findLast(o=>o.code===421)?.value;t=n==null?void 0:yt(n),e.forEach(o=>{if(!oi(o))throw new Xo("Invalid multiaddr");let i=o.getComponents().findLast(s=>s.code===421)?.value;if(i==null){if(t!=null)throw new P("Multiaddrs must all have the same peer id or have no peer id")}else{let s=yt(i);if(t?.equals(s)!==!0)throw new P("Multiaddrs must all have the same peer id or have no peer id")}})}return e=e.filter(n=>!tT.exactMatch(n)),{peerId:t,multiaddrs:e}}var Jj=["/ipfs/id/1.0.0","/ipfs/id/push/1.0.0","/libp2p/autonat/1.0.0","/libp2p/dcutr"];async function oI(r,e){let t=r?.streams?.map(o=>o.protocol)??[],n=e?.closableProtocols??Jj;if(!(t.filter(o=>o!=null&&!n.includes(o)).length>0))try{await r?.close(e)}catch(o){r?.abort(o)}}function Mh(r){let e=Ce(r),t=e.cidr;if(e.type!=="ip4"&&e.type!=="ip6")throw new P(`Multiaddr ${r} was not an IPv4 or IPv6 address`);if(t==null)switch(e.type){case"ip4":{t=32;break}case"ip6":{t=128;break}default:throw new P(`Multiaddr ${r} was not an IPv4 or IPv6 address`)}return new gc(e.host,t)}function e7(r){return!fr.exactMatch(r)}function xg(r,e,t){if(r==null||e==null)return;let n=e.sort((i,s)=>i.direct?-1:s.direct?1:0).find(i=>i.limits==null);if(n==null||n.direct||t==null)return n;if(!t.some(i=>e7(i)))return n}var Eg=class{connectionManager;peerStore;allow;events;log;constructor(e,t={}){this.allow=(t.allow??[]).map(n=>Mh(n)),this.connectionManager=e.connectionManager,this.peerStore=e.peerStore,this.events=e.events,this.log=e.logger.forComponent("libp2p:connection-manager:connection-pruner"),this.maybePruneConnections=this.maybePruneConnections.bind(this)}start(){this.events.addEventListener("connection:open",this.maybePruneConnections)}stop(){this.events.removeEventListener("connection:open",this.maybePruneConnections)}maybePruneConnections(){this._maybePruneConnections().catch(e=>{this.log.error("error while pruning connections - %e",e)})}async _maybePruneConnections(){let e=this.connectionManager.getConnections(),t=e.length,n=this.connectionManager.getMaxConnections();if(this.log("checking max connections limit %d/%d",t,n),t<=n)return;let o=new $r;for(let c of e){let l=c.remotePeer;if(!o.has(l)){o.set(l,0);try{let f=await this.peerStore.get(l);o.set(l,[...f.tags.values()].reduce((u,d)=>u+d.value,0))}catch(f){f.name!=="NotFoundError"&&this.log.error("error loading peer tags - %e",f)}}}let i=this.sortConnections(e,o),s=Math.max(t-n,0),a=[];for(let c of i)if(this.log("too many connections open - closing a connection to %p",c.remotePeer),this.allow.some(f=>{if(mr(c.remoteAddr)){let u=Ce(c.remoteAddr);return f.contains(u.host)}return!0})||a.push(c),a.length===s)break;await Promise.all(a.map(async c=>{await oI(c,{signal:AbortSignal.timeout(1e3)})})),this.events.safeDispatchEvent("connection:prune",{detail:a})}sortConnections(e,t){return e.sort((n,o)=>{let i=n.timeline.open,s=o.timeline.open;return i<s?1:i>s?-1:0}).sort((n,o)=>n.direction==="outbound"&&o.direction==="inbound"?1:n.direction==="inbound"&&o.direction==="outbound"?-1:0).sort((n,o)=>n.streams.length>o.streams.length?1:n.streams.length<o.streams.length?-1:0).sort((n,o)=>{let i=t.get(n.remotePeer)??0,s=t.get(o.remotePeer)??0;return i>s?1:i<s?-1:0})}};var iI="last-dial-failure",sI="last-dial-success";var aI=100,Sg=50;function eK(r,e){let t=Pc.exactMatch(r.multiaddr),n=Pc.exactMatch(e.multiaddr);if(t&&!n)return-1;if(!t&&n)return 1;let o=kc.exactMatch(r.multiaddr),i=kc.exactMatch(e.multiaddr);if(o&&!i)return-1;if(!o&&i)return 1;let s=Ji.exactMatch(r.multiaddr),a=Ji.exactMatch(e.multiaddr);if(s&&!a)return-1;if(!s&&a)return 1;let c=Ah.exactMatch(r.multiaddr),l=Ah.exactMatch(e.multiaddr);if(c&&!l)return-1;if(!c&&l)return 1;let f=_h.exactMatch(r.multiaddr),u=_h.exactMatch(e.multiaddr);if(f&&!u)return-1;if(!f&&u)return 1;let d=Pw.exactMatch(r.multiaddr),h=Pw.exactMatch(e.multiaddr);return d&&!h?-1:!d&&h?1:0}function tK(r,e){let t=Wd(r.multiaddr),n=Wd(e.multiaddr);return t&&!n?1:!t&&n?-1:0}function rK(r,e){let t=Mt(r.multiaddr),n=Mt(e.multiaddr);return t&&!n?1:!t&&n?-1:0}function nK(r,e){return r.isCertified&&!e.isCertified?-1:!r.isCertified&&e.isCertified?1:0}function oK(r,e){let t=fr.exactMatch(r.multiaddr),n=fr.exactMatch(e.multiaddr);return t&&!n?1:!t&&n?-1:0}function cI(r){return r.sort(eK).sort(nK).sort(oK).sort(rK).sort(tK)}var t7=class{dns;canResolve(e){return e.getComponents().some(({name:t})=>t==="dnsaddr")}async resolve(e,t){let n=e.getComponents().find(c=>c.name==="dnsaddr")?.value;if(n==null)return[e];let i=await this.getDNS(t).query(`_dnsaddr.${n}`,{signal:t?.signal,types:[Tn.TXT]}),s=e.getComponents().find(c=>c.name==="p2p")?.value,a=[];for(let c of i.Answer){let l=c.data.replace(/["']/g,"").trim().split("=")[1];l!=null&&(s!=null&&!l.includes(s)||a.push(ie(l)))}return a}getDNS(e){return e.dns!=null?e.dns:(this.dns==null&&(this.dns=vm()),this.dns)}},Uh=new t7;async function r7(r,e,t){let n=t.depth??0;if(n>(t.maxRecursiveDepth??32))throw new bg("Max recursive depth reached");let o=!1,i=[];for(let s of Object.values(e))if(s.canResolve(r)){o=!0;let a=await s.resolve(r,t);for(let c of a)i.push(...await r7(c,e,{...t,depth:n+1}))}return o===!1&&i.push(r),i}var Fh={maxParallelDials:Sg,maxDialQueueLength:500,maxPeerAddrsToDial:25,dialTimeout:1e4,resolvers:{dnsaddr:Uh}},_g=class{queue;components;addressSorter;maxPeerAddrsToDial;maxDialQueueLength;dialTimeout;shutDownController;connections;log;resolvers;constructor(e,t={}){this.addressSorter=t.addressSorter,this.maxPeerAddrsToDial=t.maxPeerAddrsToDial??Fh.maxPeerAddrsToDial,this.maxDialQueueLength=t.maxDialQueueLength??Fh.maxDialQueueLength,this.dialTimeout=t.dialTimeout??Fh.dialTimeout,this.connections=t.connections??new $r,this.log=e.logger.forComponent("libp2p:connection-manager:dial-queue"),this.components=e,this.resolvers=t.resolvers??Fh.resolvers,this.shutDownController=new AbortController,this.shutDownController.signal,this.queue=new k0({concurrency:t.maxParallelDials??Fh.maxParallelDials,metricName:"libp2p_dial_queue",metrics:e.metrics}),this.queue.addEventListener("failure",n=>{n.detail?.error.name!==Hr.name&&this.log.error("error in dial queue - %e",n.detail.error)})}start(){this.shutDownController=new AbortController,this.shutDownController.signal}stop(){this.shutDownController.abort(),this.queue.abort()}async dial(e,t={}){let{peerId:n,multiaddrs:o}=vg(e);if(n!=null&&t.force!==!0){let s=xg(n,this.connections.get(n),o);if(s!=null)return this.log("already connected to %a",s.remoteAddr),t.onProgress?.(new oe("dial-queue:already-connected")),s}let i=this.queue.queue.find(s=>{if(n?.equals(s.options.peerId)===!0)return!0;let a=s.options.multiaddrs;if(a==null)return!1;for(let c of o)if(a.has(c.toString()))return!0;return!1});if(i!=null){this.log("joining existing dial target for %p",n);for(let s of o)i.options.multiaddrs.add(s.toString());return t.onProgress?.(new oe("dial-queue:already-in-dial-queue")),i.join(t)}if(this.queue.size>=this.maxDialQueueLength)throw new Ps("Dial queue is full");return this.log("creating dial target for %p",n,o.map(s=>s.toString())),t.onProgress?.(new oe("dial-queue:add-to-dial-queue")),this.queue.add(async s=>{s.onProgress?.(new oe("dial-queue:start-dial"));let a=De([this.shutDownController.signal,s.signal]);try{return await this.dialPeer(s,a)}finally{a.clear()}},{peerId:n,priority:t.priority??s7,multiaddrs:new Set(o.map(s=>s.toString())),signal:t.signal??AbortSignal.timeout(this.dialTimeout),onProgress:t.onProgress})}async dialPeer(e,t){let n=e.peerId,o=e.multiaddrs,i=new Set,s=e.multiaddrs.size===0,a=0,c=0,l=[];for(this.log("starting dial to %p",n);s||o.size>0;){c++,s=!1;let f=[],u=new Set(e.multiaddrs);o.clear(),this.log("calculating addrs to dial %p from %s",n,[...u]);let d=await this.calculateMultiaddrs(n,u,{...e,signal:t});for(let h of d){if(i.has(h.multiaddr.toString())){this.log.trace("skipping previously failed multiaddr %a while dialing %p",h.multiaddr,n);continue}f.push(h)}this.log("%s dial to %p with %s",c===1?"starting":"continuing",n,f.map(h=>h.multiaddr.toString())),e?.onProgress?.(new oe("dial-queue:calculated-addresses",f));for(let h of f){if(a===this.maxPeerAddrsToDial)throw this.log("dialed maxPeerAddrsToDial (%d) addresses for %p, not trying any others",a,e.peerId),new Ps("Peer had more than maxPeerAddrsToDial");a++;try{let m=await this.components.transportManager.dial(h.multiaddr,{...e,signal:t});this.log("dial to %a succeeded",h.multiaddr);try{await this.components.peerStore.merge(m.remotePeer,{multiaddrs:[m.remoteAddr],metadata:{[sI]:B(Date.now().toString())}})}catch(w){this.log.error("could not update last dial failure key for %p - %e",n,w)}return m}catch(m){if(this.log.error("dial failed to %a - %e",h.multiaddr,m),i.add(h.multiaddr.toString()),n!=null)try{await this.components.peerStore.merge(n,{metadata:{[iI]:B(Date.now().toString())}})}catch(w){this.log.error("could not update last dial failure key for %p - %e",n,w)}if(t.aborted)throw new Yo(m.message);l.push(m)}}}throw l.length===1?l[0]:new AggregateError(l,"All multiaddr dials failed")}async calculateMultiaddrs(e,t=new Set,n={}){let o=[...t].map(u=>({multiaddr:ie(u),isCertified:!1}));if(e!=null){if(this.components.peerId.equals(e))throw new Ps("Tried to dial self");if(await this.components.connectionGater.denyDialPeer?.(e)===!0)throw new Lh("The dial request is blocked by gater.allowDialPeer");if(o.length===0){this.log("loading multiaddrs for %p",e);try{let u=await this.components.peerStore.get(e);o.push(...u.addresses),this.log("loaded multiaddrs for %p",e,o.map(({multiaddr:d})=>d.toString()))}catch(u){if(u.name!=="NotFoundError")throw u}}if(o.length===0){this.log("looking up multiaddrs for %p in the peer routing",e);try{let u=await this.components.peerRouting.findPeer(e,n);this.log("found multiaddrs for %p in the peer routing",e,o.map(({multiaddr:d})=>d.toString())),o.push(...u.multiaddrs.map(d=>({multiaddr:d,isCertified:!1})))}catch(u){u.name==="NoPeerRoutersError"?this.log("no peer routers configured",e):this.log.error("looking up multiaddrs for %p in the peer routing failed - %e",e,u)}}}let i=(await Promise.all(o.map(async u=>{let d=await r7(u.multiaddr,this.resolvers,{dns:this.components.dns,log:this.log,...n});return d.length===1&&d[0].equals(u.multiaddr)?u:d.map(h=>({multiaddr:h,isCertified:!1}))}))).flat();if(e!=null){let u=`/p2p/${e.toString()}`;i=i.map(d=>d.multiaddr.getComponents().pop()?.name!=="p2p"?{multiaddr:d.multiaddr.encapsulate(u),isCertified:d.isCertified}:d)}let s=i.filter(u=>{if(this.components.transportManager.dialTransportForMultiaddr(u.multiaddr)==null)return!1;let d=u.multiaddr.getComponents().findLast(h=>h.code===421)?.value;return e!=null&&d!=null?e.equals(d):!0}),a=new Map;for(let u of s){let d=u.multiaddr.toString(),h=a.get(d);if(h!=null){h.isCertified=h.isCertified||u.isCertified||!1;continue}a.set(d,u)}let c=[...a.values()];if(c.length===0)throw new mg("The dial request has no valid addresses");let l=[];for(let u of c)this.components.connectionGater.denyDialMultiaddr!=null&&await this.components.connectionGater.denyDialMultiaddr(u.multiaddr)||l.push(u);let f=this.addressSorter==null?cI(l):l.sort(this.addressSorter);if(f.length===0)throw new Lh("The connection gater denied all addresses in the dial request");return this.log.trace("addresses for %p before filtering",e??"unknown peer",i.map(({multiaddr:u})=>u.toString())),this.log.trace("addresses for %p after filtering",e??"unknown peer",f.map(({multiaddr:u})=>u.toString())),f}async isDialable(e,t={}){Array.isArray(e)||(e=[e]);try{let n=await this.calculateMultiaddrs(void 0,new Set(e.map(o=>o.toString())),t);return t.runOnLimitedConnection===!1?n.find(o=>!fr.matches(o.multiaddr))!=null:!0}catch{}return!1}};var iK=Object.prototype.toString,sK=r=>iK.call(r)==="[object Error]",aK=new Set(["network error","Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed","fetch failed","terminated"," A network error occurred.","Network connection lost"]);function a7(r){if(!(r&&sK(r)&&r.name==="TypeError"&&typeof r.message=="string"))return!1;let{message:t,stack:n}=r;return t==="Load failed"?n===void 0||"__sentry_captured__"in r:t.startsWith("error sending request for url")?!0:aK.has(t)}function cK(r){if(typeof r=="number"){if(r<0)throw new TypeError("Expected `retries` to be a non-negative number.");if(Number.isNaN(r))throw new TypeError("Expected `retries` to be a valid number or Infinity, got NaN.")}else if(r!==void 0)throw new TypeError("Expected `retries` to be a number or Infinity.")}function Ag(r,e,{min:t=0,allowInfinity:n=!1}={}){if(e!==void 0){if(typeof e!="number"||Number.isNaN(e))throw new TypeError(`Expected \`${r}\` to be a number${n?" or Infinity":""}.`);if(!n&&!Number.isFinite(e))throw new TypeError(`Expected \`${r}\` to be a finite number.`);if(e<t)throw new TypeError(`Expected \`${r}\` to be \u2265 ${t}.`)}}var c7=class extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,{message:e}=e):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}};function lK(r,e){let t=Math.max(1,r+1),n=e.randomize?Math.random()+1:1,o=Math.round(n*e.minTimeout*e.factor**(t-1));return o=Math.min(o,e.maxTimeout),o}function lI(r,e){return Number.isFinite(e)?e-(performance.now()-r):e}async function uK({error:r,attemptNumber:e,retriesConsumed:t,startTime:n,options:o}){let i=r instanceof Error?r:new TypeError(`Non-error was thrown: "${r}". You should only throw errors.`);if(i instanceof c7)throw i.originalError;let s=Number.isFinite(o.retries)?Math.max(0,o.retries-t):o.retries,a=o.maxRetryTime??Number.POSITIVE_INFINITY,c=Object.freeze({error:i,attemptNumber:e,retriesLeft:s,retriesConsumed:t});if(await o.onFailedAttempt(c),lI(n,a)<=0)throw i;let l=await o.shouldConsumeRetry(c),f=lI(n,a);if(f<=0||s<=0)throw i;if(i instanceof TypeError&&!a7(i)){if(l)throw i;return o.signal?.throwIfAborted(),!1}if(!await o.shouldRetry(c))throw i;if(!l)return o.signal?.throwIfAborted(),!1;let u=lK(t,o),d=Math.min(u,f);return o.signal?.throwIfAborted(),d>0&&await new Promise((h,m)=>{let w=()=>{clearTimeout(y),o.signal?.removeEventListener("abort",w),m(o.signal.reason)},y=setTimeout(()=>{o.signal?.removeEventListener("abort",w),h()},d);o.unref&&y.unref?.(),o.signal?.addEventListener("abort",w,{once:!0})}),o.signal?.throwIfAborted(),!0}async function l7(r,e={}){if(e={...e},cK(e.retries),Object.hasOwn(e,"forever"))throw new Error("The `forever` option is no longer supported. For many use-cases, you can set `retries: Infinity` instead.");e.retries??=10,e.factor??=2,e.minTimeout??=1e3,e.maxTimeout??=Number.POSITIVE_INFINITY,e.maxRetryTime??=Number.POSITIVE_INFINITY,e.randomize??=!1,e.onFailedAttempt??=()=>{},e.shouldRetry??=()=>!0,e.shouldConsumeRetry??=()=>!0,Ag("factor",e.factor,{min:0,allowInfinity:!1}),Ag("minTimeout",e.minTimeout,{min:0,allowInfinity:!1}),Ag("maxTimeout",e.maxTimeout,{min:0,allowInfinity:!0}),Ag("maxRetryTime",e.maxRetryTime,{min:0,allowInfinity:!0}),e.factor>0||(e.factor=1),e.signal?.throwIfAborted();let t=0,n=0,o=performance.now();for(;!Number.isFinite(e.retries)||n<=e.retries;){t++;try{e.signal?.throwIfAborted();let i=await r(t);return e.signal?.throwIfAborted(),i}catch(i){await uK({error:i,attemptNumber:t,retriesConsumed:n,startTime:o,options:e})&&n++}}throw new Error("Retry attempts exhausted without throwing an error.")}var Tg=class{log;queue;started;peerStore;retries;retryInterval;backoffFactor;connectionManager;events;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:reconnect-queue"),this.peerStore=e.peerStore,this.connectionManager=e.connectionManager,this.queue=new vr({concurrency:t.maxParallelReconnects??5,metricName:"libp2p_reconnect_queue",metrics:e.metrics}),this.started=!1,this.retries=t.retries??5,this.backoffFactor=t.backoffFactor,this.retryInterval=t.retryInterval,this.events=e.events,e.events.addEventListener("peer:disconnect",n=>{this.maybeReconnect(n.detail).catch(o=>{this.log.error("failed to maybe reconnect to %p - %e",n.detail,o)})})}async maybeReconnect(e){if(!this.started)return;let t=await this.peerStore.get(e);uI(t)&&(this.queue.has(e)||this.queue.add(async n=>{await l7(async o=>{if(this.started)try{await this.connectionManager.openConnection(e,{signal:n?.signal})}catch(i){throw this.log("reconnecting to %p attempt %d of %d failed - %e",e,o,this.retries,i),i}},{signal:n?.signal,retries:this.retries,factor:this.backoffFactor,minTimeout:this.retryInterval})},{peerId:e}).catch(async n=>{this.log.error("failed to reconnect to %p - %e",e,n);let o={};[...t.tags.keys()].forEach(i=>{i.startsWith(Ha)&&(o[i]=void 0)}),await this.peerStore.merge(e,{tags:o}),this.events.safeDispatchEvent("peer:reconnect-failure",{detail:e})}).catch(async n=>{this.log.error("failed to remove keep-alive tag from %p - %e",e,n)}))}start(){this.started=!0}async afterStart(){Promise.resolve().then(async()=>{let e=await this.peerStore.all({filters:[t=>uI(t)]});await Promise.all(e.map(async t=>{await this.connectionManager.openConnection(t.id).catch(n=>{this.log.error("could not open connection to keepalive peer - %e",n)})}))}).catch(e=>{this.log.error("error reconnect to peers after start - %e",e)})}stop(){this.started=!1,this.queue.abort()}};function uI(r){for(let e of r.tags.keys())if(e.startsWith(Ha))return!0;return!1}var s7=50,u7={maxConnections:aI,inboundConnectionThreshold:5,maxIncomingPendingConnections:10},Ig=class{started;connections;allow;deny;maxIncomingPendingConnections;incomingPendingConnections;outboundPendingConnections;maxConnections;dialQueue;reconnectQueue;connectionPruner;inboundConnectionRateLimiter;peerStore;metrics;events;log;peerId;constructor(e,t={}){if(this.maxConnections=t.maxConnections??u7.maxConnections,this.maxConnections<1)throw new P("Connection Manager maxConnections must be greater than 0");this.connections=new $r,this.started=!1,this.peerId=e.peerId,this.peerStore=e.peerStore,this.metrics=e.metrics,this.events=e.events,this.log=e.logger.forComponent("libp2p:connection-manager"),this.onConnect=this.onConnect.bind(this),this.onDisconnect=this.onDisconnect.bind(this),this.allow=(t.allow??[]).map(n=>Mh(ie(n))),this.deny=(t.deny??[]).map(n=>Mh(ie(n))),this.incomingPendingConnections=0,this.maxIncomingPendingConnections=t.maxIncomingPendingConnections??u7.maxIncomingPendingConnections,this.outboundPendingConnections=0,this.inboundConnectionRateLimiter=new Cu({points:t.inboundConnectionThreshold??u7.inboundConnectionThreshold,duration:1}),this.connectionPruner=new Eg({connectionManager:this,peerStore:e.peerStore,events:e.events,logger:e.logger},{allow:t.allow?.map(n=>ie(n))}),this.dialQueue=new _g(e,{addressSorter:t.addressSorter,maxParallelDials:t.maxParallelDials??Sg,maxDialQueueLength:t.maxDialQueueLength??500,maxPeerAddrsToDial:t.maxPeerAddrsToDial??25,dialTimeout:t.dialTimeout??1e4,resolvers:t.resolvers??{dnsaddr:Uh},connections:this.connections}),this.reconnectQueue=new Tg({events:e.events,peerStore:e.peerStore,logger:e.logger,connectionManager:this},{retries:t.reconnectRetries,retryInterval:t.reconnectRetryInterval,backoffFactor:t.reconnectBackoffFactor,maxParallelReconnects:t.maxParallelReconnects})}[Symbol.toStringTag]="@libp2p/connection-manager";async start(){this.metrics?.registerMetricGroup("libp2p_connection_manager_connections",{calculate:()=>{let e={inbound:0,"inbound pending":this.incomingPendingConnections,outbound:0,"outbound pending":this.outboundPendingConnections};for(let t of this.connections.values())for(let n of t)e[n.direction]++;return e}}),this.metrics?.registerMetricGroup("libp2p_protocol_streams_total",{label:"protocol",calculate:()=>{let e={};for(let t of this.connections.values())for(let n of t)for(let o of n.streams){let i=`${o.direction} ${o.protocol??"unnegotiated"}`;e[i]=(e[i]??0)+1}return e}}),this.metrics?.registerMetricGroup("libp2p_connection_manager_protocol_streams_per_connection_90th_percentile",{label:"protocol",calculate:()=>{let e={};for(let n of this.connections.values())for(let o of n){let i={};for(let s of o.streams){let a=`${s.direction} ${s.protocol??"unnegotiated"}`;i[a]=(i[a]??0)+1}for(let[s,a]of Object.entries(i))e[s]=e[s]??[],e[s].push(a)}let t={};for(let[n,o]of Object.entries(e)){o=o.sort((s,a)=>s-a);let i=Math.floor(o.length*.9);t[n]=o[i]}return t}}),this.events.addEventListener("connection:open",this.onConnect),this.events.addEventListener("connection:close",this.onDisconnect),await er(this.dialQueue,this.reconnectQueue,this.connectionPruner),this.started=!0,this.log("started")}async stop(){this.events.removeEventListener("connection:open",this.onConnect),this.events.removeEventListener("connection:close",this.onDisconnect),await or(this.reconnectQueue,this.dialQueue,this.connectionPruner);let e=[];for(let t of this.connections.values())for(let n of t)e.push(Promise.all([Bh(n,"close",{signal:AbortSignal.timeout(500)}),n.close({signal:AbortSignal.timeout(500)})]).catch(o=>{n.abort(o)}));this.log("closing %d connections",e.length),await Promise.all(e),this.connections.clear(),this.log("stopped")}getMaxConnections(){return this.maxConnections}setMaxConnections(e){if(this.maxConnections<1)throw new P("Connection Manager maxConnections must be greater than 0");let t=!1;e<this.maxConnections&&(t=!0),this.maxConnections=e,t&&this.connectionPruner.maybePruneConnections()}onConnect(e){this._onConnect(e).catch(t=>{this.log.error("could not connect - %e",t)})}async _onConnect(e){let{detail:t}=e;if(!this.started){await t.close();return}if(t.status!=="open")return;let n=t.remotePeer,o=!this.connections.has(n),i=this.connections.get(n)??[];i.push(t),this.connections.set(n,i),n.publicKey!=null&&n.type==="RSA"&&await this.peerStore.patch(n,{publicKey:n.publicKey}),o&&this.events.safeDispatchEvent("peer:connect",{detail:t.remotePeer})}onDisconnect(e){let{detail:t}=e,n=t.remotePeer,i=(this.connections.get(n)??[]).filter(s=>s.id!==t.id);this.connections.set(n,i),i.length===0&&(this.log.trace("peer %p disconnected, removing connection map entry",n),this.connections.delete(n),this.events.safeDispatchEvent("peer:disconnect",{detail:n}))}getConnections(e){if(e!=null)return this.connections.get(e)??[];let t=[];for(let n of this.connections.values())t=t.concat(n);return t}getConnectionsMap(){return this.connections}async openConnection(e,t={}){if(!this.started)throw new _n("Not started");this.outboundPendingConnections++;try{t.signal?.throwIfAborted();let{peerId:n,multiaddrs:o}=vg(e);if(this.peerId.equals(n))throw new Ml("Can not dial self");if(n!=null&&t.force!==!0){this.log("dial %p",n);let c=xg(n,this.getConnections(n),o);if(c!=null)return this.log("had an existing connection to %p as %a",n,c.remoteAddr),t.onProgress?.(new oe("dial-queue:already-connected")),c}let i=await this.dialQueue.dial(e,{...t,priority:t.priority??s7});if(i.status!=="open")throw new $a("Remote closed connection during opening");let s=this.connections.get(i.remotePeer);s==null&&(s=[],this.connections.set(i.remotePeer,s));let a=!1;for(let c of s)if(c.id===i.id&&(a=!0),t.force!==!0&&c.id!==i.id&&c.remoteAddr.equals(i.remoteAddr))return i.abort(new Xo("Duplicate multiaddr connection")),c;return a||s.push(i),i}finally{this.outboundPendingConnections--}}async openStream(e,t,n={}){return(await this.openConnection(e,n)).newStream(t,n)}async closeConnections(e,t={}){let n=this.connections.get(e)??[];await Promise.all(n.map(async o=>{try{await Promise.all([Bh(o,"close",t),o.close(t)])}catch(i){o.abort(i)}}))}acceptIncomingConnection(e){if(this.deny.some(o=>{if(mr(e.remoteAddr)){let i=Ce(e.remoteAddr);return o.contains(i.host)}return!1}))return this.log("connection from %a refused - connection remote address was in deny list",e.remoteAddr),!1;if(this.allow.some(o=>{if(mr(e.remoteAddr)){let i=Ce(e.remoteAddr);return o.contains(i.host)}return!0}))return this.incomingPendingConnections++,!0;if(this.incomingPendingConnections===this.maxIncomingPendingConnections)return this.log("connection from %a refused - incomingPendingConnections exceeded by host",e.remoteAddr),!1;if(mr(e.remoteAddr)){let o=Ce(e.remoteAddr);try{this.inboundConnectionRateLimiter.consume(o.host,1)}catch{return this.log("connection from %a refused - inboundConnectionThreshold exceeded by host %s",e.remoteAddr,o.host),!1}}return this.getConnections().length<this.maxConnections?(this.incomingPendingConnections++,!0):(this.log("connection from %a refused - maxConnections exceeded",e.remoteAddr),!1)}afterUpgradeInbound(){this.incomingPendingConnections--}getDialQueue(){let e={queued:"queued",running:"active",errored:"error",complete:"success"};return this.dialQueue.queue.queue.map(t=>({id:t.id,status:e[t.status],peerId:t.options.peerId,multiaddrs:[...t.options.multiaddrs].map(n=>ie(n))}))}async isDialable(e,t={}){return this.dialQueue.isDialable(e,t)}};var hK=1e4,pK="1.0.0",mK="ping",gK="ipfs",fI=32,yK=!0,Cg=class{protocol;components;log;heartbeatInterval;pingIntervalMs;abortController;timeout;abortConnectionOnPingFailure;constructor(e,t={}){this.components=e,this.protocol=`/${t.protocolPrefix??gK}/${mK}/${pK}`,this.log=e.logger.forComponent("libp2p:connection-monitor"),this.pingIntervalMs=t.pingInterval??hK,this.abortConnectionOnPingFailure=t.abortConnectionOnPingFailure??yK,this.timeout=new To({...t.pingTimeout??{},metrics:e.metrics,metricName:"libp2p_connection_monitor_ping_time_milliseconds"})}[Symbol.toStringTag]="@libp2p/connection-monitor";[qe]=["@libp2p/connection-monitor"];start(){this.abortController=new AbortController,this.abortController.signal,this.heartbeatInterval=setInterval(()=>{this.components.connectionManager.getConnections().forEach(e=>{Promise.resolve().then(async()=>{let t=Date.now();try{let n=this.timeout.getTimeoutSignal({signal:this.abortController?.signal}),o=await e.newStream(this.protocol,{signal:n,runOnLimitedConnection:!0}),i=c0(o);t=Date.now(),await Promise.all([i.write(Xr(fI),{signal:n}),i.read({bytes:fI,signal:n})]),e.rtt=Date.now()-t,await o.close({signal:n})}catch(n){if(n.name!=="UnsupportedProtocolError")throw n;e.rtt=(Date.now()-t)/2}}).catch(t=>{this.log.error("error during heartbeat - %e",t),this.abortConnectionOnPingFailure?(this.log.error("aborting connection due to ping failure"),e.abort(t)):this.log("connection ping failed, but not aborting due to abortConnectionOnPingFailure flag")})})},this.pingIntervalMs)}stop(){this.abortController?.abort(),this.heartbeatInterval!=null&&clearInterval(this.heartbeatInterval)}};var Pg=class{routers;started;components;constructor(e,t){this.routers=t.routers??[],this.started=!1,this.components=e,this.findProviders=e.metrics?.traceFunction("libp2p.contentRouting.findProviders",this.findProviders.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],o)=>({...o,cid:n.toString()}),getAttributesFromYieldedValue:(n,o)=>({...o,providers:[...Array.isArray(o.providers)?o.providers:[],n.id.toString()]})})??this.findProviders,this.provide=e.metrics?.traceFunction("libp2p.contentRouting.provide",this.provide.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],o)=>({...o,cid:n.toString()})})??this.provide,this.cancelReprovide=e.metrics?.traceFunction("libp2p.contentRouting.cancelReprovide",this.cancelReprovide.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],o)=>({...o,cid:n.toString()})})??this.cancelReprovide,this.put=e.metrics?.traceFunction("libp2p.contentRouting.put",this.put.bind(this),{optionsIndex:2,getAttributesFromArgs:([n])=>({key:j(n,"base36")})})??this.put,this.get=e.metrics?.traceFunction("libp2p.contentRouting.get",this.get.bind(this),{optionsIndex:1,getAttributesFromArgs:([n])=>({key:j(n,"base36")})})??this.get}[Symbol.toStringTag]="@libp2p/content-routing";isStarted(){return this.started}async start(){this.started=!0}async stop(){this.started=!1}async*findProviders(e,t={}){if(this.routers.length===0)throw new Hu("No content routers available");let n=this,o=new Bn;for await(let i of Yr(...n.routers.filter(s=>s.findProviders instanceof Function).map(s=>s.findProviders(e,t))))i!=null&&(i.multiaddrs.length>0&&await this.components.peerStore.merge(i.id,{multiaddrs:i.multiaddrs},t),!o.has(i.id)&&(o.add(i.id),yield i))}async provide(e,t={}){if(this.routers.length===0)throw new Hu("No content routers available");await Promise.all(this.routers.filter(n=>n.provide instanceof Function).map(async n=>{await n.provide(e,t)}))}async cancelReprovide(e,t={}){if(this.routers.length===0)throw new Hu("No content routers available");await Promise.all(this.routers.filter(n=>n.cancelReprovide instanceof Function).map(async n=>{await n.cancelReprovide(e,t)}))}async put(e,t,n){if(!this.isStarted())throw new _n;await Promise.all(this.routers.filter(o=>o.put instanceof Function).map(async o=>{await o.put(e,t,n)}))}async get(e,t){if(!this.isStarted())throw new _n;return Promise.any(this.routers.filter(n=>n.get instanceof Function).map(async n=>n.get(e,t)))}};var kg=globalThis.CustomEvent??Event;async function*ns(r,e={}){let t=e.concurrency??1/0;t<1&&(t=1/0);let n=e.ordered??!1,o=new EventTarget,i=[],s=Ve(),a=Ve(),c=!1,l,f=!1;o.addEventListener("task-complete",()=>{a.resolve()}),Promise.resolve().then(async()=>{try{for await(let m of r){if(i.length===t&&(s=Ve(),await s.promise),f)break;let w={done:!1};i.push(w),m().then(y=>{w.done=!0,w.ok=!0,w.value=y,o.dispatchEvent(new kg("task-complete"))},y=>{w.done=!0,w.err=y,o.dispatchEvent(new kg("task-complete"))})}c=!0,o.dispatchEvent(new kg("task-complete"))}catch(m){l=m,o.dispatchEvent(new kg("task-complete"))}});function u(){return n?i[0]?.done:!!i.find(m=>m.done)}function*d(){for(;i.length>0&&i[0].done;){let m=i[0];if(i.shift(),m.ok)yield m.value;else throw f=!0,s.resolve(),m.err;s.resolve()}}function*h(){for(;u();)for(let m=0;m<i.length;m++)if(i[m].done){let w=i[m];if(i.splice(m,1),m--,w.ok)yield w.value;else throw f=!0,s.resolve(),w.err;s.resolve()}}for(;;){if(u()||(a=Ve(),await a.promise),l!=null||(n?yield*d():yield*h(),l!=null))throw l;if(c&&i.length===0)break}}var Og=class{log;peerId;peerStore;routers;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:peer-routing"),this.peerId=e.peerId,this.peerStore=e.peerStore,this.routers=t.routers??[],this.findPeer=e.metrics?.traceFunction("libp2p.peerRouting.findPeer",this.findPeer.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],o)=>({...o,peer:n.toString()})})??this.findPeer,this.getClosestPeers=e.metrics?.traceFunction("libp2p.peerRouting.getClosestPeers",this.getClosestPeers.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],o)=>({...o,key:j(n,"base36")}),getAttributesFromYieldedValue:(n,o)=>({...o,peers:[...Array.isArray(o.peers)?o.peers:[],n.id.toString()]})})??this.getClosestPeers}[Symbol.toStringTag]="@libp2p/peer-routing";async findPeer(e,t){if(this.routers.length===0)throw new Nh("No peer routers available");if(e.toString()===this.peerId.toString())throw new ug("Should not try to find self");let n=this,o=Yr(...this.routers.filter(i=>i.findPeer instanceof Function).map(i=>(async function*(){try{yield await i.findPeer(e,t)}catch(s){n.log.error("router failed to find peer - %e",s)}})()));for await(let i of o)if(i!=null)return i.multiaddrs.length>0&&await this.peerStore.merge(i.id,{multiaddrs:i.multiaddrs},t),i;throw new Xe}async*getClosestPeers(e,t={}){if(this.routers.length===0)throw new Nh("No peer routers available");let n=this,o=Fr(1024);for await(let i of ns((async function*(){let s=Yr(...n.routers.filter(a=>a.getClosestPeers instanceof Function).map(a=>a.getClosestPeers(e,t)));for await(let a of s)yield async()=>{if(a.multiaddrs.length===0)try{a=await n.findPeer(a.id,{...t,useCache:!1})}catch(c){n.log.error("could not find peer multiaddrs - %e",c);return}return a}})()))i!=null&&(i.multiaddrs.length>0&&await this.peerStore.merge(i.id,{multiaddrs:i.multiaddrs},t),!o.has(i.id.toMultihash().bytes)&&(o.add(i.id.toMultihash().bytes),yield i))}};var Rg=class extends _e{peerRouting;log;walking;walkers;shutdownController;walkController;needNext;constructor(e){super(),this.log=e.logger.forComponent("libp2p:random-walk"),this.peerRouting=e.peerRouting,this.walkers=0,this.walking=!1,this.shutdownController=new AbortController,this.shutdownController.signal}[Symbol.toStringTag]="@libp2p/random-walk";start(){this.shutdownController=new AbortController,this.shutdownController.signal}stop(){this.shutdownController.abort()}async*walk(e){this.walking||this.startWalk(),this.walkers++;let t=De([this.shutdownController.signal,e?.signal]);try{for(;;)this.needNext?.resolve(),this.needNext=Ve(),yield(await Bh(this,"walk:peer",{signal:t,rejectionEvents:["walk:error"]})).detail}catch(n){throw n.detail!=null?n.detail:n}finally{t.clear(),this.walkers--,this.walkers===0&&(this.walkController?.abort(),this.walkController=void 0)}}startWalk(){this.walking=!0,this.walkController=new AbortController,this.walkController.signal;let e=De([this.walkController.signal,this.shutdownController.signal]);let t=Date.now(),n=0;Promise.resolve().then(async()=>{for(this.log("start walk");this.walkers>0;)try{let o=Xr(32),i=Date.now();for await(let s of this.peerRouting.getClosestPeers(o,{signal:e}))e.aborted&&this.log("aborting walk"),e.throwIfAborted(),this.log("found peer %p after %dms for %d walkers",s.id,Date.now()-i,this.walkers),n++,this.safeDispatchEvent("walk:peer",{detail:s}),this.walkers===1&&this.needNext!=null&&(this.log("wait for need next"),await ut(this.needNext.promise,e)),i=Date.now();this.log("walk iteration for %b and %d walkers finished, found %d peers",o,this.walkers,n)}catch(o){this.log.error("random walk errored - %e",o),this.safeDispatchEvent("walk:error",{detail:o})}this.log("no walkers left, ended walk")}).catch(o=>{this.log.error("random walk errored - %e",o)}).finally(()=>{this.log("finished walk, found %d peers after %dms",n,Date.now()-t),this.walking=!1})}};var f7=32,d7=64,Dg=class{log;topologies;handlers;components;middleware;constructor(e){this.components=e,this.log=e.logger.forComponent("libp2p:registrar"),this.middleware=new Map,this.topologies=new Map,e.metrics?.registerMetricGroup("libp2p_registrar_topologies",{calculate:()=>{let t={};for(let[n,o]of this.topologies)t[n]=o.size;return t}}),this.handlers=Wt({name:"libp2p_registrar_protocol_handlers",metrics:e.metrics}),this._onDisconnect=this._onDisconnect.bind(this),this._onPeerUpdate=this._onPeerUpdate.bind(this),this._onPeerIdentify=this._onPeerIdentify.bind(this),this.components.events.addEventListener("peer:disconnect",this._onDisconnect),this.components.events.addEventListener("peer:update",this._onPeerUpdate),this.components.events.addEventListener("peer:identify",this._onPeerIdentify)}[Symbol.toStringTag]="@libp2p/registrar";getProtocols(){return Array.from(new Set([...this.handlers.keys()])).sort()}getHandler(e){let t=this.handlers.get(e);if(t==null)throw new fg(`No handler registered for protocol ${e}`);return t}getTopologies(e){let t=this.topologies.get(e);return t==null?[]:[...t.values()]}async handle(e,t,n){if(this.handlers.has(e)&&n?.force!==!0)throw new dg(`Handler already registered for protocol ${e}`);this.handlers.set(e,{handler:t,options:{maxInboundStreams:f7,maxOutboundStreams:d7,...n}}),await this.components.peerStore.merge(this.components.peerId,{protocols:[e]},n)}async unhandle(e,t){(Array.isArray(e)?e:[e]).forEach(o=>{this.handlers.delete(o)}),await this.components.peerStore.patch(this.components.peerId,{protocols:this.getProtocols()},t)}async register(e,t){if(t==null)throw new P("invalid topology");let n=`${(Math.random()*1e9).toString(36)}${Date.now()}`,o=this.topologies.get(e);return o==null&&(o=new Map,this.topologies.set(e,o)),o.set(n,t),n}unregister(e){for(let[t,n]of this.topologies.entries())n.has(e)&&(n.delete(e),n.size===0&&this.topologies.delete(t))}use(e,t){this.middleware.set(e,t)}unuse(e){this.middleware.delete(e)}getMiddleware(e){return this.middleware.get(e)??[]}async _onDisconnect(e){let t=e.detail,n={signal:AbortSignal.timeout(5e3)};try{let o=await this.components.peerStore.get(t,n);for(let i of o.protocols){let s=this.topologies.get(i);s!=null&&await Promise.all([...s.values()].map(async a=>{a.filter?.has(t)!==!1&&(a.filter?.remove(t),await a.onDisconnect?.(t))}))}}catch(o){if(o.name==="NotFoundError")return;this.log.error("could not inform topologies of disconnecting peer %p - %e",t,o)}}async _onPeerUpdate(e){let{peer:t,previous:n}=e.detail,o=(n?.protocols??[]).filter(i=>!t.protocols.includes(i));try{for(let i of o){let s=this.topologies.get(i);s!=null&&await Promise.all([...s.values()].map(async a=>{a.filter?.has(t.id)!==!1&&(a.filter?.remove(t.id),await a.onDisconnect?.(t.id))}))}}catch(i){this.log.error("could not inform topologies of updated peer %p - %e",t.id,i)}}async _onPeerIdentify(e){let t=e.detail.protocols,n=e.detail.connection,o=e.detail.peerId;try{for(let i of t){let s=this.topologies.get(i);s!=null&&await Promise.all([...s.values()].map(async a=>{n.limits!=null&&a.notifyOnLimitedConnection!==!0||a.filter?.has(o)!==!0&&(a.filter?.add(o),await a.onConnect?.(o,n))}))}}catch(i){this.log.error("could not inform topologies of updated peer after identify %p - %e",o,i)}}};var Ng=class{log;components;transports;listeners;faultTolerance;started;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:transports"),this.components=e,this.started=!1,this.transports=Wt({name:"libp2p_transport_manager_transports",metrics:this.components.metrics}),this.listeners=Wt({name:"libp2p_transport_manager_listeners",metrics:this.components.metrics}),this.faultTolerance=t.faultTolerance??cd.FATAL_ALL}[Symbol.toStringTag]="@libp2p/transport-manager";add(e){let t=e[Symbol.toStringTag];if(t==null)throw new P("Transport must have a valid tag");if(this.transports.has(t))throw new P(`There is already a transport with the tag ${t}`);this.log("adding transport %s",t),this.transports.set(t,e),this.listeners.has(t)||this.listeners.set(t,[])}isStarted(){return this.started}start(){this.started=!0}async afterStart(){let e=this.components.addressManager.getListenAddrs();await this.listen(e)}async stop(){let e=[];for(let[t,n]of this.listeners)for(this.log("closing listeners for %s",t);n.length>0;){let o=n.pop();o!=null&&e.push(o.close())}await Promise.all(e),this.log("all listeners closed");for(let t of this.listeners.keys())this.listeners.set(t,[]);this.started=!1}async dial(e,t){let n=this.dialTransportForMultiaddr(e);if(n==null)throw new wg(`No transport available for address ${String(e)}`);return t?.onProgress?.(new oe("transport-manager:selected-transport",n[Symbol.toStringTag])),n.dial(e,{...t,upgrader:this.components.upgrader})}getAddrs(){let e=[];for(let t of this.listeners.values())for(let n of t)e=[...e,...n.getAddrs()];return e}getTransports(){return Array.of(...this.transports.values())}getListeners(){return Array.of(...this.listeners.values()).flat()}dialTransportForMultiaddr(e){for(let t of this.transports.values())if(t.dialFilter([e]).length>0)return t}listenTransportForMultiaddr(e){for(let t of this.transports.values())if(t.listenFilter([e]).length>0)return t}async listen(e){if(!this.isStarted())throw new _n("Not started");if(e==null||e.length===0){this.log("no addresses were provided for listening, this node is dial only");return}let t={errors:new Map,ipv4:{success:0,attempts:0},ipv6:{success:0,attempts:0}};e.forEach(i=>{t.errors.set(i.toString(),new hg)});let n=[];for(let[i,s]of this.transports.entries()){let a=s.listenFilter(e);for(let c of a){this.log("creating listener for %s on %a",i,c);let l=s.createListener({upgrader:this.components.upgrader}),f=this.listeners.get(i)??[];f==null&&(f=[],this.listeners.set(i,f)),f.push(l),l.addEventListener("listening",()=>{this.components.events.safeDispatchEvent("transport:listening",{detail:l})}),l.addEventListener("close",()=>{let u=f.findIndex(d=>d===l);f.splice(u,1),this.components.events.safeDispatchEvent("transport:close",{detail:l})}),Aw.matches(c)?t.ipv4.attempts++:Tw.matches(c)&&t.ipv6.attempts++,n.push(l.listen(c).then(()=>{t.errors.delete(c.toString()),Aw.matches(c)&&t.ipv4.success++,Tw.matches(c)&&t.ipv6.success++},u=>{throw this.log.error("transport %s could not listen on address %a - %e",i,c,u),t.errors.set(c.toString(),u),u}))}}let o=await Promise.allSettled(n);if(!(o.length>0&&o.every(i=>i.status==="fulfilled"))){if(this.ipv6Unsupported(t)){this.log("all IPv4 addresses succeed but all IPv6 failed");return}if(this.faultTolerance===cd.NO_FATAL){this.log("failed to listen on any address but fault tolerance allows this");return}throw new pg(`Some configured addresses failed to be listened on, you may need to remove one or more listen addresses from your configuration or set \`transportManager.faultTolerance\` to NO_FATAL:
${[...t.errors.entries()].map(([i,s])=>`
  ${i}: ${`${wK(s)}`.split(`
`).join(`
  `)}
`).join("")}`)}}ipv6Unsupported(e){if(e.ipv4.attempts===0||e.ipv6.attempts===0)return!1;let t=e.ipv4.attempts===e.ipv4.success,n=e.ipv6.success===0;return t&&n}async remove(e){let t=this.listeners.get(e)??[];this.log.trace("removing transport %s",e);let n=[];for(this.log.trace("closing listeners for %s",e);t.length>0;){let o=t.pop();o!=null&&n.push(o.close())}await Promise.all(n),this.transports.delete(e),this.listeners.delete(e)}async removeAll(){let e=[];for(let t of this.transports.keys())e.push(this.remove(t));await Promise.all(e)}};function wK(r){return r.stack!=null&&r.stack.trim()!==""?r.stack:r.message!=null?r.message:r.toString()}var ci="/multistream/1.0.0";var bK=B(`
`);async function $h(r,e){let n=(await r.read(e)).subarray();if(n.byteLength===0||n[n.length-1]!==bK[0])throw new Be("Missing newline");return j(n).trimEnd()}async function qu(r,e,t={}){if(e=Array.isArray(e)?[...e]:[e],e.length===0)throw new Error("At least one protocol must be specified");let n=r.log.newScope("mss:select"),o=Gs(r,{...t,maxDataLength:1024});for(let i=0;i<e.length;i++){let s=e[i],a;if(i===0){n.trace('write ["%s", "%s"]',ci,s);let c=B(`${ci}
`),l=B(`${s}
`);if(await o.writeV([c,l],t),n.trace("reading multistream-select header"),a=await $h(o,t),n.trace('read "%s"',a),a!==ci){n.error("did not read multistream-select header from response");break}}else n.trace('write "%s"',s),await o.write(B(`${s}
`),t);if(n.trace("reading protocol response"),a=await $h(o,t),n.trace('read "%s"',a),a===s)return n.trace('selected "%s" after negotiation',a),o.unwrap(),s}throw new Ul(`Protocol selection failed - could not negotiate ${e}`)}async function Wu(r,e,t={}){e=Array.isArray(e)?e:[e];let n=r.log.newScope("mss:handle"),o=Gs(r,{...t,maxDataLength:1024,maxLengthLength:2});for(;;){n.trace("reading incoming string");let i=await $h(o,t);if(n.trace('read "%s"',i),i===ci){n.trace('respond with "%s" for "%s"',ci,i),await o.write(B(`${ci}
`),t),n.trace('responded with "%s" for "%s"',ci,i);continue}if(e.includes(i))return n.trace('respond with "%s" for "%s"',i,i),await o.write(B(`${i}
`),t),n.trace('responded with "%s" for "%s"',i,i),o.unwrap(),i;if(i==="ls"){let s=new fe(...e.map(a=>Gi.single(B(`${a}
`))),B(`
`));n.trace('respond with "%s" for %s',e,i),await o.write(s,t),n.trace('responded with "%s" for %s',e,i);continue}n.trace('respond with "na" for "%s"',i),await o.write(B(`na
`),t),n('responded with "na" for "%s"',i)}}var p7=class extends _e{id;remoteAddr;remotePeer;direction;timeline;direct;multiplexer;encryption;limits;log;maConn;muxer;components;outboundStreamProtocolNegotiationTimeout;inboundStreamProtocolNegotiationTimeout;closeTimeout;constructor(e,t){super(),this.components=e,this.id=t.id,this.remoteAddr=t.maConn.remoteAddr,this.remotePeer=t.remotePeer,this.direction=t.direction??"outbound",this.timeline=t.maConn.timeline,this.encryption=t.cryptoProtocol,this.limits=t.limits,this.maConn=t.maConn,this.log=t.maConn.log,this.outboundStreamProtocolNegotiationTimeout=t.outboundStreamProtocolNegotiationTimeout??1e4,this.inboundStreamProtocolNegotiationTimeout=t.inboundStreamProtocolNegotiationTimeout??1e4,this.closeTimeout=t.closeTimeout??1e3,this.direct=e7(t.maConn.remoteAddr),this.onIncomingStream=this.onIncomingStream.bind(this),this.remoteAddr.getComponents().find(n=>n.code===421)==null&&(this.remoteAddr=this.remoteAddr.encapsulate(`/p2p/${this.remotePeer}`)),t.muxer!=null&&(this.multiplexer=t.muxer.protocol,this.muxer=t.muxer,this.muxer.addEventListener("stream",this.onIncomingStream)),this.maConn.addEventListener("close",n=>{this.dispatchEvent(new ks(n.local,n.error))})}[Symbol.toStringTag]="Connection";[Yv]=!0;get streams(){return this.muxer?.streams??[]}get status(){return this.maConn.status}newStream=async(e,t={})=>{if(this.muxer==null)throw new ra("Connection is not multiplexed");if(this.muxer.status!=="open")throw new $a(`The connection muxer is "${this.muxer.status}" and not "open"`);if(this.maConn.status!=="open")throw new $a(`The connection is "${this.status}" and not "open"`);if(this.limits!=null&&t?.runOnLimitedConnection!==!0)throw new ad("Cannot open protocol stream on limited connection");Array.isArray(e)||(e=[e]),this.log.trace("starting new stream for protocols %s",e);let n=await this.muxer.createStream({...t,protocol:e.length===1?e[0]:void 0});this.log.trace("started new stream %s for protocols %s",n.id,e);try{if(t.signal==null){n.log("no abort signal was passed while trying to negotiate protocols %s falling back to default timeout",e);let a=AbortSignal.timeout(this.outboundStreamProtocolNegotiationTimeout);t={...t,signal:a}}n.protocol===""?(n.log.trace("selecting protocol from protocols %s",e),n.protocol=await qu(n,e,t),n.log("negotiated protocol %s",n.protocol)):n.log("pre-negotiated protocol %s",n.protocol);let o=EK(n.protocol,this.components.registrar,t),i=pI(n.protocol,"outbound",this);if(i>o){let a=new Fl(`Too many outbound protocol streams for protocol "${n.protocol}" - ${i}/${o}`);throw n.abort(a),a}await this.components.peerStore.merge(this.remotePeer,{protocols:[n.protocol]}),this.components.metrics?.trackProtocolStream(n);let s=this.components.registrar.getMiddleware(n.protocol);return await this.runMiddlewareChain(n,this,s)}catch(o){throw n.status==="open"?n.abort(o):this.log.error("could not create new outbound stream on connection %s %a for protocols %s - %e",this.direction==="inbound"?"from":"to",this.remoteAddr,e,o),o}};async onIncomingStream(e){let t=e.detail,n=AbortSignal.timeout(this.inboundStreamProtocolNegotiationTimeout);t.log("start protocol negotiation, timing out after %dms",this.inboundStreamProtocolNegotiationTimeout);try{if(t.protocol===""){let l=this.components.registrar.getProtocols();t.log.trace("selecting protocol from protocols %s",l),t.protocol=await Wu(t,l,{signal:n}),t.log("negotiated protocol %s",t.protocol)}else t.log("pre-negotiated protocol %s",t.protocol);let o=xK(t.protocol,this.components.registrar);if(pI(t.protocol,"inbound",this)>o)throw new nm(`Too many inbound protocol streams for protocol "${t.protocol}" - limit ${o}`);await this.components.peerStore.merge(this.remotePeer,{protocols:[t.protocol]},{signal:n}),this.components.metrics?.trackProtocolStream(t);let{handler:s,options:a}=this.components.registrar.getHandler(t.protocol);if(this.limits!=null&&a.runOnLimitedConnection!==!0)throw new ad("Cannot open protocol stream on limited connection");let c=this.components.registrar.getMiddleware(t.protocol);c.push(async(l,f,u)=>{await s(l,f),u(l,f)}),await this.runMiddlewareChain(t,this,c)}catch(o){t.abort(o)}}async runMiddlewareChain(e,t,n){for(let o=0;o<n.length;o++){let i=n[o];e.log.trace("running middleware",o,i),await new Promise((s,a)=>{try{let c=i(e,t,(l,f)=>{e=l,t=f,s()});c instanceof Promise&&c.catch(a)}catch(c){a(c)}}),e.log.trace("ran middleware",o,i)}return e}async close(e={}){if(this.log("closing connection to %a",this.remoteAddr),e.signal==null){let t=AbortSignal.timeout(this.closeTimeout);e={...e,signal:t}}await this.muxer?.close(e),await this.maConn.close(e)}abort(e){this.muxer?.abort(e),this.maConn.abort(e)}};function mI(r,e){return new p7(r,e)}function xK(r,e){try{let{options:t}=e.getHandler(r);if(t.maxInboundStreams!=null)return t.maxInboundStreams}catch(t){if(t.name!=="UnhandledProtocolError")throw t}return f7}function EK(r,e,t={}){try{let{options:n}=e.getHandler(r);if(n.maxOutboundStreams!=null)return n.maxOutboundStreams}catch(n){if(n.name!=="UnhandledProtocolError")throw n}return t.maxOutboundStreams??d7}function pI(r,e,t){let n=0;return t.streams.forEach(o=>{o.direction===e&&o.protocol===r&&n++}),n}var Lg=class{components;connectionEncrypters;streamMuxers;inboundUpgradeTimeout;inboundStreamProtocolNegotiationTimeout;outboundStreamProtocolNegotiationTimeout;events;metrics;connectionCloseTimeout;constructor(e,t){this.components=e,this.connectionEncrypters=Wt({name:"libp2p_upgrader_connection_encrypters",metrics:this.components.metrics}),t.connectionEncrypters.forEach(n=>{this.connectionEncrypters.set(n.protocol,n)}),this.streamMuxers=Wt({name:"libp2p_upgrader_stream_multiplexers",metrics:this.components.metrics}),t.streamMuxers.forEach(n=>{this.streamMuxers.set(n.protocol,n)}),this.inboundUpgradeTimeout=t.inboundUpgradeTimeout??1e4,this.inboundStreamProtocolNegotiationTimeout=t.inboundStreamProtocolNegotiationTimeout??1e4,this.outboundStreamProtocolNegotiationTimeout=t.outboundStreamProtocolNegotiationTimeout??1e4,this.connectionCloseTimeout=t.connectionCloseTimeout??1e3,this.events=e.events,this.metrics={dials:e.metrics?.registerCounterGroup("libp2p_connection_manager_dials_total"),errors:e.metrics?.registerCounterGroup("libp2p_connection_manager_dial_errors_total"),inboundErrors:e.metrics?.registerCounterGroup("libp2p_connection_manager_dials_inbound_errors_total"),outboundErrors:e.metrics?.registerCounterGroup("libp2p_connection_manager_dials_outbound_errors_total")}}[Symbol.toStringTag]="@libp2p/upgrader";async shouldBlockConnection(e,...t){let n=this.components.connectionGater[e];if(n==null)return;if(await n.apply(this.components.connectionGater,t)===!0)throw new gg(`The multiaddr connection is blocked by gater.${e}`)}createInboundAbortSignal(e){let t=De([AbortSignal.timeout(this.inboundUpgradeTimeout),e]);return t}async upgradeInbound(e,t){let n=!1,o=this.createInboundAbortSignal(t.signal);try{if(this.metrics.dials?.increment({inbound:!0}),n=this.components.connectionManager.acceptIncomingConnection(e),!n)throw new yg("Connection denied");await ut(this.shouldBlockConnection("denyInboundConnection",e),o),await this._performUpgrade(e,"inbound",{...t,signal:o})}catch(i){throw this.metrics.errors?.increment({inbound:!0}),this.metrics.inboundErrors?.increment({[i.name??"Error"]:!0}),i}finally{o.clear(),n&&this.components.connectionManager.afterUpgradeInbound()}}async upgradeOutbound(e,t){try{this.metrics.dials?.increment({outbound:!0});let n=e.remoteAddr.getComponents().findLast(s=>s.code===421)?.value,o;n!=null&&(o=yt(n),await ut(this.shouldBlockConnection("denyOutboundConnection",o,e),t.signal));let i="outbound";return t.initiator===!1&&(i="inbound"),await this._performUpgrade(e,i,t)}catch(n){throw this.metrics.errors?.increment({outbound:!0}),this.metrics.outboundErrors?.increment({[n.name??"Error"]:!0}),n}}async _performUpgrade(e,t,n){let o=e,i,s,a,c,l=`${parseInt(String(Math.random()*1e9)).toString(36)}${Date.now()}`;if(e.log=e.log.newScope(`${t}:${l}`),this.components.metrics?.trackMultiaddrConnection(e),e.log.trace("starting the %s connection upgrade",t),n?.skipProtection!==!0){let u=this.components.connectionProtector;u!=null&&(e.log("protecting the %s connection",t),o=await u.protect(o,n))}try{if(SK(n)){if(n.remotePeer==null)throw new Xo(`${t} connection that skipped encryption must have a peer id`);c="native",i=n.remotePeer}else{let u=e.remoteAddr.getComponents().findLast(h=>h.code===421)?.value,d;u!=null&&(d=yt(u)),n?.onProgress?.(new oe(`upgrader:encrypt-${t}-connection`)),{connection:o,remotePeer:i,protocol:c,streamMuxer:s}=await(t==="inbound"?this._encryptInbound(o,{...n,remotePeer:d}):this._encryptOutbound(o,{...n,remotePeer:d}))}if(i.equals(this.components.peerId)){let u=new Ml("Can not dial self");throw e.abort(u),u}await this.shouldBlockConnection(t==="inbound"?"denyInboundEncryptedConnection":"denyOutboundEncryptedConnection",i,e),n?.muxerFactory!=null?s=n.muxerFactory:s==null&&this.streamMuxers.size>0&&(n?.onProgress?.(new oe(`upgrader:multiplex-${t}-connection`)),s=await(t==="inbound"?this._multiplexInbound(o,this.streamMuxers,n):this._multiplexOutbound(o,this.streamMuxers,n)))}catch(u){throw e.log.error("failed to upgrade %s connection %s %a - %e",t,t==="inbound"?"from":"to",e.remoteAddr,u),u}s!=null&&(e.log("create muxer %s",s.protocol),a=s.createStreamMuxer(o)),await this.shouldBlockConnection(t==="inbound"?"denyInboundUpgradedConnection":"denyOutboundUpgradedConnection",i,e);let f=this._createConnection({id:l,cryptoProtocol:c,direction:t,maConn:e,stream:o,muxer:a,remotePeer:i,limits:n?.limits,closeTimeout:this.connectionCloseTimeout});return f.log("successfully upgraded connection"),f}_createConnection(e){let t=mI(this.components,{...e,outboundStreamProtocolNegotiationTimeout:this.outboundStreamProtocolNegotiationTimeout,inboundStreamProtocolNegotiationTimeout:this.inboundStreamProtocolNegotiationTimeout});return t.addEventListener("close",()=>{this.events.safeDispatchEvent("connection:close",{detail:t})}),this.events.safeDispatchEvent("connection:open",{detail:t}),t}async _encryptInbound(e,t){let n=Array.from(this.connectionEncrypters.keys());try{let o=await Wu(e,n,t),i=this.connectionEncrypters.get(o);if(i==null)throw new Rc(`no crypto module found for ${o}`);return e.log("encrypting inbound connection using %s",o),{...await i.secureInbound(e,t),protocol:o}}catch(o){throw new Rc(o.message)}}async _encryptOutbound(e,t){let n=Array.from(this.connectionEncrypters.keys());try{e.log.trace("selecting encrypter from %s",n);let o=await qu(e,n,t),i=this.connectionEncrypters.get(o);if(i==null)throw new Rc(`no crypto module found for ${o}`);return e.log("encrypting outbound connection using %s",o),{...await i.secureOutbound(e,t),protocol:o}}catch(o){throw new Rc(o.message)}}async _multiplexOutbound(e,t,n){let o=Array.from(t.keys());e.log("outbound selecting muxer %s",o);try{e.log.trace("selecting stream muxer from %s",o);let i=await qu(e,o,n),s=t.get(i);if(s==null)throw new ra(`No muxer configured for protocol "${i}"`);return e.log("selected %s as muxer protocol",i),s}catch(i){throw e.log.error("error multiplexing outbound connection - %e",i),new ra(String(i))}}async _multiplexInbound(e,t,n){let o=Array.from(t.keys());e.log("inbound handling muxers %s",o);try{e.log.trace("selecting stream muxer from %s",o);let i=await Wu(e,o,n),s=t.get(i);if(s==null)throw new ra(`No muxer configured for protocol "${i}"`);return e.log("selected %s as muxer protocol",i),s}catch(i){throw e.log.error("error multiplexing inbound connection - %e",i),i}}getConnectionEncrypters(){return this.connectionEncrypters}getStreamMuxers(){return this.streamMuxers}};function SK(r){return r.skipEncryption===!0}var Bg="3.1.2",Mg="js-libp2p";function Ug(r,e){return`${r??Mg}/${e??Bg} browser/${globalThis.navigator.userAgent}`}var jh=class extends _e{peerId;peerStore;contentRouting;peerRouting;metrics;services;logger;status;components;log;constructor(e){super(),this.status="stopped";let t=new _e,n=t.dispatchEvent.bind(t);t.dispatchEvent=l=>{let f=n(l),u=this.dispatchEvent(new CustomEvent(l.type,{detail:l.detail}));return f||u},this.peerId=e.peerId,this.logger=e.logger??Qo(),this.log=this.logger.forComponent("libp2p"),this.services={};let o=e.nodeInfo?.name??Mg,i=e.nodeInfo?.version??Bg,s=this.components=JT({peerId:e.peerId,privateKey:e.privateKey,nodeInfo:{name:o,version:i,userAgent:e.nodeInfo?.userAgent??Ug(o,i)},logger:this.logger,events:t,datastore:e.datastore??new Oc,connectionGater:tI(e.connectionGater),dns:e.dns});e.metrics!=null&&(this.metrics=this.configureComponent("metrics",e.metrics(this.components))),this.peerStore=this.configureComponent("peerStore",GT(s,{addressFilter:this.components.connectionGater.filterMultiaddrForPeer,...e.peerStore})),s.events.addEventListener("peer:update",l=>{if(l.detail.previous==null){let f={id:l.detail.peer.id,multiaddrs:l.detail.peer.addresses.map(u=>u.multiaddr)};s.events.safeDispatchEvent("peer:discovery",{detail:f})}}),e.connectionProtector!=null&&this.configureComponent("connectionProtector",e.connectionProtector(s)),this.components.upgrader=new Lg(this.components,{connectionEncrypters:(e.connectionEncrypters??[]).map((l,f)=>this.configureComponent(`connection-encryption-${f}`,l(this.components))),streamMuxers:(e.streamMuxers??[]).map((l,f)=>this.configureComponent(`stream-muxers-${f}`,l(this.components))),inboundUpgradeTimeout:e.connectionManager?.inboundUpgradeTimeout,inboundStreamProtocolNegotiationTimeout:e.connectionManager?.inboundStreamProtocolNegotiationTimeout,outboundStreamProtocolNegotiationTimeout:e.connectionManager?.outboundStreamProtocolNegotiationTimeout,connectionCloseTimeout:e.connectionManager?.connectionCloseTimeout}),this.configureComponent("transportManager",new Ng(this.components,e.transportManager)),this.configureComponent("connectionManager",new Ig(this.components,e.connectionManager)),e.connectionMonitor?.enabled!==!1&&this.configureComponent("connectionMonitor",new Cg(this.components,e.connectionMonitor)),this.configureComponent("registrar",new Dg(this.components)),this.configureComponent("addressManager",new ag(this.components,e.addresses));let a=(e.peerRouters??[]).map((l,f)=>this.configureComponent(`peer-router-${f}`,l(this.components)));this.peerRouting=this.components.peerRouting=this.configureComponent("peerRouting",new Og(this.components,{routers:a}));let c=(e.contentRouters??[]).map((l,f)=>this.configureComponent(`content-router-${f}`,l(this.components)));if(this.contentRouting=this.components.contentRouting=this.configureComponent("contentRouting",new Pg(this.components,{routers:c})),this.configureComponent("randomWalk",new Rg(this.components)),(e.peerDiscovery??[]).forEach((l,f)=>{this.configureComponent(`peer-discovery-${f}`,l(this.components)).addEventListener("peer",d=>{this.#e(d)})}),e.transports?.forEach((l,f)=>{this.components.transportManager.add(this.configureComponent(`transport-${f}`,l(this.components)))}),e.services!=null)for(let l of Object.keys(e.services)){let f=e.services[l],u=f(this.components);if(u==null){this.log.error("service factory %s returned null or undefined instance",l);continue}this.services[l]=u,this.configureComponent(l,u),u[ki]!=null&&(this.log("registering service %s for content routing",l),c.push(u[ki])),u[Ri]!=null&&(this.log("registering service %s for peer routing",l),a.push(u[Ri])),u[Va]!=null&&(this.log("registering service %s for peer discovery",l),u[Va].addEventListener?.("peer",d=>{this.#e(d)}))}eI(s)}configureComponent(e,t){return t==null&&this.log.error("component %s was null or undefined",e),this.components[e]=t,t}async start(){if(this.status==="stopped"){this.status="starting",this.log("libp2p is starting");try{await this.components.beforeStart?.(),await this.components.start(),await this.components.afterStart?.(),this.status="started",this.safeDispatchEvent("start",{detail:this}),this.log("libp2p has started with peer id %p",this.peerId)}catch(e){throw this.log.error("an error occurred starting libp2p - %e",e),this.status="started",await this.stop(),e}}}async stop(){this.status==="started"&&(this.log("libp2p is stopping"),this.status="stopping",await this.components.beforeStop?.(),await this.components.stop(),await this.components.afterStop?.(),this.status="stopped",this.safeDispatchEvent("stop",{detail:this}),this.log("libp2p has stopped"))}getConnections(e){return this.components.connectionManager.getConnections(e)}getDialQueue(){return this.components.connectionManager.getDialQueue()}getPeers(){let e=new Bn;for(let t of this.components.connectionManager.getConnections())e.add(t.remotePeer);return Array.from(e)}async dial(e,t={}){return this.components.connectionManager.openConnection(e,{priority:75,...t})}async dialProtocol(e,t,n={}){if(t==null)throw new P("no protocols were provided to open a stream");if(t=Array.isArray(t)?t:[t],t.length===0)throw new P("no protocols were provided to open a stream");return this.components.connectionManager.openStream(e,t,n)}getMultiaddrs(){return this.components.addressManager.getAddresses()}getProtocols(){return this.components.registrar.getProtocols()}async hangUp(e,t={}){oi(e)&&(e=yt(e.getComponents().findLast(n=>n.code===421)?.value??"")),await this.components.connectionManager.closeConnections(e,t)}async getPublicKey(e,t={}){if(this.log("getPublicKey %p",e),e.publicKey!=null)return e.publicKey;try{let s=await this.peerStore.get(e,t);if(s.id.publicKey!=null)return s.id.publicKey}catch(s){if(s.name!=="NotFoundError")throw s}let n=gt([B("/pk/"),e.toMultihash().bytes]),o=await this.contentRouting.get(n,t),i=Kt(o);return await this.peerStore.patch(e,{publicKey:i},t),i}async handle(e,t,n){Array.isArray(e)||(e=[e]),await Promise.all(e.map(async o=>{await this.components.registrar.handle(o,t,n)}))}async unhandle(e,t){Array.isArray(e)||(e=[e]),await Promise.all(e.map(async n=>{await this.components.registrar.unhandle(n,t)}))}async register(e,t,n){return this.components.registrar.register(e,t,n)}unregister(e){this.components.registrar.unregister(e)}use(e,t){this.components.registrar.use(e,Array.isArray(t)?t:[t])}unuse(e){this.components.registrar.unuse(e)}async isDialable(e,t={}){return this.components.connectionManager.isDialable(e,t)}#e(e){let{detail:t}=e;if(t.id.toString()===this.peerId.toString()){this.log.error("peer discovery mechanism discovered self");return}this.components.peerStore.merge(t.id,{multiaddrs:t.multiaddrs}).catch(n=>{this.log.error("could not update multiaddrs of discovered peer - %e",n)})}};async function yI(r={}){r.privateKey??=await uu("Ed25519");let e=new jh({...await DT(r),peerId:HA(r.privateKey)});return r.start!==!1&&await e.start(),e}var _K=["dial","dialProtocol","hangUp","handle","unhandle","getMultiaddrs","getProtocols"];function wI(r){return r==null?!1:r instanceof jh?!0:_K.every(e=>typeof r[e]=="function")}var gC=nr(II(),1);var m7={keyLength:64,iterationCount:1e4,salt:"you should override this value with a crypto secure random number",hash:"sha2-512"};var zu={};Nt(zu,{create:()=>MK,derivedEmptyPasswordKey:()=>Fg});var Fg={alg:"A128GCM",ext:!0,k:"scm9jmO_4BJAgdwWGVulLg",key_ops:["encrypt","decrypt"],kty:"oct"};function MK(r){let e=r?.algorithm??"AES-GCM",t=r?.keyLength??16,n=r?.nonceLength??12,o=r?.digest??"SHA-256",i=r?.saltLength??16,s=r?.iterations??32767,a=qt.get();t*=8;async function c(u,d){let h=a.getRandomValues(new Uint8Array(i)),m=a.getRandomValues(new Uint8Array(n)),w={name:e,iv:m};typeof d=="string"&&(d=B(d));let y;if(d.length===0){y=await a.subtle.importKey("jwk",Fg,{name:"AES-GCM"},!0,["encrypt"]);try{let N={name:"PBKDF2",salt:h,iterations:s,hash:{name:o}},O=await a.subtle.importKey("raw",d,{name:"PBKDF2"},!1,["deriveKey"]);y=await a.subtle.deriveKey(N,O,{name:e,length:t},!0,["encrypt"])}catch{y=await a.subtle.importKey("jwk",Fg,{name:"AES-GCM"},!0,["encrypt"])}}else{let N={name:"PBKDF2",salt:h,iterations:s,hash:{name:o}},O=await a.subtle.importKey("raw",d,{name:"PBKDF2"},!1,["deriveKey"]);y=await a.subtle.deriveKey(N,O,{name:e,length:t},!0,["encrypt"])}let b=await a.subtle.encrypt(w,y,u);return gt([h,w.iv,new Uint8Array(b)])}async function l(u,d){let h=u.subarray(0,i),m=u.subarray(i,i+n),w=u.subarray(i+n),y={name:e,iv:m};typeof d=="string"&&(d=B(d));let b;if(d.length===0)try{let O={name:"PBKDF2",salt:h,iterations:s,hash:{name:o}},V=await a.subtle.importKey("raw",d,{name:"PBKDF2"},!1,["deriveKey"]);b=await a.subtle.deriveKey(O,V,{name:e,length:t},!0,["decrypt"])}catch{b=await a.subtle.importKey("jwk",Fg,{name:"AES-GCM"},!0,["decrypt"])}else{let O={name:"PBKDF2",salt:h,iterations:s,hash:{name:o}},V=await a.subtle.importKey("raw",d,{name:"PBKDF2"},!1,["deriveKey"]);b=await a.subtle.deriveKey(O,V,{name:e,length:t},!0,["decrypt"])}let N=await a.subtle.decrypt(y,b,w);return new Uint8Array(N)}return{encrypt:c,decrypt:l}}var io={};Nt(io,{Any:()=>ui,BaseBlock:()=>Xt,BaseStringBlock:()=>qh,BitString:()=>Mo,BmpString:()=>Bc,Boolean:()=>Nc,CharacterString:()=>qc,Choice:()=>Yu,Constructed:()=>Yt,DATE:()=>Qh,DateTime:()=>Jh,Duration:()=>ep,EndOfContent:()=>Wh,Enumerated:()=>Lc,GeneralString:()=>Hc,GeneralizedTime:()=>Wc,GraphicString:()=>Vc,HexBlock:()=>di,IA5String:()=>Kc,Integer:()=>Un,Null:()=>hn,NumericString:()=>Uc,ObjectIdentifier:()=>Fn,OctetString:()=>Kr,Primitive:()=>cs,PrintableString:()=>Fc,RawData:()=>b7,RelativeObjectIdentifier:()=>Yh,Repeated:()=>zc,Sequence:()=>vt,Set:()=>Jr,TIME:()=>tp,TeletexString:()=>$c,TimeOfDay:()=>Zh,UTCTime:()=>ia,UniversalString:()=>Mc,Utf8String:()=>oo,ValueBlock:()=>xr,VideotexString:()=>jc,ViewWriter:()=>Xu,VisibleString:()=>oa,compareSchema:()=>ss,fromBER:()=>$n,verifySchema:()=>oV});var Me=nr(is());function Dc(r,e){let t=0;if(r.length===1)return r[0];for(let n=r.length-1;n>=0;n--)t+=r[r.length-1-n]*Math.pow(2,e*n);return t}function na(r,e,t=-1){let n=t,o=r,i=0,s=Math.pow(2,e);for(let a=1;a<8;a++){if(r<s){let c;if(n<0)c=new ArrayBuffer(a),i=a;else{if(n<a)return new ArrayBuffer(0);c=new ArrayBuffer(n),i=n}let l=new Uint8Array(c);for(let f=a-1;f>=0;f--){let u=Math.pow(2,f*e);l[i-f-1]=Math.floor(o/u),o-=l[i-f-1]*u}return c}s*=Math.pow(2,e)}return new ArrayBuffer(0)}function Kg(...r){let e=0,t=0;for(let i of r)e+=i.length;let n=new ArrayBuffer(e),o=new Uint8Array(n);for(let i of r)o.set(i,t),t+=i.length;return o}function y7(){let r=new Uint8Array(this.valueHex);if(this.valueHex.byteLength>=2){let a=r[0]===255&&r[1]&128,c=r[0]===0&&(r[1]&128)===0;(a||c)&&this.warnings.push("Needlessly long format")}let e=new ArrayBuffer(this.valueHex.byteLength),t=new Uint8Array(e);for(let a=0;a<this.valueHex.byteLength;a++)t[a]=0;t[0]=r[0]&128;let n=Dc(t,8),o=new ArrayBuffer(this.valueHex.byteLength),i=new Uint8Array(o);for(let a=0;a<this.valueHex.byteLength;a++)i[a]=r[a];return i[0]&=127,Dc(i,8)-n}function CI(r){let e=r<0?r*-1:r,t=128;for(let n=1;n<8;n++){if(e<=t){if(r<0){let s=t-e,a=na(s,8,n),c=new Uint8Array(a);return c[0]|=128,a}let o=na(e,8,n),i=new Uint8Array(o);if(i[0]&128){let s=o.slice(0),a=new Uint8Array(s);o=new ArrayBuffer(o.byteLength+1),i=new Uint8Array(o);for(let c=0;c<s.byteLength;c++)i[c+1]=a[c];i[0]=0}return o}t*=Math.pow(2,8)}return new ArrayBuffer(0)}function PI(r,e){if(r.byteLength!==e.byteLength)return!1;let t=new Uint8Array(r),n=new Uint8Array(e);for(let o=0;o<t.length;o++)if(t[o]!==n[o])return!1;return!0}function fn(r,e){let t=r.toString(10);if(e<t.length)return"";let n=e-t.length,o=new Array(n);for(let s=0;s<n;s++)o[s]="0";return o.join("").concat(t)}var r2e=Math.log(2);function Vg(){if(typeof BigInt>"u")throw new Error("BigInt is not defined. Your environment doesn't implement BigInt.")}function v7(r){let e=0,t=0;for(let o=0;o<r.length;o++){let i=r[o];e+=i.byteLength}let n=new Uint8Array(e);for(let o=0;o<r.length;o++){let i=r[o];n.set(new Uint8Array(i),t),t+=i.byteLength}return n.buffer}function ls(r,e,t,n){return e instanceof Uint8Array?e.byteLength?t<0?(r.error="Wrong parameter: inputOffset less than zero",!1):n<0?(r.error="Wrong parameter: inputLength less than zero",!1):e.byteLength-t-n<0?(r.error="End of input reached before message was fully decoded (inconsistent offset and length values)",!1):!0:(r.error="Wrong parameter: inputBuffer has zero length",!1):(r.error="Wrong parameter: inputBuffer must be 'Uint8Array'",!1)}var Xu=class{constructor(){this.items=[]}write(e){this.items.push(e)}final(){return v7(this.items)}},Kh=[new Uint8Array([1])],kI="0123456789",w7="name",OI="valueHexView",WK="isHexOnly",zK="idBlock",GK="tagClass",XK="tagNumber",YK="isConstructed",QK="fromBER",ZK="toBER",JK="local",dn="",fi=new ArrayBuffer(0),oy=new Uint8Array(0),Hh="EndOfContent",DI="OCTET STRING",NI="BIT STRING";function di(r){var e;return e=class extends r{get valueHex(){return this.valueHexView.slice().buffer}set valueHex(n){this.valueHexView=new Uint8Array(n)}constructor(...n){var o;super(...n);let i=n[0]||{};this.isHexOnly=(o=i.isHexOnly)!==null&&o!==void 0?o:!1,this.valueHexView=i.valueHex?Me.BufferSourceConverter.toUint8Array(i.valueHex):oy}fromBER(n,o,i){let s=n instanceof ArrayBuffer?new Uint8Array(n):n;if(!ls(this,s,o,i))return-1;let a=o+i;return this.valueHexView=s.subarray(o,a),this.valueHexView.length?(this.blockLength=i,a):(this.warnings.push("Zero buffer length"),o)}toBER(n=!1){return this.isHexOnly?n?new ArrayBuffer(this.valueHexView.byteLength):this.valueHexView.byteLength===this.valueHexView.buffer.byteLength?this.valueHexView.buffer:this.valueHexView.slice().buffer:(this.error="Flag 'isHexOnly' is not set, abort",fi)}toJSON(){return{...super.toJSON(),isHexOnly:this.isHexOnly,valueHex:Me.Convert.ToHex(this.valueHexView)}}},e.NAME="hexBlock",e}var as=class{static blockName(){return this.NAME}get valueBeforeDecode(){return this.valueBeforeDecodeView.slice().buffer}set valueBeforeDecode(e){this.valueBeforeDecodeView=new Uint8Array(e)}constructor({blockLength:e=0,error:t=dn,warnings:n=[],valueBeforeDecode:o=oy}={}){this.blockLength=e,this.error=t,this.warnings=n,this.valueBeforeDecodeView=Me.BufferSourceConverter.toUint8Array(o)}toJSON(){return{blockName:this.constructor.NAME,blockLength:this.blockLength,error:this.error,warnings:this.warnings,valueBeforeDecode:Me.Convert.ToHex(this.valueBeforeDecodeView)}}};as.NAME="baseBlock";var xr=class extends as{fromBER(e,t,n){throw TypeError("User need to make a specific function in a class which extends 'ValueBlock'")}toBER(e,t){throw TypeError("User need to make a specific function in a class which extends 'ValueBlock'")}};xr.NAME="valueBlock";var Hg=class extends di(as){constructor({idBlock:e={}}={}){var t,n,o,i;super(),e?(this.isHexOnly=(t=e.isHexOnly)!==null&&t!==void 0?t:!1,this.valueHexView=e.valueHex?Me.BufferSourceConverter.toUint8Array(e.valueHex):oy,this.tagClass=(n=e.tagClass)!==null&&n!==void 0?n:-1,this.tagNumber=(o=e.tagNumber)!==null&&o!==void 0?o:-1,this.isConstructed=(i=e.isConstructed)!==null&&i!==void 0?i:!1):(this.tagClass=-1,this.tagNumber=-1,this.isConstructed=!1)}toBER(e=!1){let t=0;switch(this.tagClass){case 1:t|=0;break;case 2:t|=64;break;case 3:t|=128;break;case 4:t|=192;break;default:return this.error="Unknown tag class",fi}if(this.isConstructed&&(t|=32),this.tagNumber<31&&!this.isHexOnly){let o=new Uint8Array(1);if(!e){let i=this.tagNumber;i&=31,t|=i,o[0]=t}return o.buffer}if(!this.isHexOnly){let o=na(this.tagNumber,7),i=new Uint8Array(o),s=o.byteLength,a=new Uint8Array(s+1);if(a[0]=t|31,!e){for(let c=0;c<s-1;c++)a[c+1]=i[c]|128;a[s]=i[s-1]}return a.buffer}let n=new Uint8Array(this.valueHexView.byteLength+1);if(n[0]=t|31,!e){let o=this.valueHexView;for(let i=0;i<o.length-1;i++)n[i+1]=o[i]|128;n[this.valueHexView.byteLength]=o[o.length-1]}return n.buffer}fromBER(e,t,n){let o=Me.BufferSourceConverter.toUint8Array(e);if(!ls(this,o,t,n))return-1;let i=o.subarray(t,t+n);if(i.length===0)return this.error="Zero buffer length",-1;switch(i[0]&192){case 0:this.tagClass=1;break;case 64:this.tagClass=2;break;case 128:this.tagClass=3;break;case 192:this.tagClass=4;break;default:return this.error="Unknown tag class",-1}this.isConstructed=(i[0]&32)===32,this.isHexOnly=!1;let a=i[0]&31;if(a!==31)this.tagNumber=a,this.blockLength=1;else{let c=1,l=this.valueHexView=new Uint8Array(255),f=255;for(;i[c]&128;){if(l[c-1]=i[c]&127,c++,c>=i.length)return this.error="End of input reached before message was fully decoded",-1;if(c===f){f+=255;let d=new Uint8Array(f);for(let h=0;h<l.length;h++)d[h]=l[h];l=this.valueHexView=new Uint8Array(f)}}this.blockLength=c+1,l[c-1]=i[c]&127;let u=new Uint8Array(c);for(let d=0;d<c;d++)u[d]=l[d];l=this.valueHexView=new Uint8Array(c),l.set(u),this.blockLength<=9?this.tagNumber=Dc(l,7):(this.isHexOnly=!0,this.warnings.push("Tag too long, represented as hex-coded"))}if(this.tagClass===1&&this.isConstructed)switch(this.tagNumber){case 1:case 2:case 5:case 6:case 9:case 13:case 14:case 23:case 24:case 31:case 32:case 33:case 34:return this.error="Constructed encoding used for primitive type",-1}return t+this.blockLength}toJSON(){return{...super.toJSON(),tagClass:this.tagClass,tagNumber:this.tagNumber,isConstructed:this.isConstructed}}};Hg.NAME="identificationBlock";var qg=class extends as{constructor({lenBlock:e={}}={}){var t,n,o;super(),this.isIndefiniteForm=(t=e.isIndefiniteForm)!==null&&t!==void 0?t:!1,this.longFormUsed=(n=e.longFormUsed)!==null&&n!==void 0?n:!1,this.length=(o=e.length)!==null&&o!==void 0?o:0}fromBER(e,t,n){let o=Me.BufferSourceConverter.toUint8Array(e);if(!ls(this,o,t,n))return-1;let i=o.subarray(t,t+n);if(i.length===0)return this.error="Zero buffer length",-1;if(i[0]===255)return this.error="Length block 0xFF is reserved by standard",-1;if(this.isIndefiniteForm=i[0]===128,this.isIndefiniteForm)return this.blockLength=1,t+this.blockLength;if(this.longFormUsed=!!(i[0]&128),this.longFormUsed===!1)return this.length=i[0],this.blockLength=1,t+this.blockLength;let s=i[0]&127;if(s>8)return this.error="Too big integer",-1;if(s+1>i.length)return this.error="End of input reached before message was fully decoded",-1;let a=t+1,c=o.subarray(a,a+s);return c[s-1]===0&&this.warnings.push("Needlessly long encoded length"),this.length=Dc(c,8),this.longFormUsed&&this.length<=127&&this.warnings.push("Unnecessary usage of long length form"),this.blockLength=s+1,t+this.blockLength}toBER(e=!1){let t,n;if(this.length>127&&(this.longFormUsed=!0),this.isIndefiniteForm)return t=new ArrayBuffer(1),e===!1&&(n=new Uint8Array(t),n[0]=128),t;if(this.longFormUsed){let o=na(this.length,8);if(o.byteLength>127)return this.error="Too big length",fi;if(t=new ArrayBuffer(o.byteLength+1),e)return t;let i=new Uint8Array(o);n=new Uint8Array(t),n[0]=o.byteLength|128;for(let s=0;s<o.byteLength;s++)n[s+1]=i[s];return t}return t=new ArrayBuffer(1),e===!1&&(n=new Uint8Array(t),n[0]=this.length),t}toJSON(){return{...super.toJSON(),isIndefiniteForm:this.isIndefiniteForm,longFormUsed:this.longFormUsed,length:this.length}}};qg.NAME="lengthBlock";var le={},Xt=class extends as{constructor({name:e=dn,optional:t=!1,primitiveSchema:n,...o}={},i){super(o),this.name=e,this.optional=t,n&&(this.primitiveSchema=n),this.idBlock=new Hg(o),this.lenBlock=new qg(o),this.valueBlock=i?new i(o):new xr(o)}fromBER(e,t,n){let o=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?n:this.lenBlock.length);return o===-1?(this.error=this.valueBlock.error,o):(this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),o)}toBER(e,t){let n=t||new Xu;t||LI(this);let o=this.idBlock.toBER(e);if(n.write(o),this.lenBlock.isIndefiniteForm)n.write(new Uint8Array([128]).buffer),this.valueBlock.toBER(e,n),n.write(new ArrayBuffer(2));else{let i=this.valueBlock.toBER(e);this.lenBlock.length=i.byteLength;let s=this.lenBlock.toBER(e);n.write(s),n.write(i)}return t?fi:n.final()}toJSON(){let e={...super.toJSON(),idBlock:this.idBlock.toJSON(),lenBlock:this.lenBlock.toJSON(),valueBlock:this.valueBlock.toJSON(),name:this.name,optional:this.optional};return this.primitiveSchema&&(e.primitiveSchema=this.primitiveSchema.toJSON()),e}toString(e="ascii"){return e==="ascii"?this.onAsciiEncoding():Me.Convert.ToHex(this.toBER())}onAsciiEncoding(){let e=this.constructor.NAME,t=Me.Convert.ToHex(this.valueBlock.valueBeforeDecodeView);return`${e} : ${t}`}isEqual(e){if(this===e)return!0;if(!(e instanceof this.constructor))return!1;let t=this.toBER(),n=e.toBER();return PI(t,n)}};Xt.NAME="BaseBlock";function LI(r){var e;if(r instanceof le.Constructed)for(let t of r.valueBlock.value)LI(t)&&(r.lenBlock.isIndefiniteForm=!0);return!!(!((e=r.lenBlock)===null||e===void 0)&&e.isIndefiniteForm)}var qh=class extends Xt{getValue(){return this.valueBlock.value}setValue(e){this.valueBlock.value=e}constructor({value:e=dn,...t}={},n){super(t,n),e&&this.fromString(e)}fromBER(e,t,n){let o=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?n:this.lenBlock.length);return o===-1?(this.error=this.valueBlock.error,o):(this.fromBuffer(this.valueBlock.valueHexView),this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),o)}onAsciiEncoding(){return`${this.constructor.NAME} : '${this.valueBlock.value}'`}};qh.NAME="BaseStringBlock";var Wg=class extends di(xr){constructor({isHexOnly:e=!0,...t}={}){super(t),this.isHexOnly=e}};Wg.NAME="PrimitiveValueBlock";var BI,cs=class extends Xt{constructor(e={}){super(e,Wg),this.idBlock.isConstructed=!1}};BI=cs;le.Primitive=BI;cs.NAME="PRIMITIVE";function eV(r,e){if(r instanceof e)return r;let t=new e;return t.idBlock=r.idBlock,t.lenBlock=r.lenBlock,t.warnings=r.warnings,t.valueBeforeDecodeView=r.valueBeforeDecodeView,t}function Qu(r,e=0,t=r.length){let n=e,o=new Xt({},xr),i=new as;if(!ls(i,r,e,t))return o.error=i.error,{offset:-1,result:o};if(!r.subarray(e,e+t).length)return o.error="Zero buffer length",{offset:-1,result:o};let a=o.idBlock.fromBER(r,e,t);if(o.idBlock.warnings.length&&o.warnings.concat(o.idBlock.warnings),a===-1)return o.error=o.idBlock.error,{offset:-1,result:o};if(e=a,t-=o.idBlock.blockLength,a=o.lenBlock.fromBER(r,e,t),o.lenBlock.warnings.length&&o.warnings.concat(o.lenBlock.warnings),a===-1)return o.error=o.lenBlock.error,{offset:-1,result:o};if(e=a,t-=o.lenBlock.blockLength,!o.idBlock.isConstructed&&o.lenBlock.isIndefiniteForm)return o.error="Indefinite length form used for primitive encoding form",{offset:-1,result:o};let c=Xt;switch(o.idBlock.tagClass){case 1:if(o.idBlock.tagNumber>=37&&o.idBlock.isHexOnly===!1)return o.error="UNIVERSAL 37 and upper tags are reserved by ASN.1 standard",{offset:-1,result:o};switch(o.idBlock.tagNumber){case 0:if(o.idBlock.isConstructed&&o.lenBlock.length>0)return o.error="Type [UNIVERSAL 0] is reserved",{offset:-1,result:o};c=le.EndOfContent;break;case 1:c=le.Boolean;break;case 2:c=le.Integer;break;case 3:c=le.BitString;break;case 4:c=le.OctetString;break;case 5:c=le.Null;break;case 6:c=le.ObjectIdentifier;break;case 10:c=le.Enumerated;break;case 12:c=le.Utf8String;break;case 13:c=le.RelativeObjectIdentifier;break;case 14:c=le.TIME;break;case 15:return o.error="[UNIVERSAL 15] is reserved by ASN.1 standard",{offset:-1,result:o};case 16:c=le.Sequence;break;case 17:c=le.Set;break;case 18:c=le.NumericString;break;case 19:c=le.PrintableString;break;case 20:c=le.TeletexString;break;case 21:c=le.VideotexString;break;case 22:c=le.IA5String;break;case 23:c=le.UTCTime;break;case 24:c=le.GeneralizedTime;break;case 25:c=le.GraphicString;break;case 26:c=le.VisibleString;break;case 27:c=le.GeneralString;break;case 28:c=le.UniversalString;break;case 29:c=le.CharacterString;break;case 30:c=le.BmpString;break;case 31:c=le.DATE;break;case 32:c=le.TimeOfDay;break;case 33:c=le.DateTime;break;case 34:c=le.Duration;break;default:{let l=o.idBlock.isConstructed?new le.Constructed:new le.Primitive;l.idBlock=o.idBlock,l.lenBlock=o.lenBlock,l.warnings=o.warnings,o=l}}break;case 2:case 3:case 4:default:c=o.idBlock.isConstructed?le.Constructed:le.Primitive}return o=eV(o,c),a=o.fromBER(r,e,o.lenBlock.isIndefiniteForm?t:o.lenBlock.length),o.valueBeforeDecodeView=r.subarray(n,n+o.blockLength),{offset:a,result:o}}function $n(r){if(!r.byteLength){let e=new Xt({},xr);return e.error="Input buffer has zero length",{offset:-1,result:e}}return Qu(Me.BufferSourceConverter.toUint8Array(r).slice(),0,r.byteLength)}function tV(r,e){return r?1:e}var li=class extends xr{constructor({value:e=[],isIndefiniteForm:t=!1,...n}={}){super(n),this.value=e,this.isIndefiniteForm=t}fromBER(e,t,n){let o=Me.BufferSourceConverter.toUint8Array(e);if(!ls(this,o,t,n))return-1;if(this.valueBeforeDecodeView=o.subarray(t,t+n),this.valueBeforeDecodeView.length===0)return this.warnings.push("Zero buffer length"),t;let i=t;for(;tV(this.isIndefiniteForm,n)>0;){let s=Qu(o,i,n);if(s.offset===-1)return this.error=s.result.error,this.warnings.concat(s.result.warnings),-1;if(i=s.offset,this.blockLength+=s.result.blockLength,n-=s.result.blockLength,this.value.push(s.result),this.isIndefiniteForm&&s.result.constructor.NAME===Hh)break}return this.isIndefiniteForm&&(this.value[this.value.length-1].constructor.NAME===Hh?this.value.pop():this.warnings.push("No EndOfContent block encoded")),i}toBER(e,t){let n=t||new Xu;for(let o=0;o<this.value.length;o++)this.value[o].toBER(e,n);return t?fi:n.final()}toJSON(){let e={...super.toJSON(),isIndefiniteForm:this.isIndefiniteForm,value:[]};for(let t of this.value)e.value.push(t.toJSON());return e}};li.NAME="ConstructedValueBlock";var MI,Yt=class extends Xt{constructor(e={}){super(e,li),this.idBlock.isConstructed=!0}fromBER(e,t,n){this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm;let o=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?n:this.lenBlock.length);return o===-1?(this.error=this.valueBlock.error,o):(this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),o)}onAsciiEncoding(){let e=[];for(let n of this.valueBlock.value)e.push(n.toString("ascii").split(`
`).map(o=>`  ${o}`).join(`
`));let t=this.idBlock.tagClass===3?`[${this.idBlock.tagNumber}]`:this.constructor.NAME;return e.length?`${t} :
${e.join(`
`)}`:`${t} :`}};MI=Yt;le.Constructed=MI;Yt.NAME="CONSTRUCTED";var zg=class extends xr{fromBER(e,t,n){return t}toBER(e){return fi}};zg.override="EndOfContentValueBlock";var UI,Wh=class extends Xt{constructor(e={}){super(e,zg),this.idBlock.tagClass=1,this.idBlock.tagNumber=0}};UI=Wh;le.EndOfContent=UI;Wh.NAME=Hh;var FI,hn=class extends Xt{constructor(e={}){super(e,xr),this.idBlock.tagClass=1,this.idBlock.tagNumber=5}fromBER(e,t,n){return this.lenBlock.length>0&&this.warnings.push("Non-zero length of value block for Null type"),this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.blockLength+=n,t+n>e.byteLength?(this.error="End of input reached before message was fully decoded (inconsistent offset and length values)",-1):t+n}toBER(e,t){let n=new ArrayBuffer(2);if(!e){let o=new Uint8Array(n);o[0]=5,o[1]=0}return t&&t.write(n),n}onAsciiEncoding(){return`${this.constructor.NAME}`}};FI=hn;le.Null=FI;hn.NAME="NULL";var Gg=class extends di(xr){get value(){for(let e of this.valueHexView)if(e>0)return!0;return!1}set value(e){this.valueHexView[0]=e?255:0}constructor({value:e,...t}={}){super(t),t.valueHex?this.valueHexView=Me.BufferSourceConverter.toUint8Array(t.valueHex):this.valueHexView=new Uint8Array(1),e&&(this.value=e)}fromBER(e,t,n){let o=Me.BufferSourceConverter.toUint8Array(e);return ls(this,o,t,n)?(this.valueHexView=o.subarray(t,t+n),n>1&&this.warnings.push("Boolean value encoded in more then 1 octet"),this.isHexOnly=!0,y7.call(this),this.blockLength=n,t+n):-1}toBER(){return this.valueHexView.slice()}toJSON(){return{...super.toJSON(),value:this.value}}};Gg.NAME="BooleanValueBlock";var $I,Nc=class extends Xt{getValue(){return this.valueBlock.value}setValue(e){this.valueBlock.value=e}constructor(e={}){super(e,Gg),this.idBlock.tagClass=1,this.idBlock.tagNumber=1}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.getValue}`}};$I=Nc;le.Boolean=$I;Nc.NAME="BOOLEAN";var Xg=class extends di(li){constructor({isConstructed:e=!1,...t}={}){super(t),this.isConstructed=e}fromBER(e,t,n){let o=0;if(this.isConstructed){if(this.isHexOnly=!1,o=li.prototype.fromBER.call(this,e,t,n),o===-1)return o;for(let i=0;i<this.value.length;i++){let s=this.value[i].constructor.NAME;if(s===Hh){if(this.isIndefiniteForm)break;return this.error="EndOfContent is unexpected, OCTET STRING may consists of OCTET STRINGs only",-1}if(s!==DI)return this.error="OCTET STRING may consists of OCTET STRINGs only",-1}}else this.isHexOnly=!0,o=super.fromBER(e,t,n),this.blockLength=n;return o}toBER(e,t){return this.isConstructed?li.prototype.toBER.call(this,e,t):e?new ArrayBuffer(this.valueHexView.byteLength):this.valueHexView.slice().buffer}toJSON(){return{...super.toJSON(),isConstructed:this.isConstructed}}};Xg.NAME="OctetStringValueBlock";var x7,Kr=class extends Xt{constructor({idBlock:e={},lenBlock:t={},...n}={}){var o,i;(o=n.isConstructed)!==null&&o!==void 0||(n.isConstructed=!!(!((i=n.value)===null||i===void 0)&&i.length)),super({idBlock:{isConstructed:n.isConstructed,...e},lenBlock:{...t,isIndefiniteForm:!!n.isIndefiniteForm},...n},Xg),this.idBlock.tagClass=1,this.idBlock.tagNumber=4}fromBER(e,t,n){if(this.valueBlock.isConstructed=this.idBlock.isConstructed,this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm,n===0)return this.idBlock.error.length===0&&(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length===0&&(this.blockLength+=this.lenBlock.blockLength),t;if(!this.valueBlock.isConstructed){let i=(e instanceof ArrayBuffer?new Uint8Array(e):e).subarray(t,t+n);try{if(i.byteLength){let s=Qu(i,0,i.byteLength);s.offset!==-1&&s.offset===n&&(this.valueBlock.value=[s.result])}}catch{}}return super.fromBER(e,t,n)}onAsciiEncoding(){if(this.valueBlock.isConstructed||this.valueBlock.value&&this.valueBlock.value.length)return Yt.prototype.onAsciiEncoding.call(this);let e=this.constructor.NAME,t=Me.Convert.ToHex(this.valueBlock.valueHexView);return`${e} : ${t}`}getValue(){if(!this.idBlock.isConstructed)return this.valueBlock.valueHexView.slice().buffer;let e=[];for(let t of this.valueBlock.value)t instanceof x7&&e.push(t.valueBlock.valueHexView);return Me.BufferSourceConverter.concat(e)}};x7=Kr;le.OctetString=x7;Kr.NAME=DI;var Yg=class extends di(li){constructor({unusedBits:e=0,isConstructed:t=!1,...n}={}){super(n),this.unusedBits=e,this.isConstructed=t,this.blockLength=this.valueHexView.byteLength}fromBER(e,t,n){if(!n)return t;let o=-1;if(this.isConstructed){if(o=li.prototype.fromBER.call(this,e,t,n),o===-1)return o;for(let a of this.value){let c=a.constructor.NAME;if(c===Hh){if(this.isIndefiniteForm)break;return this.error="EndOfContent is unexpected, BIT STRING may consists of BIT STRINGs only",-1}if(c!==NI)return this.error="BIT STRING may consists of BIT STRINGs only",-1;let l=a.valueBlock;if(this.unusedBits>0&&l.unusedBits>0)return this.error='Using of "unused bits" inside constructive BIT STRING allowed for least one only',-1;this.unusedBits=l.unusedBits}return o}let i=Me.BufferSourceConverter.toUint8Array(e);if(!ls(this,i,t,n))return-1;let s=i.subarray(t,t+n);if(this.unusedBits=s[0],this.unusedBits>7)return this.error="Unused bits for BitString must be in range 0-7",-1;if(!this.unusedBits){let a=s.subarray(1);try{if(a.byteLength){let c=Qu(a,0,a.byteLength);c.offset!==-1&&c.offset===n-1&&(this.value=[c.result])}}catch{}}return this.valueHexView=s.subarray(1),this.blockLength=s.length,t+n}toBER(e,t){if(this.isConstructed)return li.prototype.toBER.call(this,e,t);if(e)return new ArrayBuffer(this.valueHexView.byteLength+1);if(!this.valueHexView.byteLength){let o=new Uint8Array(1);return o[0]=0,o.buffer}let n=new Uint8Array(this.valueHexView.length+1);return n[0]=this.unusedBits,n.set(this.valueHexView,1),n.buffer}toJSON(){return{...super.toJSON(),unusedBits:this.unusedBits,isConstructed:this.isConstructed}}};Yg.NAME="BitStringValueBlock";var jI,Mo=class extends Xt{constructor({idBlock:e={},lenBlock:t={},...n}={}){var o,i;(o=n.isConstructed)!==null&&o!==void 0||(n.isConstructed=!!(!((i=n.value)===null||i===void 0)&&i.length)),super({idBlock:{isConstructed:n.isConstructed,...e},lenBlock:{...t,isIndefiniteForm:!!n.isIndefiniteForm},...n},Yg),this.idBlock.tagClass=1,this.idBlock.tagNumber=3}fromBER(e,t,n){return this.valueBlock.isConstructed=this.idBlock.isConstructed,this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm,super.fromBER(e,t,n)}onAsciiEncoding(){if(this.valueBlock.isConstructed||this.valueBlock.value&&this.valueBlock.value.length)return Yt.prototype.onAsciiEncoding.call(this);{let e=[],t=this.valueBlock.valueHexView;for(let s of t)e.push(s.toString(2).padStart(8,"0"));let n=e.join(""),o=this.constructor.NAME,i=n.substring(0,n.length-this.valueBlock.unusedBits);return`${o} : ${i}`}}};jI=Mo;le.BitString=jI;Mo.NAME=NI;var KI;function rV(r,e){let t=new Uint8Array([0]),n=new Uint8Array(r),o=new Uint8Array(e),i=n.slice(0),s=i.length-1,a=o.slice(0),c=a.length-1,l=0,f=c<s?s:c,u=0;for(let d=f;d>=0;d--,u++){switch(!0){case u<a.length:l=i[s-u]+a[c-u]+t[0];break;default:l=i[s-u]+t[0]}switch(t[0]=l/10,!0){case u>=i.length:i=Kg(new Uint8Array([l%10]),i);break;default:i[s-u]=l%10}}return t[0]>0&&(i=Kg(t,i)),i}function RI(r){if(r>=Kh.length)for(let e=Kh.length;e<=r;e++){let t=new Uint8Array([0]),n=Kh[e-1].slice(0);for(let o=n.length-1;o>=0;o--){let i=new Uint8Array([(n[o]<<1)+t[0]]);t[0]=i[0]/10,n[o]=i[0]%10}t[0]>0&&(n=Kg(t,n)),Kh.push(n)}return Kh[r]}function nV(r,e){let t=0,n=new Uint8Array(r),o=new Uint8Array(e),i=n.slice(0),s=i.length-1,a=o.slice(0),c=a.length-1,l,f=0;for(let u=c;u>=0;u--,f++)switch(l=i[s-f]-a[c-f]-t,!0){case l<0:t=1,i[s-f]=l+10;break;default:t=0,i[s-f]=l}if(t>0)for(let u=s-c+1;u>=0;u--,f++)if(l=i[s-f]-t,l<0)t=1,i[s-f]=l+10;else{t=0,i[s-f]=l;break}return i.slice()}var zh=class extends di(xr){setValueHex(){this.valueHexView.length>=4?(this.warnings.push("Too big Integer for decoding, hex only"),this.isHexOnly=!0,this._valueDec=0):(this.isHexOnly=!1,this.valueHexView.length>0&&(this._valueDec=y7.call(this)))}constructor({value:e,...t}={}){super(t),this._valueDec=0,t.valueHex&&this.setValueHex(),e!==void 0&&(this.valueDec=e)}set valueDec(e){this._valueDec=e,this.isHexOnly=!1,this.valueHexView=new Uint8Array(CI(e))}get valueDec(){return this._valueDec}fromDER(e,t,n,o=0){let i=this.fromBER(e,t,n);if(i===-1)return i;let s=this.valueHexView;return s[0]===0&&(s[1]&128)!==0?this.valueHexView=s.subarray(1):o!==0&&s.length<o&&(o-s.length>1&&(o=s.length+1),this.valueHexView=s.subarray(o-s.length)),i}toDER(e=!1){let t=this.valueHexView;switch(!0){case(t[0]&128)!==0:{let n=new Uint8Array(this.valueHexView.length+1);n[0]=0,n.set(t,1),this.valueHexView=n}break;case(t[0]===0&&(t[1]&128)===0):this.valueHexView=this.valueHexView.subarray(1);break}return this.toBER(e)}fromBER(e,t,n){let o=super.fromBER(e,t,n);return o===-1||this.setValueHex(),o}toBER(e){return e?new ArrayBuffer(this.valueHexView.length):this.valueHexView.slice().buffer}toJSON(){return{...super.toJSON(),valueDec:this.valueDec}}toString(){let e=this.valueHexView.length*8-1,t=new Uint8Array(this.valueHexView.length*8/3),n=0,o,i=this.valueHexView,s="",a=!1;for(let c=i.byteLength-1;c>=0;c--){o=i[c];for(let l=0;l<8;l++){if((o&1)===1)switch(n){case e:t=nV(RI(n),t),s="-";break;default:t=rV(t,RI(n))}n++,o>>=1}}for(let c=0;c<t.length;c++)t[c]&&(a=!0),a&&(s+=kI.charAt(t[c]));return a===!1&&(s+=kI.charAt(0)),s}};KI=zh;zh.NAME="IntegerValueBlock";Object.defineProperty(KI.prototype,"valueHex",{set:function(r){this.valueHexView=new Uint8Array(r),this.setValueHex()},get:function(){return this.valueHexView.slice().buffer}});var Vh,Un=class extends Xt{constructor(e={}){super(e,zh),this.idBlock.tagClass=1,this.idBlock.tagNumber=2}toBigInt(){return Vg(),BigInt(this.valueBlock.toString())}static fromBigInt(e){Vg();let t=BigInt(e),n=new Xu,o=t.toString(16).replace(/^-/,""),i=new Uint8Array(Me.Convert.FromHex(o));if(t<0){let a=new Uint8Array(i.length+(i[0]&128?1:0));a[0]|=128;let l=BigInt(`0x${Me.Convert.ToHex(a)}`)+t,f=Me.BufferSourceConverter.toUint8Array(Me.Convert.FromHex(l.toString(16)));f[0]|=128,n.write(f)}else i[0]&128&&n.write(new Uint8Array([0])),n.write(i);return new Vh({valueHex:n.final()})}convertToDER(){let e=new Vh({valueHex:this.valueBlock.valueHexView});return e.valueBlock.toDER(),e}convertFromDER(){return new Vh({valueHex:this.valueBlock.valueHexView[0]===0?this.valueBlock.valueHexView.subarray(1):this.valueBlock.valueHexView})}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()}`}};Vh=Un;le.Integer=Vh;Un.NAME="INTEGER";var VI,Lc=class extends Un{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=10}};VI=Lc;le.Enumerated=VI;Lc.NAME="ENUMERATED";var Gh=class extends di(xr){constructor({valueDec:e=-1,isFirstSid:t=!1,...n}={}){super(n),this.valueDec=e,this.isFirstSid=t}fromBER(e,t,n){if(!n)return t;let o=Me.BufferSourceConverter.toUint8Array(e);if(!ls(this,o,t,n))return-1;let i=o.subarray(t,t+n);this.valueHexView=new Uint8Array(n);for(let a=0;a<n&&(this.valueHexView[a]=i[a]&127,this.blockLength++,(i[a]&128)!==0);a++);let s=new Uint8Array(this.blockLength);for(let a=0;a<this.blockLength;a++)s[a]=this.valueHexView[a];return this.valueHexView=s,(i[this.blockLength-1]&128)!==0?(this.error="End of input reached before message was fully decoded",-1):(this.valueHexView[0]===0&&this.warnings.push("Needlessly long format of SID encoding"),this.blockLength<=8?this.valueDec=Dc(this.valueHexView,7):(this.isHexOnly=!0,this.warnings.push("Too big SID for decoding, hex only")),t+this.blockLength)}set valueBigInt(e){Vg();let t=BigInt(e).toString(2);for(;t.length%7;)t="0"+t;let n=new Uint8Array(t.length/7);for(let o=0;o<n.length;o++)n[o]=parseInt(t.slice(o*7,o*7+7),2)+(o+1<n.length?128:0);this.fromBER(n.buffer,0,n.length)}toBER(e){if(this.isHexOnly){if(e)return new ArrayBuffer(this.valueHexView.byteLength);let o=this.valueHexView,i=new Uint8Array(this.blockLength);for(let s=0;s<this.blockLength-1;s++)i[s]=o[s]|128;return i[this.blockLength-1]=o[this.blockLength-1],i.buffer}let t=na(this.valueDec,7);if(t.byteLength===0)return this.error="Error during encoding SID value",fi;let n=new Uint8Array(t.byteLength);if(!e){let o=new Uint8Array(t),i=t.byteLength-1;for(let s=0;s<i;s++)n[s]=o[s]|128;n[i]=o[i]}return n}toString(){let e="";if(this.isHexOnly)e=Me.Convert.ToHex(this.valueHexView);else if(this.isFirstSid){let t=this.valueDec;this.valueDec<=39?e="0.":this.valueDec<=79?(e="1.",t-=40):(e="2.",t-=80),e+=t.toString()}else e=this.valueDec.toString();return e}toJSON(){return{...super.toJSON(),valueDec:this.valueDec,isFirstSid:this.isFirstSid}}};Gh.NAME="sidBlock";var Qg=class extends xr{constructor({value:e=dn,...t}={}){super(t),this.value=[],e&&this.fromString(e)}fromBER(e,t,n){let o=t;for(;n>0;){let i=new Gh;if(o=i.fromBER(e,o,n),o===-1)return this.blockLength=0,this.error=i.error,o;this.value.length===0&&(i.isFirstSid=!0),this.blockLength+=i.blockLength,n-=i.blockLength,this.value.push(i)}return o}toBER(e){let t=[];for(let n=0;n<this.value.length;n++){let o=this.value[n].toBER(e);if(o.byteLength===0)return this.error=this.value[n].error,fi;t.push(o)}return v7(t)}fromString(e){this.value=[];let t=0,n=0,o="",i=!1;do if(n=e.indexOf(".",t),n===-1?o=e.substring(t):o=e.substring(t,n),t=n+1,i){let s=this.value[0],a=0;switch(s.valueDec){case 0:break;case 1:a=40;break;case 2:a=80;break;default:this.value=[];return}let c=parseInt(o,10);if(isNaN(c))return;s.valueDec=c+a,i=!1}else{let s=new Gh;if(o>Number.MAX_SAFE_INTEGER){Vg();let a=BigInt(o);s.valueBigInt=a}else if(s.valueDec=parseInt(o,10),isNaN(s.valueDec))return;this.value.length||(s.isFirstSid=!0,i=!0),this.value.push(s)}while(n!==-1)}toString(){let e="",t=!1;for(let n=0;n<this.value.length;n++){t=this.value[n].isHexOnly;let o=this.value[n].toString();n!==0&&(e=`${e}.`),t?(o=`{${o}}`,this.value[n].isFirstSid?e=`2.{${o} - 80}`:e+=o):e+=o}return e}toJSON(){let e={...super.toJSON(),value:this.toString(),sidArray:[]};for(let t=0;t<this.value.length;t++)e.sidArray.push(this.value[t].toJSON());return e}};Qg.NAME="ObjectIdentifierValueBlock";var HI,Fn=class extends Xt{getValue(){return this.valueBlock.toString()}setValue(e){this.valueBlock.fromString(e)}constructor(e={}){super(e,Qg),this.idBlock.tagClass=1,this.idBlock.tagNumber=6}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()||"empty"}`}toJSON(){return{...super.toJSON(),value:this.getValue()}}};HI=Fn;le.ObjectIdentifier=HI;Fn.NAME="OBJECT IDENTIFIER";var Xh=class extends di(as){constructor({valueDec:e=0,...t}={}){super(t),this.valueDec=e}fromBER(e,t,n){if(n===0)return t;let o=Me.BufferSourceConverter.toUint8Array(e);if(!ls(this,o,t,n))return-1;let i=o.subarray(t,t+n);this.valueHexView=new Uint8Array(n);for(let a=0;a<n&&(this.valueHexView[a]=i[a]&127,this.blockLength++,(i[a]&128)!==0);a++);let s=new Uint8Array(this.blockLength);for(let a=0;a<this.blockLength;a++)s[a]=this.valueHexView[a];return this.valueHexView=s,(i[this.blockLength-1]&128)!==0?(this.error="End of input reached before message was fully decoded",-1):(this.valueHexView[0]===0&&this.warnings.push("Needlessly long format of SID encoding"),this.blockLength<=8?this.valueDec=Dc(this.valueHexView,7):(this.isHexOnly=!0,this.warnings.push("Too big SID for decoding, hex only")),t+this.blockLength)}toBER(e){if(this.isHexOnly){if(e)return new ArrayBuffer(this.valueHexView.byteLength);let o=this.valueHexView,i=new Uint8Array(this.blockLength);for(let s=0;s<this.blockLength-1;s++)i[s]=o[s]|128;return i[this.blockLength-1]=o[this.blockLength-1],i.buffer}let t=na(this.valueDec,7);if(t.byteLength===0)return this.error="Error during encoding SID value",fi;let n=new Uint8Array(t.byteLength);if(!e){let o=new Uint8Array(t),i=t.byteLength-1;for(let s=0;s<i;s++)n[s]=o[s]|128;n[i]=o[i]}return n.buffer}toString(){let e="";return this.isHexOnly?e=Me.Convert.ToHex(this.valueHexView):e=this.valueDec.toString(),e}toJSON(){return{...super.toJSON(),valueDec:this.valueDec}}};Xh.NAME="relativeSidBlock";var Zg=class extends xr{constructor({value:e=dn,...t}={}){super(t),this.value=[],e&&this.fromString(e)}fromBER(e,t,n){let o=t;for(;n>0;){let i=new Xh;if(o=i.fromBER(e,o,n),o===-1)return this.blockLength=0,this.error=i.error,o;this.blockLength+=i.blockLength,n-=i.blockLength,this.value.push(i)}return o}toBER(e,t){let n=[];for(let o=0;o<this.value.length;o++){let i=this.value[o].toBER(e);if(i.byteLength===0)return this.error=this.value[o].error,fi;n.push(i)}return v7(n)}fromString(e){this.value=[];let t=0,n=0,o="";do{n=e.indexOf(".",t),n===-1?o=e.substring(t):o=e.substring(t,n),t=n+1;let i=new Xh;if(i.valueDec=parseInt(o,10),isNaN(i.valueDec))return!0;this.value.push(i)}while(n!==-1);return!0}toString(){let e="",t=!1;for(let n=0;n<this.value.length;n++){t=this.value[n].isHexOnly;let o=this.value[n].toString();n!==0&&(e=`${e}.`),t&&(o=`{${o}}`),e+=o}return e}toJSON(){let e={...super.toJSON(),value:this.toString(),sidArray:[]};for(let t=0;t<this.value.length;t++)e.sidArray.push(this.value[t].toJSON());return e}};Zg.NAME="RelativeObjectIdentifierValueBlock";var qI,Yh=class extends Xt{getValue(){return this.valueBlock.toString()}setValue(e){this.valueBlock.fromString(e)}constructor(e={}){super(e,Zg),this.idBlock.tagClass=1,this.idBlock.tagNumber=13}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()||"empty"}`}toJSON(){return{...super.toJSON(),value:this.getValue()}}};qI=Yh;le.RelativeObjectIdentifier=qI;Yh.NAME="RelativeObjectIdentifier";var WI,vt=class extends Yt{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=16}};WI=vt;le.Sequence=WI;vt.NAME="SEQUENCE";var zI,Jr=class extends Yt{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=17}};zI=Jr;le.Set=zI;Jr.NAME="SET";var Jg=class extends di(xr){constructor({...e}={}){super(e),this.isHexOnly=!0,this.value=dn}toJSON(){return{...super.toJSON(),value:this.value}}};Jg.NAME="StringValueBlock";var ey=class extends Jg{};ey.NAME="SimpleStringValueBlock";var en=class extends qh{constructor({...e}={}){super(e,ey)}fromBuffer(e){this.valueBlock.value=String.fromCharCode.apply(null,Me.BufferSourceConverter.toUint8Array(e))}fromString(e){let t=e.length,n=this.valueBlock.valueHexView=new Uint8Array(t);for(let o=0;o<t;o++)n[o]=e.charCodeAt(o);this.valueBlock.value=e}};en.NAME="SIMPLE STRING";var ty=class extends en{fromBuffer(e){this.valueBlock.valueHexView=Me.BufferSourceConverter.toUint8Array(e);try{this.valueBlock.value=Me.Convert.ToUtf8String(e)}catch(t){this.warnings.push(`Error during "decodeURIComponent": ${t}, using raw string`),this.valueBlock.value=Me.Convert.ToBinary(e)}}fromString(e){this.valueBlock.valueHexView=new Uint8Array(Me.Convert.FromUtf8String(e)),this.valueBlock.value=e}};ty.NAME="Utf8StringValueBlock";var GI,oo=class extends ty{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=12}};GI=oo;le.Utf8String=GI;oo.NAME="UTF8String";var ry=class extends en{fromBuffer(e){this.valueBlock.value=Me.Convert.ToUtf16String(e),this.valueBlock.valueHexView=Me.BufferSourceConverter.toUint8Array(e)}fromString(e){this.valueBlock.value=e,this.valueBlock.valueHexView=new Uint8Array(Me.Convert.FromUtf16String(e))}};ry.NAME="BmpStringValueBlock";var XI,Bc=class extends ry{constructor({...e}={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=30}};XI=Bc;le.BmpString=XI;Bc.NAME="BMPString";var ny=class extends en{fromBuffer(e){let t=ArrayBuffer.isView(e)?e.slice().buffer:e.slice(0),n=new Uint8Array(t);for(let o=0;o<n.length;o+=4)n[o]=n[o+3],n[o+1]=n[o+2],n[o+2]=0,n[o+3]=0;this.valueBlock.value=String.fromCharCode.apply(null,new Uint32Array(t))}fromString(e){let t=e.length,n=this.valueBlock.valueHexView=new Uint8Array(t*4);for(let o=0;o<t;o++){let i=na(e.charCodeAt(o),8),s=new Uint8Array(i);if(s.length>4)continue;let a=4-s.length;for(let c=s.length-1;c>=0;c--)n[o*4+c+a]=s[c]}this.valueBlock.value=e}};ny.NAME="UniversalStringValueBlock";var YI,Mc=class extends ny{constructor({...e}={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=28}};YI=Mc;le.UniversalString=YI;Mc.NAME="UniversalString";var QI,Uc=class extends en{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=18}};QI=Uc;le.NumericString=QI;Uc.NAME="NumericString";var ZI,Fc=class extends en{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=19}};ZI=Fc;le.PrintableString=ZI;Fc.NAME="PrintableString";var JI,$c=class extends en{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=20}};JI=$c;le.TeletexString=JI;$c.NAME="TeletexString";var eC,jc=class extends en{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=21}};eC=jc;le.VideotexString=eC;jc.NAME="VideotexString";var tC,Kc=class extends en{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=22}};tC=Kc;le.IA5String=tC;Kc.NAME="IA5String";var rC,Vc=class extends en{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=25}};rC=Vc;le.GraphicString=rC;Vc.NAME="GraphicString";var nC,oa=class extends en{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=26}};nC=oa;le.VisibleString=nC;oa.NAME="VisibleString";var oC,Hc=class extends en{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=27}};oC=Hc;le.GeneralString=oC;Hc.NAME="GeneralString";var iC,qc=class extends en{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=29}};iC=qc;le.CharacterString=iC;qc.NAME="CharacterString";var sC,ia=class extends oa{constructor({value:e,valueDate:t,...n}={}){if(super(n),this.year=0,this.month=0,this.day=0,this.hour=0,this.minute=0,this.second=0,e){this.fromString(e),this.valueBlock.valueHexView=new Uint8Array(e.length);for(let o=0;o<e.length;o++)this.valueBlock.valueHexView[o]=e.charCodeAt(o)}t&&(this.fromDate(t),this.valueBlock.valueHexView=new Uint8Array(this.toBuffer())),this.idBlock.tagClass=1,this.idBlock.tagNumber=23}fromBuffer(e){this.fromString(String.fromCharCode.apply(null,Me.BufferSourceConverter.toUint8Array(e)))}toBuffer(){let e=this.toString(),t=new ArrayBuffer(e.length),n=new Uint8Array(t);for(let o=0;o<e.length;o++)n[o]=e.charCodeAt(o);return t}fromDate(e){this.year=e.getUTCFullYear(),this.month=e.getUTCMonth()+1,this.day=e.getUTCDate(),this.hour=e.getUTCHours(),this.minute=e.getUTCMinutes(),this.second=e.getUTCSeconds()}toDate(){return new Date(Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second))}fromString(e){let n=/(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})Z/ig.exec(e);if(n===null){this.error="Wrong input string for conversion";return}let o=parseInt(n[1],10);o>=50?this.year=1900+o:this.year=2e3+o,this.month=parseInt(n[2],10),this.day=parseInt(n[3],10),this.hour=parseInt(n[4],10),this.minute=parseInt(n[5],10),this.second=parseInt(n[6],10)}toString(e="iso"){if(e==="iso"){let t=new Array(7);return t[0]=fn(this.year<2e3?this.year-1900:this.year-2e3,2),t[1]=fn(this.month,2),t[2]=fn(this.day,2),t[3]=fn(this.hour,2),t[4]=fn(this.minute,2),t[5]=fn(this.second,2),t[6]="Z",t.join("")}return super.toString(e)}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.toDate().toISOString()}`}toJSON(){return{...super.toJSON(),year:this.year,month:this.month,day:this.day,hour:this.hour,minute:this.minute,second:this.second}}};sC=ia;le.UTCTime=sC;ia.NAME="UTCTime";var aC,Wc=class extends ia{constructor(e={}){var t;super(e),(t=this.millisecond)!==null&&t!==void 0||(this.millisecond=0),this.idBlock.tagClass=1,this.idBlock.tagNumber=24}fromDate(e){super.fromDate(e),this.millisecond=e.getUTCMilliseconds()}toDate(){let e=Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second,this.millisecond);return new Date(e)}fromString(e){let t=!1,n="",o="",i=0,s,a=0,c=0;if(e[e.length-1]==="Z")n=e.substring(0,e.length-1),t=!0;else{let u=new Number(e[e.length-1]);if(isNaN(u.valueOf()))throw new Error("Wrong input string for conversion");n=e}if(t){if(n.indexOf("+")!==-1)throw new Error("Wrong input string for conversion");if(n.indexOf("-")!==-1)throw new Error("Wrong input string for conversion")}else{let u=1,d=n.indexOf("+"),h="";if(d===-1&&(d=n.indexOf("-"),u=-1),d!==-1){if(h=n.substring(d+1),n=n.substring(0,d),h.length!==2&&h.length!==4)throw new Error("Wrong input string for conversion");let m=parseInt(h.substring(0,2),10);if(isNaN(m.valueOf()))throw new Error("Wrong input string for conversion");if(a=u*m,h.length===4){if(m=parseInt(h.substring(2,4),10),isNaN(m.valueOf()))throw new Error("Wrong input string for conversion");c=u*m}}}let l=n.indexOf(".");if(l===-1&&(l=n.indexOf(",")),l!==-1){let u=new Number(`0${n.substring(l)}`);if(isNaN(u.valueOf()))throw new Error("Wrong input string for conversion");i=u.valueOf(),o=n.substring(0,l)}else o=n;switch(!0){case o.length===8:if(s=/(\d{4})(\d{2})(\d{2})/ig,l!==-1)throw new Error("Wrong input string for conversion");break;case o.length===10:if(s=/(\d{4})(\d{2})(\d{2})(\d{2})/ig,l!==-1){let u=60*i;this.minute=Math.floor(u),u=60*(u-this.minute),this.second=Math.floor(u),u=1e3*(u-this.second),this.millisecond=Math.floor(u)}break;case o.length===12:if(s=/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})/ig,l!==-1){let u=60*i;this.second=Math.floor(u),u=1e3*(u-this.second),this.millisecond=Math.floor(u)}break;case o.length===14:if(s=/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})/ig,l!==-1){let u=1e3*i;this.millisecond=Math.floor(u)}break;default:throw new Error("Wrong input string for conversion")}let f=s.exec(o);if(f===null)throw new Error("Wrong input string for conversion");for(let u=1;u<f.length;u++)switch(u){case 1:this.year=parseInt(f[u],10);break;case 2:this.month=parseInt(f[u],10);break;case 3:this.day=parseInt(f[u],10);break;case 4:this.hour=parseInt(f[u],10)+a;break;case 5:this.minute=parseInt(f[u],10)+c;break;case 6:this.second=parseInt(f[u],10);break;default:throw new Error("Wrong input string for conversion")}if(t===!1){let u=new Date(this.year,this.month,this.day,this.hour,this.minute,this.second,this.millisecond);this.year=u.getUTCFullYear(),this.month=u.getUTCMonth(),this.day=u.getUTCDay(),this.hour=u.getUTCHours(),this.minute=u.getUTCMinutes(),this.second=u.getUTCSeconds(),this.millisecond=u.getUTCMilliseconds()}}toString(e="iso"){if(e==="iso"){let t=[];return t.push(fn(this.year,4)),t.push(fn(this.month,2)),t.push(fn(this.day,2)),t.push(fn(this.hour,2)),t.push(fn(this.minute,2)),t.push(fn(this.second,2)),this.millisecond!==0&&(t.push("."),t.push(fn(this.millisecond,3))),t.push("Z"),t.join("")}return super.toString(e)}toJSON(){return{...super.toJSON(),millisecond:this.millisecond}}};aC=Wc;le.GeneralizedTime=aC;Wc.NAME="GeneralizedTime";var cC,Qh=class extends oo{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=31}};cC=Qh;le.DATE=cC;Qh.NAME="DATE";var lC,Zh=class extends oo{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=32}};lC=Zh;le.TimeOfDay=lC;Zh.NAME="TimeOfDay";var uC,Jh=class extends oo{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=33}};uC=Jh;le.DateTime=uC;Jh.NAME="DateTime";var fC,ep=class extends oo{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=34}};fC=ep;le.Duration=fC;ep.NAME="Duration";var dC,tp=class extends oo{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=14}};dC=tp;le.TIME=dC;tp.NAME="TIME";var ui=class{constructor({name:e=dn,optional:t=!1}={}){this.name=e,this.optional=t}},Yu=class extends ui{constructor({value:e=[],...t}={}){super(t),this.value=e}},zc=class extends ui{constructor({value:e=new ui,local:t=!1,...n}={}){super(n),this.value=e,this.local=t}},b7=class{get data(){return this.dataView.slice().buffer}set data(e){this.dataView=Me.BufferSourceConverter.toUint8Array(e)}constructor({data:e=oy}={}){this.dataView=Me.BufferSourceConverter.toUint8Array(e)}fromBER(e,t,n){let o=t+n;return this.dataView=Me.BufferSourceConverter.toUint8Array(e).subarray(t,o),o}toBER(e){return this.dataView.slice().buffer}};function ss(r,e,t){if(t instanceof Yu){for(let i of t.value)if(ss(r,e,i).verified)return{verified:!0,result:r};{let i={verified:!1,result:{error:"Wrong values for Choice type"}};return t.hasOwnProperty(w7)&&(i.name=t.name),i}}if(t instanceof ui)return t.hasOwnProperty(w7)&&(r[t.name]=e),{verified:!0,result:r};if(!(r instanceof Object))return{verified:!1,result:{error:"Wrong root object"}};if(!(e instanceof Object))return{verified:!1,result:{error:"Wrong ASN.1 data"}};if(!(t instanceof Object))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(!(zK in t))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(!(QK in t.idBlock))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(!(ZK in t.idBlock))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};let n=t.idBlock.toBER(!1);if(n.byteLength===0)return{verified:!1,result:{error:"Error encoding idBlock for ASN.1 schema"}};if(t.idBlock.fromBER(n,0,n.byteLength)===-1)return{verified:!1,result:{error:"Error decoding idBlock for ASN.1 schema"}};if(t.idBlock.hasOwnProperty(GK)===!1)return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(t.idBlock.tagClass!==e.idBlock.tagClass)return{verified:!1,result:r};if(t.idBlock.hasOwnProperty(XK)===!1)return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(t.idBlock.tagNumber!==e.idBlock.tagNumber)return{verified:!1,result:r};if(t.idBlock.hasOwnProperty(YK)===!1)return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(t.idBlock.isConstructed!==e.idBlock.isConstructed)return{verified:!1,result:r};if(!(WK in t.idBlock))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(t.idBlock.isHexOnly!==e.idBlock.isHexOnly)return{verified:!1,result:r};if(t.idBlock.isHexOnly){if(!(OI in t.idBlock))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};let i=t.idBlock.valueHexView,s=e.idBlock.valueHexView;if(i.length!==s.length)return{verified:!1,result:r};for(let a=0;a<i.length;a++)if(i[a]!==s[1])return{verified:!1,result:r}}if(t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,dn),t.name&&(r[t.name]=e)),t instanceof le.Constructed){let i=0,s={verified:!1,result:{error:"Unknown error"}},a=t.valueBlock.value.length;if(a>0&&t.valueBlock.value[0]instanceof zc&&(a=e.valueBlock.value.length),a===0)return{verified:!0,result:r};if(e.valueBlock.value.length===0&&t.valueBlock.value.length!==0){let c=!0;for(let l=0;l<t.valueBlock.value.length;l++)c=c&&(t.valueBlock.value[l].optional||!1);return c?{verified:!0,result:r}:(t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,dn),t.name&&delete r[t.name]),r.error="Inconsistent object length",{verified:!1,result:r})}for(let c=0;c<a;c++)if(c-i>=e.valueBlock.value.length){if(t.valueBlock.value[c].optional===!1){let l={verified:!1,result:r};return r.error="Inconsistent length between ASN.1 data and schema",t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,dn),t.name&&(delete r[t.name],l.name=t.name)),l}}else if(t.valueBlock.value[0]instanceof zc){if(s=ss(r,e.valueBlock.value[c],t.valueBlock.value[0].value),s.verified===!1)if(t.valueBlock.value[0].optional)i++;else return t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,dn),t.name&&delete r[t.name]),s;if(w7 in t.valueBlock.value[0]&&t.valueBlock.value[0].name.length>0){let l={};JK in t.valueBlock.value[0]&&t.valueBlock.value[0].local?l=e:l=r,typeof l[t.valueBlock.value[0].name]>"u"&&(l[t.valueBlock.value[0].name]=[]),l[t.valueBlock.value[0].name].push(e.valueBlock.value[c])}}else if(s=ss(r,e.valueBlock.value[c-i],t.valueBlock.value[c]),s.verified===!1)if(t.valueBlock.value[c].optional)i++;else return t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,dn),t.name&&delete r[t.name]),s;if(s.verified===!1){let c={verified:!1,result:r};return t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,dn),t.name&&(delete r[t.name],c.name=t.name)),c}return{verified:!0,result:r}}if(t.primitiveSchema&&OI in e.valueBlock){let i=Qu(e.valueBlock.valueHexView);if(i.offset===-1){let s={verified:!1,result:i.result};return t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,dn),t.name&&(delete r[t.name],s.name=t.name)),s}return ss(r,i.result,t.primitiveSchema)}return{verified:!0,result:r}}function oV(r,e){if(!(e instanceof Object))return{verified:!1,result:{error:"Wrong ASN.1 schema type"}};let t=Qu(Me.BufferSourceConverter.toUint8Array(r));return t.offset===-1?{verified:!1,result:t.result}:ss(t.result,t.result,e)}async function iy(r,e){let n=await zu.create().encrypt(r,e);return Ht.encode(n)}async function E7(r,e,t){if(r.type==="RSA")return cV(r,e,t);if(r.type==="Ed25519")return iV(r,e,t);if(r.type==="secp256k1")return sV(r,e,t);if(r.type==="ECDSA")return aV(r,e,t);throw new wo}async function iV(r,e,t="libp2p-key"){if(t==="libp2p-key")return iy(fc(r),e);throw new P(`export format '${t}' is not supported`)}async function sV(r,e,t="libp2p-key"){if(t==="libp2p-key")return iy(fc(r),e);throw new P("Export format is not supported")}async function aV(r,e,t="libp2p-key"){if(t==="libp2p-key")return iy(fc(r),e);throw new P(`export format '${t}' is not supported`)}async function cV(r,e,t="pkcs-8"){if(t==="pkcs-8")return lV(r,e);if(t==="libp2p-key")return iy(fc(r),e);throw new P("Export format is not supported")}async function lV(r,e){let t=qt.get(),o=new vt({value:[new Un({value:0}),new vt({value:[new Fn({value:"1.2.840.113549.1.1.1"}),new hn]}),new Kr({valueHex:r.raw})]}).toBER(),i=new Uint8Array(o,0,o.byteLength),s=Xr(16),a=await $m(Bs,e,s,{c:1e4,dkLen:32}),c=Xr(16),l=await t.subtle.importKey("raw",a,"AES-CBC",!1,["encrypt"]),f=await t.subtle.encrypt({name:"AES-CBC",iv:c},l,i),u=new vt({value:[new Kr({valueHex:s}),new Un({value:1e4}),new Un({value:32}),new vt({value:[new Fn({value:"1.2.840.113549.2.11"}),new hn]})]}),d=new vt({value:[new Fn({value:"1.2.840.113549.1.5.13"}),new vt({value:[new vt({value:[new Fn({value:"1.2.840.113549.1.5.12"}),u]}),new vt({value:[new Fn({value:"2.16.840.1.101.3.4.1.42"}),new Kr({valueHex:c})]})]})]}),m=new vt({value:[d,new Kr({valueHex:f})]}).toBER(),w=new Uint8Array(m,0,m.byteLength);return["-----BEGIN ENCRYPTED PRIVATE KEY-----",...j(w,"base64pad").split(/(.{64})/).filter(Boolean),"-----END ENCRYPTED PRIVATE KEY-----"].join(`
`)}async function S7(r,e){try{let t=await uV(r,e);return gS(t)}catch{}if(!r.includes("BEGIN"))throw new P("Encrypted key was not a libp2p-key or a PEM file");return fV(r,e)}async function uV(r,e){let t=Ht.decode(r);return zu.create().decrypt(t,e)}async function fV(r,e){let t=qt.get(),n;if(r.includes("-----BEGIN ENCRYPTED PRIVATE KEY-----")){let i=B(r.replace("-----BEGIN ENCRYPTED PRIVATE KEY-----","").replace("-----END ENCRYPTED PRIVATE KEY-----","").replace(/\n/g,"").trim(),"base64pad"),{result:s}=$n(i),{iv:a,salt:c,iterations:l,keySize:f,cipherText:u}=dV(s),d=await $m(Bs,e,c,{c:l,dkLen:f}),h=await t.subtle.importKey("raw",d,"AES-CBC",!1,["decrypt"]),m=rp(await t.subtle.decrypt({name:"AES-CBC",iv:a},h,u)),{result:w}=$n(m);n=mC(w)}else if(r.includes("-----BEGIN PRIVATE KEY-----")){let i=B(r.replace("-----BEGIN PRIVATE KEY-----","").replace("-----END PRIVATE KEY-----","").replace(/\n/g,"").trim(),"base64pad"),{result:s}=$n(i);n=mC(s)}else throw new P("Could not parse private key from PEM data");let o=yS(n);if(o.type!=="RSA")throw new P("Could not parse RSA private key from PEM data");return o}function dV(r){let e=r.valueBlock.value[0];if(e.valueBlock.value[0].toString()!=="OBJECT IDENTIFIER : 1.2.840.113549.1.5.13")throw new P("Only pkcs5PBES2 encrypted private keys are supported");let n=e.valueBlock.value[1].valueBlock.value[0];if(n.valueBlock.value[0].toString()!=="OBJECT IDENTIFIER : 1.2.840.113549.1.5.12")throw new P("Only pkcs5PBKDF2 key derivation functions are supported");let i=n.valueBlock.value[1],s=rp(i.valueBlock.value[0].getValue()),a=1e4,c=32;if(i.valueBlock.value.length===3)a=Number(i.valueBlock.value[1].toBigInt()),c=Number(i.valueBlock.value[2].toBigInt());else if(i.valueBlock.value.length===2)throw new P("Could not derive key size and iterations from PEM file - please use @libp2p/rsa to re-import your key");let l=e.valueBlock.value[1].valueBlock.value[1],f=l.valueBlock.value[0].toString();if(f!=="OBJECT IDENTIFIER : 1.2.840.113549.3.7"){if(f!=="OBJECT IDENTIFIER : 1.3.14.3.2.7"){if(f!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.2"){if(f!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.22"){if(f!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.42")throw new P("Only AES-CBC encryption schemes are supported")}}}}let u=rp(l.valueBlock.value[1].getValue());return{cipherText:rp(r.valueBlock.value[1].getValue()),salt:s,iterations:a,keySize:c,iv:u}}function mC(r){return rp(r.valueBlock.value[2].getValue())}function rp(r){return new Uint8Array(r,0,r.byteLength)}var hV="/pkcs8/",_7="/info/",np=new WeakMap,Gc={minKeyLength:112/8,minSaltLength:128/8,minIterationCount:1e3};function Zu(r){return r==null||typeof r!="string"?!1:r===(0,gC.default)(r.trim())&&r.length>0}async function Er(){let t=Math.random()*800+200;await new Promise(n=>setTimeout(n,t))}function Xc(r){return new ht(hV+r)}function Ju(r){return new ht(_7+r)}async function pV(r){let e=fc(r),t=await St.digest(e);return ft.encode(t.bytes).substring(1)}var sy=class{components;init;log;self;constructor(e,t){if(this.components=e,this.log=e.logger.forComponent("libp2p:keychain"),this.init={...t,dek:{...m7,...t.dek}},this.self=t.selfKey??"self",this.init.pass!=null&&this.init.pass?.length<20)throw new Error("pass must be least 20 characters");if(this.init.dek?.keyLength!=null&&this.init.dek.keyLength<Gc.minKeyLength)throw new Error(`dek.keyLength must be least ${Gc.minKeyLength} bytes`);if(this.init.dek?.salt?.length!=null&&this.init.dek.salt.length<Gc.minSaltLength)throw new Error(`dek.saltLength must be least ${Gc.minSaltLength} bytes`);if(this.init.dek?.iterationCount!=null&&this.init.dek.iterationCount<Gc.minIterationCount)throw new Error(`dek.iterationCount must be least ${Gc.minIterationCount}`);let n=this.init.pass!=null&&this.init.dek?.salt!=null?Kd(this.init.pass,this.init.dek?.salt,this.init.dek?.iterationCount,this.init.dek?.keyLength,this.init.dek?.hash):"";np.set(this,{dek:n})}[Symbol.toStringTag]="@libp2p/keychain";[qe]=["@libp2p/keychain"];static generateOptions(){let e=Object.assign({},this.options),t=Math.ceil(Gc.minSaltLength/3)*3;return e.dek!=null&&(e.dek.salt=j(Xr(t),"base64")),e}static get options(){return{dek:{...m7}}}async findKeyByName(e){if(!Zu(e))throw await Er(),new P(`Invalid key name '${e}'`);let t=Ju(e);try{let n=await this.components.datastore.get(t);return JSON.parse(j(n))}catch(n){throw await Er(),this.log.error("could not read key from datastore - %e",n),new Xe(`Key '${e}' does not exist.`)}}async findKeyById(e){try{let t={prefix:_7};for await(let n of this.components.datastore.query(t)){let o=JSON.parse(j(n.value));if(o.id===e)return o}throw new P(`Key with id '${e}' does not exist.`)}catch(t){throw await Er(),t}}async importKey(e,t){if(!Zu(e))throw await Er(),new P(`Invalid key name '${e}'`);if(t==null)throw await Er(),new P("Key is required");let n=Xc(e);if(await this.components.datastore.has(n))throw await Er(),new P(`Key '${e}' already exists`);let i,s;try{i=await pV(t);let l=np.get(this);if(l==null)throw new P("dek missing");let f=l.dek;s=await E7(t,f,t.type==="RSA"?"pkcs-8":"libp2p-key")}catch(l){throw await Er(),l}let a={name:e,id:i},c=this.components.datastore.batch();return c.put(n,B(s)),c.put(Ju(e),B(JSON.stringify(a))),await c.commit(),a}async exportKey(e){if(!Zu(e))throw await Er(),new P(`Invalid key name '${e}'`);let t=Xc(e);try{let n=await this.components.datastore.get(t),o=j(n),i=np.get(this);if(i==null)throw new P("dek missing");let s=i.dek;return await S7(o,s)}catch(n){throw await Er(),n}}async removeKey(e){if(!Zu(e)||e===this.self)throw await Er(),new P(`Invalid key name '${e}'`);let t=Xc(e),n=await this.findKeyByName(e),o=this.components.datastore.batch();return o.delete(t),o.delete(Ju(e)),await o.commit(),n}async listKeys(){let e={prefix:_7},t=[];for await(let n of this.components.datastore.query(e))t.push(JSON.parse(j(n.value)));return t}async renameKey(e,t){if(!Zu(e)||e===this.self)throw await Er(),new P(`Invalid old key name '${e}'`);if(!Zu(t)||t===this.self)throw await Er(),new P(`Invalid new key name '${t}'`);let n=Xc(e),o=Xc(t),i=Ju(e),s=Ju(t);if(await this.components.datastore.has(o))throw await Er(),new P(`Key '${t}' already exists`);try{let c=await this.components.datastore.get(n),l=await this.components.datastore.get(i),f=JSON.parse(j(l));f.name=t;let u=this.components.datastore.batch();return u.put(o,c),u.put(s,B(JSON.stringify(f))),u.delete(n),u.delete(i),await u.commit(),f}catch(c){throw await Er(),c}}async rotateKeychainPass(e,t){if(typeof e!="string")throw await Er(),new P(`Invalid old pass type '${typeof e}'`);if(typeof t!="string")throw await Er(),new P(`Invalid new pass type '${typeof t}'`);if(t.length<20)throw await Er(),new P(`Invalid pass length ${t.length}`);this.log("recreating keychain");let n=np.get(this);if(n==null)throw new P("dek missing");let o=n.dek;this.init.pass=t;let i=t!=null&&this.init.dek?.salt!=null?Kd(t,this.init.dek.salt,this.init.dek?.iterationCount,this.init.dek?.keyLength,this.init.dek?.hash):"";np.set(this,{dek:i});let s=await this.listKeys();for(let a of s){let c=await this.components.datastore.get(Xc(a.name)),l=j(c),f=await S7(l,o),u=i.toString(),d=await E7(f,u,f.type==="RSA"?"pkcs-8":"libp2p-key"),h=this.components.datastore.batch(),m={name:a.name,id:a.id};h.put(Xc(a.name),B(d)),h.put(Ju(a.name),B(JSON.stringify(m))),await h.commit()}this.log("keychain reconstructed")}};function ay(r={}){return e=>new sy(e,r)}async function A7(r,e={}){let t=e.selfKey??"self",n=ay(e)({datastore:r,logger:Qo()}),o;return await r.has(new ht(`/pkcs8/${t}`))?o=await n.exportKey(t):(o=await uu(e.keyType??"Ed25519"),await n.importKey(t,o)),o}var ef=!!globalThis.process?.env?.DUMP_SESSION_KEYS,T7=16;function mV(r){return r instanceof Uint8Array||ArrayBuffer.isView(r)&&r.constructor.name==="Uint8Array"}function cy(r){if(typeof r!="boolean")throw new Error(`boolean expected, not ${r}`)}function ly(r){if(!Number.isSafeInteger(r)||r<0)throw new Error("positive integer expected, got "+r)}function dr(r,e,t=""){let n=mV(r),o=r?.length,i=e!==void 0;if(!n||i&&o!==e){let s=t&&`"${t}" `,a=i?` of length ${e}`:"",c=n?`length=${o}`:`type=${typeof r}`;throw new Error(s+"expected Uint8Array"+a+", got "+c)}return r}function I7(r,e=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(e&&r.finished)throw new Error("Hash#digest() has already been called")}function yC(r,e){dr(r,void 0,"output");let t=e.outputLen;if(r.length<t)throw new Error("digestInto() expects output buffer of length at least "+t)}function us(r){return new Uint32Array(r.buffer,r.byteOffset,Math.floor(r.byteLength/4))}function fs(...r){for(let e=0;e<r.length;e++)r[e].fill(0)}function gV(r){return new DataView(r.buffer,r.byteOffset,r.byteLength)}var yV=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;function wC(r,e){if(e==null||typeof e!="object")throw new Error("options must be defined");return Object.assign(r,e)}function bC(r,e){if(r.length!==e.length)return!1;let t=0;for(let n=0;n<r.length;n++)t|=r[n]^e[n];return t===0}var C7=(r,e)=>{function t(n,...o){if(dr(n,void 0,"key"),!yV)throw new Error("Non little-endian hardware is not yet supported");if(r.nonceLength!==void 0){let f=o[0];dr(f,r.varSizeNonce?void 0:r.nonceLength,"nonce")}let i=r.tagLength;i&&o[1]!==void 0&&dr(o[1],void 0,"AAD");let s=e(n,...o),a=(f,u)=>{if(u!==void 0){if(f!==2)throw new Error("cipher output not supported");dr(u,void 0,"output")}},c=!1;return{encrypt(f,u){if(c)throw new Error("cannot encrypt() twice with same key + nonce");return c=!0,dr(f),a(s.encrypt.length,u),s.encrypt(f,u)},decrypt(f,u){if(dr(f),i&&f.length<i)throw new Error('"ciphertext" expected length bigger than tagLength='+i);return a(s.decrypt.length,u),s.decrypt(f,u)}}}return Object.assign(t,r),t};function P7(r,e,t=!0){if(e===void 0)return new Uint8Array(r);if(e.length!==r)throw new Error('"output" expected Uint8Array of length '+r+", got: "+e.length);if(t&&!wV(e))throw new Error("invalid output, must be aligned");return e}function vC(r,e,t){cy(t);let n=new Uint8Array(16),o=gV(n);return o.setBigUint64(0,BigInt(e),t),o.setBigUint64(8,BigInt(r),t),n}function wV(r){return r.byteOffset%4===0}function tf(r){return Uint8Array.from(r)}var EC=r=>Uint8Array.from(r.split(""),e=>e.charCodeAt(0)),bV=EC("expand 16-byte k"),vV=EC("expand 32-byte k"),xV=us(bV),EV=us(vV);function pe(r,e){return r<<e|r>>>32-e}function k7(r){return r.byteOffset%4===0}var uy=64,SV=16,SC=2**32-1,xC=Uint32Array.of();function _V(r,e,t,n,o,i,s,a){let c=o.length,l=new Uint8Array(uy),f=us(l),u=k7(o)&&k7(i),d=u?us(o):xC,h=u?us(i):xC;for(let m=0;m<c;s++){if(r(e,t,n,f,s,a),s>=SC)throw new Error("arx: counter overflow");let w=Math.min(uy,c-m);if(u&&w===uy){let y=m/4;if(m%4!==0)throw new Error("arx: invalid block position");for(let b=0,N;b<SV;b++)N=y+b,h[N]=d[N]^f[b];m+=uy;continue}for(let y=0,b;y<w;y++)b=m+y,i[b]=o[b]^l[y];m+=w}}function O7(r,e){let{allowShortKeys:t,extendNonceFn:n,counterLength:o,counterRight:i,rounds:s}=wC({allowShortKeys:!1,counterLength:8,counterRight:!1,rounds:20},e);if(typeof r!="function")throw new Error("core must be a function");return ly(o),ly(s),cy(i),cy(t),(a,c,l,f,u=0)=>{dr(a,void 0,"key"),dr(c,void 0,"nonce"),dr(l,void 0,"data");let d=l.length;if(f===void 0&&(f=new Uint8Array(d)),dr(f,void 0,"output"),ly(u),u<0||u>=SC)throw new Error("arx: counter overflow");if(f.length<d)throw new Error(`arx: output (${f.length}) is shorter than data (${d})`);let h=[],m=a.length,w,y;if(m===32)h.push(w=tf(a)),y=EV;else if(m===16&&t)w=new Uint8Array(32),w.set(a),w.set(a,16),y=xV,h.push(w);else throw dr(a,32,"arx key"),new Error("invalid key size");k7(c)||h.push(c=tf(c));let b=us(w);if(n){if(c.length!==24)throw new Error("arx: extended nonce must be 24 bytes");n(y,b,us(c.subarray(0,16)),b),c=c.subarray(16)}let N=16-o;if(N!==c.length)throw new Error(`arx: nonce must be ${N} or 16 bytes`);if(N!==12){let V=new Uint8Array(12);V.set(c,i?0:12-c.length),c=V,h.push(c)}let O=us(c);return _V(r,y,b,O,l,f,u,s),fs(...h),f}}function Sr(r,e){return r[e++]&255|(r[e++]&255)<<8}var R7=class{blockLen=16;outputLen=16;buffer=new Uint8Array(16);r=new Uint16Array(10);h=new Uint16Array(10);pad=new Uint16Array(8);pos=0;finished=!1;constructor(e){e=tf(dr(e,32,"key"));let t=Sr(e,0),n=Sr(e,2),o=Sr(e,4),i=Sr(e,6),s=Sr(e,8),a=Sr(e,10),c=Sr(e,12),l=Sr(e,14);this.r[0]=t&8191,this.r[1]=(t>>>13|n<<3)&8191,this.r[2]=(n>>>10|o<<6)&7939,this.r[3]=(o>>>7|i<<9)&8191,this.r[4]=(i>>>4|s<<12)&255,this.r[5]=s>>>1&8190,this.r[6]=(s>>>14|a<<2)&8191,this.r[7]=(a>>>11|c<<5)&8065,this.r[8]=(c>>>8|l<<8)&8191,this.r[9]=l>>>5&127;for(let f=0;f<8;f++)this.pad[f]=Sr(e,16+2*f)}process(e,t,n=!1){let o=n?0:2048,{h:i,r:s}=this,a=s[0],c=s[1],l=s[2],f=s[3],u=s[4],d=s[5],h=s[6],m=s[7],w=s[8],y=s[9],b=Sr(e,t+0),N=Sr(e,t+2),O=Sr(e,t+4),V=Sr(e,t+6),Q=Sr(e,t+8),Z=Sr(e,t+10),se=Sr(e,t+12),C=Sr(e,t+14),T=i[0]+(b&8191),K=i[1]+((b>>>13|N<<3)&8191),z=i[2]+((N>>>10|O<<6)&8191),U=i[3]+((O>>>7|V<<9)&8191),I=i[4]+((V>>>4|Q<<12)&8191),S=i[5]+(Q>>>1&8191),x=i[6]+((Q>>>14|Z<<2)&8191),D=i[7]+((Z>>>11|se<<5)&8191),q=i[8]+((se>>>8|C<<8)&8191),H=i[9]+(C>>>5|o),M=0,G=M+T*a+K*(5*y)+z*(5*w)+U*(5*m)+I*(5*h);M=G>>>13,G&=8191,G+=S*(5*d)+x*(5*u)+D*(5*f)+q*(5*l)+H*(5*c),M+=G>>>13,G&=8191;let te=M+T*c+K*a+z*(5*y)+U*(5*w)+I*(5*m);M=te>>>13,te&=8191,te+=S*(5*h)+x*(5*d)+D*(5*u)+q*(5*f)+H*(5*l),M+=te>>>13,te&=8191;let F=M+T*l+K*c+z*a+U*(5*y)+I*(5*w);M=F>>>13,F&=8191,F+=S*(5*m)+x*(5*h)+D*(5*d)+q*(5*u)+H*(5*f),M+=F>>>13,F&=8191;let Le=M+T*f+K*l+z*c+U*a+I*(5*y);M=Le>>>13,Le&=8191,Le+=S*(5*w)+x*(5*m)+D*(5*h)+q*(5*d)+H*(5*u),M+=Le>>>13,Le&=8191;let Fe=M+T*u+K*f+z*l+U*c+I*a;M=Fe>>>13,Fe&=8191,Fe+=S*(5*y)+x*(5*w)+D*(5*m)+q*(5*h)+H*(5*d),M+=Fe>>>13,Fe&=8191;let me=M+T*d+K*u+z*f+U*l+I*c;M=me>>>13,me&=8191,me+=S*a+x*(5*y)+D*(5*w)+q*(5*m)+H*(5*h),M+=me>>>13,me&=8191;let He=M+T*h+K*d+z*u+U*f+I*l;M=He>>>13,He&=8191,He+=S*c+x*a+D*(5*y)+q*(5*w)+H*(5*m),M+=He>>>13,He&=8191;let ot=M+T*m+K*h+z*d+U*u+I*f;M=ot>>>13,ot&=8191,ot+=S*l+x*c+D*a+q*(5*y)+H*(5*w),M+=ot>>>13,ot&=8191;let Ct=M+T*w+K*m+z*h+U*d+I*u;M=Ct>>>13,Ct&=8191,Ct+=S*f+x*l+D*c+q*a+H*(5*y),M+=Ct>>>13,Ct&=8191;let ze=M+T*y+K*w+z*m+U*h+I*d;M=ze>>>13,ze&=8191,ze+=S*u+x*f+D*l+q*c+H*a,M+=ze>>>13,ze&=8191,M=(M<<2)+M|0,M=M+G|0,G=M&8191,M=M>>>13,te+=M,i[0]=G,i[1]=te,i[2]=F,i[3]=Le,i[4]=Fe,i[5]=me,i[6]=He,i[7]=ot,i[8]=Ct,i[9]=ze}finalize(){let{h:e,pad:t}=this,n=new Uint16Array(10),o=e[1]>>>13;e[1]&=8191;for(let a=2;a<10;a++)e[a]+=o,o=e[a]>>>13,e[a]&=8191;e[0]+=o*5,o=e[0]>>>13,e[0]&=8191,e[1]+=o,o=e[1]>>>13,e[1]&=8191,e[2]+=o,n[0]=e[0]+5,o=n[0]>>>13,n[0]&=8191;for(let a=1;a<10;a++)n[a]=e[a]+o,o=n[a]>>>13,n[a]&=8191;n[9]-=8192;let i=(o^1)-1;for(let a=0;a<10;a++)n[a]&=i;i=~i;for(let a=0;a<10;a++)e[a]=e[a]&i|n[a];e[0]=(e[0]|e[1]<<13)&65535,e[1]=(e[1]>>>3|e[2]<<10)&65535,e[2]=(e[2]>>>6|e[3]<<7)&65535,e[3]=(e[3]>>>9|e[4]<<4)&65535,e[4]=(e[4]>>>12|e[5]<<1|e[6]<<14)&65535,e[5]=(e[6]>>>2|e[7]<<11)&65535,e[6]=(e[7]>>>5|e[8]<<8)&65535,e[7]=(e[8]>>>8|e[9]<<5)&65535;let s=e[0]+t[0];e[0]=s&65535;for(let a=1;a<8;a++)s=(e[a]+t[a]|0)+(s>>>16)|0,e[a]=s&65535;fs(n)}update(e){I7(this),dr(e),e=tf(e);let{buffer:t,blockLen:n}=this,o=e.length;for(let i=0;i<o;){let s=Math.min(n-this.pos,o-i);if(s===n){for(;n<=o-i;i+=n)this.process(e,i);continue}t.set(e.subarray(i,i+s),this.pos),this.pos+=s,i+=s,this.pos===n&&(this.process(t,0,!1),this.pos=0)}return this}destroy(){fs(this.h,this.r,this.buffer,this.pad)}digestInto(e){I7(this),yC(e,this),this.finished=!0;let{buffer:t,h:n}=this,{pos:o}=this;if(o){for(t[o++]=1;o<16;o++)t[o]=0;this.process(t,0,!0)}this.finalize();let i=0;for(let s=0;s<8;s++)e[i++]=n[s]>>>0,e[i++]=n[s]>>>8;return e}digest(){let{buffer:e,outputLen:t}=this;this.digestInto(e);let n=e.slice(0,t);return this.destroy(),n}};function AV(r){let e=(n,o)=>r(o).update(n).digest(),t=r(new Uint8Array(32));return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=n=>r(n),e}var _C=AV(r=>new R7(r));function IC(r,e,t,n,o,i=20){let s=r[0],a=r[1],c=r[2],l=r[3],f=e[0],u=e[1],d=e[2],h=e[3],m=e[4],w=e[5],y=e[6],b=e[7],N=o,O=t[0],V=t[1],Q=t[2],Z=s,se=a,C=c,T=l,K=f,z=u,U=d,I=h,S=m,x=w,D=y,q=b,H=N,M=O,G=V,te=Q;for(let Le=0;Le<i;Le+=2)Z=Z+K|0,H=pe(H^Z,16),S=S+H|0,K=pe(K^S,12),Z=Z+K|0,H=pe(H^Z,8),S=S+H|0,K=pe(K^S,7),se=se+z|0,M=pe(M^se,16),x=x+M|0,z=pe(z^x,12),se=se+z|0,M=pe(M^se,8),x=x+M|0,z=pe(z^x,7),C=C+U|0,G=pe(G^C,16),D=D+G|0,U=pe(U^D,12),C=C+U|0,G=pe(G^C,8),D=D+G|0,U=pe(U^D,7),T=T+I|0,te=pe(te^T,16),q=q+te|0,I=pe(I^q,12),T=T+I|0,te=pe(te^T,8),q=q+te|0,I=pe(I^q,7),Z=Z+z|0,te=pe(te^Z,16),D=D+te|0,z=pe(z^D,12),Z=Z+z|0,te=pe(te^Z,8),D=D+te|0,z=pe(z^D,7),se=se+U|0,H=pe(H^se,16),q=q+H|0,U=pe(U^q,12),se=se+U|0,H=pe(H^se,8),q=q+H|0,U=pe(U^q,7),C=C+I|0,M=pe(M^C,16),S=S+M|0,I=pe(I^S,12),C=C+I|0,M=pe(M^C,8),S=S+M|0,I=pe(I^S,7),T=T+K|0,G=pe(G^T,16),x=x+G|0,K=pe(K^x,12),T=T+K|0,G=pe(G^T,8),x=x+G|0,K=pe(K^x,7);let F=0;n[F++]=s+Z|0,n[F++]=a+se|0,n[F++]=c+C|0,n[F++]=l+T|0,n[F++]=f+K|0,n[F++]=u+z|0,n[F++]=d+U|0,n[F++]=h+I|0,n[F++]=m+S|0,n[F++]=w+x|0,n[F++]=y+D|0,n[F++]=b+q|0,n[F++]=N+H|0,n[F++]=O+M|0,n[F++]=V+G|0,n[F++]=Q+te|0}function TV(r,e,t,n){let o=r[0],i=r[1],s=r[2],a=r[3],c=e[0],l=e[1],f=e[2],u=e[3],d=e[4],h=e[5],m=e[6],w=e[7],y=t[0],b=t[1],N=t[2],O=t[3];for(let Q=0;Q<20;Q+=2)o=o+c|0,y=pe(y^o,16),d=d+y|0,c=pe(c^d,12),o=o+c|0,y=pe(y^o,8),d=d+y|0,c=pe(c^d,7),i=i+l|0,b=pe(b^i,16),h=h+b|0,l=pe(l^h,12),i=i+l|0,b=pe(b^i,8),h=h+b|0,l=pe(l^h,7),s=s+f|0,N=pe(N^s,16),m=m+N|0,f=pe(f^m,12),s=s+f|0,N=pe(N^s,8),m=m+N|0,f=pe(f^m,7),a=a+u|0,O=pe(O^a,16),w=w+O|0,u=pe(u^w,12),a=a+u|0,O=pe(O^a,8),w=w+O|0,u=pe(u^w,7),o=o+l|0,O=pe(O^o,16),m=m+O|0,l=pe(l^m,12),o=o+l|0,O=pe(O^o,8),m=m+O|0,l=pe(l^m,7),i=i+f|0,y=pe(y^i,16),w=w+y|0,f=pe(f^w,12),i=i+f|0,y=pe(y^i,8),w=w+y|0,f=pe(f^w,7),s=s+u|0,b=pe(b^s,16),d=d+b|0,u=pe(u^d,12),s=s+u|0,b=pe(b^s,8),d=d+b|0,u=pe(u^d,7),a=a+c|0,N=pe(N^a,16),h=h+N|0,c=pe(c^h,12),a=a+c|0,N=pe(N^a,8),h=h+N|0,c=pe(c^h,7);let V=0;n[V++]=o,n[V++]=i,n[V++]=s,n[V++]=a,n[V++]=y,n[V++]=b,n[V++]=N,n[V++]=O}var IV=O7(IC,{counterRight:!1,counterLength:4,allowShortKeys:!1}),CV=O7(IC,{counterRight:!1,counterLength:8,extendNonceFn:TV,allowShortKeys:!1});var PV=new Uint8Array(16),AC=(r,e)=>{r.update(e);let t=e.length%16;t&&r.update(PV.subarray(t))},kV=new Uint8Array(32);function TC(r,e,t,n,o){o!==void 0&&dr(o,void 0,"AAD");let i=r(e,t,kV),s=vC(n.length,o?o.length:0,!0),a=_C.create(i);o&&AC(a,o),AC(a,n),a.update(s);let c=a.digest();return fs(i,s),c}var CC=r=>(e,t,n)=>({encrypt(i,s){let a=i.length;s=P7(a+16,s,!1),s.set(i);let c=s.subarray(0,-16);r(e,t,c,c,1);let l=TC(r,e,t,c,n);return s.set(l,a),fs(l),s},decrypt(i,s){s=P7(i.length-16,s,!1);let a=i.subarray(0,-16),c=i.subarray(-16),l=TC(r,e,t,a,n);if(!bC(c,l))throw new Error("invalid tag");return s.set(i.subarray(0,-16)),r(e,t,s,s,1),fs(l),s}}),D7=C7({blockSize:64,nonceLength:12,tagLength:16},CC(IV)),sge=C7({blockSize:64,nonceLength:24,tagLength:16},CC(CV));function kC(r,e,t){return Ni(r),t===void 0&&(t=new Uint8Array(r.outputLen)),$s(r,t,e)}var N7=Uint8Array.of(0),PC=Uint8Array.of();function OC(r,e,t,n=32){Ni(r),Nr(n,"length");let o=r.outputLen;if(n>255*o)throw new Error("Length must be <= 255*HashLen");let i=Math.ceil(n/o);t===void 0?t=PC:Oe(t,void 0,"info");let s=new Uint8Array(i*o),a=$s.create(r,e),c=a._cloneInto(),l=new Uint8Array(a.outputLen);for(let f=0;f<i;f++)N7[0]=f+1,c.update(f===0?PC:l).update(t).update(N7).digestInto(l),s.set(l,o*f),a._cloneInto(c);return a.destroy(),c.destroy(),Lr(l,N7),s.slice(0,n)}var L7={hashSHA256(r){return Yn(r.subarray())},getHKDF(r,e){let t=kC(Yn,e,r),o=OC(Yn,t,void 0,96),i=o.subarray(0,32),s=o.subarray(32,64),a=o.subarray(64,96);return[i,s,a]},generateX25519KeyPair(){let r=Od.utils.randomSecretKey();return{publicKey:Od.getPublicKey(r),privateKey:r}},generateX25519KeyPairFromSeed(r){return{publicKey:Od.getPublicKey(r),privateKey:r}},generateX25519SharedKey(r,e){return Od.getSharedSecret(r.subarray(),e.subarray())},chaCha20Poly1305Encrypt(r,e,t,n){return D7(n,e,t).encrypt(r.subarray())},chaCha20Poly1305Decrypt(r,e,t,n,o){return D7(n,e,t).decrypt(r.subarray(),o)}};var RC=L7;function DC(r){return{generateKeypair:r.generateX25519KeyPair,dh:(e,t)=>r.generateX25519SharedKey(e.privateKey,t).subarray(0,32),encrypt:r.chaCha20Poly1305Encrypt,decrypt:r.chaCha20Poly1305Decrypt,hash:r.hashSHA256,hkdf:r.getHKDF}}var rf=r=>{let e=Ot(2);return e[0]=r>>8,e[1]=r,e};rf.bytes=2;var nf=r=>{if(r.length<2)throw RangeError("Could not decode int16BE");if(r instanceof Uint8Array){let e=0;return e+=r[0]<<8,e+=r[1],e}return r.getUint16(0)};nf.bytes=2;function NC(r){return{xxHandshakeSuccesses:r.registerCounter("libp2p_noise_xxhandshake_successes_total",{help:"Total count of noise xxHandshakes successes_"}),xxHandshakeErrors:r.registerCounter("libp2p_noise_xxhandshake_error_total",{help:"Total count of noise xxHandshakes errors"}),encryptedPackets:r.registerCounter("libp2p_noise_encrypted_packets_total",{help:"Total count of noise encrypted packets successfully"}),decryptedPackets:r.registerCounter("libp2p_noise_decrypted_packets_total",{help:"Total count of noise decrypted packets"}),decryptErrors:r.registerCounter("libp2p_noise_decrypt_errors_total",{help:"Total count of noise decrypt errors"})}}function B7(r,e){!e.enabled||!ef||(r?(e(`LOCAL_STATIC_PUBLIC_KEY ${j(r.publicKey,"hex")}`),e(`LOCAL_STATIC_PRIVATE_KEY ${j(r.privateKey,"hex")}`)):e("Missing local static keys."))}function M7(r,e){!e.enabled||!ef||(r?(e(`LOCAL_PUBLIC_EPHEMERAL_KEY ${j(r.publicKey,"hex")}`),e(`LOCAL_PRIVATE_EPHEMERAL_KEY ${j(r.privateKey,"hex")}`)):e("Missing local ephemeral keys."))}function LC(r,e){!e.enabled||!ef||e(r?`REMOTE_STATIC_PUBLIC_KEY ${j(r.subarray(),"hex")}`:"Missing remote static public key.")}function U7(r,e){!e.enabled||!ef||e(r?`REMOTE_EPHEMERAL_PUBLIC_KEY ${j(r.subarray(),"hex")}`:"Missing remote ephemeral keys.")}function F7(r,e,t){!t.enabled||!ef||(t(`CIPHER_STATE_1 ${r.n.getUint64()} ${r.k&&j(r.k,"hex")}`),t(`CIPHER_STATE_2 ${e.n.getUint64()} ${e.k&&j(e.k,"hex")}`))}function Uo(r,e){if(r.length!==e.length)throw new Error("Inputs should have the same length");let t=Ot(r.length);for(let n=0;n<r.length;n++)t[n]=r[n]^e[n];return t}var of=class r extends Error{code;constructor(e="Invalid crypto exchange"){super(e),this.code=r.code}static code="ERR_INVALID_CRYPTO_EXCHANGE"};var OV=0,RV=4294967295,DV="Cipherstate has reached maximum n, a new handshake must be performed",fy=class{n;bytes;view;constructor(e=OV){this.n=e,this.bytes=ke(12),this.view=new DataView(this.bytes.buffer,this.bytes.byteOffset,this.bytes.byteLength),this.view.setUint32(4,e,!0)}increment(){this.n++,this.view.setUint32(4,this.n,!0)}getBytes(){return this.bytes}getUint64(){return this.n}assertValue(){if(this.n>RV)throw new Error(DV)}};var Yc=ke(0),sf=class{k;n;crypto;constructor(e,t=void 0,n=0){this.crypto=e,this.k=t,this.n=new fy(n)}hasKey(){return!!this.k}encryptWithAd(e,t){if(!this.hasKey())return t;this.n.assertValue();let n=this.crypto.encrypt(t,this.n.getBytes(),e,this.k);return this.n.increment(),n}decryptWithAd(e,t,n){if(!this.hasKey())return t;this.n.assertValue();let o=this.crypto.decrypt(t,this.n.getBytes(),e,this.k,n);return this.n.increment(),o}},$7=class{cs;ck;h;crypto;constructor(e,t){this.crypto=e;let n=B(t,"utf-8");this.h=NV(e,n),this.ck=this.h,this.cs=new sf(e)}mixKey(e){let[t,n]=this.crypto.hkdf(this.ck,e);this.ck=t,this.cs=new sf(this.crypto,n)}mixHash(e){this.h=this.crypto.hash(new fe(this.h,e))}encryptAndHash(e){let t=this.cs.encryptWithAd(this.h,e);return this.mixHash(t),t}decryptAndHash(e){let t=this.cs.decryptWithAd(this.h,e);return this.mixHash(e),t}split(){let[e,t]=this.crypto.hkdf(this.ck,Yc);return[new sf(this.crypto,e),new sf(this.crypto,t)]}},j7=class{ss;s;e;rs;re;initiator;crypto;constructor(e){let{crypto:t,protocolName:n,prologue:o,initiator:i,s,e:a,rs:c,re:l}=e;this.crypto=t,this.ss=new $7(t,n),this.ss.mixHash(o),this.initiator=i,this.s=s,this.e=a,this.rs=c,this.re=l}writeE(){if(this.e)throw new Error("ephemeral keypair is already set");let e=this.crypto.generateKeypair();return this.ss.mixHash(e.publicKey),this.e=e,e.publicKey}writeS(){if(!this.s)throw new Error("static keypair is not set");return this.ss.encryptAndHash(this.s.publicKey)}writeEE(){if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.re))}writeES(){if(this.initiator){if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.rs)throw new Error("remote static public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.rs))}else{if(!this.s)throw new Error("static keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.s,this.re))}}writeSE(){if(this.initiator){if(!this.s)throw new Error("static keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.s,this.re))}else{if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.rs)throw new Error("remote static public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.rs))}}readE(e,t=0){if(this.re)throw new Error("remote ephemeral public key is already set");if(e.byteLength<t+32)throw new Error("message is not long enough");this.re=e.sublist(t,t+32),this.ss.mixHash(this.re)}readS(e,t=0){if(this.rs)throw new Error("remote static public key is already set");let n=32+(this.ss.cs.hasKey()?16:0);if(e.byteLength<t+n)throw new Error("message is not long enough");let o=e.sublist(t,t+n);return this.rs=this.ss.decryptAndHash(o),n}readEE(){this.writeEE()}readES(){this.writeES()}readSE(){this.writeSE()}},op=class extends j7{writeMessageA(e){return new fe(this.writeE(),this.ss.encryptAndHash(e))}writeMessageB(e){let t=this.writeE();this.writeEE();let n=this.writeS();return this.writeES(),new fe(t,n,this.ss.encryptAndHash(e))}writeMessageC(e){let t=this.writeS();return this.writeSE(),new fe(t,this.ss.encryptAndHash(e))}readMessageA(e){try{return this.readE(e),this.ss.decryptAndHash(e.sublist(32))}catch(t){throw new of(`handshake stage 0 validation fail: ${t.message}`)}}readMessageB(e){try{this.readE(e),this.readEE();let t=this.readS(e,32);return this.readES(),this.ss.decryptAndHash(e.sublist(32+t))}catch(t){throw new of(`handshake stage 1 validation fail: ${t.message}`)}}readMessageC(e){try{let t=this.readS(e);return this.readSE(),this.ss.decryptAndHash(e.sublist(t))}catch(t){throw new of(`handshake stage 2 validation fail: ${t.message}`)}}};function NV(r,e){if(e.length<=32){let t=ke(32);return t.set(e),t}else return r.hash(e)}var dy;(function(r){let e;r.codec=()=>(e==null&&(e=Ie((t,n,o={})=>{if(o.lengthDelimited!==!1&&n.fork(),t.webtransportCerthashes!=null)for(let i of t.webtransportCerthashes)n.uint32(10),n.bytes(i);if(t.streamMuxers!=null)for(let i of t.streamMuxers)n.uint32(18),n.string(i);o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={webtransportCerthashes:[],streamMuxers:[]},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{if(o.limits?.webtransportCerthashes!=null&&i.webtransportCerthashes.length===o.limits.webtransportCerthashes)throw new dt('Decode error - map field "webtransportCerthashes" had too many elements');i.webtransportCerthashes.push(t.bytes());break}case 2:{if(o.limits?.streamMuxers!=null&&i.streamMuxers.length===o.limits.streamMuxers)throw new dt('Decode error - map field "streamMuxers" had too many elements');i.streamMuxers.push(t.string());break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>Te(t,r.codec()),r.decode=(t,n)=>Ae(t,r.codec(),n)})(dy||(dy={}));var ip;(function(r){let e;r.codec=()=>(e==null&&(e=Ie((t,n,o={})=>{o.lengthDelimited!==!1&&n.fork(),t.identityKey!=null&&t.identityKey.byteLength>0&&(n.uint32(10),n.bytes(t.identityKey)),t.identitySig!=null&&t.identitySig.byteLength>0&&(n.uint32(18),n.bytes(t.identitySig)),t.extensions!=null&&(n.uint32(34),dy.codec().encode(t.extensions,n)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={identityKey:ke(0),identitySig:ke(0)},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{i.identityKey=t.bytes();break}case 2:{i.identitySig=t.bytes();break}case 4:{i.extensions=dy.codec().decode(t,t.uint32(),{limits:o.limits?.extensions});break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>Te(t,r.codec()),r.decode=(t,n)=>Ae(t,r.codec(),n)})(ip||(ip={}));async function V7(r,e,t){let n=await r.sign(MC(e));return ip.encode({identityKey:sr(r.publicKey),identitySig:n,extensions:t})}async function H7(r,e,t){try{let n=ip.decode(r),o=Kt(n.identityKey);if(t?.equals(o)===!1)throw new Error(`Payload identity key ${o} does not match expected remote identity key ${t}`);if(!e)throw new Error("Remote static does not exist");let i=MC(e);if(!await o.verify(i,n.identitySig))throw new Error("Invalid payload signature");return n}catch(n){throw new em(n.message)}}function MC(r){let e=B("noise-libp2p-static-key:");return r instanceof Uint8Array?gt([e,r],e.length+r.length):(r.prepend(e),r)}var K7=class extends Vs{stream;handshake;metrics;decoder;constructor(e,t,n){super({log:e.log,inactivityTimeout:e.inactivityTimeout,maxReadBufferLength:e.maxReadBufferLength,direction:e.direction}),this.stream=e,this.handshake=t,this.metrics=n,this.decoder=new l0({lengthDecoder:nf,maxBufferSize:16*1024*1024,encodingLength:()=>2});let o=c=>{try{for(let l of this.decoder.decode(c.data))this.onData(this.decrypt(l))}catch(l){this.abort(l)}};this.stream.addEventListener("message",o);let i=c=>{c.error!=null?c.local===!0?this.abort(c.error):this.onRemoteReset():this.onTransportClosed()};this.stream.addEventListener("close",i);let s=()=>{this.safeDispatchEvent("drain")};this.stream.addEventListener("drain",s);let a=()=>{this.onRemoteCloseWrite()};this.stream.addEventListener("remoteCloseWrite",a)}encrypt(e){let t=new fe;for(let n=0;n<e.byteLength;n+=65519){let o=n+65519;o>e.byteLength&&(o=e.byteLength);let i;e instanceof Uint8Array?i=this.handshake.encrypt(e.subarray(n,o)):i=this.handshake.encrypt(e.sublist(n,o)),this.metrics?.encryptedPackets.increment(),t.append(rf(i.byteLength)),t.append(i)}return t}decrypt(e){let t=new fe;for(let n=0;n<e.byteLength;n+=65535){let o=n+65535;if(o>e.byteLength&&(o=e.byteLength),o-T7<n)throw new Error("Invalid chunk");let i;e instanceof Uint8Array?i=e.subarray(n,o):i=e.sublist(n,o);let s=e.subarray(n,o-T7);try{let a=this.handshake.decrypt(i,s);this.metrics?.decryptedPackets.increment(),t.append(a)}catch(a){throw this.metrics?.decryptErrors.increment(),a}}return t}close(e){return this.stream.close(e)}sendPause(){this.stream.pause()}sendResume(){this.stream.resume()}sendReset(e){this.stream.abort(e)}sendData(e){return{sentBytes:e.byteLength,canSendMore:this.stream.send(this.encrypt(e))}}};function q7(r,e,t){return new K7(r,e,t)}async function UC(r,e){let{log:t,connection:n,crypto:o,privateKey:i,prologue:s,s:a,remoteIdentityKey:c,extensions:l}=r,f=await V7(i,a.publicKey,l),u=new op({crypto:o,protocolName:"Noise_XX_25519_ChaChaPoly_SHA256",initiator:!0,prologue:s,s:a});B7(u.s,t),t.trace("Stage 0 - Initiator starting to send first message."),await n.write(u.writeMessageA(Yc),e),t.trace("Stage 0 - Initiator finished sending first message."),M7(u.e,t),t.trace("Stage 1 - Initiator waiting to receive first message from responder...");let d=u.readMessageB(await n.read(e));t.trace("Stage 1 - Initiator received the message."),U7(u.re,t),LC(u.rs,t),t.trace("Initiator going to check remote's signature...");let h=await H7(d,u.rs,c);t.trace("All good with the signature!"),t.trace("Stage 2 - Initiator sending third handshake message."),await n.write(u.writeMessageC(f),e),t.trace("Stage 2 - Initiator sent message with signed payload.");let[m,w]=u.ss.split();return F7(m,w,t),{payload:h,encrypt:y=>m.encryptWithAd(Yc,y),decrypt:(y,b)=>w.decryptWithAd(Yc,y,b)}}async function FC(r,e){let{log:t,connection:n,crypto:o,privateKey:i,prologue:s,s:a,remoteIdentityKey:c,extensions:l}=r,f=await V7(i,a.publicKey,l),u=new op({crypto:o,protocolName:"Noise_XX_25519_ChaChaPoly_SHA256",initiator:!1,prologue:s,s:a});B7(u.s,t),t.trace("Stage 0 - Responder waiting to receive first message."),u.readMessageA(await n.read(e)),t.trace("Stage 0 - Responder received first message."),U7(u.re,t),t.trace("Stage 1 - Responder sending out first message with signed payload and static key."),await n.write(u.writeMessageB(f),e),t.trace("Stage 1 - Responder sent the second handshake message with signed payload."),M7(u.e,t),t.trace("Stage 2 - Responder waiting for third handshake message...");let d=u.readMessageC(await n.read(e));t.trace("Stage 2 - Responder received the message, finished handshake.");let h=await H7(d,u.rs,c),[m,w]=u.ss.split();return F7(m,w,t),{payload:h,encrypt:y=>w.encryptWithAd(Yc,y),decrypt:(y,b)=>m.decryptWithAd(Yc,y,b)}}var hy=class{protocol="/noise";crypto;prologue;staticKey;extensions;metrics;components;log;constructor(e,t={}){let{staticNoiseKey:n,extensions:o,crypto:i,prologueBytes:s}=t,{metrics:a}=e;this.components=e,this.log=e.logger.forComponent("libp2p:noise");let c=i??RC;this.crypto=DC(c),this.extensions={webtransportCerthashes:[],...o},this.metrics=a?NC(a):void 0,n?this.staticKey=c.generateX25519KeyPairFromSeed(n):this.staticKey=c.generateX25519KeyPair(),this.prologue=s??ke(0)}[Symbol.toStringTag]="@chainsafe/libp2p-noise";[qe]=["@libp2p/connection-encryption","@chainsafe/libp2p-noise"];async secureOutbound(e,t){let n=e.log?.newScope("noise")??this.log,o=Gs(e,{lengthEncoder:rf,lengthDecoder:nf,maxDataLength:65535}),i=await this.performHandshakeInitiator(o,this.components.privateKey,n,t?.remotePeer?.publicKey,t),s=Kt(i.payload.identityKey);return{connection:q7(o.unwrap(),i,this.metrics),remoteExtensions:i.payload.extensions,remotePeer:si(s),streamMuxer:t?.skipStreamMuxerNegotiation===!0?void 0:this.getStreamMuxer(i.payload.extensions?.streamMuxers)}}getStreamMuxer(e){if(e==null||e.length===0)return;let t=this.components.upgrader.getStreamMuxers();if(t!=null)for(let n of e){let o=t.get(n);if(o!=null)return o}if(e.length)throw new tm("Early muxer negotiation was requested but the initiator and responder had no common muxers")}async secureInbound(e,t){let n=e.log?.newScope("noise")??this.log,o=Gs(e,{lengthEncoder:rf,lengthDecoder:nf,maxDataLength:65535}),i=await this.performHandshakeResponder(o,this.components.privateKey,n,t?.remotePeer?.publicKey,t),s=Kt(i.payload.identityKey);return{connection:q7(o.unwrap(),i,this.metrics),remoteExtensions:i.payload.extensions,remotePeer:si(s),streamMuxer:t?.skipStreamMuxerNegotiation===!0?void 0:this.getStreamMuxer(i.payload.extensions?.streamMuxers)}}async performHandshakeInitiator(e,t,n,o,i){let s,a=i?.skipStreamMuxerNegotiation===!0?[]:[...this.components.upgrader.getStreamMuxers().keys()];try{s=await UC({connection:e,privateKey:t,remoteIdentityKey:o,log:n.newScope("xxhandshake"),crypto:this.crypto,prologue:this.prologue,s:this.staticKey,extensions:{streamMuxers:a,webtransportCerthashes:[],...this.extensions}},i),this.metrics?.xxHandshakeSuccesses.increment()}catch(c){throw this.metrics?.xxHandshakeErrors.increment(),c}return s}async performHandshakeResponder(e,t,n,o,i){let s,a=i?.skipStreamMuxerNegotiation===!0?[]:[...this.components.upgrader.getStreamMuxers().keys()];try{s=await FC({connection:e,privateKey:t,remoteIdentityKey:o,log:n.newScope("xxhandshake"),crypto:this.crypto,prologue:this.prologue,s:this.staticKey,extensions:{streamMuxers:a,webtransportCerthashes:[],...this.extensions}},i),this.metrics?.xxHandshakeSuccesses.increment()}catch(c){throw this.metrics?.xxHandshakeErrors.increment(),c}return s}};function py(r={}){return e=>new hy(e,r)}var Rt;(function(r){r[r.Data=0]="Data",r[r.WindowUpdate=1]="WindowUpdate",r[r.Ping=2]="Ping",r[r.GoAway=3]="GoAway"})(Rt||(Rt={}));var Ze;(function(r){r[r.SYN=1]="SYN",r[r.ACK=2]="ACK",r[r.FIN=4]="FIN",r[r.RST=8]="RST"})(Ze||(Ze={}));var Tye=Object.values(Ze).filter(r=>typeof r!="string"),$C=0,tr;(function(r){r[r.NormalTermination=0]="NormalTermination",r[r.ProtocolError=1]="ProtocolError",r[r.InternalError=2]="InternalError"})(tr||(tr={}));var hi=12;var ds=class extends Error{static name="ProtocolError";reason;constructor(e,t){super(e),this.name="ProtocolError",this.reason=t}};function jC(r){return r?.reason!==null}var jn=class extends ds{static name="InvalidFrameError";constructor(e="The frame was invalid"){super(e,tr.ProtocolError),this.name="InvalidFrameError"}},af=class extends ds{static name="UnRequestedPingError";constructor(e="Un-requested ping error"){super(e,tr.ProtocolError),this.name="UnRequestedPingError"}},cf=class extends ds{static name="NotMatchingPingError";constructor(e="Not matching ping error"){super(e,tr.ProtocolError),this.name="NotMatchingPingError"}};var my=class extends ds{static name="StreamAlreadyExistsError";constructor(e="Stream already exists"){super(e,tr.ProtocolError),this.name="StreamAlreadyExistsError"}},gy=class extends ds{static name="DecodeInvalidVersionError";constructor(e="Decode invalid version"){super(e,tr.ProtocolError),this.name="DecodeInvalidVersionError"}},yy=class extends ds{static name="BothClientsError";constructor(e="Both clients"){super(e,tr.ProtocolError),this.name="BothClientsError"}},lf=class extends ds{static name="ReceiveWindowExceededError";constructor(e="Receive window exceeded"){super(e,tr.ProtocolError),this.name="ReceiveWindowExceededError"}};var Oye=new Set([jn.name,af.name,cf.name,my.name,gy.name,yy.name,lf.name]),ap=256*1024,wy=16*1024*1024;var cp={enableKeepAlive:!0,keepAliveInterval:3e4,maxInboundStreams:1e3,maxOutboundStreams:1e3,maxMessageSize:64*1024,maxEarlyStreams:10,streamOptions:{initialStreamWindowSize:ap,maxStreamWindowSize:wy,inactivityTimeout:12e4,maxReadBufferLength:4194304,maxWriteBufferLength:1/0}};function KC(r){if(r.keepAliveInterval!=null&&r.keepAliveInterval<=0)throw new P("keep-alive interval must be positive");if(r.maxInboundStreams!=null&&r.maxInboundStreams<0)throw new P("max inbound streams must be larger or equal 0");if(r.maxOutboundStreams!=null&&r.maxOutboundStreams<0)throw new P("max outbound streams must be larger or equal 0");if(r.maxMessageSize!=null&&r.maxMessageSize<1024)throw new P("MaxMessageSize must be greater than a kilobyte");if(r.streamOptions?.initialStreamWindowSize!=null&&r.streamOptions?.initialStreamWindowSize<ap)throw new P("InitialStreamWindowSize must be larger or equal 256 kB");if(r.streamOptions?.maxStreamWindowSize!=null&&r.streamOptions?.initialStreamWindowSize!=null&&r.streamOptions?.maxStreamWindowSize<r.streamOptions?.initialStreamWindowSize)throw new P("MaxStreamWindowSize must be larger than the InitialStreamWindowSize");if(r.streamOptions?.maxStreamWindowSize!=null&&r.streamOptions?.maxStreamWindowSize>2**32-1)throw new P("MaxStreamWindowSize must be less than equal MAX_UINT32")}function HC(r){return r.header.type===Rt.Data&&r.data!==null}var VC=2**24;function LV(r){if(r[0]!==$C)throw new jn("Invalid frame version");return{type:r[1],flag:(r[2]<<8)+r[3],streamID:r[4]*VC+(r[5]<<16)+(r[6]<<8)+r[7],length:r[8]*VC+(r[9]<<16)+(r[10]<<8)+r[11]}}var by=class{buffer;constructor(){this.buffer=new fe}*emitFrames(e){for(this.buffer.append(e);;){let t=this.readFrame();if(t===void 0)break;yield t}}readFrame(){let e=hi;if(this.buffer.byteLength<hi)return;let t=LV(this.buffer.subarray(0,hi));if(t.type===Rt.Data){if(e+=t.length,this.buffer.byteLength<e)return;let n=this.buffer.sublist(hi,e);return this.buffer.consume(e),{header:t,data:n}}return this.buffer.consume(e),{header:t}}};function W7(r){let e=new Uint8Array(hi);return e[1]=r.type,e[2]=r.flag>>>8,e[3]=r.flag,e[4]=r.streamID>>>24,e[5]=r.streamID>>>16,e[6]=r.streamID>>>8,e[7]=r.streamID,e[8]=r.length>>>24,e[9]=r.length>>>16,e[10]=r.length>>>8,e[11]=r.length,e}var tn;(function(r){r[r.Init=0]="Init",r[r.SYNSent=1]="SYNSent",r[r.SYNReceived=2]="SYNReceived",r[r.Established=3]="Established",r[r.Finished=4]="Finished",r[r.Paused=5]="Paused"})(tn||(tn={}));var vy=class extends Ws{streamId;state;sendWindowCapacity;recvWindow;recvWindowCapacity;maxStreamWindowSize;epochStart;getRTT;sendFrame;constructor(e){let t=e.initialStreamWindowSize??ap;super({...e,maxMessageSize:t-hi}),this.streamId=e.streamId,this.state=e.state,this.sendWindowCapacity=t,this.recvWindow=t,this.recvWindowCapacity=this.recvWindow,this.maxStreamWindowSize=e.maxStreamWindowSize??wy,this.epochStart=Date.now(),this.getRTT=e.getRTT,this.sendFrame=e.sendFrame;let n=()=>{this.state=tn.Finished};this.addEventListener("close",n)}sendData(e){let t=e.byteLength,n=0,o=!0;for(this.log?.trace("send window capacity is %d bytes",this.sendWindowCapacity);e.byteLength>0;){if(this.sendWindowCapacity===0){o=!1,this.log?.trace("sent %d/%d bytes, exhausted send window, waiting for window update",n,t);break}let i=Math.min(this.sendWindowCapacity,e.byteLength),s=this.getSendFlags(),a=e.sublist(0,i);e.consume(i);let c=this.sendFrame({type:Rt.Data,flag:s,streamID:this.streamId,length:i},a);if(this.sendWindowCapacity-=i,n+=i,!c){o=c,this.log.trace("sent %d/%d bytes, wait for muxer to have more send capacity",n,t);break}}return{sentBytes:n,canSendMore:o}}sendReset(){this.sendFrame({type:Rt.WindowUpdate,flag:Ze.RST,streamID:this.streamId,length:0})}async sendCloseWrite(){let e=this.getSendFlags()|Ze.FIN;this.sendFrame({type:Rt.WindowUpdate,flag:e,streamID:this.streamId,length:0})}async sendCloseRead(e){e?.signal?.throwIfAborted()}sendPause(){this.state=tn.Paused}sendResume(){this.state=tn.Established,this.sendWindowUpdate()}handleWindowUpdate(e){this.processFlags(e.header.flag),this.sendWindowCapacity+=e.header.length,this.maxMessageSize=this.sendWindowCapacity-hi,this.maxMessageSize<0&&(this.maxMessageSize=0),this.maxMessageSize!==0&&this.writeBuffer.byteLength>0&&(this.log?.trace("window update of %d bytes allows more data to be sent, have %d bytes queued, sending data %s",e.header.length,this.writeBuffer.byteLength,this.sendingData),this.safeDispatchEvent("drain"))}handleData(e){if(!HC(e))throw new jn("Frame was not data frame");if(this.processFlags(e.header.flag),this.recvWindowCapacity<e.header.length)throw new lf("Receive window exceeded");this.recvWindowCapacity-=e.header.length,this.onData(e.data),this.sendWindowUpdate()}processFlags(e){(e&Ze.ACK)===Ze.ACK&&this.state===tn.SYNSent&&(this.state=tn.Established),(e&Ze.FIN)===Ze.FIN&&this.onRemoteCloseWrite(),(e&Ze.RST)===Ze.RST&&this.onRemoteReset()}getSendFlags(){switch(this.state){case tn.Init:return this.state=tn.SYNSent,Ze.SYN;case tn.SYNReceived:return this.state=tn.Established,Ze.ACK;default:return 0}}sendWindowUpdate(){if(this.state===tn.Paused){this.epochStart=Date.now();return}let e=this.getSendFlags(),t=Date.now(),n=this.getRTT();if(e===0&&n>-1&&t-this.epochStart<=n*4&&(this.recvWindow=Math.min(this.recvWindow*2,this.maxStreamWindowSize)),this.recvWindowCapacity>=this.recvWindow&&e===0)return;let o=this.recvWindow-this.recvWindowCapacity;this.recvWindowCapacity=this.recvWindow,this.epochStart=t,this.sendFrame({type:Rt.WindowUpdate,flag:e,streamID:this.streamId,length:o})}};function qC(r){return{type:Rt[r.type],flags:[(r.flag&Ze.SYN)===Ze.SYN?"SYN":void 0,(r.flag&Ze.ACK)===Ze.ACK?"ACK":void 0,(r.flag&Ze.FIN)===Ze.FIN?"FIN":void 0,(r.flag&Ze.RST)===Ze.RST?"RST":void 0].filter(Boolean),streamID:r.streamID,length:r.length}}var WC="/yamux/1.0.0",xy=class{protocol=WC;_init;constructor(e={}){this._init=e}[Symbol.toStringTag]="@chainsafe/libp2p-yamux";[qe]=["@libp2p/stream-multiplexing"];createStreamMuxer(e){return new z7(e,{...this._init})}},z7=class extends qs{nextStreamID;nextPingID;activePing;rtt;client;localGoAway;remoteGoAway;numInboundStreams;numOutboundStreams;decoder;keepAlive;enableKeepAlive;keepAliveInterval;maxInboundStreams;maxOutboundStreams;constructor(e,t={}){super(e,{...t,protocol:WC,name:"yamux"}),this.client=e.direction==="outbound",KC(t),this.enableKeepAlive=t.enableKeepAlive??cp.enableKeepAlive,this.keepAliveInterval=t.keepAliveInterval??cp.keepAliveInterval,this.maxInboundStreams=t.maxInboundStreams??cp.maxInboundStreams,this.maxOutboundStreams=t.maxOutboundStreams??cp.maxOutboundStreams,this.decoder=new by,this.numInboundStreams=0,this.numOutboundStreams=0,this.nextStreamID=this.client?1:2,this.nextPingID=0,this.rtt=-1,this.log.trace("muxer created"),this.enableKeepAlive&&(this.log.trace("muxer keepalive enabled interval=%s",this.keepAliveInterval),this.keepAlive=Pu(async n=>{try{await this.ping(n)}catch(o){this.log.error("ping error: %s",o)}},this.keepAliveInterval,{runImmediately:!0}),this.keepAlive.start())}onData(e){for(let t of this.decoder.emitFrames(e))this.handleFrame(t)}onCreateStream(){if(this.remoteGoAway!==void 0)throw new yo("Muxer closed remotely");if(this.localGoAway!==void 0)throw new yo("Muxer closed locally");let e=this.nextStreamID;if(this.nextStreamID+=2,this.numOutboundStreams>=this.maxOutboundStreams)throw new Fl("max outbound streams exceeded");this.log.trace("new outgoing stream id=%s",e);let t=this._newStream(e,tn.Init,"outbound");return this.numOutboundStreams++,queueMicrotask(()=>{t.sendWindowUpdate()}),t}async ping(e){if(this.remoteGoAway!==void 0)throw new yo("Muxer closed remotely");if(this.localGoAway!==void 0)throw new yo("Muxer closed locally");if(this.activePing!=null)return ut(this.activePing.promise,e?.signal);this.activePing=Object.assign(Promise.withResolvers(),{id:this.nextPingID++,start:Date.now()}),this.sendPing(this.activePing.id);try{this.rtt=await ut(this.activePing.promise,e?.signal)}finally{this.activePing=void 0}return this.rtt}getRTT(){return this.rtt}async close(e={}){if(this.status==="open")try{let t=e?.reason??tr.NormalTermination;this.log.trace("muxer close reason=%s",tr[t]),await super.close(e),this.sendGoAway(t)}finally{this.keepAlive?.stop()}}abort(e){if(this.status==="open")try{super.abort(e);let t=tr.InternalError;jC(e)&&(t=e.reason),this.log.error("muxer abort reason=%s error=%s",t,e),this.sendGoAway(t)}finally{this.keepAlive?.stop()}}onTransportClosed(){try{super.onTransportClosed()}finally{this.keepAlive?.stop()}}_newStream(e,t,n){if(this.streams.find(i=>i.streamId===e)!=null)throw new P("Stream already exists with that id");let o=new vy({...this.streamOptions,id:`${e}`,streamId:e,state:t,direction:n,sendFrame:this.sendFrame.bind(this),log:this.log.newScope(`${n}:${e}`),getRTT:this.getRTT.bind(this)});return o.addEventListener("close",()=>{this.closeStream(e)},{once:!0}),o}closeStream(e){this.client===(e%2===0)?this.numInboundStreams--:this.numOutboundStreams--}handleFrame(e){let{streamID:t,type:n,length:o}=e.header;if(this.log.trace("received frame %o",qC(e.header)),t===0)switch(n){case Rt.Ping:{this.handlePing(e.header);return}case Rt.GoAway:{this.handleGoAway(o);return}default:throw new jn("Invalid frame type")}else switch(e.header.type){case Rt.Data:case Rt.WindowUpdate:{this.handleStreamMessage(e);return}default:throw new jn("Invalid frame type")}}handlePing(e){if(e.flag===Ze.SYN)this.log.trace("received ping request pingId=%s",e.length),this.sendPing(e.length,Ze.ACK);else if(e.flag===Ze.ACK)this.log.trace("received ping response pingId=%s",e.length),this.handlePingResponse(e.length);else throw new jn("Invalid frame flag")}handlePingResponse(e){if(this.activePing===void 0)throw new af("ping not requested");if(this.activePing.id!==e)throw new cf("ping doesn't match our id");this.activePing.resolve(Date.now()-this.activePing.start)}handleGoAway(e){this.log.trace("received GoAway reason=%s",tr[e]??"unknown"),this.remoteGoAway=e,e===tr.NormalTermination?this.onTransportClosed():this.abort(new Error("Remote sent GoAway"))}handleStreamMessage(e){let{streamID:t,flag:n,type:o}=e.header;(n&Ze.SYN)===Ze.SYN&&this.incomingStream(t);let i=this.streams.find(s=>s.streamId===t);if(i===void 0){this.log.trace("frame for missing stream id=%s",t);return}switch(o){case Rt.WindowUpdate:{i.handleWindowUpdate(e);return}case Rt.Data:{i.handleData(e);return}default:throw new Error("unreachable")}}incomingStream(e){if(this.client!==(e%2===0))throw new P("Both endpoints are clients");if(this.streams.find(n=>n.streamId===e))return;if(this.log.trace("new incoming stream id=%s",e),this.localGoAway!==void 0){this.sendFrame({type:Rt.WindowUpdate,flag:Ze.RST,streamID:e,length:0});return}if(this.numInboundStreams>=this.maxInboundStreams){this.log("maxIncomingStreams exceeded, forcing stream reset"),this.sendFrame({type:Rt.WindowUpdate,flag:Ze.RST,streamID:e,length:0});return}let t=this._newStream(e,tn.SYNReceived,"inbound");this.numInboundStreams++,this.onRemoteStream(t)}sendFrame(e,t){let n;if(e.type===Rt.Data){if(t==null)throw new jn("Invalid frame");n=new fe(W7(e),t)}else n=W7(e);return this.log.trace("sending frame %o",qC(e)),this.send(n)}sendPing(e,t=Ze.SYN){t===Ze.SYN?this.log.trace("sending ping request pingId=%s",e):this.log.trace("sending ping response pingId=%s",e),this.sendFrame({type:Rt.Ping,flag:t,streamID:0,length:e})}sendGoAway(e=tr.NormalTermination){this.log("sending GoAway reason=%s",tr[e]),this.localGoAway=e,this.sendFrame({type:Rt.GoAway,flag:0,streamID:0,length:e})}};function zC(r={}){return()=>new xy(r)}var GC="libp2p",XC="autonat",YC="1.0.0";var At;(function(r){let e;(function(l){l.DIAL="DIAL",l.DIAL_RESPONSE="DIAL_RESPONSE"})(e=r.MessageType||(r.MessageType={}));let t;(function(l){l[l.DIAL=0]="DIAL",l[l.DIAL_RESPONSE=1]="DIAL_RESPONSE"})(t||(t={})),(function(l){l.codec=()=>kt(t)})(e=r.MessageType||(r.MessageType={}));let n;(function(l){l.OK="OK",l.E_DIAL_ERROR="E_DIAL_ERROR",l.E_DIAL_REFUSED="E_DIAL_REFUSED",l.E_BAD_REQUEST="E_BAD_REQUEST",l.E_INTERNAL_ERROR="E_INTERNAL_ERROR"})(n=r.ResponseStatus||(r.ResponseStatus={}));let o;(function(l){l[l.OK=0]="OK",l[l.E_DIAL_ERROR=100]="E_DIAL_ERROR",l[l.E_DIAL_REFUSED=101]="E_DIAL_REFUSED",l[l.E_BAD_REQUEST=200]="E_BAD_REQUEST",l[l.E_INTERNAL_ERROR=300]="E_INTERNAL_ERROR"})(o||(o={})),(function(l){l.codec=()=>kt(o)})(n=r.ResponseStatus||(r.ResponseStatus={}));let i;(function(l){let f;l.codec=()=>(f==null&&(f=Ie((u,d,h={})=>{if(h.lengthDelimited!==!1&&d.fork(),u.id!=null&&(d.uint32(10),d.bytes(u.id)),u.addrs!=null)for(let m of u.addrs)d.uint32(18),d.bytes(m);h.lengthDelimited!==!1&&d.ldelim()},(u,d,h={})=>{let m={addrs:[]},w=d==null?u.len:u.pos+d;for(;u.pos<w;){let y=u.uint32();switch(y>>>3){case 1:{m.id=u.bytes();break}case 2:{if(h.limits?.addrs!=null&&m.addrs.length===h.limits.addrs)throw new dt('Decode error - map field "addrs" had too many elements');m.addrs.push(u.bytes());break}default:{u.skipType(y&7);break}}}return m})),f),l.encode=u=>Te(u,l.codec()),l.decode=(u,d)=>Ae(u,l.codec(),d)})(i=r.PeerInfo||(r.PeerInfo={}));let s;(function(l){let f;l.codec=()=>(f==null&&(f=Ie((u,d,h={})=>{h.lengthDelimited!==!1&&d.fork(),u.peer!=null&&(d.uint32(10),r.PeerInfo.codec().encode(u.peer,d)),h.lengthDelimited!==!1&&d.ldelim()},(u,d,h={})=>{let m={},w=d==null?u.len:u.pos+d;for(;u.pos<w;){let y=u.uint32();switch(y>>>3){case 1:{m.peer=r.PeerInfo.codec().decode(u,u.uint32(),{limits:h.limits?.peer});break}default:{u.skipType(y&7);break}}}return m})),f),l.encode=u=>Te(u,l.codec()),l.decode=(u,d)=>Ae(u,l.codec(),d)})(s=r.Dial||(r.Dial={}));let a;(function(l){let f;l.codec=()=>(f==null&&(f=Ie((u,d,h={})=>{h.lengthDelimited!==!1&&d.fork(),u.status!=null&&(d.uint32(8),r.ResponseStatus.codec().encode(u.status,d)),u.statusText!=null&&(d.uint32(18),d.string(u.statusText)),u.addr!=null&&(d.uint32(26),d.bytes(u.addr)),h.lengthDelimited!==!1&&d.ldelim()},(u,d,h={})=>{let m={},w=d==null?u.len:u.pos+d;for(;u.pos<w;){let y=u.uint32();switch(y>>>3){case 1:{m.status=r.ResponseStatus.codec().decode(u);break}case 2:{m.statusText=u.string();break}case 3:{m.addr=u.bytes();break}default:{u.skipType(y&7);break}}}return m})),f),l.encode=u=>Te(u,l.codec()),l.decode=(u,d)=>Ae(u,l.codec(),d)})(a=r.DialResponse||(r.DialResponse={}));let c;r.codec=()=>(c==null&&(c=Ie((l,f,u={})=>{u.lengthDelimited!==!1&&f.fork(),l.type!=null&&(f.uint32(8),r.MessageType.codec().encode(l.type,f)),l.dial!=null&&(f.uint32(18),r.Dial.codec().encode(l.dial,f)),l.dialResponse!=null&&(f.uint32(26),r.DialResponse.codec().encode(l.dialResponse,f)),u.lengthDelimited!==!1&&f.ldelim()},(l,f,u={})=>{let d={},h=f==null?l.len:l.pos+f;for(;l.pos<h;){let m=l.uint32();switch(m>>>3){case 1:{d.type=r.MessageType.codec().decode(l);break}case 2:{d.dial=r.Dial.codec().decode(l,l.uint32(),{limits:u.limits?.dial});break}case 3:{d.dialResponse=r.DialResponse.codec().decode(l,l.uint32(),{limits:u.limits?.dialResponse});break}default:{l.skipType(m&7);break}}}return d})),c),r.encode=l=>Te(l,r.codec()),r.decode=(l,f)=>Ae(l,r.codec(),f)})(At||(At={}));var jV=4,KV=8,Ey=class{components;protocol;timeout;maxInboundStreams;maxOutboundStreams;maxMessageSize;started;log;topologyId;dialResults;findPeers;addressFilter;connectionThreshold;constructor(e,t){this.components=e,this.log=e.logger.forComponent("libp2p:auto-nat"),this.started=!1,this.protocol=`/${t.protocolPrefix??GC}/${XC}/${YC}`,this.timeout=t.timeout??3e4,this.maxInboundStreams=t.maxInboundStreams??2,this.maxOutboundStreams=t.maxOutboundStreams??20,this.connectionThreshold=t.connectionThreshold??80,this.maxMessageSize=t.maxMessageSize??8192,this.dialResults=Wt({name:"libp2p_autonat_dial_results",metrics:e.metrics}),this.findPeers=Pu(this.findRandomPeers.bind(this),6e4),this.addressFilter=Fr(1024)}[Symbol.toStringTag]="@libp2p/autonat";[qe]=["@libp2p/autonat"];get[An](){return["@libp2p/identify"]}isStarted(){return this.started}async start(){this.started||(await this.components.registrar.handle(this.protocol,(e,t)=>{this.handleIncomingAutonatStream(e,t).catch(n=>{this.log.error("error handling incoming autonat stream - %e",n)})},{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams}),this.topologyId=await this.components.registrar.register(this.protocol,{onConnect:(e,t)=>{this.verifyExternalAddresses(t).catch(n=>{this.log.error("could not verify addresses - %e",n)})}}),this.findPeers.start(),this.started=!0)}async stop(){await this.components.registrar.unhandle(this.protocol),this.topologyId!=null&&await this.components.registrar.unhandle(this.topologyId),this.dialResults.clear(),this.findPeers.stop(),this.started=!1}allAddressesAreVerified(){return this.components.addressManager.getAddressesWithMetadata().every(e=>e.expires>Date.now()?!0:e.verified)}async findRandomPeers(e){if(this.allAddressesAreVerified())return;let t=De([AbortSignal.timeout(1e4),e?.signal]);try{this.log("starting random walk to find peers to run AutoNAT");for await(let n of this.components.randomWalk.walk({signal:t})){if(!await this.components.connectionManager.isDialable(n.multiaddrs)){this.log.trace("random peer %p was not dialable %s",n.id,n.multiaddrs.map(o=>o.toString()).join(", "));continue}try{this.log.trace("dial random peer %p",n.id),await this.components.connectionManager.openConnection(n.multiaddrs,{signal:t})}catch{}if(this.allAddressesAreVerified()){this.log("stopping random walk, all addresses are verified");return}if(!this.hasConnectionCapacity()){this.log("stopping random walk, too close to max connections");return}}}catch{}}async handleIncomingAutonatStream(e,t){let n=AbortSignal.timeout(this.timeout);try{let o=bt(e,{maxDataLength:this.maxMessageSize}).pb(At),i=await o.read({signal:n}),s=await this.handleAutonatMessage(i,t,{signal:n});await o.write(s,{signal:n}),await e.close({signal:n})}catch(o){this.log.error("error handling incoming autonat stream - %e",o),e.abort(o)}}async handleAutonatMessage(e,t,n){let o=this.components.addressManager.getAddresses().map(u=>Ce(u).host),i=e.dial;if(i==null)return this.log.error("dial was missing from message"),{type:At.MessageType.DIAL_RESPONSE,dialResponse:{status:At.ResponseStatus.E_BAD_REQUEST,statusText:"No Dial message found in message"}};let s,a=i.peer;if(a?.id==null)return this.log.error("peerId missing from message"),{type:At.MessageType.DIAL_RESPONSE,dialResponse:{status:At.ResponseStatus.E_BAD_REQUEST,statusText:"missing peer info"}};try{let u=lt(a.id);s=zt(u)}catch(u){return this.log.error("invalid PeerId - %e",u),{type:At.MessageType.DIAL_RESPONSE,dialResponse:{status:At.ResponseStatus.E_BAD_REQUEST,statusText:"bad peer id"}}}if(this.log("incoming request from %p",s),!t.remotePeer.equals(s))return this.log("target peer %p did not equal sending peer %p",s,t.remotePeer),{type:At.MessageType.DIAL_RESPONSE,dialResponse:{status:At.ResponseStatus.E_BAD_REQUEST,statusText:"peer id mismatch"}};let c=a.addrs.map(u=>ie(u)).filter(u=>{try{let d=Ce(u);return Mt(u)?!1:d.host!==Ce(t.remoteAddr).host?(this.log.trace("not dialing %a - target host did not match remote host %a",u,t.remoteAddr),!1):o.includes(d.host)?!1:this.components.transportManager.dialTransportForMultiaddr(u)==null?(this.log.trace("not dialing %a - transport unsupported",u),!1):!0}catch{return!1}}).map(u=>(u.getComponents().find(d=>d.code===421)?.value==null&&(u=u.encapsulate(`/p2p/${s.toString()}`)),u));if(c.length===0)return this.log("refused to dial all multiaddrs for %p from message",s),{type:At.MessageType.DIAL_RESPONSE,dialResponse:{status:At.ResponseStatus.E_DIAL_REFUSED,statusText:"no dialable addresses"}};this.log("dial multiaddrs %s for peer %p",c.map(u=>u.toString()).join(", "),s);let l="",f=c[0];for(let u of c){let d;f=u;try{if(d=await this.components.connectionManager.openConnection(u,n),!d.remoteAddr.equals(u))throw this.log.error("tried to dial %a but dialed %a",u,d.remoteAddr),new Error("Unexpected remote address");return this.log("successfully dialed %p via %a",s,u),{type:At.MessageType.DIAL_RESPONSE,dialResponse:{status:At.ResponseStatus.OK,addr:d.remoteAddr.decapsulateCode(421).bytes}}}catch(h){this.log.error("could not dial %p - %e",s,h),l=h.message}finally{d!=null&&await d.close()}}return{type:At.MessageType.DIAL_RESPONSE,dialResponse:{status:At.ResponseStatus.E_DIAL_ERROR,statusText:l,addr:f.bytes}}}getFirstUnverifiedMultiaddr(e,t){let n=this.components.addressManager.getAddressesWithMetadata().sort((o,i)=>o.type==="observed"&&i.type!=="observed"?1:i.type==="observed"&&o.type!=="observed"?-1:0).filter(o=>!(!(o.expires<Date.now())||Ce(o.multiaddr).type==="ip6"&&(!t||!qm(o.multiaddr))||Mt(o.multiaddr)));for(let o of n){let i=o.multiaddr.toString(),s=this.dialResults.get(i);if(s!=null){if(s.networkSegments.includes(e)){this.log.trace("%a already has a network segment result from %s",s.multiaddr,e);continue}if(s.queue.size>10){this.log.trace("%a already has enough peers queued",s.multiaddr);continue}}if(s==null){let a=o.expires<Date.now();if(a&&this.addressFilter.remove?.(i),this.addressFilter.has(i))continue;this.addressFilter.add(i),this.log.trace("creating dial result %s %s",a?"to revalidate":"for",i),s={multiaddr:o.multiaddr,success:0,failure:0,networkSegments:[],verifyingPeers:mw(),queue:new vr({concurrency:3,maxSize:50}),type:o.type,lastVerified:o.lastVerified},this.dialResults.set(i,s)}return s}}removeOutdatedMultiaddrResults(){let e=new Set(this.components.addressManager.getAddressesWithMetadata().filter(({expires:t})=>t<Date.now()).map(({multiaddr:t})=>t.toString()));for(let t of this.dialResults.keys())e.has(t)||(this.log.trace("remove results for %a",t),this.dialResults.delete(t))}async verifyExternalAddresses(e){if(!this.isStarted())return;this.removeOutdatedMultiaddrResults();let n=(await this.components.peerStore.get(e.remotePeer)).addresses.some(({multiaddr:s})=>Ce(s).type==="ip6"),o=this.getNetworkSegment(e.remoteAddr),i=this.getFirstUnverifiedMultiaddr(o,n);if(i==null){this.log.trace("no unverified public addresses found for peer %p to verify, not requesting verification",e.remotePeer);return}if(!this.hasConnectionCapacity()){i.lastVerified!=null?(this.log("automatically re-verifying %a because we are too close to the connection limit",i.multiaddr),this.confirmAddress(i)):this.log("skipping verifying %a because we are too close to the connection limit",i.multiaddr);return}i.queue.add(async s=>{await this.askPeerToVerify(e,o,s)},{peerId:e.remotePeer,multiaddr:i.multiaddr}).catch(s=>{i?.result==null&&this.log.error("error from %p verifying address %a - %e",e.remotePeer,i?.multiaddr,s)})}async askPeerToVerify(e,t,n){let o=this.dialResults.get(n.multiaddr.toString());if(o==null){this.log("%a was verified while %p was queued",n.multiaddr,e.remotePeer);return}let i=AbortSignal.timeout(this.timeout);this.log.trace("asking %a to verify multiaddr %s",e.remoteAddr,n.multiaddr);let s=await e.newStream(this.protocol,{signal:i});try{let a=bt(s).pb(At),[,c]=await Promise.all([a.write({type:At.MessageType.DIAL,dial:{peer:{id:this.components.peerId.toMultihash().bytes,addrs:[n.multiaddr.bytes]}}},{signal:i}),a.read({signal:i})]);if(c.type!==At.MessageType.DIAL_RESPONSE||c.dialResponse==null){this.log("invalid autonat response from %p - %j",e.remotePeer,c);return}let l=c.dialResponse.status;if(this.log.trace("autonat response from %p for %a is %s",e.remotePeer,n.multiaddr,l),l!==At.ResponseStatus.OK&&l!==At.ResponseStatus.E_DIAL_ERROR)return;if(o=this.dialResults.get(n.multiaddr.toString()),o==null){this.log.trace("peer reported %a as %s but there is no result object",n.multiaddr,c.dialResponse.status);return}if(o.networkSegments.includes(t)){this.log.trace("%a results included network segment %s",n.multiaddr,t);return}if(o.result!=null){this.log.trace("already resolved result for %a, ignoring response from",n.multiaddr,e.remotePeer);return}if(o.verifyingPeers.has(e.remotePeer)){this.log.trace("peer %p has already verified %a, ignoring response",e.remotePeer,n.multiaddr);return}if(o.verifyingPeers.add(e.remotePeer),o.networkSegments.push(t),l===At.ResponseStatus.OK){if(o.success++,o.type!=="observed"){this.confirmAddress(o);return}}else l===At.ResponseStatus.E_DIAL_ERROR&&o.failure++;this.log("%a success %d failure %d",o.multiaddr,o.success,o.failure),o.success===jV&&this.confirmAddress(o),o.failure===KV&&this.unconfirmAddress(o)}finally{try{await s.close({signal:i})}catch(a){s.abort(a)}}}hasConnectionCapacity(){let t=this.components.connectionManager.getConnections().length,n=this.components.connectionManager.getMaxConnections();return t/n*100<this.connectionThreshold}confirmAddress(e){this.log("%s address %a is externally dialable",e.type,e.multiaddr),this.components.addressManager.confirmObservedAddr(e.multiaddr),this.dialResults.delete(e.multiaddr.toString()),e.result=!0,e.queue.abort()}unconfirmAddress(e){this.log("%s address %a is not externally dialable",e.type,e.multiaddr),this.components.addressManager.removeObservedAddr(e.multiaddr),this.dialResults.delete(e.multiaddr.toString()),e.result=!1,e.queue.abort()}getNetworkSegment(e){let t=Ce(e);switch(t.type){case"ip4":return t.host.split(".")[0].padStart(3,"0");case"ip6":return t.host.split(":")[0].padStart(4,"0");default:throw new P(`Remote address ${e} was not an IPv4 or Ipv6 address`)}}};function QC(r={}){return e=>new Ey(e,r)}var VV="bootstrap",HV=50,qV=1e3,G7=class extends _e{static tag="bootstrap";log;timer;list;timeout;components;_init;constructor(e,t={list:[]}){if(t.list==null||t.list.length===0)throw new Error("Bootstrap requires a list of peer addresses");super(),this.components=e,this.log=e.logger.forComponent("libp2p:bootstrap"),this.timeout=t.timeout??qV,this.list=t.list.map(n=>ie(n)).filter(n=>Uu.matches(n)?n.getComponents().findLast(i=>i.code===421)?.value==null?(this.log.error("invalid bootstrap multiaddr without peer id"),!1):!0:(this.log.error("invalid multiaddr %a",n),!1)).map(n=>({id:yt(n.getComponents().findLast(o=>o.code===421)?.value??""),multiaddrs:[n]})),this._init=t}[Va]=this;[Symbol.toStringTag]="@libp2p/bootstrap";[qe]=["@libp2p/peer-discovery"];isStarted(){return!!this.timer}start(){this.isStarted()||(this.log("Starting bootstrap node discovery, discovering peers after %s ms",this.timeout),this.timer=setTimeout(()=>{this._discoverBootstrapPeers().catch(e=>{this.log.error("failed to discover bootstrap peers - %e",e)})},this.timeout))}async _discoverBootstrapPeers(){if(this.timer!=null)for(let e of this.list){if(await this.components.peerStore.merge(e.id,{tags:{[this._init.tagName??VV]:{value:this._init.tagValue??HV,ttl:this._init.tagTTL}},multiaddrs:e.multiaddrs}),this.timer==null)return;this.safeDispatchEvent("peer",{detail:e}),this.components.connectionManager.openConnection(e.id).catch(t=>{this.log.error("could not dial bootstrap peer %p - %e",e.id,t)})}}stop(){this.timer!=null&&clearTimeout(this.timer),this.timer=void 0}};function ZC(r){return e=>new G7(e,r)}var X7=1e3,JC=60*X7;var O3e=120*JC,eP=1,Sy=5e3,tP=100;var lp=`${Ha}-circuit-relay`,R3e=2*JC,D3e=BigInt(1<<17),Qc="/libp2p/circuit/relay/0.2.0/hop",Y7="/libp2p/circuit/relay/0.2.0/stop",N3e=30*X7,L3e=30*X7,Q7=300,rP=4096,nP=.001;var sa;(function(r){let e;(function(o){o.RESERVE="RESERVE",o.CONNECT="CONNECT",o.STATUS="STATUS"})(e=r.Type||(r.Type={}));let t;(function(o){o[o.RESERVE=0]="RESERVE",o[o.CONNECT=1]="CONNECT",o[o.STATUS=2]="STATUS"})(t||(t={})),(function(o){o.codec=()=>kt(t)})(e=r.Type||(r.Type={}));let n;r.codec=()=>(n==null&&(n=Ie((o,i,s={})=>{s.lengthDelimited!==!1&&i.fork(),o.type!=null&&(i.uint32(8),r.Type.codec().encode(o.type,i)),o.peer!=null&&(i.uint32(18),uf.codec().encode(o.peer,i)),o.reservation!=null&&(i.uint32(26),_y.codec().encode(o.reservation,i)),o.limit!=null&&(i.uint32(34),ff.codec().encode(o.limit,i)),o.status!=null&&(i.uint32(40),_r.codec().encode(o.status,i)),s.lengthDelimited!==!1&&i.ldelim()},(o,i,s={})=>{let a={},c=i==null?o.len:o.pos+i;for(;o.pos<c;){let l=o.uint32();switch(l>>>3){case 1:{a.type=r.Type.codec().decode(o);break}case 2:{a.peer=uf.codec().decode(o,o.uint32(),{limits:s.limits?.peer});break}case 3:{a.reservation=_y.codec().decode(o,o.uint32(),{limits:s.limits?.reservation});break}case 4:{a.limit=ff.codec().decode(o,o.uint32(),{limits:s.limits?.limit});break}case 5:{a.status=_r.codec().decode(o);break}default:{o.skipType(l&7);break}}}return a})),n),r.encode=o=>Te(o,r.codec()),r.decode=(o,i)=>Ae(o,r.codec(),i)})(sa||(sa={}));var pi;(function(r){let e;(function(o){o.CONNECT="CONNECT",o.STATUS="STATUS"})(e=r.Type||(r.Type={}));let t;(function(o){o[o.CONNECT=0]="CONNECT",o[o.STATUS=1]="STATUS"})(t||(t={})),(function(o){o.codec=()=>kt(t)})(e=r.Type||(r.Type={}));let n;r.codec=()=>(n==null&&(n=Ie((o,i,s={})=>{s.lengthDelimited!==!1&&i.fork(),o.type!=null&&(i.uint32(8),r.Type.codec().encode(o.type,i)),o.peer!=null&&(i.uint32(18),uf.codec().encode(o.peer,i)),o.limit!=null&&(i.uint32(26),ff.codec().encode(o.limit,i)),o.status!=null&&(i.uint32(32),_r.codec().encode(o.status,i)),s.lengthDelimited!==!1&&i.ldelim()},(o,i,s={})=>{let a={},c=i==null?o.len:o.pos+i;for(;o.pos<c;){let l=o.uint32();switch(l>>>3){case 1:{a.type=r.Type.codec().decode(o);break}case 2:{a.peer=uf.codec().decode(o,o.uint32(),{limits:s.limits?.peer});break}case 3:{a.limit=ff.codec().decode(o,o.uint32(),{limits:s.limits?.limit});break}case 4:{a.status=_r.codec().decode(o);break}default:{o.skipType(l&7);break}}}return a})),n),r.encode=o=>Te(o,r.codec()),r.decode=(o,i)=>Ae(o,r.codec(),i)})(pi||(pi={}));var uf;(function(r){let e;r.codec=()=>(e==null&&(e=Ie((t,n,o={})=>{if(o.lengthDelimited!==!1&&n.fork(),t.id!=null&&t.id.byteLength>0&&(n.uint32(10),n.bytes(t.id)),t.addrs!=null)for(let i of t.addrs)n.uint32(18),n.bytes(i);o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={id:ke(0),addrs:[]},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{i.id=t.bytes();break}case 2:{if(o.limits?.addrs!=null&&i.addrs.length===o.limits.addrs)throw new dt('Decode error - map field "addrs" had too many elements');i.addrs.push(t.bytes());break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>Te(t,r.codec()),r.decode=(t,n)=>Ae(t,r.codec(),n)})(uf||(uf={}));var _y;(function(r){let e;r.codec=()=>(e==null&&(e=Ie((t,n,o={})=>{if(o.lengthDelimited!==!1&&n.fork(),t.expire!=null&&t.expire!==0n&&(n.uint32(8),n.uint64(t.expire)),t.addrs!=null)for(let i of t.addrs)n.uint32(18),n.bytes(i);t.voucher!=null&&(n.uint32(26),Ty.codec().encode(t.voucher,n)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={expire:0n,addrs:[]},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{i.expire=t.uint64();break}case 2:{if(o.limits?.addrs!=null&&i.addrs.length===o.limits.addrs)throw new dt('Decode error - map field "addrs" had too many elements');i.addrs.push(t.bytes());break}case 3:{i.voucher=Ty.codec().decode(t,t.uint32(),{limits:o.limits?.voucher});break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>Te(t,r.codec()),r.decode=(t,n)=>Ae(t,r.codec(),n)})(_y||(_y={}));var ff;(function(r){let e;r.codec=()=>(e==null&&(e=Ie((t,n,o={})=>{o.lengthDelimited!==!1&&n.fork(),t.duration!=null&&(n.uint32(8),n.uint32(t.duration)),t.data!=null&&(n.uint32(16),n.uint64(t.data)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{i.duration=t.uint32();break}case 2:{i.data=t.uint64();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>Te(t,r.codec()),r.decode=(t,n)=>Ae(t,r.codec(),n)})(ff||(ff={}));var _r;(function(r){r.UNUSED="UNUSED",r.OK="OK",r.RESERVATION_REFUSED="RESERVATION_REFUSED",r.RESOURCE_LIMIT_EXCEEDED="RESOURCE_LIMIT_EXCEEDED",r.PERMISSION_DENIED="PERMISSION_DENIED",r.CONNECTION_FAILED="CONNECTION_FAILED",r.NO_RESERVATION="NO_RESERVATION",r.MALFORMED_MESSAGE="MALFORMED_MESSAGE",r.UNEXPECTED_MESSAGE="UNEXPECTED_MESSAGE"})(_r||(_r={}));var Z7;(function(r){r[r.UNUSED=0]="UNUSED",r[r.OK=100]="OK",r[r.RESERVATION_REFUSED=200]="RESERVATION_REFUSED",r[r.RESOURCE_LIMIT_EXCEEDED=201]="RESOURCE_LIMIT_EXCEEDED",r[r.PERMISSION_DENIED=202]="PERMISSION_DENIED",r[r.CONNECTION_FAILED=203]="CONNECTION_FAILED",r[r.NO_RESERVATION=204]="NO_RESERVATION",r[r.MALFORMED_MESSAGE=400]="MALFORMED_MESSAGE",r[r.UNEXPECTED_MESSAGE=401]="UNEXPECTED_MESSAGE"})(Z7||(Z7={}));(function(r){r.codec=()=>kt(Z7)})(_r||(_r={}));var Ay;(function(r){let e;r.codec=()=>(e==null&&(e=Ie((t,n,o={})=>{o.lengthDelimited!==!1&&n.fork(),t.relay!=null&&t.relay.byteLength>0&&(n.uint32(10),n.bytes(t.relay)),t.peer!=null&&t.peer.byteLength>0&&(n.uint32(18),n.bytes(t.peer)),t.expiration!=null&&t.expiration!==0n&&(n.uint32(24),n.uint64(t.expiration)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={relay:ke(0),peer:ke(0),expiration:0n},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{i.relay=t.bytes();break}case 2:{i.peer=t.bytes();break}case 3:{i.expiration=t.uint64();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>Te(t,r.codec()),r.decode=(t,n)=>Ae(t,r.codec(),n)})(Ay||(Ay={}));var Ty;(function(r){let e;r.codec=()=>(e==null&&(e=Ie((t,n,o={})=>{o.lengthDelimited!==!1&&n.fork(),t.publicKey!=null&&t.publicKey.byteLength>0&&(n.uint32(10),n.bytes(t.publicKey)),t.payloadType!=null&&t.payloadType.byteLength>0&&(n.uint32(18),n.bytes(t.payloadType)),t.payload!=null&&(n.uint32(26),Ay.codec().encode(t.payload,n)),t.signature!=null&&t.signature.byteLength>0&&(n.uint32(42),n.bytes(t.signature)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={publicKey:ke(0),payloadType:ke(0),signature:ke(0)},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{i.publicKey=t.bytes();break}case 2:{i.payloadType=t.bytes();break}case 3:{i.payload=Ay.codec().decode(t,t.uint32(),{limits:o.limits?.payload});break}case 5:{i.signature=t.bytes();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>Te(t,r.codec()),r.decode=(t,n)=>Ae(t,r.codec(),n)})(Ty||(Ty={}));var up=class extends Error{static name="HadEnoughRelaysError";name="HadEnoughRelaysError"},Iy=class extends Error{static name="DoubleRelayError";name="DoubleRelayError"},Cy=class extends Error{static name="RelayQueueFullError";name="RelayQueueFullError"};function J7(r){let e=r*BigInt(1e3),t=new Date().getTime();return Number(e-BigInt(t))}var fp=class{expires;bytes;constructor(e){e?.duration!=null&&e?.duration!==0&&(this.expires=Date.now()+e.duration*1e3),this.bytes=e?.data,this.bytes===0n&&(this.bytes=void 0),this.onData=this.onData.bind(this)}onData(e){this.bytes!=null&&(this.bytes-=BigInt(e.byteLength),this.bytes<0n&&(this.bytes=0n))}getLimits(){if(this.expires==null&&this.bytes==null)return;let e={};if(this.bytes!=null){let t=this;Object.defineProperty(e,"bytes",{get(){return t.bytes}})}if(this.expires!=null){let t=this;Object.defineProperty(e,"seconds",{get(){return Math.round(((t.expires??0)-Date.now())/1e3)}})}return e}},Py=ct(Qe(Uu.matchers[0],at(290))),ky=ct(at(290));var Oy=class extends _e{components;started;running;topologyId;log;discoveryController;filter;queue;constructor(e,t={}){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:discover-relays"),this.components=e,this.started=!1,this.running=!1,this.filter=t.filter,this.discoveryController=new AbortController,this.discoveryController.signal,this.dialPeer=this.dialPeer.bind(this),this.onPeer=this.onPeer.bind(this)}isStarted(){return this.started}async start(){this.topologyId=await this.components.registrar.register(Qc,{filter:this.filter,onConnect:e=>{this.log.trace("discovered relay %p queue (length: %d, active %d)",e,this.queue?.size,this.queue?.running),this.safeDispatchEvent("relay:discover",{detail:e})}}),this.started=!0}stop(){this.topologyId!=null&&this.components.registrar.unregister(this.topologyId),this.running&&this.stopDiscovery(),this.started=!1}startDiscovery(){this.running||(this.log("start discovery"),this.running=!0,this.discoveryController=new AbortController,this.discoveryController.signal,this.components.events.addEventListener("peer:discovery",this.onPeer),Promise.resolve().then(async()=>{this.log("searching peer store for relays");let e=await this.components.peerStore.all({filters:[n=>n.protocols.includes(Qc)],orders:[()=>Math.random()<.5?1:-1,(n,o)=>{let i=oP(n),s=oP(o);return i>s?-1:s>i?1:0}]});for(let n of e)this.log.trace("found relay peer %p in peer store",n.id),this.safeDispatchEvent("relay:discover",{detail:n.id});this.log("found %d relay peers in peer store",e.length);let t=this.queue=new vr({concurrency:5});this.log("start random walk");for await(let n of this.components.randomWalk.walk({signal:this.discoveryController.signal})){if(this.log.trace("found random peer %p",n.id),t.has(n.id)){this.log.trace("random peer %p was already in queue",n.id);continue}if(this.components.connectionManager.getConnections(n.id)?.length>0){this.log.trace("random peer %p was already connected",n.id);continue}if(!await this.components.connectionManager.isDialable(n.multiaddrs)){this.log.trace("random peer %p was not dialable",n.id,n.multiaddrs.map(o=>o.toString()));continue}t.queued>10&&(this.log.trace("wait for space in queue for %p",n.id),await t.onSizeLessThan(10,{signal:this.discoveryController.signal})),this.log("adding random peer %p to dial queue (length: %d, active %d)",n.id,t.size,t.running),t.add(this.dialPeer,{peerId:n.id,signal:this.discoveryController.signal}).catch(o=>{this.log.error("error opening connection to random peer %p - %e",n.id,o)})}this.log("stop random walk"),await t.onIdle()}).catch(e=>{this.discoveryController.signal.aborted||this.log.error("failed when finding relays on the network - %e",e)}))}stopDiscovery(){this.log("stop discovery"),this.running=!1,this.discoveryController?.abort(),this.queue?.clear(),this.components.events.removeEventListener("peer:discovery",this.onPeer)}onPeer(e){this.log.trace("maybe dialing discovered peer %p",e.detail.id),this.maybeDialPeer(e).catch(t=>{this.log.trace("error dialing discovered peer %p - %e",e.detail.id,t)})}async maybeDialPeer(e){if(this.queue==null)return;let t=e.detail.id,n=e.detail.multiaddrs;if(this.queue.has(t)){this.log.trace("random peer %p was already in queue",t);return}if(this.components.connectionManager.getConnections(t)?.length>0){this.log.trace("random peer %p was already connected",t);return}if(!await this.components.connectionManager.isDialable(n)){this.log.trace("random peer %p was not dialable",t);return}this.queue?.add(this.dialPeer,{peerId:e.detail.id,signal:this.discoveryController.signal}).catch(o=>{this.log.error("error opening connection to discovered peer %p - %e",e.detail.id,o)})}async dialPeer({peerId:e,signal:t}){let n=De([AbortSignal.timeout(5e3),t]);try{await this.components.connectionManager.openConnection(e,{signal:n})}finally{n.clear()}}};function oP(r){let e=r.metadata.get("last-dial-success");return e==null?0:new Date(j(e)).getTime()}var eb=class extends _e{connectionManager;addressManager;reservationStore;listeningAddrs;log;listenTimeout;reservationId;relay;constructor(e,t={}){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:transport:listener"),this.connectionManager=e.connectionManager,this.addressManager=e.addressManager,this.reservationStore=e.reservationStore,this.listeningAddrs=[],this.listenTimeout=t.listenTimeout??Sy,this.reservationStore.addEventListener("relay:removed",this._onRemoveRelayPeer),this.reservationStore.addEventListener("relay:created-reservation",this._onAddRelayPeer)}_onRemoveRelayPeer=e=>{this.log("relay removed %p our relay %p",e.detail.relay,this.relay,this.relay?.equals(e.detail.relay)),this.relay?.equals(e.detail.relay)===!0&&(this.log("relay peer removed %p",e.detail.relay),this.listeningAddrs.forEach(t=>{this.addressManager.removeObservedAddr(t)}),this.listeningAddrs=[],this.safeDispatchEvent("listening"))};_onAddRelayPeer=e=>{let{details:t}=e.detail;t.type!=="configured"&&t.id===this.reservationId&&this.addedRelay(e.detail)};async listen(e){if(ky.exactMatch(e))this.log("searching for circuit relay servers"),this.reservationId=this.reservationStore.reserveRelay();else if(Py.exactMatch(e)){this.log("listen on specific relay server %a",e);let t=AbortSignal.timeout(this.listenTimeout);let n=e.decapsulate("/p2p-circuit"),o=await this.connectionManager.openConnection(n,{signal:t});if(!this.reservationStore.hasReservation(o.remotePeer)){this.log("making reservation on peer %p",o.remotePeer);let i=await this.reservationStore.addRelay(o.remotePeer,"configured");this.addedRelay(i)}}else throw new Ka(`Could not listen on p2p-circuit address "${e}"`)}getAddrs(){return[...this.listeningAddrs.values()].flat()}updateAnnounceAddrs(){}async close(){this.reservationStore.cancelReservations(),this.listeningAddrs=[],this.reservationStore.removeEventListener("relay:removed",this._onRemoveRelayPeer),queueMicrotask(()=>{this.safeDispatchEvent("close")})}addedRelay(e){this.log("relay peer added %p",e.relay),this.relay=e.relay,this.listeningAddrs=e.details.reservation.addrs.map(t=>ie(t).encapsulate("/p2p-circuit")),this.listeningAddrs.forEach(t=>{this.addressManager.confirmObservedAddr(t,{type:"transport"})}),queueMicrotask(()=>{this.safeDispatchEvent("listening")})}};function iP(r){return new eb(r)}var sP="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";var aP=(r=21)=>{let e="",t=crypto.getRandomValues(new Uint8Array(r|=0));for(;r--;)e+=sP[t[r]&63];return e};var WV=60*1e3*10,zV=60*1e3*5,GV=30*1e3,Ry=class extends _e{peerId;connectionManager;peerStore;events;reserveQueue;reservations;pendingReservations;maxReservationQueueLength;reservationCompletionTimeout;started;log;relayFilter;constructor(e,t){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:transport:reservation-store"),this.peerId=e.peerId,this.connectionManager=e.connectionManager,this.peerStore=e.peerStore,this.events=e.events,this.reservations=new $r,this.pendingReservations=[],this.maxReservationQueueLength=t?.maxReservationQueueLength??tP,this.reservationCompletionTimeout=t?.reservationCompletionTimeout??Sy,this.started=!1,this.relayFilter=Fr(100),this.reserveQueue=new vr({concurrency:t?.reservationConcurrency??eP,metricName:"libp2p_relay_reservation_queue",metrics:e.metrics}),this.events.addEventListener("connection:close",n=>{[...this.reservations.values()].find(i=>i.connection===n.detail.id)!=null&&this.#t(n.detail.remotePeer).catch(i=>{this.log("could not remove relay %p - %e",n.detail,i)})})}isStarted(){return this.started}start(){this.started=!0}afterStart(){Promise.resolve().then(async()=>{let e=await this.peerStore.all({filters:[t=>t.tags.has(lp)]});this.log("removing tag from %d old relays",e.length),await Promise.all(e.map(async t=>{await this.peerStore.merge(t.id,{tags:{[lp]:void 0}})})),this.log("redialing %d old relays",e.length),await Promise.all(e.map(async t=>this.addRelay(t.id,"discovered"))),this.#r()}).catch(e=>{this.log.error("failed to clean up and redial old relays during afterStart - %e",e)})}stop(){this.reserveQueue.clear(),this.reservations.forEach(({timeout:e})=>{clearTimeout(e)}),this.reservations.clear(),this.started=!1}reserveRelay(){let e=aP();return this.pendingReservations.push(e),this.#r(),e}async addRelay(e,t){if(this.peerId.equals(e))throw this.log.trace("not trying to use self as relay"),new Ka("Cannot use self as relay");if(this.reserveQueue.size>this.maxReservationQueueLength)throw new Cy("The reservation queue is full");let n=this.reserveQueue.find(e);if(n!=null)return this.log.trace("potential relay peer %p is already in the reservation queue",e),n.join();if(this.relayFilter.has(e.toMultihash().bytes))throw new Ka("The relay was previously invalid");return this.log.trace("try to reserve relay slot with %p",e),this.reserveQueue.add(async()=>{let o=Date.now();try{let i=this.reservations.get(e);if(i!=null){let m=this.connectionManager.getConnections(e),w=!1;if(m.length===0&&this.log("already have relay reservation with %p but we are no longer connected",e),m.map(y=>y.id).includes(i.connection)&&(this.log("already have relay reservation with %p and the original connection is still open",e),w=!0),w&&J7(i.reservation.expire)>WV)return this.log("already have relay reservation with %p but we are still connected and it does not expire soon",e),{relay:e,details:i};await this.#t(e)}if(t==="discovered"&&this.pendingReservations.length===0)throw new up("Not making reservation on discovered relay because we do not need any more relays");let s=AbortSignal.timeout(this.reservationCompletionTimeout);let a=await this.connectionManager.openConnection(e,{signal:s});if(fr.matches(a.remoteAddr))throw new Iy("not creating reservation over relayed connection");let c=await this.#e(a,{signal:s}),l=J7(c.expire);this.log("created reservation on relay peer %p, expiry date is %s",e,new Date(Date.now()+l).toString());let f=Math.min(Math.max(l-zV,GV),Math.pow(2,31)-1),u=setTimeout(()=>{this.log("refresh reservation to relay %p",e),this.addRelay(e,t).catch(async m=>{this.log.error("could not refresh reservation to relay %p - %e",e,m),await this.#t(e)}).catch(m=>{this.log.error("could not remove expired reservation to relay %p - %e",e,m)})},f),d;if(t==="discovered"){let m=this.pendingReservations.pop();if(m==null)throw new up("Made reservation on relay but did not need any more discovered relays");d={timeout:u,reservation:c,type:t,connection:a.id,id:m}}else d={timeout:u,reservation:c,type:t,connection:a.id};this.reservations.set(e,d),await this.peerStore.merge(e,{tags:{[lp]:{value:1,ttl:l}}}),this.#r();let h={relay:e,details:d};return this.safeDispatchEvent("relay:created-reservation",{detail:h}),h}catch(i){throw t==="discovered"&&i.name==="HadEnoughRelaysError"||this.log.error("could not reserve slot on %p after %dms - %e",e,Date.now()-o,i),(i.name==="DialError"||i.name==="UnsupportedProtocolError")&&this.relayFilter.add(e.toMultihash().bytes),this.#t(e).catch(s=>{this.log.error("could not remove reservation on %p after reserving slot failed - %e",e,s)}),i}},{peerId:e})}hasReservation(e){return this.reservations.has(e)}getReservation(e){return this.reservations.get(e)?.reservation}reservationCount(e){return e==null?this.reservations.size:[...this.reservations.values()].reduce((t,n)=>(n.type===e&&t++,t),0)}cancelReservations(){[...this.reservations.values()].forEach(e=>{clearTimeout(e.timeout)}),this.reservations.clear()}async#e(e,t){t.signal?.throwIfAborted(),this.log("requesting reservation from %p",e.remotePeer);let n=await e.newStream(Qc,t),i=bt(n).pb(sa);this.log.trace("send RESERVE to %p",e.remotePeer),await i.write({type:sa.Type.RESERVE},t);let s;try{this.log.trace("reading response from %p",e.remotePeer),s=await i.read(t)}catch(c){throw n.abort(c),c}finally{n.status!=="closed"&&await n.close(t)}if(this.log.trace("read response %s",s.status),s.status===_r.OK&&s.reservation!=null){let c=new Set;c.add(e.remoteAddr.toString());for(let l of s.reservation.addrs){let f=ie(l);f.getComponents().find(u=>u.code===421)==null&&(f=f.encapsulate(`/p2p/${e.remotePeer}`)),f=ie(f.toString().replace(`/p2p/${e.remotePeer}/p2p/${e.remotePeer}`,`/p2p/${e.remotePeer}`)),c.add(f.toString())}return s.reservation.addrs=[...c].map(l=>ie(l).bytes),s.reservation}let a=`reservation failed with status ${s.status??"undefined"}`;throw this.log.error(a),new Error(a)}async#t(e){let t=this.reservations.get(e);t!=null&&(this.log("removing relay reservation with %p from local store",e),clearTimeout(t.timeout),this.reservations.delete(e),t.type==="discovered"&&this.pendingReservations.push(t.id),await this.peerStore.merge(e,{tags:{[lp]:void 0}}),this.safeDispatchEvent("relay:removed",{detail:{relay:e,details:t}}),this.#r())}#r(){if(this.pendingReservations.length===0){this.log.trace("have discovered enough relays"),this.reserveQueue.clear(),this.safeDispatchEvent("relay:found-enough-relays");return}this.relayFilter=Fr(100),this.log("not discovered enough relays %d/%d",this.reservations.size,this.pendingReservations.length),this.safeDispatchEvent("relay:not-enough-relays")}};var tb=class extends Hs{stream;init;constructor(e){super({...e,direction:e.stream.direction}),this.init=e,this.stream=e.stream,this.stream.addEventListener("close",t=>{this.onTransportClosed(t.error)}),this.stream.addEventListener("remoteCloseWrite",t=>{this.onRemoteCloseWrite(),this.close().catch(n=>{this.abort(n)})}),this.stream.addEventListener("message",t=>{e.onDataRead?.(t.data),this.onData(t.data)}),this.stream.addEventListener("drain",()=>{this.safeDispatchEvent("drain")})}sendData(e){return this.init.onDataWrite?.(e),{sentBytes:e.byteLength,canSendMore:this.stream.send(e)}}async sendClose(e){await this.stream.close(e)}sendReset(){this.stream.abort(new Error("An error occurred"))}sendPause(){this.stream.pause()}sendResume(){this.stream.resume()}};function rb(r){return new tb(r)}var XV=r=>{if(r.peer==null)return!1;try{r.peer.addrs.forEach(ie)}catch{return!1}return!0},cP={maxInboundStopStreams:Q7,maxOutboundStopStreams:Q7,stopTimeout:3e4},Dy=class{components;discovery;reservationStore;maxInboundStopStreams;maxOutboundStopStreams;started;log;shutdownController;constructor(e,t={}){this.components=e,this.log=e.logger.forComponent("libp2p:circuit-relay:transport"),this.maxInboundStopStreams=t.maxInboundStopStreams??cP.maxInboundStopStreams,this.maxOutboundStopStreams=t.maxOutboundStopStreams??cP.maxOutboundStopStreams,this.shutdownController=new AbortController,this.discovery=new Oy(e,{filter:t.discoveryFilter??gw(rP,nP)}),this.discovery.addEventListener("relay:discover",n=>{this.reservationStore.addRelay(n.detail,"discovered").catch(o=>{o.name!=="HadEnoughRelaysError"&&o.name!=="RelayQueueFullError"&&this.log.error("could not add discovered relay %p - %e",n.detail,o)})}),this.reservationStore=new Ry(e,t),this.reservationStore.addEventListener("relay:not-enough-relays",()=>{this.discovery?.startDiscovery()}),this.reservationStore.addEventListener("relay:found-enough-relays",()=>{this.discovery?.stopDiscovery()}),this.started=!1,this.onStop=this.onStop.bind(this)}[Symbol.toStringTag]="@libp2p/circuit-relay-v2-transport";[qe]=["@libp2p/transport","@libp2p/circuit-relay-v2-transport"];get[An](){return this.discovery!=null?["@libp2p/identify"]:[]}[Os]=!0;isStarted(){return this.started}async start(){this.shutdownController=new AbortController,this.shutdownController.signal,await this.components.registrar.handle(Y7,this.onStop,{maxInboundStreams:this.maxInboundStopStreams,maxOutboundStreams:this.maxOutboundStopStreams,runOnLimitedConnection:!0}),await er(this.discovery,this.reservationStore),this.started=!0}async stop(){this.shutdownController.abort(),await or(this.discovery,this.reservationStore),await this.components.registrar.unhandle(Y7),this.started=!1}async dial(e,t){let n=e.toString().split("/p2p-circuit"),o=ie(n[0]),i=ie(n[n.length-1]),s=o.getComponents().find(h=>h.code===421)?.value,a=i.getComponents().find(h=>h.code===421)?.value;if(s==null||a==null){let h=`ircuit relay dial to ${e.toString()} failed as address did not have both relay and destination PeerIDs`;throw this.log.error(`c${h}`),new Ps(`C${h}`)}let c=yt(s),l=yt(a),u=this.components.connectionManager.getConnections(c)[0];u==null?(await this.components.peerStore.merge(c,{multiaddrs:[o]}),t.onProgress?.(new oe("circuit-relay:open-connection")),u=await this.components.connectionManager.openConnection(c,t)):t.onProgress?.(new oe("circuit-relay:reuse-connection"));let d;try{t.onProgress?.(new oe("circuit-relay:open-hop-stream")),d=await u.newStream(Qc,t);let h=bt(d).pb(sa);t.onProgress?.(new oe("circuit-relay:write-connect-message")),await h.write({type:sa.Type.CONNECT,peer:{id:l.toMultihash().bytes,addrs:[ie(i).bytes]}},t),t.onProgress?.(new oe("circuit-relay:read-connect-response"));let m=await h.read(t);if(m.status!==_r.OK)throw new Be(`failed to connect via relay with status ${m?.status?.toString()??"undefined"}`);let w=new fp(m.limit),y=rb({stream:h.unwrap().unwrap(),remoteAddr:e,localAddr:o.encapsulate(`/p2p-circuit/p2p/${this.components.peerId.toString()}`),onDataRead:w.onData,onDataWrite:w.onData,log:d.log.newScope("circuit-relay:connection")}),b=await this.components.upgrader.upgradeOutbound(y,{...t,limits:w.getLimits()});return b.log("outbound relayed connection established to %p with limits %o, over connection %s",b.remotePeer,m.limit??"none",u.id),b}catch(h){throw this.log.error("circuit relay dial to destination %p via relay %p failed - %e",l,c,h),d?.abort(h),h}}createListener(e){return iP({peerId:this.components.peerId,connectionManager:this.components.connectionManager,addressManager:this.components.addressManager,reservationStore:this.reservationStore,logger:this.components.logger})}listenFilter(e){return e=Array.isArray(e)?e:[e],e.filter(t=>Py.exactMatch(t)||ky.exactMatch(t))}dialFilter(e){return e=Array.isArray(e)?e:[e],e.filter(t=>fr.exactMatch(t))}async onStop(e,t){let n=this.components.upgrader.createInboundAbortSignal(this.shutdownController.signal);try{if(!this.reservationStore.hasReservation(t.remotePeer))try{this.log("dialed via relay we did not have a reservation on, start listening on that relay address"),await this.components.transportManager.listen([t.remoteAddr.encapsulate("/p2p-circuit")])}catch(u){this.log.error("failed to listen on a relay peer we were dialed via but did not have a reservation on - %e",u)}let o=bt(e).pb(pi),i=await o.read({signal:n});if(this.log("new circuit relay v2 stop stream from %p with type %s",t.remotePeer,i.type),i?.type===void 0){this.log.error("type was missing from circuit v2 stop protocol request from %s",t.remotePeer),await o.write({type:pi.Type.STATUS,status:_r.MALFORMED_MESSAGE},{signal:n}),await e.close({signal:n});return}if(i.type!==pi.Type.CONNECT){this.log.error("invalid stop connect request via peer %p",t.remotePeer),await o.write({type:pi.Type.STATUS,status:_r.UNEXPECTED_MESSAGE},{signal:n}),await e.close({signal:n});return}if(!XV(i)){this.log.error("invalid stop connect request via peer %p",t.remotePeer),await o.write({type:pi.Type.STATUS,status:_r.MALFORMED_MESSAGE},{signal:n}),await e.close({signal:n});return}let s=zt(lt(i.peer.id));if(await this.components.connectionGater.denyInboundRelayedConnection?.(t.remotePeer,s)===!0){this.log.error("connection gater denied inbound relayed connection from %p",t.remotePeer),await o.write({type:pi.Type.STATUS,status:_r.PERMISSION_DENIED},{signal:n}),await e.close({signal:n});return}this.log.trace("sending success response to %p",t.remotePeer),await o.write({type:pi.Type.STATUS,status:_r.OK},{signal:n});let a=new fp(i.limit),c=t.remoteAddr.encapsulate(`/p2p-circuit/p2p/${s.toString()}`),l=this.components.addressManager.getAddresses()[0],f=rb({stream:o.unwrap().unwrap(),remoteAddr:c,localAddr:l,onDataRead:a.onData,onDataWrite:a.onData,log:e.log.newScope("circuit-relay:connection")});await this.components.upgrader.upgradeInbound(f,{limits:a.getLimits(),signal:n}),f.log("inbound relayed connection established to %p with limits %o, over connection %s",s,i.limit??"none",t.id)}finally{n?.clear()}}};function lP(r={}){return e=>new Dy(e,r)}var Fo;(function(r){let e;(function(o){o.UNUSED="UNUSED",o.CONNECT="CONNECT",o.SYNC="SYNC"})(e=r.Type||(r.Type={}));let t;(function(o){o[o.UNUSED=0]="UNUSED",o[o.CONNECT=100]="CONNECT",o[o.SYNC=300]="SYNC"})(t||(t={})),(function(o){o.codec=()=>kt(t)})(e=r.Type||(r.Type={}));let n;r.codec=()=>(n==null&&(n=Ie((o,i,s={})=>{if(s.lengthDelimited!==!1&&i.fork(),o.type!=null&&(i.uint32(8),r.Type.codec().encode(o.type,i)),o.observedAddresses!=null)for(let a of o.observedAddresses)i.uint32(18),i.bytes(a);s.lengthDelimited!==!1&&i.ldelim()},(o,i,s={})=>{let a={observedAddresses:[]},c=i==null?o.len:o.pos+i;for(;o.pos<c;){let l=o.uint32();switch(l>>>3){case 1:{a.type=r.Type.codec().decode(o);break}case 2:{if(s.limits?.observedAddresses!=null&&a.observedAddresses.length===s.limits.observedAddresses)throw new dt('Decode error - map field "observedAddresses" had too many elements');a.observedAddresses.push(o.bytes());break}default:{o.skipType(l&7);break}}}return a})),n),r.encode=o=>Te(o,r.codec()),r.decode=(o,i)=>Ae(o,r.codec(),i)})(Fo||(Fo={}));function nb(r,e){return fr.matches(r)||e.dialTransportForMultiaddr(r)==null?!1:C2.matches(r)?!0:iT.matches(r)?!Mt(r):!1}var uP=1024*4,fP=100,Ny={timeout:5e3,retries:3,maxInboundStreams:1,maxOutboundStreams:1},Ly=class{started;timeout;retries;maxInboundStreams;maxOutboundStreams;peerStore;registrar;connectionManager;addressManager;transportManager;topologyId;log;constructor(e,t){this.log=e.logger.forComponent("libp2p:dcutr"),this.started=!1,this.peerStore=e.peerStore,this.registrar=e.registrar,this.addressManager=e.addressManager,this.connectionManager=e.connectionManager,this.transportManager=e.transportManager,this.timeout=t.timeout??Ny.timeout,this.retries=t.retries??Ny.retries,this.maxInboundStreams=t.maxInboundStreams??Ny.maxInboundStreams,this.maxOutboundStreams=t.maxOutboundStreams??Ny.maxOutboundStreams,this.handleIncomingUpgrade=this.handleIncomingUpgrade.bind(this)}[Symbol.toStringTag]="@libp2p/dcutr";[An]=["@libp2p/identify"];isStarted(){return this.started}async start(){this.started||(this.topologyId=await this.registrar.register(dp,{notifyOnLimitedConnection:!0,onConnect:(e,t)=>{fr.exactMatch(t.remoteAddr)&&t.direction==="inbound"&&this.upgradeInbound(t).catch(n=>{this.log.error("error during outgoing DCUtR attempt - %e",n)})}}),await this.registrar.handle(dp,this.handleIncomingUpgrade,{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:!0}),this.started=!0)}async stop(){await this.registrar.unhandle(dp),this.topologyId!=null&&this.registrar.unregister(this.topologyId),this.started=!1}async upgradeInbound(e){if(await this.attemptUnilateralConnectionUpgrade(e))return;let t;for(let n=0;n<this.retries;n++){let o={signal:AbortSignal.timeout(this.timeout)};try{t=await e.newStream([dp],{signal:o.signal,runOnLimitedConnection:!0});let i=bt(t,{maxDataLength:uP}).pb(Fo);this.log("B sending connect to %p",e.remotePeer);let s=Date.now();await i.write({type:Fo.Type.CONNECT,observedAddresses:this.addressManager.getAddresses().map(u=>u.bytes)},o),this.log("B receiving connect from %p",e.remotePeer);let a=await i.read(o);if(a.type!==Fo.Type.CONNECT)throw this.log("A sent wrong message type"),new Be("DCUtR message type was incorrect");let c=this.getDialableMultiaddrs(a.observedAddresses);if(c.length===0)throw this.log("A did not have any dialable multiaddrs"),new Be("DCUtR connect message had no multiaddrs");let l=Date.now()-s;this.log("A sending sync, rtt %dms",l),await i.write({type:Fo.Type.SYNC,observedAddresses:[]},o),this.log("A waiting for half RTT"),await aA(l/2),this.log("B dialing",c);let f=await this.connectionManager.openConnection(c,{signal:o.signal,priority:fP,force:!0,initiator:!1});this.log("DCUtR to %p succeeded to address %a, closing relayed connection",e.remotePeer,f.remoteAddr),await e.close(o);break}catch(i){if(this.log.error("error while attempting DCUtR on attempt %d of %d - %e",n+1,this.retries,i),t?.abort(i),n===this.retries)throw i}finally{t!=null&&await t.close(o)}}}async attemptUnilateralConnectionUpgrade(e){let n=(await this.peerStore.get(e.remotePeer)).addresses.map(o=>{let i=o.multiaddr;return i.getComponents().find(s=>s.code===421)?.value==null?i.encapsulate(`/p2p/${e.remotePeer}`):i}).filter(o=>nb(o,this.transportManager));if(n.length>0){let o=AbortSignal.timeout(this.timeout);try{this.log("attempting unilateral connection upgrade to %a",n);let i=await this.connectionManager.openConnection(n,{signal:o,force:!0});if(fr.exactMatch(i.remoteAddr))throw new Error("Could not open a new, non-limited, connection");return this.log("unilateral connection upgrade to %p succeeded via %a, closing relayed connection",e.remotePeer,i.remoteAddr),await e.close({signal:o}),!0}catch(i){this.log.error("unilateral connection upgrade to %p on addresses %a failed - %e",e.remotePeer,n,i)}}else this.log("peer %p has no public addresses, not attempting unilateral connection upgrade",e.remotePeer);return!1}async handleIncomingUpgrade(e,t){let n={signal:AbortSignal.timeout(this.timeout)},o=bt(e,{maxDataLength:uP}).pb(Fo);this.log("A receiving connect");let i=await o.read(n);if(i.type!==Fo.Type.CONNECT)throw this.log("B sent wrong message type"),new Be("DCUtR message type was incorrect");if(i.observedAddresses.length===0)throw this.log("B sent no multiaddrs"),new Be("DCUtR connect message had no multiaddrs");let s=this.getDialableMultiaddrs(i.observedAddresses);if(s.length===0)throw this.log("B had no dialable multiaddrs in %o",i.observedAddresses.map(l=>ie(l))),new Be("DCUtR connect message had no dialable multiaddrs");if(this.log("A sending connect"),await o.write({type:Fo.Type.CONNECT,observedAddresses:this.addressManager.getAddresses().map(l=>l.bytes)}),this.log("A receiving sync"),(await o.read(n)).type!==Fo.Type.SYNC)throw new Be("DCUtR message type was incorrect");this.log("A dialing",s);let c=await this.connectionManager.openConnection(s,{signal:n.signal,priority:fP,force:!0});this.log("DCUtR to %p succeeded via %a, closing relayed connection",t.remotePeer,c.remoteAddr),await t.close(n),await e.close(n)}getDialableMultiaddrs(e){let t=[];for(let n of e)if(!(n==null||n.length===0))try{let o=ie(n);if(!nb(o,this.transportManager))continue;t.push(o)}catch{}return t}};var dp="/libp2p/dcutr";function dP(r={}){return e=>new Ly(e,r)}function ue(r){if(r!==void 0&&r!==ue.REQUEST&&r!==ue.RESPONSE)throw new Error("type must be REQUEST or RESPONSE");r===void 0||this.initialize(r),this.maxHeaderSize=ue.maxHeaderSize}ue.prototype.initialize=function(r,e){if(r!==ue.REQUEST&&r!==ue.RESPONSE)throw new Error("type must be REQUEST or RESPONSE");this.type=r,this.state=r+"_LINE",this.info={headers:[],upgrade:!1},this.trailers=[],this.line="",this.isChunked=!1,this.connection="",this.headerSize=0,this.body_bytes=null,this.isUserCall=!1,this.hadError=!1};ue.encoding="ascii";ue.maxHeaderSize=80*1024;ue.REQUEST="REQUEST";ue.RESPONSE="RESPONSE";var hP=ue.kOnHeaders=1,ob=ue.kOnHeadersComplete=2,By=ue.kOnBody=3,ib=ue.kOnMessageComplete=4;ue.prototype[hP]=ue.prototype[ob]=ue.prototype[By]=ue.prototype[ib]=function(){};var pP=!0;Object.defineProperty(ue,"kOnExecute",{get:function(){return pP=!1,99}});var mP=ue.methods=["DELETE","GET","HEAD","POST","PUT","CONNECT","OPTIONS","TRACE","COPY","LOCK","MKCOL","MOVE","PROPFIND","PROPPATCH","SEARCH","UNLOCK","BIND","REBIND","UNBIND","ACL","REPORT","MKACTIVITY","CHECKOUT","MERGE","M-SEARCH","NOTIFY","SUBSCRIBE","UNSUBSCRIBE","PATCH","PURGE","MKCALENDAR","LINK","UNLINK","SOURCE"],gP=mP.indexOf("CONNECT");ue.prototype.reinitialize=ue;ue.prototype.close=ue.prototype.pause=ue.prototype.resume=ue.prototype.remove=ue.prototype.free=function(){};ue.prototype._compatMode0_11=!1;ue.prototype.getAsyncId=function(){return 0};var YV={REQUEST_LINE:!0,RESPONSE_LINE:!0,HEADER:!0};ue.prototype.execute=function(r,e,t){if(!(this instanceof ue))throw new TypeError("not a HTTPParser");e=e||0,t=typeof t=="number"?t:r.length,this.chunk=r,this.offset=e;var n=this.end=e+t;try{for(;this.offset<n&&!this[this.state](););}catch(o){if(this.isUserCall)throw o;return this.hadError=!0,o}return this.chunk=null,t=this.offset-e,YV[this.state]&&(this.headerSize+=t,this.headerSize>(this.maxHeaderSize||ue.maxHeaderSize))?new Error("max header size exceeded"):t};var QV={REQUEST_LINE:!0,RESPONSE_LINE:!0,BODY_RAW:!0};ue.prototype.finish=function(){if(!this.hadError){if(!QV[this.state])return new Error("invalid state for EOF");this.state==="BODY_RAW"&&this.userCall()(this[ib]())}};ue.prototype.consume=ue.prototype.unconsume=ue.prototype.getCurrentBuffer=function(){};ue.prototype.userCall=function(){this.isUserCall=!0;var r=this;return function(e){return r.isUserCall=!1,e}};ue.prototype.nextRequest=function(){this.userCall()(this[ib]()),this.reinitialize(this.type)};ue.prototype.consumeLine=function(){for(var r=this.end,e=this.chunk,t=this.offset;t<r;t++)if(e[t]===10){var n=this.line+j(e.subarray(this.offset,t),ue.encoding);return n.charAt(n.length-1)==="\r"&&(n=n.substr(0,n.length-1)),this.line="",this.offset=t+1,n}this.line+=j(e.subarray(this.offset,this.end),ue.encoding),this.offset=this.end};var ZV=/^([^: \t]+):[ \t]*((?:.*[^ \t])|)/,JV=/^[ \t]+(.*[^ \t])/;ue.prototype.parseHeader=function(r,e){if(r.indexOf("\r")!==-1)throw My("HPE_LF_EXPECTED");var t=ZV.exec(r),n=t&&t[1];if(n)e.push(n),e.push(t[2]);else{var o=JV.exec(r);o&&e.length&&(e[e.length-1]&&(e[e.length-1]+=" "),e[e.length-1]+=o[1])}};var eH=/^([A-Z-]+) ([^ ]+) HTTP\/(\d)\.(\d)$/;ue.prototype.REQUEST_LINE=function(){var r=this.consumeLine();if(r){var e=eH.exec(r);if(e===null)throw My("HPE_INVALID_CONSTANT");if(this.info.method=this._compatMode0_11?e[1]:mP.indexOf(e[1]),this.info.method===-1)throw new Error("invalid request method");this.info.url=e[2],this.info.versionMajor=+e[3],this.info.versionMinor=+e[4],this.body_bytes=0,this.state="HEADER"}};var tH=/^HTTP\/(\d)\.(\d) (\d{3}) ?(.*)$/;ue.prototype.RESPONSE_LINE=function(){var r=this.consumeLine();if(r){var e=tH.exec(r);if(e===null)throw My("HPE_INVALID_CONSTANT");this.info.versionMajor=+e[1],this.info.versionMinor=+e[2];var t=this.info.statusCode=+e[3];this.info.statusMessage=e[4],((t/100|0)===1||t===204||t===304)&&(this.body_bytes=0),this.state="HEADER"}};ue.prototype.shouldKeepAlive=function(){if(this.info.versionMajor>0&&this.info.versionMinor>0){if(this.connection.indexOf("close")!==-1)return!1}else if(this.connection.indexOf("keep-alive")===-1)return!1;return!!(this.body_bytes!==null||this.isChunked)};ue.prototype.HEADER=function(){var r=this.consumeLine();if(r!==void 0){var e=this.info;if(r)this.parseHeader(r,e.headers);else{for(var t=e.headers,n=!1,o,i=!1,s=0;s<t.length;s+=2)switch(t[s].toLowerCase()){case"transfer-encoding":this.isChunked=t[s+1].toLowerCase()==="chunked";break;case"content-length":if(o=+t[s+1],n){if(o!==this.body_bytes)throw My("HPE_UNEXPECTED_CONTENT_LENGTH")}else n=!0,this.body_bytes=o;break;case"connection":this.connection+=t[s+1].toLowerCase();break;case"upgrade":i=!0;break}this.isChunked&&n&&(n=!1,this.body_bytes=null),i&&this.connection.indexOf("upgrade")!=-1?e.upgrade=this.type===ue.REQUEST||e.statusCode===101:e.upgrade=e.method===gP,this.isChunked&&e.upgrade&&(this.isChunked=!1),e.shouldKeepAlive=this.shouldKeepAlive();var a;if(pP?a=this.userCall()(this[ob](e)):a=this.userCall()(this[ob](e.versionMajor,e.versionMinor,e.headers,e.method,e.url,e.statusCode,e.statusMessage,e.upgrade,e.shouldKeepAlive)),a===2)return this.nextRequest(),!0;if(this.isChunked&&!a)this.state="BODY_CHUNKHEAD";else{if(a||this.body_bytes===0)return this.nextRequest(),e.upgrade;this.body_bytes===null?this.state="BODY_RAW":this.state="BODY_SIZED"}}}};ue.prototype.BODY_CHUNKHEAD=function(){var r=this.consumeLine();r!==void 0&&(this.body_bytes=parseInt(r,16),this.body_bytes?this.state="BODY_CHUNK":this.state="BODY_CHUNKTRAILERS")};ue.prototype.BODY_CHUNK=function(){var r=Math.min(this.end-this.offset,this.body_bytes);this.userCall()(this[By](this.chunk.slice(this.offset,this.offset+r),0,r)),this.offset+=r,this.body_bytes-=r,this.body_bytes||(this.state="BODY_CHUNKEMPTYLINE")};ue.prototype.BODY_CHUNKEMPTYLINE=function(){var r=this.consumeLine();if(r!==void 0){if(r!=="")throw new Error("Expected empty line");this.state="BODY_CHUNKHEAD"}};ue.prototype.BODY_CHUNKTRAILERS=function(){var r=this.consumeLine();r!==void 0&&(r?this.parseHeader(r,this.trailers):(this.trailers.length&&this.userCall()(this[hP](this.trailers,"")),this.nextRequest()))};ue.prototype.BODY_RAW=function(){this.userCall()(this[By](this.chunk.slice(this.offset,this.end),0,this.end-this.offset)),this.offset=this.end};ue.prototype.BODY_SIZED=function(){var r=Math.min(this.end-this.offset,this.body_bytes);this.userCall()(this[By](this.chunk.slice(this.offset,this.offset+r),0,r)),this.offset+=r,this.body_bytes-=r,this.body_bytes||this.nextRequest()};["Headers","HeadersComplete","Body","MessageComplete"].forEach(function(r){var e=ue["kOn"+r];Object.defineProperty(ue.prototype,"on"+r,{get:function(){return this[e]},set:function(t){return this._compatMode0_11=!0,gP="CONNECT",this[e]=t}})});function My(r){var e=new Error("Parse Error");return e.code=r,e}function yP(r){if(r!=null){if(typeof r[Symbol.iterator]=="function")return r[Symbol.iterator]();if(typeof r[Symbol.asyncIterator]=="function")return r[Symbol.asyncIterator]();if(typeof r.next=="function")return r}throw new Error("argument is not an iterator or iterable")}function sb(r,e={}){let t=yP(r),n={_cancelled:!1,async start(){this._cancelled=!1},async pull(o){try{let{value:i,done:s}=await t.next();if(this._cancelled)return;if(s===!0){o.close();return}o.enqueue(i)}catch(i){o.error(i)}},cancel(){this._cancelled=!0}};return new globalThis.ReadableStream(n,e)}var rH=r=>async e=>new Uint8Array(await crypto.subtle.digest(r,e)),wP=pd({name:"sha-1",code:17,encode:rH("SHA-1")});var Uy=class extends globalThis.Request{constructor(e,t={}){let n=t.method??"GET",o=mi(t),i=t.body;Fy(n,o)&&(t.method="UPGRADE"),super(e,t),Object.defineProperties(this,{body:{value:i,writable:!1},method:{value:n,writable:!1},headers:{value:o,writable:!1}})}};var bP={100:"Continue",101:"Switching Protocols",102:"Processing",103:"Early Hints",200:"OK",201:"Created",202:"Accepted",203:"Non-Authoritative Information",204:"No Content",205:"Reset Content",206:"Partial Content",207:"Multi-Status",208:"Already Reported",226:"IM Used",300:"Multiple Choices",301:"Moved Permanently",302:"Found",303:"See Other",304:"Not Modified",305:"Use Proxy",307:"Temporary Redirect",308:"Permanent Redirect",400:"Bad Request",401:"Unauthorized",402:"Payment Required",403:"Forbidden",404:"Not Found",405:"Method Not Allowed",406:"Not Acceptable",407:"Proxy Authentication Required",408:"Request Timeout",409:"Conflict",410:"Gone",411:"Length Required",412:"Precondition Failed",413:"Payload Too Large",414:"URI Too Long",415:"Unsupported Media Type",416:"Range Not Satisfiable",417:"Expectation Failed",418:"I'm a Teapot",421:"Misdirected Request",422:"Unprocessable Entity",423:"Locked",424:"Failed Dependency",425:"Too Early",426:"Upgrade Required",428:"Precondition Required",429:"Too Many Requests",431:"Request Header Fields Too Large",451:"Unavailable For Legal Reasons",500:"Internal Server Error",501:"Not Implemented",502:"Bad Gateway",503:"Service Unavailable",504:"Gateway Timeout",505:"HTTP Version Not Supported",506:"Variant Also Negotiates",507:"Insufficient Storage",508:"Loop Detected",509:"Bandwidth Limit Exceeded",510:"Not Extended",511:"Network Authentication Required"};var gi=class extends globalThis.Response{constructor(e,t={}){let n=mi(t),o=t.status??200;(o<200||o>599)&&(t.status=200),super(e,t),Object.defineProperties(this,{status:{value:o,writable:!1},statusText:{value:bP[o],writable:!1},headers:{value:n,writable:!1}})}};var nH=["dns","dns4","dns6","dnsaddr"];function pp(r,e){if(r instanceof URL)return r;let t=jy(r,e),{httpPath:n}=Ky(r);return new URL(`http://${t}${n}`)}function mp(r){return r instanceof Uint8Array?r:r instanceof DataView?new Uint8Array(r.buffer,r.byteOffset,r.byteLength):new Uint8Array(r,0,r.byteLength)}function xP(r,e){let t={method:r.method,headers:r.headers};if((t.method!=="GET"||r.upgrade)&&t.method!=="HEAD"){let n=e;r.upgrade||(n=iH(e,r.headers.get("content-length"))),t.body=sb(n),t.duplex="half"}return new Uy(ab(r).toString(),t)}async function EP(r,e){if(e.send(B([`HTTP/1.1 ${r.status} ${r.statusText}`,...$y(r.headers),"",""].join(`\r
`))),r.body==null){await e.close().catch(n=>{e.abort(n)});return}let t=r.body.getReader();for(;;){let n=await t.read();if(n.value!=null&&(e.send(n.value)||await e.onDrain()),n.done)break}await e.close().catch(n=>{e.abort(n)})}var SP=B(["HTTP/1.1 404 Not Found","Connection: close","",""].join(`\r
`)),oH=B(["HTTP/1.1 400 Bad Request","Connection: close","",""].join(`\r
`)),R6e=B(["HTTP/1.1 500 Internal Server Error","Connection: close","",""].join(`\r
`)),D6e=B(["HTTP/1.1 501 Not Implemented","Connection: close","",""].join(`\r
`));function $y(r){let e=[];r.get("Connection")==null&&r.set("Connection","close");for(let[t,n]of r.entries())e.push(`${t}: ${n}`);return e}async function*iH(r,e){if(e=parseInt(`${e??""}`),e==null||isNaN(e))return r;let t=0;for await(let n of r){if(t+=n.byteLength,t>e){yield n.subarray(0,t-e);return}if(yield n.subarray(),t===e)return}}function df(r,e){if(typeof r=="string"&&(r.startsWith("/")?r=ie(r):r=new URL(r)),on(r)&&(r=ie(`/p2p/${r}`)),r instanceof URL&&r.protocol==="multiaddr:"&&(r=X2(r.toString())),oi(r)&&(r=[r]),Array.isArray(r)){for(let t of r)if(t.getComponents().some(({name:o})=>o==="http")){let o=ea(t);return new URL(`${o}${e??""}`)}}return e==null?r:r instanceof URL?new URL(`${r}${e.substring(1)}`):r.map(t=>t.encapsulate(`/http-path/${encodeURIComponent(e.substring(1))}`))}function mi(r={}){return r.headers instanceof Headers||(r.headers=new Headers(r.headers)),r.headers}function hp(r){return r!=null&&r!==""}function jy(r,e){let t,n=80,o="http:";if(r instanceof URL&&(t=r.hostname,n=parseInt(r.port,10),o=r.protocol),hp(t)||(t=e.get("host")??void 0),!hp(t)&&Array.isArray(r))for(let i of r){let a=i.getComponents().filter(({name:c})=>nH.includes(c))?.[0]?.value;if(a!=null){t=a;break}}if(!hp(t)&&Array.isArray(r))for(let i of r){let s=i.getComponents().findLast(a=>a.code===421)?.value;try{let a=Ce(i);a.port!=null&&(n=a.port)}catch{}if(s!=null){t=yt(s).toCID().toString(Gn);break}}if(!hp(t)&&Array.isArray(r))for(let i of r)try{let s=Ce(i);s.host!=null&&(t=s.host);break}catch{}if(hp(t))return o==="http:"&&n!==80&&(t=`${t}:${n}`),o==="https:"&&n!==443&&(t=`${t}:${n}`),t;throw new P("Could not determine request host name - a request must have a host header, be made to a DNS or IP-based multiaddr or an http(s) URL")}function Ky(r){let e="/";return r=r.map(t=>ie(t.getComponents().filter(n=>n.name==="http-path"?(e=n.value??"/",!1):!0))),{httpPath:e,addresses:r}}function Vy(r,e=["GET"]){return r==null?e:(typeof r=="string"&&(r=[r]),r.map(t=>t.toUpperCase()))}function ab(r){let e=r.url??"/";if(e.startsWith("http"))return new URL(e);let t=sH(r);return new URL(`http://${t}${e}`)}function sH(r){let e=r.headers?.host;if(e==null&&(e=r.headers?.Host),e==null&&typeof r.headers.get=="function"&&(e=r.headers.get("host")),e==null)throw new P("Could not read host");return e}function Fy(r,e){return r==="GET"&&e.get("connection")?.toLowerCase()==="upgrade"&&e.get("upgrade")?.toLowerCase()==="websocket"}function vP(r,e){if(r instanceof Headers)return r.get(e)??void 0;let t=r[e];return Array.isArray(t)?t.join(","):t}async function cb(r){if(vP(r,"sec-websocket-version")!=="13")throw new ja("Invalid version");let e=vP(r,"sec-websocket-key");if(e==null)throw new ja("Missing sec-websocket-key");let t=`${e}258EAFA5-E914-47DA-95CA-C5AB0DC85B11`,n=await wP.digest(B(t)),o=ld.encode(n.digest).substring(1);return new Headers({Upgrade:"websocket",Connection:"upgrade","Sec-WebSocket-Accept":o})}async function _P(r,e){let t=new ue("REQUEST"),n=new fe,o;t[ue.kOnHeadersComplete]=i=>{let s=new Headers;for(let a=0;a<i.headers.length;a+=2)s.set(i.headers[a].toLowerCase(),i.headers[a+1]);o={...i,headers:s,raw:n,method:ue.methods[i.method]}};try{for(;;){let{data:i}=await Qr(r,"message",e?.signal),s=i.subarray(),a=t.execute(s,0,s.byteLength);if(a instanceof Error)throw a;if(n.append(s.subarray(0,a)),a<s.byteLength&&r.push(s.subarray(a)),o!=null)return o}}catch(i){r.abort(i)}finally{t.finish()}throw new Error("Failed to read header info from request")}var Hy=class extends Error{static name="InvalidResponseError";name="InvalidResponseError"};var aH=[101,204,205,304];async function AP(r,e,t){let n=Promise.withResolvers(),o=new TransformStream,i=o.writable.getWriter(),s=!1,a=new ue("RESPONSE");a.maxHeaderSize=t.maxHeaderSize??ue.maxHeaderSize,a[ue.kOnHeadersComplete]=l=>{t.log("response headers complete"),s=!0;let f=new Headers;for(let h=0;h<l.headers.length;h+=2)f.append(l.headers[h],l.headers[h+1]);let u=o.readable;aH.includes(l.statusCode)&&(o.writable.close().catch(()=>{}),o.readable.cancel().catch(()=>{}),u=null);let d=new gi(u,{status:l.statusCode,statusText:l.statusMessage,headers:f});n.resolve(d)},a[ue.kOnBody]=l=>{t.log("response read body %d bytes",l.byteLength),i.write(l).catch(f=>{n.reject(f)})},a[ue.kOnMessageComplete]=()=>{t.log("response message complete"),i.close().catch(l=>{n.reject(l)})};let c=0;return r.addEventListener("message",({data:l})=>{t.log("response stream read %d bytes",l.byteLength),c+=l.byteLength;let f=a.execute(l.subarray(),0,l.byteLength);f instanceof Error&&(r.abort(f),a.finish())}),r.addEventListener("remoteCloseWrite",()=>{s||n.reject(new Hy(`Response ended before headers were received, read ${c} bytes`)),a.finish()}),n.promise}function TP(r,e){return e.set("Content-Length",`${r.size}`),e.set("Content-Type",r.type!=null&&r.type!==""?r.type:"application/octet-stream"),r.stream()}function IP(r,e){return e.set("Content-Length",`${r.byteLength}`),e.set("Content-Type","application/octet-stream"),new ReadableStream({start(t){t.enqueue(mp(r)),t.close()}})}function cH(r,e,t){let n=[`--${t}`],o=0,i=2;return typeof e=="string"?(n.push(`Content-Disposition: form-data; name="${r}"`,'Content-Type: text/plain; charset="UTF-8"',`Content-Length: ${e.length}`,""),o=e.length+i):(n.push(`Content-Disposition: form-data; name="${r}"; filename="${encodeURIComponent(e.name)}"`,"Content-Type: application/octet-stream",`Content-Length: ${e.size}`,""),o=e.size+i),B(n.join(`\r
`)).byteLength+o}function CP(r,e){let t=`-----------------------------${crypto.randomUUID()}`;e.set("Content-Type",`multipart/form-data; boundary=${t}`);let n=0;for(let[c,l]of r.entries())n+=cH(c,l,t);e.set("Content-Length",`${n}`);let o=r.entries(),i;function s(c,l,f,u){let d=[`--${u}`];typeof f=="string"?d.push(`Content-Disposition: form-data; name="${l}"`,'Content-Type: text/plain; charset="UTF-8"',`Content-Length: ${f.length}`,"",f,""):(d.push(`Content-Disposition: form-data; name="${l}"; filename="${encodeURIComponent(f.name)}"`,"Content-Type: application/octet-stream",`Content-Length: ${f.size}`,""),i=f.stream().getReader()),c.enqueue(B(d.join(`\r
`)))}async function a(c,l){if(i!=null){let d=await i.read();d.value!=null&&c.enqueue(d.value),d.done&&(c.enqueue(B(`\r
`)),i=void 0);return}let{done:f,value:u}=o.next();if(u!=null){let[d,h]=u;s(c,d,h,l)}f===!0&&c.close()}return new ReadableStream({async pull(c){await a(c,t)}})}function PP(r,e){e.set("Content-Type","application/octet-stream"),e.set("Transfer-Encoding","chunked");let t=r.getReader();return new ReadableStream({async pull(n){let{done:o,value:i}=await t.read();i!=null&&(n.enqueue(B(`${i.byteLength}\r
`)),n.enqueue(i),n.enqueue(B(`\r
`))),o&&(n.enqueue(B(`0\r
\r
`)),n.close())}})}function lb(r,e){return e.set("Content-Length",`${r.length}`),e.set("Content-Type",'text/plain; charset="UTF-8"'),new ReadableStream({start(t){t.enqueue(B(r)),t.close()}})}function kP(r,e){if(r!=null){if(typeof r=="string")return lb(r,e);if(r instanceof Blob)return TP(r,e);if(lH(r))return IP(r,e);if(r instanceof URLSearchParams)return lb(r.toString(),e);if(r instanceof ReadableStream)return PP(r,e);if(r instanceof FormData)return CP(r,e);throw new Error("Unsupported body type")}}function lH(r){return r==null?!1:r.byteLength!=null}async function OP(r,e,t){let n=new Headers(t.headers),o=n.get("host")??e.hostname;n.set("host",o),n.get("user-agent")==null&&n.set("user-agent","libp2p/fetch");let i=kP(t.body,n),s=[`${t?.method?.toUpperCase()??"GET"} ${e.pathname??"/"} HTTP/1.1`,...$y(n),"",""];r.send(B(s.join(`\r
`)))||await r.onDrain({signal:t.signal??void 0}),i!=null&&(t.log("request sending body"),await uH(r,i,t))}async function uH(r,e,t){let n=e.getReader();for(;;){let{done:o,value:i}=await n.read();if(i!=null&&(t.log("request send %d bytes",i.byteLength),r.send(i)||await r.onDrain({signal:t.signal??void 0})),o){t.log("request finished sending body");break}}}async function RP(r,e,t={}){let n=r.log.newScope("http-fetch");e=typeof e=="string"?new URL(e):e;let[o]=await Promise.all([AP(r,e,{...t,log:n}),OP(r,e,{...t,log:n})]);return await r.close({signal:t.signal??void 0}),o}var qy=class extends Event{message;error;filename="";lineno=0;colno=0;constructor(e){super("error"),this.error=e,this.message=e.message}},gp=class extends Event{code;reason;wasClean;constructor(e,t){super(e),this.code=t?.code??0,this.reason=t?.reason??"",this.wasClean=t?.wasClean??!0}};var fH={CONTINUATION:0,TEXT:1,BINARY:2,CONNECTION_CLOSE:8,PING:9,PONG:10},ub={0:"CONTINUATION",1:"TEXT",2:"BINARY",8:"CONNECTION_CLOSE",9:"PING",10:"PONG"};var yp={NORMAL_CLOSURE:1e3,GOING_AWAY:1001,PROTOCOL_ERROR:1002,UNSUPPORTED_DATA:1003,RESERVED:1004,NO_STATUS_RECEIVED:1005,ABNORMAL_CLOSURE:1006,INVALID_FRAME_PAYLOAD_DATA:1007,POLICY_VIOLATION:1008,MESSAGE_TOO_BIG:1009,MANDATORY_EXT:1010,INTERNAL_SERVER_ERROR:1011,TLS_HANDSHAKE:1015};function DP(r){let e=0;if(r.byteLength<e+1)return;let n=r.get(e)&15;if(e++,ub[n]==null)throw new Error(`Unknown opcode: ${n}`);if(r.byteLength<e+1)return;let o=r.get(e),i=(o&128)===128,s=o&127;if(e++,s===126){if(r.byteLength<e+2)return;s=r.getUint16(e),e+=2}else if(s===127){if(r.byteLength<e+8)return;s=r.getUint32(e),e+=8}if(s===0)return r.consume(e),{type:ub[n]};let a;if(i){if(r.byteLength<e+4)return;a=r.subarray(e,e+4),e+=4}if(r.byteLength<e+s)return;let c=r.subarray(e,e+s);return e+=s,a!=null&&(c=NP(c,a)),r.consume(e),{type:ub[n],data:c}}function NP(r,e){let t=0;for(let n=0;n<r.byteLength;n++)r[n]=r[n]^e[t],t++,t===e.byteLength&&(t=0);return r}function LP(r,e,t){let o=new fe(Uint8Array.from([128|fH[r]])),i=e?.byteLength??0;if(i<126)o.append(Uint8Array.from([i|(t===!0?128:0)]));else if(i<65535){let s=new fe(new Uint8Array(3));s.set(0,126|(t===!0?128:0)),s.setUint16(1,i),o.append(s)}else if(i<18446744073709552e3){let s=new fe(new Uint8Array(9));s.set(0,127|(t===!0?128:0)),s.setUint32(1,i),o.append(s)}else throw new Error("Payload too large");if(t===!0&&e!=null){let s=Uint8Array.from([0,0,0,0]);o.append(s),e=NP(e,s)}return e!=null&&o.append(e),o}function BP(r){if(r instanceof Uint8Array||r instanceof ArrayBuffer||r instanceof DataView)return mp(r);if(typeof r=="string")return B(r);if(r instanceof Blob)return r.arrayBuffer().then(e=>mp(e));throw new P("Unsupported data type")}async function MP(r,e){return new Promise((t,n)=>{let o=!1,i=new ue("RESPONSE");i[ue.kOnHeadersComplete]=s=>{o=!0;let a=[];for(let c=0;c<s.headers.length;c+=2)a.push([s.headers[c],s.headers[c+1]]);t(new gi(null,{status:s.statusCode,statusText:s.statusMessage,headers:new Headers(a)}))},Promise.resolve().then(async()=>{for(;;){let{data:s}=await Qr(r,"message",e.signal),a=s.subarray(),c=i.execute(a,0,a.byteLength);if(c instanceof Error)throw c;if(c<a.byteLength&&r.push(a.subarray(c)),o)break}}).catch(s=>{n(s)})})}async function*UP(r,e=[],t){let n=ld.encode(crypto.getRandomValues(new Uint8Array(16))).substring(1);t.set("host",r.hostname),t.set("connection","upgrade"),t.set("upgrade","websocket"),t.set("pragma","no-cache"),t.set("cache-control","no-cache"),t.set("sec-websocket-version","13"),t.set("sec-websocket-key",n),e.length>0&&t.set("sec-websocket-protocol",e.join(", ")),yield B([`GET ${r.pathname??"/"} HTTP/1.1`,...[...t.entries()].map(([o,i])=>`${o}: ${i}`),"",""].join(`\r
`))}var dH=["BINARY","TEXT","CONTINUATION"],hH=10485760;var pH="/http/1.1",Wy=class extends _e{binaryType="arraybuffer";bufferedAmount=0;extensions="";protocol="";readyState;url;CONNECTING=0;OPEN=1;CLOSING=2;CLOSED=3;_onclose;_onerror;_onmessage;_onopen;sentClose;isClient;buffer;maxMessageSize;_url;closeController;constructor(e,t={}){super(),this.readyState=this.CONNECTING,this.url=e.pathname,this.sentClose=!1,this.isClient=t.isClient??!0,this.buffer=new fe,this.closeController=new AbortController,this.maxMessageSize=t.maxMessageSize??hH}send(e){if(this.readyState!==this.OPEN)throw new Error("WebSocket was not open");let t=BP(e);e0(t)?t.then(n=>{this._send("BINARY",n)}).catch(n=>{this._errored(n)}):this._send("BINARY",t)}_send(e,t){if(this.readyState!==this.OPEN)return;let n=LP(e,t,this.isClient),o=n.byteLength;this.bufferedAmount+=o,this._write(n,i=>{this.bufferedAmount-=o,i!=null&&this._errored(i)})}close(e,t){if(this.readyState!==this.OPEN)throw new Error("WebSocket was not open");this.readyState=this.CLOSING,this.sentClose=!0,this._send("CONNECTION_CLOSE")}_errored(e){this.readyState=this.CLOSED,this.dispatchEvent(new qy(e))}set onclose(e){this._onclose=e,this.addEventListener("close",e)}get onclose(){return this._onclose??null}set onerror(e){this._onerror=e,this.addEventListener("error",e)}get onerror(){return this._onerror??null}set onmessage(e){this._onmessage=e,this.addEventListener("message",e)}get onmessage(){return this._onmessage??null}set onopen(e){this._onopen=e,this.addEventListener("open",e)}get onopen(){return this._onopen??null}_push(e){if(this.buffer.append(e),this.buffer.byteLength>this.maxMessageSize){this.close(yp.MESSAGE_TOO_BIG,"Max message size exceeded");return}for(;;){let t=DP(this.buffer);if(t==null)break;if(dH.includes(t.type)&&t.data!=null){let n;this.binaryType==="blob"?n=new Blob([t.data]):t.data.byteOffset===0&&t.data.byteLength===t.data.buffer.byteLength?n=t.data.buffer:(n=new ArrayBuffer(t.data.byteLength),new Uint8Array(n,0,n.byteLength).set(t.data)),this.dispatchEvent(new MessageEvent("message",{data:n,origin:this._url?.hostname}))}t.type==="PING"&&this._send("PONG",t.data),t.type==="CONNECTION_CLOSE"&&(this.sentClose||this.close(),this.closeController.abort(),this._close(void 0,()=>{this.readyState=this.CLOSED,this.dispatchEvent(new gp("close"))}))}}_remoteClosed(e){this.readyState=this.CLOSING,this._close(e,()=>{this.readyState=this.CLOSED,this.dispatchEvent(new gp("close"))})}};var wp=class extends Wy{writer;writable;constructor(e,t,n={}){if(super(new URL(e.url),{...n,isClient:!1}),e.body==null)throw new P("Request body cannot be null");this.readyState=this.OPEN,this.writable=t,this.writer=t.getWriter();let o=e.body.getReader();Promise.resolve().then(async()=>{for(this.dispatchEvent(new Event("open"));;){let{value:i,done:s}=await o.read();if(i!=null&&this._push(i),s){this._remoteClosed();break}}}).catch(i=>{this._errored(i)})}_write(e,t){this.writer?.write(e).then(()=>{t()},n=>{t(n)})}_close(e,t){e!=null?this.writable.abort(e).then(()=>{t()},()=>{t()}):this.writable.close().then(()=>{t()},()=>{t()})}},bp=class extends Wy{stream;handshakeTimeout;drainTimeout;constructor(e,t,n,o){super(t,{...o,isClient:!0}),this.handshakeTimeout=o.handshakeTimeout??1e4,this.drainTimeout=o.drainTimeout??1e4,Promise.resolve().then(async()=>{let i=AbortSignal.timeout(this.handshakeTimeout);this.stream=await n.openStream(e,pH,{...o,signal:i});for await(let a of UP(t,o.protocols,mi(o)))this.stream.send(a)||await this.stream.onDrain({signal:i});let s=await MP(this.stream,{signal:i});if(s.status!==101)throw new Error("Invalid WebSocket handshake - response status "+s.status);await o.onHandshakeResponse?.(s,{signal:i}),this.protocol=s.headers.get("Sec-WebSocket-Protocol")??"",this.readyState=this.OPEN,this.dispatchEvent(new Event("open"));for await(let a of this.stream)this._push(a)}).catch(i=>{this._errored(i)})}_write(e,t){if(this.stream==null){t(new Error("WebSocket was not open"));return}this.stream.send(e)?t():this.stream.onDrain({signal:AbortSignal.timeout(this.drainTimeout)}).then(()=>{t()},n=>{t(n)})}_close(e,t){if(this.stream==null){t();return}if(e!=null){this.stream.abort(e),t();return}this.stream.close().catch(n=>{this.stream?.abort(n)}).finally(()=>{t()})}};var vp="/http/1.1";var zy=Symbol.for("@libp2p/http/websocket-handler");var qP=nr(VP(),1),Xy=class{log;cookies;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:http:cookies"),this.cookies=new Map}async prepareRequest(e,t){if((t.credentials??"same-origin")==="omit")return;let o=t.headers.get("origin");if(o==null||o==="null")return;let i=pp(e,t.headers),s=(this.cookies.get(i.hostname)??[]).filter(a=>!(a.expires!=null&&a.expires<Date.now()||a.path!=null&&!i.pathname.startsWith(a.path))).map(a=>`${a.name}=${a.value}`).join("; ");s.length>0&&t.headers.set("cookie",s)}async processResponse(e,t,n){if((t.credentials??"same-origin")==="omit"){HP(n);return}let i=t.headers.get("origin");if(i==null||i==="null")return;let s=pp(e,t.headers);for(let a of n.headers.getSetCookie()){let c=[...this.cookies.get(s.hostname)??[],...SH(qP.default.parse(a))];this.cookies.set(s.hostname,c)}HP(n)}};function HP(r){return r.headers.has("set-cookie")&&r.headers.delete("set-cookie"),r}function SH(r){let e={},t=[];return Object.entries(r).forEach(([n,o])=>{n.toLowerCase()==="domain"&&o!=null&&(e.domain=o),n.toLowerCase()==="max-age"&&o!=null&&(e.expires=Date.now()+parseInt(o,10)*1e3),!_H.includes(n.toLowerCase())&&o!=null&&t.push({name:n,value:o})}),t.map(n=>({...n,...e}))}var _H=["domain","expires","httponly","max-age","partitioned","path","samesite","secure"];var Yy=class{async prepareRequest(e,t){if(t.headers.get("origin")!=null||t.mode==="no-cors")return;let n=pp(e,t.headers);t.headers.set("origin",`${n.protocol}//${n.host}`)}};function AH(r){return typeof r.init=="function"}function Qy(r,e){if(AH(r)){let t=r;return t.handler=r.init(e),delete t.init,t}return r}function WP(r){let e=Vy(r.method,["GET"]);if(r.fallback==null&&e.filter(n=>n!=="GET").length>0)throw new P("WebSocket handlers only support the GET HTTP method");let t={...r,init:n=>{let o=Qy(r,n);return t[zy]=o.handler,async i=>{if(!Fy(i.method,i.headers))return r?.fallback!=null?r.fallback(i):new gi(null,{status:400});let s=new TransformStream;try{let a=new gi(s.readable,{status:101,headers:await cb(i.headers)}),c=new wp(i,s.writable,r);return o.handler(c),a}catch{return new gi(null,{status:500})}}}};return t}var Zy="/.well-known/libp2p/protocols";function zP(r){return WP({path:Zy,method:["GET"],cors:!0,handler:e=>{let t=JSON.stringify(r.getProtocolMap());e.send(t),e.close()},fallback:async e=>{let t=JSON.stringify(r.getProtocolMap());return new Response(t,{headers:{"Content-Type":"application/json","Content-Length":`${t.length}`}})}})}var Jy=class{log;components;protocols;endpoint;constructor(e,t={}){this.components=e,this.log=e.logger.forComponent("libp2p:http:registrar"),this.protocols=[],this.onStream=this.onStream.bind(this),this.endpoint=t.server,this.handle("",zP(this))}async start(){await this.components.registrar.handle(vp,this.onStream.bind(this))}async stop(){await this.components.registrar.unhandle(vp)}async onStream(e,t){let n=await _P(e);if(this.canHandle(n)){this.log("handling incoming request %s %s",n.method,n.url);let o=await this.onRequest(xP(n,e));await EP(o,e),await e.close();return}if(this.endpoint==null){this.log("cannot handle incoming request %s %s and no endpoint configured",n.method,n.url),e.send(SP),await e.close();return}this.log("passing incoming request %s %s to endpoint",n.method,n.url),this.endpoint.inject(n,e,t).catch(o=>{this.log.error("error injecting request to endpoint - %e",o),e.abort(o)})}canHandle(e){let t=ab(e).pathname;return this.protocols.find(n=>n.route.path===t)!=null?(this.log.trace("can handle %s",t),!0):(this.log.trace("cannot handle %s",t),!1)}async onRequest(e){this.log("incoming request %s %s",e.method,e.url);let t=this.findHandler(e.url);if(t==null)return new Response(null,{status:404});let n;return t.route.method.includes(e.method)?n=await t.route.handler(e):e.method==="OPTIONS"?n=new Response(null,{status:204}):n=new Response(null,{status:405}),TH(n,e,t),this.log("%s %s %d %s",e.method,e.url,n.status,n.statusText),n}onWebSocket(e){let t=this.findHandler(e.url);if(t!=null){let n=t.route[zy];if(n!=null){n(e);return}}e.close(yp.NORMAL_CLOSURE)}findHandler(e){let t=e.startsWith("/")?e:new URL(e).pathname;this.log("search for handler on path %s",t);let n=this.protocols.find(o=>o.route.path===t);return n!=null&&this.log("found handler for HTTP protocol %s on path %s",n.protocol,e),n}handle(e,t){if(t.path=t.path??e,this.protocols.find(n=>n.protocol===e)!=null)throw new P(`HTTP protocol handler for ${e} already registered`);(t.path===""||!t.path.startsWith("/"))&&(t.path=`/${t.path}`),t.cors=t.cors??!0,t.method=Vy(t.method),t=Qy(t,this.components),this.protocols.push({protocol:e,route:t}),this.protocols.sort(({route:{path:n}},{route:{path:o}})=>o.length-n.length)}unhandle(e){this.protocols=this.protocols.filter(t=>t.protocol===e)}getProtocolMap(){let e={};for(let t of this.protocols)t.protocol!==""&&(e[t.protocol]={path:t.route.path});return e}};function TH(r,e,t){let n=[...new Set(["OPTIONS",...t.route.method])].join(", ");t.route.cors&&(e.headers.get("Access-Control-Request-Method")!=null&&r.headers.set("access-control-allow-methods",n),e.headers.get("Access-Control-Request-Headers")!=null&&r.headers.set("access-control-allow-headers",e.headers.get("Access-Control-Request-Headers")??""),e.headers.get("Origin")!=null&&(r.headers.set("access-control-allow-origin",e.headers.get("Origin")??""),r.headers.set("vary","Origin"))),e.method==="OPTIONS"&&r.headers.set("allow",n)}async function GP(r,e,t){for(let n of e.middleware)await n.prepareRequest?.(r,e);return t()}async function XP(r,e,t){for(let n of e.middleware)await n.prepareRequest?.(r,e);return t()}async function YP(r,e,t){for(let n of e.middleware)await n.processResponse?.(r,e,t);return t}var e3=class{log;components;httpRegistrar;origin;cookies;constructor(e,t={}){this.components=e,this.log=e.logger.forComponent("libp2p:http"),this.httpRegistrar=new Jy(e,t),this.origin=new Yy,this.cookies=new Xy(e,t)}[Symbol.toStringTag]="@libp2p/http";[qe]=["@libp2p/http"];async start(){await er(this.httpRegistrar)}async stop(){await or(this.httpRegistrar)}agent(...e){throw new id("This method is not supported in browsers")}dispatcher(...e){throw new id("This method is not supported in browsers")}async connect(e,t={}){let n=df(e),o=mi(t),i={...t,headers:o,method:"GET",middleware:t.middleware?.map(s=>s(this.components))??[]};return o.set("connection","upgrade"),o.set("upgrade","websocket"),XP(n,i,async()=>{if(n instanceof URL){let c=new globalThis.WebSocket(n,t.protocols);return c.binaryType="arraybuffer",c}let{addresses:s,httpPath:a}=Ky(n);return new bp(s,new URL(`http://${jy(n,i.headers)}${decodeURIComponent(a)}`),this.components.connectionManager,i)})}async fetch(e,t={}){let n=df(e),o={...t,headers:mi(t),method:"GET",middleware:[this.origin,this.cookies,...t.middleware?.map(s=>s(this.components))??[]]},i=await GP(n,o,async()=>this.sendRequest(n,t));return YP(n,o,i)}async connectProtocol(e,t,n){let o=await this.getProtocolPath(e,t,n),i=df(e,o);return this.connect(i,n)}async fetchProtocol(e,t,n={}){let o=await this.getProtocolPath(e,t,n),i=df(e,o);return this.fetch(i,n)}async getSupportedProtocols(e,t={}){let n=df(e,Zy),o=await this.fetch(n,{method:"GET",headers:{Accept:"application/json"},signal:t.signal});if(o.status!==200)throw new Error(`Unexpected status code: ${o.status}`);return o.json()}async getProtocolPath(e,t,n={}){let o=await this.getSupportedProtocols(e,n);if(o[t]==null)throw new Error(`Peer does not serve protocol: ${t}`);return o[t].path}canHandle(e){return this.httpRegistrar.canHandle(e)}async onRequest(e){return this.httpRegistrar.onRequest(e)}onWebSocket(e){this.httpRegistrar.onWebSocket(e)}handle(e,t){this.httpRegistrar.handle(e,t)}unhandle(e){this.httpRegistrar.unhandle(e)}getProtocolMap(){return this.httpRegistrar.getProtocolMap()}async sendRequest(e,t){if(e instanceof URL)return this.log("making request to %s with global fetch"),globalThis.fetch(e,t);this.log("making request to %s with libp2p fetch",e);let n=jy(e,mi(t)),{addresses:o,httpPath:i}=Ky(e),a=await(await this.components.connectionManager.openConnection(o,{signal:t.signal??void 0})).newStream(vp,{signal:t.signal??void 0});return RP(a,new URL(`http://${n}${decodeURIComponent(i)}`),t)}};function QP(r={}){return e=>new e3(e,r)}var ZP="0.1.0";var JP="id/push",ek="1.0.0",tk="1.0.0";var ca;(function(r){let e;r.codec=()=>(e==null&&(e=Ie((t,n,o={})=>{if(o.lengthDelimited!==!1&&n.fork(),t.protocolVersion!=null&&(n.uint32(42),n.string(t.protocolVersion)),t.agentVersion!=null&&(n.uint32(50),n.string(t.agentVersion)),t.publicKey!=null&&(n.uint32(10),n.bytes(t.publicKey)),t.listenAddrs!=null)for(let i of t.listenAddrs)n.uint32(18),n.bytes(i);if(t.observedAddr!=null&&(n.uint32(34),n.bytes(t.observedAddr)),t.protocols!=null)for(let i of t.protocols)n.uint32(26),n.string(i);t.signedPeerRecord!=null&&(n.uint32(66),n.bytes(t.signedPeerRecord)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={listenAddrs:[],protocols:[]},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 5:{i.protocolVersion=t.string();break}case 6:{i.agentVersion=t.string();break}case 1:{i.publicKey=t.bytes();break}case 2:{if(o.limits?.listenAddrs!=null&&i.listenAddrs.length===o.limits.listenAddrs)throw new dt('Decode error - map field "listenAddrs" had too many elements');i.listenAddrs.push(t.bytes());break}case 4:{i.observedAddr=t.bytes();break}case 3:{if(o.limits?.protocols!=null&&i.protocols.length===o.limits.protocols)throw new dt('Decode error - map field "protocols" had too many elements');i.protocols.push(t.string());break}case 8:{i.signedPeerRecord=t.bytes();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>Te(t,r.codec()),r.decode=(t,n)=>Ae(t,r.codec(),n)})(ca||(ca={}));var pn={protocolPrefix:"ipfs",timeout:5e3,maxInboundStreams:1,maxOutboundStreams:1,maxObservedAddresses:10,maxMessageSize:8192,runOnConnectionOpen:!0,runOnSelfUpdate:!0,runOnLimitedConnection:!0,concurrency:32};function rk(r){if(r!=null&&r.length>0)try{return ie(r)}catch{}}async function t3(r,e,t,n,o){if(t("received identify from %p",n.remotePeer),o==null)throw new Be("message was null or undefined");let i={};if(o.listenAddrs.length>0&&(i.addresses=o.listenAddrs.map(c=>({isCertified:!1,multiaddr:ie(c)}))),o.protocols.length>0&&(i.protocols=o.protocols),o.publicKey!=null){let c=Kt(o.publicKey);if(!si(c).equals(n.remotePeer))throw new Be("public key did not match remote PeerId");i.publicKey=c}let s;if(o.signedPeerRecord!=null){t.trace("received signedPeerRecord from %p",n.remotePeer);let c=o.signedPeerRecord,l=await Mn.openAndCertify(c,Zr.DOMAIN),f=Zr.createFromProtobuf(l.payload),u=Ro(l.publicKey.toCID());if(!f.peerId.equals(u))throw new Be("signing key does not match PeerId in the PeerRecord");if(!n.remotePeer.equals(f.peerId))throw new Be("signing key does not match remote PeerId");let d;try{d=await r.get(f.peerId)}catch(h){if(h.name!=="NotFoundError")throw h}if(d!=null&&(i.metadata=d.metadata,d.peerRecordEnvelope!=null)){let h=Mn.createFromProtobuf(d.peerRecordEnvelope),m=Zr.createFromProtobuf(h.payload);m.seqNumber>=f.seqNumber&&(t("sequence number was lower or equal to existing sequence number - stored: %d received: %d",m.seqNumber,f.seqNumber),f=m,c=d.peerRecordEnvelope)}i.peerRecordEnvelope=c,i.addresses=f.multiaddrs.map(h=>({isCertified:!0,multiaddr:h})),s={seq:f.seqNumber,addresses:f.multiaddrs}}else t("%p did not send a signed peer record",n.remotePeer);if(t.trace("patching %p with",n.remotePeer,i),await r.patch(n.remotePeer,i),o.agentVersion!=null||o.protocolVersion!=null){let c={};o.agentVersion!=null&&(c.AgentVersion=B(o.agentVersion)),o.protocolVersion!=null&&(c.ProtocolVersion=B(o.protocolVersion)),t.trace("merging %p metadata",n.remotePeer,c),await r.merge(n.remotePeer,{metadata:c})}let a={peerId:n.remotePeer,protocolVersion:o.protocolVersion,agentVersion:o.agentVersion,publicKey:o.publicKey,listenAddrs:o.listenAddrs.map(c=>ie(c)),observedAddr:o.observedAddr==null?void 0:ie(o.observedAddr),protocols:o.protocols,signedPeerRecord:s,connection:n};return e.safeDispatchEvent("peer:identify",{detail:a}),a}var hf=class{host;components;protocol;started;timeout;maxInboundStreams;maxOutboundStreams;maxMessageSize;maxObservedAddresses;runOnLimitedConnection;log;constructor(e,t){this.protocol=t.protocol,this.started=!1,this.components=e,this.log=t.log,this.timeout=t.timeout??pn.timeout,this.maxInboundStreams=t.maxInboundStreams??pn.maxInboundStreams,this.maxOutboundStreams=t.maxOutboundStreams??pn.maxOutboundStreams,this.maxMessageSize=t.maxMessageSize??pn.maxMessageSize,this.maxObservedAddresses=t.maxObservedAddresses??pn.maxObservedAddresses,this.runOnLimitedConnection=t.runOnLimitedConnection??pn.runOnLimitedConnection,this.host={protocolVersion:`${t.protocolPrefix??pn.protocolPrefix}/${ZP}`,agentVersion:e.nodeInfo.userAgent},this.handleProtocol=this.handleProtocol.bind(this)}isStarted(){return this.started}async start(){this.started||(await this.components.peerStore.merge(this.components.peerId,{metadata:{AgentVersion:B(this.host.agentVersion),ProtocolVersion:B(this.host.protocolVersion)}}),await this.components.registrar.handle(this.protocol,this.handleProtocol,{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:this.runOnLimitedConnection}),this.started=!0)}async stop(){await this.components.registrar.unhandle(this.protocol),this.started=!1}};var r3=class extends hf{connectionManager;concurrency;_push;constructor(e,t={}){super(e,{...t,protocol:`/${t.protocolPrefix??pn.protocolPrefix}/${JP}/${tk}`,log:e.logger.forComponent("libp2p:identify-push")}),this.connectionManager=e.connectionManager,this.concurrency=t.concurrency??pn.concurrency,this._push=ji(this.sendPushMessage.bind(this),t.debounce??1e3),(t.runOnSelfUpdate??pn.runOnSelfUpdate)&&e.events.addEventListener("self:peer:update",n=>{this.push().catch(o=>{this.log.error("error pushing updates to peers - %e",o)})})}[qe]=["@libp2p/identify-push"];async push(){this._push()}async sendPushMessage(){if(this.isStarted())try{let e=this.components.addressManager.getAddresses().map(f=>f.decapsulateCode(421)),t=new Zr({peerId:this.components.peerId,multiaddrs:e}),n=await Mn.seal(t,this.components.privateKey),o=this.components.registrar.getProtocols(),i=await this.components.peerStore.get(this.components.peerId),s=j(i.metadata.get("AgentVersion")??B(this.host.agentVersion)),a=j(i.metadata.get("ProtocolVersion")??B(this.host.protocolVersion)),c=this;async function*l(){for(let f of c.connectionManager.getConnections())(await c.components.peerStore.get(f.remotePeer)).protocols.includes(c.protocol)&&(yield async()=>{let d,h=AbortSignal.timeout(c.timeout);try{d=await f.newStream(c.protocol,{signal:h,runOnLimitedConnection:c.runOnLimitedConnection}),await bt(d,{maxDataLength:c.maxMessageSize}).pb(ca).write({listenAddrs:e.map(w=>w.bytes),signedPeerRecord:n.marshal(),protocols:o,agentVersion:s,protocolVersion:a},{signal:h}),await d.close({signal:h})}catch(m){d?.log.newScope("identify-push")?.error("could not push identify update to peer",m),d?.abort(m)}})}await an(ns(l(),{concurrency:this.concurrency}))}catch(e){this.log.error("error pushing updates to peers - %e",e)}}async handleProtocol(e,t){let n=e.log.newScope("identify-push");if(this.components.peerId.equals(t.remotePeer))throw new Error("received push from ourselves?");let o={signal:AbortSignal.timeout(this.timeout)},s=await bt(e,{maxDataLength:this.maxMessageSize}).pb(ca).read(o);await e.close(o),await t3(this.components.peerStore,this.components.events,n,t,s),n.trace("handled push from %p",t.remotePeer)}};var n3=class extends hf{constructor(e,t={}){super(e,{...t,protocol:`/${t.protocolPrefix??pn.protocolPrefix}/${"id"}/${ek}`,log:e.logger.forComponent("libp2p:identify")}),(t.runOnConnectionOpen??pn.runOnConnectionOpen)&&e.events.addEventListener("connection:open",n=>{let o=n.detail;this.identify(o).catch(()=>{})})}[qe]=["@libp2p/identify"];async _identify(e,t={}){let n,o;if(t.signal==null){let i=AbortSignal.timeout(this.timeout);t={...t,signal:i}}this.log("run identify on new connection %a",e.remoteAddr);try{n=await e.newStream(this.protocol,{...t,runOnLimitedConnection:this.runOnLimitedConnection}),o=n.log.newScope("identify");let i=bt(n,{maxDataLength:this.maxMessageSize}).pb(ca),s=await i.read(t);return await i.unwrap().unwrap().close(t),s}catch(i){throw o?.error("identify failed - %e",i),n?.abort(i),i}}async identify(e,t={}){let n=await this._identify(e,t),{publicKey:o,protocols:i,observedAddr:s}=n;if(o==null)throw new Be("Public key was missing from identify message");let a=Kt(o),c=Ro(a.toCID());if(!e.remotePeer.equals(c))throw new Be("Identified peer does not match the expected peer");if(this.components.peerId.equals(c))throw new Be("Identified peer is our own peer id?");return this.maybeAddObservedAddress(s),this.log("completed for peer %p and protocols %o",c,i),t3(this.components.peerStore,this.components.events,this.log,e,n)}maybeAddObservedAddress(e){let t=rk(e);if(t==null||(this.log.trace("our observed address was %a",t),Mt(t)))return;let n=t.getComponents();if((n[0].code===41||n[0].code===42&&n[1].code===41)&&!qm(t)){this.log.trace("our observed address was IPv6 but not a global unicast address");return}Pc.exactMatch(t)||(this.log.trace("storing the observed address"),this.components.addressManager.addObservedAddr(t))}async handleProtocol(e,t){let n=e.log.newScope("identify");n("responding to identify");let o=AbortSignal.timeout(this.timeout);let i=await this.components.peerStore.get(this.components.peerId,{signal:o}),s=this.components.addressManager.getAddresses().map(f=>f.decapsulateCode(421)),a=i.peerRecordEnvelope;if(s.length>0&&a==null){let f=new Zr({peerId:this.components.peerId,multiaddrs:s});a=(await Mn.seal(f,this.components.privateKey,{signal:o})).marshal().subarray()}let c=t.remoteAddr.bytes;oT.matches(t.remoteAddr)||(c=void 0);let l=bt(e).pb(ca);n("send response"),await l.write({protocolVersion:this.host.protocolVersion,agentVersion:this.host.agentVersion,publicKey:sr(this.components.privateKey.publicKey),listenAddrs:s.map(f=>f.bytes),signedPeerRecord:a,observedAddr:c,protocols:i.protocols},{signal:o}),n("close write"),await l.unwrap().unwrap().close({signal:o})}};function nk(r={}){return e=>new n3(e,r)}function ok(r={}){return e=>new r3(e,r)}var Zc=1e3,hb=60*Zc,o3=60*hb,ik="/ipfs/kad/1.0.0",i3=48*o3;var sk=24*o3,ak=10,ck=16384,lk=o3,pb=o3,iwe=10*Zc,uk=10*Zc;var s3=20,la=10,fk=5*hb,dk=Zc,hk=5*Zc,pk=5*hb,mk=30*Zc,gk=180*Zc,mb=`${Ha}-kad-dht`;var xp;(function(r){let e;r.codec=()=>(e==null&&(e=Ie((t,n,o={})=>{o.lengthDelimited!==!1&&n.fork(),t.key!=null&&t.key.byteLength>0&&(n.uint32(10),n.bytes(t.key)),t.value!=null&&t.value.byteLength>0&&(n.uint32(18),n.bytes(t.value)),t.timeReceived!=null&&t.timeReceived!==""&&(n.uint32(42),n.string(t.timeReceived)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={key:ke(0),value:ke(0),timeReceived:""},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{i.key=t.bytes();break}case 2:{i.value=t.bytes();break}case 5:{i.timeReceived=t.string();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>Te(t,r.codec()),r.decode=(t,n)=>Ae(t,r.codec(),n)})(xp||(xp={}));function yk(r){let e=r.getUTCFullYear(),t=String(r.getUTCMonth()+1).padStart(2,"0"),n=String(r.getUTCDate()).padStart(2,"0"),o=String(r.getUTCHours()).padStart(2,"0"),i=String(r.getUTCMinutes()).padStart(2,"0"),s=String(r.getUTCSeconds()).padStart(2,"0"),a=r.getUTCMilliseconds(),c=String(a*1e3*1e3).padStart(9,"0");return`${e}-${t}-${n}T${o}:${i}:${s}.${c}Z`}function wk(r){let e=new RegExp("(\\d{4})-(\\d{2})-(\\d{2})T(\\d{2}):(\\d{2}):(\\d{2})\\.(\\d+)Z"),t=String(r).trim().match(e);if(t==null)throw new Error("Invalid format");let n=parseInt(t[1],10),o=parseInt(t[2],10)-1,i=parseInt(t[3],10),s=parseInt(t[4],10),a=parseInt(t[5],10),c=parseInt(t[6],10),l=parseInt(t[7].slice(0,-6),10);return new Date(Date.UTC(n,o,i,s,a,c,l))}var Ar=class r{key;value;timeReceived;constructor(e,t,n){if(!(e instanceof Uint8Array))throw new Error("key must be a Uint8Array");if(!(t instanceof Uint8Array))throw new Error("value must be a Uint8Array");this.key=e,this.value=t,this.timeReceived=n}serialize(){return xp.encode(this.prepareSerialize())}prepareSerialize(){return{key:this.key,value:this.value,timeReceived:yk(this.timeReceived)}}static deserialize(e){let t=xp.decode(e);return new r(t.key,t.value,new Date(t.timeReceived))}static fromDeserialized(e){let t=wk(e.timeReceived);if(e.key==null)throw new Error("key missing from deserialized object");if(e.value==null)throw new Error("value missing from deserialized object");return new r(e.key,e.value,t)}};var ua=class extends Error{constructor(e="Query error"){super(e),this.name="QueryError"}},a3=class extends Error{constructor(e="Invalid record"){super(e),this.name="InvalidRecordError"}},c3=class extends Error{constructor(e="No selector function configured for prefix"){super(e),this.name="MissingSelectorError"}};var bk;(function(r){let e;r.codec=()=>(e==null&&(e=Ie((t,n,o={})=>{o.lengthDelimited!==!1&&n.fork(),t.key!=null&&(n.uint32(10),n.bytes(t.key)),t.value!=null&&(n.uint32(18),n.bytes(t.value)),t.author!=null&&(n.uint32(26),n.bytes(t.author)),t.signature!=null&&(n.uint32(34),n.bytes(t.signature)),t.timeReceived!=null&&(n.uint32(42),n.string(t.timeReceived)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{i.key=t.bytes();break}case 2:{i.value=t.bytes();break}case 3:{i.author=t.bytes();break}case 4:{i.signature=t.bytes();break}case 5:{i.timeReceived=t.string();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>Te(t,r.codec()),r.decode=(t,n)=>Ae(t,r.codec(),n)})(bk||(bk={}));var tt;(function(r){r.PUT_VALUE="PUT_VALUE",r.GET_VALUE="GET_VALUE",r.ADD_PROVIDER="ADD_PROVIDER",r.GET_PROVIDERS="GET_PROVIDERS",r.FIND_NODE="FIND_NODE",r.PING="PING"})(tt||(tt={}));var l3;(function(r){r[r.PUT_VALUE=0]="PUT_VALUE",r[r.GET_VALUE=1]="GET_VALUE",r[r.ADD_PROVIDER=2]="ADD_PROVIDER",r[r.GET_PROVIDERS=3]="GET_PROVIDERS",r[r.FIND_NODE=4]="FIND_NODE",r[r.PING=5]="PING"})(l3||(l3={}));(function(r){r.codec=()=>kt(l3)})(tt||(tt={}));var mf;(function(r){r.NOT_CONNECTED="NOT_CONNECTED",r.CONNECTED="CONNECTED",r.CAN_CONNECT="CAN_CONNECT",r.CANNOT_CONNECT="CANNOT_CONNECT"})(mf||(mf={}));var gb;(function(r){r[r.NOT_CONNECTED=0]="NOT_CONNECTED",r[r.CONNECTED=1]="CONNECTED",r[r.CAN_CONNECT=2]="CAN_CONNECT",r[r.CANNOT_CONNECT=3]="CANNOT_CONNECT"})(gb||(gb={}));(function(r){r.codec=()=>kt(gb)})(mf||(mf={}));var pf;(function(r){let e;r.codec=()=>(e==null&&(e=Ie((t,n,o={})=>{if(o.lengthDelimited!==!1&&n.fork(),t.id!=null&&t.id.byteLength>0&&(n.uint32(10),n.bytes(t.id)),t.multiaddrs!=null)for(let i of t.multiaddrs)n.uint32(18),n.bytes(i);t.connection!=null&&(n.uint32(24),mf.codec().encode(t.connection,n)),o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={id:ke(0),multiaddrs:[]},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{i.id=t.bytes();break}case 2:{if(o.limits?.multiaddrs!=null&&i.multiaddrs.length===o.limits.multiaddrs)throw new dt('Decode error - map field "multiaddrs" had too many elements');i.multiaddrs.push(t.bytes());break}case 3:{i.connection=mf.codec().decode(t);break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>Te(t,r.codec()),r.decode=(t,n)=>Ae(t,r.codec(),n)})(pf||(pf={}));var fa;(function(r){let e;r.codec=()=>(e==null&&(e=Ie((t,n,o={})=>{if(o.lengthDelimited!==!1&&n.fork(),t.type!=null&&l3[t.type]!==0&&(n.uint32(8),tt.codec().encode(t.type,n)),t.clusterLevel!=null&&(n.uint32(80),n.int32(t.clusterLevel)),t.key!=null&&(n.uint32(18),n.bytes(t.key)),t.record!=null&&(n.uint32(26),n.bytes(t.record)),t.closer!=null)for(let i of t.closer)n.uint32(66),pf.codec().encode(i,n);if(t.providers!=null)for(let i of t.providers)n.uint32(74),pf.codec().encode(i,n);o.lengthDelimited!==!1&&n.ldelim()},(t,n,o={})=>{let i={type:tt.PUT_VALUE,closer:[],providers:[]},s=n==null?t.len:t.pos+n;for(;t.pos<s;){let a=t.uint32();switch(a>>>3){case 1:{i.type=tt.codec().decode(t);break}case 10:{i.clusterLevel=t.int32();break}case 2:{i.key=t.bytes();break}case 3:{i.record=t.bytes();break}case 8:{if(o.limits?.closer!=null&&i.closer.length===o.limits.closer)throw new dt('Decode error - map field "closer" had too many elements');i.closer.push(pf.codec().decode(t,t.uint32(),{limits:o.limits?.closer$}));break}case 9:{if(o.limits?.providers!=null&&i.providers.length===o.limits.providers)throw new dt('Decode error - map field "providers" had too many elements');i.providers.push(pf.codec().decode(t,t.uint32(),{limits:o.limits?.providers$}));break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>Te(t,r.codec()),r.decode=(t,n)=>Ae(t,r.codec(),n)})(fa||(fa={}));function yb(r,e={}){let t={...r,name:"SEND_QUERY",type:0,messageName:r.type,messageType:r.type};return e.onProgress?.(new CustomEvent("kad-dht:query:send-query",{detail:t})),t}function Ep(r,e={}){let t={...r,name:"PEER_RESPONSE",type:1,messageName:r.messageType,closer:r.closer??[],providers:r.providers??[]};return e.onProgress?.(new CustomEvent("kad-dht:query:peer-response",{detail:t})),t}function u3(r,e={}){let t={...r,name:"FINAL_PEER",type:2};return e.onProgress?.(new CustomEvent("kad-dht:query:final-peer",{detail:t})),t}function $o(r,e={}){let t={...r,name:"QUERY_ERROR",type:3};return e.onProgress?.(new CustomEvent("kad-dht:query:query-error",{detail:t})),t}function wb(r,e={}){let t={...r,name:"PROVIDER",type:4};return e.onProgress?.(new CustomEvent("kad-dht:query:provider",{detail:t})),t}function Sp(r,e={}){let t={...r,name:"VALUE",type:5};return e.onProgress?.(new CustomEvent("kad-dht:query:value",{detail:t})),t}function bb(r,e={}){let t={...r,name:"DIAL_PEER",type:7};return e.onProgress?.(new CustomEvent("kad-dht:query:dial-peer",{detail:t})),t}function vk(r,e={}){let t={...r,name:"PATH_ENDED",type:8};return e.onProgress?.(new CustomEvent("kad-dht:query:path-ended",{detail:t})),t}function xk(r,e,t){if(t.length===0)throw new P("No records given");let o=j(e).split("/");if(o.length<3)throw new P("Record key does not have a selector function");let i=r[o[1].toString()];if(i==null)throw new c3(`No selector function configured for key type "${o[1]}"`);return t.length===1?0:i(e,t)}function RH(r,e){return 0}var Ek={pk:RH};async function gf(r,e,t){let n=e.key,i=j(n).split("/");if(i.length<3)return;let s=r[i[1].toString()];if(s==null)throw new P(`No validator available for key type "${i[1]}"`);await s(n,e.value,t)}var DH=async(r,e,t)=>{if(!(r instanceof Uint8Array))throw new P('"key" must be a Uint8Array');if(r.byteLength<5)throw new P("Invalid public key record");if(j(r.subarray(0,4))!=="/pk/")throw new P("key was not prefixed with /pk/");let o=Kt(e),i=r.slice(4);if(!we(i,o.toMultihash().bytes))throw new P("public key does not match passed in key")},Sk={pk:DH};var NH=B("/pk/");function _k(r){return{...r,multiaddrs:r.multiaddrs.filter(e=>!Mt(e))}}async function da(r,e){let t=await St.digest(r);return e?.signal?.throwIfAborted(),t.digest}async function mn(r,e){return da(r.toMultihash().bytes,e)}function ha(r,e){return new ht(`${r}/${j(e,"base32")}`,!1)}function Ak(r){return gt([NH,r.toMultihash().bytes])}function Tk(r){return j(r.subarray(0,4))==="/pk/"}function Ik(r){let e=lt(r.subarray(4));return zt(e)}function vb(r,e){let t=new Date;return new Ar(r,e,t).serialize()}function f3(r){let e=r.toString().split("/"),t=e.pop(),n=e.pop();if(t==null||n==null)throw new Error(`incorrectly formatted provider entry key in datastore: ${r.toString()}`);return{cid:he.createV1(Ga,lt(B(n,"base32"))),peerId:yt(t)}}function d3(r,e,t){let n=typeof e=="string"?e:j(e.multihash.bytes,"base32"),o=[r,n];return t!=null&&o.push(t.toString()),new ht(o.join("/"))}function h3(r){return new Date(Cn(r))}function Jc(r,e,t){return async function*(...n){let o=e.queryTime?.timer(t),i=e.errorTime?.timer(t),s=!1;try{e.queries?.increment({[t]:!0}),yield*r(...n)}catch(a){throw s=!0,i?.(),e.errors?.increment({[t]:!0}),a}finally{e.queries?.decrement({[t]:!0}),s||o?.()}}}function p3(r,e,t){return async function(...n){let o=e?.queryTime?.timer(t),i=e?.errorTime?.timer(t),s=!1;try{return e.queries?.increment({[t]:!0}),await r(...n)}catch(a){throw s=!0,i?.(),e.errors?.increment({[t]:!0}),a}finally{e.queries?.decrement({[t]:!0}),s||o?.()}}}var m3=class{log;components;validators;selectors;peerRouting;queryManager;network;datastorePrefix;constructor(e,t){let{validators:n,selectors:o,peerRouting:i,queryManager:s,network:a,logPrefix:c}=t;this.components=e,this.log=e.logger.forComponent(`${c}:content-fetching`),this.datastorePrefix=`${t.datastorePrefix}/record`,this.validators=n,this.selectors=o,this.peerRouting=i,this.queryManager=s,this.network=a,this.get=e.metrics?.traceFunction("libp2p.kadDHT.get",this.get.bind(this),{optionsIndex:1})??this.get,this.put=e.metrics?.traceFunction("libp2p.kadDHT.put",this.put.bind(this),{optionsIndex:2})??this.put}async getLocal(e,t){this.log("getLocal %b",e);let n=ha(this.datastorePrefix,e);this.log("fetching record for key %k",n);let o=await this.components.datastore.get(n,t);this.log("found %k in local datastore",n);let i=Ar.deserialize(o);return await gf(this.validators,i,t),i}async*sendCorrectionRecord(e,t,n,o){this.log("sendCorrection for %b",e);let i=vb(e,n);for(let{value:s,from:a}of t){if(we(s,n)){this.log("record was ok");continue}if(this.components.peerId.equals(a)){try{let f=ha(this.datastorePrefix,e);this.log(`Storing corrected record for key ${f.toString()}`),await this.components.datastore.put(f,i.subarray(),o)}catch(f){this.log.error("failed error correcting self - %e",f)}continue}let c=!1,l={type:tt.PUT_VALUE,key:e,record:i};for await(let f of this.network.sendRequest(a,l,o))f.name==="PEER_RESPONSE"&&f.record!=null&&we(f.record.value,Ar.deserialize(i).value)&&(c=!0),yield f;if(!c)throw new ua("Could not send correction");this.log.error("failed error correcting entry")}}async*put(e,t,n){this.log("put key %b value %b",e,t);let o=vb(e,t),i=ha(this.datastorePrefix,e);this.log(`storing record for key ${i.toString()}`),await this.components.datastore.put(i,o.subarray(),n),yield*vu(this.peerRouting.getClosestPeers(e,{...n,signal:n.signal}),s=>to(s,a=>async()=>{if(a.name!=="FINAL_PEER")return[a];let c=[],l={type:tt.PUT_VALUE,key:e,record:o};this.log("send put to %p",a.peer.id);for await(let f of this.network.sendRequest(a.peer.id,l,{...n,path:a.path}))c.push(f),f.name==="PEER_RESPONSE"&&(f.record!=null&&we(f.record.value,Ar.deserialize(o).value)||c.push($o({from:a.peer.id,error:new ua("Value not put correctly"),path:f.path},n)));return c}),s=>ns(s,{ordered:!1,concurrency:la}),async function*(s){for await(let a of s)yield*a})}async*get(e,t){this.log("get %b",e);let n=[];for await(let a of this.getMany(e,t)){if(a.name==="VALUE"){n.push(a);continue}yield a}if(n.length===0)return;let o=n.map(a=>a.value),i=0;try{i=xk(this.selectors,e,o)}catch(a){if(a.name!=="InvalidParametersError")throw a}let s=o[i];if(this.log("GetValue %b %b",e,s),s==null)throw new Xe("Best value was not found");yield*this.sendCorrectionRecord(e,n,s,{...t,path:{index:-1,queued:0,running:0,total:0}}),yield n[i]}async*getMany(e,t={}){this.log("getMany values for %b",e);try{let i=await this.getLocal(e,t);yield Sp({value:i.value,from:this.components.peerId,path:{index:-1,running:0,queued:0,total:0}},t)}catch(i){this.log("error getting local value for %b",e,i)}let n=this,o=async function*({peer:i,signal:s,path:a}){for await(let c of n.peerRouting.getValueOrPeers(i.id,e,{...t,signal:s,path:a}))yield c,c.name==="PEER_RESPONSE"&&c.record!=null&&(yield Sp({from:i.id,value:c.record.value,path:a},t))};yield*this.queryManager.run(e,o,t)}};function Ck(r,e){return{id:r.id.toMultihash().bytes,multiaddrs:(r.multiaddrs??[]).map(n=>n.bytes),connection:e}}function _p(r){if(r.id==null)throw new Error("Invalid peer in message");let e=lt(r.id);return{id:zt(e),multiaddrs:(r.multiaddrs??[]).map(t=>ie(t))}}var g3=class{log;components;network;peerRouting;queryManager;routingTable;providers;constructor(e,t){let{network:n,peerRouting:o,queryManager:i,routingTable:s,providers:a,logPrefix:c}=t;this.components=e,this.log=e.logger.forComponent(`${c}:content-routing`),this.network=n,this.peerRouting=o,this.queryManager=i,this.routingTable=s,this.providers=a,this.findProviders=e.metrics?.traceFunction("libp2p.kadDHT.findProviders",this.findProviders.bind(this),{optionsIndex:1,getAttributesFromYieldedValue:(l,f)=>(l.name==="PROVIDER"&&(f.providers??=[],f.providers.push(...l.providers.map(u=>u.id.toString()))),f)})??this.findProviders,this.provide=e.metrics?.traceFunction("libp2p.kadDHT.provide",this.provide.bind(this),{optionsIndex:1,getAttributesFromYieldedValue:(l,f)=>(l.name==="PEER_RESPONSE"&&l.messageName==="ADD_PROVIDER"&&(f.providers??=[],f.providers.push(l.from.toString())),f)})??this.provide}async*provide(e,t,n={}){this.log("provide %s",e);let o=e.multihash.bytes;await this.providers.addProvider(e,this.components.peerId,n);let i={type:tt.ADD_PROVIDER,key:o,providers:[Ck({id:this.components.peerId,multiaddrs:t})]},s=0,a=this;async function*c(u){try{a.log("sending provider record for %s to %p",e,u.peer.id);for await(let d of a.network.sendMessage(u.peer.id,i,{...n,path:u.path}))d.name==="PEER_RESPONSE"&&(a.log("sent provider record for %s to %p",e,u.peer.id),s++),yield d}catch(d){a.log.error("error sending provide record to peer %p - %e",u.peer.id,d),yield $o({from:u.peer.id,error:d,path:u.path},n)}}let l=gr({objectMode:!0}),f=new yr({concurrency:la});f.addEventListener("idle",()=>{l.end()}),f.addEventListener("failure",u=>{this.log.error("error publishing provider record to peer - %e",u.detail.error)}),f.add(async()=>{let u=[];for await(let d of this.peerRouting.getClosestPeers(o,n))l.push(d),d.name==="FINAL_PEER"&&u.push(d);u.forEach(d=>{f.add(async()=>{for await(let h of c(d))l.push(h)}).catch(h=>{this.log.error("error publishing provider record to peer - %e",h)})})}).catch(u=>{l.end(u)}),yield*l,this.log("sent provider records to %d peers",s)}async*findProviders(e,t){let n=this.routingTable.kBucketSize,o=0,i=e.multihash.bytes,s=this;this.log("findProviders %c",e);let a=await this.providers.getProviders(e,t);if(a.length>0){let f=[];for(let u of a.slice(0,n))try{let d=await this.components.peerStore.get(u,t);f.push({id:u,multiaddrs:d.addresses.map(({multiaddr:h})=>h)})}catch(d){if(d.name!=="NotFoundError")throw d;this.log("no peer store entry for %p",u)}if(yield Ep({from:this.components.peerId,messageType:tt.GET_PROVIDERS,providers:f,path:{index:-1,queued:0,running:0,total:0}},t),yield wb({from:this.components.peerId,providers:f,path:{index:-1,queued:0,running:0,total:0}},t),o+=f.length,o>=n)return}let c=async function*({peer:f,signal:u,path:d}){let h={type:tt.GET_PROVIDERS,key:i};yield*s.network.sendRequest(f.id,h,{...t,signal:u,path:d})},l=new Bn(a);for await(let f of this.queryManager.run(i,c,t))if(yield f,f.name==="PEER_RESPONSE"){this.log("Found %d provider entries for %c and %d closer peers",f.providers.length,e,f.closer.length);let u=[];for(let d of f.providers)l.has(d.id)||(l.add(d.id),u.push(d));if(u.length>0&&(yield wb({from:f.from,providers:u,path:f.path},t),o+=u.length,o>=n))return}}};var y3=class extends _e{log;protocol;running;components;timeout;metrics;constructor(e,t){super(),this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:network`),this.running=!1,this.protocol=t.protocol,this.timeout=new To({...t.timeout??{},metrics:e.metrics,metricName:`${t.metricsPrefix}_network_message_send_times_milliseconds`}),this.metrics={operations:e.metrics?.registerCounterGroup(`${t.metricsPrefix}_outbound_rpc_requests_total`),errors:e.metrics?.registerCounterGroup(`${t.metricsPrefix}_outbound_rpc_errors_total`)},this.sendRequest=e.metrics?.traceFunction("libp2p.kadDHT.sendRequest",this.sendRequest.bind(this),{optionsIndex:2,getAttributesFromArgs([n,o],i){return{...i,to:n.toString(),"message type":`${o.type}`}},getAttributesFromYieldedValue:(n,o)=>(n.name==="PEER_RESPONSE"&&(n.providers.length>0&&n.providers.forEach((i,s)=>{o[`providers-${s}`]=i.id.toString()}),n.closer.length>0&&n.closer.forEach((i,s)=>{o[`closer-${s}`]=i.id.toString()})),o)})??this.sendRequest,this.sendMessage=e.metrics?.traceFunction("libp2p.kadDHT.sendMessage",this.sendMessage.bind(this),{optionsIndex:2,getAttributesFromArgs([n,o],i){return{...i,to:n.toString(),"message type":`${o.type}`}},getAttributesFromYieldedValue:(n,o)=>(n.name==="PEER_RESPONSE"&&(n.providers.length>0&&n.providers.forEach((i,s)=>{o[`providers-${s}`]=i.id.toString()}),n.closer.length>0&&n.closer.forEach((i,s)=>{o[`closer-${s}`]=i.id.toString()})),o)})??this.sendMessage}async start(){this.running||(this.running=!0)}async stop(){this.running=!1}isStarted(){return this.running}async*sendRequest(e,t,n){if(!this.running)return;let o=t.type;if(o==null)throw new P("Message type was missing");let i,s=this.timeout.getTimeoutSignal(n);n={...n,signal:s};try{this.metrics.operations?.increment({[o]:!0}),this.log("dialling %p",e),yield bb({peer:e,path:n.path},n),i=await this.components.connectionManager.openStream(e,this.protocol,n),this.log("sending %s to %p",t.type,e),yield yb({to:e,type:o,path:n.path},n);let a=await this._writeReadMessage(i,t,n);i.close(n).catch(c=>{this.log.error("error closing stream to %p - %e",e,c),i?.abort(c)}),yield Ep({from:e,messageType:a.type,closer:a.closer.map(_p),providers:a.providers.map(_p),record:a.record==null?void 0:Ar.deserialize(a.record),path:n.path},n)}catch(a){this.metrics.errors?.increment({[o]:!0}),i?.abort(a),n.signal?.aborted!==!0&&this.log.error("could not send %s to %p - %e",t.type,e,a),yield $o({from:e,error:a,path:n.path},n)}finally{this.timeout.cleanUp(s)}}async*sendMessage(e,t,n){if(!this.running)return;let o=t.type;if(o==null)throw new P("Message type was missing");let i,s=this.timeout.getTimeoutSignal(n);n={...n,signal:s};try{this.metrics.operations?.increment({[o]:!0}),this.log("dialling %p",e),yield bb({peer:e,path:n.path},n),i=await this.components.connectionManager.openStream(e,this.protocol,n),this.log("sending %s to %p",t.type,e),yield yb({to:e,type:o,path:n.path},n),await this._writeMessage(i,t,n),i.close(n).catch(a=>{this.log.error("error closing stream to %p - %e",e,a),i?.abort(a)}),yield Ep({from:e,messageType:o,path:n.path},n)}catch(a){this.metrics.errors?.increment({[o]:!0}),i?.abort(a),yield $o({from:e,error:a,path:n.path},n)}finally{this.timeout.cleanUp(s)}}async _writeMessage(e,t,n){await bt(e).write(t,fa,n)}async _writeReadMessage(e,t,n){let o=bt(e);await o.write(t,fa,n);let i=await o.read(fa,n);return i.closer.forEach(s=>{this.safeDispatchEvent("peer",{detail:_p(s)})}),i.providers.forEach(s=>{this.safeDispatchEvent("peer",{detail:_p(s)})}),i}};function el(r,e){if(r.byteLength!==e.byteLength)throw new Error("Inputs should have the same length");for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return r[t]<e[t]?-1:1;return 0}var pa=class{originDhtKey;capacity;peerDistances;constructor(e,t){this.originDhtKey=e,this.capacity=t,this.peerDistances=[]}get length(){return this.peerDistances.length}get peers(){return[...this.peerDistances]}async add(e,t={index:-1,queued:0,running:0,total:0},n){let o=await mn(e.id,n);this.addWithKadId(e,o,t)}addWithKadId(e,t,n={index:-1,queued:0,running:0,total:0}){if(this.peerDistances.find(s=>s.peer.id.equals(e.id))!=null)return;let o={peer:e,distance:Uo(this.originDhtKey,t),path:n};if(this.peerDistances.length===this.capacity){let s=this.peerDistances[this.peerDistances.length-1];if(s!=null&&el(o.distance,s.distance)!==-1)return}let i=!1;for(let s=0;s<this.peerDistances.length;s++){let a=el(this.peerDistances[s].distance,o.distance);if(a===0||a===1){i=!0,this.peerDistances.splice(s,0,o);break}}i||this.peerDistances.push(o),this.peerDistances=this.peerDistances.slice(0,this.capacity)}async isCloser(e,t){if(this.length===0)return!0;let n=await mn(e,t),o=Uo(n,this.originDhtKey),i=this.peerDistances[this.peerDistances.length-1].distance;return el(o,i)===-1}async anyCloser(e,t){return e.length===0?!1:Promise.any(e.map(async n=>this.isCloser(n,t)))}};var w3=class{log;routingTable;network;validators;queryManager;components;constructor(e,t){this.routingTable=t.routingTable,this.network=t.network,this.validators=t.validators,this.queryManager=t.queryManager,this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:peer-routing`),this.findPeer=e.metrics?.traceFunction("libp2p.kadDHT.findPeer",this.findPeer.bind(this),{optionsIndex:1})??this.findPeer,this.getClosestPeers=e.metrics?.traceFunction("libp2p.kadDHT.getClosestPeers",this.getClosestPeers.bind(this),{optionsIndex:1})??this.getClosestPeers}async findPeerLocal(e,t){let n,o=await this.routingTable.find(e,t);if(o!=null){this.log("findPeerLocal found %p in routing table",e);try{n=await this.components.peerStore.get(o,t)}catch(i){if(i.name!=="NotFoundError")throw i}}if(n==null)try{n=await this.components.peerStore.get(e,t)}catch(i){if(i.name!=="NotFoundError")throw i}if(n!=null)return this.log("findPeerLocal found %p in peer store",e),{id:n.id,multiaddrs:n.addresses.map(i=>i.multiaddr)}}async*_getValueSingle(e,t,n){let o={type:tt.GET_VALUE,key:t};yield*this.network.sendRequest(e,o,n)}async*getPublicKeyFromNode(e,t={}){let n=Ak(e),o={index:-1,queued:0,running:0,total:0};for await(let i of this._getValueSingle(e,n,{...t,path:o}))if(yield i,i.name==="PEER_RESPONSE"&&i.record!=null){let s=Kt(i.record.value),a=si(s);if(!a.equals(e))throw new Oi("public key does not match id");if(a.publicKey==null)throw new Oi("public key missing");yield Sp({from:e,value:i.record.value,path:o},t)}throw new ua(`Node not responding with its public key: ${e.toString()}`)}async*findPeer(e,t={}){if(this.log("findPeer %p",e),t.useCache!==!1){let o=await this.findPeerLocal(e,t);if(o!=null){this.log("found local"),yield u3({from:this.components.peerId,peer:o,path:{index:-1,queued:0,running:0,total:0}},t);return}}let n=!1;if(t.useNetwork!==!1){let o=this,i=async function*({peer:s,signal:a,path:c}){let l={type:tt.FIND_NODE,key:e.toMultihash().bytes};for await(let f of o.network.sendRequest(s.id,l,{...t,signal:a,path:c}))if(yield f,f.name==="PEER_RESPONSE"){let u=f.closer.find(d=>d.id.equals(e));u!=null&&(yield u3({from:f.from,peer:u,path:f.path},t))}};for await(let s of this.queryManager.run(e.toMultihash().bytes,i,t))s.name==="FINAL_PEER"&&(n=!0),yield s}if(!n)throw new Xe("Not found")}async*getClosestPeers(e,t={}){this.log("getClosestPeers to %b",e);let n=await da(e,t),o=new pa(n,this.routingTable.kBucketSize),i=this,s=async function*({peer:a,path:c,peerKadId:l,signal:f}){i.log("getClosestPeers asking %p",a.id);let u={type:tt.FIND_NODE,key:e};yield*i.network.sendRequest(a.id,u,{...t,signal:f,path:c}),o.addWithKadId(a,l,c)};yield*this.queryManager.run(e,s,t),this.log("found %d peers close to %b",o.length,e);for(let{peer:a,path:c}of o.peers)try{if(a.multiaddrs.length===0&&(a=await i.components.peerStore.getInfo(a.id,t)),a.multiaddrs.length===0)continue;yield u3({from:this.components.peerId,peer:await i.components.peerStore.getInfo(a.id,t),path:{index:c.index,queued:0,running:0,total:0}},t)}catch{continue}}async*getValueOrPeers(e,t,n){for await(let o of this._getValueSingle(e,t,n)){if(o.name==="PEER_RESPONSE"&&o.record!=null)try{await this._verifyRecordOnline(o.record,n)}catch{let s="invalid record received, discarded";this.log(s),yield $o({from:o.from,error:new ua(s),path:n.path},n);continue}yield o}}async _verifyRecordOnline(e,t){if(e.timeReceived==null)throw new a3("invalid record received");await gf(this.validators,new Ar(e.key,e.value,e.timeReceived),t)}async getClosestPeersOffline(e,t){let n=[];try{let s=lt(e),a=zt(s),c=await this.components.peerStore.get(a,t);n.push({id:c.id,multiaddrs:c.addresses.map(({multiaddr:l})=>l)})}catch{}let o=await da(e,t),i=this.routingTable.closestPeers(o,t);for(let s of i)try{n.push(await this.components.peerStore.getInfo(s,t))}catch(a){if(a.name!=="NotFoundError")throw a}return n.length>0?this.log("getClosestPeersOffline returning the %d closest peer(s) we know to %b",n.length,e):this.log("getClosestPeersOffline could not any peers close to %b with %d peers in the routing table",e,this.routingTable.size),n}};var b3=class{log;datastore;datastorePrefix;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:providers`),this.datastorePrefix=`${t.datastorePrefix}/provider`,this.datastore=e.datastore}async addProvider(e,t,n){this.log.trace("%p provides %s",t,e),await this.writeProviderEntry(e,t,n)}async removeProvider(e,t,n){let o=d3(this.datastorePrefix,e,t);this.log.trace("%p no longer provides %s",t,e),await this.datastore.delete(o,n)}async getProviders(e,t){this.log.trace("get providers for %c",e);let n=await this.loadProviders(e,t);return this.log.trace("got %d providers for %c",n.size,e),[...n.keys()]}async writeProviderEntry(e,t,n){let o=d3(this.datastorePrefix,e,t),i=Mr(n?.time?.getTime()??Date.now());await this.datastore.put(o,i,n)}async loadProviders(e,t){let n=new $r,o=d3(this.datastorePrefix,e);for await(let i of this.datastore.query({prefix:o.toString()},t)){let{peerId:s}=f3(i.key);n.set(s,h3(i.value))}return n}};var xb=class extends Error{constructor(e){super(e),this.name="TimeoutError"}},Eb=class extends Error{constructor(e){super(),this.name="AbortError",this.message=e}},Pk=r=>globalThis.DOMException===void 0?new Eb(r):new DOMException(r),kk=r=>{let e=r.reason===void 0?Pk("This operation was aborted."):r.reason;return e instanceof Error?e:Pk(e)};function Sb(r,e){let{milliseconds:t,fallback:n,message:o,customTimers:i={setTimeout,clearTimeout}}=e,s,a,l=new Promise((f,u)=>{if(typeof t!="number"||Math.sign(t)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${t}\``);if(e.signal){let{signal:h}=e;h.aborted&&u(kk(h)),a=()=>{u(kk(h))},h.addEventListener("abort",a,{once:!0})}if(t===Number.POSITIVE_INFINITY){r.then(f,u);return}let d=new xb;s=i.setTimeout.call(void 0,()=>{if(n){try{f(n())}catch(h){u(h)}return}typeof r.cancel=="function"&&r.cancel(),o===!1?f():o instanceof Error?u(o):(d.message=o??`Promise timed out after ${t} milliseconds`,u(d))},t),(async()=>{try{f(await r)}catch(h){u(h)}})()}).finally(()=>{l.clear(),a&&e.signal&&e.signal.removeEventListener("abort",a)});return l.clear=()=>{i.clearTimeout.call(void 0,s),s=void 0},l}var BH=r=>{let e=r.addEventListener||r.on||r.addListener,t=r.removeEventListener||r.off||r.removeListener;if(!e||!t)throw new TypeError("Emitter is not compatible");return{addListener:e.bind(r),removeListener:t.bind(r)}};function MH(r,e,t){let n,o=new Promise((i,s)=>{if(t={rejectionEvents:["error"],multiArgs:!1,rejectionMultiArgs:!1,resolveImmediately:!1,...t},!(t.count>=0&&(t.count===Number.POSITIVE_INFINITY||Number.isInteger(t.count))))throw new TypeError("The `count` option should be at least 0 or more");t.signal?.throwIfAborted();let a=[e].flat(),c=[],{addListener:l,removeListener:f}=BH(r),u=async(...h)=>{let m=t.multiArgs?h:h[0];if(t.filter)try{if(!await t.filter(m))return}catch(w){n(),s(w);return}c.push(m),t.count===c.length&&(n(),i(c))},d=(...h)=>{n(),s(t.rejectionMultiArgs?h:h[0])};n=()=>{for(let h of a)f(h,u);for(let h of t.rejectionEvents)a.includes(h)||f(h,d)};for(let h of a)l(h,u);for(let h of t.rejectionEvents)a.includes(h)||l(h,d);t.signal&&t.signal.addEventListener("abort",()=>{d(t.signal.reason)},{once:!0}),t.resolveImmediately&&i(c)});if(o.cancel=n,typeof t.timeout=="number"){let i=Sb(o,{milliseconds:t.timeout});return i.cancel=()=>{n(),i.clear()},i}return o}function Ok(r,e,t){typeof t=="function"&&(t={filter:t}),t={...t,count:1,resolveImmediately:!1};let n=MH(r,e,t),o=n.then(i=>i[0]);return o.cancel=n.cancel,o}async function*Rk(r){let{key:e,startingPeers:t,ourPeerId:n,query:o,alpha:i,path:s,numPaths:a,log:c,peersSeen:l,connectionManager:f,signal:u}=r,d=gr({objectMode:!0}),h=new yr({concurrency:i,sort:(w,y)=>el(w.options.distance,y.options.distance)});h.addEventListener("idle",()=>{d.push(vk({path:{index:s,queued:h.queued,running:h.running,total:h.size}},r)),d.end()}),h.addEventListener("failure",w=>{c.error("error during query - %e",w.detail.error)});let m=()=>{h.abort(),d.end(new Hr)};u.addEventListener("abort",m);try{let y=function(b,N){if(b==null)return;l.add(b.id.toMultihash().bytes);let O=Uo(N,w);h.add(async()=>{try{for await(let V of o({...r,key:e,peer:b,path:{index:s,queued:h.queued,running:h.running,total:h.size},numPaths:a,peerKadId:N,signal:u})){if(V.name==="PEER_RESPONSE")for(let Q of V.closer){if(l.has(Q.id.toMultihash().bytes)){c("already seen %p in query",Q.id);continue}if(n.equals(Q.id)){c("not querying ourselves");continue}if(!await f.isDialable(Q.multiaddrs)){c("not querying undialable peer");continue}let Z=await mn(Q.id,{signal:u}),se=Uo(Z,w);if(el(se,O)!==-1){c("skipping %p as they are not closer to %b than %p",Q.id,e,b.id);continue}c("querying closer peer %p",Q.id),y(Q,Z)}d.push({...V,path:{index:s,queued:h.queued,running:h.running,total:h.size}})}}catch(V){d.push($o({from:b.id,error:V,path:{index:s,queued:h.queued,running:h.running-1,total:h.size-1}},r))}},{distance:O}).catch(V=>{c.error("error during query - %e",V)})},w=await da(e,{signal:u});await Promise.all(t.map(async b=>{y({id:b,multiaddrs:[]},await mn(b,{signal:u}))})),yield*d}finally{u.removeEventListener("abort",m)}}var v3=class{disjointPaths;alpha;shutDownController;running;logger;peerId;connectionManager;routingTable;initialQuerySelfHasRun;logPrefix;allowQueryWithZeroPeers;constructor(e,t){this.logPrefix=t.logPrefix,this.disjointPaths=t.disjointPaths??s3,this.alpha=t.alpha??la,this.initialQuerySelfHasRun=t.initialQuerySelfHasRun,this.routingTable=t.routingTable,this.logger=e.logger,this.peerId=e.peerId,this.connectionManager=e.connectionManager,this.allowQueryWithZeroPeers=t.allowQueryWithZeroPeers??!1,this.shutDownController=new AbortController,this.shutDownController.signal,this.running=!1}isStarted(){return this.running}async start(){this.running||(this.running=!0,this.shutDownController=new AbortController,this.shutDownController.signal,void 0)}async stop(){this.running=!1,this.shutDownController.abort()}async*run(e,t,n={}){if(!this.running)throw new Error("QueryManager not started");if(n.signal==null){let c=AbortSignal.timeout(gk);n={...n,signal:c}}let o=new AbortController,i=De([this.shutDownController.signal,o.signal,n.signal]);o.signal;let s=this.logger.forComponent(`${this.logPrefix}:query:`+j(e,"base58btc")),a=!1;try{this.routingTable.size===0&&!this.allowQueryWithZeroPeers&&(s("routing table was empty, waiting for some peers before running%s query",n.isSelfQuery===!0?" self":""),await Ok(this.routingTable,"peer:add",{signal:i,filter:h=>!this.peerId.equals(h.detail)}),s("routing table has peers, continuing with%s query",n.isSelfQuery===!0?" self":"")),n.isSelfQuery!==!0&&this.initialQuerySelfHasRun!=null&&(s("waiting for initial self query before continuing"),await ut(this.initialQuerySelfHasRun.promise,i),this.initialQuerySelfHasRun=void 0),s("query:start");let c=await da(e,{signal:i}),l=this.routingTable.closestPeers(c,{count:this.routingTable.kBucketSize}),f=l.sort(()=>Math.random()>.5?1:-1).reduce((h,m,w)=>(h[w%this.disjointPaths].push(m),h),new Array(this.disjointPaths).fill(0).map(()=>[])).filter(h=>h.length>0);if(l.length===0){s.error("running query with no peers");return}let u=Fr(1024),d=f.map((h,m)=>Rk({...n,key:e,startingPeers:h,ourPeerId:this.peerId,signal:i,query:t,path:m,numPaths:f.length,alpha:this.alpha,log:s,peersSeen:u,onProgress:n.onProgress,connectionManager:this.connectionManager}));for await(let h of Yr(...d)){if(h.name==="QUERY_ERROR"&&s.error("query error - %e",h.error),h.name==="PEER_RESPONSE")for(let m of[...h.closer,...h.providers])await this.connectionManager.isDialable(m.multiaddrs,{signal:i})&&await this.routingTable.add(m.id,{signal:i});i.throwIfAborted(),yield h}a=!0}catch(c){if(this.running)throw c}finally{a||(s("query exited early"),o.abort()),i.clear(),s("query finished")}}};function UH(r){return r[Symbol.asyncIterator]!=null}function FH(r){if(UH(r))return(async()=>{let e=0;for await(let t of r)e++;return e})();{let e=0;for(let t of r)e++;return e}}var x3=FH;var E3=class{log;peerId;peerRouting;events;count;interval;initialInterval;queryTimeout;running;timeoutId;controller;initialQuerySelfHasRun;querySelfPromise;constructor(e,t){this.peerId=e.peerId,this.log=e.logger.forComponent(`${t.logPrefix}:query-self`),this.events=e.events,this.running=!1,this.peerRouting=t.peerRouting,this.count=t.count??s3,this.interval=t.interval??fk,this.initialInterval=t.initialInterval??dk,this.queryTimeout=t.queryTimeout??hk,this.initialQuerySelfHasRun=t.initialQuerySelfHasRun,this.querySelf=p3(this.querySelf.bind(this),t.operationMetrics,"SELF_QUERY")}isStarted(){return this.running}start(){this.running||(this.running=!0,clearTimeout(this.timeoutId),this.timeoutId=setTimeout(()=>{this.querySelf().catch(e=>{this.log.error("error running self-query - %e",e)})},this.initialInterval))}stop(){this.running=!1,this.timeoutId!=null&&clearTimeout(this.timeoutId),this.controller!=null&&this.controller.abort()}async querySelf(){if(!this.running){this.log("skip self-query because we are not started");return}if(this.querySelfPromise!=null)return this.log("joining existing self query"),this.querySelfPromise.promise;if(this.querySelfPromise=Ve(),this.running){this.controller=new AbortController;let e=[this.controller.signal];if(this.initialQuerySelfHasRun==null){let n=AbortSignal.timeout(this.queryTimeout);e.push(n)}let t=De(e);this.controller.signal;try{this.log("run self-query, look for %d peers timing out after %dms",this.count,this.queryTimeout);let n=Date.now(),o=await vu(this.peerRouting.getClosestPeers(this.peerId.toMultihash().bytes,{signal:t,isSelfQuery:!0}),s=>Js(s,this.count),async s=>x3(s));t?.throwIfAborted();let i=Date.now()-n;this.log("self-query found %d peers in %dms",o,i),this.events.dispatchEvent(new CustomEvent("kad-dht:query:self",{detail:{peers:o,duration:i}}))}catch(n){this.log.error("self-query error - %e",n)}finally{t.clear(),this.initialQuerySelfHasRun!=null&&(this.initialQuerySelfHasRun.resolve(),this.initialQuerySelfHasRun=void 0)}}this.querySelfPromise.resolve(),this.querySelfPromise=void 0,this.running&&(this.timeoutId=setTimeout(()=>{this.querySelf().catch(e=>{this.log.error("error running self-query - %e",e)})},this.interval))}};var S3=class extends _e{log;reprovideQueue;maxQueueSize;datastore;timeout;reprovideTimeout;running;shutdownController;reprovideThreshold;contentRouting;datastorePrefix;addressManager;validity;interval;peerId;constructor(e,t){super(),this.log=e.logger.forComponent(`${t.logPrefix}:reprovider`),this.peerId=e.peerId,this.reprovideQueue=new yr({concurrency:t.concurrency??ak,metrics:e.metrics,metricName:`${t.metricsPrefix}_reprovide_queue`}),this.reprovideTimeout=new To({...t.timeout??{},metrics:e.metrics,metricName:`${t.metricsPrefix}_reprovide_timeout_milliseconds`}),this.datastore=e.datastore,this.addressManager=e.addressManager,this.datastorePrefix=`${t.datastorePrefix}/provider`,this.reprovideThreshold=t.threshold??sk,this.maxQueueSize=t.maxQueueSize??ck,this.validity=t.validity??i3,this.interval=t.interval??lk,this.contentRouting=t.contentRouting,this.running=!1,this.reprovide=p3(this.reprovide.bind(this),t.operationMetrics,"PROVIDE")}start(){this.running||(this.running=!0,this.shutdownController=new AbortController,this.shutdownController.signal,this.timeout=setTimeout(()=>{this.processRecords({signal:AbortSignal.timeout(pb)}).catch(e=>{this.log.error("error running process to reprovide/cleanup - %e",e)})},this.interval))}stop(){this.running=!1,this.reprovideQueue.clear(),clearTimeout(this.timeout),this.shutdownController?.abort()}async processRecords(e){try{this.safeDispatchEvent("reprovide:start"),this.log("starting reprovide/cleanup");for await(let t of this.datastore.query({prefix:this.datastorePrefix},e))try{let{cid:n,peerId:o}=f3(t.key),s=h3(t.value).getTime()+this.validity,a=Date.now(),c=a>s,l=this.peerId.equals(o);this.log.trace("comparing: %d (now) < %d (expires) = %s %s",a,s,c,c?"(expired)":"(valid)"),c&&!l&&await this.datastore.delete(t.key,e),this.shouldReprovide(l,s)&&(this.log("reproviding %c as it is within the reprovide threshold (%d)",n,this.reprovideThreshold),this.queueReprovide(n).catch(f=>{this.log.error("could not reprovide %c - %e",n,f)}))}catch(n){this.log.error("error processing datastore key %s - %s",t.key,n.message)}this.log("reprovide/cleanup successful")}finally{this.safeDispatchEvent("reprovide:end"),this.running&&(this.log("queuing next re-provide/cleanup run in %d ms",this.interval),this.timeout=setTimeout(()=>{this.processRecords({signal:AbortSignal.timeout(pb)}).catch(t=>{this.log.error("error running re-provide - %e",t)})},this.interval))}}shouldReprovide(e,t){if(!e)return!1;let n=Date.now();return t<n?!0:t-n<this.reprovideThreshold}async queueReprovide(e,t){if(!this.running)return;this.log.trace("waiting for queue capacity before adding %c to re-provide queue",e),await this.reprovideQueue.onSizeLessThan(this.maxQueueSize,t);let n=this.reprovideQueue.queue.find(o=>o.options.cid.equals(e));if(n!=null)return this.log.trace("not adding %c to re-provide queue - already in queue",e),n.join();this.log.trace("adding %c to re-provide queue",e),this.reprovideQueue.add(async o=>{if(o.signal?.throwIfAborted(),!this.running)return;this.log.trace("re-providing %c",e);let i=this.reprovideTimeout.getTimeoutSignal(o);try{await this.reprovide(o.cid,o)}finally{this.reprovideTimeout.cleanUp(i)}this.log.trace("re-provided %c",e)},{signal:this.shutdownController?.signal,cid:e}).catch(o=>{this.log.error("could not re-provide key %c - %e",e,o)})}async reprovide(e,t){await an(this.contentRouting.provide(e,this.addressManager.getAddresses(),t))}};var $H=20,jH=5e3,KH="kad-close",VH=50,_3=class{routingTable;components;closestPeers;newPeers;refreshInterval;peerSetSize;timeout;closeTagName;closeTagValue;log;running;constructor(e,t){this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:routing-table`),this.routingTable=t.routingTable,this.refreshInterval=t.refreshInterval??jH,this.peerSetSize=t.peerSetSize??$H,this.closeTagName=t.closeTagName??KH,this.closeTagValue=t.closeTagValue??VH,this.closestPeers=new Bn,this.onPeerPing=this.onPeerPing.bind(this),this.running=!1}async start(){if(this.running)return;this.running=!0;let e=await mn(this.components.peerId);this.newPeers=new pa(e,this.peerSetSize),this.routingTable.addEventListener("peer:ping",this.onPeerPing),this.timeout=setInterval(()=>{this.updatePeerTags().catch(t=>{this.log.error("error updating peer tags - %e",t)})},this.refreshInterval)}stop(){this.running=!1,this.routingTable.removeEventListener("peer:ping",this.onPeerPing),clearTimeout(this.timeout)}onPeerPing(e){this.newPeers?.add({id:e.detail,multiaddrs:[]}).catch(t=>{this.log.error("error adding peer to distance list - %e",t)})}async updatePeerTags(){let e=new Bn(this.newPeers?.peers.map(({peer:o})=>o.id)),t=e.difference(this.closestPeers),n=this.closestPeers.difference(e);this.closestPeers=e,await Promise.all([...[...t].map(async o=>{await this.components.peerStore.merge(o,{tags:{[this.closeTagName]:{value:this.closeTagValue},[mb]:{value:1}}})}),...[...n].map(async o=>{await this.components.peerStore.merge(o,{tags:{[this.closeTagName]:void 0,[mb]:void 0}})})])}};function Ap(r){return Array.isArray(r?.peers)}var A3=class{peerId;root;localPeer;prefixLength;splitThreshold;kBucketSize;numberOfNodesToPing;lastPingThreshold;ping;verify;onAdd;onRemove;onMove;addingPeerMap;constructor(e,t){this.peerId=e.peerId,this.prefixLength=t.prefixLength??Dk,this.kBucketSize=t.kBucketSize??Tp,this.splitThreshold=t.splitThreshold??this.kBucketSize,this.numberOfNodesToPing=t.numberOfOldContactsToPing??Nk,this.lastPingThreshold=t.lastPingThreshold??Lk,this.ping=t.ping,this.verify=t.verify,this.onAdd=t.onAdd,this.onRemove=t.onRemove,this.addingPeerMap=Qi({name:`${t.metricsPrefix}_adding_peer_map`,metrics:e.metrics}),this.root={prefix:"",depth:0,peers:[]}}async start(){await this.addSelfPeer(this.peerId)}stop(){this.addingPeerMap.clear(),this.root={prefix:"",depth:0,peers:[]}}async addSelfPeer(e,t){this.localPeer={peerId:e,kadId:await mn(e,t),lastPing:Date.now()}}async add(e,t){let n={peerId:e,kadId:await mn(e,t),lastPing:0},o=this.addingPeerMap.get(e);if(o!=null)return o;try{let i=this._add(n,t);this.addingPeerMap.set(e,i),await i}finally{this.addingPeerMap.delete(e)}}async _add(e,t){let n=this._determineBucket(e.kadId);if(this._indexOf(n,e.kadId)>-1)return;if(n.peers.length===this.splitThreshold&&n.depth<this.prefixLength){await this._split(n,t),await this._add(e,t);return}if(n.peers.length<this.kBucketSize){if(!qH(e,this.lastPingThreshold)){n.peers.push(e),await this.onAdd?.(e,n,t);return}await this.verify(e,t)&&(e.lastPing=Date.now(),await this._add(e,t));return}let o=n.peers.filter(s=>!(s.peerId.equals(this.localPeer?.peerId)||s.lastPing>Date.now()-this.lastPingThreshold)).sort((s,a)=>s.lastPing<a.lastPing?-1:s.lastPing>a.lastPing?1:0).slice(0,this.numberOfNodesToPing),i=!1;for await(let s of this.ping(o,t))i=!0,await this.remove(s.kadId,t);i&&await this._add(e,t)}*closest(e,t){let n=new pa(e,t?.count??this.kBucketSize);for(let o of this.toIterable())t?.exclude?.some(i=>i.equals(o.peerId))!==!0&&n.addWithKadId({id:o.peerId,multiaddrs:[]},o.kadId);yield*to(n.peers,({peer:o})=>o.id)}count(){function e(t){if(Ap(t))return t.peers.length;let n=0;return t.left!=null&&(n+=e(t.left)),t.right!=null&&(n+=e(t.right)),n}return e(this.root)}get(e){let t=this._determineBucket(e),n=this._indexOf(t,e);return t.peers[n]}async remove(e,t){let n=this._determineBucket(e),o=this._indexOf(n,e);if(o>-1){let i=n.peers.splice(o,1)[0];await this.onRemove?.(i,n,t)}}*toIterable(){function*e(t){if(Ap(t)){yield*t.peers;return}yield*e(t.left),yield*e(t.right)}yield*e(this.root)}distance(e,t){return BigInt("0x"+j(Uo(e,t),"base16"))}_determineBucket(e){let t=j(e,"base2");function n(o,i=0){return Ap(o)?o:t[i]==="0"?n(o.left,i+1):n(o.right,i+1)}return n(this.root)}_indexOf(e,t){return e.peers.findIndex(n=>we(n.kadId,t))}async _split(e,t){let n={prefix:"0",depth:e.depth+1,peers:[]},o={prefix:"1",depth:e.depth+1,peers:[]};for(let i of e.peers)j(i.kadId,"base2")[e.depth]==="0"?(n.peers.push(i),await this.onMove?.(i,e,n,t)):(o.peers.push(i),await this.onMove?.(i,e,o,t));HH(e,n,o)}};function HH(r,e,t){return delete r.peers,r.left=e,r.right=t,r.prefix===""&&(delete r.depth,delete r.prefix),!0}function qH(r,e){return r.lastPing<Date.now()-e}var Tp=20,Dk=6;var WH=20,zH=100,Nk=3;var GH=20,XH=100,Bk="kad-peer",YH=1,Lk=6e5,QH=!0,ZH=1e3,T3=class extends _e{kBucketSize;kb;network;closestPeerTagger;log;components;running;pingNewContactTimeout;pingNewContactQueue;pingOldContactTimeout;pingOldContactQueue;populateFromDatastoreOnStart;populateFromDatastoreLimit;protocol;peerTagName;peerTagValue;metrics;shutdownController;constructor(e,t){super(),this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:routing-table`),this.kBucketSize=t.kBucketSize??Tp,this.running=!1,this.protocol=t.protocol,this.network=t.network,this.peerTagName=t.peerTagName??Bk,this.peerTagValue=t.peerTagValue??YH,this.pingOldContacts=this.pingOldContacts.bind(this),this.verifyNewContact=this.verifyNewContact.bind(this),this.peerAdded=this.peerAdded.bind(this),this.peerRemoved=this.peerRemoved.bind(this),this.populateFromDatastoreOnStart=t.populateFromDatastoreOnStart??QH,this.populateFromDatastoreLimit=t.populateFromDatastoreLimit??ZH,this.shutdownController=new AbortController,this.shutdownController.signal,this.pingOldContactQueue=new vr({concurrency:t.pingOldContactConcurrency??GH,metricName:`${t.metricsPrefix}_ping_old_contact_queue`,metrics:this.components.metrics,maxSize:t.pingOldContactMaxQueueSize??XH}),this.pingOldContactTimeout=new To({...t.pingOldContactTimeout??{},metrics:this.components.metrics,metricName:`${t.metricsPrefix}_routing_table_ping_old_contact_time_milliseconds`}),this.pingNewContactQueue=new vr({concurrency:t.pingNewContactConcurrency??WH,metricName:`${t.metricsPrefix}_ping_new_contact_queue`,metrics:this.components.metrics,maxSize:t.pingNewContactMaxQueueSize??zH}),this.pingNewContactTimeout=new To({...t.pingNewContactTimeout??{},metrics:this.components.metrics,metricName:`${t.metricsPrefix}_routing_table_ping_new_contact_time_milliseconds`}),this.kb=new A3(e,{kBucketSize:t.kBucketSize,prefixLength:t.prefixLength,splitThreshold:t.splitThreshold,numberOfOldContactsToPing:t.numberOfOldContactsToPing,lastPingThreshold:t.lastPingThreshold,ping:this.pingOldContacts,verify:this.verifyNewContact,onAdd:this.peerAdded,onRemove:this.peerRemoved,metricsPrefix:t.metricsPrefix}),this.closestPeerTagger=new _3(this.components,{logPrefix:t.logPrefix,routingTable:this,peerSetSize:t.closestPeerSetSize,refreshInterval:t.closestPeerSetRefreshInterval,closeTagName:t.closeTagName,closeTagValue:t.closeTagValue}),this.components.metrics!=null&&(this.metrics={routingTableSize:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_size`),routingTableKadBucketTotal:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_total`),routingTableKadBucketAverageOccupancy:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_average_occupancy`),routingTableKadBucketMinOccupancy:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_min_occupancy`),routingTableKadBucketMaxOccupancy:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_max_occupancy`),routingTableKadBucketMaxDepth:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_max_depth`),kadBucketEvents:this.components.metrics.registerCounterGroup(`${t.metricsPrefix}_kad_bucket_events_total`)})}isStarted(){return this.running}async start(){this.running||(this.running=!0,this.shutdownController=new AbortController,this.shutdownController.signal,await er(this.closestPeerTagger,this.kb))}async afterStart(){let e=0;Promise.resolve().then(async()=>{if(!this.populateFromDatastoreOnStart)return;let t=De([this.shutdownController.signal,AbortSignal.timeout(2e4)]);try{for(let n of await this.components.peerStore.all({filters:[o=>o.protocols.includes(this.protocol)&&o.tags.has(Bk)],limit:this.populateFromDatastoreLimit,signal:t})){if(!this.running)return;try{await this.add(n.id,{signal:t}),e++}catch{this.log("failed to add peer %p to routing table, removing kad-dht peer tags - %e"),await this.components.peerStore.merge(n.id,{tags:{[this.peerTagName]:void 0}})}}}finally{t.clear()}this.log("added %d peer store peers to the routing table",e)}).catch(t=>{this.log.error("error adding %d, peer store peers to the routing table - %e",e,t)})}async stop(){this.running=!1,await or(this.closestPeerTagger,this.kb),this.pingOldContactQueue.abort(),this.pingNewContactQueue.abort(),this.shutdownController.abort()}async peerAdded(e,t,n){this.components.peerId.equals(e.peerId)||await this.components.peerStore.merge(e.peerId,{tags:{[this.peerTagName]:{value:this.peerTagValue}}},n),this.updateMetrics(),this.metrics?.kadBucketEvents.increment({peer_added:!0}),this.safeDispatchEvent("peer:add",{detail:e.peerId})}async peerRemoved(e,t,n){this.components.peerId.equals(e.peerId)||await this.components.peerStore.merge(e.peerId,{tags:{[this.peerTagName]:void 0}},n),this.updateMetrics(),this.metrics?.kadBucketEvents.increment({peer_removed:!0}),this.safeDispatchEvent("peer:remove",{detail:e.peerId})}async*pingOldContacts(e,t){if(!this.running)return;let n=[];for(let o of e){if(this.kb.get(o.kadId)==null){this.log("asked to ping contact %p that was not in routing table",o.peerId);continue}this.metrics?.kadBucketEvents.increment({ping_old_contact:!0}),n.push(async()=>{let i=this.pingOldContactQueue.find(o.peerId);if(i!=null)return this.log("asked to ping contact %p was already being pinged",o.peerId),await i.join(t)?void 0:o;if(!await this.pingOldContactQueue.add(async a=>{let c=this.pingOldContactTimeout.getTimeoutSignal(),l=De([c,this.shutdownController.signal,a?.signal]);try{return await this.pingContact(o,a)}catch{return this.metrics?.kadBucketEvents.increment({ping_old_contact_error:!0}),!0}finally{this.pingOldContactTimeout.cleanUp(c),l.clear()}},{peerId:o.peerId,signal:t?.signal}))return o})}for await(let o of ns(n))o!=null&&(yield o)}async verifyNewContact(e,t){let n=this.pingNewContactTimeout.getTimeoutSignal(),o=De([n,this.shutdownController.signal,t?.signal]);try{let i=this.pingNewContactQueue.find(e.peerId);return i!=null?(this.log("joining existing ping to add new peer %p to routing table",e.peerId),await i.join({signal:o})):await this.pingNewContactQueue.add(async s=>(this.metrics?.kadBucketEvents.increment({ping_new_contact:!0}),this.log("pinging new peer %p before adding to routing table",e.peerId),this.pingContact(e,s)),{peerId:e.peerId,signal:o})}catch{return this.log.trace("tried to add peer %p but they were not online",e.peerId),this.metrics?.kadBucketEvents.increment({ping_new_contact_error:!0}),!1}finally{this.pingNewContactTimeout.cleanUp(n),o.clear()}}async pingContact(e,t){let n;try{return this.log("pinging contact %p",e.peerId),await this.components.ping.ping(e.peerId,t),this.log("contact %p ping ok",e.peerId),this.safeDispatchEvent("peer:ping",{detail:e.peerId}),!0}catch(o){return this.log("error pinging old contact %p - %e",e.peerId,o),n?.abort(o),!1}}get size(){return this.kb==null?0:this.kb.count()}async find(e,t){let n=await mn(e,t);return this.kb.get(n)?.peerId}closestPeer(e){let t=this.closestPeers(e,{count:1});if(t.length>0)return t[0]}closestPeers(e,t){return this.kb==null?[]:[...this.kb.closest(e,t)]}async add(e,t){if(this.kb==null)throw new Error("RoutingTable is not started");await this.kb.add(e,t)}async remove(e,t){if(this.kb==null)throw new Error("RoutingTable is not started");let n=await mn(e,t);await this.kb.remove(n,t)}updateMetrics(){if(this.metrics==null||this.kb==null)return;let e=0,t=0,n=0,o=20,i=0;function s(a){if(Ap(a)){a.depth>n&&(n=a.depth),t++,e+=a.peers.length,a.peers.length<o&&(o=a.peers.length),a.peers.length>i&&(i=a.peers.length);return}s(a.left),s(a.right)}s(this.kb.root),this.metrics.routingTableSize.update(e),this.metrics.routingTableKadBucketTotal.update(t),this.metrics.routingTableKadBucketAverageOccupancy.update(Math.round(e/t)),this.metrics.routingTableKadBucketMinOccupancy.update(o),this.metrics.routingTableKadBucketMaxOccupancy.update(i),this.metrics.routingTableKadBucketMaxDepth.update(n)}};var Mk=[77591,22417,43971,28421,740,29829,71467,228973,196661,78537,27689,36431,44415,14362,19456,106025,96308,2882,49509,21149,87173,131409,75844,23676,121838,30291,17492,2953,7564,110620,129477,127283,53113,72417,165166,109690,21200,102125,24049,71504,90342,25307,72039,26812,26715,32264,133800,71161,88956,171987,51779,24425,16671,30251,186294,247761,14202,2121,8465,35024,4876,85917,169730,3638,256836,96184,943,18678,6583,52907,35807,112254,214097,18796,11595,9243,23554,887,268203,382004,24590,111335,11625,16619,29039,102425,69006,97976,92362,32552,63717,41433,128974,137630,59943,10019,13986,35430,33665,108037,43799,43280,38195,29078,58629,18265,14425,46832,235538,40830,77881,110717,58937,3463,325358,51300,47623,117252,19007,10170,20540,91237,294813,4951,79841,56232,36270,128547,69209,66275,100156,32063,73531,34439,80937,28892,44466,88595,216307,32583,49620,16605,82127,45807,21630,78726,20235,40163,111007,96926,5567,72083,21665,58844,39419,179767,48328,42662,51550,5251,37811,49608,81056,50854,55513,20922,18891,197409,164656,32593,71449,220474,58919,85682,67854,13758,35066,3565,61905,214793,119572,141419,21504,10302,27354,67003,46131,32668,15165,64871,34450,17821,2757,11452,34189,5160,12257,85523,560,53385,65887,119549,135620,312353,115979,122356,10867,193231,124537,54783,90675,120791,4715,142253,50943,17271,43358,25331,4917,120566,34580,12878,33786,160528,32523,4869,301307,104817,81491,23276,8832,97911,31265,52065,7998,49622,9715,43998,34091,84587,20664,69041,29419,53205,10838,58288,116145,6185,5154,141795,35924,21307,144738,43730,12085,8279,10002,119,133779,199668,72938,31768,39176,67875,38453,9700,44144,4121,116048,41733,12868,82669,92308,128,34262,11332,7712,90764,36141,13553,71312,77470,117314,96549,49135,23602,54468,28605,6327,62308,17171,67531,21319,14105,894,107722,46157,8503,51069,100472,45138,15246,14577,35609,191464,1757,13364,161349,32067,91705,81144,52339,5408,91066,21983,14157,100545,4372,26630,129112,1423,29676,213626,4397,88436,99190,6877,49958,26122,114348,60661,29818,293118,50042,179738,16400,163423,89627,31040,43973,36638,45952,5153,1894,109322,1898,134021,12402,112077,68309,190269,69866,31938,107383,11522,105232,11248,14868,39852,71707,186525,16530,38162,106212,11700,5130,16608,26998,59586,108399,230033,43683,48135,82179,2073,5015,196684,189293,16378,23452,8301,35640,11632,214551,29240,57644,33137,91949,55157,52384,117313,5090,17717,89668,49363,82238,241035,66216,29066,184088,97206,62820,26595,4241,135635,173672,8202,459,71355,146294,29587,3008,135385,141203,14803,6634,45094,69362,50925,546,51884,62011,83296,234584,44515,56050,89476,87751,19373,12691,149923,19794,13833,35846,87557,58339,2884,19145,25647,12224,11024,77338,64608,122297,53025,7205,36189,36294,170779,21750,7739,173883,75192,35664,224240,113121,30181,26267,27036,117827,92015,106516,55628,203549,67949,60462,60844,35911,20457,1820,920,19773,8738,73173,181993,38521,98254,76257,46008,92796,5384,26868,151566,22124,2411,15919,186872,180021,28099,152961,78811,80237,62352,102653,74259,184890,16792,123702,224945,29940,19512,75283,14059,112691,92811,233329,20411,138569,53341,109802,50600,134528,66747,5529,166531,31578,64732,67189,1596,126357,967,167999,206598,109752,119431,207825,78791,91938,10301,27311,24233,252343,28831,32812,66002,112267,90895,8786,8095,16824,22866,21813,60507,174833,19549,130985,117051,52110,6938,81923,123864,38061,919,18680,53534,46739,112893,161529,85429,26761,11900,81121,91968,15390,217947,56524,1713,6654,37089,85630,138866,61850,16491,75577,16884,98296,73523,6140,44645,6062,36366,29844,57946,37932,42472,5266,20834,19309,33753,127182,134259,35810,41805,45878,312001,14881,47757,49251,120050,44252,3708,25856,107864,120347,1228,36550,41682,34496,47025,8393,173365,246526,12894,161607,35670,90785,126572,2095,124731,157033,58694,554,12786,9642,4817,16136,47864,174698,66992,4639,69284,10625,40710,27763,51738,30404,264105,137904,109882,52487,42824,57514,2740,10479,146799,107390,16586,88038,174951,9410,16185,44158,5568,40658,46108,12763,97385,26175,108859,664,230732,67470,46663,14395,50750,141320,93140,15361,47997,55784,6791,307840,118569,107326,18056,58281,260415,54691,8790,73332,45633,7511,45674,143373,14031,11799,94491,35646,96544,14560,26049,32983,25791,83814,42094,231370,63955,139212,2359,169908,3108,183486,105867,28197,32941,124968,26402,88267,149768,23053,3078,19091,52924,25383,19209,111548,97361,3959,24880,235061,9099,24921,161254,151405,20508,7159,34381,20133,11434,74036,19974,34769,36585,1076,22454,17354,38727,235160,111547,96454,117448,156940,91330,37299,7310,26915,117060,51369,22620,61861,322264,106850,111694,15091,2624,40345,300446,177064,1707,27389,54792,327783,132669,183543,59003,17744,20603,151134,106923,53084,71803,279424,319816,11579,21946,16728,38274,72711,5085,83391,88646,40159,25027,34680,10752,12988,54126,30365,18338,100445,230674,44874,84974,143877,123253,139372,28082,91477,144002,13096,219729,46016,50029,42377,14601,6660,58244,58978,23918,88206,113611,64452,17541,41032,10942,12021,49189,10978,40175,37156,10947,71709,106894,112538,57007,137486,150608,152719,40615,7746,279716,13101,19524,28708,40578,72320,1096,182051,94527,51275,22833,45164,81917,77519,48508,5421,140302,37845,149830,5587,27579,5357,428725,248187,6326,206760,39814,32585,89923,44341,288753,284443,96368,31201,94189,119504,20359,52073,103216,179,27934,32801,96035,34111,34309,101326,18198,20704,210266,37643,27880,141873,106e3,19414,56614,167714,66483,107885,86602,4379,20796,75467,4987,5017,118857,26003,34308,114428,29198,6686,29697,73632,3739,69795,16798,41504,7207,30722,21436,36735,28067,28545,3239,11221,36031,41889,100010,19247,317673,29495,174554,6424,129725,53845,94986,7955,59676,2604,191497,19735,102214,62954,23844,11872,179525,261436,34492,428,78404,142035,16747,17246,27578,37021,33672,57944,26056,135760,2369,61674,122066,31327,19374,157065,40553,130982,69619,71290,38855,72100,92903,95940,51422,165999,65713,57873,50726,7288,20272,2081,42326,22624,81120,57914,79352,19447,1684,72302,11774,302559,161481,96396,13692,414988,3721,79066,56627,46883,21150,11747,12184,5856,113458,176117,84416,52079,27933,3354,59765,141359,2212,216309,2555,23458,196722,142463,45701,44548,28798,19418,215,29916,9396,10574,114226,84475,13520,18694,34056,4524,90302,62930,13539,19407,77209,7728,38088,9535,2263,23875,183945,17750,26274,67172,10585,28042,22199,7478,51331,66030,26774,192929,31434,25850,50197,52926,178158,4679,181256,70184,229600,9959,105594,72158,73974,2726,35085,78087,23284,35568,51713,155676,5401,27254,11966,17569,223253,71993,103357,111477,55722,30504,26034,46774,35392,36285,214814,41143,163465,1051,16094,81044,6636,76489,179102,20712,39178,35683,125177,54219,30617,52994,25324,50123,2543,87529,58995,10688,125199,12388,60158,125481,131646,7642,133350,65874,3438,97277,101450,10075,56344,116821,50778,60547,98016,106135,13859,14255,16300,77373,173521,8285,45932,37426,4054,114295,55947,7703,39114,52,51119,128135,19714,60715,9554,50492,88180,2823,118271,52993,122625,97919,23859,37895,25040,33614,32102,20431,3577,9275,15686,43031,157741,110358,1884,40291,125391,13736,5008,64881,87336,77381,70711,43032,49155,118587,70494,4318,10168,30126,12580,10524,280104,104001,145413,2862,84140,6603,106005,13566,12780,11251,42830,571,179910,82443,13146,469,42714,32591,265217,424024,92553,54721,134100,6007,15242,114681,59030,16718,85465,200214,85982,55174,165013,23493,56964,82529,109150,32706,27568,82442,5350,14976,13165,44890,60021,21343,33978,17264,4655,22328,27819,75730,16567,55483,14510,17926,45827,150609,3704,7385,272531,161543,76904,122163,52405,2039,19165,41623,14423,228354,3369,176360,85491,7122,35789,303724,4465,13628,2233,55311,118771,20713,10006,221519,45115,71021,35650,29775,7337,10864,20665,21142,1746,15080,1624,32449,10905,105743,229797,7701,3940,22997,178467,57208,389057,39683,59403,63344,63125,54847,69691,18336,56448,3362,37202,18282,29648,138224,35867,10495,5911,28814,26653,31514,176702,26550,45621,11734,4525,40543,73944,121080,27858,155561,14887,44670,30742,8796,107455,113472,56369,75581,183777,240095,133699,153299,8768,160464,26058,49078,103971,21875,71486,44888,17156,9678,89541,123019,102337,3972,83930,21245,87852,109660,287918,183019,686,10100,39177,283941,11274,24736,26793,26214,25995,77011,141580,4070,23742,46285,46632,30700,26669,19056,35951,115575,174034,56097,35463,87425,24575,44245,38701,82317,85922,281616,100333,147697,61503,7730,84330,8530,59917,61597,17173,9092,32658,90288,193136,39023,20381,56654,31132,7779,1919,1375,117128,30819,11169,40938,23935,115201,101155,151034,4835,11231,74550,89388,59951,91704,107312,167882,115062,12732,72738,88703,464019,158267,57995,60496,737,14371,123867,4174,243339,159946,7568,16025,134556,110916,38103,191,80226,88794,29688,27230,10454,76308,57647,77409,113483,66864,14745,19808,12023,46583,84805,16015,17102,2231,20611,3547,95740,250131,34559,108894,8498,15853,159169,148920,20942,2813,93160,45188,210613,45531,52587,149062,39782,28194,57849,60965,84954,89766,84453,100927,16501,27658,165311,103841,54192,207341,19558,20084,319622,5672,205467,98462,61849,36279,13609,147177,24726,165015,209489,59591,31157,6551,117580,75060,141146,277310,21072,22023,106474,63041,137443,122965,68371,5383,42146,98961,113467,30863,23794,4843,99630,30392,82679,13699,241612,33601,93146,24319,18643,32155,95669,40440,15333,34089,67799,142144,58245,38633,114531,117400,77861,188726,5507,2568,8853,10987,107222,2663,2421,11530,13345,30075,41785,118661,104786,17459,12490,16281,71936,193555,17431,5944,71758,26485,77317,20803,367167,158,7362,93430,11735,172445,46002,11532,54482,930,62911,2235,23004,179236,4764,101859,208113,22477,55163,95579,14098,67320,162556,90709,156949,3826,57492,4025,34092,87442,104565,6718,186015,28214,14209,10039,107186,233912,58877,81637,55265,39828,6194,145813,50831,105849,4974,88319,122296,10272,197216,95714,51540,72418,23324,91555,8743,140452,250249,51666,34124,7229,38592,129641,78169,174242,22464,149964,51450,14034,10026,95376,26190,120062,14401,8700,265,31386,143573,7203,229889,61567,4227,140981,2466,72052,10787,10062,30958,6099,38471,30103,23202,208101,70847,467,58934,32271,32984,36637,24107,30771,17109,73353,13650,2098,157040,67366,66904,106018,265380,107238,18535,44025,32681,144983,62505,91295,56120,3082,77508,10322,63023,36700,81885,224127,16721,45023,239261,111272,13852,7866,149243,204199,32309,22084,42029,38316,126644,104973,14406,43454,67322,61310,15789,40285,24026,181047,6301,70927,23319,115823,27248,66693,115875,278566,63007,146844,56841,59007,87368,180001,22370,42114,80605,12022,10374,308,25079,14689,12618,63368,7936,264973,212291,136713,95999,105801,18965,32075,48700,52230,35119,96912,32992,8586,16606,101333,101812,14969,39930,759,193090,27387,42914,12937,5058,62646,64528,38624,25743,37502,3716,4435,30352,178687,26461,132611,42002,138442,35833,59582,16345,8048,60319,49349,309,47800,49739,90482,26405,34470,63786,32479,85028,39866,47846,11649,23934,29466,2816,42864,31828,7410,74885,49632,47629,111801,90749,19536,18767,105764,59606,21223,10746,76298,22220,39408,7190,79654,64856,11602,82156,272765,17079,70089,245473,51813,184407,384678,1576,122249,5064,27481,6188,25790,74361,27541,318284,45430,31488,620,93579,45723,192118,22670,51913,4162,70244,35966,26397,16199,50899,209613,121702,287507,2993,36101,132229,67345,33062,76295,118628,78705,52316,34375,107083,107454,44863,127561,33964,3073,154010,190914,55967,39074,6272,31047,5550,41123,26154,98638,47110,19998,148091,50229,31329,59900,195442,19106,61347,73497,70015,682,45850,25776,38022,148951,6288,37411,232526,109277,27286,32342,9262,5220,16651,23175,46740,129438,78614,121925,66914,88710,127952,5563,21500,34521,10739,14863,191006,62956,17359,16749,67027,56284,69134,43301,35039,58883,54466,60823,404451,75743,59856,86979,7923,34273,83785,32142,7693,268986,197428,282681,17049,22346,22990,92245,107180,3357,37104,96724,49153,7683,31197,43267,82231,164276,23696,20848,188364,22309,24821,158707,1018,22514,70922,27792,45589,59709,10765,736,35218,63479,51987,24275,63588,55361,92929,81964,4658,20122,12330,44058,13065,311456,72224,8337,211229,38979,22590,138478,52757,32595,133600,8838,31549,94412,43391,90056,1585,94802,127271,6223,31889,137038,132910,2165,57616,230152,6080,10748,36737,74579,134062,50525,180532,119270,34556,76155,82394,52595,29258,31435,87820,67996,26943,183878,38007,2410,13526,180297,69856,3503,187396,167700,7838,16701,9199,56267,3661,37407,65994,23767,5708,62508,221700,67088,86978,46776,84434,32088,5612,9149,88244,21685,95151,46750,189612,2979,506311,2594,3628,40074,105039,78243,28523,6651,38058,71999,30992,12764,68261,108991,6165,26450,61961,13400,22426,7490,60890,109623,2070,12958,50355,67979,257096,7213,42578,52121,35716,65461,7516,124758,39268,302,64712,14977,1467,219452,2840,34229,11121,21602,19270,63574,8024,1532,17331,79839,78885,52029,180767,57957,6069,91265,61380,55767,8927,32881,287603,22149,35029,68876,6428,199567,46926,13412,104132,21434,366616,45060,110046,81924,128910,45886,52821,130416,29416,77342,21762,67329,121432,79924,11724,38625,81006,102033,28338,13326,3250,82056,82526,38212,21112,12382,111495,3263,7414,86274,93490,40844,30224,45212,24019,48411,71367,24941,76729,57776,3769,38114,202019,197745,31953,237533,33270,201580,255648,100798,44741,32241,98468,106931,10085,15090,170358,33154,66787,18819,69760,25061,234005,82660,6295,131975,16874,9076,4094,25005,17740,40908,19533,220019,44330,99792,50040,19619,13950,55228,24423,31253,95308,103177,184795,28590,82285,5059,3210,75525,49894,70007,56178,10580,36051,139681,21617,98736,3555,106306,164189,37352,63915,47824,24883,145530,61904,28444,11483,19837,145446,30420,112972,85939,11835,191233,2262,20705,58630,1753,148334,1197,144714,6887,11223,107667,60879,77914,4151,57417,81594,96681,169430,1784,20444,95138,254041,27038,596,7117,72808,13759,3353,126776,21074,55322,27081,36942,39547,139830,179275,4453,713,8722,71399,19204,25785,22794,23923,104114,11291,25458,102309,88396,75288,230440,206396,104551,58447,130857,37247,94734,31548,176529,226077,65159,20104,10096,66881,94191,237909,27109,37404,1520,27421,25220,113003,23423,24884,50585,6286,231877,150800,11789,3226,90004,60642,5053,202400,61442,132531,175329,57138,30116,103847,9973,75367,16452,32360,59119,21246,10191,164804,23305,61051,37348,154530,13214,5468,50403,66754,130976,50559,80515,14436,155492,84017,5472,43107,41240,2890,90431,70188,382,76234,48040,50211,281038,237007,32115,142178,1536,22761,96429,1811,31243,1679,49143,55209,17402,235054,61494,7462,77030,34925,87609,78002,9499,9027,73289,201078,101379,63544,27666,5469,10642,30029,49816,132979,95620,58086,351930,116300,2110,2043,30845,6154,11279,16727,4122,2277,27281,4971,3650,39060,61970,65951,39674,75686,38151,11370,130809,177895,32665,63725,122267,7857,39618,118483,44792,157755,178624,136994,24260,41308,22471,12404,21707,12486,30473,52781,50246,20247,39065,909,56825,103158,128603,31542,1089,41935,32744,12428,37963,84420,33134,72921,208449,42622,168151,127335,147107,46699,38216,12591,94342,85814,31423,24944,2605,87542,67473,192551,4496,56321,91819,17630,6300,256183,114569,202090,33209,35289,34897,24967,40520,43470,5344,10199,34810,14283,10381,10017,62923,49924,23233,64539,13051,35686,19698,11570,135555,120868,44924,87065,52318,52335,47586,140906,245885,109834,78668,9065,46990,25258,72022,61243,40838,4545,146387,10537,11557,17470,36930,68104,46711,24264,79401,81043,18225,120488,24746,84338,81652,28266,13776,21878,46973,1047,230465,73357,95777,24973,210160,62210,58404,110633,169651,6937,41870,9909,26822,191062,76553,27519,96256,239070,2478,205678,67955,58532,20601,50120,19148,78501,195724,110740,8249,109665,27446,30568,57631,31425,49752,32820,65504,50079,3663,102256,219898,23849,211315,14645,4359,91767,9528,12449,49366,7941,49763,107848,8930,27086,50686,9744,10447,81935,39513,46514,1670,29229,6172,22312,137280,97759,9806,14445,22976,56458,73391,34983,93760,174219,52573,33149,59747,2429,136277,75123,165263,91040,7446,57632,48633,97140,246081,84766,151684,79918,93268,120346,54059,54875,77858,32996,103590,45276,11968,19600,25849,17159,132907,42828,16817,4913,99462,103303,27395,5737,74184,20749,21160,14377,77062,131403,158735,10999,27799,77785,9320,34366,51593,61070,33746,47048,29268,36675,30262,53297,9832,82e3,20188,122292,39917,7331,18160,68301,185935,134830,15031,4935,10004,165845,185534,46923,30109,44134,122631,18874,22903,112790,26561,18549,348902,82871,140345,255565,135390,63556,103747,145055,179600,145662,296111,61661,211987,23952,52342,126343,48450,32919,44277,82185,9591,62139,205363,376969,394874,108461,18040,120885,14798,39863,16571,16794,58271,81025,55206,14640,118656,6361,44092,85970,6262,153863,108244,180200,72264,79947,38044,10050,5735,61221,80712,5471,115689,11391,11661,184257,20010,60116,30320,19327,134598,45455,27542,18004,125092,452272,1549,91523,46567,180063,156026,2608,11174,58848,37788,65907,80194,30490,5786,40775,119519,106241,11323,156297,8425,61495,2617,29675,2425,59886,112582,49142,59618,4863,50597,86710,50650,168632,27693,85641,83643,18993,25768,84284,28090,93592,36627,312804,43381,9887,9402,100931,97165,3311,173330,66805,28935,4963,184460,3201,78102,19126,21607,37496,24938,22615,16153,32862,134792,153318,61120,6067,2812,12826,12792,23825,37559,64662,202250,102694,155488,85881,149193,46233,65383,15521,106982,11358,176786,25752,39717,34208,24510,32464,77742,39371,72028,138229,60688,71386,102834,132477,2208,11548,63670,271279,28351,30338,38620,32491,99845,143885,152266,13252,2825,178663,108097,1775,78201,14897,113573,163346,62292,171129,22183,96598,38733,64971,166776,117445,9968,146393,44677,74867,20908,97328,12761,25656,26785,9148,112344,26115,99176,110121,22437,49547,6180,79320,5835,31392,43328,33377,75870,119860,69497,80273,7325,155219,43167,111173,28347,20222,3763,71752,55041,47252,14618,28088,15012,97805,194698,54636,2036,41349,6173,96604,61530,51859,43782,13361,24334,22668,24792,7070,23441,16789,3209,36211,208475,26242,32880,122181,182407,21444,31060,88459,29929,77907,12716,10934,97005,20599,31690,8403,58445,30303,22700,10336,86731,103115,337709,72556,46788,112566,47684,67089,53548,36874,56487,41387,125985,26893,40071,106683,73712,18787,40105,72992,67246,137276,50802,36790,70328,138827,22466,39263,183295,29858,50975,9322,57397,10654,24364,30383,55799,41600,23584,127295,296610,129078,143558,244131,86397,36049,1085,80677,3820,108139,5476,34767,24683,7758,13060,7239,131671,250593,59556,103392,29810,4188,252323,39404,116877,7651,43600,40338,13554,157253,39196,25978,144387,61211,234,50104,6129,10449,93777,9240,356378,274148,4439,72970,3724,147770,78680,62570,115877,40027,40547,36817,224392,64609,34795,165027,67440,2477,37206,23431,50754,164797,46018,94995,170982,27051,7957,22767,3674,27900,56419,18930,60701,41302,2692,84749,339721,61996,111094,80221,50129,1045,8153,62945,19202,8250,37208,37418,32560,79477,41106,88569,33963,36693,5892,30570,1581,66471,49647,11922,160717,29442,5643,114865,82962,95982,132098,22633,22838,94726,54556,28566,205039,162340,33216,16849,35847,221339,94851,26533,71469,1805,3804,12935,45483,71020,36310,65381,192960,34240,35165,59773,1248,46954,155332,96864,4246,388800,16129,57133,74592,44807,442014,38203,42574,80818,91592,26377,36424,65760,977,77387,22628,147610,28018,30561,98454,6969,119628,63648,18170,36854,26601,64018,22027,37279,51395,152934,21153,9430,58760,194742,5330,55115,34158,28917,174111,13171,122326,1526,43896,66094,25325,4234,148354,11450,275,18999,112191,44365,22723,68409,8733,57746,96565,75007,14196,108844,29475,88599,177563,100792,106156,86323,93726,14248,135341,194131,40126,47099,14779,8272,39597,95983,171398,65882,28052,10393,47213,40689,22120,72212,106829,34964,109146,753,648,21660,30047,17527,181025,5619,145357,4085,216883,9359,186951,24779,53931,24545,36197,223296,62628,168101,4243,107313,30321,26642,13049,51059,31027,107912,807,73550,26551,84369,122422,165872,49754,74213,234264,33151,52014,33100,87183,22365,52500,40013,23302,5652,72723,21404,26107,48434,587,94049,168493,96418,32871,70860,31709,25128,443,71597,166253,15670,70994,26341,133675,28280,75491,54756,47955,56028,26182,11952,113272,472197,64640,110753,17919,337,50642,22576,142,87371,53391,93210,126694,15285,19642,85667,14148,1506,42092,52962,33243,11970,20734,135843,57044,58880,13002,219134,22876,64754,232519,4257,43120,321573,24799,64526,124728,52579,81472,70831,276848,17403,74359,23021,182101,74597,23744,148267,12055,7976,5349,11772,67540,167347,65318,18720,127832,108238,22828,90233,9987,259080,118185,73209,79270,13775,90100,137742,90799,70569,15699,19961,9087,67475,57872,39731,8810,134897,131868,146849,19898,3334,2281,167061,91073,60356,467742,74712,188,53179,137679,92769,29241,9537,132595,80119,1041,88962,5976,40171,44911,102859,139059,104558,98987,47761,19272,71472,113864,175377,73338,10857,23402,23758,1591,139864,5644,4076,118760,16427,134198,18853,20291,100849,37423,22038,36677,19071,195521,57445,11069,31869,55718,66882,148490,44,41296,75242,49704,166810,9906,20943,122258,49112,105667,15969,10344,6408,187694,21399,72742,58970,14867,14376,81889,41856,23225,15042,56993,16074,131389,74276,72407,53875,383108,53597,37363,68993,44854,122548,430927,198279,38430,80409,12245,2981,628,2818,17760,37437,238229,7968,46892,2200,3730,34190,65983,37959,112291,87850,70827,6522,20750,73913,111621,41652,19587,2780,58668,25916,85259,18200,168962,95781,42445,102050,7776,57662,103313,47742,96358,41964,66174,100396,29069,204735,19679,27978,7479,40264,22534,61183,36081,107436,58223,14680,23002,101311,24716,124108,12908,5646,31750,40380,14215,232799,102772,14122,96775,61398,50917,12096,149880,67833,598749,124194,155871,49216,790,14677,65319,56917,7440,145744,95701,12206,49405,129269,76199,45732,9767,11058,9047,210885,11051,7392,26307,2130,8132,147526,20802,232698,115660,50060,59789,57344,107623,80343,112676,23291,9866,160971,34032,118291,15719,59730,164911,28975,2659,58046,78480,21854,66209,53863,109085,116045,29021,46481,107552,22130,18764,70254,31272,11300,52460,43933,84738,20721,53869,190840,79673,105300,7561,321817,66924,13940,33281,101046,183181,32176,71878,5678,62924,79535,56646,40303,19559,27703,93042,73368,42187,3670,37376,46440,7023,36816,109628,20680,5940,276440,275233,170848,112093,136996,14984,20226,111441,77693,112960,48577,39370,55707,50314,123404,26570,54281,61372,123391,4857,35928,246740,132507,106646,44241,7196,92258,9825,37688,51197,303141,5590,15476,132986,10955,85782,34486,26696,7991,28813,18858,39546,11703,11365,38185,5716,93555,11925,40121,60002,6985,10976,171384,3887,43394,13337,56346,6381,252336,39573,75042,53711,1028,31781,44295,95925,131713,7214,68125,43571,70954,213234,1628,8760,13391,65485,17320,56038,1710,25248,60803,57399,19839,3870,326,281556,50945,72400,21460,316244,75619,56246,98775,481,13513,55765,50427,7388,123519,32929,57908,27124,61316,101097,57467,30228,48792,10788,20402,37318,50526,155730,34456,158065,145305,17832,43733,64052,4506,35072,205355,177028,184004,187081,68616,35938,83703,10367,36892,93186,260137,51934,89970,4985,23445,26755,21558,7948,78741,23376,124405,85594,68596,57536,49351,12619,56593,132668,99924,109728,71844,71935,196018,65464,17617,14987,89701,143773,33997,8687,22701,33258,2914,4436,72108,85610,9671,49067,2327,82988,1361,1672,44033,35777,30269,24057,10605,82236,616,15793,13919,47249,112086,116698,9484,80207,90574,33304,68624,93127,56101,42210,160929,4827,38995,38095,4701,125119,5027,33680,9236,231236,14135,87837,23318,70261,78893,30151,81482,14332,1084,74256,27532,46644,79185,3148,62615,6981,55672,31668,36825,1849,14536,37446,14738,23779,43058,162749,72199,1168,21346,5592,85932,85302,9668,18351,57135,150360,2080,228015,77953,34670,119302,151751,31009,106725,84265,45214,59289,74178,113071,263206,111009,4021,44449,188119,192629,123592,392506,292847,114487,12831,205858,9852,20780,79648,75767,357014,97721,18166,21005,67950,33226,204009,16536,2987,11335,66717,144910,47950,17262,55060,15063,2934,51038,26775,178497,66008,3427,49433,128592,20036,157553,63861,3089,23015,51210,28696,35933,49942,71135,231518,99620,17248,21835,176536,20676,16944,38700,165831,233253,295625,36723,13023,52745,10907,19423,67972,125868,95473,82875,1183,108455,52685,33417,64095,21433,52438,33191,127809,44505,211823,7810,2752,95548,162031,7185,91196,47563,61721,33359,17897,23682,42806,178101,22874,49707,199897,75419,82456,8618,11171,79712,116847,18783,44190,46564,5346,59046,95032,7893,14916,3214,26800,24172,121453,34362,10250,17408,18888,4840,68696,22831,13162,36005,32512,14800,62357,41723,45046,27247,37486,5372,2564,34261,298500,66509,133920,89138,31305,117697,19097,108304,81386,84106,23802,46411,63304,946,51417,41777,41041,19501,115864,60743,294354,37955,94165,18116,1156,17937,20645,57114,90804,58042,48643,92288,9861,2557,88546,61333,101008,12853,5148,87856,4152,144503,73841,18718,9789,147565,10846,42085,12789,30223,8993,56352,67203,2448,28215,6052,23540,126319,75933,36689,80235,23231,23561,21383,38800,77548,102798,21234,31468,158608,46188,63960,191679,8051,67014,11185,170078,42186,28827,34777,41930,212079,12421,34750,24111,110344,73918,45171,70826,141949,40063,23979,24254,37309,26724,27179,24718,83648,54938,14591,17425,29525,102675,48975,48654,12316,8929,60640,41709,50168,63264,89812,50716,48632,38755,138583,160123,55579,71829,24230,233277,46322,39650,166388,34718,24108,98252,7031,106695,62498,18258,35062,217827,78731,34824,33354,19520,60852,2432,60224,8587,2836,62955,702,20227,42285,40560,95592,62486,11094,53035,143291,18842,46177,77994,1770,9657,107422,172915,32655,128716,25886,25164,156740,119928,165875,85817,11007,89110,33956,12652,65156,180266,8494,36889,19958,20955,96,1264,118288,135769,44754,86671,5632,19026,168220,289120,33569,93821,66144,70635,7687,5642,2714,55445,56636,71545,184182,93133,7332,37389,12643,52315,22729,11014,158742,17050,152889,50178,34601,41945,52136,9948,26914,63548,95721,115951,40759,8960,158258,38938,49232,48325,42234,81523,253019,66128,40978,20048,238048,38760,62928,122560,118532,43687,137472,163689,26680,9878,17448,51035,16211,60834,36749,29178,14241,59868,150086,2305,26477,42422,34342,165341,83279,33894,14257,29928,12743,13957,125571,89134,66712,10952,16507,147839,30146,7249,16565,45399,39874,114565,215780,31990,230881,171477,102,196546,44538,10880,84948,281705,86651,10617,31395,2342,453658,43569,60561,132901,21845,17727,58556,258242,22262,58728,4008,77997,11806,37431,30599,81375,109137,185787,114085,217292,97453,169085,30593,60212,11544,102056,65580,2384,91655,4855,95725,7295,157994,16228,20669,53276,141590,105246,17334,25440,76067,17967,39321,38911,11362,28559,63807,21627,26468,85816,40120,1025,15234,58319,69516,66512,124548,75845,78873,22137,46681,51242,85683,32909,76747,35555,43396,101465,1765,73094,1077,2962,39028,66777,57831,42048,15828,13962,36041,63657,52412,5242,58846,2141,5506,219012,134451,3936,182230,17558,17153,152237,22621,49377,170216,35257,68233,65374,6510,11126,212151,7184,2480,22517,3437,33073,30156,16557,3768,55067,86829,91e3,12350,148650,66017,79424,70885,49066,28250,21369,51213,34533,11510,3258,18176,18465,84413,6315,36411,163765,4346,356,107618,598,13727,285026,162695,8749,14583,7132,63521,184253,32378,25991,5604,30961,53675,4874,84693,5086,34811,26978,56564,7904,33519,51221,113942,69253,6664,125563,22055,220680,102008,742,51930,19494,176108,44424,35123,13025,75685,11759,74335,22250,181453,131147,16984,132115,154311,11991,76452,52609,85351,196,30969,9198,74919,2529,56838,71779,29187,116304,3504,62330,41190,86153,28393,254926,104228,105189,13264,84359,3574,12415,8534,57147,10175,188174,59504,60932,66318,16407,107921,17638,99103,49278,28403,39786,145865,8462,3558,43406,142271,29139,21989,36552,93955,72365,7176,13556,106185,37957,321774,17782,129017,51154,27938,24952,1935,39366,2791,33489,41582,56078,24558,9311,5449,218786,27808,190429,68013,36020,86003,29735,3404,87348,119357,115714,2324,86796,81973,40992,43376,93621,28784,16808,36367,2517,2909,191926,24978,55303,53308,205724,60068,3098,21375,64784,23949,26579,63121,12319,80145,39967,97861,6757,70143,67642,37082,34698,69140,122883,46151,62187,80934,429,19437,135071,137885,222647,13331,154065,327,61778,74257,40116,37493,14855,85079,237641,42342,102164,199965,71204,4662,29368,5042,113914,122214,8955,13149,102503,43173,5659,163787,69003,307084,63392,171080,21390,81918,86666,36622,24126,28887,5736,28054,207170,163428,79891,346467,95363,38980,111806,80828,9200,19288,294896,114468,87405,111715,141705,7015,72754,68463,48738,243147,33397,101210,37051,98801,82847,20397,4940,185559,18716,54718,83491,11725,40803,1128,12128,23060,5174,7745,67007,46701,1571,27807,180186,256996,18975,16837,7877,212758,250379,15440,87954,57755,24719,124057,83461,258,50864,8874,29038,71289,31627,15429,9005,4061,113851,107716,82819,13651,79656,117851,17539,111446,12938,39724,190787,4352,15402,21070,62708,8539,23777,73853,13552,38810,86117,16285,56400,1718,75342,142863,29033,378,110113,180321,32586,23606,26393,160984,207987,23783,8406,16904,24596,47274,11693,46539,60524,78595,48423,31718,20170,9009,146268,15183,191060,172765,1349,138436,37365,10970,40509,225817,20021,70394,152138,21541,66559,66544,89352,2725,17258,91345,7313,3815,115868,8660,40362,4071,103524,39388,118275,21950,6549,38226,32754,209574,29201,43495,18028,20296,40597,18370,47520,202450,24134,2219,8195,69545,38041,136934,46374,19041,159811,84865,58620,846,98749,13569,30714,97246,32186,4479,27355,92973,35214,151491,75963,37631,1561,27200,238083,23182,60756,12291,25766,39355,102333,87362,65741,59906,19538,201575,48772,102938,24438,292580,39964,66366,9004,61379,50548,37622,38732,28379,68180,76622,17488,69849,5963,7219,48143,43413,55358,540,58691,29506,19245,52193,48621,5518,13048,118625,44755,191081,42061,89197,2259,60665,66994,71210,51232,3585,142096,55024,7892,8345,58653,463307,65658,64319,137941,136323,53499,12746,43492,6978,95163,29925,60175,5128,7352,41463,184756,121146,20473,18426,4598,5309,54580,14277,121151,10691,56711,43880,63409,76682,11830,172218,264898,32632,66536,81062,31649,25788,92774,60222,11100,63159,9432,224657,25240,53613,152,138620,163829,2397,85345,12501,37507,64932,38575,43522,65789,80198,78796,35226,3851,108891,73311,3060,28391,93671,39663,46142,30982,66041,37281,68157,26553,71872,81142,211527,39747,118119,22695,2859,11066,20232,168911,7933,197005,17066,111071,44434,133994,120798,12766,227798,45756,132852,29917,36076,55352,65281,129800,41958,18944,84678,18580,168093,132621,39997,54092,27740,32354,3770,114118,103242,43918,15899,18574,145944,3190,123469,219903,24169,100571,62403,16776,92779,14535,17168,16475,14304,37231,1712,28218,242754,61688,28980,1318,51359,222657,99200,67989,31772,23932,35351,201251,49041,27306,19128,40135,3986,77333,19649,120683,151927,21081,7076,78375,77501,101599,8011,89585,96715,58179,5378,102138,106793,26051,217276,4197,16297,27014,46721,13322,22806,5278,29629,70632,9647,71519,58818,40603,128530,8903,36770,56900,31483,26935,43845,34265,34920,87658,6114,84767,64250,47318,50720,19264,162514,33357,13117,6705,46696,75032,71054,87004,42035,69138,11903,99854,102328,19611,34525,69312,6431,49842,101600,133178,108751,41829,89939,225664,48916,99556,9195,130387,5960,36857,116724,53518,94002,39077,53996,6945,22261,64291,8314,152785,57588,16522,9091,5048,87671,35441,39509,1945,12423,158923,178413,37549,14095,1475,73188,62878,4819,24012,68534,42606,4010,120809,57497,59564,101758,103718,32701,80116,12345,95834,46918,21468,53213,15665,31200,3867,5140,96013,250744,21016,10069,13968,35449,180829,27683,39704,59956,22893,3115,26293,32785,75934,62445,141162,62720,2018,83638,19949,114012,95006,3330,99829,130935,309272,9565,55874,121727,37017,23586,319858,40970,27602,8625,112329,61060,100088,118525,25922,16232,1907,60671,51583,44553,80993,5262,94679,8676,940,20736,11823,3020,16476,12340,152600,97416,3703,25744,66826,16245,16876,46446,84798,74227,176020,45192,61955,75496,23946,23626,40372,26036,6149,11822,30582,16541,41914,82385,232823,40921,80773,14930,3631,7517,39619,4348,36180,126106,138939,62611,1477,113512,47321,25052,14546,118881,29060,23589,128322,36795,18401,137921,104699,267929,36194,172791,18113,4766,188215,30083,332586,94089,5805,77909,22194,68234,154976,43220,40660,70001,184893,138095,11128,103010,22663,5108,212615,8485,5565,49222,54614,26530,42639,16319,55062,152662,105595,21114,22216,10294,68158,10436,86950,7206,62115,3977,3657,59874,456,118617,18156,106663,112229,80992,17442,8217,55551,5133,34344,251927,51153,39364,201321,7816,66803,23057,156724,145664,14276,95705,979,2796,6875,13429,212525,50602,26276,28284,3424,19465,52397,46963,31420,51399,206476,92317,48851,637,100820,83349,10317,60227,21972,6908,282439,32857,224767,95629,83882,42106,87338,69757,29840,68709,37665,45244,114577,49188,175943,54009,186746,106158,70168,3358,234002,50555,9221,129338,9562,20118,32923,78479,118280,65752,4977,10474,102174,60947,129006,10570,83451,8598,8078,159367,123785,80438,16742,5905,5281,181513,42402,6977,163136,93179,42191,14968,50421,112401,105440,33456,57347,121611,4221,94954,36517,24046,27796,6255,33394,72990,135408,116627,1233,57874,25654,95419,68156,401399,313338,55208,45573,93124,119251,47200,38196,11909,130667,45391,73904,64964,167846,4137,115606,52036,62214,7969,160925,7187,1132,134835,40309,73195,64494,80472,444841,61111,26500,45323,40743,53625,52797,22659,15631,29739,36706,28841,39147,102836,26794,10536,14845,87305,45874,12241,127587,83833,57183,79722,30844,41304,84655,20825,92500,3722,25655,27811,10157,81634,31362,34088,92487,70123,22190,185100,72658,139035,192523,88241,2078,230490,44528,85638,100198,22088,29982,291233,241062,13865,4445,137791,37835,107218,31726,19718,38234,72528,23046,19177,66695,5109,17251,28077,5617,21554,47839,72425,133825,1486,73065,181275,141508,21768,62971,63082,2512,34200,9904,120309,6392,91243,68416,268253,41199,116757,138551,185526,41246,28986,4093,19057,17295,4148,245766,122360,35356,112075,20301,75441,10998,7977,19769,62922,937,63547,100196,26427,157820,20983,236696,22935,8140,90315,156004,47204,140973,7726,45097,52725,22636,23436,257282,105247,522,88389,216031,202204,46812,211666,19693,68828,81691,45925,11256,30292,372,5236,167826,88328,232776,151611,5360,82104,18841,80393,25465,18285,20320,72377,31730,33160,45803,38715,27705,37379,24163,18360,103586,4015,32305,269494,91252,20080,36567,54650,7797,57073,12650,31164,42209,6375,261663,105528,81661,106002,2800,5375,17247,43151,4442,15727,194619,100855,144898,62320,78465,39929,16454,1967,28311,61363,17219,9395,8745,121445,76939,80385,162380,22009,54191,44248,16299,122830,48151,74429,78291,64755,14238,44966,2511,17712,67954,93583,829,105899,49935,84750,11591,33185,85447,42717,27409,208542,28965,62052,52525,5597,25694,65594,16343,63224,276188,12475,9331,127507,38522,57287,24128,133161,79723,105548,133695,48917,27558,43278,46520,13778,141954,110785,83366,17715,46317,105763,66298,147013,41086,94180,16478,220447,44611,730,19722,78975,117889,125643,26254,16574,18480,65006,15806,38549,246418,46052,36056,8440,34984,30170,3163,59800,4458,115442,4283,41970,33507,104078,1653,22,121158,276486,3655,6338,24048,133421,23641,2161,24422,36006,8086,10675,181474,12307,29514,59143,14729,52509,87128,122470,19446,80852,33314,24573,119864,14237,9652,57779,6612,51851,15284,98871,90581,124466,156831,21190,22015,71380,161906,87247,69201,18392,17908,108470,72962,40719,14338,17911,95260,43339,20610,78916,20710,72451,11315,31448,17263,58853,178878,48111,116002,45497,80506,82605,85880,36300,121755,25215,36118,301929,88728,405223,276136,553,34704,212438,49970,78329,922,20711,25036,257130,38295,145369,18128,15385,30829,55656,48345,8012,3561,28004,122041,192900,58338,112508,41085,29976,87040,47117,23905,4336,92061,138880,97407,42083,172121,6256,25192,172671,5,93568,1420,12677,31605,56743,40620,6015,78415,231077,31298,80026,13902,19048,24924,170586,32955,176119,87859,36731,6773,27711,24658,26475,115216,133207,93250,95820,88522,8317,5714,124047,55219,86860,19677,23961,22928,162209,8904,225992,359835,56084,96201,29392,96558,86071,93643,55114,13347,8183,95129,82012,2017,123336,34219,115554,157159,47747,101684,41008,18735,193781,104151,226906,7552,179874,124113,31159,21162,44010,14771,51268,166128,31382,73124,77438,92830,205709,12113,1292,38937,13114,1334,2118,15597,69581,14449,21934,76618,48728,67038,14967,51495,24243,87736,147249,26720,11119,46063,43749,5843,44147,152629,133428,65703,14269,45604,57982,28672,55616,45957,8438,95433,37698,220862,132034,39456,61870,4161,26501,73560,56418,9845,4654,20916,10456,88920,119358,9015,65931,96507,48029,38534,21676,109081,43078,34943,25089,6131,28766,23665,5477,10255,16695,67,45778,42443,42770,29534,23733,100513,62617,42630,48746,14191,43753,50295,26007,8792,57243,43119,54725,164253,58250,112304,131796,25165,4651,3188,24831,47748,3705,19540,13211,102095,5593,18699,23666,32005,117571,33541,60584,74573,86311,99443,25172,27222,168938,7143,11853,53560,18834,19960,86522,28217,53266,117700,72989,34323,18721,66450,34346,74056,47217,202002,46269,9429,68582,75458,37823,82843,96652,32549,145144,27958,19820,158086,31955,201406,135379,31207,192545,12950,51704,9094,248263,76147,64028,110009,79407,89345,99284,223492,47966,26848,15359,201137,2861,110507,71231,72297,31851,118777,71039,151051,240855,16333,50766,14727,7939,4149,80908,418780,88378,59276,1327,7284,38576,79814,65820,42199,84860,49574,62596,12396,70598,40117,8648,7994,16836,7630,14047,359699,106878,525,29037,28064,13380,11675,50669,74216,103539,180314,27449,56299,172344,19274,7301,246099,32043,19422,36506,129317,6806,30140,4614,46639,66926,932,86600,6322,27847,233103,10541,39025,34887,3517,12972,26220,2031,66561,115015,48658,47596,12714,33845,3893,16165,35237,89983,14769,11962,147224,47018,29977,27979,5552,82338,86023,131368,1218,24853,237840,132193,15455,40873,3668,65351,53388,15229,59889,272245,47934,11858,34347,18038,90853,86981,300602,19343,114181,29362,84921,6095,106059,79472,38015,1206,48741,6208,8e4,21916,17423,6002,108083,24479,34931,56661,9511,26995,100694,163853,35997,81254,58321,18919,171890,86877,91341,74503,70477,53412,7027,59281,39892,131302,5864,15947,61301,67466,162369,47956,27874,35624,282324,21270,111847,102548,41482,30955,116737,28264,8592,55458,22301,75090,29821,30697,51709,3041,19208,8038,24634,30467,87509,126428,19389,18814,152686,20701,83474,45832,80891,105808,11378,153223,120770,98186,150633,49838,9141,12755,30962,5260,74490,21256,31678,65062,33326,289838,187831,20595,89768,2805,58535,10844,70085,12090,2451,138068,98544,24461,4511,6754,41684,28203,3383,65355,82833,30161,83924,234361,128424,28921,222594,33975,125491,34069,11508,67464,144226,41850,98703,34371,7901,21254,38398,65651,23549,53883,213340,123269,12028,71764,177701,28758,2623,68395,11549,15232,68603,9660,63116,36079,57093,31198,20475,48467,89984,35619,186847,107469,31389,43631,73867,41949,68841,114250,1605,30564,63403,17588,27680,99533,12641,70325,50428,73426,78379,11855,91651,72081,91720,60198,15743,12065,83398,140046,6761,46598,45900,5068,886,62448,148968,37347,19405,9680,15819,43496,63370,75667,163700,37639,3633,22774,34341,183131,134335,37200,23915,7054,14194,12970,26438,13350,285521,25594,8219,104410,91039,168804,138480,149734,15907,33818,61132,60082,4622,110187,56736,13551,73571,3945,73463,65498,17758,263266,17593,2710,27585,54469,38200,45367,63754,28881,3473,12791,98287,31895,65787,4463,94536,24951,36332,59901,28803,52130,86403,7668,181822,74831,18977,9850,177206,145485,109798,7292,31421,26280,77211,58511,12507,127004,11113,147,8729,56208,43066,79926,129937,31345,83947,39915,46146,98763,42566,1337,13192,18323,105163,80570,117753,16555,72883,11077,159438,40764,70933,83329,26066,12276,72059,21655,173836,126713,69454,153482,91585,70644,102558,110483,6764,127864,190133,3961,101798,20945,71138,82402,90884,69669,44753,923,16939,59700,164258,25969,27082,31399,43846,6306,246093,51342,6153,151581,202801,182731,56475,162188,89426,141356,14355,121815,27536,28023,65257,77523,106668,127314,24947,12790,38796,169698,23555,10725,44573,183083,42088,62716,43265,105958,32050,44067,50118,1668,3874,6243,318411,16599,1691,94999,52378,28671,216728,123258,2059,34969,69225,5913,136280,171443,141515,91662,22175,135282,80020,92270,1663,4808,4482,3495,34691,5226,109830,108512,17342,107488,11606,123190,100247,29666,146527,113014,15794,30894,13224,39585,243192,22351,9903,7836,47699,11078,25468,122291,48821,26780,122679,75521,81450,630,4895,92900,55074,74293,17441,3563,111657,103102,51613,12318,52370,36191,68245,34269,40445,41354,122901,168604,182500,62012,42557,11259,24428,115113,86345,12362,3909,78430,86852,134602,20459,47853,93879,22577,7659,3688,38555,13349,17381,56715,91639,12493,10895,92438,3142,37057,28928,2004,36427,32268,34222,209974,10432,67436,41989,173518,107930,27079,62729,30908,55558,5828,45031,14902,53546,8204,144263,60255,14520,88212,86582,109589,69356,8064,47449,8505,66558,16886,4844,52817,111260,215129,12941,91118,650,20770,6273,73089,40618,62790,2873,35002,14023,97208,19386,102646,36993,143736,135457,35385,113601,17893,32627,84439,100619,56016,6581,57264,172160,45452,111710,203627,70131,24100,322787,1996,35665,70078,22358,90922,83658,4097,63200,58499,14542,99153,52159,6615,12414,63415,31986,16823,1579,65405,137809,8841,16898,48082,259,33014,42375,12260,179850,73667,91389,98882,29532,17311,326251,41092,5928,20742,44964,48019,43505,9317,49265,6643,192712,48424,163487,19861,20113,70848,31928,105333,23685,78563,14638,54755,7158,24142,44018,20774,125255,20331,24280,10163,1285,2336,39851,4299,117269,46714,63816,87779,159624,11731,9971,990,137317,108831,50994,74554,162680,23640,131597,146962,170620,34829,91205,21184,1913,63616,18427,93136,156592,17519,67565,115882,138220,78622,88535,18115,2711,33554,109492,54298,971,24914,25863,36363,45715,27099,194995,14299,178181,111488,72395,322385,157719,130787,11897,81843,83999,11369,49280,118604,40922,61332,110343,53407,75639,40582,300440,54722,25637,13694,48248,48278,194521,56203,52779,48783,72627,10953,376,16733,280238,26351,230789,15132,25168,137270,3588,63704,73376,94031,74284,19443,159557,9697,39901,13351,119050,15406,146455,3460,29556,75195,37673,102524,92329,47289,98413,15311,100684,56345,7116,95480,11590,7200,167,23610,58426,17730,136656,27944,53151,2701,8824,103124,3017,90744,113588,53216,79736,65940,26931,498,29568,80540,143543,21292,1740,59268,16561,180816,42323,50174,40890,52866,10703,57169,4700,17191,4424,93511,49698,166650,26972,48631,165169,82879,69326,202970,4007,2376,231325,139592,22119,62851,37504,68816,58345,67398,186643,43331,277416,53749,15746,23102,17432,4793,151138,48822,54265,48203,198688,14305,54287,2291,18018,113378,123260,7180,97549,87027,120085,2920,76080,8190,102005,5641,64580,14955,59802,54028,58884,19367,81779,412567,85957,97053,103637,78871,29364,27637,141728,4767,30686,112738,130146,42745,12730,105040,14844,232,210944,36581,152317,135543,29744,3129,55647,58149,46319,27265,17499,28005,59948,7170,34138,5702,293047,110892,408,91760,218674,18469,46095,81403,14389,4610,35672,73060,11006,74848,104820,118143,190357,20043,105358,141735,5115,27093,45924,123073,52599,29433,9616,238350,78610,24851,58858,26769,31969,24613,18294,4982,32735,39639,143563,112073,202205,12567,4873,88601,44897,81503,101648,81362,34662,85277,17574,48173,21435,221188,40215,39576,80786,26544,64668,81841,10731,37733,247986,149188,127703,495,18382,54388,72446,43071,30974,198723,89608,41360,190,33045,8386,31658,19992,237838,119015,137622,50890,100913,6460,116233,267230,26621,104129,65114,14190,41542,14888,85962,23342,23041,26453,43725,71809,45186,4770,46452,53894,56616,221286,18973,9038,109299,55365,19366,26863,18808,60909,69353,41738,83463,12100,68561,72860,3980,13796,49340,12332,31311,27418,4255,53430,18976,45523,510,14224,30477,26581,4530,3651,101663,139840,22709,150861,31996,63923,120623,262522,3076,10528,2929,14672,130238,18087,9816,121894,100308,25085,55111,14565,18952,53293,2042,369988,23674,61789,133529,28783,108293,35477,47119,36448,71049,40015,33055,78598,198442,1833,159937,40654,77444,189245,113153,8621,18599,38553,35223,166072,2375,11659,21786,89523,6032,12116,63046,159398,18454,3678,32521,47626,11411,103527,38896,42946,15696,26370,10185,8413,37080,165583,4331,63555,14907,72220,50056,6623,62236,36565,49783,10049,17503,100581,55951,146244,24724,9626,17969,25524,109300,173965,99994,101056,46459,43647,53737,277968,8347,123521,74858,33829,44762,77574,877,81377,222525,123532,30602,43881,53145,2973,16284,81940,61281,127044,63620,9875,14756,114829,19032,9202,52759,119141,23928,120551,19607,3599,33401,76821,73233,117430,39968,36539,7071,5446,121735,194059,15206,45283,6706,15603,65615,1207,165723,92275,34773,104447,8396,32353,205240,164323,13600,60555,79205,25532,22907,33410,57480,107111,69630,32137,47832,70913,33161,20321,2371,117348,10714,86246,1625,11763,17900,268,78457,99175,97940,101092,86660,32221,14041,128504,125080,53744,124263,31017,13897,403,31859,21964,5633,111630,5547,77329,17961,18241,84995,25984,12983,67491,62168,47262,5241,297,51191,7351,8967,147212,82060,16821,782,11033,82431,62957,5026,43459,77963,203477,53528,6247,191852,87774,74164,215654,13467,1522,219964,28589,244104,16242,117821,67725,72570,156792,17186,15979,26990,44128,193014,35276,57125,16212,166451,68017,6905,77608,16364,53777,75921,76426,37975,26203,269296,64099,84122,12077,38533,830,4407,20139,963,43028,38902,42911,37503,83343,85045,16979,1165,60835,137387,58380,86990,110066,134540,56331,193845,81238,17922,163093,38744,110641,12502,56404,34862,26865,125964,12965,111648,25547,7771,27196,136980,9555,29551,107158,57885,18831,37705,35505,101742,13970,102109,62548,124657,23328,11124,89592,146376,248050,6241,22033,18337,80685,29898,11908,216623,67721,106162,146610,21377,15085,91552,42041,62560,122532,125336,102365,121537,142559,29693,223919,11515,110495,18776,22494,5895,185059,103592,229351,51220,100102,37027,257855,29359,54123,36066,106493,12244,79258,32002,432,56205,94836,90182,6726,14762,29391,48938,26864,38083,60364,3310,60192,14766,205567,57504,110760,22649,24666,46333,21517,3430,13135,28873,27052,158809,11597,20529,6695,23138,22960,37137,45574,6545,305877,43423,26153,24769,59844,14501,10430,134352,56169,13213,103432,49523,35181,13435,12408,129475,64620,230854,77390,51990,15653,83248,33466,44571,117828,51481,2187,10559,68019,18021,54895,48247,18354,33737,4554,108595,37288,39767,116707,9175,3726,108877,21616,83684,49862,1938,8543,276466,20134,108498,48770,102254,31914,131520,185291,100559,51890,209,19526,76471,50544,71814,99351,8172,198526,28816,20419,9109,98389,136777,76479,75596,30635,165417,48216,120220,25955,211071,39314,24308,32164,2559,146280,43403,9233,17947,90585,1786,86920,125662,2457,64741,32152,32918,122882,78538,44001,31723,56426,23375,103172,88177,145697,52506,49319,68016,31664,41488,18486,110400,7030,28241,986,109199,19900,42147,56864,65287,49183,7858,24e3,30453,840,16673,25907,68916,89927,6309,158335,36407,199737,130464,13137,59603,201778,195292,21015,42466,179062,172561,89492,11075,180407,31868,72493,20998,60217,9865,19530,39274,130266,54539,21623,12535,13505,40641,73375,4087,85633,2153,3117,70680,55788,92096,47509,98493,37490,271936,151475,3032,16171,96642,34106,78425,125761,19591,3366,19316,54508,24183,50786,194248,91528,33253,34622,108355,41741,705,3814,3883,108929,13203,67831,10142,59754,68208,29128,84820,56880,38794,24972,48571,40821,40476,18137,164254,24064,236309,79181,11282,395,39169,2013,51587,28551,9645,701,109513,115899,113566,12762,62045,58322,103726,41343,40866,244102,143816,2490,70346,40973,52618,15412,30720,104315,38917,42027,93676,17513,107418,20706,123890,13399,97727,24044,87962,65606,44250,98044,65276,74790,101473,19350,91570,1326,87790,172042,7577,100813,86896,85891,41512,108130,27794,14875,71431,12835,156250,58135,3759,22476,42176,115873,34686,56523,73643,108505,51491,20838,12721,32863,45700,29496,13700,34294,55360,29206,155942,123812,7706,163234,203,132720,49358,144431,8130,175788,35818,3270,76832,25710,54095,97274,28779,94621,74396,19092,128242,58067,20885,14670,93255,15107,63291,23654,126900,129421,59294,262659,9798,3251,67344,28600,44629,50672,29072,26999,31526,23183,49175,165843,175455,17282,175411,32022,45989,30298,90690,78118,83156,23749,35636,31317,7069,80381,94561,133756,14960,97404,6138,41065,78041,32843,16601,34123,9559,146529,123377,96395,54441,42012,84257,123541,10745,22139,106459,11720,150883,172651,154996,110538,4728,53447,25704,2009,71152,119354,21166,66604,1429,216162,8637,122250,63520,27180,29172,36124,276428,107787,77184,4680,14952,104903,24418,14793,51561,52931,8371,26342,48526,7118,92066,67280,40653,8847,34597,105438,14198,50163,61188,146286,50315,41205,170829,161496,585,197359,95056,1687,365794,91349,48507,5804,49263,5146,104902,96365,117343,132222,46084,96919,16875,8073,262381,79982,52663,13928,16056,153908,15145,109256,132308,18763,24904,167644,13618,40750,18686,147124,114709,150038,52849,2938,12568,48617,8778,5459,44202,44591,74914,17183,248689,13878,7822,80060,23116,194037,18487,2067,7798,43077,33678,244028,31320,74273,2794,19466,8218,36280,183997,48124,19416,29656,19280,98734,7715,18311,30701,133602,150307,126956,7378,2933,79903,13178,12593,86571,26604,92446,13574,44205,65699,427599,21118,8245,14407,27877,47936,33542,7916,26460,117762,21596,37818,2249,127359,209394,60044,47677,308089,36791,154971,31417,6998,150042,174360,12255,43009,29335,48739,3912,101398,53340,2580,146939,151295,45360,125275,15273,45383,27456,48761,23314,8750,60801,85823,104759,27894,123685,66968,39480,26917,55290,83305,2696,98390,57569,145853,340733,4919,20024,52268,30884,7413,203685,70989,112855,4129,50536,349518,68205,332641,159581,135361,236026,37563,176404,64899,6578,122033,63871,1850,85234,82089,66124,74145,121098,107351,12687,36881,117334,13136,14698,85933,93866,18047,32620,310,15094,46e3,88451,23632,36645,27940,87618,80520,58892,20976,27702,140090,96075,67841,103292,238964,87778,107338,17019,83427,67522,7302,8261,47570,116787,8730,80484,61772,174422,56005,131193,52875,14588,28471,59817,9586,15720,158155,51307,109734,15196,11025,59331,3884,52626,102602,84797,25158,27314,4437,20488,76214,189248,35023,114952,157376,2827,62439,102878,129749,36405,10329,109339,108633,36662,1254,13267,5470,87105,58004,15397,10434,159667,21864,52022,179464,3013,32147,31496,116832,18494,105502,129227,107267,50033,13481,9954,24267,22141,16257,116154,36185,950,115685,11305,176708,2048,178671,112573,287867,162328,497663,95170,50979,193861,50987,30368,136257,31830,46549,15119,169876,23788,17462,249887,57377,1949,35448,14791,43769,210091,3783,34612,282103,88380,245190,5457,20491,98908,11402,86899,117916,16028,162584,60644,320177,156096,31065,55876,22e3,77655,9992,23397,13757,317623,63978,215255,2443,17648,93231,27388,104529,93807,55505,140477,12046,112040,70887,40152,94365,112353,25063,114679,266061,71248,119555,15589,2244,617,14129,211431,70110,100652,7777,4383,85911,89221,21010,120615,58357,86405,37554,41647,18,15143,69662,60491,14714,186134,148344,42347,5410,168175,44535,42449,343894,129417,99682,20659,27272,140483,63455,222159,17536,13722,42637,62324,11976,114691,148109,2283,32057,182393,4295,147364,33705,2075,44303,30274,28331,63740,69740,29148,10346,44862,33716,73937,153333,12930,38784,247159,2515,41053,20256,83368,256189,54639,115240,5096,24661,175419,153552,26516,141,138176,63885,34115,47222,55709,2765,28479,38875,236608,12229,22921,77291,54426,45388,2860,57787,114579,295139,105782,17826,71066,19119,54364,69385,16568,12323,28057,33346,34919,124763,155533,101386,31644,8627,49001,303600,29868,63213,9103,77280,71333,9696,138789,37059,24823,5057,21352,32368,114208,56803,19424,10445,58514,8661,209508,26187,171838,10460,63454,14016,122504,41328,21329,46618,32493,38225,7855,31763,7945,29876,8734,6438,24205,97490,139977,130740,47323,33195,85390,57194,13813,60600,21313,96251,7699,27584,170521,139271,1363,4402,336738,129223,84983,69150,13147,3590,163929,207225,155260,55916,20288,4503,8398,98490,11773,27512,37113,84976,86558,28365,11756,116005,182148,13733,115313,47644,67208,85069,9347,14995,226141,14704,101835,41159,35314,13113,63526,214039,29978,50446,83339,17440,129441,72522,118641,97816,24907,73844,15717,118884,167255,96509,162793,30847,36849,51297,78974,77793,10427,1873,2972,9999,35074,28190,64297,146836,46298,60038,163007,108919,61219,2403,75022,127339,4233,110389,69022,9833,128097,88016,79390,222936,22570,94657,28462,56956,38803,81536,30474,152794,19566,16481,147408,74574,81895,20731,1918,1366,76367,187321,54494,24366,21690,61696,33283,107477,77499,31112,414383,74362,18463,218441,120929,59848,258629,201924,69269,454,19989,13054,59894,3623,58908,20681,35723,78523,102680,38988,184112,108087,50944,132704,52966,21699,18860,96349,201411,82697,85395,95658,5093,6427,177894,44191,32755,26961,155739,6249,31310,81030,26574,84311,120155,86730,113535,7424,48888,13516,45747,98098,20077,183995,81945,43210,26704,40420,75831,45648,11180,6855,57927,65528,124096,34851,2598,156633,107572,127352,38169,123845,60142,62722,105584,232364,23211,68120,1601,22169,89299,747,258039,80572,7258,152249,11862,101204,8834,121434,33761,19175,133142,46343,40178,48723,3589,41977,30210,38868,62257,10087,82658,87827,90646,16415,47552,351723,28298,72225,91146,272760,1701,11295,1652,109651,300747,51863,198800,29446,11794,32345,37538,22356,33102,37590,113544,37970,11478,179743,25454,103417,59905,221970,105196,145604,7817,164809,102360,16974,75840,255333,56902,6659,1954,645,59400,67769,7689,18675,5215,13793,20536,27852,3387,29523,259718,16860,94625,43143,29245,15848,233581,22685,63631,78557,22836,133302,84513,1348,51826,47129,98836,58284,1830,1749,94642,10933,6145,12506,10975,13879,103781,144434,10268,28409,32346,52968,121567,107374,77268,23686,35097,10501,155275,15303,47136,21102,168741,55332,90385,15996,84817,681,137803,25054,142275,6163,38175,8056,124296,240642,65621,4934,178205,16101,62803,60964,18230,100622,76465,44689,14545,9543,47514,16852,93380,28048,12047,107106,37575,101485,77047,57326,34819,96137,76916,6469,46264,115983,75768,87668,69942,13027,165,8373,114231,26434,52844,42799,182044,23580,146254,38081,43236,33883,146220,382894,14606,46035,36481,166621,35417,95382,2957,59384,60428,36358,66343,75378,22267,22950,83528,17577,56474,25285,4619,179691,75355,95836,53295,34588,171410,4487,14679,84208,44015,18562,109133,54101,11531,86052,174479,303157,28095,9953,35642,14564,39802,16145,77606,117406,53038,121117,53624,22062,1212,7632,127157,237292,189087,10478,127345,102515,181997,86752,87623,10966,121602,68783,68681,83042,114380,138349,191305,67176,50085,39016,1427,42384,1412,67118,122616,72389,25260,2237,13576,137346,19938,20304,2191,68759,5373,61364,238507,75814,23931,69565,38993,131741,38364,12528,87762,5679,129853,5310,186831,32653,90338,260176,389531,108118,26843,43985,50175,30563,25106,56965,18130,140428,4542,165503,117991,24219,229605,1819,129663,1240,3797,76093,18398,71339,51919,93043,27175,47060,216257,6483,35051,1217,16512,80798,129064,13225,69339,8548,237079,72298,2575,34280,51379,117910,55671,53345,247552,29486,39328,140821,34681,57045,60177,5004,90269,78522,2479,322607,48474,61296,13057,31558,4678,59271,6699,27044,31988,35944,12503,83480,4389,136508,3781,114121,70279,4488,155829,42214,2898,68191,75695,305850,45041,74344,106509,30087,17429,93292,12477,290,23080,114802,35714,18751,26554,105424,17775,2144,2412,100610,65192,113975,52975,180272,135050,129815,76238,106483,21440,63186,4260,46189,9711,28249,4169,23429,23390,8324,141585,63809,67668,38457,38063,39226,59972,1189,203916,62368,14403,16949,61767,85801,1739,40147,35049,76757,33124,62102,15780,103593,103009,53484,22952,67973,114645,6566,5245,50462,7601,8288,3513,194571,80276,1908,54592,5124,58571,2513,6800,273997,193904,1119,17991,117245,2508,129156,82366,26278,71465,63341,56943,39662,106116,94966,156875,9736,2204,122308,94418,27134,1280,24539,49022,45314,3764,50904,46424,30699,28087,293839,9400,33646,40165,822,147499,50263,116179,29085,11863,31314,5578,17797,5104,12454,1604,15342,219206,10232,67800,94261,25872,13565,90339,78971,75377,26649,41184,47695,11514,35369,20767,14227,41953,309396,148270,147938,33074,14453,27499,109019,39018,25738,240196,158931,52820,8612,95853,21524,137010,84901,70869,70021,116794,48404,38771,6732,1070,70990,187297,49140,5238,576,3564,253975,16027,16483,2811,37775,19034,25259,4053,2e3,70083,95774,19713,33431,92703,91314,42381,288770,48194,95985,3991,77418,13406,241328,245086,56533,35275,62725,9246,51924,70181,95331,16163,31410,79016,39312,120878,119371,275987,80124,27712,9186,220,23598,146167,85209,68238,282190,57048,31273,30555,80913,17594,75779,59160,135002,101219,189377,29225,96735,60126,62522,104e3,27620,86814,17240,147533,11001,5425,43682,410,49460,87270,69480,46315,59448,1816,76201,9431,11788,87960,29063,65539,47347,11678,33846,7008,196704,9895,6753,8633,120892,59970,572824,115934,6646,202559,892,48351,37611,251282,57823,67263,57750,26527,34485,90747,7685,88370,6144,64182,1709,41969,21458,62327,181657,49247,225330,122600,114574,107124,85361,111833,63243,71420,15655,191178,72430,18063,51425,54002,12364,53225,86557,18193,97580,41232,138398,67821,128724,8944,233212,101353,52099,42127,14006,120107,32789,32132,3498,18123,33758,56058,5779,128760,59888,98869,18445,84702,51911,13234,218379,20093,39031,8074,70195,20708,23462,24355,131384,60189,26390,10403,41060,7140,10781,49410,42261,87202,82566,41663,43105,60276,2768,5733,74176,28329,2297,145430,131632,83615,122915,105441,655,224102,5284,136426,67763,16294,188511,32538,61049,27893,3394,13951,159099,28542,17930,145360,9492,190122,32285,78855,26440,13570,58648,73908,4239,124561,2444,74172,53131,11468,10794,73566,11623,35343,64710,30481,4163,10328,38309,29901,10538,154377,76132,92405,24839,11679,3465,13449,11637,7824,2337,57754,1260,14458,41118,19878,38661,13416,159180,37074,163164,54137,28627,52134,184900,8520,40385,29546,30502,22386,66527,107458,6850,24022,47983,30603,35083,8934,304066,39500,9,28261,33026,77251,9374,44833,116312,34990,29236,63563,125639,135405,165398,159055,55690,88141,69643,236964,31983,25572,20436,36746,60896,31850,16179,11828,5888,3043,66368,9750,31167,7915,53111,36430,1333,64344,93659,20061,60596,180191,51630,6792,30244,43509,101058,22409,420,44210,109783,43223,27030,72477,72831,32679,29235,7675,47556,12258,39907,149412,84926,118247,24692,71717,105038,86009,45941,41189,89453,29856,52543,30627,226798,67303,59230,67415,34408,1367,99685,16867,128419,52147,4111,125381,117881,16173,44093,102224,31575,23234,24870,83790,127407,239098,3200,994,1255,100903,242275,117266,55116,38205,16140,29662,11307,40414,208793,123355,56470,4862,75600,30119,58218,70828,24075,26974,7802,192353,4851,5475,78720,66596,3409,28573,64396,30381,30690,59859,88256,5406,99945,103064,34463,37727,24238,86643,60088,4057,23741,5967,162904,38240,28356,93858,25510,122879,6897,3278,7057,11971,4400,35461,211413,21395,59615,39471,87233,55795,128426,3051,22470,41950,14705,3974,180108,80476,78442,204996,91987,15634,67610,139015,142373,35611,51134,10387,4353,153456,57749,181039,14183,68447,151532,21107,36452,20551,3186,46247,46383,129666,88736,140662,146243,2066,8360,7978,64818,106963,17896,47801,10723,114821,223295,74192,3293,3393,16987,74064,11277,91622,4270,29828,27951,387869,103235,1374,61988,120083,477,145892,128378,11779,211263,61354,18221,17869,46530,83061,108538,157981,90608,67199,95080,49064,195814,12302,66307,10348,231346,160732,112859,63633,146558,21271,31037,198802,47622,12862,95710,3910,77850,73961,85585,34752,61e3,4082,24595,103679,71107,8208,79568,150019,16615,24961,139857,32664,197366,4559,54735,32696,4126,162019,75698,13916,70108,159638,19834,9349,24675,175560,49643,18206,52459,27992,10809,88865,401975,133172,29e3,34558,30915,3658,25834,42430,36562,125265,18182,10155,40149,97082,208980,19575,60853,90529,66545,9600,789,46420,2317,88593,55595,98980,115302,5742,169155,1073,177901,3472,11189,63711,78643,65472,50459,127979,93,42202,67053,21720,157650,11145,141378,42033,22824,85705,79114,35584,15974,1510,54172,28562,12451,104226,19190,97151,73024,20948,5151,81741,21499,29006,84183,198074,54003,45120,170125,26240,35177,28389,64863,79974,60778,176915,232183,45342,2038,80253,41564,40703,32689,5430,100689,5366,23007,134279,14266,26712,73993,24934,64242,52113,102887,61801,46415,201049,54251,62133,122757,164883,30815,139966,2319,30842,766,13362,10287,134518,86111,81665,82440,28333,43019,18963,8804,161944,23439,102144,101145,80029,39052,248708,30350,117340,11878,128467,974,138625,63961,5237,74778,61834,67040,43814,13690,65947,33809,232476,115258,181745,28824,94013,9510,10246,93722,81976,7217,114383,3493,16014,69045,72692,12145,80981,9507,6692,1620,60820,330444,35474,33962,4797,7053,295463,46445,27026,12491,77988,49524,35675,90947,29114,166705,101385,133782,32704,6186,84595,176031,185623,45966,151302,63069,1699,107491,947,15458,74452,196212,6046,10498,12163,10239,35191,243951,9277,9090,29539,54460,22820,26514,112549,60372,51753,48756,21812,70861,260326,41,44222,10441,16961,48148,138771,216194,5914,52153,53400,212036,56519,26245,10117,45888,15294,138019,90913,26368,43842,42111,23348,6082,194845,161089,156206,51546,11647,30759,302912,262094,8635,78876,26535,35283,54183,31183,85484,147873,12989,5197,6356,72894,65347,20150,27370,73787,1493,45918,12366,190217,20724,13858,10981,67449,81213,7553,14115,72242,271517,11842,48310,88743,143726,22177,3290,243231,58452,62937,12592,1654,40066,33477,13751,9921,128442,15868,7106,75236,83773,10775,36938,10482,170465,17368,17469,161508,32752,98340,800,19824,264456,3901,87319,2867,26782,9630,113102,185815,24197,44584,86366,40224,3636,140916,31731,267731,9567,53678,72984,29389,27963,17106,50282,284911,60170,8322,12608,23374,89652,5268,39044,229766,8869,151350,31436,177342,12269,183212,120418,116270,2843,78888,69192,7865,184099,1086,129897,18383,70508,20242,18508,229924,124569,35749,50589,55626,9884,83115,40971,30671,18135,14452,38861,17844,201826,5549,26413,17189,13561,38539,10679,143331,3314,36785,171194,49685,187713,67506,4618,104039,17060,195080,50648,33159,19238,67559,134840,28599,157523,17130,38064,117398,94355,31918,13575,34538,40326,13997,3494,348283,62481,26862,3603,104426,244363,153709,112487,304612,199674,41239,35545,54869,293005,28223,26277,26899,4533,18518,15492,38587,80488,70485,160395,263,60162,11382,222152,4696,250751,51921,182609,10707,48463,46243,1227,49111,111564,46502,33342,56846,68541,63559,858,139927,16654,229375,76759,26478,33205,95828,23399,92945,2637,35630,28470,143992,50214,14174,21456,166191,65665,1711,21594,78019,97599,111701,36,147151,110246,189022,43021,30397,40757,131935,42065,73335,48039,26596,28984,15102,2361,7421,202167,69744,43766,52826,3642,83304,33873,75140,63169,192389,36551,92748,13039,123959,233220,21738,84447,77230,20228,187852,19095,25799,92136,108774,29237,53947,2299,118106,2687,8830,42331,202924,33667,2023,73763,30704,19363,19779,16737,35629,48081,24068,101013,162338,291912,13749,24745,328289,167679,70086,48299,23306,16732,17801,43322,54589,3586,63653,43624,53474,925,109177,251316,43805,13082,19511,86565,142182,92461,17117,101033,103319,64589,4022,4351,235897,5352,82705,107142,46391,156084,5860,61365,10558,13045,7717,18357,33922,12590,33065,6928,46993,783,46937,67846,8952,26295,6107,119656,18799,17458,50747,4229,179559,112727,118080,20683,41464,125468,51560,49749,44231,7359,35339,62988,136487,67015,5208,29150,24956,105186,48858,6143,18097,6972,16404,73489,58742,97196,36357,164616,5834,32267,13746,147733,15113,132091,34127,106298,39729,106426,22294,9780,15602,36213,71502,42808,66802,599,60755,5851,39120,67363,108623,126368,72770,91263,32486,30596,151717,7951,52002,43103,11768,68942,40901,39344,24037,127500,116890,48403,16926,86750,17745,48648,159545,34460,58419,5634,114317,67865,31462,23352,24010,98185,125708,69686,68337,13610,26271,70691,2980,4768,27225,102402,75453,28106,8104,6931,1176,6274,6475,112635,22498,6176,238686,26832,28893,90319,14441,15682,15087,39517,45270,109134,104440,45965,47645,81772,7876,52683,87720,12898,4505,185665,2769,113401,15664,57592,105229,137381,97059,119268,6876,43309,33886,128363,35476,144249,67013,143587,83367,25703,91436,59347,53236,2289,16519,19844,46309,58558,99834,23313,218816,231303,36388,51333,183535,109792,139277,54306,90139,18235,8275,32710,37677,82464,86025,92204,88842,117723,37570,128723,234242,76350,73795,34896,148247,58424,11105,11744,45746,63372,17118,49772,199520,81902,38004,22911,33752,3125,1995,53792,4689,26909,108150,146062,69674,41811,161444,84855,8999,28561,16731,93937,3189,21967,24890,22943,1356,145300,51569,28802,517,118679,31703,40607,48098,108854,25003,10233,73969,177495,5248,24516,215347,146192,48712,60626,69188,40735,5866,586,101541,6509,47590,52129,5969,222045,110933,25733,24223,65339,62812,2414,155418,35819,16022,78423,43138,20995,128255,240673,46745,236093,72176,57085,97841,61248,107,36068,193177,105427,55726,215229,20446,47228,100420,87091,14429,121708,23605,21157,187721,21880,2997,203976,99166,95068,25877,7724,98925,83401,4829,13182,18229,13718,239662,38653,116505,153497,30589,89029,38962,181302,43853,78872,180301,4786,248240,7401,106136,112590,77745,19731,60880,77789,125748,135487,5975,48627,34084,12419,215770,47557,254582,10364,106495,21856,67539,88981,38805,21428,48732,42316,12149,16078,52808,25327,51322,33850,51147,12253,122354,46077,56483,254553,115417,81834,150991,94662,86668,7381,12841,100650,18218,15741,22372,68294,50705,15535,84660,61887,22553,72299,31361,24824,17743,46820,64288,31582,77006,111674,116384,30760,80920,86149,77192,51979,79691,60342,122805,103800,240873,160744,233114,78962,54920,8608,3484,316104,72548,24337,5088,230040,21926,10172,36838,26,86221,83458,102176,12062,17571,41929,41170,28428,68239,41750,103930,2634,18313,53019,34825,97837,63115,24606,73157,152474,14715,91439,37033,109806,140259,30668,174760,380,135597,95673,136073,65073,134249,13829,17279,122305,4420,46444,10237,64848,203623,70728,10349,182885,65075,24519,25783,40318,34139,22222,63394,55266,102764,41422,20126,65100,90408,53640,35128,48932,11192,38935,96839,34782,39492,19396,41332,6250,5511,19492,51304,25936,104466,54099,73771,86115,5080,7669,30891,111700,13931,25276,72289,135447,14820,258641,25265,31005,281179,75286,393,95359,14623,13584,6680,101227,80173,44933,76666,54542,13244,39348,458,25379,109451,134348,81143,6959,65554,12027,51311,8716,57589,140731,28467,23316,17272,30458,25980,55229,77197,83798,28302,114784,7428,34548,26241,14712,39336,103304,18928,54080,12870,334,87722,15208,16895,142098,114262,39820,83913,57817,28682,7721,14900,108672,11250,62246,42849,415188,1724,26555,24549,25505,26443,107450,145899,61035,43528,6901,60726,65906,267741,21338,147590,42079,18924,73017,135236,15393,5206,4026,84185,1531,5988,113890,82647,303391,7386,69844,71611,189865,76523,31877,13315,19314,198575,32821,1928,67641,25913,104475,103489,3297,70391,18406,15446,113347,19295,93790,27856,1792,167471,116449,8541,4408,41757,63233,25765,86680,64501,27034,24816,34975,6079,4486,49693,36229,16917,21581,62426,27862,11612,54284,35702,194034,355,24277,48262,87411,70504,310164,118018,12516,47559,43502,57433,107139,9290,66533,80863,14634,34312,91725,28606,21342,67241,72355,43244,375789,37402,174015,105070,8342,44167,67494,1890,16365,11723,271002,1865,47918,8350,45564,27742,25110,125803,8553,49504,81925,62211,4534,15491,19011,80373,206920,667,102405,128623,245524,5553,113309,192739,65766,19567,22832,261958,29679,21293,71134,20962,105123,24721,860,21752,33448,18372,157167,94822,35770,173224,232737,75729,28937,46828,28062,25453,5207,140366,36665,30652,6169,67920,150458,92040,23186,184604,92330,20891,176492,49427,27828,38305,42495,143982,49560,25503,90043,29747,65328,47830,12932,11068,77721,9003,25213,94205,140426,46090,89945,138173,192691,33329,112232,129905,35709,27514,1841,19957,31411,127476,53572,17497,173549,55063,175135,19841,69314,5192,237921,117660,150697,4060,273045,50414,98940,65348,153665,164423,58804,156695,48994,213928,86036,28608,8355,39574,34540,16927,135680,18374,151587,10830,53805,16878,16623,4282,48030,8537,14986,46102,13062,72897,72,33050,108227,39451,45935,651,113320,40535,95176,57450,48843,5003,19019,10407,211163,3848,1068,4988,32091,30095,41692,15099,43602,107434,50744,7627,171349,16313,150832,352665,207750,33937,38256,51091,156e3,87889,90663,84175,24908,114900,50365,31494,83829,5398,169342,47521,54818,18935,8356,43094,41212,174536,10082,92550,6678,60614,23355,69721,14796,34149,128830,58187,3179,208,40325,28399,225029,401412,51150,31580,207268,6657,10993,69818,64282,289845,23308,12961,38447,6681,52944,31855,2572,47646,120728,179148,37240,45196,218274,4816,3695,21961,50084,35209,18073,51452,27004,6100,33941,1377,84831,171214,85,141510,9078,99227,32610,6417,11718,49868,65579,87902,73018,49062,46280,61742,21512,40862,107733,15941,29168,157765,144919,14487,5767,158014,140070,7241,573,71584,16921,223566,40331,179473,35081,47926,140885,41508,52104,59180,42310,32811,29048,123517,102413,80208,10104,14746,12649,153641,126022,37965,113017,4171,83,142592,2809,6362,50416,71323,116894,260776,16204,1524,5760,30351,12658,20703,54403,36083,45408,74772,4946,14485,50759,111222,10890,2195,167147,92962,130534,16283,177256,35016,15472,210156,151187,73922,117691,43250,52051,37392,24811,24358,30830,5775,818,21969,1476,127322,151783,58392,31021,106913,65215,89407,90802,28531,11690,20234,95249,44602,37256,18707,11928,5161,4410,26571,51903,49768,22008,25252,65780,209499,68769,203726,13249,137363,48845,86823,6658,5674,31881,1083,1823,108676,34518,166752,13791,14287,91576,91429,8665,11529,26401,16191,91972,30964,5254,28486,54697,79613,66520,18447,22870,45203,194466,22822,51703,12278,76716,44595,73455,33546,12235,144843,36154,51247,11116,33040,3180,225753,60864,1972,28469,12891,28879,10338,144157,56294,353058,38302,41447,87532,110616,27065,168438,6557,1213,50804,144643,24817,2390,136531,38174,247513,16190,4059,122791,131994,137430,39506,57650,16305,5188,54309,106128,20628,88071,67394,395446,250285,66176,91254,1399,114196,43915,60230,44853,27206,106353,43013,18733,345105,226453,51202,16607,57106,117175,35492,10476,89598,127439,15187,39624,13688,61570,10615,31111,59370,6238,175252,32143,224492,41388,95408,34384,148238,78307,38959,9340,160091,61443,15737,11216,41244,170,38299,102443,113097,26382,14027,33707,3957,76300,66160,19431,18900,6952,1717,108656,82206,188021,257335,27295,43999,41210,31777,46956,57457,12657,11489,15697,48060,204748,53583,82422,284790,30503,137341,8120,19615,220311,15991,10217,63424,9808,67431,70976,98221,4491,15177,28535,144789,751,13230,2394,1504,33977,132104,30316,22230,931,97193,185240,24826,22687,174322,15307,22988,1390,188745,180325,29580,59068,74903,18994,29195,79,15436,7622,38462,11566,138710,44828,45774,37768,99236,68137,84083,19282,22698,17134,74807,126662,173497,46248,16938,119735,3212,28292,213652,49013,9975,32180,45660,86250,4801,68788,95490,77482,113751,11994,44624,94452,46839,128497,100316,5798,58588,73184,202987,65417,37790,88524,1606,43156,97964,105717,34947,11203,100060,37742,130074,93653,107799,94311,196106,41347,8035,10780,16390,27883,118236,167395,1979,25006,19375,31628,18916,144723,78502,114047,103107,86492,107686,5844,20934,206963,23556,22591,16562,146333,20167,10471,117434,33085,2863,9740,36669,41849,37271,22790,18209,28979,8231,12952,54408,21731,25130,45208,55748,138120,75826,414,29593,9925,292865,25999,683,123149,7036,92159,86055,61827,103680,23176,54918,58466,57578,13305,5709,86479,16697,31064,17660,200919,10770,49793,33423,32370,52047,16488,62555,6459,8426,83493,7763,59725,82812,18628,67760,79405,68557,9612,7673,28102,56517,69620,171797,32458,29541,15870,81109,32080,207644,71495,21202,11039,91036,61230,2810,130800,32260,4613,60590,37112,75214,33979,126402,155062,30642,63875,12810,194463,82799,47664,16725,36685,43367,61099,449,172150,102867,21691,301838,36745,7130,18671,57316,34852,38034,54182,35578,65900,99486,19771,3456,2658,16914,99866,28390,28109,8262,21147,34353,20006,4228,137085,1675,203023,283196,198286,214375,163329,290603,152574,40471,83506,30068,14730,23177,131539,34759,27668,32178,71896,104799,116305,85430,119262,42860,25160,8911,23428,49437,105322,6519,16203,6349,74711,1230,38045,8540,75165,44736,25909,51026,317034,4984,32281,91312,27060,44431,17817,45363,155937,239085,35697,59784,91993,29531,126740,213757,76560,167776,285273,24262,8237,65030,41160,74437,48804,118916,13159,37842,1031,75349,1478,11655,108777,23435,277425,101734,67469,70231,124711,43532,28514,65526,54956,1e3,21882,17728,25302,40952,52214,149632,1999,2111,3259,63362,89961,220561,39777,26335,9063,10572,12416,34551,34623,38604,24723,5947,15588,69927,66252,119177,69173,46629,28714,70715,212408,20521,406913,74380,11716,50659,50862,37009,88460,130101,7210,53853,538,65120,151950,55806,163748,52837,13153,21100,16674,64536,6091,138201,44837,58547,3723,163,2177,32288,85454,34033,8497,14282,25742,10535,10741,79559,117493,243787,49337,100718,79495,40139,42956,7551,55433,15421,31509,23034,45081,547,61176,53434,328001,8470,36263,30145,4519,74173,53935,11845,73774,60211,78025,3,4102,73782,109293,315332,48412,26683,13714,6865,20128,18490,104141,325,39470,171970,115860,15707,7268,73301,74336,31370,2368,111827,107757,136231,142844,97138,96638,84053,38691,23801,1588,10573,122098,77039,240,186135,146101,11996,18143,112963,46171,155836,348769,47795,121213,116266,132515,3344,144804,31286,99187,255838,129694,35894,48779,55235,148582,71967,65282,15174,13920,47080,6147,108242,157593,125025,7136,1286,28957,127956,28402,98813,20805,7532,109417,40610,5041,32958,15142,18408,108596,33543,50517,27748,80114,233434,91447,487,37094,100048,30541,43477,10639,89862,155868,37667,8726,60684,237903,73408,99589,12190,38739,97348,3914,13594,2680,149016,13907,30171,28343,23530,115225,61104,35821,147679,14337,4297,244282,24085,326976,56428,7851,21303,131620,71446,83253,68692,111870,5224,15813,38197,49026,45057,13660,3306,76345,40671,27905,91072,996,68527,62085,91351,122634,55109,168209,2024,27560,112707,17352,8306,167115,169921,166958,5031,46020,11844,67284,19130,76185,6920,32849,5450,14610,22451,21002,17392,31872,66682,84796,13709,40210,59898,12029,8719,53564,21462,91884,21647,88379,194428,12754,37797,132826,160016,22567,54383,53186,77611,31107,8339,4694,19185,90355,23597,17222,140675,28442,23668,55977,9128,61555,28774,155229,17658,9390,24379,69357,15752,127381,239631,62460,93181,55913,45133,140155,18676,25249,33164,29581,82837,67223,22362,29975,7317,52813,1943,29613,20012,207130,49617,49651,5636,15334,36313,29226,28084,95247,72072,19e3,224932,15811,114,32127,38097,37508,88507,37225,27359,91626,12193,69279,20608,11055,88156,92808,2152,57259,55275,72789,24475,104414,1708,9882,3818,48661,66897,1631,34806,227930,85815,87753,18321,250664,72733,25107,206797,50891,8082,196411,92596,96764,152823,65514,22819,387277,62176,51225,40329,15563,189,3659,73670,64357,51793,275136,33482,86653,74615,67058,11318,125720,15388,22388,8267,1730,102663,170910,40784,7144,85373,13040,7088,94309,583,44224,140424,77439,18496,164026,36578,4722,9151,5824,63365,26510,35199,40500,79277,32495,44614,35233,9566,203293,152144,7097,2330,183480,98629,13423,330887,44130,68600,30939,97829,31012,345465,56747,94879,4939,160027,149761,99423,46099,32251,15332,8761,96094,128555,5763,235318,222223,55729,30241,55420,201746,3987,81382,8259,49325,23287,7719,24633,251100,92311,18591,110533,64759,170260,393860,7175,21144,132887,3593,75346,101277,91109,16387,259187,11627,57459,173829,44694,55780,49797,89192,120443,62622,3904,14814,23887,1027,112258,64955,99800,11132,66353,36202,48624,18158,88481,96882,43059,11040,2455,7077,21651,181159,99126,100434,61388,68186,19161,110468,120052,8819,55324,41494,7014,37689,3618,87729,92615,207943,9823,128657,12587,15857,6379,67628,51216,71775,157617,63244,1503,3864,218754,110864,5769,21492,7243,1192,87921,85529,31512,18537,42698,35350,73510,84474,34301,8991,21013,35034,566,38832,19838,35586,37216,39413,55006,12178,59742,856,84563,6900,25632,17437,49786,30723,13847,70845,4044,7843,23944,235976,55530,48942,6518,20939,73769,192653,52936,95207,23895,132542,142982,22632,87452,48042,54018,178468,10728,26230,23559,363,81269,142012,5718,346258,31456,84333,246476,51018,66692,101804,120570,39962,30373,70593,2864,60541,19425,54209,104092,7201,31545,48018,25865,15442,46257,40443,8328,6451,111782,47527,97754,33046,470,245116,31095,39,91934,87208,73470,36708,36521,12801,70624,36272,8892,79768,12427,55454,103756,5908,52390,62962,22720,141138,94634,41689,128402,126390,6628,106394,35527,134394,82727,254651,194502,148064,89549,3202,28359,957,21954,27906,49840,142747,8307,24206,48978,1186,71728,133038,71474,91306,6333,110959,74600,70387,18983,62609,56057,22970,1147,135850,1321,28834,3578,59715,102227,32827,81415,99952,55636,257598,390,22702,35701,85872,402916,39216,189795,14929,19467,10112,144422,61514,5279,63421,134686,41436,8424,51925,10598,132295,124416,4604,194739,210929,57866,31829,51626,50007,9976,91878,61906,56168,81906,60918,61859,40017,23059,16887,40927,62064,12785,32893,32913,21782,93965,20169,44387,79084,38463,11457,93950,27127,157050,2697,337088,5116,54128,48255,33279,8821,27352,25515,124022,65710,28906,38557,33390,1722,104435,72215,38551,12094,30978,25113,6671,37355,175109,42862,98024,65406,221276,59624,118012,64637,78760,86697,21426,1639,40350,12584,67193,84144,31396,7863,143011,69629,63112,9454,28666,65798,46372,134721,6314,51402,30837,151922,2847,38676,38008,92823,136245,17540,5504,109295,205242,37606,5211,214892,1586,20670,208711,137743,19328,40652,16995,20023,14657,154919,34422,12996,13918,38221,47690,16398,2959,37680,89122,6721,198469,91876,172043,83898,101992,26084,94570,3635,76958,22853,76497,38266,176590,168403,44464,142840,79180,184594,1984,41806,83147,11985,6546,366068,59732,24533,271505,8736,39084,222992,93429,28962,58985,86665,8432,30028,14548,32439,54424,165029,55175,27458,69046,121277,46168,33732,20661,24581,135574,123110,37556,79260,72611,16957,12939,46162,58238,44907,72936,253758,41324,32518,96480,11949,124438,65280,43256,34107,53533,43531,37037,28366,45970,32741,173438,6121,194202,62969,26355,30314,58370,28455,1848,50519,82830,90393,21761,295490,10936,256940,133568,44050,20269,4089,27457,21610,219460,36743,14821,101388,52005,13124,30979,140816,167362,26054,18458,60789,34917,40447,26606,33422,9066,3452,83614,5761,20263,137238,25038,91310,101,52322,74548,42572,38084,214054,186568,31802,17665,30620,141936,37730,14420,4265,187218,49640,188208,51441,55388,96452,66659,40869,42039,60967,221027,19234,178581,29105,96050,9165,196118,157335,3738,40354,117436,2965,34136,59659,15570,50843,230035,31444,71260,43886,18316,5387,38500,168508,17406,32174,8828,103373,143806,90367,3560,18719,122310,16508,26719,2541,105429,6645,37998,73190,10591,235916,49737,87112,233941,53188,32193,79154,4544,52905,126477,7580,63501,57314,3216,31337,6541,103083,60846,49,9756,15481,1355,43840,14319,13743,27486,10222,73114,230718,418644,16706,6674,279748,23058,45273,295831,86306,2743,5535,88773,21829,35253,120938,31153,3169,16839,42847,8751,80974,33942,36867,35514,16485,26474,77775,56877,5391,48346,3882,108713,31403,27804,55248,26235,43821,136104,40118,175507,28034,203908,18732,1788,34030,106427,36958,54359,7251,44936,15356,69139,455,157915,22173,140291,50348,43275,82066,49621,54952,15216,36226,96695,66855,6936,1987,8227,196087,4631,68827,99004,47541,110265,17953,147605,110242,58520,31312,38724,329975,642,3155,34497,75937,6207,73843,6120,17249,51429,117746,3218,910,68961,319671,14938,29555,34700,1649,66673,72268,9655,76800,153087,6941,210168,27130,35398,1780,73242,3135,56689,19556,165307,8765,35967,121458,13333,70453,17350,117253,22265,13340,44265,39869,441,3742,135025,23581,33309,16543,17731,13291,157637,283005,21408,101360,63887,52312,83873,5338,233779,23759,186949,34531,177320,38069,156465,91004,19353,59852,68160,14891,1338,1072,29823,1950,28901,81407,313445,73038,84807,162348,240257,37162,138934,16111,58013,41253,102951,16457,96056,19541,56402,67217,41638,94381,89674,29481,37456,80815,151579,13937,13683,132537,19699,134545,67020,29816,222341,141235,427578,48868,129557,233342,23077,87871,16213,18728,16184,9469,37913,19680,2798,171356,178328,13216,50049,72690,71904,124644,55455,7504,29052,41036,266546,19899,30391,188755,8659,59469,16,104298,112943,53865,76203,138226,68857,139953,14125,107625,119795,173133,4398,50273,48808,54390,16466,122086,31835,67035,50971,48859,7508,46427,66477,73021,84615,39985,83076,46779,201569,53336,36443,60865,168164,143810,51393,25548,169307,32896,24485,38424,21837,29087,275813,51674,6714,64883,46169,187369,55186,76192,12852,12018,62134,31067,118303,16542,12125,10579,4928,26291,43854,7091,10946,253716,109062,39283,17261,113012,258512,47764,125126,32646,55892,80279,201623,149872,3192,385,1208,48750,5376,58738,22335,5427,82416,47811,32435,143086,38930,94128,59975,156037,37977,38224,62485,7698,50405,71027,16462,21559,136153,34131,107506,162069,63703,3101,215029,40407,4178,3774,9187,80019,17880,97926,67579,2600,18405,8351,47924,86638,70820,92206,86453,29610,42241,119200,3198,15466,67813,57863,35454,4779,99518,4649,104641,144269,33730,38073,65864,6838,109456,193298,154007,5623,45741,30846,182578,25573,157224,1543,58575,138703,146140,44971,49356,18275,59064,20300,13122,11848,24453,11973,9797,86843,2919,25530,49210,1130,161220,76788,75373,85604,34926,36014,17777,17255,51533,11676,92226,51845,119859,21525,5936,18507,28050,1140,31418,14857,34207,47859,10750,36382,32079,106909,59426,87757,38393,110042,15965,97104,33757,35344,97993,53979,33651,45407,41884,82515,173089,7177,58371,35365,47543,51927,35587,10670,23544,29306,84233,39976,76076,62097,9007,8668,28119,78281,120790,19835,143020,54968,18670,64959,20649,34469,42570,33001,136570,87796,120044,1106,58700,63951,127623,12805,83057,40212,31773,49850,7361,54336,347524,101314,23751,19569,48791,29174,49369,20467,7465,75842,38281,623,112457,60210,28849,51003,94720,6426,90047,85560,43761,3579,85105,34607,90410,118528,7224,42907,111163,18168,6960,161135,191298,5247,100584,127552,171568,20121,91173,12636,54615,20199,63730,98105,2396,40387,14438,125012,4765,33235,12865,45299,37728,82098,77872,114037,59253,19675,24838,398016,102561,11446,17069,57508,178277,65836,99941,26114,2585,271882,136866,50126,11027,155648,118367,14585,8910,123015,335383,40434,41016,53021,14439,87098,176860,201543,121888,2358,9286,5739,22666,54270,37884,169381,33984,93859,16124,89364,72207,51639,76366,99029,65812,2198,12147,174891,194289,6986,30252,88822,21284,11445,288337,160821,33034,100869,43852,25761,52882,1144,103809,1924,84458,86079,43411,13542,139276,18141,34978,41298,7276,26481,173800,33210,17951,142652,33616,33677,2210,19941,98568,2486,192414,80136,12058,235883,50963,249638,29572,27221,47034,6124,72107,63346,97620,158513,299699,40388,23235,37176,224244,198386,121323,67992,23827,63170,17838,106622,158590,26807,5345,23489,91891,55474,74834,37981,13058,5977,72552,34706,26828,145172,19904,21367,34043,960,77092,91381,4733,47446,7680,41697,5170,16960,14741,46101,13656,473,51842,37433,11103,11551,121951,13191,97536,165932,50397,51628,129028,9069,44885,6590,59195,47045,32940,225472,90345,21833,13303,29407,96615,141951,5198,6028,18395,7181,3861,14966,156358,167182,36529,55253,25942,173153,30959,27261,50691,150176,162201,38467,48462,80602,42163,118482,168,108756,26011,17166,54149,456538,22512,91374,13816,90358,131615,18132,226707,1824,28139,26860,42253,93877,77351,65575,8980,80574,22020,27948,40422,91324,76376,13528,39281,91685,82215,122541,144066,1983,193851,17283,26320,2739,194978,4790,26845,42627,61300,65815,174612,55133,4200,191130,79771,158321,52280,166796,221620,62461,11278,4067,88152,83409,31717,121367,13522,47325,37945,10406,174348,249321,154101,64912,29938,51775,17220,15776,166138,78890,84425,54121,42861,16368,24572,291647,10197,32073,22651,11677,97509,26952,35787,18424,41910,71614,94977,72318,41594,70024,275419,37702,60199,7335,39107,61315,18271,18394,33768,87884,104277,123724,7277,56288,71981,189803,49320,3352,6798,14240,8954,69220,94433,57372,28620,68863,193727,85575,42309,41667,67689,42081,22543,44824,12719,28540,114236,101553,27638,27296,4300,5353,4663,19379,94098,3758,95888,95144,80344,87320,28447,259518,12718,71391,152731,37063,24132,31911,104896,15672,103782,1521,4945,72541,23717,122632,15619,87175,206120,29428,189780,61416,28350,44457,972,1175,47233,198738,95789,41907,21953,97034,59341,22864,53713,16873,32971,20693,20954,31336,21477,16169,38370,16412,9019,3841,24599,21938,17085,6484,81198,76413,5849,72514,12320,65247,276175,37234,59796,52642,16312,57349,198507,94148,46134,18958,125552,1747,18725,151873,14901,5490,68287,29470,3689,64794,40814,26018,25692,54450,2703,88278,124886,173087,174e3,24159,179477,24276,46004,201876,209202,445,52876,31948,30206,157610,39180,18439,44124,50469,5774,96278,222758,200216,50290,45486,20435,46986,46276,140133,142326,15569,13363,47522,92583,2182,7135,16853,22998,30272,4952,63263,35623,39096,53789,44864,20053,110392,124213,4630,16087,28221,127787,25839,77481,44693,13464,113146,6983,27069,55717,50102,4760,7107,26186,66507,59145,36032,104182,71328,29425,64317,50781,47465,94298,69706,74899,22754,120756,25108,93077,56834,73286,39928,16218,41699,176763,7555,70819,50083,26895,23315,26014,16773,123079,41712,5719,31516,90427,158540,85051,183128,40864,27505,55392,9058,45224,96857,30901,136622,96557,56304,120061,11501,151448,5773,89743,7769,86069,2935,18471,41628,10114,33660,110170,49479,26745,92846,33221,26731,18795,87076,8550,2100,29972,120289,3077,72490,33784,2630,208722,50861,63483,79029,6419,39467,14302,45286,64207,9686,67513,44170,1050,77246,59266,17055,53801,7150,11111,42432,4278,94579,362117,36175,42902,41933,39002,98489,22913,74161,84773,57036,17556,162288,74485,178760,93867,73635,128860,50362,261,67455,80001,46080,35662,4368,25247,19230,74393,22588,1822,27682,235324,13798,85998,13194,235067,23514,71669,147632,23191,134748,214683,105101,1518,25489,247114,7380,54842,26922,3971,26361,20844,68642,170517,77339,123255,8963,77818,150998,48466,36806,2732,23261,11741,236162,18243,126216,28690,50546,16385,92760,197383,246558,201295,88255,67588,71687,176076,172653,169058,33906,63747,24835,157621,43338,30050,46152,132741,2770,51371,94835,6614,15112,11749,56936,1250,19027,399017,58036,100215,23388,55815,308768,124152,94803,9521,64186,8971,28,30427,62163,7616,103838,35079,29203,131235,7743,17389,10882,37420,61460,228512,85363,41581,131077,62822,119647,10130,54445,26925,19968,29016,24446,74028,24176,61448,67185,9254,8563,119129,9771,99184,37716,39514,10532,221512,258753,218630,55980,23394,32141,61924,66749,32411,3741,36475,26678,77010,44946,91203,128749,116953,20476,49625,53116,13735,102335,29376,51946,83407,67892,59212,34685,21083,1546,112982,32972,74397,1078,190545,16082,86140,58591,89611,101531,10061,105104,76319,20035,17551,52611,169061,190842,100780,23907,90413,115619,9675,34710,193435,49443,129734,11183,258877,16318,136182,126808,44635,27304,192375,2599,125648,47051,12091,23814,721,58800,40137,66726,97930,60877,74487,7942,54326,9841,41428,13762,8211,85383,6950,99177,79806,201786,296464,124087,13144,29741,41721,47634,55088,254286,106408,17041,99064,12942,64086,45233,14005,2612,55827,255,7984,13980,38574,12776,46654,73499,249951,2101,26676,25996,132326,116415,119062,50449,31033,23038,11589,179252,20007,14860,129270,21143,17796,144715,60106,70758,69842,34674,282133,44014,16774,57268,38528,24053,46373,201667,28327,471023,51889,102667,21193,114909,84132,69317,96723,67969,16134,68145,15058,28765,32035,2524,101089,98664,25045,76571,14957,86040,118506,262428,154764,81573,39681,283900,73287,127825,544,80448,52347,38512,175971,15180,45467,33086,46552,48894,81107,43213,36672,54025,76703,8053,7608,13299,56619,20752,238099,54164,105133,1444,32942,953,37564,8e3,66316,119463,106817,404,13667,149108,128597,31267,10269,49836,106150,1484,52330,76965,160486,171648,38456,31263,22424,37738,66245,67467,143369,60471,75610,20895,115528,86070,60854,40796,49347,18989,15030,11371,37578,15779,79867,10187,86462,46402,155626,93200,40229,7090,57547,108053,99598,11088,47505,41218,206017,2173,20988,30219,22919,80563,57566,42369,93141,41675,2407,182519,120495,27154,16702,29456,14349,7958,16688,117177,140375,42467,261919,74916,153569,10836,34742,49526,7621,105997,12212,2270,392377,7755,17959,25086,232152,138791,33847,13860,35316,5811,1344,71259,50452,207539,92635,50359,5821,33674,30255,2086,2587,96264,17543,42,6029,9580,43007,139248,82831,12917,29607,25786,51467,42137,85161,100698,31561,88989,121990,278500,3602,109344,37982,15279,116442,28936,30880,87894,58079,128661,126731,67392,28051,146885,4861,16216,97344,42827,147561,153948,22684,21335,47685,1853,43349,15185,59642,10229,25520,187921,108972,5579,98037,24945,6697,19193,63734,137934,75056,89740,19767,224268,56138,63643,151661,39313,70618,84031,89723,84074,13703,85626,35460,8867,64845,3439,57906,99776,63968,49270,81130,34356,16210,23547,36446,34090,140028,72439,2221,22163,57058,363492,113754,18913,95451,48663,54464,54037,176097,68425,3023,34906,29482,117389,341780,80431,58330,16753,92616,60907,94846,147486,4498,48646,7773,46801,7778,18946,464978,47558,33223,177444,7328,15626,63337,94700,11743,9351,255024,39098,16447,42647,96230,39769,58840,10068,63439,35800,65843,58823,413844,9156,51258,7434,61791,85018,6872,3692,28096,7121,33024,6009,75532,31997,192535,9661,3304,9547,14753,31987,25314,55689,15896,20430,39472,31340,99744,25398,115569,54883,28719,205423,23071,57855,64638,149867,25671,82403,37616,20668,39989,77996,74948,140555,175248,64810,36515,46595,4958,248773,24045,28728,136673,168704,20804,114833,100325,27135,21205,96151,153134,45992,7093,13992,76047,1980,19432,145001,75159,87462,17710,1013,45556,34297,144882,20648,26061,11319,129567,108555,18872,464580,33386,22717,65948,167189,5603,135042,79542,8801,202632,18114,91882,5973,5239,67315,4431,60916,47819,71693,32597,32606,18183,45072,80329,76385,24749,51305,40314,156514,14693,130345,13168,66214,18029,12858,34801,27628,14544,10823,40522,40185,33739,148694,23548,9923,61012,28859,17933,19442,34364,99849,164107,141167,30629,21054,6744,36491,8096,42474,41706,155060,30650,10600,163442,1143,96655,61390,52359,7559,51568,64256,203854,4467,22453,14504,436398,7878,6980,8293,63610,293747,16167,35763,19627,147603,15419,18032,110744,51346,33681,54571,40472,48615,39073,21604,13754,173027,92560,11083,47299,63062,11813,52007,29883,9734,139722,15953,1550,20651,13616,49306,16113,90089,92326,7584,30712,72424,164858,6831,152871,55746,197721,34167,196442,6022,112107,55215,7538,123381,4920,43539,77165,8939,50392,34192,20225,79762,22505,58667,40770,29788,97180,82835,4568,8579,13273,363569,35898,49983,436,36598,3237,131691,62418,35591,8101,4073,379438,65218,76072,33887,2968,27573,212619,288680,68278,72851,150504,217896,6913,121339,22017,35340,51072,43616,75043,31437,10833,81487,4364,22968,41454,106687,85446,19863,109625,149241,524,141850,214404,54376,657,237023,9401,108137,53800,32474,49712,53334,126876,27337,45552,177696,8269,15036,12097,42240,2328,125374,119295,99715,2500,19624,39441,27220,102691,60957,94543,39101,18566,67362,13975,78230,25017,34017,239007,90027,39351,41681,35354,43822,1043,916,58587,141983,94818,38799,75459,41114,67432,16195,36606,59568,22272,126769,31424,68659,12287,134302,257977,5756,207285,95637,47248,117689,19583,77451,22373,12200,54993,117118,34244,29386,34562,53819,71267,64172,77665,49368,7716,59301,25749,45426,194789,17297,2650,1766,32501,45198,20403,20984,6600,14171,94604,19037,5402,29896,9938,59935,109708,88081,145182,44844,39167,352626,164173,35374,45982,6122,154,73419,220487,53834,53601,17992,8609,229321,5610,68098,66815,71012,95069,140968,27396,8957,134489,24656,86659,56598,134852,17316,123838,255436,6613,41610,138033,81452,32023,32396,123687,63398,8693,29712,30407,19296,121188,3551,36099,20032,111948,56624,16547,27453,35916,15378,52039,56849,13489,22214,73177,53097,277349,2157,14029,187886,10260,141743,246460,91880,50869,3788,49486,133566,54950,33120,129337,53768,18333,9525,26902,312251,10297,9020,70759,16647,112432,59260,84609,9818,82766,73569,468,46001,75780,55028,52106,11498,43645,108069,17150,17753,29417,16705,31799,9606,289,122254,115975,8620,6133,255357,56908,14456,133464,43554,79224,11247,29630,160,12756,25464,65960,350428,62521,321796,100359,67358,35169,46172,113128,48988,88868,31094,33266,6847,60887,98188,49659,69117,92977,220228,13947,80181,35103,62170,97351,13475,2440,199768,19498,36597,46971,25234,67806,62881,84717,73648,181966,10488,94149,21550,26655,63436,48375,14405,165650,9621,24439,28043,42735,4490,29963,56674,45373,1934,262446,50855,67098,26898,5261,52696,40644,33900,9440,180286,87162,22940,19704,26936,69769,10254,101759,27406,12243,48e3,73926,113215,54935,5726,192787,4312,106216,9366,11550,52949,23457,212271,277152,133895,108374,6191,96477,29980,218916,58024,54696,40853,91124,65894,91170,65908,252552,6793,29212,15389,44516,122515,52617,35058,9017,103536,39510,49136,19242,130652,662077,74699,47024,31422,8517,73351,24399,13867,128360,4810,4434,61779,111983,61036,17798,110240,59722,102960,39688,10001,23803,23039,176498,56659,44814,134295,17188,77577,74466,226175,102472,154333,63900,111747,18062,41171,79669,32773,408933,42562,28931,30907,107388,43487,2946,240310,23938,24354,319,184983,7927,6488,1422,10790,68809,68209,64775,4361,202,17123,59634,51200,44391,18188,17843,2619,74278,3230,9540,47187,21702,36274,56894,43907,16310,34790,16866,6150,5561,13587,107545,108873,126867,86986,28640,33427,19017,5762,80637,17430,46903,2047,131055,25958,13558,5444,47152,13900,44563,122857,45348,70863,39593,54332,38068,33637,318,40310,143467,18502,24520,11377,62013,28942,27246,28269,83545,17999,59015,90707,30065,15161,34720,1263,37008,2012,6060,98575,92933,5721,299,199555,24578,29223,2985,743,115825,109523,136657,47454,26378,53586,3733,174945,93340,244456,5693,37386,28782,89767,27545,23573,18798,136425,34320,84778,20041,48453,38215,7477,71958,40621,8773,5874,187927,105965,51100,43533,18083,8443,10180,43597,2003,183999,69689,12216,129696,146188,62389,34044,68410,12765,43273,26949,266807,3345,34477,79197,5688,47539,213110,21634,22257,50092,32222,42346,39530,63668,98,134978,74022,5152,59088,174145,37220,9934,9545,118937,5724,87240,19875,15784,40143,23263,87513,181654,285152,37881,263241,4966,43934,10433,186657,6470,74416,225854,25908,142677,246262,32280,6192,75890,45546,143264,135305,29742,47013,77787,11732,126658,8763,37950,21806,57557,113464,89465,108995,164574,23894,22996,23169,15369,23117,17642,130607,40503,36239,280990,44666,9981,40427,147487,26869,168452,32886,32991,46798,240839,15111,70502,65697,88548,44145,28701,48767,31139,206777,35659,181164,166262,14554,171445,31786,66523,76607,17956,6507,31279,90476,116611,167918,6560,1243,115324,80128,41867,55897,187323,37069,32596,189444,145931,13390,105530,65709,26805,6999,55714,41300,22915,68951,22138,21120,22264,10058,19945,33635,56123,99085,10032,5818,6016,46649,57476,35264,94413,112522,262288,93686,83038,14341,23204,28807,66084,77987,6101,126673,7133,38126,5923,122091,170240,97772,46874,215746,43948,41622,3272,55596,8332,146411,251315,13533,8561,81521,115449,48616,175175,2063,186556,3036,134537,75772,29728,82360,22973,186559,86348,89100,38388,82297,45610,2613,87082,9986,177812,57884,23591,47485,42543,33582,44713,74439,257444,252451,31825,35631,38540,33066,5147,13973,4343,51830,70378,22827,26448,95560,36896,241741,48067,203953,298860,61620,20450,3220,67272,6586,107662,100160,108684,6929,57226,4762,7457,1320,40404,77204,99309,62750,208653,59977,44e3,74315,34332,5819,172217,64904,114077,18147,84012,1791,98456,90930,21446,116669,103938,7422,85140,59713,5768,326211,16239,75411,13229,29398,10758,236107,1539,112472,95979,152154,151294,306,21196,38146,10700,6891,84282,109646,56492,40539,6589,119491,51354,30685,140209,136906,29622,73617,49553,70525,51671,166869,139616,74395,37439,49595,45678,11959,33211,86560,52434,9282,62690,112155,130810,5243,108261,99970,265613,72551,80049,6391,33365,90721,66737,69872,87011,1860,9032,112544,60905,37371,89015,140351,19076,850,373531,2802,36725,218795,72062,28990,16550,24614,7815,6187,26336,33373,32162,42791,73555,32062,23386,10244,56392,49442,27076,136262,12412,14883,1134,33675,97153,199281,15608,100152,74072,47942,254301,36451,16026,10687,65067,56708,254030,30290,50490,13864,57941,259331,35588,23485,43486,24869,21620,92971,22072,88645,1048,182050,13343,32452,14825,19509,3325,216938,45740,99716,189082,53740,78245,25609,24311,176777,47340,308354,40669,66085,14102,125339,9225,128709,97207,1271,200933,78439,113451,88975,18324,46521,11819,18570,141756,72512,170020,52754,63550,118515,103073,93330,32736,50499,14722,31600,68452,398867,29316,172786,18417,104924,2606,5670,84818,16288,67106,59580,82929,607401,291,85829,359,15897,35830,50696,65630,52672,22115,356968,29895,40837,231192,34024,38957,26722,406,23335,124952,72068,68804,13268,147101,164740,276569,162596,66943,11569,26654,66358,4777,23229,102127,5848,978,2921,59666,5371,28212,90108,42938,39320,2499,4271,108792,33510,125072,71653,65239,38250,66357,38577,13964,86251,35708,50755,36010,29448,12209,3844,38222,206337,100876,67827,137088,14167,252225,84163,195270,1306,5703,54198,779,46802,22028,51124,86759,70560,113164,35685,162145,45471,34561,422,2611,6464,47486,19223,38246,9191,18331,89942,243642,212364,15893,17518,22617,6409,30046,126182,59716,36560,104428,18846,26592,19458,50793,147333,30826,1388,27647,10922,14495,33545,19269,135828,39727,41601,46931,233379,49169,131130,182112,16276,82381,118209,142445,128310,19672,28740,82907,33436,3118,102206,28723,24819,41937,38854,5157,3881,111491,1142,9776,421673,152241,29309,14961,87854,6054,15424,3796,82656,54996,2108,55367,239450,154525,9643,118103,106041,64601,68549,48707,30266,25772,18740,9462,229669,91798,112152,191327,14493,72828,8175,66636,236474,25817,87351,129027,76653,20422,22983,71240,27846,44661,12399,46158,77704,53101,35032,11072,17300,109294,33638,24408,1895,11241,760,17584,82479,125877,63150,141075,34259,23274,81698,15732,43577,48340,91584,14688,16379,24481,150280,96420,262050,48635,43727,61819,56268,72003,88178,17281,79912,13218,122519,125295,166396,11811,2171,118930,67746,17636,178278,174656,95661,173039,83845,79689,17473,98555,127696,203415,54730,22925,232239,9309,12136,175026,20740,180188,10747,39816,314017,266131,10040,175732,112550,220651,31974,37393,888,23008,86799,4303,64905,148467,75337,251,3284,370102,50264,9835,5438,23655,4481,29851,329,12855,7162,64931,78141,12804,42372,296771,83547,18624,34874,86271,3360,48665,77735,88767,11463,63527,28889,22258,29140,194315,113924,25499,6406,31334,1845,4802,49184,43455,35469,127594,92970,61038,115005,38840,87761,106838,8811,20572,55637,11162,96721,132425,108925,2948,125457,36356,3502,75270,27622,127192,2561,123095,49394,61155,16897,110064,9699,89448,53356,19628,220310,21622,83036,9885,112214,6087,26713,17901,161912,91492,3440,68594,9266,92238,8087,6866,150194,72175,80701,13459,31836,43243,239700,95846,44749,50647,21945,230538,120612,132371,244604,5193,105637,34661,41341,68775,85393,1874,8771,33718,49672,77403,595452,99507,6490,58895,128742,7704,39239,73217,43816,62824,37804,199976,22361,80005,87514,94832,14089,4574,139975,59142,75523,100268,43906,53442,15152,2547,186002,17011,19513,204282,3343,60568,128318,119250,4298,51871,41336,71759,21921,45074,98169,145889,99427,11350,1237,5520,28799,7803,53702,21026,136352,38293,128690,12158,90132,44600,10184,26957,39459,126025,78904,82999,59373,39301,150198,120529,153042,20177,50089,14764,271571,30530,123161,38975,101562,22941,5648,124654,109243,69817,71675,49162,106884,21241,107795,30258,16572,188262,141456,7688,60718,8271,11044,32440,104608,103419,236109,93156,43293,128929,42107,67180,25201,115254,185488,130954,72813,167547,20537,39969,38432,22582,184022,1139,27199,5655,17767,97412,122606,209377,27070,35871,326617,188954,42680,73512,80911,22629,3011,95021,315242,157737,383,41821,41808,19335,27950,15674,25677,110950,35375,76835,59108,57370,35262,16569,160415,37706,78086,32041,49691,137143,9782,172080,50148,77917,6323,10110,69172,17711,21795,59511,76184,135114,31046,132319,59105,157578,20549,80778,57649,158421,65143,4575,72235,21899,10797,92745,34035,106079,80159,4508,78304,25350,75457,46458,32937,25623,47,8531,104751,84953,8138,36508,187199,66310,115274,13253,32461,38536,1916,42007,187160,35055,26325,84394,35963,94216,45590,97782];var I3=15,C3=class{log;peerRouting;routingTable;refreshInterval;refreshQueryTimeout;commonPrefixLengthRefreshedAt;refreshTimeoutId;constructor(e,t){let{peerRouting:n,routingTable:o,refreshInterval:i,refreshQueryTimeout:s,logPrefix:a}=t;this.log=e.logger.forComponent(`${a}:routing-table:refresh`),this.peerRouting=n,this.routingTable=o,this.refreshInterval=i??pk,this.refreshQueryTimeout=s??mk,this.commonPrefixLengthRefreshedAt=[],this.refreshTable=this.refreshTable.bind(this)}async afterStart(){this.log(`refreshing routing table every ${this.refreshInterval}ms`),this.refreshTable(!0)}async stop(){this.refreshTimeoutId!=null&&clearTimeout(this.refreshTimeoutId)}refreshTable(e=!1,t){this.log("refreshing routing table");let n=this._maxCommonPrefix(),o=this._getTrackedCommonPrefixLengthsForRefresh(n);this.log(`max common prefix length ${n}`),this.log(`tracked CPLs [ ${o.map(i=>i.toISOString()).join(", ")} ]`),Promise.all(o.map(async(i,s)=>{try{if(await this._refreshCommonPrefixLength(s,i,e,t),this._numPeersForCpl(n)===0){let a=Math.min(2*(s+1),o.length-1);for(let c=s+1;c<a+1;c++)try{await this._refreshCommonPrefixLength(c,i,e,t)}catch(l){this.log.error("failed to refresh entries with common prefix length %d - %e",c,l)}}}catch(a){this.log.error("failed to refresh entries with common prefix length - %e",a)}})).catch(i=>{this.log.error("failed to refresh table - %e",i)}).then(()=>{this.refreshTimeoutId=setTimeout(this.refreshTable,this.refreshInterval),this.refreshTimeoutId.unref!=null&&this.refreshTimeoutId.unref()}).catch(i=>{this.log.error("failed to set refresh timeout - %e",i)})}async _refreshCommonPrefixLength(e,t,n,o){if(!n&&t.getTime()>Date.now()-this.refreshInterval){this.log("not running refresh for cpl %s as time since last refresh not above interval",e);return}let i=this._generateRandomPeerId(e);this.log("starting refreshing cpl %s with key %p (routing table size was %s)",e,i,this.routingTable.size);let s=De([o?.signal,AbortSignal.timeout(this.refreshQueryTimeout)]);try{let a=await x3(this.peerRouting.getClosestPeers(i.toMultihash().bytes,{signal:s}));this.log(`found ${a} peers that were close to imaginary peer %p`,i),this.log("finished refreshing cpl %s with key %p (routing table size is now %s)",e,i,this.routingTable.size)}finally{s.clear()}}_getTrackedCommonPrefixLengthsForRefresh(e){e>I3&&(e=I3);let t=[];for(let n=0;n<=e;n++)t[n]=this.commonPrefixLengthRefreshedAt[n]??new Date;return t}_generateRandomPeerId(e){if(this.routingTable.kb==null)throw new Error("Routing table not started");if(this.routingTable.kb.localPeer==null)throw new Error("Local peer not set");let t=Xr(2),n=(t[1]<<8)+t[0],o=this._makePeerId(this.routingTable.kb.localPeer.kadId,n,e),i=lt(o);return zt(i)}_makePeerId(e,t,n){if(n>I3)throw new Error(`Cannot generate peer ID for common prefix length greater than ${I3}`);let s=new DataView(e.buffer,e.byteOffset,e.byteLength).getUint16(0,!1)^32768>>n,a=65535<<16-(n+1),c=s&a|t&~a,l=Mk[c],f=new ArrayBuffer(34),u=new DataView(f,0,f.byteLength);return u.setUint8(0,St.code),u.setUint8(1,32),u.setUint32(2,l,!1),new Uint8Array(u.buffer,u.byteOffset,u.byteLength)}_maxCommonPrefix(){let e=0;for(let t of this._prefixLengths())t>e&&(e=t);return e}_numPeersForCpl(e){let t=0;for(let n of this._prefixLengths())n===e&&t++;return t}*_prefixLengths(){if(this.routingTable.kb?.localPeer!=null)for(let{kadId:e}of this.routingTable.kb.toIterable()){let t=Uo(this.routingTable.kb.localPeer.kadId,e),n=0;for(let o of t)if(o===0)n++;else break;yield n}}};var P3=class{peerId;providers;peerStore;log;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:add-provider`),this.peerId=e.peerId,this.providers=t.providers,this.peerStore=e.peerStore}async handle(e,t){if(t.key==null||t.key.length===0)throw new Be("Missing key");let n;try{n=he.decode(t.key)}catch{throw new Be("Invalid CID")}(t.providers==null||t.providers.length===0)&&this.log.error("no providers found in message"),this.log("%p asked us, %p to store provider record for for %c",e,this.peerId,n),await Promise.all(t.providers.map(async o=>{let i=lt(o.id),s=zt(i),a=o.multiaddrs.map(c=>ie(c));if(!e.equals(s)){this.log("invalid provider peer %p from %p",o.id,e);return}if(o.multiaddrs.length<1){this.log("no valid addresses for provider %p. Ignore",e);return}this.log.trace("received provider %p for %s (addrs %s)",e,n,a),await this.providers.addProvider(n,s),await this.peerStore.merge(s,{multiaddrs:a})}))}};var k3=class{peerRouting;peerInfoMapper;peerId;addressManager;log;constructor(e,t){let{peerRouting:n,logPrefix:o}=t;this.log=e.logger.forComponent(`${o}:rpc:handlers:find-node`),this.peerId=e.peerId,this.addressManager=e.addressManager,this.peerRouting=n,this.peerInfoMapper=t.peerInfoMapper}async handle(e,t){this.log("incoming request from %p for peers close to %b",e,t.key);try{if(t.key==null)throw new Be("Invalid FIND_NODE message received - key was missing");let n=await this.peerRouting.getClosestPeersOffline(t.key,{exclude:[e,this.peerId]});we(this.peerId.toMultihash().bytes,t.key)&&n.push({id:this.peerId,multiaddrs:this.addressManager.getAddresses().map(i=>i.decapsulateCode(421))});let o={type:tt.FIND_NODE,clusterLevel:t.clusterLevel,closer:n.map(this.peerInfoMapper).filter(({multiaddrs:i})=>i.length).map(i=>({id:i.id.toMultihash().bytes,multiaddrs:i.multiaddrs.map(s=>s.bytes)})),providers:[]};return o.closer.length===0?this.log("could not find any peers closer to %b for %p",t.key,e):this.log("found %d peers close to %b for %p",o.closer.length,t.key,e),o}catch(n){throw this.log("error during finding peers closer to %b for %p - %e",t.key,e,n),n}}};var O3=class{peerId;peerRouting;providers;peerStore;peerInfoMapper;log;constructor(e,t){let{peerRouting:n,providers:o,logPrefix:i}=t;this.log=e.logger.forComponent(`${i}:rpc:handlers:get-providers`),this.peerId=e.peerId,this.peerStore=e.peerStore,this.peerRouting=n,this.providers=o,this.peerInfoMapper=t.peerInfoMapper}async handle(e,t){if(t.key==null)throw new Be("Invalid GET_PROVIDERS message received - key was missing");let n;try{n=he.decode(t.key)}catch{throw new Be("Invalid CID")}this.log("%p asking for providers for %s",e,n);let[o,i]=await Promise.all([es(to(await this.providers.getProviders(n),async a=>{let c=await this.peerStore.get(a);return{id:c.id,multiaddrs:c.addresses.map(({multiaddr:f})=>f)}})),this.peerRouting.getClosestPeersOffline(t.key)]),s={type:tt.GET_PROVIDERS,key:t.key,clusterLevel:t.clusterLevel,closer:i.map(this.peerInfoMapper).filter(({id:a,multiaddrs:c})=>c.length>0).map(a=>({id:a.id.toMultihash().bytes,multiaddrs:a.multiaddrs.map(c=>c.bytes)})),providers:o.map(this.peerInfoMapper).filter(({id:a,multiaddrs:c})=>c.length>0).map(a=>({id:a.id.toMultihash().bytes,multiaddrs:a.multiaddrs.map(c=>c.bytes)}))};return this.log("got %s providers %s closerPeers",s.providers.length,s.closer.length),s}async _getAddresses(e){return[]}};var R3=class{peerStore;datastore;peerRouting;log;datastorePrefix;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:get-value`),this.datastorePrefix=`${t.datastorePrefix}/record`,this.peerStore=e.peerStore,this.datastore=e.datastore,this.peerRouting=t.peerRouting}async handle(e,t){let n=t.key;if(this.log("%p asked for key %b",e,n),n==null||n.length===0)throw new Be("Invalid key");let o={type:tt.GET_VALUE,key:n,clusterLevel:t.clusterLevel,closer:[],providers:[]};if(Tk(n)){this.log("is public key");let a=Ik(n),c;try{let l=await this.peerStore.get(a);if(l.id.publicKey==null)throw new Xe("No public key found in key book");c=sr(l.id.publicKey)}catch(l){if(l.name!=="NotFoundError")throw l}if(c!=null)return this.log("returning found public key"),o.record=new Ar(n,c,new Date).serialize(),o}let[i,s]=await Promise.all([this._checkLocalDatastore(n),this.peerRouting.getClosestPeersOffline(n)]);return i!=null&&(this.log("had record for %b in local datastore",n),o.record=i.serialize()),s.length>0&&(this.log("had %s closer peers in routing table",s.length),o.closer=s.map(a=>({id:a.id.toMultihash().bytes,multiaddrs:a.multiaddrs.map(c=>c.bytes)}))),o}async _checkLocalDatastore(e){this.log("checkLocalDatastore looking for %b",e);let t=ha(this.datastorePrefix,e),n;try{n=await this.datastore.get(t)}catch(i){if(i.name==="NotFoundError")return;throw i}let o=Ar.deserialize(n);if(o.timeReceived==null||Date.now()-o.timeReceived.getTime()>i3){await this.datastore.delete(t);return}return o}};var D3=class{log;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:ping`)}async handle(e,t){return this.log("ping from %p",e),t}};var N3=class{components;validators;log;datastorePrefix;constructor(e,t){let{validators:n}=t;this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:put-value`),this.datastorePrefix=`${t.datastorePrefix}/record`,this.validators=n}async handle(e,t){let n=t.key;if(this.log("%p asked us to store value for key %b",e,n),t.record==null)throw this.log.error("empty record from %p",e),new Be(`Empty record from: ${e}`);try{let o=Ar.deserialize(t.record);await gf(this.validators,o),o.timeReceived=new Date;let i=ha(this.datastorePrefix,o.key);await this.components.datastore.put(i,o.serialize().subarray()),this.log("put record for %b into datastore under key %k",n,i)}catch(o){this.log("did not put record for key %b into datastore %o",n,o)}return t}};var L3=class{handlers;log;metrics;incomingMessageTimeout;constructor(e,t){this.metrics={operations:e.metrics?.registerCounterGroup(`${t.metricsPrefix}_inbound_rpc_requests_total`),errors:e.metrics?.registerCounterGroup(`${t.metricsPrefix}_inbound_rpc_errors_total`),rpcTime:e.metrics?.registerMetricGroup(`${t.metricsPrefix}_inbound_rpc_time_seconds`,{label:"operation"})},this.log=e.logger.forComponent(`${t.logPrefix}:rpc`),this.incomingMessageTimeout=t.incomingMessageTimeout??1e4,this.handlers={[tt.GET_VALUE.toString()]:new R3(e,t),[tt.PUT_VALUE.toString()]:new N3(e,t),[tt.FIND_NODE.toString()]:new k3(e,t),[tt.ADD_PROVIDER.toString()]:new P3(e,t),[tt.GET_PROVIDERS.toString()]:new O3(e,t),[tt.PING.toString()]:new D3(e,t)}}async handleMessage(e,t){let n=this.handlers[t.type];if(n==null){this.log.error(`no handler found for message type: ${t.type}`);return}try{return this.metrics.operations?.increment({[t.type]:!0}),await n.handle(e,t)}catch{this.metrics.errors?.increment({[t.type]:!0})}}async onIncomingStream(e,t){let n=()=>{e.abort(new Yo)},o=AbortSignal.timeout(this.incomingMessageTimeout);o.addEventListener("abort",n);let i=bt(e).pb(fa);for(;;){if(e.readStatus!=="readable"){await e.close({signal:o});break}let s=await i.read({signal:o}),a=this.metrics?.rpcTime?.timer(s.type.toString()),c=this.metrics?.rpcTime?.timer(s.type.toString()),l=!1;try{this.log("incoming %s from %p",s.type,t.remotePeer);let f=await this.handleMessage(t.remotePeer,s);f!=null&&await i.write(f,{signal:o})}catch(f){throw l=!0,c?.(),f}finally{l||a?.()}o.removeEventListener("abort",n),o=AbortSignal.timeout(this.incomingMessageTimeout),o.addEventListener("abort",n)}}};var B3=class extends _e{log;components;protocol;running;registrarId;constructor(e,t){super();let{protocol:n,logPrefix:o}=t;this.components=e,this.log=e.logger.forComponent(`${o}:topology-listener`),this.running=!1,this.protocol=n}isStarted(){return this.running}async start(){this.running||(this.running=!0,this.registrarId=await this.components.registrar.register(this.protocol,{onConnect:e=>{this.log("observed peer %p with protocol %s",e,this.protocol),this.dispatchEvent(new CustomEvent("peer",{detail:e}))}}))}async stop(){this.running=!1,this.registrarId!=null&&(this.components.registrar.unregister(this.registrarId),this.registrarId=void 0)}};var _b=class{dht;constructor(e){this.dht=e}async provide(e,t={}){await an(this.dht.provide(e,t))}async cancelReprovide(e){await this.dht.cancelReprovide(e)}async*findProviders(e,t={}){for await(let n of this.dht.findProviders(e,t))n.name==="PROVIDER"&&(yield*n.providers.map(o=>({...o,routing:"kad-dht"})))}async put(e,t,n){await an(this.dht.put(e,t,n))}async get(e,t){for await(let n of this.dht.get(e,t))if(n.name==="VALUE")return n.value;throw new Xe("Could not find value for key")}},Ab=class{dht;constructor(e){this.dht=e}async findPeer(e,t={}){for await(let n of this.dht.findPeer(e,t))if(n.name==="FINAL_PEER")return n.peer;throw new Xe("Peer not found")}async*getClosestPeers(e,t={}){for await(let n of this.dht.getClosestPeers(e,t))n.name==="FINAL_PEER"&&(yield n.peer)}},JH=32,eq=64,M3=class extends _e{k;a;d;protocol;routingTable;providers;network;peerRouting;components;log;running;clientMode;validators;selectors;queryManager;contentFetching;contentRouting;routingTableRefresh;rpc;topologyListener;querySelf;maxInboundStreams;maxOutboundStreams;dhtContentRouting;dhtPeerRouting;peerInfoMapper;reprovider;onPeerConnectTimeout;constructor(e,t={}){super();let n=t.logPrefix??"libp2p:kad-dht",o=t.datastorePrefix??"/dht",i=t.metricsPrefix??"libp2p_kad_dht",s={queries:e.metrics?.registerMetricGroup(`${i}_operations_total`,{label:"operation"}),errors:e.metrics?.registerCounterGroup(`${i}_operation_errors_total`,{label:"operation"}),queryTime:e.metrics?.registerMetricGroup(`${i}_operation_time_seconds`,{label:"operation"}),errorTime:e.metrics?.registerMetricGroup(`${i}_operation_error_time_seconds`,{label:"operation"})};this.running=!1,this.components=e,this.log=e.logger.forComponent(n),this.k=t.kBucketSize??Tp,this.a=t.alpha??la,this.d=t.disjointPaths??this.a,this.protocol=t.protocol??ik,this.clientMode=t.clientMode??!0,this.maxInboundStreams=t.maxInboundStreams??JH,this.maxOutboundStreams=t.maxOutboundStreams??eq,this.peerInfoMapper=t.peerInfoMapper??_k,this.onPeerConnectTimeout=t.onPeerConnectTimeout??uk,this.providers=new b3(e,{...t.providers,logPrefix:n,datastorePrefix:o}),this.validators={...Sk,...t.validators},this.selectors={...Ek,...t.selectors},this.network=new y3(e,{protocol:this.protocol,logPrefix:n,metricsPrefix:i}),this.routingTable=new T3(e,{kBucketSize:this.k,pingOldContactTimeout:t.pingOldContactTimeout,pingOldContactConcurrency:t.pingOldContactConcurrency,pingOldContactMaxQueueSize:t.pingOldContactMaxQueueSize,pingNewContactTimeout:t.pingNewContactTimeout,pingNewContactConcurrency:t.pingNewContactConcurrency,pingNewContactMaxQueueSize:t.pingNewContactMaxQueueSize,protocol:this.protocol,logPrefix:n,metricsPrefix:i,prefixLength:t.prefixLength,splitThreshold:t.kBucketSplitThreshold,network:this.network});let a=Ve();t.allowQueryWithZeroPeers===!0&&a.resolve(),this.queryManager=new v3(e,{disjointPaths:this.d,alpha:this.a,logPrefix:n,metricsPrefix:i,initialQuerySelfHasRun:a,routingTable:this.routingTable,allowQueryWithZeroPeers:t.allowQueryWithZeroPeers}),this.peerRouting=new w3(e,{routingTable:this.routingTable,network:this.network,validators:this.validators,queryManager:this.queryManager,logPrefix:n}),this.contentFetching=new m3(e,{validators:this.validators,selectors:this.selectors,peerRouting:this.peerRouting,queryManager:this.queryManager,network:this.network,logPrefix:n,datastorePrefix:o}),this.contentRouting=new g3(e,{network:this.network,peerRouting:this.peerRouting,queryManager:this.queryManager,routingTable:this.routingTable,providers:this.providers,logPrefix:n}),this.routingTableRefresh=new C3(e,{peerRouting:this.peerRouting,routingTable:this.routingTable,logPrefix:n}),this.rpc=new L3(e,{routingTable:this.routingTable,providers:this.providers,peerRouting:this.peerRouting,validators:this.validators,logPrefix:n,metricsPrefix:i,datastorePrefix:o,peerInfoMapper:this.peerInfoMapper}),this.topologyListener=new B3(e,{protocol:this.protocol,logPrefix:n}),this.querySelf=new E3(e,{peerRouting:this.peerRouting,interval:t.querySelfInterval,initialInterval:t.initialQuerySelfInterval,logPrefix:n,initialQuerySelfHasRun:a,operationMetrics:s}),this.reprovider=new S3(e,{...t.reprovide,logPrefix:n,metricsPrefix:i,datastorePrefix:o,contentRouting:this.contentRouting,operationMetrics:s}),this.network.addEventListener("peer",c=>{let l=c.detail;this.onPeerConnect(l).catch(f=>{this.log.error("could not add %p to routing table - %e",l.id,f)}),this.dispatchEvent(new CustomEvent("peer",{detail:l}))}),this.topologyListener.addEventListener("peer",c=>{let l=c.detail;Promise.resolve().then(async()=>{let f=await this.components.peerStore.get(l),u={id:l,multiaddrs:f.addresses.map(({multiaddr:d})=>d),protocols:f.protocols};await this.onPeerConnect(u)}).catch(f=>{this.log.error("could not add %p to routing table - %e",l,f)})}),this.dhtPeerRouting=new Ab(this),this.dhtContentRouting=new _b(this),t.clientMode==null&&e.events.addEventListener("self:peer:update",c=>{this.log("received update of self-peer info"),Promise.resolve().then(async()=>{let l=c.detail.peer.addresses.some(({multiaddr:u})=>!Mt(u)&&!fr.exactMatch(u)),f=this.getMode();l&&f==="client"?await this.setMode("server"):f==="server"&&!l&&await this.setMode("client")}).catch(l=>{this.log.error("error setting dht server mode - %e",l)})}),this.get=Jc(this.get.bind(this),s,"GET_VALUE"),this.findProviders=Jc(this.findProviders.bind(this),s,"FIND_PROVIDERS"),this.findPeer=Jc(this.findPeer.bind(this),s,"FIND_PEER"),this.getClosestPeers=Jc(this.getClosestPeers.bind(this),s,"GET_CLOSEST_PEERS"),this.provide=Jc(this.provide.bind(this),s,"PROVIDE"),this.put=Jc(this.put.bind(this),s,"PUT_VALUE")}[Symbol.toStringTag]="@libp2p/kad-dht";[qe]=["@libp2p/content-routing","@libp2p/peer-routing","@libp2p/peer-discovery","@libp2p/kad-dht"];[An]=["@libp2p/identify","@libp2p/ping"];get[ki](){return this.dhtContentRouting}get[Ri](){return this.dhtPeerRouting}get[Va](){return this}async onPeerConnect(e){if(this.log.trace("peer %p connected",e.id,e.multiaddrs),e=this.peerInfoMapper(e),e.multiaddrs.length===0){this.log.trace("ignoring %p as there were no valid addresses in %s after filtering",e.id,e.multiaddrs.map(n=>n.toString()));return}let t=AbortSignal.timeout(this.onPeerConnectTimeout);try{await this.routingTable.add(e.id,{signal:t})}catch(n){this.log.error("could not add %p to routing table - %e",e.id,n)}}isStarted(){return this.running}getMode(){return this.clientMode?"client":"server"}async setMode(e,t){if(e===this.getMode()&&t?.force!==!0){this.log("already in %s mode",e);return}if(await this.components.registrar.unhandle(this.protocol,t),e===this.getMode()&&t?.force!==!0){this.log("already in %s mode",e);return}e==="client"?(this.log("enabling client mode while in %s mode",this.getMode()),this.clientMode=!0):(this.log("enabling server mode while in %s mode",this.getMode()),this.clientMode=!1,await this.components.registrar.handle(this.protocol,this.rpc.onIncomingStream.bind(this.rpc),{signal:t?.signal,maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams}))}async start(){this.running||(this.running=!0,await this.setMode(this.clientMode?"client":"server",{force:!0}),await er(this.routingTable,this.queryManager,this.network,this.topologyListener,this.routingTableRefresh,this.reprovider),await er(this.querySelf))}async stop(){this.running=!1,await or(this.querySelf,this.queryManager,this.network,this.routingTable,this.routingTableRefresh,this.topologyListener,this.reprovider)}async*put(e,t,n={}){yield*this.contentFetching.put(e,t,n)}async*get(e,t={}){yield*this.contentFetching.get(e,t)}async*provide(e,t={}){yield*this.contentRouting.provide(e,this.components.addressManager.getAddresses(),t)}async cancelReprovide(e,t){await this.providers.removeProvider(e,this.components.peerId,t)}async*findProviders(e,t={}){yield*this.contentRouting.findProviders(e,t)}async*findPeer(e,t={}){yield*this.peerRouting.findPeer(e,t)}async*getClosestPeers(e,t={}){yield*this.peerRouting.getClosestPeers(e,t)}async refreshRoutingTable(e){this.routingTableRefresh.refreshTable(!0,e)}};var Uk;(function(r){r[r.SEND_QUERY=0]="SEND_QUERY",r[r.PEER_RESPONSE=1]="PEER_RESPONSE",r[r.FINAL_PEER=2]="FINAL_PEER",r[r.QUERY_ERROR=3]="QUERY_ERROR",r[r.PROVIDER=4]="PROVIDER",r[r.VALUE=5]="VALUE",r[r.ADD_PEER=6]="ADD_PEER",r[r.DIAL_PEER=7]="DIAL_PEER",r[r.PATH_ENDED=8]="PATH_ENDED"})(Uk||(Uk={}));function Fk(r={}){return e=>new M3(e,r)}var rt;(function(r){r[r.NEW_STREAM=0]="NEW_STREAM",r[r.MESSAGE_RECEIVER=1]="MESSAGE_RECEIVER",r[r.MESSAGE_INITIATOR=2]="MESSAGE_INITIATOR",r[r.CLOSE_RECEIVER=3]="CLOSE_RECEIVER",r[r.CLOSE_INITIATOR=4]="CLOSE_INITIATOR",r[r.RESET_RECEIVER=5]="RESET_RECEIVER",r[r.RESET_INITIATOR=6]="RESET_INITIATOR"})(rt||(rt={}));var Ip=Object.freeze({0:"NEW_STREAM",1:"MESSAGE_RECEIVER",2:"MESSAGE_INITIATOR",3:"CLOSE_RECEIVER",4:"CLOSE_INITIATOR",5:"RESET_RECEIVER",6:"RESET_INITIATOR"}),Tb=Object.freeze({NEW_STREAM:rt.NEW_STREAM,MESSAGE:rt.MESSAGE_INITIATOR,CLOSE:rt.CLOSE_INITIATOR,RESET:rt.RESET_INITIATOR}),$k=Object.freeze({MESSAGE:rt.MESSAGE_RECEIVER,CLOSE:rt.CLOSE_RECEIVER,RESET:rt.RESET_RECEIVER});var Cp=1<<20,Ib=4<<20,U3=class{_buffer;_headerInfo;_maxMessageSize;_maxUnprocessedMessageQueueSize;constructor(e=Cp,t=Ib){this._buffer=new fe,this._headerInfo=null,this._maxMessageSize=e,this._maxUnprocessedMessageQueueSize=t}write(e){if(e==null||e.length===0)return[];if(this._buffer.append(e),this._buffer.byteLength>this._maxUnprocessedMessageQueueSize)throw new Be("Unprocessed message queue size too large!");let t=[];for(;this._buffer.length!==0;){if(this._headerInfo==null)try{this._headerInfo=this._decodeHeader(this._buffer)}catch(l){if(l.name==="InvalidMessageError")throw l;break}let{id:n,type:o,length:i,offset:s}=this._headerInfo;if(this._buffer.length-s<i)break;let c={id:n,type:o};(o===rt.NEW_STREAM||o===rt.MESSAGE_INITIATOR||o===rt.MESSAGE_RECEIVER)&&(c.data=this._buffer.sublist(s,s+i)),t.push(c),this._buffer.consume(s+i),this._headerInfo=null}return t}_decodeHeader(e){let{value:t,offset:n}=Kk(e),{value:o,offset:i}=Kk(e,n),s=t&7;if(Ip[s]==null)throw new Error(`Invalid type received: ${s}`);if(o>this._maxMessageSize)throw new Be("Message size too large");return{id:t>>3,type:s,offset:n+i,length:o}}},tq=128,jk=127;function Kk(r,e=0){let t=0,n=0,o=e,i,s=r.length;do{if(o>=s||n>49)throw e=0,new RangeError("Could not decode varint");i=r.get(o++),t+=n<28?(i&jk)<<n:(i&jk)*Math.pow(2,n),n+=7}while(i>=tq);return e=o-e,{value:t,offset:e}}var Cb=10*1024,Pb=class{_pool;_poolOffset;constructor(){this._pool=Ot(Cb),this._poolOffset=0}write(e,t){let n=this._pool,o=this._poolOffset;Mr(e.id<<3|e.type,n,o),o+=je(e.id<<3|e.type),(e.type===rt.NEW_STREAM||e.type===rt.MESSAGE_INITIATOR||e.type===rt.MESSAGE_RECEIVER)&&e.data!=null?(Mr(e.data.length,n,o),o+=je(e.data.length)):(Mr(0,n,o),o+=je(0));let i=n.subarray(this._poolOffset,o);Cb-o<100?(this._pool=Ot(Cb),this._poolOffset=0):this._poolOffset=o,t.append(i),(e.type===rt.NEW_STREAM||e.type===rt.MESSAGE_INITIATOR||e.type===rt.MESSAGE_RECEIVER)&&e.data!=null&&t.append(e.data)}},rq=new Pb;function Pp(r){let e=new fe;return rq.write(r,e),e}var kb=class extends Ws{streamId;types;maxDataSize;muxer;constructor(e){super(e),this.types=e.direction==="outbound"?Tb:$k,this.maxDataSize=e.maxDataSize,this.muxer=e.muxer,this.streamId=parseInt(this.id.substring(1)),e.direction==="outbound"&&queueMicrotask(()=>{this.muxer.send(Pp({id:this.streamId,type:Tb.NEW_STREAM,data:new fe(B(this.id))}))})}sendData(e){let t=new fe,n=e.byteLength;for(;e.byteLength>0;){let o=Math.min(e.byteLength,this.maxDataSize),i=e.sublist(0,o);e=e.sublist(o),t.append(Pp({id:this.streamId,type:this.types.MESSAGE,data:i}))}return{sentBytes:n,canSendMore:this.muxer.send(t)}}sendReset(){return this.muxer.send(Pp({id:this.streamId,type:this.types.RESET}))}async sendCloseWrite(e){this.muxer.send(Pp({id:this.streamId,type:this.types.CLOSE})),e?.signal?.throwIfAborted()}async sendCloseRead(e){e?.signal?.throwIfAborted()}sendPause(){}sendResume(){}};function Vk(r){let{id:e,muxer:t,direction:n,maxMsgSize:o=Cp}=r;return new kb({...r,id:n==="outbound"?`i${e}`:`r${e}`,direction:n,maxDataSize:o,muxer:t,log:r.log.newScope(`${n}:${e}`),protocol:""})}var nq=5;function oq(r){let e={...r,type:`${Ip[r.type]} (${r.type})`};return r.type===rt.NEW_STREAM&&(e.data=j(r.data.subarray())),(r.type===rt.MESSAGE_INITIATOR||r.type===rt.MESSAGE_RECEIVER)&&(e.data=j(r.data.subarray(),"base16")),e}var F3=class extends qs{_streamId;rateLimiter;maxMessageSize;maxUnprocessedMessageQueueSize;decoder;constructor(e,t){super(e,{...t,protocol:"/mplex/6.7.0",name:"mplex"}),this._streamId=0,this.maxMessageSize=t.maxMessageSize??Cp,this.maxUnprocessedMessageQueueSize=t.maxUnprocessedMessageQueueSize??Ib,this.decoder=new U3(this.maxMessageSize,this.maxUnprocessedMessageQueueSize),this.rateLimiter=new Cu({points:t.disconnectThreshold??nq,duration:1})}onData(e){for(let t of this.decoder.write(e))this.handleMessage(t)}onCreateStream(e){if(this.status!=="open")throw new yo("Muxer already closed");let t=this._streamId++;return this._newStream(t,"outbound",e)}_newStream(e,t,n){return this.log("new %s stream %s",t,e),Vk({...n,id:e,direction:t,maxMsgSize:this.maxMessageSize,log:this.log,muxer:this})}handleMessage(e){if(this.log.enabled&&this.log.trace("incoming message",oq(e)),e.type===rt.NEW_STREAM){try{this.rateLimiter.consume("new-stream",1)}catch{this.log("rate limit hit when opening too many new streams over the inbound stream limit - closing remote connection"),this.abort(new Error("Too many open streams"));return}let o=this._newStream(e.id,"inbound",this.streamOptions);this.onRemoteStream(o);return}let t=`${(e.type&1)===1?"i":"r"}${e.id}`,n=this.streams.find(o=>o.id===t);if(n==null){this.log("missing stream %s for message type %s",t,Ip[e.type]);try{this.rateLimiter.consume("missing-stream",1)}catch{this.log("rate limit hit when receiving messages for streams that do not exist - closing remote connection"),this.abort(new Error("Too many messages for missing streams"));return}return}try{switch(e.type){case rt.MESSAGE_INITIATOR:case rt.MESSAGE_RECEIVER:n.onData(e.data);break;case rt.CLOSE_INITIATOR:case rt.CLOSE_RECEIVER:n.onRemoteCloseWrite();break;case rt.RESET_INITIATOR:case rt.RESET_RECEIVER:n.onRemoteReset();break;default:this.log("unknown message type")}}catch(o){this.log.error("error while processing message - %e",o),n.abort(o)}}};var Ob=class{protocol="/mplex/6.7.0";_init;constructor(e={}){this._init=e}[Symbol.toStringTag]="@libp2p/mplex";[qe]=["@libp2p/stream-multiplexing"];createStreamMuxer(e){return new F3(e,{...this._init})}};function Hk(r={}){return()=>new Ob(r)}var Rb=class extends Error{constructor(e){super(e),this.name="TimeoutError"}},Db=class extends Error{constructor(e){super(),this.name="AbortError",this.message=e}},qk=r=>globalThis.DOMException===void 0?new Db(r):new DOMException(r),Wk=r=>{let e=r.reason===void 0?qk("This operation was aborted."):r.reason;return e instanceof Error?e:qk(e)};function Nb(r,e){let{milliseconds:t,fallback:n,message:o,customTimers:i={setTimeout,clearTimeout}}=e,s,a,l=new Promise((f,u)=>{if(typeof t!="number"||Math.sign(t)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${t}\``);if(e.signal){let{signal:h}=e;h.aborted&&u(Wk(h)),a=()=>{u(Wk(h))},h.addEventListener("abort",a,{once:!0})}if(t===Number.POSITIVE_INFINITY){r.then(f,u);return}let d=new Rb;s=i.setTimeout.call(void 0,()=>{if(n){try{f(n())}catch(h){u(h)}return}typeof r.cancel=="function"&&r.cancel(),o===!1?f():o instanceof Error?u(o):(d.message=o??`Promise timed out after ${t} milliseconds`,u(d))},t),(async()=>{try{f(await r)}catch(h){u(h)}})()}).finally(()=>{l.clear(),a&&e.signal&&e.signal.removeEventListener("abort",a)});return l.clear=()=>{i.clearTimeout.call(void 0,s),s=void 0},l}var iq=r=>{let e=r.addEventListener||r.on||r.addListener,t=r.removeEventListener||r.off||r.removeListener;if(!e||!t)throw new TypeError("Emitter is not compatible");return{addListener:e.bind(r),removeListener:t.bind(r)}};function sq(r,e,t){let n,o=new Promise((i,s)=>{if(t={rejectionEvents:["error"],multiArgs:!1,rejectionMultiArgs:!1,resolveImmediately:!1,...t},!(t.count>=0&&(t.count===Number.POSITIVE_INFINITY||Number.isInteger(t.count))))throw new TypeError("The `count` option should be at least 0 or more");t.signal?.throwIfAborted();let a=[e].flat(),c=[],{addListener:l,removeListener:f}=iq(r),u=async(...h)=>{let m=t.multiArgs?h:h[0];if(t.filter)try{if(!await t.filter(m))return}catch(w){n(),s(w);return}c.push(m),t.count===c.length&&(n(),i(c))},d=(...h)=>{n(),s(t.rejectionMultiArgs?h:h[0])};n=()=>{for(let h of a)f(h,u);for(let h of t.rejectionEvents)a.includes(h)||f(h,d)};for(let h of a)l(h,u);for(let h of t.rejectionEvents)a.includes(h)||l(h,d);t.signal&&t.signal.addEventListener("abort",()=>{d(t.signal.reason)},{once:!0}),t.resolveImmediately&&i(c)});if(o.cancel=n,typeof t.timeout=="number"){let i=Nb(o,{milliseconds:t.timeout});return i.cancel=()=>{n(),i.clear()},i}return o}function zk(r,e,t){typeof t=="function"&&(t={filter:t}),t={...t,count:1,resolveImmediately:!1};let n=sq(r,e,t),o=n.then(i=>i[0]);return o.cancel=n.cancel,o}var Gk="1.0.0",Xk="ping",Yk="ipfs";var $3=class{protocol;components;started;timeout;maxInboundStreams;maxOutboundStreams;runOnLimitedConnection;constructor(e,t={}){this.components=e,this.started=!1,this.protocol=`/${t.protocolPrefix??Yk}/${Xk}/${Gk}`,this.timeout=t.timeout??1e4,this.maxInboundStreams=t.maxInboundStreams??2,this.maxOutboundStreams=t.maxOutboundStreams??1,this.runOnLimitedConnection=t.runOnLimitedConnection??!0,this.handlePing=this.handlePing.bind(this)}[Symbol.toStringTag]="@libp2p/ping";[qe]=["@libp2p/ping"];async start(){await this.components.registrar.handle(this.protocol,this.handlePing,{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:this.runOnLimitedConnection}),this.started=!0}async stop(){await this.components.registrar.unhandle(this.protocol),this.started=!1}isStarted(){return this.started}async handlePing(e,t){let n=e.log.newScope("ping");n.trace("ping from %p",t.remotePeer);let o=AbortSignal.timeout(this.timeout);o.addEventListener("abort",()=>{e.abort(new Yo("Ping timed out"))});let i=Date.now();for await(let s of e){if(e.status!=="open"){n("stream status changed to %s",e.status);break}e.send(s)||(n("waiting for stream to drain"),await zk(e,"drain",{rejectionEvents:["close"],signal:o}),n("stream drained"))}n("ping from %p complete in %dms",t.remotePeer,Date.now()-i),await e.close({signal:o})}async ping(e,t={}){let n=Xr(32),o=await this.components.connectionManager.openStream(e,this.protocol,{runOnLimitedConnection:this.runOnLimitedConnection,...t}),i=o.log.newScope("ping");try{let s=Date.now(),a=Promise.withResolvers(),c=new fe,l=f=>{if(c.append(f.data),c.byteLength===32){o.removeEventListener("message",l);let u=Date.now()-s;Promise.all([o.closeRead(t)]).then(()=>{if(we(n,c.subarray()))a.resolve(u);else throw new ja(`Received wrong ping ack after ${u}ms`)}).catch(d=>{o.abort(d),a.reject(d)})}};return o.addEventListener("message",l),o.send(n),await o.close(t),await ut(a.promise,t.signal)}catch(s){throw i.error("error while pinging %o - %e",e,s),o?.abort(s),s}finally{o?.close()}}};function Zk(r={}){return e=>new $3(e,r)}var Vr;(function(r){let e;(function(o){o.FIN="FIN",o.STOP_SENDING="STOP_SENDING",o.RESET="RESET",o.FIN_ACK="FIN_ACK"})(e=r.Flag||(r.Flag={}));let t;(function(o){o[o.FIN=0]="FIN",o[o.STOP_SENDING=1]="STOP_SENDING",o[o.RESET=2]="RESET",o[o.FIN_ACK=3]="FIN_ACK"})(t||(t={})),(function(o){o.codec=()=>kt(t)})(e=r.Flag||(r.Flag={}));let n;r.codec=()=>(n==null&&(n=Ie((o,i,s={})=>{s.lengthDelimited!==!1&&i.fork(),o.flag!=null&&(i.uint32(8),r.Flag.codec().encode(o.flag,i)),o.message!=null&&(i.uint32(18),i.bytes(o.message)),s.lengthDelimited!==!1&&i.ldelim()},(o,i,s={})=>{let a={},c=i==null?o.len:o.pos+i;for(;o.pos<c;){let l=o.uint32();switch(l>>>3){case 1:{a.flag=r.Flag.codec().decode(o);break}case 2:{a.message=o.bytes();break}default:{o.skipType(l&7);break}}}return a})),n),r.encode=o=>Te(o,r.codec()),r.decode=(o,i)=>Ae(o,r.codec(),i)})(Vr||(Vr={}));var Jk=["stun:stun.l.google.com:19302","stun:global.stun.twilio.com:3478","stun:stun.cloudflare.com:3478","stun:stun.services.mozilla.com:3478"],Lb=Array.from("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890"),eO="libp2p+webrtc+v1/",tO=2*1024*1024,yf=16*1024;function uq(r=yf){let e=je(r-je(r)),t=1+je(Object.keys(Vr.Flag).length-1),n=1,o=r-e-t-n,i=je(o);return e+t+n+i}var rO=uq();var nO=1e4,Bb="/webrtc",kp="/webrtc-signaling/0.0.1",oO="/libp2p/webrtc-direct/certificate",iO="webrtc-direct-certificate-private-key";var sO=12096e5,Mb=864e5;var Ub=class extends Error{constructor(e){super(e),this.name="TimeoutError"}},Fb=class extends Error{constructor(e){super(),this.name="AbortError",this.message=e}},aO=r=>globalThis.DOMException===void 0?new Fb(r):new DOMException(r),cO=r=>{let e=r.reason===void 0?aO("This operation was aborted."):r.reason;return e instanceof Error?e:aO(e)};function $b(r,e){let{milliseconds:t,fallback:n,message:o,customTimers:i={setTimeout,clearTimeout}}=e,s,a,l=new Promise((f,u)=>{if(typeof t!="number"||Math.sign(t)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${t}\``);if(e.signal){let{signal:h}=e;h.aborted&&u(cO(h)),a=()=>{u(cO(h))},h.addEventListener("abort",a,{once:!0})}if(t===Number.POSITIVE_INFINITY){r.then(f,u);return}let d=new Ub;s=i.setTimeout.call(void 0,()=>{if(n){try{f(n())}catch(h){u(h)}return}typeof r.cancel=="function"&&r.cancel(),o===!1?f():o instanceof Error?u(o):(d.message=o??`Promise timed out after ${t} milliseconds`,u(d))},t),(async()=>{try{f(await r)}catch(h){u(h)}})()}).finally(()=>{l.clear(),a&&e.signal&&e.signal.removeEventListener("abort",a)});return l.clear=()=>{i.clearTimeout.call(void 0,s),s=void 0},l}var fq=r=>{let e=r.addEventListener||r.on||r.addListener,t=r.removeEventListener||r.off||r.removeListener;if(!e||!t)throw new TypeError("Emitter is not compatible");return{addListener:e.bind(r),removeListener:t.bind(r)}};function dq(r,e,t){let n,o=new Promise((i,s)=>{if(t={rejectionEvents:["error"],multiArgs:!1,rejectionMultiArgs:!1,resolveImmediately:!1,...t},!(t.count>=0&&(t.count===Number.POSITIVE_INFINITY||Number.isInteger(t.count))))throw new TypeError("The `count` option should be at least 0 or more");t.signal?.throwIfAborted();let a=[e].flat(),c=[],{addListener:l,removeListener:f}=fq(r),u=async(...h)=>{let m=t.multiArgs?h:h[0];if(t.filter)try{if(!await t.filter(m))return}catch(w){n(),s(w);return}c.push(m),t.count===c.length&&(n(),i(c))},d=(...h)=>{n(),s(t.rejectionMultiArgs?h:h[0])};n=()=>{for(let h of a)f(h,u);for(let h of t.rejectionEvents)a.includes(h)||f(h,d)};for(let h of a)l(h,u);for(let h of t.rejectionEvents)a.includes(h)||l(h,d);t.signal&&t.signal.addEventListener("abort",()=>{d(t.signal.reason)},{once:!0}),t.resolveImmediately&&i(c)});if(o.cancel=n,typeof t.timeout=="number"){let i=$b(o,{milliseconds:t.timeout});return i.cancel=()=>{n(),i.clear()},i}return o}function hs(r,e,t){typeof t=="function"&&(t={filter:t}),t={...t,count:1,resolveImmediately:!1};let n=dq(r,e,t),o=n.then(i=>i[0]);return o.cancel=n.cancel,o}var lO=function(r,e,t){if(t||arguments.length===2)for(var n=0,o=e.length,i;n<o;n++)(i||!(n in e))&&(i||(i=Array.prototype.slice.call(e,0,n)),i[n]=e[n]);return r.concat(i||Array.prototype.slice.call(e))},hq=(function(){function r(e,t,n){this.name=e,this.version=t,this.os=n,this.type="browser"}return r})();var pq=(function(){function r(e){this.version=e,this.type="node",this.name="node",this.os=process.platform}return r})();var mq=(function(){function r(e,t,n,o){this.name=e,this.version=t,this.os=n,this.bot=o,this.type="bot-device"}return r})();var gq=(function(){function r(){this.type="bot",this.bot=!0,this.name="bot",this.version=null,this.os=null}return r})();var yq=(function(){function r(){this.type="react-native",this.name="react-native",this.version=null,this.os=null}return r})();var wq=/alexa|bot|crawl(er|ing)|facebookexternalhit|feedburner|google web preview|nagios|postrank|pingdom|slurp|spider|yahoo!|yandex/,bq=/(nuhk|curl|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask\ Jeeves\/Teoma|ia_archiver)/,uO=3,vq=[["aol",/AOLShield\/([0-9\._]+)/],["edge",/Edge\/([0-9\._]+)/],["edge-ios",/EdgiOS\/([0-9\._]+)/],["yandexbrowser",/YaBrowser\/([0-9\._]+)/],["kakaotalk",/KAKAOTALK\s([0-9\.]+)/],["samsung",/SamsungBrowser\/([0-9\.]+)/],["silk",/\bSilk\/([0-9._-]+)\b/],["miui",/MiuiBrowser\/([0-9\.]+)$/],["beaker",/BeakerBrowser\/([0-9\.]+)/],["edge-chromium",/EdgA?\/([0-9\.]+)/],["chromium-webview",/(?!Chrom.*OPR)wv\).*Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["chrome",/(?!Chrom.*OPR)Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["phantomjs",/PhantomJS\/([0-9\.]+)(:?\s|$)/],["crios",/CriOS\/([0-9\.]+)(:?\s|$)/],["firefox",/Firefox\/([0-9\.]+)(?:\s|$)/],["fxios",/FxiOS\/([0-9\.]+)/],["opera-mini",/Opera Mini.*Version\/([0-9\.]+)/],["opera",/Opera\/([0-9\.]+)(?:\s|$)/],["opera",/OPR\/([0-9\.]+)(:?\s|$)/],["pie",/^Microsoft Pocket Internet Explorer\/(\d+\.\d+)$/],["pie",/^Mozilla\/\d\.\d+\s\(compatible;\s(?:MSP?IE|MSInternet Explorer) (\d+\.\d+);.*Windows CE.*\)$/],["netfront",/^Mozilla\/\d\.\d+.*NetFront\/(\d.\d)/],["ie",/Trident\/7\.0.*rv\:([0-9\.]+).*\).*Gecko$/],["ie",/MSIE\s([0-9\.]+);.*Trident\/[4-7].0/],["ie",/MSIE\s(7\.0)/],["bb10",/BB10;\sTouch.*Version\/([0-9\.]+)/],["android",/Android\s([0-9\.]+)/],["ios",/Version\/([0-9\._]+).*Mobile.*Safari.*/],["safari",/Version\/([0-9\._]+).*Safari/],["facebook",/FB[AS]V\/([0-9\.]+)/],["instagram",/Instagram\s([0-9\.]+)/],["ios-webview",/AppleWebKit\/([0-9\.]+).*Mobile/],["ios-webview",/AppleWebKit\/([0-9\.]+).*Gecko\)$/],["curl",/^curl\/([0-9\.]+)$/],["searchbot",wq]],fO=[["iOS",/iP(hone|od|ad)/],["Android OS",/Android/],["BlackBerry OS",/BlackBerry|BB10/],["Windows Mobile",/IEMobile/],["Amazon OS",/Kindle/],["Windows 3.11",/Win16/],["Windows 95",/(Windows 95)|(Win95)|(Windows_95)/],["Windows 98",/(Windows 98)|(Win98)/],["Windows 2000",/(Windows NT 5.0)|(Windows 2000)/],["Windows XP",/(Windows NT 5.1)|(Windows XP)/],["Windows Server 2003",/(Windows NT 5.2)/],["Windows Vista",/(Windows NT 6.0)/],["Windows 7",/(Windows NT 6.1)/],["Windows 8",/(Windows NT 6.2)/],["Windows 8.1",/(Windows NT 6.3)/],["Windows 10",/(Windows NT 10.0)/],["Windows ME",/Windows ME/],["Windows CE",/Windows CE|WinCE|Microsoft Pocket Internet Explorer/],["Open BSD",/OpenBSD/],["Sun OS",/SunOS/],["Chrome OS",/CrOS/],["Linux",/(Linux)|(X11)/],["Mac OS",/(Mac_PowerPC)|(Macintosh)/],["QNX",/QNX/],["BeOS",/BeOS/],["OS/2",/OS\/2/]];function hO(r){return r?dO(r):typeof document>"u"&&typeof navigator<"u"&&navigator.product==="ReactNative"?new yq:typeof navigator<"u"?dO(navigator.userAgent):Sq()}function xq(r){return r!==""&&vq.reduce(function(e,t){var n=t[0],o=t[1];if(e)return e;var i=o.exec(r);return!!i&&[n,i]},!1)}function dO(r){var e=xq(r);if(!e)return null;var t=e[0],n=e[1];if(t==="searchbot")return new gq;var o=n[1]&&n[1].split(".").join("_").split("_").slice(0,3);o?o.length<uO&&(o=lO(lO([],o,!0),_q(uO-o.length),!0)):o=[];var i=o.join("."),s=Eq(r),a=bq.exec(r);return a&&a[1]?new mq(t,i,s,a[1]):new hq(t,i,s)}function Eq(r){for(var e=0,t=fO.length;e<t;e++){var n=fO[e],o=n[0],i=n[1],s=i.exec(r);if(s)return o}return null}function Sq(){var r=typeof process<"u"&&process.version;return r?new pq(process.version.slice(1)):null}function _q(r){for(var e=[],t=0;t<r;t++)e.push("0");return e}var pO=hO(),j3=pO!=null&&pO.name==="firefox";async function jb(r){return r=r??{},typeof r=="function"&&(r=await r()),r.iceServers=r.iceServers??Jk.map(e=>({urls:[e]})),r}var mO=(r=32)=>eO+[...Array(r)].map(()=>Lb.at(Math.floor(Math.random()*Lb.length))).join("");var Kb=class extends Ws{channel;incomingData;maxBufferedAmount;receivedFinAck;finAckTimeout;constructor(e){super({...e,maxMessageSize:(e.maxMessageSize??yf)-rO}),this.channel=e.channel,this.channel.binaryType="arraybuffer",this.incomingData=gr(),this.maxBufferedAmount=e.maxBufferedAmount??tO,this.finAckTimeout=e.finAckTimeout??nO,this.channel.onclose=()=>{this.log.trace("received datachannel close event"),this.onRemoteCloseWrite(),this.onTransportClosed()},this.channel.onerror=n=>{let o=n.error;this.log.trace("received datachannel error event - %e",o),this.abort(o)},this.channel.onmessage=async n=>{this.log("incoming message %d bytes",n.data.byteLength);let{data:o}=n;o===null||o.byteLength===0||this.incomingData.push(new Uint8Array(o,0,o.byteLength))},this.channel.bufferedAmountLowThreshold=0,this.channel.onbufferedamountlow=()=>{this.writableNeedsDrain&&this.safeDispatchEvent("drain")},Promise.resolve().then(async()=>{for await(let n of Ec(this.incomingData))this.processIncomingProtobuf(n)}).catch(n=>{this.log.error("error processing incoming data channel messages - %e",n)});let t=()=>{this.channel.readyState==="open"&&(this.log.trace("stream closed, closing underlying datachannel"),this.channel.close())};this.addEventListener("close",t),this.channel.readyState!=="open"&&(this.log('channel ready state is "%s" and not "open", waiting for "open" event before sending data',this.channel.readyState),hs(this.channel,"open",{rejectionEvents:["close","error"]}).then(()=>{this.log('channel ready state is now "%s", dispatching drain',this.channel.readyState),this.safeDispatchEvent("drain")}).catch(n=>{this.abort(n.error??n)}))}sendNewStream(){}_sendMessage(e){if(this.channel.readyState!=="open")throw new Go(`Invalid datachannel state - ${this.channel.readyState}`);if(this.log.trace('sending message, channel state "%s"',this.channel.readyState),j3){this.channel.send(e.subarray());return}for(let t of e)this.channel.send(t)}sendData(e){return this.channel.readyState!=="open"?{sentBytes:0,canSendMore:!1}:(this._sendMessage(Gi.single(Vr.encode({message:e.subarray()}))),{sentBytes:e.byteLength,canSendMore:this.channel.bufferedAmount<this.maxBufferedAmount})}sendReset(e){try{this.log.error("sending reset - %e",e),this._sendFlag(Vr.Flag.RESET),this.receivedFinAck?.reject(e)}catch(t){this.log.error("failed to send reset - %e",t)}}async sendCloseWrite(e){this._sendFlag(Vr.Flag.FIN),e?.signal?.throwIfAborted(),this.receivedFinAck=Promise.withResolvers();let t=e?.signal??AbortSignal.timeout(this.finAckTimeout),n=[hs(this.channel,"close",{signal:t}),hs(this.channel,"error",{signal:t})];await Promise.any([ut(this.receivedFinAck.promise,t),...n]).finally(()=>{n.forEach(o=>o.cancel())})}async sendCloseRead(e){this._sendFlag(Vr.Flag.STOP_SENDING),e?.signal?.throwIfAborted()}processIncomingProtobuf(e){let t=Vr.decode(e);t.message!=null&&(this.readStatus==="readable"||this.readStatus==="paused")&&this.onData(new fe(t.message)),t.flag!==void 0&&(this.log.trace('incoming flag %s, write status "%s", read status "%s"',t.flag,this.writeStatus,this.readStatus),t.flag===Vr.Flag.FIN&&(this._sendFlag(Vr.Flag.FIN_ACK),this.onRemoteCloseWrite()),t.flag===Vr.Flag.RESET&&(this.receivedFinAck?.reject(new Bl("The stream was reset")),this.onRemoteReset()),t.flag===Vr.Flag.STOP_SENDING&&this.onRemoteCloseRead(),t.flag===Vr.Flag.FIN_ACK&&this.receivedFinAck?.resolve())}_sendFlag(e){if(this.channel.readyState!=="open")return this.log.trace('not sending flag %s because channel is "%s" and not "open"',e.toString(),this.channel.readyState),!1;this.log.trace("sending flag %s",e.toString());let t=Vr.encode({flag:e}),n=Gi.single(t);try{return this._sendMessage(n),!0}catch(o){this.log.error("could not send flag %s - %e",e.toString(),o)}return!1}sendPause(){}sendResume(){}};function Op(r){let{channel:e,direction:t,isHandshake:n}=r;return new Kb({...r,id:`${e.id}`,log:r.log.newScope(`${n===!0?"handshake":t}:${e.id}`),protocol:""})}var ma=class{protocol;peerConnection;metrics;dataChannelOptions;earlyDataChannels;constructor(e){this.onEarlyDataChannel=this.onEarlyDataChannel.bind(this),this.peerConnection=e.peerConnection,this.metrics=e.metrics,this.protocol=e.protocol??Bb,this.dataChannelOptions=e.dataChannelOptions??{},this.peerConnection.addEventListener("datachannel",this.onEarlyDataChannel),this.earlyDataChannels=[]}onEarlyDataChannel(e){this.earlyDataChannels.push(e.channel)}createStreamMuxer(e){return this.peerConnection.removeEventListener("datachannel",this.onEarlyDataChannel),new Vb(e,{peerConnection:this.peerConnection,dataChannelOptions:this.dataChannelOptions,metrics:this.metrics,protocol:this.protocol,earlyDataChannels:this.earlyDataChannels})}},Vb=class extends qs{peerConnection;dataChannelOptions;constructor(e,t){super(e,{...t,name:"muxer"}),this.peerConnection=t.peerConnection,this.protocol=t.protocol??Bb,this.dataChannelOptions=t.dataChannelOptions??{},this.peerConnection.ondatachannel=({channel:n})=>{this.onDataChannel(n)},queueMicrotask(()=>{if(this.status!=="open"){t.earlyDataChannels.forEach(n=>{n.close()});return}t.earlyDataChannels.forEach(n=>{this.onDataChannel(n)})})}onDataChannel(e){if(this.log("incoming datachannel with channel id %d, protocol %s and status %s",e.id,e.protocol,e.readyState),e.label==="init"){this.log.trace("closing init channel %d",e.id),e.close();return}let t=Op({...this.streamOptions,...this.dataChannelOptions,channel:e,direction:"inbound",log:this.log});this.onRemoteStream(t)}async onCreateStream(e){let t=this.peerConnection.createDataChannel("",{});return this.log("open channel %d for protocol %s",t.id,e?.protocol),Op({...e,...this.dataChannelOptions,channel:t,direction:"outbound",log:this.log})}onData(){}};var Hb=class extends Hs{peerConnection;constructor(e){super(e),this.peerConnection=e.peerConnection;let t=e.peerConnection.connectionState;this.peerConnection.onconnectionstatechange=()=>{this.log.trace("peer connection state change %s initial state %s",this.peerConnection.connectionState,t),(this.peerConnection.connectionState==="disconnected"||this.peerConnection.connectionState==="failed"||this.peerConnection.connectionState==="closed")&&(this.onTransportClosed(),this.peerConnection.close())}}sendData(e){return{sentBytes:e.byteLength,canSendMore:!0}}async sendClose(e){this.peerConnection.close(),e?.signal?.throwIfAborted()}sendReset(){this.peerConnection.close()}sendPause(){}sendResume(){}},Rp=r=>new Hb(r);var K3=globalThis.RTCPeerConnection,V3=globalThis.RTCSessionDescription,gO=globalThis.RTCIceCandidate;var ga=class extends Error{constructor(e){super(`WebRTC transport error: ${e}`),this.name="WebRTCTransportError"}},so=class extends ga{constructor(e="SDP handshake failed"){super(e),this.name="SDPHandshakeFailedError"}};var H3=class extends ga{constructor(e,t){super(`Invalid fingerprint "${e}" within ${t}`),this.name="WebRTC/InvalidFingerprintError"}};var q3=class extends ga{constructor(e){super(`A method (${e}) was called though it has been intentionally left unimplemented.`),this.name="WebRTC/UnimplementedError"}},W3=class extends ga{constructor(e){super(`unsupported hash algorithm code: ${e} please see the codes at https://github.com/multiformats/multicodec/blob/master/table.csv `),this.name="WebRTC/UnsupportedHashAlgorithmError"}};var gn;(function(r){let e;(function(o){o.SDP_OFFER="SDP_OFFER",o.SDP_ANSWER="SDP_ANSWER",o.ICE_CANDIDATE="ICE_CANDIDATE"})(e=r.Type||(r.Type={}));let t;(function(o){o[o.SDP_OFFER=0]="SDP_OFFER",o[o.SDP_ANSWER=1]="SDP_ANSWER",o[o.ICE_CANDIDATE=2]="ICE_CANDIDATE"})(t||(t={})),(function(o){o.codec=()=>kt(t)})(e=r.Type||(r.Type={}));let n;r.codec=()=>(n==null&&(n=Ie((o,i,s={})=>{s.lengthDelimited!==!1&&i.fork(),o.type!=null&&(i.uint32(8),r.Type.codec().encode(o.type,i)),o.data!=null&&(i.uint32(18),i.string(o.data)),s.lengthDelimited!==!1&&i.ldelim()},(o,i,s={})=>{let a={},c=i==null?o.len:o.pos+i;for(;o.pos<c;){let l=o.uint32();switch(l>>>3){case 1:{a.type=r.Type.codec().decode(o);break}case 2:{a.data=o.string();break}default:{o.skipType(l&7);break}}}return a})),n),r.encode=o=>Te(o,r.codec()),r.decode=(o,i)=>Ae(o,r.codec(),i)})(gn||(gn={}));var z3=async(r,e,t)=>{try{let n=Promise.withResolvers();for(Aq(r,n);;){let o=await Promise.race([n.promise,e.read({signal:t.signal})]);if(o==null){t.signal?.throwIfAborted();break}if(o.type!==gn.Type.ICE_CANDIDATE)throw new Be("ICE candidate message expected");let i=JSON.parse(o.data??"null");if(i===""||i===null){t.onProgress?.(new oe("webrtc:end-of-ice-candidates")),t.log.trace("end-of-candidates received");continue}let s=new gO(i);t.log.trace("%s received new ICE candidate %o",t.direction,i);try{t.onProgress?.(new oe("webrtc:add-ice-candidate",s.candidate)),await r.addIceCandidate(s)}catch(a){t.log.error("%s bad candidate received %o - %e",t.direction,i,a)}}}catch(n){if(t.log.error("%s error parsing ICE candidate - %e",t.direction,n),t.signal?.aborted===!0&&r.connectionState!=="connected")throw n}};function Aq(r,e){if(r.connectionState==="connected"){e.resolve();return}r.onconnectionstatechange=t=>{switch(r.connectionState){case"connected":e.resolve();break;case"failed":case"disconnected":case"closed":e.reject(new Ll(`RTCPeerConnection connection state became "${r.connectionState}"`));break;default:break}}}function G3(r){let e;for(let t of r.getComponents())t.name==="p2p"&&(e=yt(t.value??""));if(e==null)throw new Xo("Remote peerId must be present in multiaddr");return e}async function yO({rtcConfiguration:r,dataChannel:e,signal:t,metrics:n,multiaddr:o,connectionManager:i,transportManager:s,log:a,logger:c,onProgress:l}){let{circuitAddress:f,targetPeer:u}=wO(o);n?.dialerEvents.increment({open:!0}),a.trace("dialing circuit address: %a",f);let d=i.getConnections(u),h;d.length===0?(l?.(new oe("webrtc:dial-relay")),h=await s.dial(f,{signal:t,onProgress:l})):(l?.(new oe("webrtc:reuse-relay-connection")),h=d[0]),l?.(new oe("webrtc:open-signaling-stream"));let m=await h.newStream(kp,{signal:t,runOnLimitedConnection:!0}),w=bt(m).pb(gn),y=new K3(r);y.addEventListener("connectionstatechange",()=>{switch(y.connectionState){case"closed":y.close();break;default:break}});let b=new ma({peerConnection:y,dataChannelOptions:e});try{let N=y.createDataChannel("init");y.onicecandidate=({candidate:Z})=>{if(y.connectionState==="connected"){a.trace("ignore new ice candidate as peer connection is already connected");return}if(Z==null||Z?.candidate===""){a.trace("initiator detected end of ICE candidates");return}let se=JSON.stringify(Z?.toJSON()??null);a.trace("initiator sending ICE candidate %o",Z),w.write({type:gn.Type.ICE_CANDIDATE,data:se},{signal:t}).catch(C=>{a.error("error sending ICE candidate - %e",C)})},y.onicecandidateerror=Z=>{a.error("initiator ICE candidate error",Z)};let O=await y.createOffer().catch(Z=>{throw a.error("could not execute createOffer - %e",Z),new so("Failed to set createOffer")});a.trace("initiator send SDP offer %s",O.sdp),l?.(new oe("webrtc:send-sdp-offer")),await w.write({type:gn.Type.SDP_OFFER,data:O.sdp},{signal:t}),await y.setLocalDescription(O).catch(Z=>{throw a.error("could not execute setLocalDescription - %e",Z),new so("Failed to set localDescription")}),l?.(new oe("webrtc:read-sdp-answer")),a.trace("initiator read SDP answer");let V=await w.read({signal:t});if(V.type!==gn.Type.SDP_ANSWER)throw new so("Remote should send an SDP answer");a.trace("initiator received SDP answer %s",V.data);let Q=new V3({type:"answer",sdp:V.data});return await y.setRemoteDescription(Q).catch(Z=>{throw a.error("could not execute setRemoteDescription - %e",Z),new so("Failed to set remoteDescription")}),a.trace("initiator read candidates until connected"),l?.(new oe("webrtc:read-ice-candidates")),await z3(y,w,{direction:"initiator",signal:t,log:a,onProgress:l}),a.trace("initiator connected"),N.readyState!=="open"&&(a.trace("wait for init channel to open"),await hs(N,"open",{signal:t})),a.trace("closing init channel"),N.close(),a.trace("waiting for init channel to close"),await hs(N,"close",{signal:t}),l?.(new oe("webrtc:close-signaling-stream")),a.trace("closing signaling channel"),await m.close({signal:t}),a.trace("initiator connected to remote address %s",o),{remoteAddress:o,peerConnection:y,muxerFactory:b}}catch(N){throw a.error("outgoing signaling error - %e",N),y.close(),m.abort(N),N}finally{y.onicecandidate=null,y.onicecandidateerror=null}}var bO=ct(Uu.matchers[0],at(290)),X3=class r extends _e{transportManager;shutdownController;events;constructor(e,t){super(),this.transportManager=e.transportManager,this.events=e.events,this.shutdownController=t.shutdownController,this.onTransportListening=this.onTransportListening.bind(this)}async listen(){this.events.addEventListener("transport:listening",this.onTransportListening)}onTransportListening(e){e.detail.getAddrs().filter(n=>bO.exactMatch(n)).map(n=>n.encapsulate("/webrtc")).length>0&&this.safeDispatchEvent("listening")}getAddrs(){return this.transportManager.getListeners().filter(e=>!(e instanceof r)).map(e=>e.getAddrs().filter(t=>bO.exactMatch(t)).map(t=>t.encapsulate("/webrtc"))).flat()}updateAnnounceAddrs(){}async close(){this.events.removeEventListener("transport:listening",this.onTransportListening),this.shutdownController.abort(),queueMicrotask(()=>{this.safeDispatchEvent("close")})}};async function vO(r,e,{peerConnection:t,signal:n,log:o}){o.trace("new inbound signaling stream");let i=bt(r).pb(gn);try{t.onicecandidate=({candidate:u})=>{if(t.connectionState==="connected"){o.trace("ignore new ice candidate as peer connection is already connected");return}if(u==null||u?.candidate===""){o.trace("recipient detected end of ICE candidates");return}let d=JSON.stringify(u?.toJSON()??null);o.trace("recipient sending ICE candidate %s",d),i.write({type:gn.Type.ICE_CANDIDATE,data:d},{signal:n}).catch(h=>{o.error("error sending ICE candidate - %e",h)})},o.trace("recipient read SDP offer");let c=await i.read({signal:n});if(c.type!==gn.Type.SDP_OFFER)throw new so(`expected message type SDP_OFFER, received: ${c.type??"undefined"} `);o.trace("recipient received SDP offer %s",c.data);let l=new V3({type:"offer",sdp:c.data});await t.setRemoteDescription(l).catch(u=>{throw o.error("could not execute setRemoteDescription - %e",u),new so("Failed to set remoteDescription")});let f=await t.createAnswer().catch(u=>{throw o.error("could not execute createAnswer - %e",u),new so("Failed to create answer")});o.trace("recipient send SDP answer %s",f.sdp),await i.write({type:gn.Type.SDP_ANSWER,data:f.sdp},{signal:n}),await t.setLocalDescription(f).catch(u=>{throw o.error("could not execute setLocalDescription - %e",u),new so("Failed to set localDescription")}),o.trace("recipient read candidates until connected"),await z3(t,i,{direction:"recipient",signal:n,log:o})}catch(c){if(t.connectionState!=="connected")throw o.error("error while handling signaling stream from peer %a - %e",e.remoteAddr,c),t.close(),c;o("error while handling signaling stream from peer %a, ignoring as the RTCPeerConnection is already connected",e.remoteAddr,c)}let s=G3(e.remoteAddr),a=ie(`/webrtc/p2p/${s}`);return o.trace("recipient connected to remote address %s",a),{remoteAddress:a,remotePeer:s}}var Y3=class{components;init;log;_started=!1;metrics;shutdownController;constructor(e,t={}){this.components=e,this.init=t,this.log=e.logger.forComponent("libp2p:webrtc"),this.shutdownController=new AbortController,this.shutdownController.signal,e.metrics!=null&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_webrtc_dialer_events_total",{label:"event",help:"Total count of WebRTC dialer events by type"}),listenerEvents:e.metrics.registerCounterGroup("libp2p_webrtc_listener_events_total",{label:"event",help:"Total count of WebRTC listener events by type"})})}[Os]=!0;[Symbol.toStringTag]="@libp2p/webrtc";[qe]=["@libp2p/transport"];[An]=["@libp2p/identify","@libp2p/circuit-relay-v2-transport"];isStarted(){return this._started}async start(){await this.components.registrar.handle(kp,(e,t)=>{let n=this.components.upgrader.createInboundAbortSignal(this.shutdownController.signal);this._onProtocol(e,t,n).catch(o=>{this.log.error("failed to handle incoming connect from %p - %e",t.remotePeer,o)}).finally(()=>{n.clear()})},{runOnLimitedConnection:!0}),this._started=!0}async stop(){await this.components.registrar.unhandle(kp),this._started=!1}createListener(e){return new X3(this.components,{shutdownController:this.shutdownController})}listenFilter(e){return e.filter(Ah.exactMatch)}dialFilter(e){return this.listenFilter(e)}async dial(e,t){this.log.trace("dialing address: %a",e);let{remoteAddress:n,peerConnection:o,muxerFactory:i}=await yO({rtcConfiguration:await jb(this.init.rtcConfiguration),dataChannel:this.init.dataChannel,multiaddr:e,dataChannelOptions:this.init.dataChannel,signal:t.signal,connectionManager:this.components.connectionManager,transportManager:this.components.transportManager,log:this.log,logger:this.components.logger,onProgress:t.onProgress}),s=Rp({peerConnection:o,remoteAddr:n,metrics:this.metrics?.dialerEvents,direction:"outbound",log:this.components.logger.forComponent("libp2p:webrtc:connection")}),a=await t.upgrader.upgradeOutbound(s,{skipProtection:!0,skipEncryption:!0,remotePeer:G3(e),muxerFactory:i,onProgress:t.onProgress,signal:t.signal});return this._closeOnShutdown(o,s),a}async _onProtocol(e,t,n){let o=new K3(await jb(this.init.rtcConfiguration));o.addEventListener("connectionstatechange",()=>{switch(o.connectionState){case"closed":o.close();break;default:break}});let i=new ma({peerConnection:o,dataChannelOptions:this.init.dataChannel});try{let{remoteAddress:s,remotePeer:a}=await vO(e,t,{peerConnection:o,signal:n,log:this.log});await e.close({signal:n});let c=Rp({peerConnection:o,remoteAddr:s,metrics:this.metrics?.listenerEvents,direction:"inbound",log:this.components.logger.forComponent("libp2p:webrtc:connection")});await this.components.upgrader.upgradeInbound(c,{skipEncryption:!0,skipProtection:!0,remotePeer:a,muxerFactory:i,signal:n}),this._closeOnShutdown(o,c)}catch(s){throw this.log.error("incoming signaling error - %e",s),o.close(),e.abort(s),s}}_closeOnShutdown(e,t){let n=()=>{t.close().catch(o=>{this.log.error("could not close WebRTCMultiaddrConnection - %e",o)})};this.shutdownController.signal.addEventListener("abort",n),e.addEventListener("close",()=>{this.shutdownController.signal.removeEventListener("abort",n)})}};function wO(r){let e=r.getComponents().filter(({name:n})=>n==="p2p").map(({value:n})=>n).pop();if(e==null)throw new P("Destination peer id was missing");return{circuitAddress:ie(r.getComponents().filter(({name:n})=>n!=="webrtc")),targetPeer:yt(e)}}var x$e=nr(EO());var A;(function(r){r[r.Sequence=0]="Sequence",r[r.Set=1]="Set",r[r.Choice=2]="Choice"})(A||(A={}));var g;(function(r){r[r.Any=1]="Any",r[r.Boolean=2]="Boolean",r[r.OctetString=3]="OctetString",r[r.BitString=4]="BitString",r[r.Integer=5]="Integer",r[r.Enumerated=6]="Enumerated",r[r.ObjectIdentifier=7]="ObjectIdentifier",r[r.Utf8String=8]="Utf8String",r[r.BmpString=9]="BmpString",r[r.UniversalString=10]="UniversalString",r[r.NumericString=11]="NumericString",r[r.PrintableString=12]="PrintableString",r[r.TeletexString=13]="TeletexString",r[r.VideotexString=14]="VideotexString",r[r.IA5String=15]="IA5String",r[r.GraphicString=16]="GraphicString",r[r.VisibleString=17]="VisibleString",r[r.GeneralString=18]="GeneralString",r[r.CharacterString=19]="CharacterString",r[r.UTCTime=20]="UTCTime",r[r.GeneralizedTime=21]="GeneralizedTime",r[r.DATE=22]="DATE",r[r.TimeOfDay=23]="TimeOfDay",r[r.DateTime=24]="DateTime",r[r.Duration=25]="Duration",r[r.TIME=26]="TIME",r[r.Null=27]="Null"})(g||(g={}));var qb=nr(is()),wi=class{constructor(e,t=0){if(this.unusedBits=0,this.value=new ArrayBuffer(0),e)if(typeof e=="number")this.fromNumber(e);else if(qb.BufferSourceConverter.isBufferSource(e))this.unusedBits=t,this.value=qb.BufferSourceConverter.toArrayBuffer(e);else throw TypeError("Unsupported type of 'params' argument for BitString")}fromASN(e){if(!(e instanceof Mo))throw new TypeError("Argument 'asn' is not instance of ASN.1 BitString");return this.unusedBits=e.valueBlock.unusedBits,this.value=e.valueBlock.valueHex,this}toASN(){return new Mo({unusedBits:this.unusedBits,valueHex:this.value})}toSchema(e){return new Mo({name:e})}toNumber(){let e="",t=new Uint8Array(this.value);for(let n of t)e+=n.toString(2).padStart(8,"0");return e=e.split("").reverse().join(""),this.unusedBits&&(e=e.slice(this.unusedBits).padStart(this.unusedBits,"0")),parseInt(e,2)}fromNumber(e){let t=e.toString(2),n=t.length+7>>3;this.unusedBits=(n<<3)-t.length;let o=new Uint8Array(n);t=t.padStart(n<<3,"0").split("").reverse().join("");let i=0;for(;i<n;)o[i]=parseInt(t.slice(i<<3,(i<<3)+8),2),i++;this.value=o.buffer}};var Wb=nr(is()),xe=class{get byteLength(){return this.buffer.byteLength}get byteOffset(){return 0}constructor(e){typeof e=="number"?this.buffer=new ArrayBuffer(e):Wb.BufferSourceConverter.isBufferSource(e)?this.buffer=Wb.BufferSourceConverter.toArrayBuffer(e):Array.isArray(e)?this.buffer=new Uint8Array(e):this.buffer=new ArrayBuffer(0)}fromASN(e){if(!(e instanceof Kr))throw new TypeError("Argument 'asn' is not instance of ASN.1 OctetString");return this.buffer=e.valueBlock.valueHex,this}toASN(){return new Kr({valueHex:this.buffer})}toSchema(e){return new Kr({name:e})}};var Tq={fromASN:r=>r instanceof hn?null:r.valueBeforeDecodeView,toASN:r=>{if(r===null)return new hn;let e=$n(r);if(e.result.error)throw new Error(e.result.error);return e.result}},Iq={fromASN:r=>r.valueBlock.valueHexView.byteLength>=4?r.valueBlock.toString():r.valueBlock.valueDec,toASN:r=>new Un({value:+r})},Cq={fromASN:r=>r.valueBlock.valueDec,toASN:r=>new Lc({value:r})},Ue={fromASN:r=>r.valueBlock.valueHexView,toASN:r=>new Un({valueHex:r})};var Pq={fromASN:r=>r.valueBlock.valueHexView,toASN:r=>new Mo({valueHex:r})},kq={fromASN:r=>r.valueBlock.toString(),toASN:r=>new Fn({value:r})},Oq={fromASN:r=>r.valueBlock.value,toASN:r=>new Nc({value:r})},wf={fromASN:r=>r.valueBlock.valueHexView,toASN:r=>new Kr({valueHex:r})},SO={fromASN:r=>new xe(r.getValue()),toASN:r=>r.toASN()};function ao(r){return{fromASN:e=>e.valueBlock.value,toASN:e=>new r({value:e})}}var zb=ao(oo),Rq=ao(Bc),Dq=ao(Mc),Nq=ao(Uc),Lq=ao(Fc),Bq=ao($c),Mq=ao(jc),Uq=ao(Kc),Fq=ao(Vc),$q=ao(oa),jq=ao(Hc),Kq=ao(qc),Vq={fromASN:r=>r.toDate(),toASN:r=>new ia({valueDate:r})},Hq={fromASN:r=>r.toDate(),toASN:r=>new Wc({valueDate:r})},qq={fromASN:()=>null,toASN:()=>new hn};function ya(r){switch(r){case g.Any:return Tq;case g.BitString:return Pq;case g.BmpString:return Rq;case g.Boolean:return Oq;case g.CharacterString:return Kq;case g.Enumerated:return Cq;case g.GeneralString:return jq;case g.GeneralizedTime:return Hq;case g.GraphicString:return Fq;case g.IA5String:return Uq;case g.Integer:return Iq;case g.Null:return qq;case g.NumericString:return Nq;case g.ObjectIdentifier:return kq;case g.OctetString:return wf;case g.PrintableString:return Lq;case g.TeletexString:return Bq;case g.UTCTime:return Vq;case g.UniversalString:return Dq;case g.Utf8String:return zb;case g.VideotexString:return Mq;case g.VisibleString:return $q;default:return null}}function co(r){return typeof r=="function"&&r.prototype?r.prototype.toASN&&r.prototype.fromASN?!0:co(r.prototype):!!(r&&typeof r=="object"&&"toASN"in r&&"fromASN"in r)}function Xb(r){var e;if(r){let t=Object.getPrototypeOf(r);return((e=t?.prototype)===null||e===void 0?void 0:e.constructor)===Array?!0:Xb(t)}return!1}function _O(r,e){if(!(r&&e)||r.byteLength!==e.byteLength)return!1;let t=new Uint8Array(r),n=new Uint8Array(e);for(let o=0;o<r.byteLength;o++)if(t[o]!==n[o])return!1;return!0}var Q3=class{constructor(){this.items=new WeakMap}has(e){return this.items.has(e)}get(e,t=!1){let n=this.items.get(e);if(!n)throw new Error(`Cannot get schema for '${e.prototype.constructor.name}' target`);if(t&&!n.schema)throw new Error(`Schema '${e.prototype.constructor.name}' doesn't contain ASN.1 schema. Call 'AsnSchemaStorage.cache'.`);return n}cache(e){let t=this.get(e);t.schema||(t.schema=this.create(e,!0))}createDefault(e){let t={type:A.Sequence,items:{}},n=this.findParentSchema(e);return n&&(Object.assign(t,n),t.items=Object.assign({},t.items,n.items)),t}create(e,t){let n=this.items.get(e)||this.createDefault(e),o=[];for(let i in n.items){let s=n.items[i],a=t?i:"",c;if(typeof s.type=="number"){let f=g[s.type],u=io[f];if(!u)throw new Error(`Cannot get ASN1 class by name '${f}'`);c=new u({name:a})}else co(s.type)?c=new s.type().toSchema(a):s.optional?this.get(s.type).type===A.Choice?c=new ui({name:a}):(c=this.create(s.type,!1),c.name=a):c=new ui({name:a});let l=!!s.optional||s.defaultValue!==void 0;if(s.repeated){c.name="";let f=s.repeated==="set"?Jr:vt;c=new f({name:"",value:[new zc({name:a,value:c})]})}if(s.context!==null&&s.context!==void 0)if(s.implicit)if(typeof s.type=="number"||co(s.type)){let f=s.repeated?Yt:cs;o.push(new f({name:a,optional:l,idBlock:{tagClass:3,tagNumber:s.context}}))}else{this.cache(s.type);let f=!!s.repeated,u=f?c:this.get(s.type,!0).schema;u="valueBlock"in u?u.valueBlock.value:u.value,o.push(new Yt({name:f?"":a,optional:l,idBlock:{tagClass:3,tagNumber:s.context},value:u}))}else o.push(new Yt({optional:l,idBlock:{tagClass:3,tagNumber:s.context},value:[c]}));else c.optional=l,o.push(c)}switch(n.type){case A.Sequence:return new vt({value:o,name:""});case A.Set:return new Jr({value:o,name:""});case A.Choice:return new Yu({value:o,name:""});default:throw new Error("Unsupported ASN1 type in use")}}set(e,t){return this.items.set(e,t),this}findParentSchema(e){let t=Object.getPrototypeOf(e);return t?this.items.get(t)||this.findParentSchema(t):null}};var Qt=new Q3;var k=r=>e=>{let t;Qt.has(e)?t=Qt.get(e):(t=Qt.createDefault(e),Qt.set(e,t)),Object.assign(t,r)};var p=r=>(e,t)=>{let n;Qt.has(e.constructor)?n=Qt.get(e.constructor):(n=Qt.createDefault(e.constructor),Qt.set(e.constructor,n));let o=Object.assign({},r);if(typeof o.type=="number"&&!o.converter){let i=ya(r.type);if(!i)throw new Error(`Cannot get default converter for property '${t}' of ${e.constructor.name}`);o.converter=i}o.raw=r.raw,n.items[t]=o};var wa=class extends Error{constructor(){super(...arguments),this.schemas=[]}};var Dp=class{static parse(e,t){let n=$n(e);if(n.result.error)throw new Error(n.result.error);return this.fromASN(n.result,t)}static fromASN(e,t){try{if(co(t))return new t().fromASN(e);let n=Qt.get(t);Qt.cache(t);let o=n.schema,i=this.handleChoiceTypes(e,n,t,o);if(i?.result)return i.result;i?.targetSchema&&(o=i.targetSchema);let s=this.handleSequenceTypes(e,n,t,o),a=new t;return Xb(t)?this.handleArrayTypes(e,n,t):(this.processSchemaItems(n,s,a),a)}catch(n){throw n instanceof wa&&n.schemas.push(t.name),n}}static handleChoiceTypes(e,t,n,o){if(e.constructor===Yt&&t.type===A.Choice&&e.idBlock.tagClass===3)for(let i in t.items){let s=t.items[i];if(s.context===e.idBlock.tagNumber&&s.implicit&&typeof s.type=="function"&&Qt.has(s.type)){let a=Qt.get(s.type);if(a&&a.type===A.Sequence){let c=new vt;if("value"in e.valueBlock&&Array.isArray(e.valueBlock.value)&&"value"in c.valueBlock){c.valueBlock.value=e.valueBlock.value;let l=this.fromASN(c,s.type),f=new n;return f[i]=l,{result:f}}}}}else if(e.constructor===Yt&&t.type!==A.Choice){let i=new Yt({idBlock:{tagClass:3,tagNumber:e.idBlock.tagNumber},value:t.schema.valueBlock.value});for(let s in t.items)delete e[s];return{targetSchema:i}}return null}static handleSequenceTypes(e,t,n,o){if(t.type===A.Sequence){let i=ss({},e,o);if(!i.verified)throw new wa(`Data does not match to ${n.name} ASN1 schema.${i.result.error?` ${i.result.error}`:""}`);return i}else{let i=ss({},e,o);if(!i.verified)throw new wa(`Data does not match to ${n.name} ASN1 schema.${i.result.error?` ${i.result.error}`:""}`);return i}}static processRepeatedField(e,t,n){let o=e.slice(t);if(o.length===1&&o[0].constructor.name==="Sequence"){let i=o[0];i.valueBlock&&i.valueBlock.value&&Array.isArray(i.valueBlock.value)&&(o=i.valueBlock.value)}if(typeof n.type=="number"){let i=ya(n.type);if(!i)throw new Error(`No converter for ASN.1 type ${n.type}`);return o.filter(s=>s&&s.valueBlock).map(s=>{try{return i.fromASN(s)}catch{return}}).filter(s=>s!==void 0)}else return o.filter(i=>i&&i.valueBlock).map(i=>{try{return this.fromASN(i,n.type)}catch{return}}).filter(i=>i!==void 0)}static processPrimitiveField(e,t){let n=ya(t.type);if(!n)throw new Error(`No converter for ASN.1 type ${t.type}`);return n.fromASN(e)}static isOptionalChoiceField(e){return e.optional&&typeof e.type=="function"&&Qt.has(e.type)&&Qt.get(e.type).type===A.Choice}static processOptionalChoiceField(e,t){try{return{processed:!0,value:this.fromASN(e,t.type)}}catch(n){if(n instanceof wa&&/Wrong values for Choice type/.test(n.message))return{processed:!1};throw n}}static handleArrayTypes(e,t,n){if(!("value"in e.valueBlock&&Array.isArray(e.valueBlock.value)))throw new Error("Cannot get items from the ASN.1 parsed value. ASN.1 object is not constructed.");let o=t.itemType;if(typeof o=="number"){let i=ya(o);if(!i)throw new Error(`Cannot get default converter for array item of ${n.name} ASN1 schema`);return n.from(e.valueBlock.value,s=>i.fromASN(s))}else return n.from(e.valueBlock.value,i=>this.fromASN(i,o))}static processSchemaItems(e,t,n){for(let o in e.items){let i=t.result[o];if(!i)continue;let s=e.items[o],a=s.type,c;typeof a=="number"||co(a)?c=this.processPrimitiveSchemaItem(i,s,a):c=this.processComplexSchemaItem(i,s,a),c&&typeof c=="object"&&"value"in c&&"raw"in c?(n[o]=c.value,n[`${o}Raw`]=c.raw):n[o]=c}}static processPrimitiveSchemaItem(e,t,n){var o;let i=(o=t.converter)!==null&&o!==void 0?o:co(n)?new n:null;if(!i)throw new Error("Converter is empty");return t.repeated?this.processRepeatedPrimitiveItem(e,t,i):this.processSinglePrimitiveItem(e,t,n,i)}static processRepeatedPrimitiveItem(e,t,n){if(t.implicit){let o=t.repeated==="sequence"?vt:Jr,i=new o;i.valueBlock=e.valueBlock;let s=$n(i.toBER(!1));if(s.offset===-1)throw new Error(`Cannot parse the child item. ${s.result.error}`);if(!("value"in s.result.valueBlock&&Array.isArray(s.result.valueBlock.value)))throw new Error("Cannot get items from the ASN.1 parsed value. ASN.1 object is not constructed.");let a=s.result.valueBlock.value;return Array.from(a,c=>n.fromASN(c))}else return Array.from(e,o=>n.fromASN(o))}static processSinglePrimitiveItem(e,t,n,o){let i=e;if(t.implicit){let s;if(co(n))s=new n().toSchema("");else{let a=g[n],c=io[a];if(!c)throw new Error(`Cannot get '${a}' class from asn1js module`);s=new c}s.valueBlock=i.valueBlock,i=$n(s.toBER(!1)).result}return o.fromASN(i)}static processComplexSchemaItem(e,t,n){if(t.repeated){if(!Array.isArray(e))throw new Error("Cannot get list of items from the ASN.1 parsed value. ASN.1 value should be iterable.");return Array.from(e,o=>this.fromASN(o,n))}else{let o=this.handleImplicitTagging(e,t,n);if(this.isOptionalChoiceField(t))try{return this.fromASN(o,n)}catch(i){if(i instanceof wa&&/Wrong values for Choice type/.test(i.message))return;throw i}else{let i=this.fromASN(o,n);return t.raw?{value:i,raw:e.valueBeforeDecodeView}:i}}}static handleImplicitTagging(e,t,n){if(t.implicit&&typeof t.context=="number"){let o=Qt.get(n);if(o.type===A.Sequence){let i=new vt;if("value"in e.valueBlock&&Array.isArray(e.valueBlock.value)&&"value"in i.valueBlock)return i.valueBlock.value=e.valueBlock.value,i}else if(o.type===A.Set){let i=new Jr;if("value"in e.valueBlock&&Array.isArray(e.valueBlock.value)&&"value"in i.valueBlock)return i.valueBlock.value=e.valueBlock.value,i}}return e}};var Np=class r{static serialize(e){return e instanceof Xt?e.toBER(!1):this.toASN(e).toBER(!1)}static toASN(e){if(e&&typeof e=="object"&&co(e))return e.toASN();if(!(e&&typeof e=="object"))throw new TypeError("Parameter 1 should be type of Object.");let t=e.constructor,n=Qt.get(t);Qt.cache(t);let o=[];if(n.itemType){if(!Array.isArray(e))throw new TypeError("Parameter 1 should be type of Array.");if(typeof n.itemType=="number"){let s=ya(n.itemType);if(!s)throw new Error(`Cannot get default converter for array item of ${t.name} ASN1 schema`);o=e.map(a=>s.toASN(a))}else o=e.map(s=>this.toAsnItem({type:n.itemType},"[]",t,s))}else for(let s in n.items){let a=n.items[s],c=e[s];if(c===void 0||a.defaultValue===c||typeof a.defaultValue=="object"&&typeof c=="object"&&_O(this.serialize(a.defaultValue),this.serialize(c)))continue;let l=r.toAsnItem(a,s,t,c);if(typeof a.context=="number")if(a.implicit)if(!a.repeated&&(typeof a.type=="number"||co(a.type))){let f={};f.valueHex=l instanceof hn?l.valueBeforeDecodeView:l.valueBlock.toBER(),o.push(new cs({optional:a.optional,idBlock:{tagClass:3,tagNumber:a.context},...f}))}else o.push(new Yt({optional:a.optional,idBlock:{tagClass:3,tagNumber:a.context},value:l.valueBlock.value}));else o.push(new Yt({optional:a.optional,idBlock:{tagClass:3,tagNumber:a.context},value:[l]}));else a.repeated?o=o.concat(l):o.push(l)}let i;switch(n.type){case A.Sequence:i=new vt({value:o});break;case A.Set:i=new Jr({value:o});break;case A.Choice:if(!o[0])throw new Error(`Schema '${t.name}' has wrong data. Choice cannot be empty.`);i=o[0];break}return i}static toAsnItem(e,t,n,o){let i;if(typeof e.type=="number"){let s=e.converter;if(!s)throw new Error(`Property '${t}' doesn't have converter for type ${g[e.type]} in schema '${n.name}'`);if(e.repeated){if(!Array.isArray(o))throw new TypeError("Parameter 'objProp' should be type of Array.");let a=Array.from(o,l=>s.toASN(l)),c=e.repeated==="sequence"?vt:Jr;i=new c({value:a})}else i=s.toASN(o)}else if(e.repeated){if(!Array.isArray(o))throw new TypeError("Parameter 'objProp' should be type of Array.");let s=Array.from(o,c=>this.toASN(c)),a=e.repeated==="sequence"?vt:Jr;i=new a({value:s})}else i=this.toASN(o);return i}};var ve=class extends Array{constructor(e=[]){if(typeof e=="number")super(e);else{super();for(let t of e)this.push(t)}}};var Yb=nr(is());var ee=class r{static serialize(e){return Np.serialize(e)}static parse(e,t){return Dp.parse(e,t)}static toString(e){let t=Yb.BufferSourceConverter.isBufferSource(e)?Yb.BufferSourceConverter.toArrayBuffer(e):r.serialize(e),n=$n(t);if(n.offset===-1)throw new Error(`Cannot decode ASN.1 data. ${n.result.error}`);return n.result.toString()}};function E(r,e,t,n){var o=arguments.length,i=o<3?e:n===null?n=Object.getOwnPropertyDescriptor(e,t):n,s;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")i=Reflect.decorate(r,e,t,n);else for(var a=r.length-1;a>=0;a--)(s=r[a])&&(i=(o<3?s(i):o>3?s(e,t,i):s(e,t))||i);return o>3&&i&&Object.defineProperty(e,t,i),i}var AO=nr(is()),Lp=class{static isIPv4(e){return/^(\d{1,3}\.){3}\d{1,3}$/.test(e)}static parseIPv4(e){let t=e.split(".");if(t.length!==4)throw new Error("Invalid IPv4 address");return t.map(n=>{let o=parseInt(n,10);if(isNaN(o)||o<0||o>255)throw new Error("Invalid IPv4 address part");return o})}static parseIPv6(e){let n=this.expandIPv6(e).split(":");if(n.length!==8)throw new Error("Invalid IPv6 address");return n.reduce((o,i)=>{let s=parseInt(i,16);if(isNaN(s)||s<0||s>65535)throw new Error("Invalid IPv6 address part");return o.push(s>>8&255),o.push(s&255),o},[])}static expandIPv6(e){if(!e.includes("::"))return e;let t=e.split("::");if(t.length>2)throw new Error("Invalid IPv6 address");let n=t[0]?t[0].split(":"):[],o=t[1]?t[1].split(":"):[],i=8-(n.length+o.length);if(i<0)throw new Error("Invalid IPv6 address");return[...n,...Array(i).fill("0"),...o].join(":")}static formatIPv6(e){let t=[];for(let n=0;n<16;n+=2)t.push((e[n]<<8|e[n+1]).toString(16));return this.compressIPv6(t.join(":"))}static compressIPv6(e){let t=e.split(":"),n=-1,o=0,i=-1,s=0;for(let a=0;a<t.length;a++)t[a]==="0"?(i===-1&&(i=a),s++):(s>o&&(n=i,o=s),i=-1,s=0);if(s>o&&(n=i,o=s),o>1){let a=t.slice(0,n).join(":"),c=t.slice(n+o).join(":");return`${a}::${c}`}return e}static parseCIDR(e){let[t,n]=e.split("/"),o=parseInt(n,10);if(this.isIPv4(t)){if(o<0||o>32)throw new Error("Invalid IPv4 prefix length");return[this.parseIPv4(t),o]}else{if(o<0||o>128)throw new Error("Invalid IPv6 prefix length");return[this.parseIPv6(t),o]}}static decodeIP(e){if(e.length===64&&parseInt(e,16)===0)return"::/0";if(e.length!==16)return e;let t=parseInt(e.slice(8),16).toString(2).split("").reduce((o,i)=>o+ +i,0),n=e.slice(0,8).replace(/(.{2})/g,o=>`${parseInt(o,16)}.`);return n=n.slice(0,-1),`${n}/${t}`}static toString(e){let t=new Uint8Array(e);if(t.length===4)return Array.from(t).join(".");if(t.length===16)return this.formatIPv6(t);if(t.length===8||t.length===32){let n=t.length/2,o=t.slice(0,n),i=t.slice(n);if(t.every(c=>c===0))return t.length===8?"0.0.0.0/0":"::/0";let a=i.reduce((c,l)=>c+(l.toString(2).match(/1/g)||[]).length,0);return t.length===8?`${Array.from(o).join(".")}/${a}`:`${this.formatIPv6(o)}/${a}`}return this.decodeIP(AO.Convert.ToHex(e))}static fromString(e){if(e.includes("/")){let[n,o]=this.parseCIDR(e),i=new Uint8Array(n.length),s=o;for(let c=0;c<i.length;c++)s>=8?(i[c]=255,s-=8):s>0&&(i[c]=255<<8-s,s=0);let a=new Uint8Array(n.length*2);return a.set(n,0),a.set(i,n.length),a.buffer}let t=this.isIPv4(e)?this.parseIPv4(e):this.parseIPv6(e);return new Uint8Array(t).buffer}};var TO=nr(is()),Qb,Zb,Jb,Zt=class{constructor(e={}){Object.assign(this,e)}toString(){return this.bmpString||this.printableString||this.teletexString||this.universalString||this.utf8String||""}};E([p({type:g.TeletexString})],Zt.prototype,"teletexString",void 0);E([p({type:g.PrintableString})],Zt.prototype,"printableString",void 0);E([p({type:g.UniversalString})],Zt.prototype,"universalString",void 0);E([p({type:g.Utf8String})],Zt.prototype,"utf8String",void 0);E([p({type:g.BmpString})],Zt.prototype,"bmpString",void 0);Zt=E([k({type:A.Choice})],Zt);var bf=class extends Zt{constructor(e={}){super(e),Object.assign(this,e)}toString(){return this.ia5String||(this.anyValue?TO.Convert.ToHex(this.anyValue):super.toString())}};E([p({type:g.IA5String})],bf.prototype,"ia5String",void 0);E([p({type:g.Any})],bf.prototype,"anyValue",void 0);bf=E([k({type:A.Choice})],bf);var tl=class{constructor(e={}){this.type="",this.value=new bf,Object.assign(this,e)}};E([p({type:g.ObjectIdentifier})],tl.prototype,"type",void 0);E([p({type:bf})],tl.prototype,"value",void 0);var ba=Qb=class extends ve{constructor(e){super(e),Object.setPrototypeOf(this,Qb.prototype)}};ba=Qb=E([k({type:A.Set,itemType:tl})],ba);var e9=Zb=class extends ve{constructor(e){super(e),Object.setPrototypeOf(this,Zb.prototype)}};e9=Zb=E([k({type:A.Sequence,itemType:ba})],e9);var pt=Jb=class extends e9{constructor(e){super(e),Object.setPrototypeOf(this,Jb.prototype)}};pt=Jb=E([k({type:A.Sequence})],pt);var Wq={fromASN:r=>Lp.toString(wf.fromASN(r)),toASN:r=>wf.toASN(Lp.fromString(r))},va=class{constructor(e={}){this.typeId="",this.value=new ArrayBuffer(0),Object.assign(this,e)}};E([p({type:g.ObjectIdentifier})],va.prototype,"typeId",void 0);E([p({type:g.Any,context:0})],va.prototype,"value",void 0);var Bp=class{constructor(e={}){this.partyName=new Zt,Object.assign(this,e)}};E([p({type:Zt,optional:!0,context:0,implicit:!0})],Bp.prototype,"nameAssigner",void 0);E([p({type:Zt,context:1,implicit:!0})],Bp.prototype,"partyName",void 0);var Se=class{constructor(e={}){Object.assign(this,e)}};E([p({type:va,context:0,implicit:!0})],Se.prototype,"otherName",void 0);E([p({type:g.IA5String,context:1,implicit:!0})],Se.prototype,"rfc822Name",void 0);E([p({type:g.IA5String,context:2,implicit:!0})],Se.prototype,"dNSName",void 0);E([p({type:g.Any,context:3,implicit:!0})],Se.prototype,"x400Address",void 0);E([p({type:pt,context:4,implicit:!1})],Se.prototype,"directoryName",void 0);E([p({type:Bp,context:5})],Se.prototype,"ediPartyName",void 0);E([p({type:g.IA5String,context:6,implicit:!0})],Se.prototype,"uniformResourceIdentifier",void 0);E([p({type:g.OctetString,context:7,implicit:!0,converter:Wq})],Se.prototype,"iPAddress",void 0);E([p({type:g.ObjectIdentifier,context:8,implicit:!0})],Se.prototype,"registeredID",void 0);Se=E([k({type:A.Choice})],Se);var xa="1.3.6.1.5.5.7",Ea=`${xa}.1`,IO=`${xa}.2`,rl=`${xa}.3`,Z3=`${xa}.48`,ASe=`${IO}.1`,TSe=`${IO}.2`,t9=`${Z3}.1`,r9=`${Z3}.2`,n9=`${Z3}.3`,o9=`${Z3}.5`,Re="2.5.29";var i9,J3=`${Ea}.1`,ps=class{constructor(e={}){this.accessMethod="",this.accessLocation=new Se,Object.assign(this,e)}};E([p({type:g.ObjectIdentifier})],ps.prototype,"accessMethod",void 0);E([p({type:Se})],ps.prototype,"accessLocation",void 0);var nl=i9=class extends ve{constructor(e){super(e),Object.setPrototypeOf(this,i9.prototype)}};nl=i9=E([k({type:A.Sequence,itemType:ps})],nl);var e4=`${Re}.35`,ol=class extends xe{},bi=class{constructor(e={}){e&&Object.assign(this,e)}};E([p({type:ol,context:0,optional:!0,implicit:!0})],bi.prototype,"keyIdentifier",void 0);E([p({type:Se,context:1,optional:!0,implicit:!0,repeated:"sequence"})],bi.prototype,"authorityCertIssuer",void 0);E([p({type:g.Integer,context:2,optional:!0,implicit:!0,converter:Ue})],bi.prototype,"authorityCertSerialNumber",void 0);var t4=`${Re}.19`,il=class{constructor(e={}){this.cA=!1,Object.assign(this,e)}};E([p({type:g.Boolean,defaultValue:!1})],il.prototype,"cA",void 0);E([p({type:g.Integer,optional:!0})],il.prototype,"pathLenConstraint",void 0);var s9,Tt=s9=class extends ve{constructor(e){super(e),Object.setPrototypeOf(this,s9.prototype)}};Tt=s9=E([k({type:A.Sequence,itemType:Se})],Tt);var a9,zq=`${Re}.29`,CO=a9=class extends Tt{constructor(e){super(e),Object.setPrototypeOf(this,a9.prototype)}};CO=a9=E([k({type:A.Sequence})],CO);var c9,n4=`${Re}.32`,o_e=`${n4}.0`,ms=class{constructor(e={}){Object.assign(this,e)}toString(){return this.ia5String||this.visibleString||this.bmpString||this.utf8String||""}};E([p({type:g.IA5String})],ms.prototype,"ia5String",void 0);E([p({type:g.VisibleString})],ms.prototype,"visibleString",void 0);E([p({type:g.BmpString})],ms.prototype,"bmpString",void 0);E([p({type:g.Utf8String})],ms.prototype,"utf8String",void 0);ms=E([k({type:A.Choice})],ms);var Mp=class{constructor(e={}){this.organization=new ms,this.noticeNumbers=[],Object.assign(this,e)}};E([p({type:ms})],Mp.prototype,"organization",void 0);E([p({type:g.Integer,repeated:"sequence"})],Mp.prototype,"noticeNumbers",void 0);var Up=class{constructor(e={}){Object.assign(this,e)}};E([p({type:Mp,optional:!0})],Up.prototype,"noticeRef",void 0);E([p({type:ms,optional:!0})],Up.prototype,"explicitText",void 0);var r4=class{constructor(e={}){Object.assign(this,e)}};E([p({type:g.IA5String})],r4.prototype,"cPSuri",void 0);E([p({type:Up})],r4.prototype,"userNotice",void 0);r4=E([k({type:A.Choice})],r4);var Fp=class{constructor(e={}){this.policyQualifierId="",this.qualifier=new ArrayBuffer(0),Object.assign(this,e)}};E([p({type:g.ObjectIdentifier})],Fp.prototype,"policyQualifierId",void 0);E([p({type:g.Any})],Fp.prototype,"qualifier",void 0);var sl=class{constructor(e={}){this.policyIdentifier="",Object.assign(this,e)}};E([p({type:g.ObjectIdentifier})],sl.prototype,"policyIdentifier",void 0);E([p({type:Fp,repeated:"sequence",optional:!0})],sl.prototype,"policyQualifiers",void 0);var $p=c9=class extends ve{constructor(e){super(e),Object.setPrototypeOf(this,c9.prototype)}};$p=c9=E([k({type:A.Sequence,itemType:sl})],$p);var d_e=`${Re}.20`,jp=class{constructor(e=0){this.value=e}};E([p({type:g.Integer})],jp.prototype,"value",void 0);jp=E([k({type:A.Choice})],jp);var b_e=`${Re}.27`,PO=class extends jp{};PO=E([k({type:A.Choice})],PO);var l9,o4=`${Re}.31`,jo;(function(r){r[r.unused=1]="unused",r[r.keyCompromise=2]="keyCompromise",r[r.cACompromise=4]="cACompromise",r[r.affiliationChanged=8]="affiliationChanged",r[r.superseded=16]="superseded",r[r.cessationOfOperation=32]="cessationOfOperation",r[r.certificateHold=64]="certificateHold",r[r.privilegeWithdrawn=128]="privilegeWithdrawn",r[r.aACompromise=256]="aACompromise"})(jo||(jo={}));var Kp=class extends wi{toJSON(){let e=[],t=this.toNumber();return t&jo.aACompromise&&e.push("aACompromise"),t&jo.affiliationChanged&&e.push("affiliationChanged"),t&jo.cACompromise&&e.push("cACompromise"),t&jo.certificateHold&&e.push("certificateHold"),t&jo.cessationOfOperation&&e.push("cessationOfOperation"),t&jo.keyCompromise&&e.push("keyCompromise"),t&jo.privilegeWithdrawn&&e.push("privilegeWithdrawn"),t&jo.superseded&&e.push("superseded"),t&jo.unused&&e.push("unused"),e}toString(){return`[${this.toJSON().join(", ")}]`}},gs=class{constructor(e={}){Object.assign(this,e)}};E([p({type:Se,context:0,repeated:"sequence",implicit:!0})],gs.prototype,"fullName",void 0);E([p({type:ba,context:1,implicit:!0})],gs.prototype,"nameRelativeToCRLIssuer",void 0);gs=E([k({type:A.Choice})],gs);var vi=class{constructor(e={}){Object.assign(this,e)}};E([p({type:gs,context:0,optional:!0})],vi.prototype,"distributionPoint",void 0);E([p({type:Kp,context:1,optional:!0,implicit:!0})],vi.prototype,"reasons",void 0);E([p({type:Se,context:2,optional:!0,repeated:"sequence",implicit:!0})],vi.prototype,"cRLIssuer",void 0);var Sa=l9=class extends ve{constructor(e){super(e),Object.setPrototypeOf(this,l9.prototype)}};Sa=l9=E([k({type:A.Sequence,itemType:vi})],Sa);var u9,N_e=`${Re}.46`,kO=u9=class extends Sa{constructor(e){super(e),Object.setPrototypeOf(this,u9.prototype)}};kO=u9=E([k({type:A.Sequence,itemType:vi})],kO);var K_e=`${Re}.28`,Kn=class r{constructor(e={}){this.onlyContainsUserCerts=r.ONLY,this.onlyContainsCACerts=r.ONLY,this.indirectCRL=r.ONLY,this.onlyContainsAttributeCerts=r.ONLY,Object.assign(this,e)}};Kn.ONLY=!1;E([p({type:gs,context:0,optional:!0})],Kn.prototype,"distributionPoint",void 0);E([p({type:g.Boolean,context:1,defaultValue:Kn.ONLY,implicit:!0})],Kn.prototype,"onlyContainsUserCerts",void 0);E([p({type:g.Boolean,context:2,defaultValue:Kn.ONLY,implicit:!0})],Kn.prototype,"onlyContainsCACerts",void 0);E([p({type:Kp,context:3,optional:!0,implicit:!0})],Kn.prototype,"onlySomeReasons",void 0);E([p({type:g.Boolean,context:4,defaultValue:Kn.ONLY,implicit:!0})],Kn.prototype,"indirectCRL",void 0);E([p({type:g.Boolean,context:5,defaultValue:Kn.ONLY,implicit:!0})],Kn.prototype,"onlyContainsAttributeCerts",void 0);var OO=`${Re}.21`,Vp;(function(r){r[r.unspecified=0]="unspecified",r[r.keyCompromise=1]="keyCompromise",r[r.cACompromise=2]="cACompromise",r[r.affiliationChanged=3]="affiliationChanged",r[r.superseded=4]="superseded",r[r.cessationOfOperation=5]="cessationOfOperation",r[r.certificateHold=6]="certificateHold",r[r.removeFromCRL=8]="removeFromCRL",r[r.privilegeWithdrawn=9]="privilegeWithdrawn",r[r.aACompromise=10]="aACompromise"})(Vp||(Vp={}));var Hp=class{constructor(e=Vp.unspecified){this.reason=Vp.unspecified,this.reason=e}toJSON(){return Vp[this.reason]}toString(){return this.toJSON()}};E([p({type:g.Enumerated})],Hp.prototype,"reason",void 0);Hp=E([k({type:A.Choice})],Hp);var f9,i4=`${Re}.37`,qp=f9=class extends ve{constructor(e){super(e),Object.setPrototypeOf(this,f9.prototype)}};qp=f9=E([k({type:A.Sequence,itemType:g.ObjectIdentifier})],qp);var J_e=`${i4}.0`,RO=`${rl}.1`,DO=`${rl}.2`,NO=`${rl}.3`,LO=`${rl}.4`,BO=`${rl}.8`,MO=`${rl}.9`;var oAe=`${Re}.54`,d9=class{constructor(e=new ArrayBuffer(0)){this.value=e}};E([p({type:g.Integer,converter:Ue})],d9.prototype,"value",void 0);d9=E([k({type:A.Choice})],d9);var UO=`${Re}.24`,Wp=class{constructor(e){this.value=new Date,e&&(this.value=e)}};E([p({type:g.GeneralizedTime})],Wp.prototype,"value",void 0);Wp=E([k({type:A.Choice})],Wp);var h9,p9=`${Re}.18`,FO=h9=class extends Tt{constructor(e){super(e),Object.setPrototypeOf(this,h9.prototype)}};FO=h9=E([k({type:A.Sequence})],FO);var s4=`${Re}.15`,Ko;(function(r){r[r.digitalSignature=1]="digitalSignature",r[r.nonRepudiation=2]="nonRepudiation",r[r.keyEncipherment=4]="keyEncipherment",r[r.dataEncipherment=8]="dataEncipherment",r[r.keyAgreement=16]="keyAgreement",r[r.keyCertSign=32]="keyCertSign",r[r.cRLSign=64]="cRLSign",r[r.encipherOnly=128]="encipherOnly",r[r.decipherOnly=256]="decipherOnly"})(Ko||(Ko={}));var vf=class extends wi{toJSON(){let e=this.toNumber(),t=[];return e&Ko.cRLSign&&t.push("crlSign"),e&Ko.dataEncipherment&&t.push("dataEncipherment"),e&Ko.decipherOnly&&t.push("decipherOnly"),e&Ko.digitalSignature&&t.push("digitalSignature"),e&Ko.encipherOnly&&t.push("encipherOnly"),e&Ko.keyAgreement&&t.push("keyAgreement"),e&Ko.keyCertSign&&t.push("keyCertSign"),e&Ko.keyEncipherment&&t.push("keyEncipherment"),e&Ko.nonRepudiation&&t.push("nonRepudiation"),t}toString(){return`[${this.toJSON().join(", ")}]`}};var m9,AAe=`${Re}.30`,xf=class{constructor(e={}){this.base=new Se,this.minimum=0,Object.assign(this,e)}};E([p({type:Se})],xf.prototype,"base",void 0);E([p({type:g.Integer,context:0,defaultValue:0,implicit:!0})],xf.prototype,"minimum",void 0);E([p({type:g.Integer,context:1,optional:!0,implicit:!0})],xf.prototype,"maximum",void 0);var a4=m9=class extends ve{constructor(e){super(e),Object.setPrototypeOf(this,m9.prototype)}};a4=m9=E([k({type:A.Sequence,itemType:xf})],a4);var c4=class{constructor(e={}){Object.assign(this,e)}};E([p({type:a4,context:0,optional:!0,implicit:!0})],c4.prototype,"permittedSubtrees",void 0);E([p({type:a4,context:1,optional:!0,implicit:!0})],c4.prototype,"excludedSubtrees",void 0);var OAe=`${Re}.36`,l4=class{constructor(e={}){Object.assign(this,e)}};E([p({type:g.Integer,context:0,implicit:!0,optional:!0,converter:Ue})],l4.prototype,"requireExplicitPolicy",void 0);E([p({type:g.Integer,context:1,implicit:!0,optional:!0,converter:Ue})],l4.prototype,"inhibitPolicyMapping",void 0);var g9,BAe=`${Re}.33`,zp=class{constructor(e={}){this.issuerDomainPolicy="",this.subjectDomainPolicy="",Object.assign(this,e)}};E([p({type:g.ObjectIdentifier})],zp.prototype,"issuerDomainPolicy",void 0);E([p({type:g.ObjectIdentifier})],zp.prototype,"subjectDomainPolicy",void 0);var $O=g9=class extends ve{constructor(e){super(e),Object.setPrototypeOf(this,g9.prototype)}};$O=g9=E([k({type:A.Sequence,itemType:zp})],$O);var y9,w9=`${Re}.17`,u4=y9=class extends Tt{constructor(e){super(e),Object.setPrototypeOf(this,y9.prototype)}};u4=y9=E([k({type:A.Sequence})],u4);var Tr=class{constructor(e={}){this.type="",this.values=[],Object.assign(this,e)}};E([p({type:g.ObjectIdentifier})],Tr.prototype,"type",void 0);E([p({type:g.Any,repeated:"set"})],Tr.prototype,"values",void 0);var b9,ZAe=`${Re}.9`,jO=b9=class extends ve{constructor(e){super(e),Object.setPrototypeOf(this,b9.prototype)}};jO=b9=E([k({type:A.Sequence,itemType:Tr})],jO);var v9=`${Re}.14`,yn=class extends ol{};var aTe=`${Re}.16`,f4=class{constructor(e={}){Object.assign(this,e)}};E([p({type:g.GeneralizedTime,context:0,implicit:!0,optional:!0})],f4.prototype,"notBefore",void 0);E([p({type:g.GeneralizedTime,context:1,implicit:!0,optional:!0})],f4.prototype,"notAfter",void 0);var Gp;(function(r){r[r.keyUpdateAllowed=1]="keyUpdateAllowed",r[r.newExtensions=2]="newExtensions",r[r.pKIXCertificate=4]="pKIXCertificate"})(Gp||(Gp={}));var d4=class extends wi{toJSON(){let e=[],t=this.toNumber();return t&Gp.pKIXCertificate&&e.push("pKIXCertificate"),t&Gp.newExtensions&&e.push("newExtensions"),t&Gp.keyUpdateAllowed&&e.push("keyUpdateAllowed"),e}toString(){return`[${this.toJSON().join(", ")}]`}},h4=class{constructor(e={}){this.entrustVers="",this.entrustInfoFlags=new d4,Object.assign(this,e)}};E([p({type:g.GeneralString})],h4.prototype,"entrustVers",void 0);E([p({type:d4})],h4.prototype,"entrustInfoFlags",void 0);var x9,gTe=`${Ea}.11`,KO=x9=class extends ve{constructor(e){super(e),Object.setPrototypeOf(this,x9.prototype)}};KO=x9=E([k({type:A.Sequence,itemType:ps})],KO);var VO=nr(is()),X=class r{constructor(e={}){this.algorithm="",Object.assign(this,e)}isEqual(e){return e instanceof r&&e.algorithm==this.algorithm&&(e.parameters&&this.parameters&&VO.isEqual(e.parameters,this.parameters)||e.parameters===this.parameters)}};E([p({type:g.ObjectIdentifier})],X.prototype,"algorithm",void 0);E([p({type:g.Any,optional:!0})],X.prototype,"parameters",void 0);var Ir=class{constructor(e={}){this.algorithm=new X,this.subjectPublicKey=new ArrayBuffer(0),Object.assign(this,e)}};E([p({type:X})],Ir.prototype,"algorithm",void 0);E([p({type:g.BitString})],Ir.prototype,"subjectPublicKey",void 0);var Ut=class{constructor(e){if(e)if(typeof e=="string"||typeof e=="number"||e instanceof Date){let t=new Date(e);t.getUTCFullYear()>2049?this.generalTime=t:this.utcTime=t}else Object.assign(this,e)}getTime(){let e=this.utcTime||this.generalTime;if(!e)throw new Error("Cannot get time from CHOICE object");return e}};E([p({type:g.UTCTime})],Ut.prototype,"utcTime",void 0);E([p({type:g.GeneralizedTime})],Ut.prototype,"generalTime",void 0);Ut=E([k({type:A.Choice})],Ut);var ys=class{constructor(e){this.notBefore=new Ut(new Date),this.notAfter=new Ut(new Date),e&&(this.notBefore=new Ut(e.notBefore),this.notAfter=new Ut(e.notAfter))}};E([p({type:Ut})],ys.prototype,"notBefore",void 0);E([p({type:Ut})],ys.prototype,"notAfter",void 0);var E9,Cr=class r{constructor(e={}){this.extnID="",this.critical=r.CRITICAL,this.extnValue=new xe,Object.assign(this,e)}};Cr.CRITICAL=!1;E([p({type:g.ObjectIdentifier})],Cr.prototype,"extnID",void 0);E([p({type:g.Boolean,defaultValue:Cr.CRITICAL})],Cr.prototype,"critical",void 0);E([p({type:xe})],Cr.prototype,"extnValue",void 0);var Vn=E9=class extends ve{constructor(e){super(e),Object.setPrototypeOf(this,E9.prototype)}};Vn=E9=E([k({type:A.Sequence,itemType:Cr})],Vn);var xi;(function(r){r[r.v1=0]="v1",r[r.v2=1]="v2",r[r.v3=2]="v3"})(xi||(xi={}));var Pr=class{constructor(e={}){this.version=xi.v1,this.serialNumber=new ArrayBuffer(0),this.signature=new X,this.issuer=new pt,this.validity=new ys,this.subject=new pt,this.subjectPublicKeyInfo=new Ir,Object.assign(this,e)}};E([p({type:g.Integer,context:0,defaultValue:xi.v1})],Pr.prototype,"version",void 0);E([p({type:g.Integer,converter:Ue})],Pr.prototype,"serialNumber",void 0);E([p({type:X})],Pr.prototype,"signature",void 0);E([p({type:pt})],Pr.prototype,"issuer",void 0);E([p({type:ys})],Pr.prototype,"validity",void 0);E([p({type:pt})],Pr.prototype,"subject",void 0);E([p({type:Ir})],Pr.prototype,"subjectPublicKeyInfo",void 0);E([p({type:g.BitString,context:1,implicit:!0,optional:!0})],Pr.prototype,"issuerUniqueID",void 0);E([p({type:g.BitString,context:2,implicit:!0,optional:!0})],Pr.prototype,"subjectUniqueID",void 0);E([p({type:Vn,context:3,optional:!0})],Pr.prototype,"extensions",void 0);var lo=class{constructor(e={}){this.tbsCertificate=new Pr,this.signatureAlgorithm=new X,this.signatureValue=new ArrayBuffer(0),Object.assign(this,e)}};E([p({type:Pr,raw:!0})],lo.prototype,"tbsCertificate",void 0);E([p({type:X})],lo.prototype,"signatureAlgorithm",void 0);E([p({type:g.BitString})],lo.prototype,"signatureValue",void 0);var al=class{constructor(e={}){this.userCertificate=new ArrayBuffer(0),this.revocationDate=new Ut,Object.assign(this,e)}};E([p({type:g.Integer,converter:Ue})],al.prototype,"userCertificate",void 0);E([p({type:Ut})],al.prototype,"revocationDate",void 0);E([p({type:Cr,optional:!0,repeated:"sequence"})],al.prototype,"crlEntryExtensions",void 0);var Hn=class{constructor(e={}){this.signature=new X,this.issuer=new pt,this.thisUpdate=new Ut,Object.assign(this,e)}};E([p({type:g.Integer,optional:!0})],Hn.prototype,"version",void 0);E([p({type:X})],Hn.prototype,"signature",void 0);E([p({type:pt})],Hn.prototype,"issuer",void 0);E([p({type:Ut})],Hn.prototype,"thisUpdate",void 0);E([p({type:Ut,optional:!0})],Hn.prototype,"nextUpdate",void 0);E([p({type:al,repeated:"sequence",optional:!0})],Hn.prototype,"revokedCertificates",void 0);E([p({type:Cr,optional:!0,context:0,repeated:"sequence"})],Hn.prototype,"crlExtensions",void 0);var cl=class{constructor(e={}){this.tbsCertList=new Hn,this.signatureAlgorithm=new X,this.signature=new ArrayBuffer(0),Object.assign(this,e)}};E([p({type:Hn,raw:!0})],cl.prototype,"tbsCertList",void 0);E([p({type:X})],cl.prototype,"signatureAlgorithm",void 0);E([p({type:g.BitString})],cl.prototype,"signature",void 0);var Y=nr(is());function Xp(r,e,t,n){var o=arguments.length,i=o<3?e:n===null?n=Object.getOwnPropertyDescriptor(e,t):n,s;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")i=Reflect.decorate(r,e,t,n);else for(var a=r.length-1;a>=0;a--)(s=r[a])&&(i=(o<3?s(i):o>3?s(e,t,i):s(e,t))||i);return o>3&&i&&Object.defineProperty(e,t,i),i}function Ne(r,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(r):n?n.value:e.get(r)}function It(r,e,t,n,o){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!o)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!o:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?o.call(r,t):o?o.value=t:e.set(r,t),t}function L(r,e,t,n){var o=arguments.length,i=o<3?e:n===null?n=Object.getOwnPropertyDescriptor(e,t):n,s;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")i=Reflect.decorate(r,e,t,n);else for(var a=r.length-1;a>=0;a--)(s=r[a])&&(i=(o<3?s(i):o>3?s(e,t,i):s(e,t))||i);return o>3&&i&&Object.defineProperty(e,t,i),i}var Vo=class{constructor(e={}){this.issuer=new pt,this.serialNumber=new ArrayBuffer(0),Object.assign(this,e)}};L([p({type:pt})],Vo.prototype,"issuer",void 0);L([p({type:g.Integer,converter:Ue})],Vo.prototype,"serialNumber",void 0);var ll=class{constructor(e={}){Object.assign(this,e)}};L([p({type:yn,context:0,implicit:!0})],ll.prototype,"subjectKeyIdentifier",void 0);L([p({type:Vo})],ll.prototype,"issuerAndSerialNumber",void 0);ll=L([k({type:A.Choice})],ll);var kr;(function(r){r[r.v0=0]="v0",r[r.v1=1]="v1",r[r.v2=2]="v2",r[r.v3=3]="v3",r[r.v4=4]="v4",r[r.v5=5]="v5"})(kr||(kr={}));var ul=class extends X{};ul=L([k({type:A.Sequence})],ul);var Yp=class extends X{};Yp=L([k({type:A.Sequence})],Yp);var wn=class extends X{};wn=L([k({type:A.Sequence})],wn);var Qp=class extends X{};Qp=L([k({type:A.Sequence})],Qp);var qO=class extends X{};qO=L([k({type:A.Sequence})],qO);var p4=class extends X{};p4=L([k({type:A.Sequence})],p4);var Ho=class{constructor(e={}){this.attrType="",this.attrValues=[],Object.assign(this,e)}};L([p({type:g.ObjectIdentifier})],Ho.prototype,"attrType",void 0);L([p({type:g.Any,repeated:"set"})],Ho.prototype,"attrValues",void 0);var S9,bn=class{constructor(e={}){this.version=kr.v0,this.sid=new ll,this.digestAlgorithm=new ul,this.signatureAlgorithm=new Yp,this.signature=new xe,Object.assign(this,e)}};L([p({type:g.Integer})],bn.prototype,"version",void 0);L([p({type:ll})],bn.prototype,"sid",void 0);L([p({type:ul})],bn.prototype,"digestAlgorithm",void 0);L([p({type:Ho,repeated:"set",context:0,implicit:!0,optional:!0,raw:!0})],bn.prototype,"signedAttrs",void 0);L([p({type:Yp})],bn.prototype,"signatureAlgorithm",void 0);L([p({type:xe})],bn.prototype,"signature",void 0);L([p({type:Ho,repeated:"set",context:1,implicit:!0,optional:!0})],bn.prototype,"unsignedAttrs",void 0);var Zp=S9=class extends ve{constructor(e){super(e),Object.setPrototypeOf(this,S9.prototype)}};Zp=S9=L([k({type:A.Set,itemType:bn})],Zp);var WO=class extends bn{};WO=L([k({type:A.Sequence})],WO);var zO=class extends Ut{};zO=L([k({type:A.Choice})],zO);function re(r,e,t,n){var o=arguments.length,i=o<3?e:n===null?n=Object.getOwnPropertyDescriptor(e,t):n,s;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")i=Reflect.decorate(r,e,t,n);else for(var a=r.length-1;a>=0;a--)(s=r[a])&&(i=(o<3?s(i):o>3?s(e,t,i):s(e,t))||i);return o>3&&i&&Object.defineProperty(e,t,i),i}var Jp=class{constructor(e={}){this.acIssuer=new Se,this.acSerial=0,this.attrs=[],Object.assign(this,e)}};re([p({type:Se})],Jp.prototype,"acIssuer",void 0);re([p({type:g.Integer})],Jp.prototype,"acSerial",void 0);re([p({type:Tr,repeated:"sequence"})],Jp.prototype,"attrs",void 0);var _9,e1=_9=class extends ve{constructor(e){super(e),Object.setPrototypeOf(this,_9.prototype)}};e1=_9=re([k({type:A.Sequence,itemType:g.ObjectIdentifier})],e1);var Ef=class{constructor(e={}){this.permitUnSpecified=!0,Object.assign(this,e)}};re([p({type:g.Integer,optional:!0})],Ef.prototype,"pathLenConstraint",void 0);re([p({type:e1,implicit:!0,context:0,optional:!0})],Ef.prototype,"permittedAttrs",void 0);re([p({type:e1,implicit:!0,context:1,optional:!0})],Ef.prototype,"excludedAttrs",void 0);re([p({type:g.Boolean,defaultValue:!0})],Ef.prototype,"permitUnSpecified",void 0);var uo=class{constructor(e={}){this.issuer=new Tt,this.serial=new ArrayBuffer(0),this.issuerUID=new ArrayBuffer(0),Object.assign(this,e)}};re([p({type:Tt})],uo.prototype,"issuer",void 0);re([p({type:g.Integer,converter:Ue})],uo.prototype,"serial",void 0);re([p({type:g.BitString,optional:!0})],uo.prototype,"issuerUID",void 0);var A9;(function(r){r[r.publicKey=0]="publicKey",r[r.publicKeyCert=1]="publicKeyCert",r[r.otherObjectTypes=2]="otherObjectTypes"})(A9||(A9={}));var fo=class{constructor(e={}){this.digestedObjectType=A9.publicKey,this.digestAlgorithm=new X,this.objectDigest=new ArrayBuffer(0),Object.assign(this,e)}};re([p({type:g.Enumerated})],fo.prototype,"digestedObjectType",void 0);re([p({type:g.ObjectIdentifier,optional:!0})],fo.prototype,"otherObjectTypeID",void 0);re([p({type:X})],fo.prototype,"digestAlgorithm",void 0);re([p({type:g.BitString})],fo.prototype,"objectDigest",void 0);var fl=class{constructor(e={}){Object.assign(this,e)}};re([p({type:Tt,optional:!0})],fl.prototype,"issuerName",void 0);re([p({type:uo,context:0,implicit:!0,optional:!0})],fl.prototype,"baseCertificateID",void 0);re([p({type:fo,context:1,implicit:!0,optional:!0})],fl.prototype,"objectDigestInfo",void 0);var dl=class{constructor(e={}){Object.assign(this,e)}};re([p({type:Se,repeated:"sequence"})],dl.prototype,"v1Form",void 0);re([p({type:fl,context:0,implicit:!0})],dl.prototype,"v2Form",void 0);dl=re([k({type:A.Choice})],dl);var hl=class{constructor(e={}){this.notBeforeTime=new Date,this.notAfterTime=new Date,Object.assign(this,e)}};re([p({type:g.GeneralizedTime})],hl.prototype,"notBeforeTime",void 0);re([p({type:g.GeneralizedTime})],hl.prototype,"notAfterTime",void 0);var _a=class{constructor(e={}){Object.assign(this,e)}};re([p({type:uo,implicit:!0,context:0,optional:!0})],_a.prototype,"baseCertificateID",void 0);re([p({type:Tt,implicit:!0,context:1,optional:!0})],_a.prototype,"entityName",void 0);re([p({type:fo,implicit:!0,context:2,optional:!0})],_a.prototype,"objectDigestInfo",void 0);var T9;(function(r){r[r.v2=1]="v2"})(T9||(T9={}));var vn=class{constructor(e={}){this.version=T9.v2,this.holder=new _a,this.issuer=new dl,this.signature=new X,this.serialNumber=new ArrayBuffer(0),this.attrCertValidityPeriod=new hl,this.attributes=[],Object.assign(this,e)}};re([p({type:g.Integer})],vn.prototype,"version",void 0);re([p({type:_a})],vn.prototype,"holder",void 0);re([p({type:dl})],vn.prototype,"issuer",void 0);re([p({type:X})],vn.prototype,"signature",void 0);re([p({type:g.Integer,converter:Ue})],vn.prototype,"serialNumber",void 0);re([p({type:hl})],vn.prototype,"attrCertValidityPeriod",void 0);re([p({type:Tr,repeated:"sequence"})],vn.prototype,"attributes",void 0);re([p({type:g.BitString,optional:!0})],vn.prototype,"issuerUniqueID",void 0);re([p({type:Vn,optional:!0})],vn.prototype,"extensions",void 0);var pl=class{constructor(e={}){this.acinfo=new vn,this.signatureAlgorithm=new X,this.signatureValue=new ArrayBuffer(0),Object.assign(this,e)}};re([p({type:vn})],pl.prototype,"acinfo",void 0);re([p({type:X})],pl.prototype,"signatureAlgorithm",void 0);re([p({type:g.BitString})],pl.prototype,"signatureValue",void 0);var t1;(function(r){r[r.unmarked=1]="unmarked",r[r.unclassified=2]="unclassified",r[r.restricted=4]="restricted",r[r.confidential=8]="confidential",r[r.secret=16]="secret",r[r.topSecret=32]="topSecret"})(t1||(t1={}));var Sf=class extends wi{};var _f=class{constructor(e={}){this.type="",this.value=new ArrayBuffer(0),Object.assign(this,e)}};re([p({type:g.ObjectIdentifier,implicit:!0,context:0})],_f.prototype,"type",void 0);re([p({type:g.Any,implicit:!0,context:1})],_f.prototype,"value",void 0);var r1=class{constructor(e={}){this.policyId="",this.classList=new Sf(t1.unclassified),Object.assign(this,e)}};re([p({type:g.ObjectIdentifier})],r1.prototype,"policyId",void 0);re([p({type:Sf,defaultValue:new Sf(t1.unclassified)})],r1.prototype,"classList",void 0);re([p({type:_f,repeated:"set"})],r1.prototype,"securityCategories",void 0);var Af=class{constructor(e={}){Object.assign(this,e)}};re([p({type:xe})],Af.prototype,"cotets",void 0);re([p({type:g.ObjectIdentifier})],Af.prototype,"oid",void 0);re([p({type:g.Utf8String})],Af.prototype,"string",void 0);var m4=class{constructor(e={}){this.values=[],Object.assign(this,e)}};re([p({type:Tt,implicit:!0,context:0,optional:!0})],m4.prototype,"policyAuthority",void 0);re([p({type:Af,repeated:"sequence"})],m4.prototype,"values",void 0);var cke=`${Ea}.4`,lke=`${Ea}.6`,uke=`${Ea}.10`,fke=`${Re}.55`,n1=`${xa}.10`,dke=`${n1}.1`,hke=`${n1}.2`,pke=`${n1}.3`,mke=`${n1}.4`,gke=`${n1}.6`,I9="2.5.4",yke=`${I9}.72`;var C9,Tf=class{constructor(e={}){this.targetCertificate=new uo,Object.assign(this,e)}};re([p({type:uo})],Tf.prototype,"targetCertificate",void 0);re([p({type:Se,optional:!0})],Tf.prototype,"targetName",void 0);re([p({type:fo,optional:!0})],Tf.prototype,"certDigestInfo",void 0);var If=class{constructor(e={}){Object.assign(this,e)}};re([p({type:Se,context:0,implicit:!0})],If.prototype,"targetName",void 0);re([p({type:Se,context:1,implicit:!0})],If.prototype,"targetGroup",void 0);re([p({type:Tf,context:2,implicit:!0})],If.prototype,"targetCert",void 0);If=re([k({type:A.Choice})],If);var g4=C9=class extends ve{constructor(e){super(e),Object.setPrototypeOf(this,C9.prototype)}};g4=C9=re([k({type:A.Sequence,itemType:If})],g4);var P9,GO=P9=class extends ve{constructor(e){super(e),Object.setPrototypeOf(this,P9.prototype)}};GO=P9=re([k({type:A.Sequence,itemType:g4})],GO);var y4=class{constructor(e={}){Object.assign(this,e)}};re([p({type:Tt,implicit:!0,context:0,optional:!0})],y4.prototype,"roleAuthority",void 0);re([p({type:Se,implicit:!0,context:1})],y4.prototype,"roleName",void 0);var o1=class{constructor(e={}){this.service=new Se,this.ident=new Se,Object.assign(this,e)}};re([p({type:Se})],o1.prototype,"service",void 0);re([p({type:Se})],o1.prototype,"ident",void 0);re([p({type:xe,optional:!0})],o1.prototype,"authInfo",void 0);var k9,i1=class{constructor(e={}){this.otherCertFormat="",this.otherCert=new ArrayBuffer(0),Object.assign(this,e)}};L([p({type:g.ObjectIdentifier})],i1.prototype,"otherCertFormat",void 0);L([p({type:g.Any})],i1.prototype,"otherCert",void 0);var ml=class{constructor(e={}){Object.assign(this,e)}};L([p({type:lo})],ml.prototype,"certificate",void 0);L([p({type:pl,context:2,implicit:!0})],ml.prototype,"v2AttrCert",void 0);L([p({type:i1,context:3,implicit:!0})],ml.prototype,"other",void 0);ml=L([k({type:A.Choice})],ml);var gl=k9=class extends ve{constructor(e){super(e),Object.setPrototypeOf(this,k9.prototype)}};gl=k9=L([k({type:A.Set,itemType:ml})],gl);var ho=class{constructor(e={}){this.contentType="",this.content=new ArrayBuffer(0),Object.assign(this,e)}};L([p({type:g.ObjectIdentifier})],ho.prototype,"contentType",void 0);L([p({type:g.Any,context:0})],ho.prototype,"content",void 0);var Cf=class{constructor(e={}){Object.assign(this,e)}};L([p({type:xe})],Cf.prototype,"single",void 0);L([p({type:g.Any})],Cf.prototype,"any",void 0);Cf=L([k({type:A.Choice})],Cf);var yl=class{constructor(e={}){this.eContentType="",Object.assign(this,e)}};L([p({type:g.ObjectIdentifier})],yl.prototype,"eContentType",void 0);L([p({type:Cf,context:0,optional:!0})],yl.prototype,"eContent",void 0);var s1=class{constructor(e={}){Object.assign(this,e)}};L([p({type:xe,context:0,implicit:!0,optional:!0})],s1.prototype,"value",void 0);L([p({type:xe,converter:SO,context:0,implicit:!0,optional:!0,repeated:"sequence"})],s1.prototype,"constructedValue",void 0);s1=L([k({type:A.Choice})],s1);var Aa=class{constructor(e={}){this.contentType="",this.contentEncryptionAlgorithm=new Qp,Object.assign(this,e)}};L([p({type:g.ObjectIdentifier})],Aa.prototype,"contentType",void 0);L([p({type:Qp})],Aa.prototype,"contentEncryptionAlgorithm",void 0);L([p({type:s1,optional:!0})],Aa.prototype,"encryptedContent",void 0);var Ta=class{constructor(e={}){this.keyAttrId="",Object.assign(this,e)}};L([p({type:g.ObjectIdentifier})],Ta.prototype,"keyAttrId",void 0);L([p({type:g.Any,optional:!0})],Ta.prototype,"keyAttr",void 0);var O9,Pf=class{constructor(e={}){this.subjectKeyIdentifier=new yn,Object.assign(this,e)}};L([p({type:yn})],Pf.prototype,"subjectKeyIdentifier",void 0);L([p({type:g.GeneralizedTime,optional:!0})],Pf.prototype,"date",void 0);L([p({type:Ta,optional:!0})],Pf.prototype,"other",void 0);var kf=class{constructor(e={}){Object.assign(this,e)}};L([p({type:Pf,context:0,implicit:!0,optional:!0})],kf.prototype,"rKeyId",void 0);L([p({type:Vo,optional:!0})],kf.prototype,"issuerAndSerialNumber",void 0);kf=L([k({type:A.Choice})],kf);var a1=class{constructor(e={}){this.rid=new kf,this.encryptedKey=new xe,Object.assign(this,e)}};L([p({type:kf})],a1.prototype,"rid",void 0);L([p({type:xe})],a1.prototype,"encryptedKey",void 0);var w4=O9=class extends ve{constructor(e){super(e),Object.setPrototypeOf(this,O9.prototype)}};w4=O9=L([k({type:A.Sequence,itemType:a1})],w4);var c1=class{constructor(e={}){this.algorithm=new X,this.publicKey=new ArrayBuffer(0),Object.assign(this,e)}};L([p({type:X})],c1.prototype,"algorithm",void 0);L([p({type:g.BitString})],c1.prototype,"publicKey",void 0);var wl=class{constructor(e={}){Object.assign(this,e)}};L([p({type:yn,context:0,implicit:!0,optional:!0})],wl.prototype,"subjectKeyIdentifier",void 0);L([p({type:c1,context:1,implicit:!0,optional:!0})],wl.prototype,"originatorKey",void 0);L([p({type:Vo,optional:!0})],wl.prototype,"issuerAndSerialNumber",void 0);wl=L([k({type:A.Choice})],wl);var ws=class{constructor(e={}){this.version=kr.v3,this.originator=new wl,this.keyEncryptionAlgorithm=new wn,this.recipientEncryptedKeys=new w4,Object.assign(this,e)}};L([p({type:g.Integer})],ws.prototype,"version",void 0);L([p({type:wl,context:0})],ws.prototype,"originator",void 0);L([p({type:xe,context:1,optional:!0})],ws.prototype,"ukm",void 0);L([p({type:wn})],ws.prototype,"keyEncryptionAlgorithm",void 0);L([p({type:w4})],ws.prototype,"recipientEncryptedKeys",void 0);var Of=class{constructor(e={}){Object.assign(this,e)}};L([p({type:yn,context:0,implicit:!0})],Of.prototype,"subjectKeyIdentifier",void 0);L([p({type:Vo})],Of.prototype,"issuerAndSerialNumber",void 0);Of=L([k({type:A.Choice})],Of);var Ia=class{constructor(e={}){this.version=kr.v0,this.rid=new Of,this.keyEncryptionAlgorithm=new wn,this.encryptedKey=new xe,Object.assign(this,e)}};L([p({type:g.Integer})],Ia.prototype,"version",void 0);L([p({type:Of})],Ia.prototype,"rid",void 0);L([p({type:wn})],Ia.prototype,"keyEncryptionAlgorithm",void 0);L([p({type:xe})],Ia.prototype,"encryptedKey",void 0);var bl=class{constructor(e={}){this.keyIdentifier=new xe,Object.assign(this,e)}};L([p({type:xe})],bl.prototype,"keyIdentifier",void 0);L([p({type:g.GeneralizedTime,optional:!0})],bl.prototype,"date",void 0);L([p({type:Ta,optional:!0})],bl.prototype,"other",void 0);var Ca=class{constructor(e={}){this.version=kr.v4,this.kekid=new bl,this.keyEncryptionAlgorithm=new wn,this.encryptedKey=new xe,Object.assign(this,e)}};L([p({type:g.Integer})],Ca.prototype,"version",void 0);L([p({type:bl})],Ca.prototype,"kekid",void 0);L([p({type:wn})],Ca.prototype,"keyEncryptionAlgorithm",void 0);L([p({type:xe})],Ca.prototype,"encryptedKey",void 0);var Pa=class{constructor(e={}){this.version=kr.v0,this.keyEncryptionAlgorithm=new wn,this.encryptedKey=new xe,Object.assign(this,e)}};L([p({type:g.Integer})],Pa.prototype,"version",void 0);L([p({type:p4,context:0,optional:!0})],Pa.prototype,"keyDerivationAlgorithm",void 0);L([p({type:wn})],Pa.prototype,"keyEncryptionAlgorithm",void 0);L([p({type:xe})],Pa.prototype,"encryptedKey",void 0);var l1=class{constructor(e={}){this.oriType="",this.oriValue=new ArrayBuffer(0),Object.assign(this,e)}};L([p({type:g.ObjectIdentifier})],l1.prototype,"oriType",void 0);L([p({type:g.Any})],l1.prototype,"oriValue",void 0);var bs=class{constructor(e={}){Object.assign(this,e)}};L([p({type:Ia,optional:!0})],bs.prototype,"ktri",void 0);L([p({type:ws,context:1,implicit:!0,optional:!0})],bs.prototype,"kari",void 0);L([p({type:Ca,context:2,implicit:!0,optional:!0})],bs.prototype,"kekri",void 0);L([p({type:Pa,context:3,implicit:!0,optional:!0})],bs.prototype,"pwri",void 0);L([p({type:l1,context:4,implicit:!0,optional:!0})],bs.prototype,"ori",void 0);bs=L([k({type:A.Choice})],bs);var R9,u1=R9=class extends ve{constructor(e){super(e),Object.setPrototypeOf(this,R9.prototype)}};u1=R9=L([k({type:A.Set,itemType:bs})],u1);var D9,XO=`${xa}.16`,gRe=`${XO}.2`,yRe=`${XO}.4`,Rf=class{constructor(e={}){this.otherRevInfoFormat="",this.otherRevInfo=new ArrayBuffer(0),Object.assign(this,e)}};L([p({type:g.ObjectIdentifier})],Rf.prototype,"otherRevInfoFormat",void 0);L([p({type:g.Any})],Rf.prototype,"otherRevInfo",void 0);var b4=class{constructor(e={}){this.other=new Rf,Object.assign(this,e)}};L([p({type:Rf,context:1,implicit:!0})],b4.prototype,"other",void 0);b4=L([k({type:A.Choice})],b4);var Df=D9=class extends ve{constructor(e){super(e),Object.setPrototypeOf(this,D9.prototype)}};Df=D9=L([k({type:A.Set,itemType:b4})],Df);var Nf=class{constructor(e={}){Object.assign(this,e)}};L([p({type:gl,context:0,implicit:!0,optional:!0})],Nf.prototype,"certs",void 0);L([p({type:Df,context:1,implicit:!0,optional:!0})],Nf.prototype,"crls",void 0);var N9,L9=N9=class extends ve{constructor(e){super(e),Object.setPrototypeOf(this,N9.prototype)}};L9=N9=L([k({type:A.Set,itemType:Ho})],L9);var vl=class{constructor(e={}){this.version=kr.v0,this.recipientInfos=new u1,this.encryptedContentInfo=new Aa,Object.assign(this,e)}};L([p({type:g.Integer})],vl.prototype,"version",void 0);L([p({type:Nf,context:0,implicit:!0,optional:!0})],vl.prototype,"originatorInfo",void 0);L([p({type:u1})],vl.prototype,"recipientInfos",void 0);L([p({type:Aa})],vl.prototype,"encryptedContentInfo",void 0);L([p({type:L9,context:1,implicit:!0,optional:!0})],vl.prototype,"unprotectedAttrs",void 0);var YO="1.2.840.113549.1.7.2";var B9,v4=B9=class extends ve{constructor(e){super(e),Object.setPrototypeOf(this,B9.prototype)}};v4=B9=L([k({type:A.Set,itemType:ul})],v4);var vs=class{constructor(e={}){this.version=kr.v0,this.digestAlgorithms=new v4,this.encapContentInfo=new yl,this.signerInfos=new Zp,Object.assign(this,e)}};L([p({type:g.Integer})],vs.prototype,"version",void 0);L([p({type:v4})],vs.prototype,"digestAlgorithms",void 0);L([p({type:yl})],vs.prototype,"encapContentInfo",void 0);L([p({type:gl,context:0,implicit:!0,optional:!0})],vs.prototype,"certificates",void 0);L([p({type:Df,context:1,implicit:!0,optional:!0})],vs.prototype,"crls",void 0);L([p({type:Zp})],vs.prototype,"signerInfos",void 0);var xl="1.2.840.10045.2.1";var f1="1.2.840.10045.4.1",x4="1.2.840.10045.4.3.1",d1="1.2.840.10045.4.3.2",h1="1.2.840.10045.4.3.3",p1="1.2.840.10045.4.3.4";var M9="1.2.840.10045.3.1.7";var U9="1.3.132.0.34";var F9="1.3.132.0.35";function m1(r){return new X({algorithm:r})}var ZO=m1(f1),hDe=m1(x4),JO=m1(d1),eR=m1(h1),tR=m1(p1);function mt(r,e,t,n){var o=arguments.length,i=o<3?e:n===null?n=Object.getOwnPropertyDescriptor(e,t):n,s;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")i=Reflect.decorate(r,e,t,n);else for(var a=r.length-1;a>=0;a--)(s=r[a])&&(i=(o<3?s(i):o>3?s(e,t,i):s(e,t))||i);return o>3&&i&&Object.defineProperty(e,t,i),i}var g1=class{constructor(e={}){Object.assign(this,e)}};mt([p({type:g.ObjectIdentifier})],g1.prototype,"fieldType",void 0);mt([p({type:g.Any})],g1.prototype,"parameters",void 0);g1=mt([k({type:A.Sequence})],g1);var $9=class extends xe{};var Lf=class{constructor(e={}){Object.assign(this,e)}};mt([p({type:g.OctetString})],Lf.prototype,"a",void 0);mt([p({type:g.OctetString})],Lf.prototype,"b",void 0);mt([p({type:g.BitString,optional:!0})],Lf.prototype,"seed",void 0);Lf=mt([k({type:A.Sequence})],Lf);var j9;(function(r){r[r.ecpVer1=1]="ecpVer1"})(j9||(j9={}));var Ei=class{constructor(e={}){this.version=j9.ecpVer1,Object.assign(this,e)}};mt([p({type:g.Integer})],Ei.prototype,"version",void 0);mt([p({type:g1})],Ei.prototype,"fieldID",void 0);mt([p({type:Lf})],Ei.prototype,"curve",void 0);mt([p({type:$9})],Ei.prototype,"base",void 0);mt([p({type:g.Integer,converter:Ue})],Ei.prototype,"order",void 0);mt([p({type:g.Integer,optional:!0})],Ei.prototype,"cofactor",void 0);Ei=mt([k({type:A.Sequence})],Ei);var Si=class{constructor(e={}){Object.assign(this,e)}};mt([p({type:g.ObjectIdentifier})],Si.prototype,"namedCurve",void 0);mt([p({type:g.Null})],Si.prototype,"implicitCurve",void 0);mt([p({type:Ei})],Si.prototype,"specifiedCurve",void 0);Si=mt([k({type:A.Choice})],Si);var Bf=class{constructor(e={}){this.version=1,this.privateKey=new xe,Object.assign(this,e)}};mt([p({type:g.Integer})],Bf.prototype,"version",void 0);mt([p({type:xe})],Bf.prototype,"privateKey",void 0);mt([p({type:Si,context:0,optional:!0})],Bf.prototype,"parameters",void 0);mt([p({type:g.BitString,context:1,optional:!0})],Bf.prototype,"publicKey",void 0);var El=class{constructor(e={}){this.r=new ArrayBuffer(0),this.s=new ArrayBuffer(0),Object.assign(this,e)}};mt([p({type:g.Integer,converter:Ue})],El.prototype,"r",void 0);mt([p({type:g.Integer,converter:Ue})],El.prototype,"s",void 0);function nt(r,e,t,n){var o=arguments.length,i=o<3?e:n===null?n=Object.getOwnPropertyDescriptor(e,t):n,s;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")i=Reflect.decorate(r,e,t,n);else for(var a=r.length-1;a>=0;a--)(s=r[a])&&(i=(o<3?s(i):o>3?s(e,t,i):s(e,t))||i);return o>3&&i&&Object.defineProperty(e,t,i),i}var xn="1.2.840.113549.1.1",_i=`${xn}.1`,rR=`${xn}.7`,nR=`${xn}.9`,ka=`${xn}.10`,oR=`${xn}.2`,iR=`${xn}.4`,Mf=`${xn}.5`,sR=`${xn}.14`;var E4=`${xn}.11`,Uf=`${xn}.12`,Ff=`${xn}.13`,K9=`${xn}.15`,V9=`${xn}.16`,Sl="1.3.14.3.2.26",S4="2.16.840.1.101.3.4.2.4",_l="2.16.840.1.101.3.4.2.1",Al="2.16.840.1.101.3.4.2.2",Tl="2.16.840.1.101.3.4.2.3",aR="2.16.840.1.101.3.4.2.5",cR="2.16.840.1.101.3.4.2.6",lR="1.2.840.113549.2.2",uR="1.2.840.113549.2.5",Oa=`${xn}.8`;function rr(r){return new X({algorithm:r,parameters:null})}var VDe=rr(lR),HDe=rr(uR),xs=rr(Sl),qDe=rr(S4),WDe=rr(_l),zDe=rr(Al),GDe=rr(Tl),XDe=rr(aR),YDe=rr(cR),_4=new X({algorithm:Oa,parameters:ee.serialize(xs)}),H9=new X({algorithm:nR,parameters:ee.serialize(wf.toASN(new Uint8Array([218,57,163,238,94,107,75,13,50,85,191,239,149,96,24,144,175,216,7,9]).buffer))}),QDe=rr(_i),ZDe=rr(oR),JDe=rr(iR),eNe=rr(Mf),tNe=rr(K9),rNe=rr(V9),nNe=rr(Uf),oNe=rr(Ff),iNe=rr(K9),sNe=rr(V9);var $f=class{constructor(e={}){this.hashAlgorithm=new X(xs),this.maskGenAlgorithm=new X({algorithm:Oa,parameters:ee.serialize(xs)}),this.pSourceAlgorithm=new X(H9),Object.assign(this,e)}};nt([p({type:X,context:0,defaultValue:xs})],$f.prototype,"hashAlgorithm",void 0);nt([p({type:X,context:1,defaultValue:_4})],$f.prototype,"maskGenAlgorithm",void 0);nt([p({type:X,context:2,defaultValue:H9})],$f.prototype,"pSourceAlgorithm",void 0);var hNe=new X({algorithm:rR,parameters:ee.serialize(new $f)});var Ai=class{constructor(e={}){this.hashAlgorithm=new X(xs),this.maskGenAlgorithm=new X({algorithm:Oa,parameters:ee.serialize(xs)}),this.saltLength=20,this.trailerField=1,Object.assign(this,e)}};nt([p({type:X,context:0,defaultValue:xs})],Ai.prototype,"hashAlgorithm",void 0);nt([p({type:X,context:1,defaultValue:_4})],Ai.prototype,"maskGenAlgorithm",void 0);nt([p({type:g.Integer,context:2,defaultValue:20})],Ai.prototype,"saltLength",void 0);nt([p({type:g.Integer,context:3,defaultValue:1})],Ai.prototype,"trailerField",void 0);var vNe=new X({algorithm:ka,parameters:ee.serialize(new Ai)});var Il=class{constructor(e={}){this.digestAlgorithm=new X,this.digest=new xe,Object.assign(this,e)}};nt([p({type:X})],Il.prototype,"digestAlgorithm",void 0);nt([p({type:xe})],Il.prototype,"digest",void 0);var q9,jf=class{constructor(e={}){this.prime=new ArrayBuffer(0),this.exponent=new ArrayBuffer(0),this.coefficient=new ArrayBuffer(0),Object.assign(this,e)}};nt([p({type:g.Integer,converter:Ue})],jf.prototype,"prime",void 0);nt([p({type:g.Integer,converter:Ue})],jf.prototype,"exponent",void 0);nt([p({type:g.Integer,converter:Ue})],jf.prototype,"coefficient",void 0);var A4=q9=class extends ve{constructor(e){super(e),Object.setPrototypeOf(this,q9.prototype)}};A4=q9=nt([k({type:A.Sequence,itemType:jf})],A4);var po=class{constructor(e={}){this.version=0,this.modulus=new ArrayBuffer(0),this.publicExponent=new ArrayBuffer(0),this.privateExponent=new ArrayBuffer(0),this.prime1=new ArrayBuffer(0),this.prime2=new ArrayBuffer(0),this.exponent1=new ArrayBuffer(0),this.exponent2=new ArrayBuffer(0),this.coefficient=new ArrayBuffer(0),Object.assign(this,e)}};nt([p({type:g.Integer})],po.prototype,"version",void 0);nt([p({type:g.Integer,converter:Ue})],po.prototype,"modulus",void 0);nt([p({type:g.Integer,converter:Ue})],po.prototype,"publicExponent",void 0);nt([p({type:g.Integer,converter:Ue})],po.prototype,"privateExponent",void 0);nt([p({type:g.Integer,converter:Ue})],po.prototype,"prime1",void 0);nt([p({type:g.Integer,converter:Ue})],po.prototype,"prime2",void 0);nt([p({type:g.Integer,converter:Ue})],po.prototype,"exponent1",void 0);nt([p({type:g.Integer,converter:Ue})],po.prototype,"exponent2",void 0);nt([p({type:g.Integer,converter:Ue})],po.prototype,"coefficient",void 0);nt([p({type:A4,optional:!0})],po.prototype,"otherPrimeInfos",void 0);var Kf=class{constructor(e={}){this.modulus=new ArrayBuffer(0),this.publicExponent=new ArrayBuffer(0),Object.assign(this,e)}};nt([p({type:g.Integer,converter:Ue})],Kf.prototype,"modulus",void 0);nt([p({type:g.Integer,converter:Ue})],Kf.prototype,"publicExponent",void 0);var W9;(function(r){r[r.Transient=0]="Transient",r[r.Singleton=1]="Singleton",r[r.ResolutionScoped=2]="ResolutionScoped",r[r.ContainerScoped=3]="ContainerScoped"})(W9||(W9={}));var Or=W9;var RR=nr(OR(),1),{__extends:Hf,__assign:QNe,__rest:Jq,__decorate:ZNe,__param:JNe,__metadata:eLe,__awaiter:DR,__generator:NR,__exportStar:tLe,__createBinding:rLe,__values:y1,__read:w1,__spread:qo,__spreadArrays:nLe,__await:oLe,__asyncGenerator:iLe,__asyncDelegator:sLe,__asyncValues:aLe,__makeTemplateObject:cLe,__importStar:lLe,__importDefault:uLe,__classPrivateFieldGet:fLe,__classPrivateFieldSet:dLe}=RR.default;var eW="injectionTokens";function G9(r){var e=Reflect.getMetadata("design:paramtypes",r)||[],t=Reflect.getOwnMetadata(eW,r)||{};return Object.keys(t).forEach(function(n){e[+n]=t[n]}),e}function b1(r){return!!r.useClass}function qf(r){return!!r.useFactory}var C4=(function(){function r(e){this.wrap=e,this.reflectMethods=["get","getPrototypeOf","setPrototypeOf","getOwnPropertyDescriptor","defineProperty","has","set","deleteProperty","apply","construct","ownKeys"]}return r.prototype.createProxy=function(e){var t=this,n={},o=!1,i,s=function(){return o||(i=e(t.wrap()),o=!0),i};return new Proxy(n,this.createHandler(s))},r.prototype.createHandler=function(e){var t={},n=function(o){t[o]=function(){for(var i=[],s=0;s<arguments.length;s++)i[s]=arguments[s];i[0]=e();var a=Reflect[o];return a.apply(void 0,qo(i))}};return this.reflectMethods.forEach(n),t},r})();function Ra(r){return typeof r=="string"||typeof r=="symbol"}function X9(r){return typeof r=="object"&&"token"in r&&"multiple"in r}function P4(r){return typeof r=="object"&&"token"in r&&"transform"in r}function LR(r){return typeof r=="function"||r instanceof C4}function Cl(r){return!!r.useToken}function Pl(r){return r.useValue!=null}function BR(r){return b1(r)||Pl(r)||Cl(r)||qf(r)}var tW=(function(){function r(){this._registryMap=new Map}return r.prototype.entries=function(){return this._registryMap.entries()},r.prototype.getAll=function(e){return this.ensure(e),this._registryMap.get(e)},r.prototype.get=function(e){this.ensure(e);var t=this._registryMap.get(e);return t[t.length-1]||null},r.prototype.set=function(e,t){this.ensure(e),this._registryMap.get(e).push(t)},r.prototype.setAll=function(e,t){this._registryMap.set(e,t)},r.prototype.has=function(e){return this.ensure(e),this._registryMap.get(e).length>0},r.prototype.clear=function(){this._registryMap.clear()},r.prototype.ensure=function(e){this._registryMap.has(e)||this._registryMap.set(e,[])},r})(),v1=tW;var rW=(function(r){Hf(e,r);function e(){return r!==null&&r.apply(this,arguments)||this}return e})(v1),MR=rW;var nW=(function(){function r(){this.scopedResolutions=new Map}return r})(),x1=nW;function oW(r,e){if(r===null)return"at position #"+e;var t=r.split(",")[e].trim();return'"'+t+'" at position #'+e}function iW(r,e,t){return t===void 0&&(t="    "),qo([r],e.message.split(`
`).map(function(n){return t+n})).join(`
`)}function Y9(r,e,t){var n=w1(r.toString().match(/constructor\(([\w, ]+)\)/)||[],2),o=n[1],i=o===void 0?null:o,s=oW(i,e);return iW("Cannot inject the dependency "+s+' of "'+r.name+'" constructor. Reason:',t)}function UR(r){if(typeof r.dispose!="function")return!1;var e=r.dispose;return!(e.length>0)}var sW=(function(r){Hf(e,r);function e(){return r!==null&&r.apply(this,arguments)||this}return e})(v1);var aW=(function(r){Hf(e,r);function e(){return r!==null&&r.apply(this,arguments)||this}return e})(v1);var cW=(function(){function r(){this.preResolution=new sW,this.postResolution=new aW}return r})(),FR=cW;var Q9=new Map,lW=(function(){function r(e){this.parent=e,this._registry=new MR,this.interceptors=new FR,this.disposed=!1,this.disposables=new Set}return r.prototype.register=function(e,t,n){n===void 0&&(n={lifecycle:Or.Transient}),this.ensureNotDisposed();var o;if(BR(t)?o=t:o={useClass:t},Cl(o))for(var i=[e],s=o;s!=null;){var a=s.useToken;if(i.includes(a))throw new Error("Token registration cycle detected! "+qo(i,[a]).join(" -> "));i.push(a);var c=this._registry.get(a);c&&Cl(c.provider)?s=c.provider:s=null}if((n.lifecycle===Or.Singleton||n.lifecycle==Or.ContainerScoped||n.lifecycle==Or.ResolutionScoped)&&(Pl(o)||qf(o)))throw new Error('Cannot use lifecycle "'+Or[n.lifecycle]+'" with ValueProviders or FactoryProviders');return this._registry.set(e,{provider:o,options:n}),this},r.prototype.registerType=function(e,t){return this.ensureNotDisposed(),Ra(t)?this.register(e,{useToken:t}):this.register(e,{useClass:t})},r.prototype.registerInstance=function(e,t){return this.ensureNotDisposed(),this.register(e,{useValue:t})},r.prototype.registerSingleton=function(e,t){if(this.ensureNotDisposed(),Ra(e)){if(Ra(t))return this.register(e,{useToken:t},{lifecycle:Or.Singleton});if(t)return this.register(e,{useClass:t},{lifecycle:Or.Singleton});throw new Error('Cannot register a type name as a singleton without a "to" token')}var n=e;return t&&!Ra(t)&&(n=t),this.register(e,{useClass:n},{lifecycle:Or.Singleton})},r.prototype.resolve=function(e,t,n){t===void 0&&(t=new x1),n===void 0&&(n=!1),this.ensureNotDisposed();var o=this.getRegistration(e);if(!o&&Ra(e)){if(n)return;throw new Error('Attempted to resolve unregistered dependency token: "'+e.toString()+'"')}if(this.executePreResolutionInterceptor(e,"Single"),o){var i=this.resolveRegistration(o,t);return this.executePostResolutionInterceptor(e,i,"Single"),i}if(LR(e)){var i=this.construct(e,t);return this.executePostResolutionInterceptor(e,i,"Single"),i}throw new Error("Attempted to construct an undefined constructor. Could mean a circular dependency problem. Try using `delay` function.")},r.prototype.executePreResolutionInterceptor=function(e,t){var n,o;if(this.interceptors.preResolution.has(e)){var i=[];try{for(var s=y1(this.interceptors.preResolution.getAll(e)),a=s.next();!a.done;a=s.next()){var c=a.value;c.options.frequency!="Once"&&i.push(c),c.callback(e,t)}}catch(l){n={error:l}}finally{try{a&&!a.done&&(o=s.return)&&o.call(s)}finally{if(n)throw n.error}}this.interceptors.preResolution.setAll(e,i)}},r.prototype.executePostResolutionInterceptor=function(e,t,n){var o,i;if(this.interceptors.postResolution.has(e)){var s=[];try{for(var a=y1(this.interceptors.postResolution.getAll(e)),c=a.next();!c.done;c=a.next()){var l=c.value;l.options.frequency!="Once"&&s.push(l),l.callback(e,t,n)}}catch(f){o={error:f}}finally{try{c&&!c.done&&(i=a.return)&&i.call(a)}finally{if(o)throw o.error}}this.interceptors.postResolution.setAll(e,s)}},r.prototype.resolveRegistration=function(e,t){if(this.ensureNotDisposed(),e.options.lifecycle===Or.ResolutionScoped&&t.scopedResolutions.has(e))return t.scopedResolutions.get(e);var n=e.options.lifecycle===Or.Singleton,o=e.options.lifecycle===Or.ContainerScoped,i=n||o,s;return Pl(e.provider)?s=e.provider.useValue:Cl(e.provider)?s=i?e.instance||(e.instance=this.resolve(e.provider.useToken,t)):this.resolve(e.provider.useToken,t):b1(e.provider)?s=i?e.instance||(e.instance=this.construct(e.provider.useClass,t)):this.construct(e.provider.useClass,t):qf(e.provider)?s=e.provider.useFactory(this):s=this.construct(e.provider,t),e.options.lifecycle===Or.ResolutionScoped&&t.scopedResolutions.set(e,s),s},r.prototype.resolveAll=function(e,t,n){var o=this;t===void 0&&(t=new x1),n===void 0&&(n=!1),this.ensureNotDisposed();var i=this.getAllRegistrations(e);if(!i&&Ra(e)){if(n)return[];throw new Error('Attempted to resolve unregistered dependency token: "'+e.toString()+'"')}if(this.executePreResolutionInterceptor(e,"All"),i){var s=i.map(function(c){return o.resolveRegistration(c,t)});return this.executePostResolutionInterceptor(e,s,"All"),s}var a=[this.construct(e,t)];return this.executePostResolutionInterceptor(e,a,"All"),a},r.prototype.isRegistered=function(e,t){return t===void 0&&(t=!1),this.ensureNotDisposed(),this._registry.has(e)||t&&(this.parent||!1)&&this.parent.isRegistered(e,!0)},r.prototype.reset=function(){this.ensureNotDisposed(),this._registry.clear(),this.interceptors.preResolution.clear(),this.interceptors.postResolution.clear()},r.prototype.clearInstances=function(){var e,t;this.ensureNotDisposed();try{for(var n=y1(this._registry.entries()),o=n.next();!o.done;o=n.next()){var i=w1(o.value,2),s=i[0],a=i[1];this._registry.setAll(s,a.filter(function(c){return!Pl(c.provider)}).map(function(c){return c.instance=void 0,c}))}}catch(c){e={error:c}}finally{try{o&&!o.done&&(t=n.return)&&t.call(n)}finally{if(e)throw e.error}}},r.prototype.createChildContainer=function(){var e,t;this.ensureNotDisposed();var n=new r(this);try{for(var o=y1(this._registry.entries()),i=o.next();!i.done;i=o.next()){var s=w1(i.value,2),a=s[0],c=s[1];c.some(function(l){var f=l.options;return f.lifecycle===Or.ContainerScoped})&&n._registry.setAll(a,c.map(function(l){return l.options.lifecycle===Or.ContainerScoped?{provider:l.provider,options:l.options}:l}))}}catch(l){e={error:l}}finally{try{i&&!i.done&&(t=o.return)&&t.call(o)}finally{if(e)throw e.error}}return n},r.prototype.beforeResolution=function(e,t,n){n===void 0&&(n={frequency:"Always"}),this.interceptors.preResolution.set(e,{callback:t,options:n})},r.prototype.afterResolution=function(e,t,n){n===void 0&&(n={frequency:"Always"}),this.interceptors.postResolution.set(e,{callback:t,options:n})},r.prototype.dispose=function(){return DR(this,void 0,void 0,function(){var e;return NR(this,function(t){switch(t.label){case 0:return this.disposed=!0,e=[],this.disposables.forEach(function(n){var o=n.dispose();o&&e.push(o)}),[4,Promise.all(e)];case 1:return t.sent(),[2]}})})},r.prototype.getRegistration=function(e){return this.isRegistered(e)?this._registry.get(e):this.parent?this.parent.getRegistration(e):null},r.prototype.getAllRegistrations=function(e){return this.isRegistered(e)?this._registry.getAll(e):this.parent?this.parent.getAllRegistrations(e):null},r.prototype.construct=function(e,t){var n=this;if(e instanceof C4)return e.createProxy(function(i){return n.resolve(i,t)});var o=(function(){var i=Q9.get(e);if(!i||i.length===0){if(e.length===0)return new e;throw new Error('TypeInfo not known for "'+e.name+'"')}var s=i.map(n.resolveParams(t,e));return new(e.bind.apply(e,qo([void 0],s)))})();return UR(o)&&this.disposables.add(o),o},r.prototype.resolveParams=function(e,t){var n=this;return function(o,i){var s,a,c;try{return X9(o)?P4(o)?o.multiple?(s=n.resolve(o.transform)).transform.apply(s,qo([n.resolveAll(o.token,new x1,o.isOptional)],o.transformArgs)):(a=n.resolve(o.transform)).transform.apply(a,qo([n.resolve(o.token,e,o.isOptional)],o.transformArgs)):o.multiple?n.resolveAll(o.token,new x1,o.isOptional):n.resolve(o.token,e,o.isOptional):P4(o)?(c=n.resolve(o.transform,e)).transform.apply(c,qo([n.resolve(o.token,e)],o.transformArgs)):n.resolve(o,e)}catch(l){throw new Error(Y9(t,i,l))}}},r.prototype.ensureNotDisposed=function(){if(this.disposed)throw new Error("This container has been disposed, you cannot interact with a disposed container")},r})(),xt=new lW;function uW(r){return function(e){Q9.set(e,G9(e)),r&&r.token&&(Array.isArray(r.token)?r.token.forEach(function(t){xt.register(t,e)}):xt.register(r.token,e))}}var Da=uW;if(typeof Reflect>"u"||!Reflect.getMetadata)throw new Error(`tsyringe requires a reflect polyfill. Please add 'import "reflect-metadata"' to the top of your entry point.`);function Je(r,e,t,n){var o=arguments.length,i=o<3?e:n===null?n=Object.getOwnPropertyDescriptor(e,t):n,s;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")i=Reflect.decorate(r,e,t,n);else for(var a=r.length-1;a>=0;a--)(s=r[a])&&(i=(o<3?s(i):o>3?s(e,t,i):s(e,t))||i);return o>3&&i&&Object.defineProperty(e,t,i),i}function et(r,e,t,n){var o=arguments.length,i=o<3?e:n===null?n=Object.getOwnPropertyDescriptor(e,t):n,s;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")i=Reflect.decorate(r,e,t,n);else for(var a=r.length-1;a>=0;a--)(s=r[a])&&(i=(o<3?s(i):o>3?s(e,t,i):s(e,t))||i);return o>3&&i&&Object.defineProperty(e,t,i),i}var J9,kl=class{constructor(e={}){this.attrId="",this.attrValues=[],Object.assign(e)}};et([p({type:g.ObjectIdentifier})],kl.prototype,"attrId",void 0);et([p({type:g.Any,repeated:"set"})],kl.prototype,"attrValues",void 0);var $R=J9=class extends ve{constructor(e){super(e),Object.setPrototypeOf(this,J9.prototype)}};$R=J9=et([k({type:A.Sequence,itemType:kl})],$R);var ev,jR=ev=class extends ve{constructor(e){super(e),Object.setPrototypeOf(this,ev.prototype)}};jR=ev=et([k({type:A.Sequence,itemType:ho})],jR);var fW="1.2.840.113549",dW=`${fW}.1`,KR=`${dW}.12`,Wf=`${KR}.1`,AMe=`${Wf}.1`,TMe=`${Wf}.2`,IMe=`${Wf}.3`,CMe=`${Wf}.4`,PMe=`${Wf}.5`,kMe=`${Wf}.6`,Ol=`${KR}.10.1`;var DMe=`${Ol}.1`,NMe=`${Ol}.2`,LMe=`${Ol}.3`,BMe=`${Ol}.4`,MMe=`${Ol}.5`,UMe=`${Ol}.6`,k4="1.2.840.113549.1.9";var O4=class{constructor(e={}){this.certId="",this.certValue=new ArrayBuffer(0),Object.assign(this,e)}};et([p({type:g.ObjectIdentifier})],O4.prototype,"certId",void 0);et([p({type:g.Any,context:0})],O4.prototype,"certValue",void 0);var VR=`${k4}.22`,VMe=`${VR}.1`,HMe=`${VR}.2`;var R4=class{constructor(e={}){this.crlId="",this.crltValue=new ArrayBuffer(0),Object.assign(this,e)}};et([p({type:g.ObjectIdentifier})],R4.prototype,"crlId",void 0);et([p({type:g.Any,context:0})],R4.prototype,"crltValue",void 0);var hW=`${k4}.23`,XMe=`${hW}.1`;function Es(r,e,t,n){var o=arguments.length,i=o<3?e:n===null?n=Object.getOwnPropertyDescriptor(e,t):n,s;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")i=Reflect.decorate(r,e,t,n);else for(var a=r.length-1;a>=0;a--)(s=r[a])&&(i=(o<3?s(i):o>3?s(e,t,i):s(e,t))||i);return o>3&&i&&Object.defineProperty(e,t,i),i}var D4=class extends xe{},Na=class{constructor(e={}){this.encryptionAlgorithm=new X,this.encryptedData=new D4,Object.assign(this,e)}};Es([p({type:X})],Na.prototype,"encryptionAlgorithm",void 0);Es([p({type:D4})],Na.prototype,"encryptedData",void 0);var tv,rv;(function(r){r[r.v1=0]="v1"})(rv||(rv={}));var N4=class extends xe{},nv=tv=class extends ve{constructor(e){super(e),Object.setPrototypeOf(this,tv.prototype)}};nv=tv=Es([k({type:A.Sequence,itemType:Tr})],nv);var La=class{constructor(e={}){this.version=rv.v1,this.privateKeyAlgorithm=new X,this.privateKey=new N4,Object.assign(this,e)}};Es([p({type:g.Integer})],La.prototype,"version",void 0);Es([p({type:X})],La.prototype,"privateKeyAlgorithm",void 0);Es([p({type:N4})],La.prototype,"privateKey",void 0);Es([p({type:nv,implicit:!0,context:0,optional:!0})],La.prototype,"attributes",void 0);var HR=class extends La{};HR=et([k({type:A.Sequence})],HR);var qR=class extends Na{};qR=et([k({type:A.Sequence})],qR);var L4=class{constructor(e={}){this.secretTypeId="",this.secretValue=new ArrayBuffer(0),Object.assign(this,e)}};et([p({type:g.ObjectIdentifier})],L4.prototype,"secretTypeId",void 0);et([p({type:g.Any,context:0})],L4.prototype,"secretValue",void 0);var Ba=class{constructor(e={}){this.mac=new Il,this.macSalt=new xe,this.iterations=1,Object.assign(this,e)}};et([p({type:Il})],Ba.prototype,"mac",void 0);et([p({type:xe})],Ba.prototype,"macSalt",void 0);et([p({type:g.Integer,defaultValue:1})],Ba.prototype,"iterations",void 0);var Rl=class{constructor(e={}){this.version=3,this.authSafe=new ho,this.macData=new Ba,Object.assign(this,e)}};et([p({type:g.Integer})],Rl.prototype,"version",void 0);et([p({type:ho})],Rl.prototype,"authSafe",void 0);et([p({type:Ba,optional:!0})],Rl.prototype,"macData",void 0);var ov,zf=class{constructor(e={}){this.bagId="",this.bagValue=new ArrayBuffer(0),Object.assign(this,e)}};et([p({type:g.ObjectIdentifier})],zf.prototype,"bagId",void 0);et([p({type:g.Any,context:0})],zf.prototype,"bagValue",void 0);et([p({type:kl,repeated:"set",optional:!0})],zf.prototype,"bagAttributes",void 0);var WR=ov=class extends ve{constructor(e){super(e),Object.setPrototypeOf(this,ov.prototype)}};WR=ov=et([k({type:A.Sequence,itemType:zf})],WR);var iv,sv,av,Ft="1.2.840.113549.1.9",ZUe=`${Ft}.0`,sD=`${Ft}.24`,S1=`${Ft}.25`,aD=`${Ft}.26`,cD=`${Ft}.27`,JUe=`${sD}.1`,eFe=`${sD}.2`,tFe=`${Ft}.1`,rFe=`${Ft}.2`,nFe=`${Ft}.3`,oFe=`${Ft}.4`,iFe=`${Ft}.5`,sFe=`${Ft}.6`,mv=`${Ft}.7`,aFe=`${Ft}.8`,cFe=`${Ft}.9`,lFe=`${Ft}.13`,_1=`${Ft}.14`,uFe=`${Ft}.15`,fFe=`${Ft}.20`,dFe=`${Ft}.21`;var hFe=`${S1}.1`,pFe=`${S1}.2`,mFe=`${S1}.3`,gFe=`${S1}.4`,yFe=`${S1}.5`,A1="1.3.6.1.5.5.7.9",wFe=`${A1}.1`,bFe=`${A1}.2`,vFe=`${A1}.3`,xFe=`${A1}.4`,EFe=`${A1}.5`,SFe=`${aD}.1`,_Fe=`${aD}.2`,AFe=`${cD}.1`,TFe=`${cD}.2`,IFe=`${Ft}.16`,CFe=`${Ft}.22`,PFe=`${Ft}.23`,kFe=`${I9}.65`,B4=class extends Zt{constructor(e={}){super(e)}toString(){return{}.toString(),this.ia5String||super.toString()}};Je([p({type:g.IA5String})],B4.prototype,"ia5String",void 0);B4=Je([k({type:A.Choice})],B4);var zR=class extends ho{};zR=Je([k({type:A.Sequence})],zR);var GR=class extends Rl{};GR=Je([k({type:A.Sequence})],GR);var XR=class extends Na{};XR=Je([k({type:A.Sequence})],XR);var cv=class{constructor(e=""){this.value=e}toString(){return this.value}};Je([p({type:g.IA5String})],cv.prototype,"value",void 0);cv=Je([k({type:A.Choice})],cv);var YR=class extends B4{};YR=Je([k({type:A.Choice})],YR);var QR=class extends Zt{};QR=Je([k({type:A.Choice})],QR);var lv=class{constructor(e=new Date){this.value=e}};Je([p({type:g.GeneralizedTime})],lv.prototype,"value",void 0);lv=Je([k({type:A.Choice})],lv);var ZR=class extends Zt{};ZR=Je([k({type:A.Choice})],ZR);var uv=class{constructor(e="M"){this.value=e}toString(){return this.value}};Je([p({type:g.PrintableString})],uv.prototype,"value",void 0);uv=Je([k({type:A.Choice})],uv);var M4=class{constructor(e=""){this.value=e}toString(){return this.value}};Je([p({type:g.PrintableString})],M4.prototype,"value",void 0);M4=Je([k({type:A.Choice})],M4);var JR=class extends M4{};JR=Je([k({type:A.Choice})],JR);var eD=class extends Zt{};eD=Je([k({type:A.Choice})],eD);var fv=class{constructor(e=""){this.value=e}toString(){return this.value}};Je([p({type:g.ObjectIdentifier})],fv.prototype,"value",void 0);fv=Je([k({type:A.Choice})],fv);var tD=class extends Ut{};tD=Je([k({type:A.Choice})],tD);var dv=class{constructor(e=0){this.value=e}toString(){return this.value.toString()}};Je([p({type:g.Integer})],dv.prototype,"value",void 0);dv=Je([k({type:A.Choice})],dv);var rD=class extends bn{};rD=Je([k({type:A.Sequence})],rD);var E1=class extends Zt{};E1=Je([k({type:A.Choice})],E1);var nD=iv=class extends Vn{constructor(e){super(e),Object.setPrototypeOf(this,iv.prototype)}};nD=iv=Je([k({type:A.Sequence})],nD);var oD=sv=class extends ve{constructor(e){super(e),Object.setPrototypeOf(this,sv.prototype)}};oD=sv=Je([k({type:A.Set,itemType:Ho})],oD);var hv=class{constructor(e=""){this.value=e}toString(){return this.value}};Je([p({type:g.BmpString})],hv.prototype,"value",void 0);hv=Je([k({type:A.Choice})],hv);var pv=class extends X{};pv=Je([k({type:A.Sequence})],pv);var iD=av=class extends ve{constructor(e){super(e),Object.setPrototypeOf(this,av.prototype)}};iD=av=Je([k({type:A.Sequence,itemType:pv})],iD);function Wo(r,e,t,n){var o=arguments.length,i=o<3?e:n===null?n=Object.getOwnPropertyDescriptor(e,t):n,s;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")i=Reflect.decorate(r,e,t,n);else for(var a=r.length-1;a>=0;a--)(s=r[a])&&(i=(o<3?s(i):o>3?s(e,t,i):s(e,t))||i);return o>3&&i&&Object.defineProperty(e,t,i),i}var gv,T1=gv=class extends ve{constructor(e){super(e),Object.setPrototypeOf(this,gv.prototype)}};T1=gv=Wo([k({type:A.Sequence,itemType:Tr})],T1);var Ti=class{constructor(e={}){this.version=0,this.subject=new pt,this.subjectPKInfo=new Ir,this.attributes=new T1,Object.assign(this,e)}};Wo([p({type:g.Integer})],Ti.prototype,"version",void 0);Wo([p({type:pt})],Ti.prototype,"subject",void 0);Wo([p({type:Ir})],Ti.prototype,"subjectPKInfo",void 0);Wo([p({type:T1,implicit:!0,context:0,optional:!0})],Ti.prototype,"attributes",void 0);var Ma=class{constructor(e={}){this.certificationRequestInfo=new Ti,this.signatureAlgorithm=new X,this.signature=new ArrayBuffer(0),Object.assign(this,e)}};Wo([p({type:Ti,raw:!0})],Ma.prototype,"certificationRequestInfo",void 0);Wo([p({type:X})],Ma.prototype,"signatureAlgorithm",void 0);Wo([p({type:g.BitString})],Ma.prototype,"signature",void 0);var Y1="crypto.algorithm",Tv=class{getAlgorithms(){return xt.resolveAll(Y1)}toAsnAlgorithm(e){({...e});for(let t of this.getAlgorithms()){let n=t.toAsnAlgorithm(e);if(n)return n}if(/^[0-9.]+$/.test(e.name)){let t=new X({algorithm:e.name});if("parameters"in e){let n=e;t.parameters=n.parameters}return t}throw new Error("Cannot convert WebCrypto algorithm to ASN.1 algorithm")}toWebAlgorithm(e){for(let n of this.getAlgorithms()){let o=n.toWebAlgorithm(e);if(o)return o}return{name:e.algorithm,parameters:e.parameters}}},Dl="crypto.algorithmProvider";xt.registerSingleton(Dl,Tv);var j4,Sn="1.3.36.3.3.2.8.1.1",lD=`${Sn}.1`,uD=`${Sn}.2`,fD=`${Sn}.3`,dD=`${Sn}.4`,hD=`${Sn}.5`,pD=`${Sn}.6`,mD=`${Sn}.7`,gD=`${Sn}.8`,yD=`${Sn}.9`,wD=`${Sn}.10`,bD=`${Sn}.11`,vD=`${Sn}.12`,xD=`${Sn}.13`,ED=`${Sn}.14`,SD="brainpoolP160r1",_D="brainpoolP160t1",AD="brainpoolP192r1",TD="brainpoolP192t1",ID="brainpoolP224r1",CD="brainpoolP224t1",PD="brainpoolP256r1",kD="brainpoolP256t1",OD="brainpoolP320r1",RD="brainpoolP320t1",DD="brainpoolP384r1",ND="brainpoolP384t1",LD="brainpoolP512r1",BD="brainpoolP512t1",Dt="ECDSA",W1=j4=class{toAsnAlgorithm(e){switch(e.name.toLowerCase()){case Dt.toLowerCase():if("hash"in e)switch((typeof e.hash=="string"?e.hash:e.hash.name).toLowerCase()){case"sha-1":return ZO;case"sha-256":return JO;case"sha-384":return eR;case"sha-512":return tR}else if("namedCurve"in e){let t="";switch(e.namedCurve){case"P-256":t=M9;break;case"K-256":t=j4.SECP256K1;break;case"P-384":t=U9;break;case"P-521":t=F9;break;case SD:t=lD;break;case _D:t=uD;break;case AD:t=fD;break;case TD:t=dD;break;case ID:t=hD;break;case CD:t=pD;break;case PD:t=mD;break;case kD:t=gD;break;case OD:t=yD;break;case RD:t=wD;break;case DD:t=bD;break;case ND:t=vD;break;case LD:t=xD;break;case BD:t=ED;break}if(t)return new X({algorithm:xl,parameters:ee.serialize(new Si({namedCurve:t}))})}}return null}toWebAlgorithm(e){switch(e.algorithm){case f1:return{name:Dt,hash:{name:"SHA-1"}};case d1:return{name:Dt,hash:{name:"SHA-256"}};case h1:return{name:Dt,hash:{name:"SHA-384"}};case p1:return{name:Dt,hash:{name:"SHA-512"}};case xl:{if(!e.parameters)throw new TypeError("Cannot get required parameters from EC algorithm");switch(ee.parse(e.parameters,Si).namedCurve){case M9:return{name:Dt,namedCurve:"P-256"};case j4.SECP256K1:return{name:Dt,namedCurve:"K-256"};case U9:return{name:Dt,namedCurve:"P-384"};case F9:return{name:Dt,namedCurve:"P-521"};case lD:return{name:Dt,namedCurve:SD};case uD:return{name:Dt,namedCurve:_D};case fD:return{name:Dt,namedCurve:AD};case dD:return{name:Dt,namedCurve:TD};case hD:return{name:Dt,namedCurve:ID};case pD:return{name:Dt,namedCurve:CD};case mD:return{name:Dt,namedCurve:PD};case gD:return{name:Dt,namedCurve:kD};case yD:return{name:Dt,namedCurve:OD};case wD:return{name:Dt,namedCurve:RD};case bD:return{name:Dt,namedCurve:DD};case vD:return{name:Dt,namedCurve:ND};case xD:return{name:Dt,namedCurve:LD};case ED:return{name:Dt,namedCurve:BD}}}}return null}};W1.SECP256K1="1.3.132.0.10";W1=j4=Xp([Da()],W1);xt.registerSingleton(Y1,W1);var zD=Symbol("name"),GD=Symbol("value"),Ge=class{constructor(e,t={},n=""){this[zD]=e,this[GD]=n;for(let o in t)this[o]=t[o]}};Ge.NAME=zD;Ge.VALUE=GD;var Iv=class{static toTextObject(e){let t=new Ge("Algorithm Identifier",{},Ci.toString(e.algorithm));if(e.parameters)switch(e.algorithm){case xl:{let n=new W1().toWebAlgorithm(e);n&&"namedCurve"in n?t["Named Curve"]=n.namedCurve:t.Parameters=e.parameters;break}default:t.Parameters=e.parameters}return t}},Ci=class{static toString(e){let t=this.items[e];return t||e}};Ci.items={[Sl]:"sha1",[S4]:"sha224",[_l]:"sha256",[Al]:"sha384",[Tl]:"sha512",[_i]:"rsaEncryption",[Mf]:"sha1WithRSAEncryption",[sR]:"sha224WithRSAEncryption",[E4]:"sha256WithRSAEncryption",[Uf]:"sha384WithRSAEncryption",[Ff]:"sha512WithRSAEncryption",[xl]:"ecPublicKey",[f1]:"ecdsaWithSHA1",[x4]:"ecdsaWithSHA224",[d1]:"ecdsaWithSHA256",[h1]:"ecdsaWithSHA384",[p1]:"ecdsaWithSHA512",[RO]:"TLS WWW server authentication",[DO]:"TLS WWW client authentication",[NO]:"Code Signing",[LO]:"E-mail Protection",[BO]:"Time Stamping",[MO]:"OCSP Signing",[YO]:"Signed Data"};var _s=class{static serialize(e){return this.serializeObj(e).join(`
`)}static pad(e=0){return"".padStart(2*e," ")}static serializeObj(e,t=0){let n=[],o=this.pad(t++),i="",s=e[Ge.VALUE];s&&(i=` ${s}`),n.push(`${o}${e[Ge.NAME]}:${i}`),o=this.pad(t);for(let a in e){if(typeof a=="symbol")continue;let c=e[a],l=a?`${a}: `:"";if(typeof c=="string"||typeof c=="number"||typeof c=="boolean")n.push(`${o}${l}${c}`);else if(c instanceof Date)n.push(`${o}${l}${c.toUTCString()}`);else if(Array.isArray(c))for(let f of c)f[Ge.NAME]=a,n.push(...this.serializeObj(f,t));else if(c instanceof Ge)c[Ge.NAME]=a,n.push(...this.serializeObj(c,t));else if(Y.BufferSourceConverter.isBufferSource(c))a?(n.push(`${o}${l}`),n.push(...this.serializeBufferSource(c,t+1))):n.push(...this.serializeBufferSource(c,t));else if("toTextObject"in c){let f=c.toTextObject();f[Ge.NAME]=a,n.push(...this.serializeObj(f,t))}else throw new TypeError("Cannot serialize data in text format. Unsupported type.")}return n}static serializeBufferSource(e,t=0){let n=this.pad(t),o=Y.BufferSourceConverter.toUint8Array(e),i=[];for(let s=0;s<o.length;){let a=[];for(let c=0;c<16&&s<o.length;c++){c===8&&a.push("");let l=o[s++].toString(16).padStart(2,"0");a.push(l)}i.push(`${n}${a.join(" ")}`)}return i}static serializeAlgorithm(e){return this.algorithmSerializer.toTextObject(e)}};_s.oidSerializer=Ci;_s.algorithmSerializer=Iv;var Gf,Ua=class r{get rawData(){return Ne(this,Gf,"f")||It(this,Gf,ee.serialize(this.asn),"f"),Ne(this,Gf,"f")}constructor(...e){Gf.set(this,void 0),Y.BufferSourceConverter.isBufferSource(e[0])?(this.asn=ee.parse(e[0],e[1]),It(this,Gf,Y.BufferSourceConverter.toArrayBuffer(e[0]),"f"),this.onInit(this.asn)):(this.asn=e[0],this.onInit(this.asn))}equal(e){return e instanceof r?(0,Y.isEqual)(e.rawData,this.rawData):!1}toString(e="text"){switch(e){case"asn":return ee.toString(this.rawData);case"text":return _s.serialize(this.toTextObject());case"hex":return Y.Convert.ToHex(this.rawData);case"base64":return Y.Convert.ToBase64(this.rawData);case"base64url":return Y.Convert.ToBase64Url(this.rawData);default:throw TypeError("Argument 'format' is unsupported value")}}getTextName(){return this.constructor.NAME}toTextObject(){let e=this.toTextObjectEmpty();return e[""]=this.rawData,e}toTextObjectEmpty(e){return new Ge(this.getTextName(),{},e)}};Gf=new WeakMap;Ua.NAME="ASN";var qn=class r extends Ua{constructor(...e){let t;Y.BufferSourceConverter.isBufferSource(e[0])?t=Y.BufferSourceConverter.toArrayBuffer(e[0]):t=ee.serialize(new Cr({extnID:e[0],critical:e[1],extnValue:new xe(Y.BufferSourceConverter.toArrayBuffer(e[2]))})),super(t,Cr)}onInit(e){this.type=e.extnID,this.critical=e.critical,this.value=e.extnValue.buffer}toTextObject(){let e=this.toTextObjectWithoutValue();return e[""]=this.value,e}toTextObjectWithoutValue(){let e=this.toTextObjectEmpty(this.critical?"critical":void 0);return e[Ge.NAME]===r.NAME&&(e[Ge.NAME]=Ci.toString(this.type)),e}},XD,z1=class r{static isCryptoKeyPair(e){return e&&e.privateKey&&e.publicKey}static isCryptoKey(e){return e&&e.usages&&e.type&&e.algorithm&&e.extractable!==void 0}constructor(){this.items=new Map,this[XD]="CryptoProvider",typeof self<"u"&&typeof crypto<"u"?this.set(r.DEFAULT,crypto):typeof globalThis<"u"&&globalThis.crypto&&globalThis.crypto.subtle&&this.set(r.DEFAULT,globalThis.crypto)}clear(){this.items.clear()}delete(e){return this.items.delete(e)}forEach(e,t){return this.items.forEach(e,t)}has(e){return this.items.has(e)}get size(){return this.items.size}entries(){return this.items.entries()}keys(){return this.items.keys()}values(){return this.items.values()}[Symbol.iterator](){return this.items[Symbol.iterator]()}get(e=r.DEFAULT){let t=this.items.get(e.toLowerCase());if(!t)throw new Error(`Cannot get Crypto by name '${e}'`);return t}set(e,t){if(typeof e=="string"){if(!t)throw new TypeError("Argument 'value' is required");this.items.set(e.toLowerCase(),t)}else this.items.set(r.DEFAULT,e);return this}};XD=Symbol.toStringTag;z1.DEFAULT="default";var hr=new z1,yW=/^[0-2](?:\.[1-9][0-9]*)+$/;function wW(r){return new RegExp(yW).test(r)}var V4=class{constructor(e={}){this.items={};for(let t in e)this.register(t,e[t])}get(e){return this.items[e]||null}findId(e){return wW(e)?e:this.get(e)}register(e,t){this.items[e]=t,this.items[t]=e}},En=new V4;En.register("CN","2.5.4.3");En.register("L","2.5.4.7");En.register("ST","2.5.4.8");En.register("O","2.5.4.10");En.register("OU","2.5.4.11");En.register("C","2.5.4.6");En.register("DC","0.9.2342.19200300.100.1.25");En.register("E","1.2.840.113549.1.9.1");En.register("G","2.5.4.42");En.register("I","2.5.4.43");En.register("SN","2.5.4.4");En.register("T","2.5.4.12");function bW(r,e){return`\\${Y.Convert.ToHex(Y.Convert.FromUtf8String(e)).toUpperCase()}`}function vW(r){return r.replace(/([,+"\\<>;])/g,"\\$1").replace(/^([ #])/,"\\$1").replace(/([ ]$)/,"\\$1").replace(/([\r\n\t])/,bW)}var zo=class r{static isASCII(e){for(let t=0;t<e.length;t++)if(e.charCodeAt(t)>255)return!1;return!0}static isPrintableString(e){return/^[A-Za-z0-9 '()+,-./:=?]*$/g.test(e)}constructor(e,t={}){this.extraNames=new V4,this.asn=new pt;for(let n in t)if(Object.prototype.hasOwnProperty.call(t,n)){let o=t[n];this.extraNames.register(n,o)}typeof e=="string"?this.asn=this.fromString(e):e instanceof pt?this.asn=e:Y.BufferSourceConverter.isBufferSource(e)?this.asn=ee.parse(e,pt):this.asn=this.fromJSON(e)}getField(e){let t=this.extraNames.findId(e)||En.findId(e),n=[];for(let o of this.asn)for(let i of o)i.type===t&&n.push(i.value.toString());return n}getName(e){return this.extraNames.get(e)||En.get(e)}toString(){return this.asn.map(e=>e.map(t=>{let n=this.getName(t.type)||t.type,o=t.value.anyValue?`#${Y.Convert.ToHex(t.value.anyValue)}`:vW(t.value.toString());return`${n}=${o}`}).join("+")).join(", ")}toJSON(){var e;let t=[];for(let n of this.asn){let o={};for(let i of n){let s=this.getName(i.type)||i.type;(e=o[s])!==null&&e!==void 0||(o[s]=[]),o[s].push(i.value.anyValue?`#${Y.Convert.ToHex(i.value.anyValue)}`:i.value.toString())}t.push(o)}return t}fromString(e){let t=new pt,n=/(\d\.[\d.]*\d|[A-Za-z]+)=((?:"")|(?:".*?[^\\]")|(?:[^,+"\\](?=[,+]|$))|(?:[^,+].*?(?:[^\\][,+]))|(?:))([,+])?/g,o=null,i=",";for(;o=n.exec(`${e},`);){let[,s,a]=o,c=a[a.length-1];(c===","||c==="+")&&(a=a.slice(0,a.length-1),o[3]=c);let l=o[3];s=this.getTypeOid(s);let f=this.createAttribute(s,a);i==="+"?t[t.length-1].push(f):t.push(new ba([f])),i=l}return t}fromJSON(e){let t=new pt;for(let n of e){let o=new ba;for(let i in n){let s=this.getTypeOid(i),a=n[i];for(let c of a){let l=this.createAttribute(s,c);o.push(l)}}t.push(o)}return t}getTypeOid(e){if(/[\d.]+/.test(e)||(e=this.getName(e)||""),!e)throw new Error(`Cannot get OID for name type '${e}'`);return e}createAttribute(e,t){let n=new tl({type:e});if(typeof t=="object")for(let o in t)switch(o){case"ia5String":n.value.ia5String=t[o];break;case"utf8String":n.value.utf8String=t[o];break;case"universalString":n.value.universalString=t[o];break;case"bmpString":n.value.bmpString=t[o];break;case"printableString":n.value.printableString=t[o];break}else if(t[0]==="#")n.value.anyValue=Y.Convert.FromHex(t.slice(1));else{let o=this.processStringValue(t);e===this.getName("E")||e===this.getName("DC")?n.value.ia5String=o:r.isPrintableString(o)?n.value.printableString=o:n.value.utf8String=o}return n}processStringValue(e){let t=/"(.*?[^\\])?"/.exec(e);return t&&(e=t[1]),e.replace(/\\0a/ig,`
`).replace(/\\0d/ig,"\r").replace(/\\0g/ig,"	").replace(/\\(.)/g,"$1")}toArrayBuffer(){return ee.serialize(this.asn)}async getThumbprint(...e){var t;let n,o="SHA-1";return e.length>=1&&!(!((t=e[0])===null||t===void 0)&&t.subtle)?(o=e[0]||o,n=e[1]||hr.get()):n=e[0]||hr.get(),await n.subtle.digest(o,this.toArrayBuffer())}},YD="Cannot initialize GeneralName from ASN.1 data.",MD=`${YD} Unsupported string format in use.`,xW=`${YD} Value doesn't match to GUID regular expression.`,UD=/^([0-9a-f]{8})-?([0-9a-f]{4})-?([0-9a-f]{4})-?([0-9a-f]{4})-?([0-9a-f]{12})$/i,FD="1.3.6.1.4.1.311.25.1",$D="1.3.6.1.4.1.311.20.2.3",yv="dns",wv="dn",bv="email",vv="ip",xv="url",Ev="guid",Sv="upn",U4="id",Ii=class extends Ua{constructor(...e){let t;if(e.length===2)switch(e[0]){case wv:{let n=new zo(e[1]).toArrayBuffer(),o=ee.parse(n,pt);t=new Se({directoryName:o});break}case yv:t=new Se({dNSName:e[1]});break;case bv:t=new Se({rfc822Name:e[1]});break;case Ev:{let n=new RegExp(UD,"i").exec(e[1]);if(!n)throw new Error("Cannot parse GUID value. Value doesn't match to regular expression");let o=n.slice(1).map((i,s)=>s<3?Y.Convert.ToHex(new Uint8Array(Y.Convert.FromHex(i)).reverse()):i).join("");t=new Se({otherName:new va({typeId:FD,value:ee.serialize(new xe(Y.Convert.FromHex(o)))})});break}case vv:t=new Se({iPAddress:e[1]});break;case U4:t=new Se({registeredID:e[1]});break;case Sv:{t=new Se({otherName:new va({typeId:$D,value:ee.serialize(zb.toASN(e[1]))})});break}case xv:t=new Se({uniformResourceIdentifier:e[1]});break;default:throw new Error("Cannot create GeneralName. Unsupported type of the name")}else Y.BufferSourceConverter.isBufferSource(e[0])?t=ee.parse(e[0],Se):t=e[0];super(t)}onInit(e){if(e.dNSName!=null)this.type=yv,this.value=e.dNSName;else if(e.rfc822Name!=null)this.type=bv,this.value=e.rfc822Name;else if(e.iPAddress!=null)this.type=vv,this.value=e.iPAddress;else if(e.uniformResourceIdentifier!=null)this.type=xv,this.value=e.uniformResourceIdentifier;else if(e.registeredID!=null)this.type=U4,this.value=e.registeredID;else if(e.directoryName!=null)this.type=wv,this.value=new zo(e.directoryName).toString();else if(e.otherName!=null)if(e.otherName.typeId===FD){this.type=Ev;let t=ee.parse(e.otherName.value,xe),n=new RegExp(UD,"i").exec(Y.Convert.ToHex(t));if(!n)throw new Error(xW);this.value=n.slice(1).map((o,i)=>i<3?Y.Convert.ToHex(new Uint8Array(Y.Convert.FromHex(o)).reverse()):o).join("-")}else if(e.otherName.typeId===$D)this.type=Sv,this.value=ee.parse(e.otherName.value,Zt).toString();else throw new Error(MD);else throw new Error(MD)}toJSON(){return{type:this.type,value:this.value}}toTextObject(){let e;switch(this.type){case wv:case yv:case Ev:case vv:case U4:case Sv:case xv:e=this.type.toUpperCase();break;case bv:e="Email";break;default:throw new Error("Unsupported GeneralName type")}let t=this.value;return this.type===U4&&(t=Ci.toString(t)),new Ge(e,void 0,t)}},As=class extends Ua{constructor(e){let t;if(e instanceof Tt)t=e;else if(Array.isArray(e)){let n=[];for(let o of e)if(o instanceof Se)n.push(o);else{let i=ee.parse(new Ii(o.type,o.value).rawData,Se);n.push(i)}t=new Tt(n)}else if(Y.BufferSourceConverter.isBufferSource(e))t=ee.parse(e,Tt);else throw new Error("Cannot initialize GeneralNames. Incorrect incoming arguments");super(t)}onInit(e){let t=[];for(let n of e){let o=null;try{o=new Ii(n)}catch{continue}t.push(o)}this.items=t}toJSON(){return this.items.map(e=>e.toJSON())}toTextObject(){let e=super.toTextObjectEmpty();for(let t of this.items){let n=t.toTextObject(),o=e[n[Ge.NAME]];Array.isArray(o)||(o=[],e[n[Ge.NAME]]=o),o.push(n)}return e}};As.NAME="GeneralNames";var q1="-{5}",G1="\\n",EW=`[^${G1}]+`,SW=`${q1}BEGIN (${EW}(?=${q1}))${q1}`,_W=`${q1}END \\1${q1}`,Qf="\\n",AW=`[^:${G1}]+`,TW=`(?:[^${G1}]+${Qf}(?: +[^${G1}]+${Qf})*)`,IW="[a-zA-Z0-9=+/]+",CW=`(?:${IW}${Qf})+`,jD=`${SW}${Qf}(?:((?:${AW}: ${TW})+))?${Qf}?(${CW})${_W}`,rn=class{static isPem(e){return typeof e=="string"&&new RegExp(jD,"g").test(e.replace(/\r/g,""))}static decodeWithHeaders(e){e=e.replace(/\r/g,"");let t=new RegExp(jD,"g"),n=[],o=null;for(;o=t.exec(e);){let i=o[3].replace(new RegExp(`[${G1}]+`,"g"),""),s={type:o[1],headers:[],rawData:Y.Convert.FromBase64(i)},a=o[2];if(a){let c=a.split(new RegExp(Qf,"g")),l=null;for(let f of c){let[u,d]=f.split(/:(.*)/);if(d===void 0){if(!l)throw new Error("Cannot parse PEM string. Incorrect header value");l.value+=u.trim()}else l&&s.headers.push(l),l={key:u,value:d.trim()}}l&&s.headers.push(l)}n.push(s)}return n}static decode(e){return this.decodeWithHeaders(e).map(n=>n.rawData)}static decodeFirst(e){let t=this.decode(e);if(!t.length)throw new RangeError("PEM string doesn't contain any objects");return t[0]}static encode(e,t){if(Array.isArray(e)){let n=new Array;return t?e.forEach(o=>{if(!Y.BufferSourceConverter.isBufferSource(o))throw new TypeError("Cannot encode array of BufferSource in PEM format. Not all items of the array are BufferSource");n.push(this.encodeStruct({type:t,rawData:Y.BufferSourceConverter.toArrayBuffer(o)}))}):e.forEach(o=>{if(!("type"in o))throw new TypeError("Cannot encode array of PemStruct in PEM format. Not all items of the array are PemStrut");n.push(this.encodeStruct(o))}),n.join(`
`)}else{if(!t)throw new Error("Required argument 'tag' is missed");return this.encodeStruct({type:t,rawData:Y.BufferSourceConverter.toArrayBuffer(e)})}}static encodeStruct(e){var t;let n=e.type.toLocaleUpperCase(),o=[];if(o.push(`-----BEGIN ${n}-----`),!((t=e.headers)===null||t===void 0)&&t.length){for(let l of e.headers)o.push(`${l.key}: ${l.value}`);o.push("")}let i=Y.Convert.ToBase64(e.rawData),s,a=0,c=Array();for(;a<i.length&&(i.length-a<64?s=i.substring(a):(s=i.substring(a,a+64),a+=64),s.length!==0);)if(c.push(s),s.length<64)break;return o.push(...c),o.push(`-----END ${n}-----`),o.join(`
`)}};rn.CertificateTag="CERTIFICATE";rn.CrlTag="CRL";rn.CertificateRequestTag="CERTIFICATE REQUEST";rn.PublicKeyTag="PUBLIC KEY";rn.PrivateKeyTag="PRIVATE KEY";var Fa=class r extends Ua{static isAsnEncoded(e){return Y.BufferSourceConverter.isBufferSource(e)||typeof e=="string"}static toArrayBuffer(e){if(typeof e=="string"){if(rn.isPem(e))return rn.decode(e)[0];if(Y.Convert.isHex(e))return Y.Convert.FromHex(e);if(Y.Convert.isBase64(e))return Y.Convert.FromBase64(e);if(Y.Convert.isBase64Url(e))return Y.Convert.FromBase64Url(e);throw new TypeError("Unsupported format of 'raw' argument. Must be one of DER, PEM, HEX, Base64, or Base4Url")}else{let t=Y.BufferSourceConverter.toUint8Array(e);if(t.length>0&&t[0]===48)return Y.BufferSourceConverter.toArrayBuffer(e);let n=Y.Convert.ToBinary(e);if(rn.isPem(n))return rn.decode(n)[0];if(Y.Convert.isHex(n))return Y.Convert.FromHex(n);if(Y.Convert.isBase64(n))return Y.Convert.FromBase64(n);if(Y.Convert.isBase64Url(n))return Y.Convert.FromBase64Url(n);throw new TypeError("Unsupported format of 'raw' argument. Must be one of DER, PEM, HEX, Base64, or Base4Url")}}constructor(...e){r.isAsnEncoded(e[0])?super(r.toArrayBuffer(e[0]),e[1]):super(e[0])}toString(e="pem"){switch(e){case"pem":return rn.encode(this.rawData,this.tag);default:return super.toString(e)}}},Ss=class r extends Fa{static async create(e,t=hr.get()){if(e instanceof r)return e;if(z1.isCryptoKey(e)){if(e.type!=="public")throw new TypeError("Public key is required");let n=await t.subtle.exportKey("spki",e);return new r(n)}else{if(e.publicKey)return e.publicKey;if(Y.BufferSourceConverter.isBufferSource(e))return new r(e);throw new TypeError("Unsupported PublicKeyType")}}constructor(e){Fa.isAsnEncoded(e)?super(e,Ir):super(e),this.tag=rn.PublicKeyTag}async export(...e){let t,n=["verify"],o={hash:"SHA-256",...this.algorithm};e.length>1?(o=e[0]||o,n=e[1]||n,t=e[2]||hr.get()):t=e[0]||hr.get();let i=this.rawData,s=ee.parse(this.rawData,Ir);return s.algorithm.algorithm===ka&&(i=PW(s,i)),t.subtle.importKey("spki",i,o,!0,n)}onInit(e){let t=xt.resolve(Dl),n=this.algorithm=t.toWebAlgorithm(e.algorithm);switch(e.algorithm.algorithm){case _i:{let o=ee.parse(e.subjectPublicKey,Kf),i=Y.BufferSourceConverter.toUint8Array(o.modulus);n.publicExponent=Y.BufferSourceConverter.toUint8Array(o.publicExponent),n.modulusLength=(i[0]?i:i.slice(1)).byteLength<<3;break}}}async getThumbprint(...e){var t;let n,o="SHA-1";return e.length>=1&&!(!((t=e[0])===null||t===void 0)&&t.subtle)?(o=e[0]||o,n=e[1]||hr.get()):n=e[0]||hr.get(),await n.subtle.digest(o,this.rawData)}async getKeyIdentifier(...e){let t,n="SHA-1";e.length===1?typeof e[0]=="string"?(n=e[0],t=hr.get()):t=e[0]:e.length===2?(n=e[0],t=e[1]):t=hr.get();let o=ee.parse(this.rawData,Ir);return await t.subtle.digest(n,o.subjectPublicKey)}toTextObject(){let e=this.toTextObjectEmpty(),t=ee.parse(this.rawData,Ir);switch(e.Algorithm=_s.serializeAlgorithm(t.algorithm),t.algorithm.algorithm){case xl:e["EC Point"]=t.subjectPublicKey;break;case _i:default:e["Raw Data"]=t.subjectPublicKey}return e}};function PW(r,e){return r.algorithm=new X({algorithm:_i,parameters:null}),e=ee.serialize(r),e}var H4=class r extends qn{static async create(e,t=!1,n=hr.get()){if("name"in e&&"serialNumber"in e)return new r(e,t);let i=await(await Ss.create(e,n)).getKeyIdentifier(n);return new r(Y.Convert.ToHex(i),t)}constructor(...e){if(Y.BufferSourceConverter.isBufferSource(e[0]))super(e[0]);else if(typeof e[0]=="string"){let t=new bi({keyIdentifier:new ol(Y.Convert.FromHex(e[0]))});super(e4,e[1],ee.serialize(t))}else{let t=e[0],n=t.name instanceof As?ee.parse(t.name.rawData,Tt):t.name,o=new bi({authorityCertIssuer:n,authorityCertSerialNumber:Y.Convert.FromHex(t.serialNumber)});super(e4,e[1],ee.serialize(o))}}onInit(e){super.onInit(e);let t=ee.parse(e.extnValue,bi);t.keyIdentifier&&(this.keyId=Y.Convert.ToHex(t.keyIdentifier)),(t.authorityCertIssuer||t.authorityCertSerialNumber)&&(this.certId={name:t.authorityCertIssuer||[],serialNumber:t.authorityCertSerialNumber?Y.Convert.ToHex(t.authorityCertSerialNumber):""})}toTextObject(){let e=this.toTextObjectWithoutValue(),t=ee.parse(this.value,bi);return t.authorityCertIssuer&&(e["Authority Issuer"]=new As(t.authorityCertIssuer).toTextObject()),t.authorityCertSerialNumber&&(e["Authority Serial Number"]=t.authorityCertSerialNumber),t.keyIdentifier&&(e[""]=t.keyIdentifier),e}};H4.NAME="Authority Key Identifier";var Zf=class extends qn{constructor(...e){if(Y.BufferSourceConverter.isBufferSource(e[0])){super(e[0]);let t=ee.parse(this.value,il);this.ca=t.cA,this.pathLength=t.pathLenConstraint}else{let t=new il({cA:e[0],pathLenConstraint:e[1]});super(t4,e[2],ee.serialize(t)),this.ca=e[0],this.pathLength=e[1]}}toTextObject(){let e=this.toTextObjectWithoutValue();return this.ca&&(e.CA=this.ca),this.pathLength!==void 0&&(e["Path Length"]=this.pathLength),e}};Zf.NAME="Basic Constraints";var KD;(function(r){r.serverAuth="1.3.6.1.5.5.7.3.1",r.clientAuth="1.3.6.1.5.5.7.3.2",r.codeSigning="1.3.6.1.5.5.7.3.3",r.emailProtection="1.3.6.1.5.5.7.3.4",r.timeStamping="1.3.6.1.5.5.7.3.8",r.ocspSigning="1.3.6.1.5.5.7.3.9"})(KD||(KD={}));var q4=class extends qn{constructor(...e){if(Y.BufferSourceConverter.isBufferSource(e[0])){super(e[0]);let t=ee.parse(this.value,qp);this.usages=t.map(n=>n)}else{let t=new qp(e[0]);super(i4,e[1],ee.serialize(t)),this.usages=e[0]}}toTextObject(){let e=this.toTextObjectWithoutValue();return e[""]=this.usages.map(t=>Ci.toString(t)).join(", "),e}};q4.NAME="Extended Key Usages";var VD;(function(r){r[r.digitalSignature=1]="digitalSignature",r[r.nonRepudiation=2]="nonRepudiation",r[r.keyEncipherment=4]="keyEncipherment",r[r.dataEncipherment=8]="dataEncipherment",r[r.keyAgreement=16]="keyAgreement",r[r.keyCertSign=32]="keyCertSign",r[r.cRLSign=64]="cRLSign",r[r.encipherOnly=128]="encipherOnly",r[r.decipherOnly=256]="decipherOnly"})(VD||(VD={}));var W4=class extends qn{constructor(...e){if(Y.BufferSourceConverter.isBufferSource(e[0])){super(e[0]);let t=ee.parse(this.value,vf);this.usages=t.toNumber()}else{let t=new vf(e[0]);super(s4,e[1],ee.serialize(t)),this.usages=e[0]}}toTextObject(){let e=this.toTextObjectWithoutValue(),t=ee.parse(this.value,vf);return e[""]=t.toJSON().join(", "),e}};W4.NAME="Key Usages";var z4=class r extends qn{static async create(e,t=!1,n=hr.get()){let i=await(await Ss.create(e,n)).getKeyIdentifier(n);return new r(Y.Convert.ToHex(i),t)}constructor(...e){if(Y.BufferSourceConverter.isBufferSource(e[0])){super(e[0]);let t=ee.parse(this.value,yn);this.keyId=Y.Convert.ToHex(t)}else{let t=typeof e[0]=="string"?Y.Convert.FromHex(e[0]):e[0],n=new yn(t);super(v9,e[1],ee.serialize(n)),this.keyId=Y.Convert.ToHex(t)}}toTextObject(){let e=this.toTextObjectWithoutValue(),t=ee.parse(this.value,yn);return e[""]=t,e}};z4.NAME="Subject Key Identifier";var G4=class extends qn{constructor(...e){Y.BufferSourceConverter.isBufferSource(e[0])?super(e[0]):super(w9,e[1],new As(e[0]||[]).rawData)}onInit(e){super.onInit(e);let t=ee.parse(e.extnValue,u4);this.names=new As(t)}toTextObject(){let e=this.toTextObjectWithoutValue(),t=this.names.toTextObject();for(let n in t)e[n]=t[n];return e}};G4.NAME="Subject Alternative Name";var nn=class{static register(e,t){this.items.set(e,t)}static create(e){let t=new qn(e),n=this.items.get(t.type);return n?new n(e):t}};nn.items=new Map;var X4=class extends qn{constructor(...e){var t;if(Y.BufferSourceConverter.isBufferSource(e[0])){super(e[0]);let n=ee.parse(this.value,$p);this.policies=n.map(o=>o.policyIdentifier)}else{let n=e[0],o=(t=e[1])!==null&&t!==void 0?t:!1,i=new $p(n.map(s=>new sl({policyIdentifier:s})));super(n4,o,ee.serialize(i)),this.policies=n}}toTextObject(){let e=this.toTextObjectWithoutValue();return e.Policy=this.policies.map(t=>new Ge("",{},Ci.toString(t))),e}};X4.NAME="Certificate Policies";nn.register(n4,X4);var Y4=class extends qn{constructor(...e){var t;if(Y.BufferSourceConverter.isBufferSource(e[0]))super(e[0]);else if(Array.isArray(e[0])&&typeof e[0][0]=="string"){let o=e[0].map(s=>new vi({distributionPoint:new gs({fullName:[new Se({uniformResourceIdentifier:s})]})})),i=new Sa(o);super(o4,e[1],ee.serialize(i))}else{let n=new Sa(e[0]);super(o4,e[1],ee.serialize(n))}(t=this.distributionPoints)!==null&&t!==void 0||(this.distributionPoints=[])}onInit(e){super.onInit(e);let t=ee.parse(e.extnValue,Sa);this.distributionPoints=t}toTextObject(){let e=this.toTextObjectWithoutValue();return e["Distribution Point"]=this.distributionPoints.map(t=>{var n;let o={};return t.distributionPoint&&(o[""]=(n=t.distributionPoint.fullName)===null||n===void 0?void 0:n.map(i=>new Ii(i).toString()).join(", ")),t.reasons&&(o.Reasons=t.reasons.toString()),t.cRLIssuer&&(o["CRL Issuer"]=t.cRLIssuer.map(i=>i.toString()).join(", ")),o}),e}};Y4.NAME="CRL Distribution Points";var Q4=class extends qn{constructor(...e){var t,n,o,i;if(Y.BufferSourceConverter.isBufferSource(e[0]))super(e[0]);else if(e[0]instanceof nl){let s=new nl(e[0]);super(J3,e[1],ee.serialize(s))}else{let s=e[0],a=new nl;$4(a,s,t9,"ocsp"),$4(a,s,r9,"caIssuers"),$4(a,s,n9,"timeStamping"),$4(a,s,o9,"caRepository"),super(J3,e[1],ee.serialize(a))}(t=this.ocsp)!==null&&t!==void 0||(this.ocsp=[]),(n=this.caIssuers)!==null&&n!==void 0||(this.caIssuers=[]),(o=this.timeStamping)!==null&&o!==void 0||(this.timeStamping=[]),(i=this.caRepository)!==null&&i!==void 0||(this.caRepository=[])}onInit(e){super.onInit(e),this.ocsp=[],this.caIssuers=[],this.timeStamping=[],this.caRepository=[],ee.parse(e.extnValue,nl).forEach(n=>{switch(n.accessMethod){case t9:this.ocsp.push(new Ii(n.accessLocation));break;case r9:this.caIssuers.push(new Ii(n.accessLocation));break;case n9:this.timeStamping.push(new Ii(n.accessLocation));break;case o9:this.caRepository.push(new Ii(n.accessLocation));break}})}toTextObject(){let e=this.toTextObjectWithoutValue();return this.ocsp.length&&F4(e,"OCSP",this.ocsp),this.caIssuers.length&&F4(e,"CA Issuers",this.caIssuers),this.timeStamping.length&&F4(e,"Time Stamping",this.timeStamping),this.caRepository.length&&F4(e,"CA Repository",this.caRepository),e}};Q4.NAME="Authority Info Access";function F4(r,e,t){if(t.length===1)r[e]=t[0].toTextObject();else{let n=new Ge("");t.forEach((o,i)=>{let s=o.toTextObject(),a=`${s[Ge.NAME]} ${i+1}`,c=n[a];Array.isArray(c)||(c=[],n[a]=c),c.push(s)}),r[e]=n}}function $4(r,e,t,n){let o=e[n];o&&(Array.isArray(o)?o:[o]).forEach(s=>{typeof s=="string"&&(s=new Ii("url",s)),r.push(new ps({accessMethod:t,accessLocation:ee.parse(s.rawData,Se)}))})}var Z4=class extends qn{constructor(...e){Y.BufferSourceConverter.isBufferSource(e[0])?super(e[0]):super(p9,e[1],new As(e[0]||[]).rawData)}onInit(e){super.onInit(e);let t=ee.parse(e.extnValue,Tt);this.names=new As(t)}toTextObject(){let e=this.toTextObjectWithoutValue(),t=this.names.toTextObject();for(let n in t)e[n]=t[n];return e}};Z4.NAME="Issuer Alternative Name";var Jf=class r extends Ua{constructor(...e){let t;if(Y.BufferSourceConverter.isBufferSource(e[0]))t=Y.BufferSourceConverter.toArrayBuffer(e[0]);else{let n=e[0],o=Array.isArray(e[1])?e[1].map(i=>Y.BufferSourceConverter.toArrayBuffer(i)):[];t=ee.serialize(new Tr({type:n,values:o}))}super(t,Tr)}onInit(e){this.type=e.type,this.values=e.values}toTextObject(){let e=this.toTextObjectWithoutValue();return e.Value=this.values.map(t=>new Ge("",{"":t})),e}toTextObjectWithoutValue(){let e=this.toTextObjectEmpty();return e[Ge.NAME]===r.NAME&&(e[Ge.NAME]=Ci.toString(this.type)),e}};Jf.NAME="Attribute";var J4=class extends Jf{constructor(...e){var t;if(Y.BufferSourceConverter.isBufferSource(e[0]))super(e[0]);else{let n=new E1({printableString:e[0]});super(mv,[ee.serialize(n)])}(t=this.password)!==null&&t!==void 0||(this.password="")}onInit(e){if(super.onInit(e),this.values[0]){let t=ee.parse(this.values[0],E1);this.password=t.toString()}}toTextObject(){let e=this.toTextObjectWithoutValue();return e[Ge.VALUE]=this.password,e}};J4.NAME="Challenge Password";var X1=class extends Jf{constructor(...e){var t;if(Y.BufferSourceConverter.isBufferSource(e[0]))super(e[0]);else{let n=e[0],o=new Vn;for(let i of n)o.push(ee.parse(i.rawData,Cr));super(_1,[ee.serialize(o)])}(t=this.items)!==null&&t!==void 0||(this.items=[])}onInit(e){if(super.onInit(e),this.values[0]){let t=ee.parse(this.values[0],Vn);this.items=t.map(n=>nn.create(ee.serialize(n)))}}toTextObject(){let e=this.toTextObjectWithoutValue(),t=this.items.map(n=>n.toTextObject());for(let n of t)e[n[Ge.NAME]]=n;return e}};X1.NAME="Extensions";var ed=class{static register(e,t){this.items.set(e,t)}static create(e){let t=new Jf(e),n=this.items.get(t.type);return n?new n(e):t}};ed.items=new Map;var Q1="crypto.signatureFormatter",Cv=class{toAsnSignature(e,t){return Y.BufferSourceConverter.toArrayBuffer(t)}toWebSignature(e,t){return Y.BufferSourceConverter.toArrayBuffer(t)}},K4,Pv=K4=class{static createPssParams(e,t){let n=K4.getHashAlgorithm(e);return n?new Ai({hashAlgorithm:n,maskGenAlgorithm:new X({algorithm:Oa,parameters:ee.serialize(n)}),saltLength:t}):null}static getHashAlgorithm(e){let t=xt.resolve(Dl);return typeof e=="string"?t.toAsnAlgorithm({name:e}):typeof e=="object"&&e&&"name"in e?t.toAsnAlgorithm(e):null}toAsnAlgorithm(e){switch(e.name.toLowerCase()){case"rsassa-pkcs1-v1_5":if("hash"in e){let t;if(typeof e.hash=="string")t=e.hash;else if(e.hash&&typeof e.hash=="object"&&"name"in e.hash&&typeof e.hash.name=="string")t=e.hash.name.toUpperCase();else throw new Error("Cannot get hash algorithm name");switch(t.toLowerCase()){case"sha-1":return new X({algorithm:Mf,parameters:null});case"sha-256":return new X({algorithm:E4,parameters:null});case"sha-384":return new X({algorithm:Uf,parameters:null});case"sha-512":return new X({algorithm:Ff,parameters:null})}}else return new X({algorithm:_i,parameters:null});break;case"rsa-pss":if("hash"in e){if(!("saltLength"in e&&typeof e.saltLength=="number"))throw new Error("Cannot get 'saltLength' from 'alg' argument");let t=K4.createPssParams(e.hash,e.saltLength);if(!t)throw new Error("Cannot create PSS parameters");return new X({algorithm:ka,parameters:ee.serialize(t)})}else return new X({algorithm:ka,parameters:null})}return null}toWebAlgorithm(e){switch(e.algorithm){case _i:return{name:"RSASSA-PKCS1-v1_5"};case Mf:return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-1"}};case E4:return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}};case Uf:return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-384"}};case Ff:return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-512"}};case ka:if(e.parameters){let t=ee.parse(e.parameters,Ai);return{name:"RSA-PSS",hash:xt.resolve(Dl).toWebAlgorithm(t.hashAlgorithm),saltLength:t.saltLength}}else return{name:"RSA-PSS"}}return null}};Pv=K4=Xp([Da()],Pv);xt.registerSingleton(Y1,Pv);var kv=class{toAsnAlgorithm(e){switch(e.name.toLowerCase()){case"sha-1":return new X({algorithm:Sl});case"sha-256":return new X({algorithm:_l});case"sha-384":return new X({algorithm:Al});case"sha-512":return new X({algorithm:Tl})}return null}toWebAlgorithm(e){switch(e.algorithm){case Sl:return{name:"SHA-1"};case _l:return{name:"SHA-256"};case Al:return{name:"SHA-384"};case Tl:return{name:"SHA-512"}}return null}};kv=Xp([Da()],kv);xt.registerSingleton(Y1,kv);var Ts=class r{addPadding(e,t){let n=Y.BufferSourceConverter.toUint8Array(t),o=new Uint8Array(e);return o.set(n,e-n.length),o.buffer}removePadding(e,t=!1){let n=Y.BufferSourceConverter.toUint8Array(e);for(let o=0;o<n.length;o++)if(n[o]){n=n.slice(o);break}if(t&&n[0]>127){let o=new Uint8Array(n.length+1);return o.set(n,1),o.buffer}return n.buffer}toAsnSignature(e,t){if(e.name==="ECDSA"){let n=e.namedCurve,o=r.namedCurveSize.get(n)||r.defaultNamedCurveSize,i=new El,s=Y.BufferSourceConverter.toUint8Array(t);return i.r=this.removePadding(s.slice(0,o),!0),i.s=this.removePadding(s.slice(o,o+o),!0),ee.serialize(i)}return null}toWebSignature(e,t){if(e.name==="ECDSA"){let n=ee.parse(t,El),o=e.namedCurve,i=r.namedCurveSize.get(o)||r.defaultNamedCurveSize,s=this.addPadding(i,this.removePadding(n.r)),a=this.addPadding(i,this.removePadding(n.s));return(0,Y.combine)(s,a)}return null}};Ts.namedCurveSize=new Map;Ts.defaultNamedCurveSize=32;var _v="1.3.101.110",HD="1.3.101.111",Av="1.3.101.112",qD="1.3.101.113",Ov=class{toAsnAlgorithm(e){let t=null;switch(e.name.toLowerCase()){case"ed25519":t=Av;break;case"x25519":t=_v;break;case"eddsa":switch(e.namedCurve.toLowerCase()){case"ed25519":t=Av;break;case"ed448":t=qD;break}break;case"ecdh-es":switch(e.namedCurve.toLowerCase()){case"x25519":t=_v;break;case"x448":t=HD;break}}return t?new X({algorithm:t}):null}toWebAlgorithm(e){switch(e.algorithm){case Av:return{name:"Ed25519"};case qD:return{name:"EdDSA",namedCurve:"Ed448"};case _v:return{name:"X25519"};case HD:return{name:"ECDH-ES",namedCurve:"X448"}}return null}};Ov=Xp([Da()],Ov);xt.registerSingleton(Y1,Ov);var I1,C1,P1,k1,O1,R1,D1,Xf,Rv=class extends Fa{get subjectName(){return Ne(this,C1,"f")||It(this,C1,new zo(this.asn.certificationRequestInfo.subject),"f"),Ne(this,C1,"f")}get subject(){return Ne(this,P1,"f")||It(this,P1,this.subjectName.toString(),"f"),Ne(this,P1,"f")}get signatureAlgorithm(){if(!Ne(this,k1,"f")){let e=xt.resolve(Dl);It(this,k1,e.toWebAlgorithm(this.asn.signatureAlgorithm),"f")}return Ne(this,k1,"f")}get signature(){return Ne(this,O1,"f")||It(this,O1,this.asn.signature,"f"),Ne(this,O1,"f")}get publicKey(){return Ne(this,R1,"f")||It(this,R1,new Ss(this.asn.certificationRequestInfo.subjectPKInfo),"f"),Ne(this,R1,"f")}get attributes(){return Ne(this,D1,"f")||It(this,D1,this.asn.certificationRequestInfo.attributes.map(e=>ed.create(ee.serialize(e))),"f"),Ne(this,D1,"f")}get extensions(){if(!Ne(this,Xf,"f")){It(this,Xf,[],"f");let e=this.getAttribute(_1);e instanceof X1&&It(this,Xf,e.items,"f")}return Ne(this,Xf,"f")}get tbs(){return Ne(this,I1,"f")||It(this,I1,this.asn.certificationRequestInfoRaw||ee.serialize(this.asn.certificationRequestInfo),"f"),Ne(this,I1,"f")}constructor(e){let t=Fa.isAsnEncoded(e)?[e,Ma]:[e];super(t[0],t[1]),I1.set(this,void 0),C1.set(this,void 0),P1.set(this,void 0),k1.set(this,void 0),O1.set(this,void 0),R1.set(this,void 0),D1.set(this,void 0),Xf.set(this,void 0),this.tag=rn.CertificateRequestTag}onInit(e){}getAttribute(e){for(let t of this.attributes)if(t.type===e)return t;return null}getAttributes(e){return this.attributes.filter(t=>t.type===e)}getExtension(e){for(let t of this.extensions)if(t.type===e)return t;return null}getExtensions(e){return this.extensions.filter(t=>t.type===e)}async verify(e=hr.get()){let t={...this.publicKey.algorithm,...this.signatureAlgorithm},n=await this.publicKey.export(t,["verify"],e),o=xt.resolveAll(Q1).reverse(),i=null;for(let a of o)if(i=a.toWebSignature(t,this.signature),i)break;if(!i)throw Error("Cannot convert WebCrypto signature value to ASN.1 format");return await e.subtle.verify(this.signatureAlgorithm,n,i,this.tbs)}toTextObject(){let e=this.toTextObjectEmpty(),t=ee.parse(this.rawData,Ma),n=t.certificationRequestInfo,o=new Ge("",{Version:`${xi[n.version]} (${n.version})`,Subject:this.subject,"Subject Public Key Info":this.publicKey});if(this.attributes.length){let i=new Ge("");for(let s of this.attributes){let a=s.toTextObject();i[a[Ge.NAME]]=a}o.Attributes=i}return e.Data=o,e.Signature=new Ge("",{Algorithm:_s.serializeAlgorithm(t.signatureAlgorithm),"":t.signature}),e}};I1=new WeakMap,C1=new WeakMap,P1=new WeakMap,k1=new WeakMap,O1=new WeakMap,R1=new WeakMap,D1=new WeakMap,Xf=new WeakMap;Rv.NAME="PKCS#10 Certificate Request";var N1,L1,B1,M1,U1,F1,$1,j1,K1,V1,Yf,H1,td=class extends Fa{get publicKey(){return Ne(this,H1,"f")||It(this,H1,new Ss(this.asn.tbsCertificate.subjectPublicKeyInfo),"f"),Ne(this,H1,"f")}get serialNumber(){if(!Ne(this,L1,"f")){let e=this.asn.tbsCertificate,t=new Uint8Array(e.serialNumber);t.length>1&&t[0]===0&&t[1]>127&&(t=t.slice(1)),It(this,L1,Y.Convert.ToHex(t),"f")}return Ne(this,L1,"f")}get subjectName(){return Ne(this,B1,"f")||It(this,B1,new zo(this.asn.tbsCertificate.subject),"f"),Ne(this,B1,"f")}get subject(){return Ne(this,M1,"f")||It(this,M1,this.subjectName.toString(),"f"),Ne(this,M1,"f")}get issuerName(){return Ne(this,U1,"f")||It(this,U1,new zo(this.asn.tbsCertificate.issuer),"f"),Ne(this,U1,"f")}get issuer(){return Ne(this,F1,"f")||It(this,F1,this.issuerName.toString(),"f"),Ne(this,F1,"f")}get notBefore(){if(!Ne(this,$1,"f")){let e=this.asn.tbsCertificate.validity.notBefore.utcTime||this.asn.tbsCertificate.validity.notBefore.generalTime;if(!e)throw new Error("Cannot get 'notBefore' value");It(this,$1,e,"f")}return Ne(this,$1,"f")}get notAfter(){if(!Ne(this,j1,"f")){let e=this.asn.tbsCertificate.validity.notAfter.utcTime||this.asn.tbsCertificate.validity.notAfter.generalTime;if(!e)throw new Error("Cannot get 'notAfter' value");It(this,j1,e,"f")}return Ne(this,j1,"f")}get signatureAlgorithm(){if(!Ne(this,K1,"f")){let e=xt.resolve(Dl);It(this,K1,e.toWebAlgorithm(this.asn.signatureAlgorithm),"f")}return Ne(this,K1,"f")}get signature(){return Ne(this,V1,"f")||It(this,V1,this.asn.signatureValue,"f"),Ne(this,V1,"f")}get extensions(){return Ne(this,Yf,"f")||(It(this,Yf,[],"f"),this.asn.tbsCertificate.extensions&&It(this,Yf,this.asn.tbsCertificate.extensions.map(e=>nn.create(ee.serialize(e))),"f")),Ne(this,Yf,"f")}get tbs(){return Ne(this,N1,"f")||It(this,N1,this.asn.tbsCertificateRaw||ee.serialize(this.asn.tbsCertificate),"f"),Ne(this,N1,"f")}constructor(e){let t=Fa.isAsnEncoded(e)?[e,lo]:[e];super(t[0],t[1]),N1.set(this,void 0),L1.set(this,void 0),B1.set(this,void 0),M1.set(this,void 0),U1.set(this,void 0),F1.set(this,void 0),$1.set(this,void 0),j1.set(this,void 0),K1.set(this,void 0),V1.set(this,void 0),Yf.set(this,void 0),H1.set(this,void 0),this.tag=rn.CertificateTag}onInit(e){}getExtension(e){for(let t of this.extensions)if(typeof e=="string"){if(t.type===e)return t}else if(t instanceof e)return t;return null}getExtensions(e){return this.extensions.filter(t=>typeof e=="string"?t.type===e:t instanceof e)}async verify(e={},t=hr.get()){let n,o,i=e.publicKey;try{if(!i)n={...this.publicKey.algorithm,...this.signatureAlgorithm},o=await this.publicKey.export(n,["verify"],t);else if("publicKey"in i)n={...i.publicKey.algorithm,...this.signatureAlgorithm},o=await i.publicKey.export(n,["verify"],t);else if(i instanceof Ss)n={...i.algorithm,...this.signatureAlgorithm},o=await i.export(n,["verify"],t);else if(Y.BufferSourceConverter.isBufferSource(i)){let l=new Ss(i);n={...l.algorithm,...this.signatureAlgorithm},o=await l.export(n,["verify"],t)}else n={...i.algorithm,...this.signatureAlgorithm},o=i}catch{return!1}let s=xt.resolveAll(Q1).reverse(),a=null;for(let l of s)if(a=l.toWebSignature(n,this.signature),a)break;if(!a)throw Error("Cannot convert ASN.1 signature value to WebCrypto format");let c=await t.subtle.verify(this.signatureAlgorithm,o,a,this.tbs);if(e.signatureOnly)return c;{let f=(e.date||new Date).getTime();return c&&this.notBefore.getTime()<f&&f<this.notAfter.getTime()}}async getThumbprint(...e){let t,n="SHA-1";return e[0]&&(e[0].subtle?t=e[0]:(n=e[0]||n,t=e[1])),t??(t=hr.get()),await t.subtle.digest(n,this.rawData)}async isSelfSigned(e=hr.get()){return this.subject===this.issuer&&await this.verify({signatureOnly:!0},e)}toTextObject(){let e=this.toTextObjectEmpty(),t=ee.parse(this.rawData,lo),n=t.tbsCertificate,o=new Ge("",{Version:`${xi[n.version]} (${n.version})`,"Serial Number":n.serialNumber,"Signature Algorithm":_s.serializeAlgorithm(n.signature),Issuer:this.issuer,Validity:new Ge("",{"Not Before":n.validity.notBefore.getTime(),"Not After":n.validity.notAfter.getTime()}),Subject:this.subject,"Subject Public Key Info":this.publicKey});if(n.issuerUniqueID&&(o["Issuer Unique ID"]=n.issuerUniqueID),n.subjectUniqueID&&(o["Subject Unique ID"]=n.subjectUniqueID),this.extensions.length){let i=new Ge("");for(let s of this.extensions){let a=s.toTextObject();i[a[Ge.NAME]]=a}o.Extensions=i}return e.Data=o,e.Signature=new Ge("",{Algorithm:_s.serializeAlgorithm(t.signatureAlgorithm),"":t.signatureValue}),e}};N1=new WeakMap,L1=new WeakMap,B1=new WeakMap,M1=new WeakMap,U1=new WeakMap,F1=new WeakMap,$1=new WeakMap,j1=new WeakMap,K1=new WeakMap,V1=new WeakMap,Yf=new WeakMap,H1=new WeakMap;td.NAME="Certificate";function kW(r,e=hr.get()){let t=Y.BufferSourceConverter.toUint8Array(Y.Convert.FromHex(r||"")),n=t&&t.length&&t.some(i=>i>0)?new Uint8Array(t):void 0;n||(n=e.getRandomValues(new Uint8Array(16)));let o=0;for(;o<n.length-1&&n[o]===0;)o++;if(n=n.slice(o),n[0]>127){let i=new Uint8Array(n.length+1);i[0]=0,i.set(n,1),n=i}return n.buffer}var e6=class{static async createSelfSigned(e,t=hr.get()){if(!e.keys.privateKey)throw new Error("Bad field 'keys' in 'params' argument. 'privateKey' is empty");if(!e.keys.publicKey)throw new Error("Bad field 'keys' in 'params' argument. 'publicKey' is empty");return this.create({serialNumber:e.serialNumber,subject:e.name,issuer:e.name,notBefore:e.notBefore,notAfter:e.notAfter,publicKey:e.keys.publicKey,signingKey:e.keys.privateKey,signingAlgorithm:e.signingAlgorithm,extensions:e.extensions},t)}static async create(e,t=hr.get()){var n;let o;e.publicKey instanceof Ss?o=e.publicKey.rawData:"publicKey"in e.publicKey?o=e.publicKey.publicKey.rawData:Y.BufferSourceConverter.isBufferSource(e.publicKey)?o=e.publicKey:o=await t.subtle.exportKey("spki",e.publicKey);let i=kW(e.serialNumber,t),s=e.notBefore||new Date,a=e.notAfter||new Date(s.getTime()+31536e6),c=new lo({tbsCertificate:new Pr({version:xi.v3,serialNumber:i,validity:new ys({notBefore:s,notAfter:a}),extensions:new Vn(((n=e.extensions)===null||n===void 0?void 0:n.map(y=>ee.parse(y.rawData,Cr)))||[]),subjectPublicKeyInfo:ee.parse(o,Ir)})});if(e.subject){let y=e.subject instanceof zo?e.subject:new zo(e.subject);c.tbsCertificate.subject=ee.parse(y.toArrayBuffer(),pt)}if(e.issuer){let y=e.issuer instanceof zo?e.issuer:new zo(e.issuer);c.tbsCertificate.issuer=ee.parse(y.toArrayBuffer(),pt)}let l={hash:"SHA-256"},f="signingKey"in e?{...l,...e.signingAlgorithm,...e.signingKey.algorithm}:{...l,...e.signingAlgorithm},u=xt.resolve(Dl);c.tbsCertificate.signature=c.signatureAlgorithm=u.toAsnAlgorithm(f);let d=ee.serialize(c.tbsCertificate),h="signingKey"in e?await t.subtle.sign(f,e.signingKey,d):e.signature,m=xt.resolveAll(Q1).reverse(),w=null;for(let y of m)if(w=y.toAsnSignature(f,h),w)break;if(!w)throw Error("Cannot convert ASN.1 signature value to WebCrypto format");return c.signatureValue=w,new td(ee.serialize(c))}},OW,RW,DW,NW,LW,WD;(function(r){r[r.unspecified=0]="unspecified",r[r.keyCompromise=1]="keyCompromise",r[r.cACompromise=2]="cACompromise",r[r.affiliationChanged=3]="affiliationChanged",r[r.superseded=4]="superseded",r[r.cessationOfOperation=5]="cessationOfOperation",r[r.certificateHold=6]="certificateHold",r[r.removeFromCRL=8]="removeFromCRL",r[r.privilegeWithdrawn=9]="privilegeWithdrawn",r[r.aACompromise=10]="aACompromise"})(WD||(WD={}));OW=new WeakMap,RW=new WeakMap,DW=new WeakMap,NW=new WeakMap,LW=new WeakMap;var BW,MW,UW,FW,$W,jW,KW;BW=new WeakMap,MW=new WeakMap,UW=new WeakMap,FW=new WeakMap,$W=new WeakMap,jW=new WeakMap,KW=new WeakMap;nn.register(t4,Zf);nn.register(i4,q4);nn.register(s4,W4);nn.register(v9,z4);nn.register(e4,H4);nn.register(w9,G4);nn.register(o4,Y4);nn.register(J3,Q4);nn.register(p9,Z4);ed.register(mv,J4);ed.register(_1,X1);xt.registerSingleton(Q1,Cv);xt.registerSingleton(Q1,Ts);Ts.namedCurveSize.set("P-256",32);Ts.namedCurveSize.set("K-256",32);Ts.namedCurveSize.set("P-384",48);Ts.namedCurveSize.set("P-521",66);var t6=class extends _e{async listen(){throw new q3("WebRTCTransport.createListener")}getAddrs(){return[]}updateAnnounceAddrs(){}async close(){}};var Dv=Object.values(Ya).map(r=>r.decoder).reduce((r,e)=>r.or(e)),VW=/^a=fingerprint:(?:\w+-[0-9]+)\s(?<fingerprint>(:?[0-9a-fA-F]{2})+)$/m;function QD(r){return r?.match(VW)?.groups?.fingerprint}function Nv(r){let t=r.getComponents().find(n=>n.code===466)?.value;if(t===void 0||t==="")throw new P(`Couldn't find a certhash component of multiaddr: ${r.toString()}`);return t}function HW(r){return Bt.decode(Dv.decode(r))}function qW(r){let e=HW(Nv(r)),t=WW(e.code),n=e.digest.reduce((i,s)=>i+s.toString(16).padStart(2,"0"),""),o=n.match(/.{1,2}/g);if(o==null)throw new H3(n,r.toString());return`${t} ${o.join(":").toUpperCase()}`}function ZD(r){let e=r.split(":").map(o=>parseInt(o,16)),t=Uint8Array.from(e),n=Wr(St.code,t);return ie(`/certhash/${qa.encode(n.bytes)}`)}function WW(r){switch(r){case 17:return"sha-1";case 18:return"sha-256";case 19:return"sha-512";default:throw new W3(r)}}function JD(r,e){let{host:t,port:n,type:o}=Ce(r);if(o!=="ip4"&&o!=="ip6")throw new P(`Multiaddr ${r} was not an IPv4 or IPv6 address`);let i=qW(r);return{type:"answer",sdp:`v=0
o=- 0 0 IN IP${o==="ip4"?4:6} ${t}
s=-
t=0 0
a=ice-lite
m=application ${n} UDP/DTLS/SCTP webrtc-datachannel
c=IN IP${o==="ip4"?4:6} ${t}
a=mid:0
a=ice-options:ice2
a=ice-ufrag:${e}
a=ice-pwd:${e}
a=fingerprint:${i}
a=setup:passive
a=sctp-port:5000
a=max-message-size:${yf}
a=candidate:1467250027 1 UDP 1467250027 ${t} ${n} typ host
a=end-of-candidates
`}}function eN(r,e){let{host:t,port:n,type:o}=Ce(r);if(o!=="ip4"&&o!=="ip6")throw new P(`Multiaddr ${r} was not an IPv4 or IPv6 address`);return{type:"offer",sdp:`v=0
o=- 0 0 IN IP${o==="ip4"?4:6} ${t}
s=-
c=IN IP${o==="ip4"?4:6} ${t}
t=0 0
a=ice-options:ice2,trickle
m=application ${n} UDP/DTLS/SCTP webrtc-datachannel
a=mid:0
a=setup:active
a=ice-ufrag:${e}
a=ice-pwd:${e}
a=fingerprint:sha-256 00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00
a=sctp-port:5000
a=max-message-size:${yf}
a=candidate:1467250027 1 UDP 1467250027 ${t} ${n} typ host
a=end-of-candidates
`}}function Lv(r,e){if(r.sdp===void 0)throw new P("Can't munge a missing SDP");let t=r.sdp.includes(`\r
`)?`\r
`:`
`;try{r.sdp=r.sdp.replace(/\na=ice-ufrag:[^\n]*\n/,`
a=ice-ufrag:`+e+t).replace(/\na=ice-pwd:[^\n]*\n/,`
a=ice-pwd:`+e+t)}catch{}return r}var Bv=B("libp2p-webrtc-noise:");function rN(r,e,t){let n=r.trim().toLowerCase().replaceAll(":",""),o=B(n,"hex"),i=Wr(St.code,o),s=Dv.decode(Nv(e)),a=Bv.byteLength+i.bytes.byteLength+s.byteLength;return t==="server"?gt([Bv,s,i.bytes],a):gt([Bv,i.bytes,s],a)}var zW=j3?"iceconnectionstatechange":"connectionstatechange";function GW(r,e){return r.role==="server"}async function nN(r,e,t,n){let o=r.createDataChannel("",{negotiated:!0,id:0});try{if(n.role==="client"){n.log.trace("client creating local offer");let u=await r.createOffer();n.log.trace("client created local offer %s",u.sdp);let d=Lv(u,t);n.log.trace("client setting local offer %s",d.sdp),await r.setLocalDescription(d);let h=JD(n.remoteAddr,t);n.log.trace("client setting server description %s",h.sdp),await r.setRemoteDescription(h)}else{let u=eN(n.remoteAddr,t);n.log.trace("server setting client %s %s",u.type,u.sdp),await r.setRemoteDescription(u),n.log.trace("server creating local answer");let d=await r.createAnswer();n.log.trace("server created local answer");let h=Lv(d,t);n.log.trace("server setting local description %s",d.sdp),await r.setLocalDescription(h)}if(o.readyState!=="open"&&(n.log.trace("%s wait for handshake channel to open, starting status %s",n.role,o.readyState),await hs(o,"open",n)),n.log.trace("%s handshake channel opened",n.role),GW(n,r)){let u=r.remoteFingerprint()?.value??"";n.remoteAddr=n.remoteAddr.encapsulate(ZD(u))}let i=QD(r.localDescription?.sdp);if(i==null)throw new ga("Could not get fingerprint from local description sdp");n.log.trace("%s performing noise handshake",n.role);let s=rN(i,n.remoteAddr,n.role),a=py({prologueBytes:s})(n),c=Op({channel:o,direction:"outbound",isHandshake:!0,log:n.log,...n.dataChannel??{}}),l=Rp({peerConnection:r,remoteAddr:n.remoteAddr,metrics:n.events,direction:n.role==="client"?"outbound":"inbound",log:n.logger.forComponent("libp2p:webrtc-direct:connection")});if(r.addEventListener(zW,()=>{switch(r.connectionState){case"failed":case"disconnected":case"closed":l.close().catch(u=>{n.log.error("error closing connection - %e",u),l.abort(u)});break;default:break}}),n.events?.increment({peer_connection:!0}),n.role==="client"){n.log.trace("%s secure inbound",n.role);let u=await a.secureInbound(c,{remotePeer:n.remotePeer,signal:n.signal,skipStreamMuxerNegotiation:!0});return n.log.trace("%s upgrade outbound",n.role),await n.upgrader.upgradeOutbound(l,{skipProtection:!0,skipEncryption:!0,remotePeer:u.remotePeer,muxerFactory:e,signal:n.signal})}n.log.trace("%s secure outbound",n.role);let f=await a.secureOutbound(c,{remotePeer:n.remotePeer,signal:n.signal,skipStreamMuxerNegotiation:!0});l.remoteAddr=l.remoteAddr.encapsulate(`/p2p/${f.remotePeer}`),n.log.trace("%s upgrade inbound",n.role),await n.upgrader.upgradeInbound(l,{skipProtection:!0,skipEncryption:!0,remotePeer:f.remotePeer,muxerFactory:e,signal:n.signal})}catch(i){throw o.close(),r.close(),i}}async function oN(r,e,t={}){let n=t.certificate;n==null&&(n=await RTCPeerConnection.generateCertificate({name:"ECDSA",namedCurve:"P-256"}));let o=typeof t.rtcConfiguration=="function"?await t.rtcConfiguration():t.rtcConfiguration,i=new RTCPeerConnection({...o??{},certificates:[n]}),s=new ma({peerConnection:i,metrics:t.events,dataChannelOptions:t.dataChannel});return{peerConnection:i,muxerFactory:s}}async function iN(r){let e=await Fm(r),t=await crypto.subtle.exportKey("pkcs8",e.privateKey);return["-----BEGIN PRIVATE KEY-----",...j(new Uint8Array(t),"base64pad").split(/(.{64})/).filter(Boolean),"-----END PRIVATE KEY-----"].join(`
`)}var r6=class{log;metrics;components;init;certificate;privateKey;emitter;renewCertificateTask;constructor(e,t={}){if(this.log=e.logger.forComponent("libp2p:webrtc-direct"),this.components=e,this.init=t,this.emitter=new _e,t.certificateLifespan!=null&&t.certificateRenewalThreshold!=null&&t.certificateRenewalThreshold>=t.certificateLifespan)throw new P("Certificate renewal threshold must be less than certificate lifespan");e.metrics!=null&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_webrtc-direct_dialer_events_total",{label:"event",help:"Total count of WebRTC-direct dial events by type"})})}[Os]=!0;[Symbol.toStringTag]="@libp2p/webrtc-direct";[qe]=["@libp2p/transport"];async start(){this.certificate=await this.getCertificate()}async stop(){this.renewCertificateTask!=null&&clearTimeout(this.renewCertificateTask),this.certificate=void 0}async dial(e,t){this.log("dial %a",e),t.signal.throwIfAborted();let n,o=e.getComponents().findLast(c=>c.code===421)?.value;o!=null&&(n=yt(o));let i=mO(),{peerConnection:s,muxerFactory:a}=await oN("client",i,{rtcConfiguration:typeof this.init.rtcConfiguration=="function"?await this.init.rtcConfiguration():this.init.rtcConfiguration??{},dataChannel:this.init.dataChannel});try{return await nN(s,a,i,{role:"client",log:this.log,logger:this.components.logger,events:this.metrics?.dialerEvents,signal:t.signal,remoteAddr:e,dataChannel:this.init.dataChannel,upgrader:t.upgrader,peerId:this.components.peerId,remotePeer:n,privateKey:this.components.privateKey})}catch(c){throw s.close(),c}}createListener(e){if(this.certificate==null)throw new _n;return new t6(this.components,{...this.init,...e,certificate:this.certificate,emitter:this.emitter})}listenFilter(e){return e.filter(_h.exactMatch)}dialFilter(e){return this.listenFilter(e)}async getCertificate(e){if(XW(this.init.certificate))return this.log("using provided TLS certificate"),this.init.certificate;let t=await this.loadOrCreatePrivateKey(),{pem:n,certhash:o}=await this.loadOrCreateCertificate(t,e);return{privateKey:await iN(t),pem:n,certhash:o}}async loadOrCreatePrivateKey(){if(this.privateKey!=null)return this.privateKey;let e=this.init.certificateKeychainName??iO,t=this.getKeychain();try{if(t==null)throw this.log("no keychain configured - not checking for stored private key"),new Xe;this.log.trace("checking for stored private key"),this.privateKey=await t.exportKey(e)}catch(n){if(n.name!=="NotFoundError")throw n;this.log.trace("generating private key"),this.privateKey=await uu("ECDSA","P-256"),t!=null?(this.log.trace("storing private key"),await t.importKey(e,this.privateKey)):this.log("no keychain configured - not storing private key")}return this.privateKey}async loadOrCreateCertificate(e,t){if(this.certificate!=null&&t!==!0)return this.certificate;let n,o=new ht(this.init.certificateDatastoreKey??oO),i=await Fm(e);try{if(t===!0)throw this.log.trace("forcing renewal of TLS certificate"),new Xe;this.log.trace("checking for stored TLS certificate"),n=await this.loadCertificate(o,i)}catch(a){if(a.name!=="NotFoundError")throw a;this.log.trace("generating new TLS certificate"),n=await this.createCertificate(o,i)}let s=n.notAfter.getTime()-(this.init.certificateRenewalThreshold??Mb)-Date.now();return s<0&&(s=100),this.log("will renew TLS certificate after %d ms",s),this.renewCertificateTask=setTimeout(()=>{this.log("renewing TLS certificate"),this.getCertificate(!0).then(a=>{this.certificate=a,this.emitter.safeDispatchEvent("certificate:renew",{detail:a})}).catch(a=>{this.log.error("could not renew certificate - %e",a)})},s),{pem:n.toString("pem"),certhash:qa.encode((await St.digest(new Uint8Array(n.rawData))).bytes)}}async loadCertificate(e,t){let n=await this.components.datastore.get(e),o=new td(n),i=o.notAfter.getTime()-(this.init.certificateRenewalThreshold??Mb);if(Date.now()>i)throw this.log("stored TLS certificate has expired"),new Xe;this.log("loaded certificate, expires in %d ms",i);let s=await o.publicKey.export(crypto),a=await crypto.subtle.exportKey("raw",s),c=await crypto.subtle.exportKey("raw",t.publicKey);if(!we(new Uint8Array(a,0,a.byteLength),new Uint8Array(c,0,c.byteLength)))throw this.log("stored TLS certificate public key did not match public key from private key"),new Xe;return this.log("loaded certificate, expiry time is %o",i),o}async createCertificate(e,t){let n=new Date,o=new Date(Date.now()+(this.init.certificateLifespan??sO));n.setMilliseconds(0),o.setMilliseconds(0);let i=await e6.createSelfSigned({serialNumber:(BigInt(Math.random().toString().replace(".",""))*100000n).toString(16),name:"CN=example.com, C=US, L=CA, O=example, ST=CA",notBefore:n,notAfter:o,keys:t,extensions:[new Zf(!1,void 0,!0)]},crypto);return this.getKeychain()!=null?(this.log.trace("storing TLS certificate"),await this.components.datastore.put(e,B(i.toString("pem")))):this.log("no keychain is configured so not storing TLS certificate since the private key will not be reused"),i}getKeychain(){try{return this.components.keychain}catch{}}};function XW(r){return r==null?!1:typeof r.privateKey=="string"&&typeof r.pem=="string"&&typeof r.certhash=="string"}function sN(r){return e=>new r6(e,r)}function aN(r){return e=>new Y3(e,r)}var Mv=class extends Error{constructor(e){super(e),this.name="TimeoutError"}},Uv=class extends Error{constructor(e){super(),this.name="AbortError",this.message=e}},cN=r=>globalThis.DOMException===void 0?new Uv(r):new DOMException(r),lN=r=>{let e=r.reason===void 0?cN("This operation was aborted."):r.reason;return e instanceof Error?e:cN(e)};function Fv(r,e){let{milliseconds:t,fallback:n,message:o,customTimers:i={setTimeout,clearTimeout}}=e,s,a,l=new Promise((f,u)=>{if(typeof t!="number"||Math.sign(t)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${t}\``);if(e.signal){let{signal:h}=e;h.aborted&&u(lN(h)),a=()=>{u(lN(h))},h.addEventListener("abort",a,{once:!0})}if(t===Number.POSITIVE_INFINITY){r.then(f,u);return}let d=new Mv;s=i.setTimeout.call(void 0,()=>{if(n){try{f(n())}catch(h){u(h)}return}typeof r.cancel=="function"&&r.cancel(),o===!1?f():o instanceof Error?u(o):(d.message=o??`Promise timed out after ${t} milliseconds`,u(d))},t),(async()=>{try{f(await r)}catch(h){u(h)}})()}).finally(()=>{l.clear(),a&&e.signal&&e.signal.removeEventListener("abort",a)});return l.clear=()=>{i.clearTimeout.call(void 0,s),s=void 0},l}var YW=r=>{let e=r.addEventListener||r.on||r.addListener,t=r.removeEventListener||r.off||r.removeListener;if(!e||!t)throw new TypeError("Emitter is not compatible");return{addListener:e.bind(r),removeListener:t.bind(r)}};function QW(r,e,t){let n,o=new Promise((i,s)=>{if(t={rejectionEvents:["error"],multiArgs:!1,rejectionMultiArgs:!1,resolveImmediately:!1,...t},!(t.count>=0&&(t.count===Number.POSITIVE_INFINITY||Number.isInteger(t.count))))throw new TypeError("The `count` option should be at least 0 or more");t.signal?.throwIfAborted();let a=[e].flat(),c=[],{addListener:l,removeListener:f}=YW(r),u=async(...h)=>{let m=t.multiArgs?h:h[0];if(t.filter)try{if(!await t.filter(m))return}catch(w){n(),s(w);return}c.push(m),t.count===c.length&&(n(),i(c))},d=(...h)=>{n(),s(t.rejectionMultiArgs?h:h[0])};n=()=>{for(let h of a)f(h,u);for(let h of t.rejectionEvents)a.includes(h)||f(h,d)};for(let h of a)l(h,u);for(let h of t.rejectionEvents)a.includes(h)||l(h,d);t.signal&&t.signal.addEventListener("abort",()=>{d(t.signal.reason)},{once:!0}),t.resolveImmediately&&i(c)});if(o.cancel=n,typeof t.timeout=="number"){let i=Fv(o,{milliseconds:t.timeout});return i.cancel=()=>{n(),i.clear()},i}return o}function uN(r,e,t){typeof t=="function"&&(t={filter:t}),t={...t,count:1,resolveImmediately:!1};let n=QW(r,e,t),o=n.then(i=>i[0]);return o.cancel=n.cancel,o}function fN(){throw new Error("WebSocket Servers can not be created in the browser!")}var ZW=1024*1024*4,JW=10,$v=class extends Hs{websocket;maxBufferedAmount;checkBufferedAmountTask;constructor(e){super(e),this.websocket=e.websocket,this.maxBufferedAmount=e.maxBufferedAmount??ZW,this.checkBufferedAmountTask=Pu(this.checkBufferedAmount.bind(this),e.bufferedAmountPollInterval??JW),this.websocket.addEventListener("close",t=>{if(this.log('closed - code %d, reason "%s", wasClean %s',t.code,t.reason,t.wasClean),this.checkBufferedAmountTask.stop(),!t.wasClean){this.onRemoteReset();return}this.onTransportClosed()},{once:!0}),this.websocket.addEventListener("message",t=>{try{let n;if(typeof t.data=="string")n=B(t.data);else if(t.data instanceof ArrayBuffer)n=new Uint8Array(t.data,0,t.data.byteLength);else{this.abort(new Error("Incorrect binary type"));return}this.onData(n)}catch(n){this.log.error("error receiving data - %e",n)}})}sendData(e){for(let n of e)this.websocket.send(n);let t=this.websocket.bufferedAmount<this.maxBufferedAmount;return t||this.checkBufferedAmountTask.start(),{sentBytes:e.byteLength,canSendMore:t}}sendReset(){this.websocket.close(1006)}async sendClose(e){this.websocket.close(),e?.signal?.throwIfAborted()}sendPause(){}sendResume(){}checkBufferedAmount(){this.log("buffered amount now %d",this.websocket.bufferedAmount),this.websocket.bufferedAmount===0&&(this.checkBufferedAmountTask.stop(),this.safeDispatchEvent("drain"))}};function dN(r){return new $v(r)}var jv=class{log;init;logger;metrics;components;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:websockets"),this.logger=e.logger,this.components=e,this.init=t,e.metrics!=null&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_websockets_dialer_events_total",{label:"event",help:"Total count of WebSockets dialer events by type"})})}[Os]=!0;[Symbol.toStringTag]="@libp2p/websockets";[qe]=["@libp2p/transport"];async dial(e,t){this.log("dialing %s",e),t=t??{};let n=dN({websocket:await this._connect(e,t),remoteAddr:e,metrics:this.metrics?.dialerEvents,direction:"outbound",log:this.components.logger.forComponent("libp2p:websockets:connection"),maxBufferedAmount:this.init.maxBufferedAmount,bufferedAmountPollInterval:this.init.bufferedAmountPollInterval});this.log("new outbound connection %s",n.remoteAddr);let o=await t.upgrader.upgradeOutbound(n,t);return this.log("outbound connection %s upgraded",n.remoteAddr),o}async _connect(e,t){t?.signal?.throwIfAborted();let n=ea(e);this.log("create websocket connection to %s",n);let o=new WebSocket(n);o.binaryType="arraybuffer";try{t.onProgress?.(new oe("websockets:open-connection")),await uN(o,"open",t)}catch(i){if(t.signal?.aborted)throw this.metrics?.dialerEvents.increment({abort:!0}),new Ll(`Could not connect to ${n}`);this.metrics?.dialerEvents.increment({error:!0});try{o.close()}catch{}throw i}return this.log("connected %s",e),this.metrics?.dialerEvents.increment({connect:!0}),o}createListener(e){return fN({logger:this.logger,events:this.components.events,metrics:this.components.metrics},{...this.init,...e})}listenFilter(e){return e.filter(t=>Ji.exactMatch(t)||kc.exactMatch(t))}dialFilter(e){return this.listenFilter(e)}};function hN(r={}){return e=>new jv(e,r)}var Kv=nr(L2(),1);function pN(r,e){let t=e.map((n,o)=>({record:ai(n),index:o}));return t.sort((n,o)=>{let i=n.record.sequence,s=o.record.sequence;if(i>s)return-1;if(i<s)return 1;if(n.record.validityType===un.ValidityType.EOL&&o.record.validityType===un.ValidityType.EOL){let a=Kv.default.fromString(n.record.validity).toDate(),c=Kv.default.fromString(o.record.validity).toDate();if(a.getTime()>c.getTime())return-1;if(a.getTime()<c.getTime())return 1}return 0}),t[0].index}var mN="6.0.13",gN="helia";var yN={list:["/dnsaddr/bootstrap.libp2p.io/p2p/QmNnooDu7bfjPFoTZYxMNLWUQJyrVwtbZg5gBMjTezGAJN","/dnsaddr/bootstrap.libp2p.io/p2p/QmbLHAnMoJPWSCR5Zhtx6BHJX9KiKNN6tpvbUcqanj75Nb","/dnsaddr/bootstrap.libp2p.io/p2p/QmcZf59bWwK5XFi76CZX8cbJ4BhTzzA3gU1ZjYZcYW3dwt","/dnsaddr/va1.bootstrap.libp2p.io/p2p/12D3KooWKnDdG3iXw9eTFijk3EWSunZcFi54Zka4wmtqtt6rPxc8","/ip4/104.131.131.82/tcp/4001/p2p/QmaCpDMGvV2BGHeYERUEnRQAwe3N8SzbUtfsmvsqQLuvuJ"]};function n6(r={}){let e=`${gN}/${mN} ${Ug()}`;return{privateKey:r.privateKey,dns:r.dns,nodeInfo:{userAgent:e},addresses:{listen:["/p2p-circuit","/webrtc"]},transports:[lP(),aN(),sN(),hN()],connectionEncrypters:[py()],streamMuxers:[zC(),Hk()],peerDiscovery:[ZC(yN)],services:{autoNAT:QC(),dcutr:dP(),delegatedRouting:()=>_T("https://delegated-ipfs.dev",Nw()),dht:Fk({clientMode:!0,validators:{ipns:K2},selectors:{ipns:pN}}),identify:nk(),identifyPush:ok(),keychain:ay(r.keychain),ping:Zk(),http:QP()}}}async function wN(r){let e=r.libp2p??{};e.privateKey==null&&r.datastore!=null&&(e.privateKey=await A7(r.datastore,r.keychain));let t=n6(e);return t.datastore=t.datastore??r.datastore,await yI({...t,...e,start:!1})}async function Vv(r={}){let e=r.datastore??new Oc,t=r.blockstore??new kh,n;return wI(r.libp2p)?n=r.libp2p:n=await wN({...r,libp2p:{dns:r.dns,...r.libp2p,start:void 0},datastore:e}),{...r,libp2p:n,datastore:e,blockstore:t,blockBrokers:r.blockBrokers??[Rw(),xw()],routers:r.routers??[qw(n),Vw()],metrics:n.metrics}}async function ez(r={}){let e=await Vv(r),t=new d2(e);return e.start!==!1&&await t.start(),t}return DN(tz);})();
/*! Bundled license information:

pvtsutils/build/index.js:
  (*!
   * MIT License
   * 
   * Copyright (c) 2017-2024 Peculiar Ventures, LLC
   * 
   * Permission is hereby granted, free of charge, to any person obtaining a copy
   * of this software and associated documentation files (the "Software"), to deal
   * in the Software without restriction, including without limitation the rights
   * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
   * copies of the Software, and to permit persons to whom the Software is
   * furnished to do so, subject to the following conditions:
   * 
   * The above copyright notice and this permission notice shall be included in all
   * copies or substantial portions of the Software.
   * 
   * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
   * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
   * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
   * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
   * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
   * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
   * SOFTWARE.
   * 
   *)

reflect-metadata/Reflect.js:
  (*! *****************************************************************************
  Copyright (C) Microsoft. All rights reserved.
  Licensed under the Apache License, Version 2.0 (the "License"); you may not use
  this file except in compliance with the License. You may obtain a copy of the
  License at http://www.apache.org/licenses/LICENSE-2.0
  
  THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
  KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
  WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
  MERCHANTABLITY OR NON-INFRINGEMENT.
  
  See the Apache Version 2.0 License for specific language governing permissions
  and limitations under the License.
  ***************************************************************************** *)

tslib/tslib.js:
  (*! *****************************************************************************
  Copyright (c) Microsoft Corporation.
  
  Permission to use, copy, modify, and/or distribute this software for any
  purpose with or without fee is hereby granted.
  
  THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
  REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
  AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
  INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
  LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
  OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
  PERFORMANCE OF THIS SOFTWARE.
  ***************************************************************************** *)

@noble/hashes/utils.js:
  (*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/curves/utils.js:
@noble/curves/abstract/modular.js:
@noble/curves/abstract/curve.js:
@noble/curves/abstract/edwards.js:
@noble/curves/abstract/montgomery.js:
@noble/curves/ed25519.js:
@noble/curves/abstract/weierstrass.js:
@noble/curves/secp256k1.js:
  (*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

pvutils/build/utils.es.js:
  (*!
   Copyright (c) Peculiar Ventures, LLC
  *)

asn1js/build/index.es.js:
  (*!
   * Copyright (c) 2014, GMO GlobalSign
   * Copyright (c) 2015-2022, Peculiar Ventures
   * All rights reserved.
   * 
   * Author 2014-2019, Yury Strozhevsky
   * 
   * Redistribution and use in source and binary forms, with or without modification,
   * are permitted provided that the following conditions are met:
   * 
   * * Redistributions of source code must retain the above copyright notice, this
   *   list of conditions and the following disclaimer.
   * 
   * * Redistributions in binary form must reproduce the above copyright notice, this
   *   list of conditions and the following disclaimer in the documentation and/or
   *   other materials provided with the distribution.
   * 
   * * Neither the name of the copyright holder nor the names of its
   *   contributors may be used to endorse or promote products derived from
   *   this software without specific prior written permission.
   * 
   * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
   * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
   * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
   * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR
   * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
   * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
   * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
   * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
   * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
   * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
   * 
   *)

@noble/ciphers/utils.js:
  (*! noble-ciphers - MIT License (c) 2023 Paul Miller (paulmillr.com) *)

@peculiar/x509/build/x509.es.js:
  (*!
   * MIT License
   * 
   * Copyright (c) Peculiar Ventures. All rights reserved.
   * 
   * Permission is hereby granted, free of charge, to any person obtaining a copy
   * of this software and associated documentation files (the "Software"), to deal
   * in the Software without restriction, including without limitation the rights
   * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
   * copies of the Software, and to permit persons to whom the Software is
   * furnished to do so, subject to the following conditions:
   * 
   * The above copyright notice and this permission notice shall be included in all
   * copies or substantial portions of the Software.
   * 
   * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
   * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
   * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
   * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
   * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
   * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
   * SOFTWARE.
   * 
   *)
*/
return Helia}));
//# sourceMappingURL=index.min.js.map
