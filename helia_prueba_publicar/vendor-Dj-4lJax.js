const yS=Symbol.for("@libp2p/connection"),Rc=Symbol.for("@libp2p/content-routing");let ys=class extends Error{static name="AbortError";constructor(e="The operation was aborted"){super(e),this.name="AbortError"}};class wS extends Error{static name="UnexpectedPeerError";constructor(e="Unexpected Peer"){super(e),this.name="UnexpectedPeerError"}}let bS=class extends Error{static name="InvalidCryptoExchangeError";constructor(e="Invalid crypto exchange"){super(e),this.name="InvalidCryptoExchangeError"}},H=class extends Error{static name="InvalidParametersError";constructor(e="Invalid parameters"){super(e),this.name="InvalidParametersError"}};class Yu extends Error{static name="InvalidPublicKeyError";constructor(e="Invalid public key"){super(e),this.name="InvalidPublicKeyError"}}class t8 extends Error{static name="InvalidPrivateKeyError";constructor(e="Invalid private key"){super(e),this.name="InvalidPrivateKeyError"}}class p4 extends Error{static name="UnsupportedOperationError";constructor(e="Unsupported operation"){super(e),this.name="UnsupportedOperationError"}}class f0 extends Error{static name="ConnectionClosedError";constructor(e="The connection is closed"){super(e),this.name="ConnectionClosedError"}}class r8 extends Error{static name="ConnectionFailedError";constructor(e="Connection failed"){super(e),this.name="ConnectionFailedError"}}class fo extends Error{static name="MuxerClosedError";constructor(e="The muxer is closed"){super(e),this.name="MuxerClosedError"}}class n8 extends Error{static name="StreamResetError";constructor(e="The stream has been reset"){super(e),this.name="StreamResetError"}}class co extends Error{static name="StreamStateError";constructor(e="The stream is in an invalid state"){super(e),this.name="StreamStateError"}}class g4 extends Error{static name="StreamBufferError";constructor(e="The stream buffer was full"){super(e),this.name="StreamBufferError"}}let wt=class extends Error{static name="NotFoundError";constructor(e="Not found"){super(e),this.name="NotFoundError"}};class i8 extends Error{static name="InvalidPeerIdError";constructor(e="Invalid PeerID"){super(e),this.name="InvalidPeerIdError"}}let Bh=class extends Error{static name="InvalidMultiaddrError";constructor(e="Invalid multiaddr"){super(e),this.name="InvalidMultiaddrError"}};class vS extends Error{static name="InvalidCIDError";constructor(e="Invalid CID"){super(e),this.name="InvalidCIDError"}}class Op extends Error{static name="InvalidMultihashError";constructor(e="Invalid Multihash"){super(e),this.name="InvalidMultihashError"}}class s8 extends Error{static name="UnsupportedProtocolError";constructor(e="Unsupported protocol error"){super(e),this.name="UnsupportedProtocolError"}}class Je extends Error{static name="InvalidMessageError";constructor(e="Invalid message"){super(e),this.name="InvalidMessageError"}}let p0=class extends Error{static name="ProtocolError";constructor(e="Protocol error"){super(e),this.name="ProtocolError"}},Lh=class extends Error{static name="TimeoutError";constructor(e="Timed out"){super(e),this.name="TimeoutError"}};class Po extends Error{static name="NotStartedError";constructor(e="Not started"){super(e),this.name="NotStartedError"}}class Ou extends Error{static name="DialError";constructor(e="Dial error"){super(e),this.name="DialError"}}class g0 extends Error{static name="ListenError";constructor(e="Listen error"){super(e),this.name="ListenError"}}class m4 extends Error{static name="LimitedConnectionError";constructor(e="Limited connection"){super(e),this.name="LimitedConnectionError"}}class ES extends Error{static name="TooManyInboundProtocolStreamsError";constructor(e="Too many inbound protocol streams"){super(e),this.name="TooManyInboundProtocolStreamsError"}}class o8 extends Error{static name="TooManyOutboundProtocolStreamsError";constructor(e="Too many outbound protocol streams"){super(e),this.name="TooManyOutboundProtocolStreamsError"}}class ca extends Error{static name="UnsupportedKeyTypeError";constructor(e="Unsupported key type"){super(e),this.name="UnsupportedKeyTypeError"}}class SS extends Event{data;constructor(e,t){super("message",t),this.data=e}}class Oh extends Event{error;local;constructor(e,t,n){super("close",n),this.error=t,this.local=e}}class xS extends Oh{constructor(e,t){super(!0,e,t)}}class AS extends Oh{constructor(e,t){super(!1,e,t)}}const Qu=Symbol.for("@libp2p/peer-discovery"),Mp=Symbol.for("@libp2p/peer-id");function Ii(r){return!!r?.[Mp]}const Nc=Symbol.for("@libp2p/peer-routing"),Mh="keep-alive";function $p(r){return r!=null&&typeof r.start=="function"&&typeof r.stop=="function"}async function Cn(...r){const e=[];for(const t of r)$p(t)&&e.push(t);await Promise.all(e.map(async t=>{t.beforeStart!=null&&await t.beforeStart()})),await Promise.all(e.map(async t=>{await t.start()})),await Promise.all(e.map(async t=>{t.afterStart!=null&&await t.afterStart()}))}async function ni(...r){const e=[];for(const t of r)$p(t)&&e.push(t);await Promise.all(e.map(async t=>{t.beforeStop!=null&&await t.beforeStop()})),await Promise.all(e.map(async t=>{await t.stop()})),await Promise.all(e.map(async t=>{t.afterStop!=null&&await t.afterStop()}))}const $h=Symbol.for("@libp2p/transport");var Xu;(function(r){r[r.FATAL_ALL=0]="FATAL_ALL",r[r.NO_FATAL=1]="NO_FATAL"})(Xu||(Xu={}));class Qe extends EventTarget{#e=new Map;constructor(){super()}listenerCount(e){const t=this.#e.get(e);return t==null?0:t.length}addEventListener(e,t,n){super.addEventListener(e,t,n);let i=this.#e.get(e);i==null&&(i=[],this.#e.set(e,i)),i.push({callback:t,once:(n!==!0&&n!==!1&&n?.once)??!1})}removeEventListener(e,t,n){super.removeEventListener(e.toString(),t??null,n);let i=this.#e.get(e);i!=null&&(i=i.filter(({callback:s})=>s!==t),this.#e.set(e,i))}dispatchEvent(e){const t=super.dispatchEvent(e);let n=this.#e.get(e.type);return n==null||(n=n.filter(({once:i})=>!i),this.#e.set(e.type,n)),t}safeDispatchEvent(e,t={}){return this.dispatchEvent(new CustomEvent(e,t))}}const It=Symbol.for("@libp2p/service-capabilities"),ws=Symbol.for("@libp2p/service-dependencies"),kS=new Uint8Array(0);function CS(r){const e=r.match(/../g);return e!=null?new Uint8Array(e.map(t=>parseInt(t,16))):kS}function IS(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function la(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function _S(r){return new TextEncoder().encode(r)}function TS(r){return new TextDecoder().decode(r)}function PS(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var i=0;i<r.length;i++){var s=r.charAt(i),o=s.charCodeAt(0);if(t[o]!==255)throw new TypeError(s+" is ambiguous");t[o]=i}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),u=Math.log(256)/Math.log(a);function d(y){if(y instanceof Uint8Array||(ArrayBuffer.isView(y)?y=new Uint8Array(y.buffer,y.byteOffset,y.byteLength):Array.isArray(y)&&(y=Uint8Array.from(y))),!(y instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(y.length===0)return"";for(var m=0,p=0,b=0,A=y.length;b!==A&&y[b]===0;)b++,m++;for(var v=(A-b)*u+1>>>0,C=new Uint8Array(v);b!==A;){for(var T=y[b],R=0,L=v-1;(T!==0||R<p)&&L!==-1;L--,R++)T+=256*C[L]>>>0,C[L]=T%a>>>0,T=T/a>>>0;if(T!==0)throw new Error("Non-zero carry");p=R,b++}for(var N=v-p;N!==v&&C[N]===0;)N++;for(var E=c.repeat(m);N<v;++N)E+=r.charAt(C[N]);return E}function h(y){if(typeof y!="string")throw new TypeError("Expected String");if(y.length===0)return new Uint8Array;var m=0;if(y[m]!==" "){for(var p=0,b=0;y[m]===c;)p++,m++;for(var A=(y.length-m)*l+1>>>0,v=new Uint8Array(A);y[m];){var C=t[y.charCodeAt(m)];if(C===255)return;for(var T=0,R=A-1;(C!==0||T<b)&&R!==-1;R--,T++)C+=a*v[R]>>>0,v[R]=C%256>>>0,C=C/256>>>0;if(C!==0)throw new Error("Non-zero carry");b=T,m++}if(y[m]!==" "){for(var L=A-b;L!==A&&v[L]===0;)L++;for(var N=new Uint8Array(p+(A-L)),E=p;L!==A;)N[E++]=v[L++];return N}}}function f(y){var m=h(y);if(m)return m;throw new Error(`Non-${e} character`)}return{encode:d,decodeUnsafe:h,decode:f}}var RS=PS,NS=RS;let DS=class{name;prefix;baseEncode;constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},BS=class{name;prefix;baseDecode;prefixCodePoint;constructor(e,t,n){this.name=e,this.prefix=t;const i=t.codePointAt(0);if(i===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=i,this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return a8(this,e)}};class LS{decoders;constructor(e){this.decoders=e}or(e){return a8(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}}function a8(r,e){return new LS({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}class OS{name;prefix;baseEncode;baseDecode;encoder;decoder;constructor(e,t,n,i){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=i,this.encoder=new DS(e,t,n),this.decoder=new BS(e,t,i)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}}function Uh({name:r,prefix:e,encode:t,decode:n}){return new OS(r,e,t,n)}function pl({name:r,prefix:e,alphabet:t}){const{encode:n,decode:i}=NS(t,r);return Uh({prefix:e,name:r,encode:n,decode:s=>la(i(s))})}function MS(r,e,t,n){let i=r.length;for(;r[i-1]==="=";)--i;const s=new Uint8Array(i*t/8|0);let o=0,a=0,c=0;for(let l=0;l<i;++l){const u=e[r[l]];if(u===void 0)throw new SyntaxError(`Non-${n} character`);a=a<<t|u,o+=t,o>=8&&(o-=8,s[c++]=255&a>>o)}if(o>=t||(255&a<<8-o)!==0)throw new SyntaxError("Unexpected end of data");return s}function $S(r,e,t){const n=e[e.length-1]==="=",i=(1<<t)-1;let s="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,s+=e[i&a>>o];if(o!==0&&(s+=e[i&a<<t-o]),n)for(;(s.length*t&7)!==0;)s+="=";return s}function US(r){const e={};for(let t=0;t<r.length;++t)e[r[t]]=t;return e}function Vt({name:r,prefix:e,bitsPerChar:t,alphabet:n}){const i=US(n);return Uh({prefix:e,name:r,encode(s){return $S(s,n,t)},decode(s){return MS(s,i,t,r)}})}const vr=Vt({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),FS=Vt({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),VS=Vt({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),zS=Vt({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),HS=Vt({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),qS=Vt({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),KS=Vt({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),WS=Vt({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),jS=Vt({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),GS=Object.freeze(Object.defineProperty({__proto__:null,base32:vr,base32hex:HS,base32hexpad:KS,base32hexpadupper:WS,base32hexupper:qS,base32pad:VS,base32padupper:zS,base32upper:FS,base32z:jS},Symbol.toStringTag,{value:"Module"})),Ct=pl({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),YS=pl({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),QS=Object.freeze(Object.defineProperty({__proto__:null,base58btc:Ct,base58flickr:YS},Symbol.toStringTag,{value:"Module"})),Br=Vt({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),Up=Vt({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),Fh=Vt({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),XS=Vt({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),ZS=Object.freeze(Object.defineProperty({__proto__:null,base64:Br,base64pad:Up,base64url:Fh,base64urlpad:XS},Symbol.toStringTag,{value:"Module"})),Ro=1e3,No=Ro*60,Do=No*60,bs=Do*24,Dc=bs*7,Bo=bs*365.25,Bc=Bo/12;function JS(r,e){if(typeof r=="string")return ex(r);if(typeof r=="number")return nx(r,e);throw Error(`Value provided to ms() must be a string or number. value=${JSON.stringify(r)}`)}var c8=JS;function ex(r){if(typeof r!="string"||r.length===0||r.length>100)throw Error(`Value provided to ms.parse() must be a string with length between 1 and 99. value=${JSON.stringify(r)}`);let e=/^(?<value>-?\d*\.?\d+) *(?<unit>milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|months?|mo|years?|yrs?|y)?$/i.exec(r);if(!e?.groups)return NaN;let{value:t,unit:n="ms"}=e.groups,i=parseFloat(t),s=n.toLowerCase();switch(s){case"years":case"year":case"yrs":case"yr":case"y":return i*Bo;case"months":case"month":case"mo":return i*Bc;case"weeks":case"week":case"w":return i*Dc;case"days":case"day":case"d":return i*bs;case"hours":case"hour":case"hrs":case"hr":case"h":return i*Do;case"minutes":case"minute":case"mins":case"min":case"m":return i*No;case"seconds":case"second":case"secs":case"sec":case"s":return i*Ro;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return i;default:throw Error(`Unknown unit "${s}" provided to ms.parse(). value=${JSON.stringify(r)}`)}}function tx(r){let e=Math.abs(r);return e>=Bo?`${Math.round(r/Bo)}y`:e>=Bc?`${Math.round(r/Bc)}mo`:e>=Dc?`${Math.round(r/Dc)}w`:e>=bs?`${Math.round(r/bs)}d`:e>=Do?`${Math.round(r/Do)}h`:e>=No?`${Math.round(r/No)}m`:e>=Ro?`${Math.round(r/Ro)}s`:`${r}ms`}function rx(r){let e=Math.abs(r);return e>=Bo?Qi(r,e,Bo,"year"):e>=Bc?Qi(r,e,Bc,"month"):e>=Dc?Qi(r,e,Dc,"week"):e>=bs?Qi(r,e,bs,"day"):e>=Do?Qi(r,e,Do,"hour"):e>=No?Qi(r,e,No,"minute"):e>=Ro?Qi(r,e,Ro,"second"):`${r} ms`}function nx(r,e){if(typeof r!="number"||!Number.isFinite(r))throw Error("Value provided to ms.format() must be of type number.");return e?.long?rx(r):tx(r)}function Qi(r,e,t,n){let i=e>=t*1.5;return`${Math.round(r/t)} ${n}${i?"s":""}`}function ix(r){t.debug=t,t.default=t,t.coerce=c,t.disable=s,t.enable=i,t.enabled=o,t.humanize=c8,t.destroy=l,Object.keys(r).forEach(u=>{t[u]=r[u]}),t.names=[],t.skips=[],t.formatters={};function e(u){let d=0;for(let h=0;h<u.length;h++)d=(d<<5)-d+u.charCodeAt(h),d|=0;return t.colors[Math.abs(d)%t.colors.length]}t.selectColor=e;function t(u,d){let h,f=null,y,m;function p(...b){if(!p.enabled)return;const A=p,v=Number(new Date),C=v-(h||v);A.diff=C,A.prev=h,A.curr=v,h=v,b[0]=t.coerce(b[0]),typeof b[0]!="string"&&b.unshift("%O");let T=0;b[0]=b[0].replace(/%([a-zA-Z%])/g,(L,N)=>{if(L==="%%")return"%";T++;const E=t.formatters[N];if(typeof E=="function"){const O=b[T];L=E.call(A,O),b.splice(T,1),T--}return L}),t.formatArgs.call(A,b),d?.onLog!=null&&d.onLog(...b),(A.log||t.log).apply(A,b)}return p.namespace=u,p.useColors=t.useColors(),p.color=t.selectColor(u),p.extend=n,p.destroy=t.destroy,Object.defineProperty(p,"enabled",{enumerable:!0,configurable:!1,get:()=>f!==null?f:(y!==t.namespaces&&(y=t.namespaces,m=t.enabled(u)),m),set:b=>{f=b}}),typeof t.init=="function"&&t.init(p),p}function n(u,d){const h=t(this.namespace+(typeof d>"u"?":":d)+u);return h.log=this.log,h}function i(u){t.save(u),t.namespaces=u,t.names=[],t.skips=[];let d;const h=(typeof u=="string"?u:"").split(/[\s,]+/),f=h.length;for(d=0;d<f;d++)h[d]&&(u=h[d].replace(/\*/g,".*?"),u[0]==="-"?t.skips.push(new RegExp("^"+u.substr(1)+"$")):t.names.push(new RegExp("^"+u+"$")))}function s(){const u=[...t.names.map(a),...t.skips.map(a).map(d=>"-"+d)].join(",");return t.enable(""),u}function o(u){if(u[u.length-1]==="*")return!0;let d,h;for(d=0,h=t.skips.length;d<h;d++)if(t.skips[d].test(u))return!1;for(d=0,h=t.names.length;d<h;d++)if(t.names[d].test(u))return!0;return!1}function a(u){return u.toString().substring(2,u.toString().length-2).replace(/\.\*\?$/,"*")}function c(u){return u instanceof Error?u.stack??u.message:u}function l(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return t.setupFormatters(t.formatters),t.enable(t.load()),t}var sx={};const Zu=hx(),ox=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function ax(){return typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs)?!0:typeof navigator<"u"&&navigator.userAgent?.toLowerCase().match(/(edge|trident)\/(\d+)/)!=null?!1:typeof document<"u"&&document.documentElement?.style?.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent?.toLowerCase().match(/firefox\/(\d+)/)!=null&&parseInt(RegExp.$1,10)>=31||typeof navigator<"u"&&navigator.userAgent?.toLowerCase().match(/applewebkit\/(\d+)/)}function cx(r){if(r[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+r[0]+(this.useColors?"%c ":" ")+"+"+c8(this.diff),!this.useColors)return;const e="color: "+this.color;r.splice(1,0,e,"color: inherit");let t=0,n=0;r[0].replace(/%[a-zA-Z%]/g,i=>{i!=="%%"&&(t++,i==="%c"&&(n=t))}),r.splice(n,0,e)}const lx=console.debug??console.log??(()=>{});function ux(r){try{r?Zu?.setItem("debug",r):Zu?.removeItem("debug")}catch{}}function dx(){let r;try{r=Zu?.getItem("debug")}catch{}return!r&&typeof globalThis.process<"u"&&"env"in globalThis.process&&(r=sx.DEBUG),r}function hx(){try{return localStorage}catch{}}function fx(r){r.j=function(e){try{return JSON.stringify(e)}catch(t){return"[UnexpectedJSONParseError]: "+t.message}}}const Er=ix({formatArgs:cx,save:ux,load:dx,useColors:ax,setupFormatters:fx,colors:ox,storage:Zu,log:lx});Er.formatters.b=r=>r==null?"undefined":Ct.baseEncode(r);Er.formatters.t=r=>r==null?"undefined":vr.baseEncode(r);Er.formatters.m=r=>r==null?"undefined":Br.baseEncode(r);Er.formatters.p=r=>r==null?"undefined":r.toString();Er.formatters.c=r=>r==null?"undefined":r.toString();Er.formatters.k=r=>r==null?"undefined":r.toString();Er.formatters.a=r=>r==null?"undefined":r.toString();function y4(r,e=""){const t=w4(r.message),n=w4(r.stack);return t!=null&&n!=null?n.includes(t)?`${n.split(`
`).join(`
${e}`)}`:`${t}
${e}${n.split(`
`).join(`
${e}`)}`:n!=null?`${n.split(`
`).join(`
${e}`)}`:t!=null?`${t}`:`${r.toString()}`}function px(r){return r instanceof AggregateError||r?.name==="AggregateError"&&Array.isArray(r.errors)}function l8(r,e=""){if(px(r)){let t=y4(r,e);return r.errors.length>0?(e=`${e}    `,t+=`
${e}${r.errors.map(n=>`${l8(n,`${e}`)}`).join(`
${e}`)}`):t+=`
${e}[Error list was empty]`,t.trim()}return y4(r,e)}Er.formatters.e=r=>r==null?"undefined":l8(r);function gx(r){const e=()=>{};return e.enabled=!1,e.color="",e.diff=0,e.log=()=>{},e.namespace=r,e.destroy=()=>!0,e.extend=()=>e,e}function gl(r){return{forComponent(e){return Xt(e,r)}}}function Xt(r,e){let t=gx(`${r}:trace`);return Er.enabled(`${r}:trace`)&&Er.names.map(n=>n.toString()).find(n=>n.includes(":trace"))!=null&&(t=Er(`${r}:trace`,e)),Object.assign(Er(r,e),{error:Er(`${r}:error`,e),trace:t,newScope:n=>Xt(`${r}:${n}`,e)})}function w4(r){if(r!=null&&(r=r.trim(),r.length!==0))return r}class oe extends Event{type;detail;constructor(e,t){super(e),this.type=e,this.detail=t}}class mx extends AggregateError{static name="DNSQueryFailedError";name="DNSQueryFailedError"}var b4=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Us(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}var d1={exports:{}},v4;function yx(){return v4||(v4=1,(function(r){var e=Object.prototype.hasOwnProperty,t="~";function n(){}Object.create&&(n.prototype=Object.create(null),new n().__proto__||(t=!1));function i(c,l,u){this.fn=c,this.context=l,this.once=u||!1}function s(c,l,u,d,h){if(typeof u!="function")throw new TypeError("The listener must be a function");var f=new i(u,d||c,h),y=t?t+l:l;return c._events[y]?c._events[y].fn?c._events[y]=[c._events[y],f]:c._events[y].push(f):(c._events[y]=f,c._eventsCount++),c}function o(c,l){--c._eventsCount===0?c._events=new n:delete c._events[l]}function a(){this._events=new n,this._eventsCount=0}a.prototype.eventNames=function(){var l=[],u,d;if(this._eventsCount===0)return l;for(d in u=this._events)e.call(u,d)&&l.push(t?d.slice(1):d);return Object.getOwnPropertySymbols?l.concat(Object.getOwnPropertySymbols(u)):l},a.prototype.listeners=function(l){var u=t?t+l:l,d=this._events[u];if(!d)return[];if(d.fn)return[d.fn];for(var h=0,f=d.length,y=new Array(f);h<f;h++)y[h]=d[h].fn;return y},a.prototype.listenerCount=function(l){var u=t?t+l:l,d=this._events[u];return d?d.fn?1:d.length:0},a.prototype.emit=function(l,u,d,h,f,y){var m=t?t+l:l;if(!this._events[m])return!1;var p=this._events[m],b=arguments.length,A,v;if(p.fn){switch(p.once&&this.removeListener(l,p.fn,void 0,!0),b){case 1:return p.fn.call(p.context),!0;case 2:return p.fn.call(p.context,u),!0;case 3:return p.fn.call(p.context,u,d),!0;case 4:return p.fn.call(p.context,u,d,h),!0;case 5:return p.fn.call(p.context,u,d,h,f),!0;case 6:return p.fn.call(p.context,u,d,h,f,y),!0}for(v=1,A=new Array(b-1);v<b;v++)A[v-1]=arguments[v];p.fn.apply(p.context,A)}else{var C=p.length,T;for(v=0;v<C;v++)switch(p[v].once&&this.removeListener(l,p[v].fn,void 0,!0),b){case 1:p[v].fn.call(p[v].context);break;case 2:p[v].fn.call(p[v].context,u);break;case 3:p[v].fn.call(p[v].context,u,d);break;case 4:p[v].fn.call(p[v].context,u,d,h);break;default:if(!A)for(T=1,A=new Array(b-1);T<b;T++)A[T-1]=arguments[T];p[v].fn.apply(p[v].context,A)}}return!0},a.prototype.on=function(l,u,d){return s(this,l,u,d,!1)},a.prototype.once=function(l,u,d){return s(this,l,u,d,!0)},a.prototype.removeListener=function(l,u,d,h){var f=t?t+l:l;if(!this._events[f])return this;if(!u)return o(this,f),this;var y=this._events[f];if(y.fn)y.fn===u&&(!h||y.once)&&(!d||y.context===d)&&o(this,f);else{for(var m=0,p=[],b=y.length;m<b;m++)(y[m].fn!==u||h&&!y[m].once||d&&y[m].context!==d)&&p.push(y[m]);p.length?this._events[f]=p.length===1?p[0]:p:o(this,f)}return this},a.prototype.removeAllListeners=function(l){var u;return l?(u=t?t+l:l,this._events[u]&&o(this,u)):(this._events=new n,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=t,a.EventEmitter=a,r.exports=a})(d1)),d1.exports}var wx=yx();const bx=Us(wx);let vx=class u8 extends Error{name="TimeoutError";constructor(e,t){super(e,t),Error.captureStackTrace?.(this,u8)}};const E4=r=>r.reason??new DOMException("This operation was aborted.","AbortError");function Ex(r,e){const{milliseconds:t,fallback:n,message:i,customTimers:s={setTimeout,clearTimeout},signal:o}=e;let a,c;const u=new Promise((d,h)=>{if(typeof t!="number"||Math.sign(t)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${t}\``);if(o?.aborted){h(E4(o));return}if(o&&(c=()=>{h(E4(o))},o.addEventListener("abort",c,{once:!0})),r.then(d,h),t===Number.POSITIVE_INFINITY)return;const f=new vx;a=s.setTimeout.call(void 0,()=>{if(n){try{d(n())}catch(y){h(y)}return}typeof r.cancel=="function"&&r.cancel(),i===!1?d():i instanceof Error?h(i):(f.message=i??`Promise timed out after ${t} milliseconds`,h(f))},t)}).finally(()=>{u.clear(),c&&o&&o.removeEventListener("abort",c)});return u.clear=()=>{s.clearTimeout.call(void 0,a),a=void 0},u}function Sx(r,e,t){let n=0,i=r.length;for(;i>0;){const s=Math.trunc(i/2);let o=n+s;t(r[o],e)<=0?(n=++o,i-=s+1):i=s}return n}let xx=class{#e=[];enqueue(e,t){const{priority:n=0,id:i}=t??{},s={priority:n,id:i,run:e};if(this.size===0||this.#e[this.size-1].priority>=n){this.#e.push(s);return}const o=Sx(this.#e,s,(a,c)=>c.priority-a.priority);this.#e.splice(o,0,s)}setPriority(e,t){const n=this.#e.findIndex(s=>s.id===e);if(n===-1)throw new ReferenceError(`No promise function with the id "${e}" exists in the queue.`);const[i]=this.#e.splice(n,1);this.enqueue(i.run,{priority:t,id:e})}dequeue(){return this.#e.shift()?.run}filter(e){return this.#e.filter(t=>t.priority===e.priority).map(t=>t.run)}get size(){return this.#e.length}};class Fp extends bx{#e;#t;#r=0;#o;#s=!1;#d=!1;#h;#b=0;#m=0;#a;#c;#n;#v;#i=0;#f;#l;#C=1n;#p=new Map;timeout;constructor(e){if(super(),e={carryoverIntervalCount:!1,intervalCap:Number.POSITIVE_INFINITY,interval:0,concurrency:Number.POSITIVE_INFINITY,autoStart:!0,queueClass:xx,...e},!(typeof e.intervalCap=="number"&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${e.intervalCap?.toString()??""}\` (${typeof e.intervalCap})`);if(e.interval===void 0||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${e.interval?.toString()??""}\` (${typeof e.interval})`);if(this.#e=e.carryoverIntervalCount??e.carryoverConcurrencyCount??!1,this.#t=e.intervalCap===Number.POSITIVE_INFINITY||e.interval===0,this.#o=e.intervalCap,this.#h=e.interval,this.#n=new e.queueClass,this.#v=e.queueClass,this.concurrency=e.concurrency,e.timeout!==void 0&&!(Number.isFinite(e.timeout)&&e.timeout>0))throw new TypeError(`Expected \`timeout\` to be a positive finite number, got \`${e.timeout}\` (${typeof e.timeout})`);this.timeout=e.timeout,this.#l=e.autoStart===!1,this.#D()}get#I(){return this.#t||this.#r<this.#o}get#_(){return this.#i<this.#f}#T(){this.#i--,this.#i===0&&this.emit("pendingZero"),this.#y(),this.emit("next")}#P(){this.#A(),this.#x(),this.#c=void 0}get#R(){const e=Date.now();if(this.#a===void 0){const t=this.#b-e;if(t<0){if(this.#m>0){const n=e-this.#m;if(n<this.#h)return this.#E(this.#h-n),!0}this.#r=this.#e?this.#i:0}else return this.#E(t),!0}return!1}#E(e){this.#c===void 0&&(this.#c=setTimeout(()=>{this.#P()},e))}#S(){this.#a&&(clearInterval(this.#a),this.#a=void 0)}#N(){this.#c&&(clearTimeout(this.#c),this.#c=void 0)}#y(){if(this.#n.size===0)return this.#S(),this.emit("empty"),this.#i===0&&(this.#N(),this.emit("idle")),!1;let e=!1;if(!this.#l){const t=!this.#R;if(this.#I&&this.#_){const n=this.#n.dequeue();this.#t||(this.#r++,this.#g()),this.emit("active"),this.#m=Date.now(),n(),t&&this.#x(),e=!0}}return e}#x(){this.#t||this.#a!==void 0||(this.#a=setInterval(()=>{this.#A()},this.#h),this.#b=Date.now()+this.#h)}#A(){this.#r===0&&this.#i===0&&this.#a&&this.#S(),this.#r=this.#e?this.#i:0,this.#w(),this.#g()}#w(){for(;this.#y(););}get concurrency(){return this.#f}set concurrency(e){if(!(typeof e=="number"&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this.#f=e,this.#w()}setPriority(e,t){if(typeof t!="number"||!Number.isFinite(t))throw new TypeError(`Expected \`priority\` to be a finite number, got \`${t}\` (${typeof t})`);this.#n.setPriority(e,t)}async add(e,t={}){return t.id??=(this.#C++).toString(),t={timeout:this.timeout,...t},new Promise((n,i)=>{const s=Symbol(`task-${t.id}`);this.#n.enqueue(async()=>{this.#i++,this.#p.set(s,{id:t.id,priority:t.priority??0,startTime:Date.now(),timeout:t.timeout});let o;try{try{t.signal?.throwIfAborted()}catch(l){throw this.#t||this.#r--,this.#p.delete(s),l}let a=e({signal:t.signal});if(t.timeout&&(a=Ex(Promise.resolve(a),{milliseconds:t.timeout,message:`Task timed out after ${t.timeout}ms (queue has ${this.#i} running, ${this.#n.size} waiting)`})),t.signal){const{signal:l}=t;a=Promise.race([a,new Promise((u,d)=>{o=()=>{d(l.reason)},l.addEventListener("abort",o,{once:!0})})])}const c=await a;n(c),this.emit("completed",c)}catch(a){i(a),this.emit("error",a)}finally{o&&t.signal?.removeEventListener("abort",o),this.#p.delete(s),queueMicrotask(()=>{this.#T()})}},t),this.emit("add"),this.#y()})}async addAll(e,t){return Promise.all(e.map(async n=>this.add(n,t)))}start(){return this.#l?(this.#l=!1,this.#w(),this):this}pause(){this.#l=!0}clear(){this.#n=new this.#v,this.#k()}async onEmpty(){this.#n.size!==0&&await this.#u("empty")}async onSizeLessThan(e){this.#n.size<e||await this.#u("next",()=>this.#n.size<e)}async onIdle(){this.#i===0&&this.#n.size===0||await this.#u("idle")}async onPendingZero(){this.#i!==0&&await this.#u("pendingZero")}async onRateLimit(){this.isRateLimited||await this.#u("rateLimit")}async onRateLimitCleared(){this.isRateLimited&&await this.#u("rateLimitCleared")}async onError(){return new Promise((e,t)=>{const n=i=>{this.off("error",n),t(i)};this.on("error",n)})}async#u(e,t){return new Promise(n=>{const i=()=>{t&&!t()||(this.off(e,i),n())};this.on(e,i)})}get size(){return this.#n.size}sizeBy(e){return this.#n.filter(e).length}get pending(){return this.#i}get isPaused(){return this.#l}#D(){this.#t||(this.on("add",()=>{this.#n.size>0&&this.#g()}),this.on("next",()=>{this.#g()}))}#g(){this.#t||this.#d||(this.#d=!0,queueMicrotask(()=>{this.#d=!1,this.#k()}))}#k(){const e=this.#s,t=!this.#t&&this.#r>=this.#o&&this.#n.size>0;t!==e&&(this.#s=t,this.emit(t?"rateLimit":"rateLimitCleared"))}get isRateLimited(){return this.#s}get isSaturated(){return this.#i===this.#f&&this.#n.size>0||this.isRateLimited&&this.#n.size>0}get runningTasks(){return[...this.#p.values()].map(e=>({...e}))}}function d8(r){const e=[Bi.A];return r==null?e:Array.isArray(r)?r.length===0?e:r:[r]}const Ax=pl({prefix:"9",name:"base10",alphabet:"0123456789"}),kx=Object.freeze(Object.defineProperty({__proto__:null,base10:Ax},Symbol.toStringTag,{value:"Module"})),Cx=Vt({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),Ix=Vt({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),_x=Object.freeze(Object.defineProperty({__proto__:null,base16:Cx,base16upper:Ix},Symbol.toStringTag,{value:"Module"})),Tx=Vt({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),Px=Object.freeze(Object.defineProperty({__proto__:null,base2:Tx},Symbol.toStringTag,{value:"Module"})),h8=Array.from("ðŸš€ðŸªâ˜„ðŸ›°ðŸŒŒðŸŒ‘ðŸŒ’ðŸŒ“ðŸŒ”ðŸŒ•ðŸŒ–ðŸŒ—ðŸŒ˜ðŸŒðŸŒðŸŒŽðŸ‰â˜€ðŸ’»ðŸ–¥ðŸ’¾ðŸ’¿ðŸ˜‚â¤ðŸ˜ðŸ¤£ðŸ˜ŠðŸ™ðŸ’•ðŸ˜­ðŸ˜˜ðŸ‘ðŸ˜…ðŸ‘ðŸ˜ðŸ”¥ðŸ¥°ðŸ’”ðŸ’–ðŸ’™ðŸ˜¢ðŸ¤”ðŸ˜†ðŸ™„ðŸ’ªðŸ˜‰â˜ºðŸ‘ŒðŸ¤—ðŸ’œðŸ˜”ðŸ˜ŽðŸ˜‡ðŸŒ¹ðŸ¤¦ðŸŽ‰ðŸ’žâœŒâœ¨ðŸ¤·ðŸ˜±ðŸ˜ŒðŸŒ¸ðŸ™ŒðŸ˜‹ðŸ’—ðŸ’šðŸ˜ðŸ’›ðŸ™‚ðŸ’“ðŸ¤©ðŸ˜„ðŸ˜€ðŸ–¤ðŸ˜ƒðŸ’¯ðŸ™ˆðŸ‘‡ðŸŽ¶ðŸ˜’ðŸ¤­â£ðŸ˜œðŸ’‹ðŸ‘€ðŸ˜ªðŸ˜‘ðŸ’¥ðŸ™‹ðŸ˜žðŸ˜©ðŸ˜¡ðŸ¤ªðŸ‘ŠðŸ¥³ðŸ˜¥ðŸ¤¤ðŸ‘‰ðŸ’ƒðŸ˜³âœ‹ðŸ˜šðŸ˜ðŸ˜´ðŸŒŸðŸ˜¬ðŸ™ƒðŸ€ðŸŒ·ðŸ˜»ðŸ˜“â­âœ…ðŸ¥ºðŸŒˆðŸ˜ˆðŸ¤˜ðŸ’¦âœ”ðŸ˜£ðŸƒðŸ’â˜¹ðŸŽŠðŸ’˜ðŸ˜ â˜ðŸ˜•ðŸŒºðŸŽ‚ðŸŒ»ðŸ˜ðŸ–•ðŸ’ðŸ™ŠðŸ˜¹ðŸ—£ðŸ’«ðŸ’€ðŸ‘‘ðŸŽµðŸ¤žðŸ˜›ðŸ”´ðŸ˜¤ðŸŒ¼ðŸ˜«âš½ðŸ¤™â˜•ðŸ†ðŸ¤«ðŸ‘ˆðŸ˜®ðŸ™†ðŸ»ðŸƒðŸ¶ðŸ’ðŸ˜²ðŸŒ¿ðŸ§¡ðŸŽâš¡ðŸŒžðŸŽˆâŒâœŠðŸ‘‹ðŸ˜°ðŸ¤¨ðŸ˜¶ðŸ¤ðŸš¶ðŸ’°ðŸ“ðŸ’¢ðŸ¤ŸðŸ™ðŸš¨ðŸ’¨ðŸ¤¬âœˆðŸŽ€ðŸºðŸ¤“ðŸ˜™ðŸ’ŸðŸŒ±ðŸ˜–ðŸ‘¶ðŸ¥´â–¶âž¡â“ðŸ’ŽðŸ’¸â¬‡ðŸ˜¨ðŸŒšðŸ¦‹ðŸ˜·ðŸ•ºâš ðŸ™…ðŸ˜ŸðŸ˜µðŸ‘ŽðŸ¤²ðŸ¤ ðŸ¤§ðŸ“ŒðŸ”µðŸ’…ðŸ§ðŸ¾ðŸ’ðŸ˜—ðŸ¤‘ðŸŒŠðŸ¤¯ðŸ·â˜ŽðŸ’§ðŸ˜¯ðŸ’†ðŸ‘†ðŸŽ¤ðŸ™‡ðŸ‘â„ðŸŒ´ðŸ’£ðŸ¸ðŸ’ŒðŸ“ðŸ¥€ðŸ¤¢ðŸ‘…ðŸ’¡ðŸ’©ðŸ‘ðŸ“¸ðŸ‘»ðŸ¤ðŸ¤®ðŸŽ¼ðŸ¥µðŸš©ðŸŽðŸŠðŸ‘¼ðŸ’ðŸ“£ðŸ¥‚"),Rx=h8.reduce((r,e,t)=>(r[t]=e,r),[]),Nx=h8.reduce((r,e,t)=>{const n=e.codePointAt(0);if(n==null)throw new Error(`Invalid character: ${e}`);return r[n]=t,r},[]);function Dx(r){return r.reduce((e,t)=>(e+=Rx[t],e),"")}function Bx(r){const e=[];for(const t of r){const n=t.codePointAt(0);if(n==null)throw new Error(`Invalid character: ${t}`);const i=Nx[n];if(i==null)throw new Error(`Non-base256emoji character: ${t}`);e.push(i)}return new Uint8Array(e)}const Lx=Uh({prefix:"ðŸš€",name:"base256emoji",encode:Dx,decode:Bx}),Ox=Object.freeze(Object.defineProperty({__proto__:null,base256emoji:Lx},Symbol.toStringTag,{value:"Module"})),_i=pl({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),Mx=pl({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),$x=Object.freeze(Object.defineProperty({__proto__:null,base36:_i,base36upper:Mx},Symbol.toStringTag,{value:"Module"})),Ux=Vt({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),Fx=Object.freeze(Object.defineProperty({__proto__:null,base8:Ux},Symbol.toStringTag,{value:"Module"})),Vx=Uh({prefix:"\0",name:"identity",encode:r=>TS(r),decode:r=>_S(r)}),zx=Object.freeze(Object.defineProperty({__proto__:null,identity:Vx},Symbol.toStringTag,{value:"Module"})),Hx=new TextEncoder,qx=new TextDecoder,Kx="json",Vp=512;function Wx(r){return Hx.encode(JSON.stringify(r))}function f8(r){return JSON.parse(qx.decode(r))}const jx=Object.freeze(Object.defineProperty({__proto__:null,code:Vp,decode:f8,encode:Wx,name:Kx},Symbol.toStringTag,{value:"Module"})),Gx="raw",sn=85;function Yx(r){return la(r)}function Qx(r){return la(r)}const p8=Object.freeze(Object.defineProperty({__proto__:null,code:sn,decode:Qx,encode:Yx,name:Gx},Symbol.toStringTag,{value:"Module"}));var Xx=g8,S4=128,Zx=-128,Jx=Math.pow(2,31);function g8(r,e,t){e=e||[],t=t||0;for(var n=t;r>=Jx;)e[t++]=r&255|S4,r/=128;for(;r&Zx;)e[t++]=r&255|S4,r>>>=7;return e[t]=r|0,g8.bytes=t-n+1,e}var eA=m0,tA=128,x4=127;function m0(r,n){var t=0,n=n||0,i=0,s=n,o,a=r.length;do{if(s>=a)throw m0.bytes=0,new RangeError("Could not decode varint");o=r[s++],t+=i<28?(o&x4)<<i:(o&x4)*Math.pow(2,i),i+=7}while(o>=tA);return m0.bytes=s-n,t}var rA=Math.pow(2,7),nA=Math.pow(2,14),iA=Math.pow(2,21),sA=Math.pow(2,28),oA=Math.pow(2,35),aA=Math.pow(2,42),cA=Math.pow(2,49),lA=Math.pow(2,56),uA=Math.pow(2,63),dA=function(r){return r<rA?1:r<nA?2:r<iA?3:r<sA?4:r<oA?5:r<aA?6:r<cA?7:r<lA?8:r<uA?9:10},hA={encode:Xx,decode:eA,encodingLength:dA},Ju=hA;function y0(r,e=0){return[Ju.decode(r,e),Ju.decode.bytes]}function ed(r,e,t=0){return Ju.encode(r,e,t),e}function td(r){return Ju.encodingLength(r)}function qi(r,e){const t=e.byteLength,n=td(r),i=n+td(t),s=new Uint8Array(i+t);return ed(r,s,0),ed(t,s,n),s.set(e,i),new zp(r,t,e,s)}function Zt(r){const e=la(r),[t,n]=y0(e),[i,s]=y0(e.subarray(n)),o=e.subarray(n+s);if(o.byteLength!==i)throw new Error("Incorrect length");return new zp(t,i,o,e)}function fA(r,e){if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&IS(r.bytes,t.bytes)}}class zp{code;size;digest;bytes;constructor(e,t,n,i){this.code=e,this.size=t,this.digest=n,this.bytes=i}}const m8=0,pA="identity",y8=la;function gA(r,e){if(e?.truncate!=null&&e.truncate!==r.byteLength){if(e.truncate<0||e.truncate>r.byteLength)throw new Error(`Invalid truncate option, must be less than or equal to ${r.byteLength}`);r=r.subarray(0,e.truncate)}return qi(m8,y8(r))}const jn={code:m8,name:pA,encode:y8,digest:gA},mA=20;function Vh({name:r,code:e,encode:t,minDigestLength:n,maxDigestLength:i}){return new yA(r,e,t,n,i)}class yA{name;code;encode;minDigestLength;maxDigestLength;constructor(e,t,n,i,s){this.name=e,this.code=t,this.encode=n,this.minDigestLength=i??mA,this.maxDigestLength=s}digest(e,t){if(t?.truncate!=null){if(t.truncate<this.minDigestLength)throw new Error(`Invalid truncate option, must be greater than or equal to ${this.minDigestLength}`);if(this.maxDigestLength!=null&&t.truncate>this.maxDigestLength)throw new Error(`Invalid truncate option, must be less than or equal to ${this.maxDigestLength}`)}if(e instanceof Uint8Array){const n=this.encode(e);return n instanceof Uint8Array?A4(n,this.code,t?.truncate):n.then(i=>A4(i,this.code,t?.truncate))}else throw Error("Unknown type, must be binary type")}}function A4(r,e,t){if(t!=null&&t!==r.byteLength){if(t>r.byteLength)throw new Error(`Invalid truncate option, must be less than or equal to ${r.byteLength}`);r=r.subarray(0,t)}return qi(e,r)}function w8(r){return async e=>new Uint8Array(await crypto.subtle.digest(r,e))}const Et=Vh({name:"sha2-256",code:18,encode:w8("SHA-256")}),k4=Vh({name:"sha2-512",code:19,encode:w8("SHA-512")});function C4(r,e){const{bytes:t,version:n}=r;switch(n){case 0:return bA(t,w0(r),e??Ct.encoder);default:return vA(t,w0(r),e??vr.encoder)}}const I4=new WeakMap;function w0(r){const e=I4.get(r);if(e==null){const t=new Map;return I4.set(r,t),t}return e}class ae{code;version;multihash;bytes;"/";constructor(e,t,n,i){this.code=t,this.version=e,this.multihash=n,this.bytes=i,this["/"]=i}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==Da)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==EA)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return ae.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=qi(e,t);return ae.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return ae.equals(this,e)}static equals(e,t){const n=t;return n!=null&&e.code===n.code&&e.version===n.version&&fA(e.multihash,n.multihash)}toString(e){return C4(this,e)}toJSON(){return{"/":C4(this)}}link(){return this}[Symbol.toStringTag]="CID";[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof ae)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:i,multihash:s,bytes:o}=t;return new ae(n,i,s,o??_4(n,i,s.bytes))}else if(t[SA]===!0){const{version:n,multihash:i,code:s}=t,o=Zt(i);return ae.create(n,s,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==Da)throw new Error(`Version 0 CID must use dag-pb (code: ${Da}) block encoding`);return new ae(e,t,n,n.bytes)}case 1:{const i=_4(e,t,n.bytes);return new ae(e,t,n,i)}default:throw new Error("Invalid version")}}static createV0(e){return ae.create(0,Da,e)}static createV1(e,t){return ae.create(1,e,t)}static decode(e){const[t,n]=ae.decodeFirst(e);if(n.length!==0)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=ae.inspectBytes(e),n=t.size-t.multihashSize,i=la(e.subarray(n,n+t.multihashSize));if(i.byteLength!==t.multihashSize)throw new Error("Incorrect length");const s=i.subarray(t.multihashSize-t.digestSize),o=new zp(t.multihashCode,t.digestSize,s,i);return[t.version===0?ae.createV0(o):ae.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[d,h]=y0(e.subarray(t));return t+=h,d};let i=n(),s=Da;if(i===18?(i=0,t=0):s=n(),i!==0&&i!==1)throw new RangeError(`Invalid CID version ${i}`);const o=t,a=n(),c=n(),l=t+c,u=l-o;return{version:i,codec:s,multihashCode:a,digestSize:c,multihashSize:u,size:l}}static parse(e,t){const[n,i]=wA(e,t),s=ae.decode(i);if(s.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return w0(s).set(n,e),s}}function wA(r,e){switch(r[0]){case"Q":{const t=e??Ct;return[Ct.prefix,t.decode(`${Ct.prefix}${r}`)]}case Ct.prefix:{const t=e??Ct;return[Ct.prefix,t.decode(r)]}case vr.prefix:{const t=e??vr;return[vr.prefix,t.decode(r)]}case _i.prefix:{const t=e??_i;return[_i.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}}function bA(r,e,t){const{prefix:n}=t;if(n!==Ct.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const i=e.get(n);if(i==null){const s=t.encode(r).slice(1);return e.set(n,s),s}else return i}function vA(r,e,t){const{prefix:n}=t,i=e.get(n);if(i==null){const s=t.encode(r);return e.set(n,s),s}else return i}const Da=112,EA=18;function _4(r,e,t){const n=td(r),i=n+td(e),s=new Uint8Array(i+t.byteLength);return ed(r,s,0),ed(e,s,n),s.set(t,i),s}const SA=Symbol.for("@ipld/js-cid/CID"),rd={...zx,...Px,...Fx,...kx,..._x,...GS,...$x,...QS,...ZS,...Ox};function Re(r=0){return new Uint8Array(r)}function Ar(r=0){return new Uint8Array(r)}function b8(r,e,t,n){return{name:r,prefix:e,encoder:{name:r,prefix:e,encode:t},decoder:{decode:n}}}const T4=b8("utf8","u",r=>"u"+new TextDecoder("utf8").decode(r),r=>new TextEncoder().encode(r.substring(1))),h1=b8("ascii","a",r=>{let e="a";for(let t=0;t<r.length;t++)e+=String.fromCharCode(r[t]);return e},r=>{r=r.substring(1);const e=Ar(r.length);for(let t=0;t<r.length;t++)e[t]=r.charCodeAt(t);return e}),v8={utf8:T4,"utf-8":T4,hex:rd.base16,latin1:h1,ascii:h1,binary:h1,...rd};function Y(r,e="utf8"){const t=v8[e];if(t==null)throw new Error(`Unsupported encoding "${e}"`);return t.encoder.encode(r).substring(1)}const E8=60;function S8(r){return{Status:r.Status??0,TC:r.TC??r.flag_tc??!1,RD:r.RD??r.flag_rd??!1,RA:r.RA??r.flag_ra??!1,AD:r.AD??r.flag_ad??!1,CD:r.CD??r.flag_cd??!1,Question:(r.Question??r.questions??[]).map(e=>({name:e.name,type:Bi[e.type]})),Answer:(r.Answer??r.answers??[]).map(e=>({name:e.name,type:Bi[e.type],TTL:e.TTL??e.ttl??E8,data:e.data instanceof Uint8Array?Y(e.data):e.data}))}}const xA=4;function P4(r,e={}){const t=new Fp({concurrency:e.queryConcurrency??xA});return async(n,i={})=>{const s=new URLSearchParams;s.set("name",n),d8(i.types).forEach(a=>{s.append("type",Bi[a])}),i.onProgress?.(new oe("dns:query",n));const o=await t.add(async()=>{const a=await fetch(`${r}?${s}`,{headers:{accept:"application/dns-json"},signal:i?.signal});if(a.status!==200)throw new Error(`Unexpected HTTP status: ${a.status} - ${a.statusText}`);const c=S8(await a.json());return i.onProgress?.(new oe("dns:response",c)),c},{signal:i.signal});if(o==null)throw new Error("No DNS response received");return o}}function AA(){return[P4("https://cloudflare-dns.com/dns-query"),P4("https://dns.google/resolve")]}var f1,R4;function kA(){return R4||(R4=1,f1=function(r){if(!r)throw Error("hashlru must have a max value, of type number, greater than 0");var e=0,t=Object.create(null),n=Object.create(null);function i(s,o){t[s]=o,e++,e>=r&&(e=0,n=t,t=Object.create(null))}return{has:function(s){return t[s]!==void 0||n[s]!==void 0},remove:function(s){t[s]!==void 0&&(t[s]=void 0),n[s]!==void 0&&(n[s]=void 0)},get:function(s){var o=t[s];if(o!==void 0)return o;if((o=n[s])!==void 0)return i(s,o),o},set:function(s,o){t[s]!==void 0?t[s]=o:i(s,o)},clear:function(){t=Object.create(null),n=Object.create(null)}}}),f1}var CA=kA();const IA=Us(CA);class _A{lru;constructor(e){this.lru=IA(e)}get(e,t){let n=!0;const i=[];for(const s of t){const o=this.getAnswers(e,s);if(o.length===0){n=!1;break}i.push(...o)}if(n)return S8({answers:i})}getAnswers(e,t){const n=`${e.toLowerCase()}-${t}`,i=this.lru.get(n);if(i!=null){const s=i.filter(o=>o.expires>Date.now()).map(({expires:o,value:a})=>({...a,TTL:Math.round((o-Date.now())/1e3),type:Bi[a.type]}));return s.length===0&&this.lru.remove(n),s}return[]}add(e,t){const n=`${e.toLowerCase()}-${t.type}`,i=this.lru.get(n)??[];i.push({expires:Date.now()+(t.TTL??E8)*1e3,value:t}),this.lru.set(n,i)}remove(e,t){const n=`${e.toLowerCase()}-${t}`;this.lru.remove(n)}clear(){this.lru.clear()}}function TA(r){return new _A(r)}const PA=1e3;let RA=class{resolvers;cache;constructor(e){this.resolvers={},this.cache=TA(e.cacheSize??PA),Object.entries(e.resolvers??{}).forEach(([t,n])=>{Array.isArray(n)||(n=[n]),t.endsWith(".")||(t=`${t}.`),this.resolvers[t]=n}),this.resolvers["."]==null&&(this.resolvers["."]=AA())}async query(e,t={}){const n=d8(t.types),i=t.cached!==!1?this.cache.get(e,n):void 0;if(i!=null)return t.onProgress?.(new oe("dns:cache",i)),i;const s=`${e.split(".").pop()}.`,o=(this.resolvers[s]??this.resolvers["."]).sort(()=>Math.random()>.5?-1:1),a=[];for(const c of o){if(t.signal?.aborted===!0)break;try{const l=await c(e,{...t,types:n});for(const u of l.Answer)this.cache.add(e,u);return l}catch(l){a.push(l),t.onProgress?.(new oe("dns:error",l))}}throw new mx(a,`DNS lookup of ${e} ${n} failed`)}};var Bi;(function(r){r[r.A=1]="A",r[r.CNAME=5]="CNAME",r[r.TXT=16]="TXT",r[r.AAAA=28]="AAAA"})(Bi||(Bi={}));function x8(r={}){return new RA(r)}function NA(r){return r[Symbol.asyncIterator]!=null}function Li(r){if(NA(r))return(async()=>{for await(const e of r);})();for(const e of r);}class N4 extends Error{constructor(e="An error occurred while signing a message"){super(e),this.name="SigningError"}}class D4 extends Error{constructor(e="An error occurred while verifying a message"){super(e),this.name="VerificationError"}}class DA extends Error{constructor(e="Missing Web Crypto API"){super(e),this.name="WebCryptoMissingError"}}const ir={get(r=globalThis){const e=r.crypto;if(e?.subtle==null)throw new DA("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p/blob/main/packages/crypto/README.md#web-crypto-api");return e}};function Te(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function Ot(r,e){e==null&&(e=r.reduce((i,s)=>i+s.length,0));const t=Ar(e);let n=0;for(const i of r)t.set(i,n),n+=i.length;return t}const A8=Symbol.for("@achingbrain/uint8arraylist");function B4(r,e){if(e==null||e<0)throw new RangeError("index is out of bounds");let t=0;for(const n of r){const i=t+n.byteLength;if(e<i)return{buf:n,index:e-t};t=i}throw new RangeError("index is out of bounds")}function Ka(r){return!!r?.[A8]}class me{bufs;length;[A8]=!0;constructor(...e){this.bufs=[],this.length=0,e.length>0&&this.appendAll(e)}*[Symbol.iterator](){yield*this.bufs}get byteLength(){return this.length}append(...e){this.appendAll(e)}appendAll(e){let t=0;for(const n of e)if(n instanceof Uint8Array)t+=n.byteLength,this.bufs.push(n);else if(Ka(n))t+=n.byteLength,this.bufs.push(...n.bufs);else throw new Error("Could not append value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}prepend(...e){this.prependAll(e)}prependAll(e){let t=0;for(const n of e.reverse())if(n instanceof Uint8Array)t+=n.byteLength,this.bufs.unshift(n);else if(Ka(n))t+=n.byteLength,this.bufs.unshift(...n.bufs);else throw new Error("Could not prepend value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}get(e){const t=B4(this.bufs,e);return t.buf[t.index]}set(e,t){const n=B4(this.bufs,e);n.buf[n.index]=t}write(e,t=0){if(e instanceof Uint8Array)for(let n=0;n<e.length;n++)this.set(t+n,e[n]);else if(Ka(e))for(let n=0;n<e.length;n++)this.set(t+n,e.get(n));else throw new Error("Could not write value, must be an Uint8Array or a Uint8ArrayList")}consume(e){if(e=Math.trunc(e),!(Number.isNaN(e)||e<=0)){if(e===this.byteLength){this.bufs=[],this.length=0;return}for(;this.bufs.length>0;)if(e>=this.bufs[0].byteLength)e-=this.bufs[0].byteLength,this.length-=this.bufs[0].byteLength,this.bufs.shift();else{this.bufs[0]=this.bufs[0].subarray(e),this.length-=e;break}}}slice(e,t){const{bufs:n,length:i}=this._subList(e,t);return Ot(n,i)}subarray(e,t){const{bufs:n,length:i}=this._subList(e,t);return n.length===1?n[0]:Ot(n,i)}sublist(e,t){const{bufs:n,length:i}=this._subList(e,t),s=new me;return s.length=i,s.bufs=[...n],s}_subList(e,t){if(e=e??0,t=t??this.length,e<0&&(e=this.length+e),t<0&&(t=this.length+t),e<0||t>this.length)throw new RangeError("index is out of bounds");if(e===t)return{bufs:[],length:0};if(e===0&&t===this.length)return{bufs:this.bufs,length:this.length};const n=[];let i=0;for(let s=0;s<this.bufs.length;s++){const o=this.bufs[s],a=i,c=a+o.byteLength;if(i=c,e>=c)continue;const l=e>=a&&e<c,u=t>a&&t<=c;if(l&&u){if(e===a&&t===c){n.push(o);break}const d=e-a;n.push(o.subarray(d,d+(t-e)));break}if(l){if(e===0){n.push(o);continue}n.push(o.subarray(e-a));continue}if(u){if(t===c){n.push(o);break}n.push(o.subarray(0,t-a));break}n.push(o)}return{bufs:n,length:t-e}}indexOf(e,t=0){if(!Ka(e)&&!(e instanceof Uint8Array))throw new TypeError('The "value" argument must be a Uint8ArrayList or Uint8Array');const n=e instanceof Uint8Array?e:e.subarray();if(t=Number(t??0),isNaN(t)&&(t=0),t<0&&(t=this.length+t),t<0&&(t=0),e.length===0)return t>this.length?this.length:t;const i=n.byteLength;if(i===0)throw new TypeError("search must be at least 1 byte long");const s=256,o=new Int32Array(s);for(let d=0;d<s;d++)o[d]=-1;for(let d=0;d<i;d++)o[n[d]]=d;const a=o,c=this.byteLength-n.byteLength,l=n.byteLength-1;let u;for(let d=t;d<=c;d+=u){u=0;for(let h=l;h>=0;h--){const f=this.get(d+h);if(n[h]!==f){u=Math.max(1,h-a[f]);break}}if(u===0)return d}return-1}getInt8(e){const t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getInt8(0)}setInt8(e,t){const n=Ar(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setInt8(0,t),this.write(n,e)}getInt16(e,t){const n=this.subarray(e,e+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt16(0,t)}setInt16(e,t,n){const i=Re(2);new DataView(i.buffer,i.byteOffset,i.byteLength).setInt16(0,t,n),this.write(i,e)}getInt32(e,t){const n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt32(0,t)}setInt32(e,t,n){const i=Re(4);new DataView(i.buffer,i.byteOffset,i.byteLength).setInt32(0,t,n),this.write(i,e)}getBigInt64(e,t){const n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigInt64(0,t)}setBigInt64(e,t,n){const i=Re(8);new DataView(i.buffer,i.byteOffset,i.byteLength).setBigInt64(0,t,n),this.write(i,e)}getUint8(e){const t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getUint8(0)}setUint8(e,t){const n=Ar(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setUint8(0,t),this.write(n,e)}getUint16(e,t){const n=this.subarray(e,e+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint16(0,t)}setUint16(e,t,n){const i=Re(2);new DataView(i.buffer,i.byteOffset,i.byteLength).setUint16(0,t,n),this.write(i,e)}getUint32(e,t){const n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint32(0,t)}setUint32(e,t,n){const i=Re(4);new DataView(i.buffer,i.byteOffset,i.byteLength).setUint32(0,t,n),this.write(i,e)}getBigUint64(e,t){const n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigUint64(0,t)}setBigUint64(e,t,n){const i=Re(8);new DataView(i.buffer,i.byteOffset,i.byteLength).setBigUint64(0,t,n),this.write(i,e)}getFloat32(e,t){const n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat32(0,t)}setFloat32(e,t,n){const i=Re(4);new DataView(i.buffer,i.byteOffset,i.byteLength).setFloat32(0,t,n),this.write(i,e)}getFloat64(e,t){const n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat64(0,t)}setFloat64(e,t,n){const i=Re(8);new DataView(i.buffer,i.byteOffset,i.byteLength).setFloat64(0,t,n),this.write(i,e)}equals(e){if(e==null||!(e instanceof me)||e.bufs.length!==this.bufs.length)return!1;for(let t=0;t<this.bufs.length;t++)if(!Te(this.bufs[t],e.bufs[t]))return!1;return!0}static fromUint8Arrays(e,t){const n=new me;return n.bufs=e,t==null&&(t=e.reduce((i,s)=>i+s.byteLength,0)),n.length=t,n}}function W(r,e="utf8"){const t=v8[e];if(t==null)throw new Error(`Unsupported encoding "${e}"`);return t.decoder.decode(`${t.prefix}${r}`)}const BA=parseInt("11111",2),b0=parseInt("10000000",2),LA=parseInt("01111111",2),L4={0:Ba,1:Ba,2:OA,3:UA,4:FA,5:$A,6:MA,16:Ba,22:Ba,48:Ba};function Fs(r,e={offset:0}){const t=r[e.offset]&BA;if(e.offset++,L4[t]!=null)return L4[t](r,e);throw new Error("No decoder for tag "+t)}function ml(r,e){let t=0;if((r[e.offset]&b0)===b0){const n=r[e.offset]&LA;let i="0x";e.offset++;for(let s=0;s<n;s++,e.offset++)i+=r[e.offset].toString(16).padStart(2,"0");t=parseInt(i,16)}else t=r[e.offset],e.offset++;return t}function Ba(r,e){ml(r,e);const t=[];for(;!(e.offset>=r.byteLength);){const n=Fs(r,e);if(n===null)break;t.push(n)}return t}function OA(r,e){const t=ml(r,e),n=e.offset,i=e.offset+t,s=[];for(let o=n;o<i;o++)o===n&&r[o]===0||s.push(r[o]);return e.offset+=t,Uint8Array.from(s)}function MA(r,e){const t=ml(r,e),n=e.offset+t,i=r[e.offset];e.offset++;let s=0,o=0;i<40?(s=0,o=i):i<80?(s=1,o=i-40):(s=2,o=i-80);let a=`${s}.${o}`,c=[];for(;e.offset<n;){const l=r[e.offset];if(e.offset++,c.push(l&127),l<128){c.reverse();let u=0;for(let d=0;d<c.length;d++)u+=c[d]<<d*7;a+=`.${u}`,c=[]}}return a}function $A(r,e){return e.offset++,null}function UA(r,e){const t=ml(r,e),n=r[e.offset];e.offset++;const i=r.subarray(e.offset,e.offset+t-1);if(e.offset+=t,n!==0)throw new Error("Unused bits in bit string is unimplemented");return i}function FA(r,e){const t=ml(r,e),n=r.subarray(e.offset,e.offset+t);return e.offset+=t,n}function VA(r){let e=r.toString(16);e.length%2===1&&(e="0"+e);const t=new me;for(let n=0;n<e.length;n+=2)t.append(Uint8Array.from([parseInt(`${e[n]}${e[n+1]}`,16)]));return t}function zh(r){if(r.byteLength<128)return Uint8Array.from([r.byteLength]);const e=VA(r.byteLength);return new me(Uint8Array.from([e.byteLength|b0]),e)}function yr(r){const e=new me,t=128;return(r.subarray()[0]&t)===t&&e.append(Uint8Array.from([0])),e.append(r),new me(Uint8Array.from([2]),zh(e),e)}function Hp(r){const e=Uint8Array.from([0]),t=new me(e,r);return new me(Uint8Array.from([3]),zh(t),t)}function zA(r){return new me(Uint8Array.from([4]),zh(r),r)}function qn(r,e=48){const t=new me;for(const n of r)t.append(n);return new me(Uint8Array.from([e]),zh(t),t)}const HA="1.2.840.10045.3.1.7",qA="1.3.132.0.34",KA="1.3.132.0.35";async function WA(r="P-256"){const e=await crypto.subtle.generateKey({name:"ECDSA",namedCurve:r},!0,["sign","verify"]);return{publicKey:await crypto.subtle.exportKey("jwk",e.publicKey),privateKey:await crypto.subtle.exportKey("jwk",e.privateKey)}}async function jA(r,e,t){const n=await crypto.subtle.importKey("jwk",r,{name:"ECDSA",namedCurve:r.crv??"P-256"},!1,["sign"]);t?.signal?.throwIfAborted();const i=await crypto.subtle.sign({name:"ECDSA",hash:{name:"SHA-256"}},n,e.subarray());return t?.signal?.throwIfAborted(),new Uint8Array(i,0,i.byteLength)}async function GA(r,e,t,n){const i=await crypto.subtle.importKey("jwk",r,{name:"ECDSA",namedCurve:r.crv??"P-256"},!1,["verify"]);n?.signal?.throwIfAborted();const s=await crypto.subtle.verify({name:"ECDSA",hash:{name:"SHA-256"}},i,e,t.subarray());return n?.signal?.throwIfAborted(),s}const YA=Uint8Array.from([6,8,42,134,72,206,61,3,1,7]),QA=Uint8Array.from([6,5,43,129,4,0,34]),XA=Uint8Array.from([6,5,43,129,4,0,35]),k8={ext:!0,kty:"EC",crv:"P-256"},C8={ext:!0,kty:"EC",crv:"P-384"},I8={ext:!0,kty:"EC",crv:"P-521"},bo=32,vo=48,Eo=66;function ZA(r){const e=Fs(r);return _8(e)}function _8(r){const e=r[1],t=Y(e,"base64url"),n=r[2][1][0],i=1;let s,o;if(e.byteLength===bo)return s=Y(n.subarray(i,i+bo),"base64url"),o=Y(n.subarray(i+bo),"base64url"),new $u({...k8,key_ops:["sign"],d:t,x:s,y:o});if(e.byteLength===vo)return s=Y(n.subarray(i,i+vo),"base64url"),o=Y(n.subarray(i+vo),"base64url"),new $u({...C8,key_ops:["sign"],d:t,x:s,y:o});if(e.byteLength===Eo)return s=Y(n.subarray(i,i+Eo),"base64url"),o=Y(n.subarray(i+Eo),"base64url"),new $u({...I8,key_ops:["sign"],d:t,x:s,y:o});throw new H(`Private key length was wrong length, got ${e.byteLength}, expected 32, 48 or 66`)}function T8(r){const e=Fs(r);return JA(e)}function JA(r){const e=r[1][1][0],t=1;let n,i;if(e.byteLength===bo*2+1)return n=Y(e.subarray(t,t+bo),"base64url"),i=Y(e.subarray(t+bo),"base64url"),new Mu({...k8,key_ops:["verify"],x:n,y:i});if(e.byteLength===vo*2+1)return n=Y(e.subarray(t,t+vo),"base64url"),i=Y(e.subarray(t+vo),"base64url"),new Mu({...C8,key_ops:["verify"],x:n,y:i});if(e.byteLength===Eo*2+1)return n=Y(e.subarray(t,t+Eo),"base64url"),i=Y(e.subarray(t+Eo),"base64url"),new Mu({...I8,key_ops:["verify"],x:n,y:i});throw new H(`coordinates were wrong length, got ${e.byteLength}, expected 65, 97 or 133`)}function ek(r){return qn([yr(Uint8Array.from([1])),zA(W(r.d??"","base64url")),qn([P8(r.crv)],160),qn([Hp(new me(Uint8Array.from([4]),W(r.x??"","base64url"),W(r.y??"","base64url")))],161)]).subarray()}function tk(r){return qn([yr(Uint8Array.from([1])),qn([P8(r.crv)],160),qn([Hp(new me(Uint8Array.from([4]),W(r.x??"","base64url"),W(r.y??"","base64url")))],161)]).subarray()}function P8(r){if(r==="P-256")return YA;if(r==="P-384")return QA;if(r==="P-521")return XA;throw new H(`Invalid curve ${r}`)}async function rk(r="P-256"){const e=await WA(r);return new $u(e.privateKey)}class Mu{type="ECDSA";jwk;_raw;constructor(e){this.jwk=e}get raw(){return this._raw==null&&(this._raw=tk(this.jwk)),this._raw}toMultihash(){return jn.digest(En(this))}toCID(){return ae.createV1(114,this.toMultihash())}toString(){return Ct.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:Te(this.raw,e.raw)}async verify(e,t,n){return GA(this.jwk,t,e,n)}}class $u{type="ECDSA";jwk;publicKey;_raw;constructor(e){this.jwk=e,this.publicKey=new Mu({crv:e.crv,ext:e.ext,key_ops:["verify"],kty:"EC",x:e.x,y:e.y})}get raw(){return this._raw==null&&(this._raw=ek(this.jwk)),this._raw}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:Te(this.raw,e.raw)}async sign(e,t){return jA(this.jwk,e,t)}}function Hh(r){return r instanceof Uint8Array||ArrayBuffer.isView(r)&&r.constructor.name==="Uint8Array"}function Jr(r,e=""){if(!Number.isSafeInteger(r)||r<0){const t=e&&`"${e}" `;throw new Error(`${t}expected integer >= 0, got ${r}`)}}function _e(r,e,t=""){const n=Hh(r),i=r?.length,s=e!==void 0;if(!n||s&&i!==e){const o=t&&`"${t}" `,a=s?` of length ${e}`:"",c=n?`length=${i}`:`type=${typeof r}`;throw new Error(o+"expected Uint8Array"+a+", got "+c)}return r}function yl(r){if(typeof r!="function"||typeof r.create!="function")throw new Error("Hash must wrapped by utils.createHasher");Jr(r.outputLen),Jr(r.blockLen)}function nd(r,e=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(e&&r.finished)throw new Error("Hash#digest() has already been called")}function nk(r,e){_e(r,void 0,"digestInto() output");const t=e.outputLen;if(r.length<t)throw new Error('"digestInto() output" expected to be of length >='+t)}function In(...r){for(let e=0;e<r.length;e++)r[e].fill(0)}function pc(r){return new DataView(r.buffer,r.byteOffset,r.byteLength)}function hn(r,e){return r<<32-e|r>>>e}function p1(r,e){return r<<e|r>>>32-e>>>0}const R8=typeof Uint8Array.from([]).toHex=="function"&&typeof Uint8Array.fromHex=="function",ik=Array.from({length:256},(r,e)=>e.toString(16).padStart(2,"0"));function wl(r){if(_e(r),R8)return r.toHex();let e="";for(let t=0;t<r.length;t++)e+=ik[r[t]];return e}const On={_0:48,_9:57,A:65,F:70,a:97,f:102};function O4(r){if(r>=On._0&&r<=On._9)return r-On._0;if(r>=On.A&&r<=On.F)return r-(On.A-10);if(r>=On.a&&r<=On.f)return r-(On.a-10)}function Lc(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);if(R8)return Uint8Array.fromHex(r);const e=r.length,t=e/2;if(e%2)throw new Error("hex string expected, got unpadded hex of length "+e);const n=new Uint8Array(t);for(let i=0,s=0;i<t;i++,s+=2){const o=O4(r.charCodeAt(s)),a=O4(r.charCodeAt(s+1));if(o===void 0||a===void 0){const c=r[s]+r[s+1];throw new Error('hex string expected, got non-hex character "'+c+'" at index '+s)}n[i]=o*16+a}return n}const sk=async()=>{};async function ok(r,e,t){let n=Date.now();for(let i=0;i<r;i++){t(i);const s=Date.now()-n;s>=0&&s<e||(await sk(),n+=s)}}function ak(r){if(typeof r!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(r))}function M4(r,e=""){return typeof r=="string"?ak(r):_e(r,void 0,e)}function wn(...r){let e=0;for(let n=0;n<r.length;n++){const i=r[n];_e(i),e+=i.length}const t=new Uint8Array(e);for(let n=0,i=0;n<r.length;n++){const s=r[n];t.set(s,i),i+=s.length}return t}function ck(r,e){if(e!==void 0&&{}.toString.call(e)!=="[object Object]")throw new Error("options must be object or undefined");return Object.assign(r,e)}function qp(r,e={}){const t=(i,s)=>r(s).update(i).digest(),n=r(void 0);return t.outputLen=n.outputLen,t.blockLen=n.blockLen,t.create=i=>r(i),Object.assign(t,e),Object.freeze(t)}function bl(r=32){const e=typeof globalThis=="object"?globalThis.crypto:null;if(typeof e?.getRandomValues!="function")throw new Error("crypto.getRandomValues must be defined");return e.getRandomValues(new Uint8Array(r))}const N8=r=>({oid:Uint8Array.from([6,9,96,134,72,1,101,3,4,2,r])});function D8(r,e,t){return r&e^~r&t}function B8(r,e,t){return r&e^r&t^e&t}class Kp{blockLen;outputLen;padOffset;isLE;buffer;view;finished=!1;length=0;pos=0;destroyed=!1;constructor(e,t,n,i){this.blockLen=e,this.outputLen=t,this.padOffset=n,this.isLE=i,this.buffer=new Uint8Array(e),this.view=pc(this.buffer)}update(e){nd(this),_e(e);const{view:t,buffer:n,blockLen:i}=this,s=e.length;for(let o=0;o<s;){const a=Math.min(i-this.pos,s-o);if(a===i){const c=pc(e);for(;i<=s-o;o+=i)this.process(c,o);continue}n.set(e.subarray(o,o+a),this.pos),this.pos+=a,o+=a,this.pos===i&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){nd(this),nk(e,this),this.finished=!0;const{buffer:t,view:n,blockLen:i,isLE:s}=this;let{pos:o}=this;t[o++]=128,In(this.buffer.subarray(o)),this.padOffset>i-o&&(this.process(n,0),o=0);for(let d=o;d<i;d++)t[d]=0;n.setBigUint64(i-8,BigInt(this.length*8),s),this.process(n,0);const a=pc(e),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen must be aligned to 32bit");const l=c/4,u=this.get();if(l>u.length)throw new Error("_sha2: outputLen bigger than state");for(let d=0;d<l;d++)a.setUint32(4*d,u[d],s)}digest(){const{buffer:e,outputLen:t}=this;this.digestInto(e);const n=e.slice(0,t);return this.destroy(),n}_cloneInto(e){e||=new this.constructor,e.set(...this.get());const{blockLen:t,buffer:n,length:i,finished:s,destroyed:o,pos:a}=this;return e.destroyed=o,e.finished=s,e.length=i,e.pos=a,i%t&&e.buffer.set(n),e}clone(){return this._cloneInto()}}const ui=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),zt=Uint32Array.from([1779033703,4089235720,3144134277,2227873595,1013904242,4271175723,2773480762,1595750129,1359893119,2917565137,2600822924,725511199,528734635,4215389547,1541459225,327033209]),Ql=BigInt(2**32-1),$4=BigInt(32);function lk(r,e=!1){return e?{h:Number(r&Ql),l:Number(r>>$4&Ql)}:{h:Number(r>>$4&Ql)|0,l:Number(r&Ql)|0}}function uk(r,e=!1){const t=r.length;let n=new Uint32Array(t),i=new Uint32Array(t);for(let s=0;s<t;s++){const{h:o,l:a}=lk(r[s],e);[n[s],i[s]]=[o,a]}return[n,i]}const U4=(r,e,t)=>r>>>t,F4=(r,e,t)=>r<<32-t|e>>>t,eo=(r,e,t)=>r>>>t|e<<32-t,to=(r,e,t)=>r<<32-t|e>>>t,Xl=(r,e,t)=>r<<64-t|e>>>t-32,Zl=(r,e,t)=>r>>>t-32|e<<64-t;function Mn(r,e,t,n){const i=(e>>>0)+(n>>>0);return{h:r+t+(i/2**32|0)|0,l:i|0}}const dk=(r,e,t)=>(r>>>0)+(e>>>0)+(t>>>0),hk=(r,e,t,n)=>e+t+n+(r/2**32|0)|0,fk=(r,e,t,n)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0),pk=(r,e,t,n,i)=>e+t+n+i+(r/2**32|0)|0,gk=(r,e,t,n,i)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0)+(i>>>0),mk=(r,e,t,n,i,s)=>e+t+n+i+s+(r/2**32|0)|0,yk=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),di=new Uint32Array(64);class wk extends Kp{constructor(e){super(64,e,8,!1)}get(){const{A:e,B:t,C:n,D:i,E:s,F:o,G:a,H:c}=this;return[e,t,n,i,s,o,a,c]}set(e,t,n,i,s,o,a,c){this.A=e|0,this.B=t|0,this.C=n|0,this.D=i|0,this.E=s|0,this.F=o|0,this.G=a|0,this.H=c|0}process(e,t){for(let d=0;d<16;d++,t+=4)di[d]=e.getUint32(t,!1);for(let d=16;d<64;d++){const h=di[d-15],f=di[d-2],y=hn(h,7)^hn(h,18)^h>>>3,m=hn(f,17)^hn(f,19)^f>>>10;di[d]=m+di[d-7]+y+di[d-16]|0}let{A:n,B:i,C:s,D:o,E:a,F:c,G:l,H:u}=this;for(let d=0;d<64;d++){const h=hn(a,6)^hn(a,11)^hn(a,25),f=u+h+D8(a,c,l)+yk[d]+di[d]|0,m=(hn(n,2)^hn(n,13)^hn(n,22))+B8(n,i,s)|0;u=l,l=c,c=a,a=o+f|0,o=s,s=i,i=n,n=f+m|0}n=n+this.A|0,i=i+this.B|0,s=s+this.C|0,o=o+this.D|0,a=a+this.E|0,c=c+this.F|0,l=l+this.G|0,u=u+this.H|0,this.set(n,i,s,o,a,c,l,u)}roundClean(){In(di)}destroy(){this.set(0,0,0,0,0,0,0,0),In(this.buffer)}}class bk extends wk{A=ui[0]|0;B=ui[1]|0;C=ui[2]|0;D=ui[3]|0;E=ui[4]|0;F=ui[5]|0;G=ui[6]|0;H=ui[7]|0;constructor(){super(32)}}const L8=uk(["0x428a2f98d728ae22","0x7137449123ef65cd","0xb5c0fbcfec4d3b2f","0xe9b5dba58189dbbc","0x3956c25bf348b538","0x59f111f1b605d019","0x923f82a4af194f9b","0xab1c5ed5da6d8118","0xd807aa98a3030242","0x12835b0145706fbe","0x243185be4ee4b28c","0x550c7dc3d5ffb4e2","0x72be5d74f27b896f","0x80deb1fe3b1696b1","0x9bdc06a725c71235","0xc19bf174cf692694","0xe49b69c19ef14ad2","0xefbe4786384f25e3","0x0fc19dc68b8cd5b5","0x240ca1cc77ac9c65","0x2de92c6f592b0275","0x4a7484aa6ea6e483","0x5cb0a9dcbd41fbd4","0x76f988da831153b5","0x983e5152ee66dfab","0xa831c66d2db43210","0xb00327c898fb213f","0xbf597fc7beef0ee4","0xc6e00bf33da88fc2","0xd5a79147930aa725","0x06ca6351e003826f","0x142929670a0e6e70","0x27b70a8546d22ffc","0x2e1b21385c26c926","0x4d2c6dfc5ac42aed","0x53380d139d95b3df","0x650a73548baf63de","0x766a0abb3c77b2a8","0x81c2c92e47edaee6","0x92722c851482353b","0xa2bfe8a14cf10364","0xa81a664bbc423001","0xc24b8b70d0f89791","0xc76c51a30654be30","0xd192e819d6ef5218","0xd69906245565a910","0xf40e35855771202a","0x106aa07032bbd1b8","0x19a4c116b8d2d0c8","0x1e376c085141ab53","0x2748774cdf8eeb99","0x34b0bcb5e19b48a8","0x391c0cb3c5c95a63","0x4ed8aa4ae3418acb","0x5b9cca4f7763e373","0x682e6ff3d6b2b8a3","0x748f82ee5defb2fc","0x78a5636f43172f60","0x84c87814a1f0ab72","0x8cc702081a6439ec","0x90befffa23631e28","0xa4506cebde82bde9","0xbef9a3f7b2c67915","0xc67178f2e372532b","0xca273eceea26619c","0xd186b8c721c0c207","0xeada7dd6cde0eb1e","0xf57d4f7fee6ed178","0x06f067aa72176fba","0x0a637dc5a2c898a6","0x113f9804bef90dae","0x1b710b35131c471b","0x28db77f523047d84","0x32caab7b40c72493","0x3c9ebe0a15c9bebc","0x431d67c49c100d4c","0x4cc5d4becb3e42b6","0x597f299cfc657e2a","0x5fcb6fab3ad6faec","0x6c44198c4a475817"].map(r=>BigInt(r))),vk=L8[0],Ek=L8[1],hi=new Uint32Array(80),fi=new Uint32Array(80);class Sk extends Kp{constructor(e){super(128,e,16,!1)}get(){const{Ah:e,Al:t,Bh:n,Bl:i,Ch:s,Cl:o,Dh:a,Dl:c,Eh:l,El:u,Fh:d,Fl:h,Gh:f,Gl:y,Hh:m,Hl:p}=this;return[e,t,n,i,s,o,a,c,l,u,d,h,f,y,m,p]}set(e,t,n,i,s,o,a,c,l,u,d,h,f,y,m,p){this.Ah=e|0,this.Al=t|0,this.Bh=n|0,this.Bl=i|0,this.Ch=s|0,this.Cl=o|0,this.Dh=a|0,this.Dl=c|0,this.Eh=l|0,this.El=u|0,this.Fh=d|0,this.Fl=h|0,this.Gh=f|0,this.Gl=y|0,this.Hh=m|0,this.Hl=p|0}process(e,t){for(let v=0;v<16;v++,t+=4)hi[v]=e.getUint32(t),fi[v]=e.getUint32(t+=4);for(let v=16;v<80;v++){const C=hi[v-15]|0,T=fi[v-15]|0,R=eo(C,T,1)^eo(C,T,8)^U4(C,T,7),L=to(C,T,1)^to(C,T,8)^F4(C,T,7),N=hi[v-2]|0,E=fi[v-2]|0,O=eo(N,E,19)^Xl(N,E,61)^U4(N,E,6),V=to(N,E,19)^Zl(N,E,61)^F4(N,E,6),$=fk(L,V,fi[v-7],fi[v-16]),I=pk($,R,O,hi[v-7],hi[v-16]);hi[v]=I|0,fi[v]=$|0}let{Ah:n,Al:i,Bh:s,Bl:o,Ch:a,Cl:c,Dh:l,Dl:u,Eh:d,El:h,Fh:f,Fl:y,Gh:m,Gl:p,Hh:b,Hl:A}=this;for(let v=0;v<80;v++){const C=eo(d,h,14)^eo(d,h,18)^Xl(d,h,41),T=to(d,h,14)^to(d,h,18)^Zl(d,h,41),R=d&f^~d&m,L=h&y^~h&p,N=gk(A,T,L,Ek[v],fi[v]),E=mk(N,b,C,R,vk[v],hi[v]),O=N|0,V=eo(n,i,28)^Xl(n,i,34)^Xl(n,i,39),$=to(n,i,28)^Zl(n,i,34)^Zl(n,i,39),I=n&s^n&a^s&a,k=i&o^i&c^o&c;b=m|0,A=p|0,m=f|0,p=y|0,f=d|0,y=h|0,{h:d,l:h}=Mn(l|0,u|0,E|0,O|0),l=a|0,u=c|0,a=s|0,c=o|0,s=n|0,o=i|0;const S=dk(O,$,k);n=hk(S,E,V,I),i=S|0}({h:n,l:i}=Mn(this.Ah|0,this.Al|0,n|0,i|0)),{h:s,l:o}=Mn(this.Bh|0,this.Bl|0,s|0,o|0),{h:a,l:c}=Mn(this.Ch|0,this.Cl|0,a|0,c|0),{h:l,l:u}=Mn(this.Dh|0,this.Dl|0,l|0,u|0),{h:d,l:h}=Mn(this.Eh|0,this.El|0,d|0,h|0),{h:f,l:y}=Mn(this.Fh|0,this.Fl|0,f|0,y|0),{h:m,l:p}=Mn(this.Gh|0,this.Gl|0,m|0,p|0),{h:b,l:A}=Mn(this.Hh|0,this.Hl|0,b|0,A|0),this.set(n,i,s,o,a,c,l,u,d,h,f,y,m,p,b,A)}roundClean(){In(hi,fi)}destroy(){In(this.buffer),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}}class xk extends Sk{Ah=zt[0]|0;Al=zt[1]|0;Bh=zt[2]|0;Bl=zt[3]|0;Ch=zt[4]|0;Cl=zt[5]|0;Dh=zt[6]|0;Dl=zt[7]|0;Eh=zt[8]|0;El=zt[9]|0;Fh=zt[10]|0;Fl=zt[11]|0;Gh=zt[12]|0;Gl=zt[13]|0;Hh=zt[14]|0;Hl=zt[15]|0;constructor(){super(64)}}const Ti=qp(()=>new bk,N8(1)),qh=qp(()=>new xk,N8(3));const Wp=BigInt(0),v0=BigInt(1);function vs(r,e=""){if(typeof r!="boolean"){const t=e&&`"${e}" `;throw new Error(t+"expected boolean, got type="+typeof r)}return r}function O8(r){if(typeof r=="bigint"){if(!Uu(r))throw new Error("positive bigint expected, got "+r)}else Jr(r);return r}function Jl(r){const e=O8(r).toString(16);return e.length&1?"0"+e:e}function M8(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);return r===""?Wp:BigInt("0x"+r)}function Kh(r){return M8(wl(r))}function Es(r){return M8(wl(Oc(_e(r)).reverse()))}function jp(r,e){Jr(e),r=O8(r);const t=Lc(r.toString(16).padStart(e*2,"0"));if(t.length!==e)throw new Error("number too large");return t}function Gp(r,e){return jp(r,e).reverse()}function Oc(r){return Uint8Array.from(r)}const Uu=r=>typeof r=="bigint"&&Wp<=r;function Ak(r,e,t){return Uu(r)&&Uu(e)&&Uu(t)&&e<=r&&r<t}function Mc(r,e,t,n){if(!Ak(e,t,n))throw new Error("expected valid "+r+": "+t+" <= n < "+n+", got "+e)}function kk(r){let e;for(e=0;r>Wp;r>>=v0,e+=1);return e}const Yp=r=>(v0<<BigInt(r))-v0;function Ck(r,e,t){if(Jr(r,"hashLen"),Jr(e,"qByteLen"),typeof t!="function")throw new Error("hmacFn must be a function");const n=p=>new Uint8Array(p),i=Uint8Array.of(),s=Uint8Array.of(0),o=Uint8Array.of(1),a=1e3;let c=n(r),l=n(r),u=0;const d=()=>{c.fill(1),l.fill(0),u=0},h=(...p)=>t(l,wn(c,...p)),f=(p=i)=>{l=h(s,p),c=h(),p.length!==0&&(l=h(o,p),c=h())},y=()=>{if(u++>=a)throw new Error("drbg: tried max amount of iterations");let p=0;const b=[];for(;p<e;){c=h();const A=c.slice();b.push(A),p+=c.length}return wn(...b)};return(p,b)=>{d(),f(p);let A;for(;!(A=b(y()));)f();return d(),A}}function ua(r,e={},t={}){if(!r||typeof r!="object")throw new Error("expected valid options object");function n(s,o,a){const c=r[s];if(a&&c===void 0)return;const l=typeof c;if(l!==o||c===null)throw new Error(`param "${s}" is invalid: expected ${o}, got ${l}`)}const i=(s,o)=>Object.entries(s).forEach(([a,c])=>n(a,c,o));i(e,!1),i(t,!0)}function id(r){const e=new WeakMap;return(t,...n)=>{const i=e.get(t);if(i!==void 0)return i;const s=r(t,...n);return e.set(t,s),s}}const fr=BigInt(0),Lt=BigInt(1),ns=BigInt(2),$8=BigInt(3),U8=BigInt(4),F8=BigInt(5),Ik=BigInt(7),V8=BigInt(8),_k=BigInt(9),z8=BigInt(16);function lt(r,e){const t=r%e;return t>=fr?t:e+t}function ct(r,e,t){let n=r;for(;e-- >fr;)n*=n,n%=t;return n}function V4(r,e){if(r===fr)throw new Error("invert: expected non-zero number");if(e<=fr)throw new Error("invert: expected positive modulus, got "+e);let t=lt(r,e),n=e,i=fr,s=Lt;for(;t!==fr;){const a=n/t,c=n%t,l=i-s*a;n=t,t=c,i=s,s=l}if(n!==Lt)throw new Error("invert: does not exist");return lt(i,e)}function Qp(r,e,t){if(!r.eql(r.sqr(e),t))throw new Error("Cannot find square root")}function H8(r,e){const t=(r.ORDER+Lt)/U8,n=r.pow(e,t);return Qp(r,n,e),n}function Tk(r,e){const t=(r.ORDER-F8)/V8,n=r.mul(e,ns),i=r.pow(n,t),s=r.mul(e,i),o=r.mul(r.mul(s,ns),i),a=r.mul(s,r.sub(o,r.ONE));return Qp(r,a,e),a}function Pk(r){const e=Wh(r),t=q8(r),n=t(e,e.neg(e.ONE)),i=t(e,n),s=t(e,e.neg(n)),o=(r+Ik)/z8;return(a,c)=>{let l=a.pow(c,o),u=a.mul(l,n);const d=a.mul(l,i),h=a.mul(l,s),f=a.eql(a.sqr(u),c),y=a.eql(a.sqr(d),c);l=a.cmov(l,u,f),u=a.cmov(h,d,y);const m=a.eql(a.sqr(u),c),p=a.cmov(l,u,m);return Qp(a,p,c),p}}function q8(r){if(r<$8)throw new Error("sqrt is not defined for small field");let e=r-Lt,t=0;for(;e%ns===fr;)e/=ns,t++;let n=ns;const i=Wh(r);for(;z4(i,n)===1;)if(n++>1e3)throw new Error("Cannot find square root: probably non-prime P");if(t===1)return H8;let s=i.pow(n,e);const o=(e+Lt)/ns;return function(c,l){if(c.is0(l))return l;if(z4(c,l)!==1)throw new Error("Cannot find square root");let u=t,d=c.mul(c.ONE,s),h=c.pow(l,e),f=c.pow(l,o);for(;!c.eql(h,c.ONE);){if(c.is0(h))return c.ZERO;let y=1,m=c.sqr(h);for(;!c.eql(m,c.ONE);)if(y++,m=c.sqr(m),y===u)throw new Error("Cannot find square root");const p=Lt<<BigInt(u-y-1),b=c.pow(d,p);u=y,d=c.sqr(b),h=c.mul(h,d),f=c.mul(f,b)}return f}}function Rk(r){return r%U8===$8?H8:r%V8===F8?Tk:r%z8===_k?Pk(r):q8(r)}const Nk=(r,e)=>(lt(r,e)&Lt)===Lt,Dk=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function Bk(r){const e={ORDER:"bigint",BYTES:"number",BITS:"number"},t=Dk.reduce((n,i)=>(n[i]="function",n),e);return ua(r,t),r}function Lk(r,e,t){if(t<fr)throw new Error("invalid exponent, negatives unsupported");if(t===fr)return r.ONE;if(t===Lt)return e;let n=r.ONE,i=e;for(;t>fr;)t&Lt&&(n=r.mul(n,i)),i=r.sqr(i),t>>=Lt;return n}function K8(r,e,t=!1){const n=new Array(e.length).fill(t?r.ZERO:void 0),i=e.reduce((o,a,c)=>r.is0(a)?o:(n[c]=o,r.mul(o,a)),r.ONE),s=r.inv(i);return e.reduceRight((o,a,c)=>r.is0(a)?o:(n[c]=r.mul(o,n[c]),r.mul(o,a)),s),n}function z4(r,e){const t=(r.ORDER-Lt)/ns,n=r.pow(e,t),i=r.eql(n,r.ONE),s=r.eql(n,r.ZERO),o=r.eql(n,r.neg(r.ONE));if(!i&&!s&&!o)throw new Error("invalid Legendre symbol result");return i?1:s?0:-1}function Ok(r,e){e!==void 0&&Jr(e);const t=e!==void 0?e:r.toString(2).length,n=Math.ceil(t/8);return{nBitLength:t,nByteLength:n}}class Mk{ORDER;BITS;BYTES;isLE;ZERO=fr;ONE=Lt;_lengths;_sqrt;_mod;constructor(e,t={}){if(e<=fr)throw new Error("invalid field: expected ORDER > 0, got "+e);let n;this.isLE=!1,t!=null&&typeof t=="object"&&(typeof t.BITS=="number"&&(n=t.BITS),typeof t.sqrt=="function"&&(this.sqrt=t.sqrt),typeof t.isLE=="boolean"&&(this.isLE=t.isLE),t.allowedLengths&&(this._lengths=t.allowedLengths?.slice()),typeof t.modFromBytes=="boolean"&&(this._mod=t.modFromBytes));const{nBitLength:i,nByteLength:s}=Ok(e,n);if(s>2048)throw new Error("invalid field: expected ORDER of <= 2048 bytes");this.ORDER=e,this.BITS=i,this.BYTES=s,this._sqrt=void 0,Object.preventExtensions(this)}create(e){return lt(e,this.ORDER)}isValid(e){if(typeof e!="bigint")throw new Error("invalid field element: expected bigint, got "+typeof e);return fr<=e&&e<this.ORDER}is0(e){return e===fr}isValidNot0(e){return!this.is0(e)&&this.isValid(e)}isOdd(e){return(e&Lt)===Lt}neg(e){return lt(-e,this.ORDER)}eql(e,t){return e===t}sqr(e){return lt(e*e,this.ORDER)}add(e,t){return lt(e+t,this.ORDER)}sub(e,t){return lt(e-t,this.ORDER)}mul(e,t){return lt(e*t,this.ORDER)}pow(e,t){return Lk(this,e,t)}div(e,t){return lt(e*V4(t,this.ORDER),this.ORDER)}sqrN(e){return e*e}addN(e,t){return e+t}subN(e,t){return e-t}mulN(e,t){return e*t}inv(e){return V4(e,this.ORDER)}sqrt(e){return this._sqrt||(this._sqrt=Rk(this.ORDER)),this._sqrt(this,e)}toBytes(e){return this.isLE?Gp(e,this.BYTES):jp(e,this.BYTES)}fromBytes(e,t=!1){_e(e);const{_lengths:n,BYTES:i,isLE:s,ORDER:o,_mod:a}=this;if(n){if(!n.includes(e.length)||e.length>i)throw new Error("Field.fromBytes: expected "+n+" bytes, got "+e.length);const l=new Uint8Array(i);l.set(e,s?0:l.length-e.length),e=l}if(e.length!==i)throw new Error("Field.fromBytes: expected "+i+" bytes, got "+e.length);let c=s?Es(e):Kh(e);if(a&&(c=lt(c,o)),!t&&!this.isValid(c))throw new Error("invalid field element: outside of range 0..ORDER");return c}invertBatch(e){return K8(this,e)}cmov(e,t,n){return n?t:e}}function Wh(r,e={}){return new Mk(r,e)}function W8(r){if(typeof r!="bigint")throw new Error("field order must be bigint");const e=r.toString(2).length;return Math.ceil(e/8)}function j8(r){const e=W8(r);return e+Math.ceil(e/2)}function $k(r,e,t=!1){_e(r);const n=r.length,i=W8(e),s=j8(e);if(n<16||n<s||n>1024)throw new Error("expected "+s+"-1024 bytes of input, got "+n);const o=t?Es(r):Kh(r),a=lt(o,e-Lt)+Lt;return t?Gp(a,i):jp(a,i)}const Lo=BigInt(0),is=BigInt(1);function sd(r,e){const t=e.negate();return r?t:e}function gc(r,e){const t=K8(r.Fp,e.map(n=>n.Z));return e.map((n,i)=>r.fromAffine(n.toAffine(t[i])))}function G8(r,e){if(!Number.isSafeInteger(r)||r<=0||r>e)throw new Error("invalid window size, expected [1.."+e+"], got W="+r)}function g1(r,e){G8(r,e);const t=Math.ceil(e/r)+1,n=2**(r-1),i=2**r,s=Yp(r),o=BigInt(r);return{windows:t,windowSize:n,mask:s,maxNumber:i,shiftBy:o}}function H4(r,e,t){const{windowSize:n,mask:i,maxNumber:s,shiftBy:o}=t;let a=Number(r&i),c=r>>o;a>n&&(a-=s,c+=is);const l=e*n,u=l+Math.abs(a)-1,d=a===0,h=a<0,f=e%2!==0;return{nextN:c,offset:u,isZero:d,isNeg:h,isNegF:f,offsetF:l}}const m1=new WeakMap,Y8=new WeakMap;function y1(r){return Y8.get(r)||1}function q4(r){if(r!==Lo)throw new Error("invalid wNAF")}class Q8{BASE;ZERO;Fn;bits;constructor(e,t){this.BASE=e.BASE,this.ZERO=e.ZERO,this.Fn=e.Fn,this.bits=t}_unsafeLadder(e,t,n=this.ZERO){let i=e;for(;t>Lo;)t&is&&(n=n.add(i)),i=i.double(),t>>=is;return n}precomputeWindow(e,t){const{windows:n,windowSize:i}=g1(t,this.bits),s=[];let o=e,a=o;for(let c=0;c<n;c++){a=o,s.push(a);for(let l=1;l<i;l++)a=a.add(o),s.push(a);o=a.double()}return s}wNAF(e,t,n){if(!this.Fn.isValid(n))throw new Error("invalid scalar");let i=this.ZERO,s=this.BASE;const o=g1(e,this.bits);for(let a=0;a<o.windows;a++){const{nextN:c,offset:l,isZero:u,isNeg:d,isNegF:h,offsetF:f}=H4(n,a,o);n=c,u?s=s.add(sd(h,t[f])):i=i.add(sd(d,t[l]))}return q4(n),{p:i,f:s}}wNAFUnsafe(e,t,n,i=this.ZERO){const s=g1(e,this.bits);for(let o=0;o<s.windows&&n!==Lo;o++){const{nextN:a,offset:c,isZero:l,isNeg:u}=H4(n,o,s);if(n=a,!l){const d=t[c];i=i.add(u?d.negate():d)}}return q4(n),i}getPrecomputes(e,t,n){let i=m1.get(t);return i||(i=this.precomputeWindow(t,e),e!==1&&(typeof n=="function"&&(i=n(i)),m1.set(t,i))),i}cached(e,t,n){const i=y1(e);return this.wNAF(i,this.getPrecomputes(i,e,n),t)}unsafe(e,t,n,i){const s=y1(e);return s===1?this._unsafeLadder(e,t,i):this.wNAFUnsafe(s,this.getPrecomputes(s,e,n),t,i)}createCache(e,t){G8(t,this.bits),Y8.set(e,t),m1.delete(e)}hasCache(e){return y1(e)!==1}}function Uk(r,e,t,n){let i=e,s=r.ZERO,o=r.ZERO;for(;t>Lo||n>Lo;)t&is&&(s=s.add(i)),n&is&&(o=o.add(i)),i=i.double(),t>>=is,n>>=is;return{p1:s,p2:o}}function K4(r,e,t){if(e){if(e.ORDER!==r)throw new Error("Field.ORDER must match order: Fp == p, Fn == n");return Bk(e),e}else return Wh(r,{isLE:t})}function X8(r,e,t={},n){if(n===void 0&&(n=r==="edwards"),!e||typeof e!="object")throw new Error(`expected valid ${r} CURVE object`);for(const c of["p","n","h"]){const l=e[c];if(!(typeof l=="bigint"&&l>Lo))throw new Error(`CURVE.${c} must be positive bigint`)}const i=K4(e.p,t.Fp,n),s=K4(e.n,t.Fn,n),a=["Gx","Gy","a",r==="weierstrass"?"b":"d"];for(const c of a)if(!i.isValid(e[c]))throw new Error(`CURVE.${c} must be valid field element of CURVE.Fp`);return e=Object.freeze(Object.assign({},e)),{CURVE:e,Fp:i,Fn:s}}function Xp(r,e){return function(n){const i=r(n);return{secretKey:i,publicKey:e(i)}}}const pi=BigInt(0),xt=BigInt(1),w1=BigInt(2),Fk=BigInt(8);function Vk(r,e,t,n){const i=r.sqr(t),s=r.sqr(n),o=r.add(r.mul(e.a,i),s),a=r.add(r.ONE,r.mul(e.d,r.mul(i,s)));return r.eql(o,a)}function zk(r,e={}){const t=X8("edwards",r,e,e.FpFnLE),{Fp:n,Fn:i}=t;let s=t.CURVE;const{h:o}=s;ua(e,{},{uvRatio:"function"});const a=w1<<BigInt(i.BYTES*8)-xt,c=p=>n.create(p),l=e.uvRatio||((p,b)=>{try{return{isValid:!0,value:n.sqrt(n.div(p,b))}}catch{return{isValid:!1,value:pi}}});if(!Vk(n,s,s.Gx,s.Gy))throw new Error("bad curve params: generator point");function u(p,b,A=!1){const v=A?xt:pi;return Mc("coordinate "+p,b,v,a),b}function d(p){if(!(p instanceof y))throw new Error("EdwardsPoint expected")}const h=id((p,b)=>{const{X:A,Y:v,Z:C}=p,T=p.is0();b==null&&(b=T?Fk:n.inv(C));const R=c(A*b),L=c(v*b),N=n.mul(C,b);if(T)return{x:pi,y:xt};if(N!==xt)throw new Error("invZ was invalid");return{x:R,y:L}}),f=id(p=>{const{a:b,d:A}=s;if(p.is0())throw new Error("bad point: ZERO");const{X:v,Y:C,Z:T,T:R}=p,L=c(v*v),N=c(C*C),E=c(T*T),O=c(E*E),V=c(L*b),$=c(E*c(V+N)),I=c(O+c(A*c(L*N)));if($!==I)throw new Error("bad point: equation left != right (1)");const k=c(v*C),S=c(T*R);if(k!==S)throw new Error("bad point: equation left != right (2)");return!0});class y{static BASE=new y(s.Gx,s.Gy,xt,c(s.Gx*s.Gy));static ZERO=new y(pi,xt,xt,pi);static Fp=n;static Fn=i;X;Y;Z;T;constructor(b,A,v,C){this.X=u("x",b),this.Y=u("y",A),this.Z=u("z",v,!0),this.T=u("t",C),Object.freeze(this)}static CURVE(){return s}static fromAffine(b){if(b instanceof y)throw new Error("extended point not allowed");const{x:A,y:v}=b||{};return u("x",A),u("y",v),new y(A,v,xt,c(A*v))}static fromBytes(b,A=!1){const v=n.BYTES,{a:C,d:T}=s;b=Oc(_e(b,v,"point")),vs(A,"zip215");const R=Oc(b),L=b[v-1];R[v-1]=L&-129;const N=Es(R),E=A?a:n.ORDER;Mc("point.y",N,pi,E);const O=c(N*N),V=c(O-xt),$=c(T*O-C);let{isValid:I,value:k}=l(V,$);if(!I)throw new Error("bad point: invalid y coordinate");const S=(k&xt)===xt,B=(L&128)!==0;if(!A&&k===pi&&B)throw new Error("bad point: x=0 and x_0=1");return B!==S&&(k=c(-k)),y.fromAffine({x:k,y:N})}static fromHex(b,A=!1){return y.fromBytes(Lc(b),A)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(b=8,A=!0){return m.createCache(this,b),A||this.multiply(w1),this}assertValidity(){f(this)}equals(b){d(b);const{X:A,Y:v,Z:C}=this,{X:T,Y:R,Z:L}=b,N=c(A*L),E=c(T*C),O=c(v*L),V=c(R*C);return N===E&&O===V}is0(){return this.equals(y.ZERO)}negate(){return new y(c(-this.X),this.Y,this.Z,c(-this.T))}double(){const{a:b}=s,{X:A,Y:v,Z:C}=this,T=c(A*A),R=c(v*v),L=c(w1*c(C*C)),N=c(b*T),E=A+v,O=c(c(E*E)-T-R),V=N+R,$=V-L,I=N-R,k=c(O*$),S=c(V*I),B=c(O*I),U=c($*V);return new y(k,S,U,B)}add(b){d(b);const{a:A,d:v}=s,{X:C,Y:T,Z:R,T:L}=this,{X:N,Y:E,Z:O,T:V}=b,$=c(C*N),I=c(T*E),k=c(L*v*V),S=c(R*O),B=c((C+T)*(N+E)-$-I),U=S-k,q=S+k,M=c(I-A*$),K=c(B*U),Q=c(q*M),re=c(B*M),X=c(U*q);return new y(K,Q,X,re)}subtract(b){return this.add(b.negate())}multiply(b){if(!i.isValidNot0(b))throw new Error("invalid scalar: expected 1 <= sc < curve.n");const{p:A,f:v}=m.cached(this,b,C=>gc(y,C));return gc(y,[A,v])[0]}multiplyUnsafe(b,A=y.ZERO){if(!i.isValid(b))throw new Error("invalid scalar: expected 0 <= sc < curve.n");return b===pi?y.ZERO:this.is0()||b===xt?this:m.unsafe(this,b,v=>gc(y,v),A)}isSmallOrder(){return this.multiplyUnsafe(o).is0()}isTorsionFree(){return m.unsafe(this,s.n).is0()}toAffine(b){return h(this,b)}clearCofactor(){return o===xt?this:this.multiplyUnsafe(o)}toBytes(){const{x:b,y:A}=this.toAffine(),v=n.toBytes(A);return v[v.length-1]|=b&xt?128:0,v}toHex(){return wl(this.toBytes())}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}}const m=new Q8(y,i.BITS);return y.BASE.precompute(8),y}function Hk(r,e,t={}){if(typeof e!="function")throw new Error('"hash" function param is required');ua(t,{},{adjustScalarBytes:"function",randomBytes:"function",domain:"function",prehash:"function",mapToCurve:"function"});const{prehash:n}=t,{BASE:i,Fp:s,Fn:o}=r,a=t.randomBytes||bl,c=t.adjustScalarBytes||(N=>N),l=t.domain||((N,E,O)=>{if(vs(O,"phflag"),E.length||O)throw new Error("Contexts/pre-hash are not supported");return N});function u(N){return o.create(Es(N))}function d(N){const E=v.secretKey;_e(N,v.secretKey,"secretKey");const O=_e(e(N),2*E,"hashedSecretKey"),V=c(O.slice(0,E)),$=O.slice(E,2*E),I=u(V);return{head:V,prefix:$,scalar:I}}function h(N){const{head:E,prefix:O,scalar:V}=d(N),$=i.multiply(V),I=$.toBytes();return{head:E,prefix:O,scalar:V,point:$,pointBytes:I}}function f(N){return h(N).pointBytes}function y(N=Uint8Array.of(),...E){const O=wn(...E);return u(e(l(O,_e(N,void 0,"context"),!!n)))}function m(N,E,O={}){N=_e(N,void 0,"message"),n&&(N=n(N));const{prefix:V,scalar:$,pointBytes:I}=h(E),k=y(O.context,V,N),S=i.multiply(k).toBytes(),B=y(O.context,S,I,N),U=o.create(k+B*$);if(!o.isValid(U))throw new Error("sign failed: invalid s");const q=wn(S,o.toBytes(U));return _e(q,v.signature,"result")}const p={zip215:!0};function b(N,E,O,V=p){const{context:$,zip215:I}=V,k=v.signature;N=_e(N,k,"signature"),E=_e(E,void 0,"message"),O=_e(O,v.publicKey,"publicKey"),I!==void 0&&vs(I,"zip215"),n&&(E=n(E));const S=k/2,B=N.subarray(0,S),U=Es(N.subarray(S,k));let q,M,K;try{q=r.fromBytes(O,I),M=r.fromBytes(B,I),K=i.multiplyUnsafe(U)}catch{return!1}if(!I&&q.isSmallOrder())return!1;const Q=y($,M.toBytes(),q.toBytes(),E);return M.add(q.multiplyUnsafe(Q)).subtract(K).clearCofactor().is0()}const A=s.BYTES,v={secretKey:A,publicKey:A,signature:2*A,seed:A};function C(N=a(v.seed)){return _e(N,v.seed,"seed")}function T(N){return Hh(N)&&N.length===o.BYTES}function R(N,E){try{return!!r.fromBytes(N,E)}catch{return!1}}const L={getExtendedPublicKey:h,randomSecretKey:C,isValidSecretKey:T,isValidPublicKey:R,toMontgomery(N){const{y:E}=r.fromBytes(N),O=v.publicKey,V=O===32;if(!V&&O!==57)throw new Error("only defined for 25519 and 448");const $=V?s.div(xt+E,xt-E):s.div(E-xt,E+xt);return s.toBytes($)},toMontgomerySecret(N){const E=v.secretKey;_e(N,E);const O=e(N.subarray(0,E));return c(O).subarray(0,E)}};return Object.freeze({keygen:Xp(C,f),getPublicKey:f,sign:m,verify:b,utils:L,Point:r,lengths:v})}const La=BigInt(0),ro=BigInt(1),eu=BigInt(2);function qk(r){return ua(r,{adjustScalarBytes:"function",powPminus2:"function"}),Object.freeze({...r})}function Kk(r){const e=qk(r),{P:t,type:n,adjustScalarBytes:i,powPminus2:s,randomBytes:o}=e,a=n==="x25519";if(!a&&n!=="x448")throw new Error("invalid type");const c=o||bl,l=a?255:448,u=a?32:56,d=BigInt(a?9:5),h=BigInt(a?121665:39081),f=a?eu**BigInt(254):eu**BigInt(447),y=a?BigInt(8)*eu**BigInt(251)-ro:BigInt(4)*eu**BigInt(445)-ro,m=f+y+ro,p=k=>lt(k,t),b=A(d);function A(k){return Gp(p(k),u)}function v(k){const S=Oc(_e(k,u,"uCoordinate"));return a&&(S[31]&=127),p(Es(S))}function C(k){return Es(i(Oc(_e(k,u,"scalar"))))}function T(k,S){const B=O(v(S),C(k));if(B===La)throw new Error("invalid private or public key received");return A(B)}function R(k){return T(k,b)}const L=R,N=T;function E(k,S,B){const U=p(k*(S-B));return S=p(S-U),B=p(B+U),{x_2:S,x_3:B}}function O(k,S){Mc("u",k,La,t),Mc("scalar",S,f,m);const B=S,U=k;let q=ro,M=La,K=k,Q=ro,re=La;for(let Se=BigInt(l-1);Se>=La;Se--){const ve=B>>Se&ro;re^=ve,{x_2:q,x_3:K}=E(re,q,K),{x_2:M,x_3:Q}=E(re,M,Q),re=ve;const fe=q+M,Fe=p(fe*fe),ot=q-M,De=p(ot*ot),ut=Fe-De,_t=K+Q,Yi=K-Q,dn=p(Yi*fe),Ra=p(_t*ot),Yl=dn+Ra,Js=dn-Ra;K=p(Yl*Yl),Q=p(U*p(Js*Js)),q=p(Fe*De),M=p(ut*(Fe+p(h*ut)))}({x_2:q,x_3:K}=E(re,q,K)),{x_2:M,x_3:Q}=E(re,M,Q);const X=s(M);return p(q*X)}const V={secretKey:u,publicKey:u,seed:u},$=(k=c(u))=>(_e(k,V.seed,"seed"),k),I={randomSecretKey:$};return Object.freeze({keygen:Xp($,L),getSharedSecret:N,getPublicKey:L,scalarMult:T,scalarMultBase:R,utils:I,GuBytes:b.slice(),lengths:V})}const Wk=BigInt(1),W4=BigInt(2),jk=BigInt(3),Gk=BigInt(5),Yk=BigInt(8),jh=BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffed"),Qk={p:jh,n:BigInt("0x1000000000000000000000000000000014def9dea2f79cd65812631a5cf5d3ed"),h:Yk,a:BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffec"),d:BigInt("0x52036cee2b6ffe738cc740797779e89800700a4d4141d8ab75eb4dca135978a3"),Gx:BigInt("0x216936d3cd6e53fec0a4e231fdd6dc5c692cc7609525a7b2c9562d608f25d51a"),Gy:BigInt("0x6666666666666666666666666666666666666666666666666666666666666658")};function Z8(r){const e=BigInt(10),t=BigInt(20),n=BigInt(40),i=BigInt(80),s=jh,a=r*r%s*r%s,c=ct(a,W4,s)*a%s,l=ct(c,Wk,s)*r%s,u=ct(l,Gk,s)*l%s,d=ct(u,e,s)*u%s,h=ct(d,t,s)*d%s,f=ct(h,n,s)*h%s,y=ct(f,i,s)*f%s,m=ct(y,i,s)*f%s,p=ct(m,e,s)*u%s;return{pow_p_5_8:ct(p,W4,s)*r%s,b2:a}}function J8(r){return r[0]&=248,r[31]&=127,r[31]|=64,r}const j4=BigInt("19681161376707505956807079304988542015446066515923890162744021073123829784752");function Xk(r,e){const t=jh,n=lt(e*e*e,t),i=lt(n*n*e,t),s=Z8(r*i).pow_p_5_8;let o=lt(r*n*s,t);const a=lt(e*o*o,t),c=o,l=lt(o*j4,t),u=a===r,d=a===lt(-r,t),h=a===lt(-r*j4,t);return u&&(o=c),(d||h)&&(o=l),Nk(o,t)&&(o=lt(-o,t)),{isValid:u||d,value:o}}const Zk=zk(Qk,{uvRatio:Xk});function Jk(r){return Hk(Zk,qh,Object.assign({adjustScalarBytes:J8},r))}const od=Jk({}),tu=(()=>{const r=jh;return Kk({P:r,type:"x25519",powPminus2:e=>{const{pow_p_5_8:t,b2:n}=Z8(e);return lt(ct(t,jk,r)*n,r)},adjustScalarBytes:J8})})(),ad=32,mn=64,E0=32;let So;const e7=(async()=>{try{return await ir.get().subtle.generateKey({name:"Ed25519"},!0,["sign","verify"]),!0}catch{return!1}})();function eC(){const r=od.utils.randomSecretKey(),e=od.getPublicKey(r);return{privateKey:aC(r,e),publicKey:e}}async function tC(r,e){let t;r.length===mn?t=r.subarray(0,32):t=r;const n={crv:"Ed25519",kty:"OKP",x:Y(r.subarray(32),"base64url"),d:Y(t,"base64url"),ext:!0,key_ops:["sign"]},i=await ir.get().subtle.importKey("jwk",n,{name:"Ed25519"},!0,["sign"]),s=await ir.get().subtle.sign({name:"Ed25519"},i,e instanceof Uint8Array?e:e.subarray());return new Uint8Array(s,0,s.byteLength)}function rC(r,e){const t=r.subarray(0,E0);return od.sign(e instanceof Uint8Array?e:e.subarray(),t)}async function nC(r,e){return So==null&&(So=await e7),So?tC(r,e):rC(r,e)}async function iC(r,e,t){if(r.buffer instanceof ArrayBuffer){const n=await ir.get().subtle.importKey("raw",r.buffer,{name:"Ed25519"},!1,["verify"]);return await ir.get().subtle.verify({name:"Ed25519"},n,e,t instanceof Uint8Array?t:t.subarray())}throw new TypeError("WebCrypto does not support SharedArrayBuffer for Ed25519 keys")}function sC(r,e,t){return od.verify(e,t instanceof Uint8Array?t:t.subarray(),r)}async function oC(r,e,t){return So==null&&(So=await e7),So?iC(r,e,t):sC(r,e,t)}function aC(r,e){const t=new Uint8Array(mn);for(let n=0;n<E0;n++)t[n]=r[n],t[E0+n]=e[n];return t}function Gh(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}class t7{type="Ed25519";raw;constructor(e){this.raw=$c(e,ad)}toMultihash(){return jn.digest(En(this))}toCID(){return ae.createV1(114,this.toMultihash())}toString(){return Ct.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:Te(this.raw,e.raw)}verify(e,t,n){n?.signal?.throwIfAborted();const i=oC(this.raw,t,e);return Gh(i)?i.then(s=>(n?.signal?.throwIfAborted(),s)):i}}class S0{type="Ed25519";raw;publicKey;constructor(e,t){this.raw=$c(e,mn),this.publicKey=new t7(t)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:Te(this.raw,e.raw)}sign(e,t){t?.signal?.throwIfAborted();const n=nC(this.raw,e);return Gh(n)?n.then(i=>(t?.signal?.throwIfAborted(),i)):(t?.signal?.throwIfAborted(),n)}}function r7(r){if(r.length>mn){r=$c(r,mn+ad);const n=r.subarray(0,mn),i=r.subarray(mn,r.length);return new S0(n,i)}r=$c(r,mn);const e=r.subarray(0,mn),t=r.subarray(ad);return new S0(e,t)}function n7(r){return r=$c(r,ad),new t7(r)}async function cC(){const{privateKey:r,publicKey:e}=eC();return new S0(r,e)}function $c(r,e){if(r=Uint8Array.from(r??[]),r.length!==e)throw new H(`Key must be a Uint8Array of length ${e}, got ${r.length}`);return r}const lC=Math.pow(2,7),uC=Math.pow(2,14),dC=Math.pow(2,21),Zp=Math.pow(2,28),Jp=Math.pow(2,35),eg=Math.pow(2,42),tg=Math.pow(2,49),ze=128,qt=127;function et(r){if(r<lC)return 1;if(r<uC)return 2;if(r<dC)return 3;if(r<Zp)return 4;if(r<Jp)return 5;if(r<eg)return 6;if(r<tg)return 7;if(Number.MAX_SAFE_INTEGER!=null&&r>Number.MAX_SAFE_INTEGER)throw new RangeError("Could not encode varint");return 8}function cd(r,e,t=0){switch(et(r)){case 8:e[t++]=r&255|ze,r/=128;case 7:e[t++]=r&255|ze,r/=128;case 6:e[t++]=r&255|ze,r/=128;case 5:e[t++]=r&255|ze,r/=128;case 4:e[t++]=r&255|ze,r>>>=7;case 3:e[t++]=r&255|ze,r>>>=7;case 2:e[t++]=r&255|ze,r>>>=7;case 1:{e[t++]=r&255,r>>>=7;break}default:throw new Error("unreachable")}return e}function hC(r,e,t=0){switch(et(r)){case 8:e.set(t++,r&255|ze),r/=128;case 7:e.set(t++,r&255|ze),r/=128;case 6:e.set(t++,r&255|ze),r/=128;case 5:e.set(t++,r&255|ze),r/=128;case 4:e.set(t++,r&255|ze),r>>>=7;case 3:e.set(t++,r&255|ze),r>>>=7;case 2:e.set(t++,r&255|ze),r>>>=7;case 1:{e.set(t++,r&255),r>>>=7;break}default:throw new Error("unreachable")}return e}function i7(r,e){let t=r[e],n=0;if(n+=t&qt,t<ze||(t=r[e+1],n+=(t&qt)<<7,t<ze)||(t=r[e+2],n+=(t&qt)<<14,t<ze)||(t=r[e+3],n+=(t&qt)<<21,t<ze)||(t=r[e+4],n+=(t&qt)*Zp,t<ze)||(t=r[e+5],n+=(t&qt)*Jp,t<ze)||(t=r[e+6],n+=(t&qt)*eg,t<ze)||(t=r[e+7],n+=(t&qt)*tg,t<ze))return n;throw new RangeError("Could not decode varint")}function fC(r,e){let t=r.get(e),n=0;if(n+=t&qt,t<ze||(t=r.get(e+1),n+=(t&qt)<<7,t<ze)||(t=r.get(e+2),n+=(t&qt)<<14,t<ze)||(t=r.get(e+3),n+=(t&qt)<<21,t<ze)||(t=r.get(e+4),n+=(t&qt)*Zp,t<ze)||(t=r.get(e+5),n+=(t&qt)*Jp,t<ze)||(t=r.get(e+6),n+=(t&qt)*eg,t<ze)||(t=r.get(e+7),n+=(t&qt)*tg,t<ze))return n;throw new RangeError("Could not decode varint")}function vn(r,e,t=0){return e==null&&(e=Ar(et(r))),e instanceof Uint8Array?cd(r,e,t):hC(r,e,t)}function Vs(r,e=0){return r instanceof Uint8Array?i7(r,e):fC(r,e)}const rg=new Float32Array([-0]),Ei=new Uint8Array(rg.buffer);function pC(r,e,t){rg[0]=r,e[t]=Ei[0],e[t+1]=Ei[1],e[t+2]=Ei[2],e[t+3]=Ei[3]}function gC(r,e){return Ei[0]=r[e],Ei[1]=r[e+1],Ei[2]=r[e+2],Ei[3]=r[e+3],rg[0]}const ng=new Float64Array([-0]),Kt=new Uint8Array(ng.buffer);function mC(r,e,t){ng[0]=r,e[t]=Kt[0],e[t+1]=Kt[1],e[t+2]=Kt[2],e[t+3]=Kt[3],e[t+4]=Kt[4],e[t+5]=Kt[5],e[t+6]=Kt[6],e[t+7]=Kt[7]}function yC(r,e){return Kt[0]=r[e],Kt[1]=r[e+1],Kt[2]=r[e+2],Kt[3]=r[e+3],Kt[4]=r[e+4],Kt[5]=r[e+5],Kt[6]=r[e+6],Kt[7]=r[e+7],ng[0]}const wC=BigInt(Number.MAX_SAFE_INTEGER),bC=BigInt(Number.MIN_SAFE_INTEGER);class Wt{lo;hi;constructor(e,t){this.lo=e|0,this.hi=t|0}toNumber(e=!1){if(!e&&this.hi>>>31>0){const t=~this.lo+1>>>0;let n=~this.hi>>>0;return t===0&&(n=n+1>>>0),-(t+n*4294967296)}return this.lo+this.hi*4294967296}toBigInt(e=!1){if(e)return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n);if(this.hi>>>31){const t=~this.lo+1>>>0;let n=~this.hi>>>0;return t===0&&(n=n+1>>>0),-(BigInt(t)+(BigInt(n)<<32n))}return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n)}toString(e=!1){return this.toBigInt(e).toString()}zzEncode(){const e=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^e)>>>0,this.lo=(this.lo<<1^e)>>>0,this}zzDecode(){const e=-(this.lo&1);return this.lo=((this.lo>>>1|this.hi<<31)^e)>>>0,this.hi=(this.hi>>>1^e)>>>0,this}length(){const e=this.lo,t=(this.lo>>>28|this.hi<<4)>>>0,n=this.hi>>>24;return n===0?t===0?e<16384?e<128?1:2:e<2097152?3:4:t<16384?t<128?5:6:t<2097152?7:8:n<128?9:10}static fromBigInt(e){if(e===0n)return hs;if(e<wC&&e>bC)return this.fromNumber(Number(e));const t=e<0n;t&&(e=-e);let n=e>>32n,i=e-(n<<32n);return t&&(n=~n|0n,i=~i|0n,++i>G4&&(i=0n,++n>G4&&(n=0n))),new Wt(Number(i),Number(n))}static fromNumber(e){if(e===0)return hs;const t=e<0;t&&(e=-e);let n=e>>>0,i=(e-n)/4294967296>>>0;return t&&(i=~i>>>0,n=~n>>>0,++n>4294967295&&(n=0,++i>4294967295&&(i=0))),new Wt(n,i)}static from(e){return typeof e=="number"?Wt.fromNumber(e):typeof e=="bigint"?Wt.fromBigInt(e):typeof e=="string"?Wt.fromBigInt(BigInt(e)):e.low!=null||e.high!=null?new Wt(e.low>>>0,e.high>>>0):hs}}const hs=new Wt(0,0);hs.toBigInt=function(){return 0n};hs.zzEncode=hs.zzDecode=function(){return this};hs.length=function(){return 1};const G4=4294967296n;function vC(r){let e=0,t=0;for(let n=0;n<r.length;++n)t=r.charCodeAt(n),t<128?e+=1:t<2048?e+=2:(t&64512)===55296&&(r.charCodeAt(n+1)&64512)===56320?(++n,e+=4):e+=3;return e}function EC(r,e,t){if(t-e<1)return"";let i;const s=[];let o=0,a;for(;e<t;)a=r[e++],a<128?s[o++]=a:a>191&&a<224?s[o++]=(a&31)<<6|r[e++]&63:a>239&&a<365?(a=((a&7)<<18|(r[e++]&63)<<12|(r[e++]&63)<<6|r[e++]&63)-65536,s[o++]=55296+(a>>10),s[o++]=56320+(a&1023)):s[o++]=(a&15)<<12|(r[e++]&63)<<6|r[e++]&63,o>8191&&((i??(i=[])).push(String.fromCharCode.apply(String,s)),o=0);return i!=null?(o>0&&i.push(String.fromCharCode.apply(String,s.slice(0,o))),i.join("")):String.fromCharCode.apply(String,s.slice(0,o))}function s7(r,e,t){const n=t;let i,s;for(let o=0;o<r.length;++o)i=r.charCodeAt(o),i<128?e[t++]=i:i<2048?(e[t++]=i>>6|192,e[t++]=i&63|128):(i&64512)===55296&&((s=r.charCodeAt(o+1))&64512)===56320?(i=65536+((i&1023)<<10)+(s&1023),++o,e[t++]=i>>18|240,e[t++]=i>>12&63|128,e[t++]=i>>6&63|128,e[t++]=i&63|128):(e[t++]=i>>12|224,e[t++]=i>>6&63|128,e[t++]=i&63|128);return t-n}function Vr(r,e){return RangeError(`index out of range: ${r.pos} + ${e??1} > ${r.len}`)}function ru(r,e){return(r[e-4]|r[e-3]<<8|r[e-2]<<16|r[e-1]<<24)>>>0}class SC{buf;pos;len;_slice=Uint8Array.prototype.subarray;constructor(e){this.buf=e,this.pos=0,this.len=e.length}uint32(){let e=4294967295;if(e=(this.buf[this.pos]&127)>>>0,this.buf[this.pos++]<128||(e=(e|(this.buf[this.pos]&127)<<7)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<14)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<21)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&15)<<28)>>>0,this.buf[this.pos++]<128))return e;if((this.pos+=5)>this.len)throw this.pos=this.len,Vr(this,10);return e}int32(){return this.uint32()|0}sint32(){const e=this.uint32();return e>>>1^-(e&1)|0}bool(){return this.uint32()!==0}fixed32(){if(this.pos+4>this.len)throw Vr(this,4);return ru(this.buf,this.pos+=4)}sfixed32(){if(this.pos+4>this.len)throw Vr(this,4);return ru(this.buf,this.pos+=4)|0}float(){if(this.pos+4>this.len)throw Vr(this,4);const e=gC(this.buf,this.pos);return this.pos+=4,e}double(){if(this.pos+8>this.len)throw Vr(this,4);const e=yC(this.buf,this.pos);return this.pos+=8,e}bytes(){const e=this.uint32(),t=this.pos,n=this.pos+e;if(n>this.len)throw Vr(this,e);return this.pos+=e,t===n?new Uint8Array(0):this.buf.subarray(t,n)}string(){const e=this.bytes();return EC(e,0,e.length)}skip(e){if(typeof e=="number"){if(this.pos+e>this.len)throw Vr(this,e);this.pos+=e}else do if(this.pos>=this.len)throw Vr(this);while((this.buf[this.pos++]&128)!==0);return this}skipType(e){switch(e){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;(e=this.uint32()&7)!==4;)this.skipType(e);break;case 5:this.skip(4);break;default:throw Error(`invalid wire type ${e} at offset ${this.pos}`)}return this}readLongVarint(){const e=new Wt(0,0);let t=0;if(this.len-this.pos>4){for(;t<4;++t)if(e.lo=(e.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return e;if(e.lo=(e.lo|(this.buf[this.pos]&127)<<28)>>>0,e.hi=(e.hi|(this.buf[this.pos]&127)>>4)>>>0,this.buf[this.pos++]<128)return e;t=0}else{for(;t<3;++t){if(this.pos>=this.len)throw Vr(this);if(e.lo=(e.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return e}return e.lo=(e.lo|(this.buf[this.pos++]&127)<<t*7)>>>0,e}if(this.len-this.pos>4){for(;t<5;++t)if(e.hi=(e.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return e}else for(;t<5;++t){if(this.pos>=this.len)throw Vr(this);if(e.hi=(e.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return e}throw Error("invalid varint encoding")}readFixed64(){if(this.pos+8>this.len)throw Vr(this,8);const e=ru(this.buf,this.pos+=4),t=ru(this.buf,this.pos+=4);return new Wt(e,t)}int64(){return this.readLongVarint().toBigInt()}int64Number(){return this.readLongVarint().toNumber()}int64String(){return this.readLongVarint().toString()}uint64(){return this.readLongVarint().toBigInt(!0)}uint64Number(){const e=i7(this.buf,this.pos);return this.pos+=et(e),e}uint64String(){return this.readLongVarint().toString(!0)}sint64(){return this.readLongVarint().zzDecode().toBigInt()}sint64Number(){return this.readLongVarint().zzDecode().toNumber()}sint64String(){return this.readLongVarint().zzDecode().toString()}fixed64(){return this.readFixed64().toBigInt()}fixed64Number(){return this.readFixed64().toNumber()}fixed64String(){return this.readFixed64().toString()}sfixed64(){return this.readFixed64().toBigInt()}sfixed64Number(){return this.readFixed64().toNumber()}sfixed64String(){return this.readFixed64().toString()}}function xC(r){return new SC(r instanceof Uint8Array?r:r.subarray())}function Ae(r,e,t){const n=xC(r);return e.decode(n,void 0,t)}function AC(r){let n,i=8192;return function(o){if(o<1||o>4096)return Ar(o);i+o>8192&&(n=Ar(8192),i=0);const a=n.subarray(i,i+=o);return(i&7)!==0&&(i=(i|7)+1),a}}class Wa{fn;len;next;val;constructor(e,t,n){this.fn=e,this.len=t,this.next=void 0,this.val=n}}function b1(){}class kC{head;tail;len;next;constructor(e){this.head=e.head,this.tail=e.tail,this.len=e.len,this.next=e.states}}const CC=AC();function IC(r){return globalThis.Buffer!=null?Ar(r):CC(r)}class x0{len;head;tail;states;constructor(){this.len=0,this.head=new Wa(b1,0,0),this.tail=this.head,this.states=null}_push(e,t,n){return this.tail=this.tail.next=new Wa(e,t,n),this.len+=t,this}uint32(e){return this.len+=(this.tail=this.tail.next=new TC((e=e>>>0)<128?1:e<16384?2:e<2097152?3:e<268435456?4:5,e)).len,this}int32(e){return e<0?this._push(nu,10,Wt.fromNumber(e)):this.uint32(e)}sint32(e){return this.uint32((e<<1^e>>31)>>>0)}uint64(e){const t=Wt.fromBigInt(e);return this._push(nu,t.length(),t)}uint64Number(e){return this._push(cd,et(e),e)}uint64String(e){return this.uint64(BigInt(e))}int64(e){return this.uint64(e)}int64Number(e){return this.uint64Number(e)}int64String(e){return this.uint64String(e)}sint64(e){const t=Wt.fromBigInt(e).zzEncode();return this._push(nu,t.length(),t)}sint64Number(e){const t=Wt.fromNumber(e).zzEncode();return this._push(nu,t.length(),t)}sint64String(e){return this.sint64(BigInt(e))}bool(e){return this._push(v1,1,e?1:0)}fixed32(e){return this._push(Oa,4,e>>>0)}sfixed32(e){return this.fixed32(e)}fixed64(e){const t=Wt.fromBigInt(e);return this._push(Oa,4,t.lo)._push(Oa,4,t.hi)}fixed64Number(e){const t=Wt.fromNumber(e);return this._push(Oa,4,t.lo)._push(Oa,4,t.hi)}fixed64String(e){return this.fixed64(BigInt(e))}sfixed64(e){return this.fixed64(e)}sfixed64Number(e){return this.fixed64Number(e)}sfixed64String(e){return this.fixed64String(e)}float(e){return this._push(pC,4,e)}double(e){return this._push(mC,8,e)}bytes(e){const t=e.length>>>0;return t===0?this._push(v1,1,0):this.uint32(t)._push(PC,t,e)}string(e){const t=vC(e);return t!==0?this.uint32(t)._push(s7,t,e):this._push(v1,1,0)}fork(){return this.states=new kC(this),this.head=this.tail=new Wa(b1,0,0),this.len=0,this}reset(){return this.states!=null?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new Wa(b1,0,0),this.len=0),this}ldelim(){const e=this.head,t=this.tail,n=this.len;return this.reset().uint32(n),n!==0&&(this.tail.next=e.next,this.tail=t,this.len+=n),this}finish(){let e=this.head.next;const t=IC(this.len);let n=0;for(;e!=null;)e.fn(e.val,t,n),n+=e.len,e=e.next;return t}}function v1(r,e,t){e[t]=r&255}function _C(r,e,t){for(;r>127;)e[t++]=r&127|128,r>>>=7;e[t]=r}class TC extends Wa{next;constructor(e,t){super(_C,e,t),this.next=void 0}}function nu(r,e,t){for(;r.hi!==0;)e[t++]=r.lo&127|128,r.lo=(r.lo>>>7|r.hi<<25)>>>0,r.hi>>>=7;for(;r.lo>127;)e[t++]=r.lo&127|128,r.lo=r.lo>>>7;e[t++]=r.lo}function Oa(r,e,t){e[t]=r&255,e[t+1]=r>>>8&255,e[t+2]=r>>>16&255,e[t+3]=r>>>24}function PC(r,e,t){e.set(r,t)}globalThis.Buffer!=null&&(x0.prototype.bytes=function(r){const e=r.length>>>0;return this.uint32(e),e>0&&this._push(RC,e,r),this},x0.prototype.string=function(r){const e=globalThis.Buffer.byteLength(r);return this.uint32(e),e>0&&this._push(NC,e,r),this});function RC(r,e,t){e.set(r,t)}function NC(r,e,t){r.length<40?s7(r,e,t):e.utf8Write!=null?e.utf8Write(r,t):e.set(W(r),t)}function DC(){return new x0}function ke(r,e){const t=DC();return e.encode(r,t,{lengthDelimited:!1}),t.finish()}var ld;(function(r){r[r.VARINT=0]="VARINT",r[r.BIT64=1]="BIT64",r[r.LENGTH_DELIMITED=2]="LENGTH_DELIMITED",r[r.START_GROUP=3]="START_GROUP",r[r.END_GROUP=4]="END_GROUP",r[r.BIT32=5]="BIT32"})(ld||(ld={}));function o7(r,e,t,n){return{name:r,type:e,encode:t,decode:n}}function sr(r){function e(i){if(r[i.toString()]==null)throw new Error("Invalid enum value");return r[i]}const t=function(s,o){const a=e(s);o.int32(a)},n=function(s){const o=s.int32();return e(o)};return o7("enum",ld.VARINT,t,n)}function Ce(r,e){return o7("message",ld.LENGTH_DELIMITED,r,e)}class Mt extends Error{code="ERR_MAX_LENGTH";name="MaxLengthError"}class Y4 extends Error{code="ERR_MAX_SIZE";name="MaxSizeError"}var st;(function(r){r.RSA="RSA",r.Ed25519="Ed25519",r.secp256k1="secp256k1",r.ECDSA="ECDSA"})(st||(st={}));var A0;(function(r){r[r.RSA=0]="RSA",r[r.Ed25519=1]="Ed25519",r[r.secp256k1=2]="secp256k1",r[r.ECDSA=3]="ECDSA"})(A0||(A0={}));(function(r){r.codec=()=>sr(A0)})(st||(st={}));var Oi;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),st.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{const s={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.Type=st.codec().decode(t);break}case 2:{s.Data=t.bytes();break}default:{t.skipType(a&7);break}}}return s})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ae(t,r.codec(),n)})(Oi||(Oi={}));var ud;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),st.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{const s={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.Type=st.codec().decode(t);break}case 2:{s.Data=t.bytes();break}default:{t.skipType(a&7);break}}}return s})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ae(t,r.codec(),n)})(ud||(ud={}));function Ss(r){if(isNaN(r)||r<=0)throw new H("random bytes length must be a Number bigger than 0");return bl(r)}let ig=class{type="RSA";jwk;_raw;_multihash;constructor(e,t){this.jwk=e,this._multihash=t}get raw(){return this._raw==null&&(this._raw=og(this.jwk)),this._raw}toMultihash(){return this._multihash}toCID(){return ae.createV1(114,this._multihash)}toString(){return Ct.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:Te(this.raw,e.raw)}verify(e,t,n){return jC(this.jwk,t,e,n)}},a7=class{type="RSA";jwk;_raw;publicKey;constructor(e,t){this.jwk=e,this.publicKey=t}get raw(){return this._raw==null&&(this._raw=MC(this.jwk)),this._raw}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:Te(this.raw,e.raw)}sign(e,t){return WC(this.jwk,e,t)}};const c7=8192,sg=18,BC=1062,LC=Uint8Array.from([48,13,6,9,42,134,72,134,247,13,1,1,1,5,0]);function OC(r){return{n:Y(r[1],"base64url"),e:Y(r[2],"base64url"),d:Y(r[3],"base64url"),p:Y(r[4],"base64url"),q:Y(r[5],"base64url"),dp:Y(r[6],"base64url"),dq:Y(r[7],"base64url"),qi:Y(r[8],"base64url"),kty:"RSA"}}function MC(r){if(r.n==null||r.e==null||r.d==null||r.p==null||r.q==null||r.dp==null||r.dq==null||r.qi==null)throw new H("JWK was missing components");return qn([yr(Uint8Array.from([0])),yr(W(r.n,"base64url")),yr(W(r.e,"base64url")),yr(W(r.d,"base64url")),yr(W(r.p,"base64url")),yr(W(r.q,"base64url")),yr(W(r.dp,"base64url")),yr(W(r.dq,"base64url")),yr(W(r.qi,"base64url"))]).subarray()}function $C(r){const e=Fs(r[1],{offset:0});return{kty:"RSA",n:Y(e[0],"base64url"),e:Y(e[1],"base64url")}}function og(r){if(r.n==null||r.e==null)throw new H("JWK was missing components");return qn([LC,Hp(qn([yr(W(r.n,"base64url")),yr(W(r.e,"base64url"))]))]).subarray()}function UC(r){const e=Fs(r);return l7(e)}function l7(r){const e=OC(r);return zC(e)}function FC(r,e){if(r.byteLength>=BC)throw new Yu("Key size is too large");const t=Fs(r,{offset:0});return VC(t,r,e)}function VC(r,e,t){const n=$C(r);if(t==null){const i=Ti(Oi.encode({Type:st.RSA,Data:e}));t=qi(sg,i)}return new ig(n,t)}function zC(r){if(YC(r)>c7)throw new H("Key size is too large");const e=qC(r),t=Ti(Oi.encode({Type:st.RSA,Data:og(e.publicKey)})),n=qi(sg,t);return new a7(e.privateKey,new ig(e.publicKey,n))}async function HC(r){if(r>c7)throw new H("Key size is too large");const e=await KC(r),t=Ti(Oi.encode({Type:st.RSA,Data:og(e.publicKey)})),n=qi(sg,t);return new a7(e.privateKey,new ig(e.publicKey,n))}function qC(r){if(r==null)throw new H("Missing key parameter");return{privateKey:r,publicKey:{kty:r.kty,n:r.n,e:r.e}}}async function KC(r,e){const t=await ir.get().subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:r,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign","verify"]),n=await GC(t);return{privateKey:n[0],publicKey:n[1]}}async function WC(r,e,t){const n=await ir.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["sign"]);t?.signal?.throwIfAborted();const i=await ir.get().subtle.sign({name:"RSASSA-PKCS1-v1_5"},n,e instanceof Uint8Array?e:e.subarray());return t?.signal?.throwIfAborted(),new Uint8Array(i,0,i.byteLength)}async function jC(r,e,t,n){const i=await ir.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]);n?.signal?.throwIfAborted();const s=await ir.get().subtle.verify({name:"RSASSA-PKCS1-v1_5"},i,e,t instanceof Uint8Array?t:t.subarray());return n?.signal?.throwIfAborted(),s}async function GC(r,e){if(r.privateKey==null||r.publicKey==null)throw new H("Private and public key are required");return await Promise.all([ir.get().subtle.exportKey("jwk",r.privateKey),ir.get().subtle.exportKey("jwk",r.publicKey)])}function YC(r){if(r.kty!=="RSA")throw new H("invalid key type");if(r.n==null)throw new H("invalid key modulus");return W(r.n,"base64url").length*8}class u7{oHash;iHash;blockLen;outputLen;finished=!1;destroyed=!1;constructor(e,t){if(yl(e),_e(t,void 0,"key"),this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const n=this.blockLen,i=new Uint8Array(n);i.set(t.length>n?e.create().update(t).digest():t);for(let s=0;s<i.length;s++)i[s]^=54;this.iHash.update(i),this.oHash=e.create();for(let s=0;s<i.length;s++)i[s]^=106;this.oHash.update(i),In(i)}update(e){return nd(this),this.iHash.update(e),this}digestInto(e){nd(this),_e(e,this.outputLen,"output"),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){const e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||=Object.create(Object.getPrototypeOf(this),{});const{oHash:t,iHash:n,finished:i,destroyed:s,blockLen:o,outputLen:a}=this;return e=e,e.finished=i,e.destroyed=s,e.blockLen=o,e.outputLen=a,e.oHash=t._cloneInto(e.oHash),e.iHash=n._cloneInto(e.iHash),e}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}}const vl=(r,e,t)=>new u7(r,e).update(t).digest();vl.create=(r,e)=>new u7(r,e);const Q4=(r,e)=>(r+(r>=0?e:-e)/d7)/e;function QC(r,e,t){const[[n,i],[s,o]]=e,a=Q4(o*r,t),c=Q4(-i*r,t);let l=r-a*n-c*s,u=-a*i-c*o;const d=l<zn,h=u<zn;d&&(l=-l),h&&(u=-u);const f=Yp(Math.ceil(kk(t)/2))+xo;if(l<zn||l>=f||u<zn||u>=f)throw new Error("splitScalar (endomorphism): failed, k="+r);return{k1neg:d,k1:l,k2neg:h,k2:u}}function k0(r){if(!["compact","recovered","der"].includes(r))throw new Error('Signature format must be "compact", "recovered", or "der"');return r}function E1(r,e){const t={};for(let n of Object.keys(e))t[n]=r[n]===void 0?e[n]:r[n];return vs(t.lowS,"lowS"),vs(t.prehash,"prehash"),t.format!==void 0&&k0(t.format),t}class XC extends Error{constructor(e=""){super(e)}}const wi={Err:XC,_tlv:{encode:(r,e)=>{const{Err:t}=wi;if(r<0||r>256)throw new t("tlv.encode: wrong tag");if(e.length&1)throw new t("tlv.encode: unpadded data");const n=e.length/2,i=Jl(n);if(i.length/2&128)throw new t("tlv.encode: long form length too big");const s=n>127?Jl(i.length/2|128):"";return Jl(r)+s+i+e},decode(r,e){const{Err:t}=wi;let n=0;if(r<0||r>256)throw new t("tlv.encode: wrong tag");if(e.length<2||e[n++]!==r)throw new t("tlv.decode: wrong tlv");const i=e[n++],s=!!(i&128);let o=0;if(!s)o=i;else{const c=i&127;if(!c)throw new t("tlv.decode(long): indefinite length not supported");if(c>4)throw new t("tlv.decode(long): byte length is too big");const l=e.subarray(n,n+c);if(l.length!==c)throw new t("tlv.decode: length bytes not complete");if(l[0]===0)throw new t("tlv.decode(long): zero leftmost byte");for(const u of l)o=o<<8|u;if(n+=c,o<128)throw new t("tlv.decode(long): not minimal encoding")}const a=e.subarray(n,n+o);if(a.length!==o)throw new t("tlv.decode: wrong value length");return{v:a,l:e.subarray(n+o)}}},_int:{encode(r){const{Err:e}=wi;if(r<zn)throw new e("integer: negative integers are not allowed");let t=Jl(r);if(Number.parseInt(t[0],16)&8&&(t="00"+t),t.length&1)throw new e("unexpected DER parsing assertion: unpadded hex");return t},decode(r){const{Err:e}=wi;if(r[0]&128)throw new e("invalid signature integer: negative");if(r[0]===0&&!(r[1]&128))throw new e("invalid signature integer: unnecessary leading zero");return Kh(r)}},toSig(r){const{Err:e,_int:t,_tlv:n}=wi,i=_e(r,void 0,"signature"),{v:s,l:o}=n.decode(48,i);if(o.length)throw new e("invalid signature: left bytes after parsing");const{v:a,l:c}=n.decode(2,s),{v:l,l:u}=n.decode(2,c);if(u.length)throw new e("invalid signature: left bytes after parsing");return{r:t.decode(a),s:t.decode(l)}},hexFromSig(r){const{_tlv:e,_int:t}=wi,n=e.encode(2,t.encode(r.r)),i=e.encode(2,t.encode(r.s)),s=n+i;return e.encode(48,s)}},zn=BigInt(0),xo=BigInt(1),d7=BigInt(2),iu=BigInt(3),ZC=BigInt(4);function JC(r,e={}){const t=X8("weierstrass",r,e),{Fp:n,Fn:i}=t;let s=t.CURVE;const{h:o,n:a}=s;ua(e,{},{allowInfinityPoint:"boolean",clearCofactor:"function",isTorsionFree:"function",fromBytes:"function",toBytes:"function",endo:"object"});const{endo:c}=e;if(c&&(!n.is0(s.a)||typeof c.beta!="bigint"||!Array.isArray(c.basises)))throw new Error('invalid endo: expected "beta": bigint and "basises": array');const l=f7(n,i);function u(){if(!n.isOdd)throw new Error("compression is not supported: Field does not have .isOdd()")}function d($,I,k){const{x:S,y:B}=I.toAffine(),U=n.toBytes(S);if(vs(k,"isCompressed"),k){u();const q=!n.isOdd(B);return wn(h7(q),U)}else return wn(Uint8Array.of(4),U,n.toBytes(B))}function h($){_e($,void 0,"Point");const{publicKey:I,publicKeyUncompressed:k}=l,S=$.length,B=$[0],U=$.subarray(1);if(S===I&&(B===2||B===3)){const q=n.fromBytes(U);if(!n.isValid(q))throw new Error("bad point: is not on curve, wrong x");const M=m(q);let K;try{K=n.sqrt(M)}catch(X){const Se=X instanceof Error?": "+X.message:"";throw new Error("bad point: is not on curve, sqrt error"+Se)}u();const Q=n.isOdd(K);return(B&1)===1!==Q&&(K=n.neg(K)),{x:q,y:K}}else if(S===k&&B===4){const q=n.BYTES,M=n.fromBytes(U.subarray(0,q)),K=n.fromBytes(U.subarray(q,q*2));if(!p(M,K))throw new Error("bad point: is not on curve");return{x:M,y:K}}else throw new Error(`bad point: got length ${S}, expected compressed=${I} or uncompressed=${k}`)}const f=e.toBytes||d,y=e.fromBytes||h;function m($){const I=n.sqr($),k=n.mul(I,$);return n.add(n.add(k,n.mul($,s.a)),s.b)}function p($,I){const k=n.sqr(I),S=m($);return n.eql(k,S)}if(!p(s.Gx,s.Gy))throw new Error("bad curve params: generator point");const b=n.mul(n.pow(s.a,iu),ZC),A=n.mul(n.sqr(s.b),BigInt(27));if(n.is0(n.add(b,A)))throw new Error("bad curve params: a or b");function v($,I,k=!1){if(!n.isValid(I)||k&&n.is0(I))throw new Error(`bad point coordinate ${$}`);return I}function C($){if(!($ instanceof E))throw new Error("Weierstrass Point expected")}function T($){if(!c||!c.basises)throw new Error("no endo");return QC($,c.basises,i.ORDER)}const R=id(($,I)=>{const{X:k,Y:S,Z:B}=$;if(n.eql(B,n.ONE))return{x:k,y:S};const U=$.is0();I==null&&(I=U?n.ONE:n.inv(B));const q=n.mul(k,I),M=n.mul(S,I),K=n.mul(B,I);if(U)return{x:n.ZERO,y:n.ZERO};if(!n.eql(K,n.ONE))throw new Error("invZ was invalid");return{x:q,y:M}}),L=id($=>{if($.is0()){if(e.allowInfinityPoint&&!n.is0($.Y))return;throw new Error("bad point: ZERO")}const{x:I,y:k}=$.toAffine();if(!n.isValid(I)||!n.isValid(k))throw new Error("bad point: x or y not field elements");if(!p(I,k))throw new Error("bad point: equation left != right");if(!$.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0});function N($,I,k,S,B){return k=new E(n.mul(k.X,$),k.Y,k.Z),I=sd(S,I),k=sd(B,k),I.add(k)}class E{static BASE=new E(s.Gx,s.Gy,n.ONE);static ZERO=new E(n.ZERO,n.ONE,n.ZERO);static Fp=n;static Fn=i;X;Y;Z;constructor(I,k,S){this.X=v("x",I),this.Y=v("y",k,!0),this.Z=v("z",S),Object.freeze(this)}static CURVE(){return s}static fromAffine(I){const{x:k,y:S}=I||{};if(!I||!n.isValid(k)||!n.isValid(S))throw new Error("invalid affine point");if(I instanceof E)throw new Error("projective point not allowed");return n.is0(k)&&n.is0(S)?E.ZERO:new E(k,S,n.ONE)}static fromBytes(I){const k=E.fromAffine(y(_e(I,void 0,"point")));return k.assertValidity(),k}static fromHex(I){return E.fromBytes(Lc(I))}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(I=8,k=!0){return V.createCache(this,I),k||this.multiply(iu),this}assertValidity(){L(this)}hasEvenY(){const{y:I}=this.toAffine();if(!n.isOdd)throw new Error("Field doesn't support isOdd");return!n.isOdd(I)}equals(I){C(I);const{X:k,Y:S,Z:B}=this,{X:U,Y:q,Z:M}=I,K=n.eql(n.mul(k,M),n.mul(U,B)),Q=n.eql(n.mul(S,M),n.mul(q,B));return K&&Q}negate(){return new E(this.X,n.neg(this.Y),this.Z)}double(){const{a:I,b:k}=s,S=n.mul(k,iu),{X:B,Y:U,Z:q}=this;let M=n.ZERO,K=n.ZERO,Q=n.ZERO,re=n.mul(B,B),X=n.mul(U,U),Se=n.mul(q,q),ve=n.mul(B,U);return ve=n.add(ve,ve),Q=n.mul(B,q),Q=n.add(Q,Q),M=n.mul(I,Q),K=n.mul(S,Se),K=n.add(M,K),M=n.sub(X,K),K=n.add(X,K),K=n.mul(M,K),M=n.mul(ve,M),Q=n.mul(S,Q),Se=n.mul(I,Se),ve=n.sub(re,Se),ve=n.mul(I,ve),ve=n.add(ve,Q),Q=n.add(re,re),re=n.add(Q,re),re=n.add(re,Se),re=n.mul(re,ve),K=n.add(K,re),Se=n.mul(U,q),Se=n.add(Se,Se),re=n.mul(Se,ve),M=n.sub(M,re),Q=n.mul(Se,X),Q=n.add(Q,Q),Q=n.add(Q,Q),new E(M,K,Q)}add(I){C(I);const{X:k,Y:S,Z:B}=this,{X:U,Y:q,Z:M}=I;let K=n.ZERO,Q=n.ZERO,re=n.ZERO;const X=s.a,Se=n.mul(s.b,iu);let ve=n.mul(k,U),fe=n.mul(S,q),Fe=n.mul(B,M),ot=n.add(k,S),De=n.add(U,q);ot=n.mul(ot,De),De=n.add(ve,fe),ot=n.sub(ot,De),De=n.add(k,B);let ut=n.add(U,M);return De=n.mul(De,ut),ut=n.add(ve,Fe),De=n.sub(De,ut),ut=n.add(S,B),K=n.add(q,M),ut=n.mul(ut,K),K=n.add(fe,Fe),ut=n.sub(ut,K),re=n.mul(X,De),K=n.mul(Se,Fe),re=n.add(K,re),K=n.sub(fe,re),re=n.add(fe,re),Q=n.mul(K,re),fe=n.add(ve,ve),fe=n.add(fe,ve),Fe=n.mul(X,Fe),De=n.mul(Se,De),fe=n.add(fe,Fe),Fe=n.sub(ve,Fe),Fe=n.mul(X,Fe),De=n.add(De,Fe),ve=n.mul(fe,De),Q=n.add(Q,ve),ve=n.mul(ut,De),K=n.mul(ot,K),K=n.sub(K,ve),ve=n.mul(ot,fe),re=n.mul(ut,re),re=n.add(re,ve),new E(K,Q,re)}subtract(I){return this.add(I.negate())}is0(){return this.equals(E.ZERO)}multiply(I){const{endo:k}=e;if(!i.isValidNot0(I))throw new Error("invalid scalar: out of range");let S,B;const U=q=>V.cached(this,q,M=>gc(E,M));if(k){const{k1neg:q,k1:M,k2neg:K,k2:Q}=T(I),{p:re,f:X}=U(M),{p:Se,f:ve}=U(Q);B=X.add(ve),S=N(k.beta,re,Se,q,K)}else{const{p:q,f:M}=U(I);S=q,B=M}return gc(E,[S,B])[0]}multiplyUnsafe(I){const{endo:k}=e,S=this;if(!i.isValid(I))throw new Error("invalid scalar: out of range");if(I===zn||S.is0())return E.ZERO;if(I===xo)return S;if(V.hasCache(this))return this.multiply(I);if(k){const{k1neg:B,k1:U,k2neg:q,k2:M}=T(I),{p1:K,p2:Q}=Uk(E,S,U,M);return N(k.beta,K,Q,B,q)}else return V.unsafe(S,I)}toAffine(I){return R(this,I)}isTorsionFree(){const{isTorsionFree:I}=e;return o===xo?!0:I?I(E,this):V.unsafe(this,a).is0()}clearCofactor(){const{clearCofactor:I}=e;return o===xo?this:I?I(E,this):this.multiplyUnsafe(o)}isSmallOrder(){return this.multiplyUnsafe(o).is0()}toBytes(I=!0){return vs(I,"isCompressed"),this.assertValidity(),f(E,this,I)}toHex(I=!0){return wl(this.toBytes(I))}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}}const O=i.BITS,V=new Q8(E,e.endo?Math.ceil(O/2):O);return E.BASE.precompute(8),E}function h7(r){return Uint8Array.of(r?2:3)}function f7(r,e){return{secretKey:e.BYTES,publicKey:1+r.BYTES,publicKeyUncompressed:1+2*r.BYTES,publicKeyHasPrefix:!0,signature:2*e.BYTES}}function eI(r,e={}){const{Fn:t}=r,n=e.randomBytes||bl,i=Object.assign(f7(r.Fp,t),{seed:j8(t.ORDER)});function s(f){try{const y=t.fromBytes(f);return t.isValidNot0(y)}catch{return!1}}function o(f,y){const{publicKey:m,publicKeyUncompressed:p}=i;try{const b=f.length;return y===!0&&b!==m||y===!1&&b!==p?!1:!!r.fromBytes(f)}catch{return!1}}function a(f=n(i.seed)){return $k(_e(f,i.seed,"seed"),t.ORDER)}function c(f,y=!0){return r.BASE.multiply(t.fromBytes(f)).toBytes(y)}function l(f){const{secretKey:y,publicKey:m,publicKeyUncompressed:p}=i;if(!Hh(f)||"_lengths"in t&&t._lengths||y===m)return;const b=_e(f,void 0,"key").length;return b===m||b===p}function u(f,y,m=!0){if(l(f)===!0)throw new Error("first arg must be private key");if(l(y)===!1)throw new Error("second arg must be public key");const p=t.fromBytes(f);return r.fromBytes(y).multiply(p).toBytes(m)}const d={isValidSecretKey:s,isValidPublicKey:o,randomSecretKey:a},h=Xp(a,c);return Object.freeze({getPublicKey:c,getSharedSecret:u,keygen:h,Point:r,utils:d,lengths:i})}function tI(r,e,t={}){yl(e),ua(t,{},{hmac:"function",lowS:"boolean",randomBytes:"function",bits2int:"function",bits2int_modN:"function"}),t=Object.assign({},t);const n=t.randomBytes||bl,i=t.hmac||((k,S)=>vl(e,k,S)),{Fp:s,Fn:o}=r,{ORDER:a,BITS:c}=o,{keygen:l,getPublicKey:u,getSharedSecret:d,utils:h,lengths:f}=eI(r,t),y={prehash:!0,lowS:typeof t.lowS=="boolean"?t.lowS:!0,format:"compact",extraEntropy:!1},m=a*d7<s.ORDER;function p(k){const S=a>>xo;return k>S}function b(k,S){if(!o.isValidNot0(S))throw new Error(`invalid signature ${k}: out of range 1..Point.Fn.ORDER`);return S}function A(){if(m)throw new Error('"recovered" sig type is not supported for cofactor >2 curves')}function v(k,S){k0(S);const B=f.signature,U=S==="compact"?B:S==="recovered"?B+1:void 0;return _e(k,U)}class C{r;s;recovery;constructor(S,B,U){if(this.r=b("r",S),this.s=b("s",B),U!=null){if(A(),![0,1,2,3].includes(U))throw new Error("invalid recovery id");this.recovery=U}Object.freeze(this)}static fromBytes(S,B=y.format){v(S,B);let U;if(B==="der"){const{r:Q,s:re}=wi.toSig(_e(S));return new C(Q,re)}B==="recovered"&&(U=S[0],B="compact",S=S.subarray(1));const q=f.signature/2,M=S.subarray(0,q),K=S.subarray(q,q*2);return new C(o.fromBytes(M),o.fromBytes(K),U)}static fromHex(S,B){return this.fromBytes(Lc(S),B)}assertRecovery(){const{recovery:S}=this;if(S==null)throw new Error("invalid recovery id: must be present");return S}addRecoveryBit(S){return new C(this.r,this.s,S)}recoverPublicKey(S){const{r:B,s:U}=this,q=this.assertRecovery(),M=q===2||q===3?B+a:B;if(!s.isValid(M))throw new Error("invalid recovery id: sig.r+curve.n != R.x");const K=s.toBytes(M),Q=r.fromBytes(wn(h7((q&1)===0),K)),re=o.inv(M),X=R(_e(S,void 0,"msgHash")),Se=o.create(-X*re),ve=o.create(U*re),fe=r.BASE.multiplyUnsafe(Se).add(Q.multiplyUnsafe(ve));if(fe.is0())throw new Error("invalid recovery: point at infinify");return fe.assertValidity(),fe}hasHighS(){return p(this.s)}toBytes(S=y.format){if(k0(S),S==="der")return Lc(wi.hexFromSig(this));const{r:B,s:U}=this,q=o.toBytes(B),M=o.toBytes(U);return S==="recovered"?(A(),wn(Uint8Array.of(this.assertRecovery()),q,M)):wn(q,M)}toHex(S){return wl(this.toBytes(S))}}const T=t.bits2int||function(S){if(S.length>8192)throw new Error("input is too large");const B=Kh(S),U=S.length*8-c;return U>0?B>>BigInt(U):B},R=t.bits2int_modN||function(S){return o.create(T(S))},L=Yp(c);function N(k){return Mc("num < 2^"+c,k,zn,L),o.toBytes(k)}function E(k,S){return _e(k,void 0,"message"),S?_e(e(k),void 0,"prehashed message"):k}function O(k,S,B){const{lowS:U,prehash:q,extraEntropy:M}=E1(B,y);k=E(k,q);const K=R(k),Q=o.fromBytes(S);if(!o.isValidNot0(Q))throw new Error("invalid private key");const re=[N(Q),N(K)];if(M!=null&&M!==!1){const fe=M===!0?n(f.secretKey):M;re.push(_e(fe,void 0,"extraEntropy"))}const X=wn(...re),Se=K;function ve(fe){const Fe=T(fe);if(!o.isValidNot0(Fe))return;const ot=o.inv(Fe),De=r.BASE.multiply(Fe).toAffine(),ut=o.create(De.x);if(ut===zn)return;const _t=o.create(ot*o.create(Se+ut*Q));if(_t===zn)return;let Yi=(De.x===ut?0:2)|Number(De.y&xo),dn=_t;return U&&p(_t)&&(dn=o.neg(_t),Yi^=1),new C(ut,dn,m?void 0:Yi)}return{seed:X,k2sig:ve}}function V(k,S,B={}){const{seed:U,k2sig:q}=O(k,S,B);return Ck(e.outputLen,o.BYTES,i)(U,q).toBytes(B.format)}function $(k,S,B,U={}){const{lowS:q,prehash:M,format:K}=E1(U,y);if(B=_e(B,void 0,"publicKey"),S=E(S,M),!Hh(k)){const Q=k instanceof C?", use sig.toBytes()":"";throw new Error("verify expects Uint8Array signature"+Q)}v(k,K);try{const Q=C.fromBytes(k,K),re=r.fromBytes(B);if(q&&Q.hasHighS())return!1;const{r:X,s:Se}=Q,ve=R(S),fe=o.inv(Se),Fe=o.create(ve*fe),ot=o.create(X*fe),De=r.BASE.multiplyUnsafe(Fe).add(re.multiplyUnsafe(ot));return De.is0()?!1:o.create(De.x)===X}catch{return!1}}function I(k,S,B={}){const{prehash:U}=E1(B,y);return S=E(S,U),C.fromBytes(k,"recovered").recoverPublicKey(S).toBytes()}return Object.freeze({keygen:l,getPublicKey:u,getSharedSecret:d,utils:h,lengths:f,Point:r,sign:V,verify:$,recoverPublicKey:I,Signature:C,hash:e})}const ag={p:BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),n:BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),h:BigInt(1),a:BigInt(0),b:BigInt(7),Gx:BigInt("0x79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798"),Gy:BigInt("0x483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8")},rI={beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),basises:[[BigInt("0x3086d221a7d46bcde86c90e49284eb15"),-BigInt("0xe4437ed6010e88286f547fa90abfe4c3")],[BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),BigInt("0x3086d221a7d46bcde86c90e49284eb15")]]},X4=BigInt(2);function nI(r){const e=ag.p,t=BigInt(3),n=BigInt(6),i=BigInt(11),s=BigInt(22),o=BigInt(23),a=BigInt(44),c=BigInt(88),l=r*r*r%e,u=l*l*r%e,d=ct(u,t,e)*u%e,h=ct(d,t,e)*u%e,f=ct(h,X4,e)*l%e,y=ct(f,i,e)*f%e,m=ct(y,s,e)*y%e,p=ct(m,a,e)*m%e,b=ct(p,c,e)*p%e,A=ct(b,a,e)*m%e,v=ct(A,t,e)*u%e,C=ct(v,o,e)*y%e,T=ct(C,n,e)*l%e,R=ct(T,X4,e);if(!C0.eql(C0.sqr(R),r))throw new Error("Cannot find square root");return R}const C0=Wh(ag.p,{sqrt:nI}),iI=JC(ag,{Fp:C0,endo:rI}),Gn=tI(iI,Ti),sI=32;function oI(r,e,t){const n=Et.digest(e instanceof Uint8Array?e:e.subarray());if(Gh(n))return n.then(({digest:i})=>(t?.signal?.throwIfAborted(),Gn.sign(i,r,{prehash:!1,format:"der"}))).catch(i=>{throw i.name==="AbortError"?i:new N4(String(i))});try{return Gn.sign(n.digest,r,{prehash:!1,format:"der"})}catch(i){throw new N4(String(i))}}function aI(r,e,t,n){const i=Et.digest(t instanceof Uint8Array?t:t.subarray());if(Gh(i))return i.then(({digest:s})=>(n?.signal?.throwIfAborted(),Gn.verify(e,s,r,{prehash:!1,format:"der"}))).catch(s=>{throw s.name==="AbortError"?s:new D4(String(s))});try{return n?.signal?.throwIfAborted(),Gn.verify(e,i.digest,r,{prehash:!1,format:"der"})}catch(s){throw new D4(String(s))}}class p7{type="secp256k1";raw;_key;constructor(e){this._key=dI(e),this.raw=lI(this._key)}toMultihash(){return jn.digest(En(this))}toCID(){return ae.createV1(114,this.toMultihash())}toString(){return Ct.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:Te(this.raw,e.raw)}verify(e,t,n){return aI(this._key,t,e,n)}}class g7{type="secp256k1";raw;publicKey;constructor(e,t){this.raw=uI(e),this.publicKey=new p7(t??hI(e))}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:Te(this.raw,e.raw)}sign(e,t){return oI(this.raw,e,t)}}function m7(r){return new g7(r)}function y7(r){return new p7(r)}async function cI(){const r=fI();return new g7(r)}function lI(r){return Gn.Point.fromBytes(r).toBytes()}function uI(r){try{return Gn.getPublicKey(r,!0),r}catch(e){throw new t8(String(e))}}function dI(r){try{return Gn.Point.fromBytes(r),r}catch(e){throw new Yu(String(e))}}function hI(r){try{return Gn.getPublicKey(r,!0)}catch(e){throw new t8(String(e))}}function fI(){return Gn.utils.randomSecretKey()}async function cg(r,e){if(r==="Ed25519")return cC();if(r==="secp256k1")return cI();if(r==="RSA")return HC(mI(e));if(r==="ECDSA")return rk(yI(e));throw new ca}function on(r,e){const{Type:t,Data:n}=Oi.decode(r),i=n??new Uint8Array;switch(t){case st.RSA:return FC(i,e);case st.Ed25519:return n7(i);case st.secp256k1:return y7(i);case st.ECDSA:return T8(i);default:throw new ca}}function w7(r){const{Type:e,Data:t}=Oi.decode(r.digest),n=t??new Uint8Array;switch(e){case st.Ed25519:return n7(n);case st.secp256k1:return y7(n);case st.ECDSA:return T8(n);default:throw new ca}}function En(r){return Oi.encode({Type:st[r.type],Data:r.raw})}function pI(r){const e=ud.decode(r),t=e.Data??new Uint8Array;switch(e.Type){case st.RSA:return UC(t);case st.Ed25519:return r7(t);case st.secp256k1:return m7(t);case st.ECDSA:return ZA(t);default:throw new ca}}function gI(r){if(r.byteLength===mn)return r7(r);if(r.byteLength===sI)return m7(r);const e=Fs(r),t=e[2]?.[0];if(t===HA||t===qA||t===KA)return _8(e);if(e.length>8)return l7(e);throw new H("Could not extract private key from raw bytes")}function El(r){return ud.encode({Type:st[r.type],Data:r.raw})}function mI(r){return r==null?2048:parseInt(r,10)}function yI(r){if(r==="P-256"||r==null)return"P-256";if(r==="P-384")return"P-384";if(r==="P-521")return"P-521";throw new H("Unsupported curve, should be P-256, P-384 or P-521")}async function b7(r){if(r.type==="RSA")return{privateKey:await crypto.subtle.importKey("jwk",r.jwk,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["sign"]),publicKey:await crypto.subtle.importKey("jwk",r.publicKey.jwk,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["verify"])};if(r.type==="ECDSA")return{privateKey:await crypto.subtle.importKey("jwk",r.jwk,{name:"ECDSA",namedCurve:r.jwk.crv??"P-256"},!0,["sign"]),publicKey:await crypto.subtle.importKey("jwk",r.publicKey.jwk,{name:"ECDSA",namedCurve:r.publicKey.jwk.crv??"P-256"},!0,["verify"])};throw new H("Only RSA and ECDSA keys are supported")}const Ma=Uint32Array.from([1732584193,4023233417,2562383102,271733878,3285377520]),gi=new Uint32Array(80);class wI extends Kp{A=Ma[0]|0;B=Ma[1]|0;C=Ma[2]|0;D=Ma[3]|0;E=Ma[4]|0;constructor(){super(64,20,8,!1)}get(){const{A:e,B:t,C:n,D:i,E:s}=this;return[e,t,n,i,s]}set(e,t,n,i,s){this.A=e|0,this.B=t|0,this.C=n|0,this.D=i|0,this.E=s|0}process(e,t){for(let c=0;c<16;c++,t+=4)gi[c]=e.getUint32(t,!1);for(let c=16;c<80;c++)gi[c]=p1(gi[c-3]^gi[c-8]^gi[c-14]^gi[c-16],1);let{A:n,B:i,C:s,D:o,E:a}=this;for(let c=0;c<80;c++){let l,u;c<20?(l=D8(i,s,o),u=1518500249):c<40?(l=i^s^o,u=1859775393):c<60?(l=B8(i,s,o),u=2400959708):(l=i^s^o,u=3395469782);const d=p1(n,5)+l+a+u+gi[c]|0;a=o,o=s,s=p1(i,30),i=n,n=d}n=n+this.A|0,i=i+this.B|0,s=s+this.C|0,o=o+this.D|0,a=a+this.E|0,this.set(n,i,s,o,a)}roundClean(){In(gi)}destroy(){this.set(0,0,0,0,0),In(this.buffer)}}const bI=qp(()=>new wI);function v7(r,e,t,n){yl(r);const i=ck({dkLen:32,asyncTick:10},n),{c:s,dkLen:o,asyncTick:a}=i;if(Jr(s,"c"),Jr(o,"dkLen"),Jr(a,"asyncTick"),s<1)throw new Error("iterations (c) must be >= 1");const c=M4(e,"password"),l=M4(t,"salt"),u=new Uint8Array(o),d=vl.create(r,c),h=d._cloneInto().update(l);return{c:s,dkLen:o,asyncTick:a,DK:u,PRF:d,PRFSalt:h}}function E7(r,e,t,n,i){return r.destroy(),e.destroy(),n&&n.destroy(),In(i),t}function vI(r,e,t,n){const{c:i,dkLen:s,DK:o,PRF:a,PRFSalt:c}=v7(r,e,t,n);let l;const u=new Uint8Array(4),d=pc(u),h=new Uint8Array(a.outputLen);for(let f=1,y=0;y<s;f++,y+=a.outputLen){const m=o.subarray(y,y+a.outputLen);d.setInt32(0,f,!1),(l=c._cloneInto(l)).update(u).digestInto(h),m.set(h.subarray(0,m.length));for(let p=1;p<i;p++){a._cloneInto(l).update(h).digestInto(h);for(let b=0;b<m.length;b++)m[b]^=h[b]}}return E7(a,c,o,l,h)}async function S7(r,e,t,n){const{c:i,dkLen:s,asyncTick:o,DK:a,PRF:c,PRFSalt:l}=v7(r,e,t,n);let u;const d=new Uint8Array(4),h=pc(d),f=new Uint8Array(c.outputLen);for(let y=1,m=0;m<s;y++,m+=c.outputLen){const p=a.subarray(m,m+c.outputLen);h.setInt32(0,y,!1),(u=l._cloneInto(u)).update(d).digestInto(f),p.set(f.subarray(0,p.length)),await ok(i-1,o,()=>{c._cloneInto(u).update(f).digestInto(f);for(let b=0;b<p.length;b++)p[b]^=f[b]})}return E7(c,l,a,u,f)}const Z4={sha1:bI,"sha2-256":Ti,"sha2-512":qh};function J4(r,e,t,n,i){if(i!=="sha1"&&i!=="sha2-256"&&i!=="sha2-512"){const a=Object.keys(Z4).join(" / ");throw new H(`Hash '${i}' is unknown or not supported. Must be ${a}`)}const s=Z4[i],o=vI(s,r,e,{c:t,dkLen:n});return Br.encode(o).substring(1)}const lg={32:16777619n,64:1099511628211n,128:309485009821345068724781371n,256:374144419156711147060143317175368453031918731002211n,512:35835915874844867368919076489095108449946327955754392558399825615420669938882575126094039892345713852759n,1024:5016456510113118655434598811035278955030765345404790744303017523831112055108147451509157692220295382716162651878526895249385292291816524375083746691371804094271873160484737966720260389217684476157468082573n},x7={32:2166136261n,64:14695981039346656037n,128:144066263297769815596495629667062367629n,256:100029257958052580907070968620625704837092796014241193945225284501741471925557n,512:9659303129496669498009435400716310466090418745672637896108374329434462657994582932197716438449813051892206539805784495328239340083876191928701583869517785n,1024:14197795064947621068722070641403218320880622795441933960878474914617582723252296732303717722150864096521202355549365628174669108571814760471015076148029755969804077320157692458563003215304957150157403644460363550505412711285966361610267868082893823963790439336411086884584107735010676915n},A7=new globalThis.TextEncoder;function EI(r,e){const t=lg[e];let n=x7[e];for(let i=0;i<r.length;i++)n^=BigInt(r[i]),n=BigInt.asUintN(e,n*t);return n}function SI(r,e,t){if(t.length===0)throw new Error("The `utf8Buffer` option must have a length greater than zero");const n=lg[e];let i=x7[e],s=r;for(;s.length>0;){const o=A7.encodeInto(s,t);s=s.slice(o.read);for(let a=0;a<o.written;a++)i^=BigInt(t[a]),i=BigInt.asUintN(e,i*n)}return i}function xI(r,{size:e=32,utf8Buffer:t}={}){if(!lg[e])throw new Error("The `size` option must be one of 32, 64, 128, 256, 512, or 1024");if(typeof r=="string"){if(t)return SI(r,e,t);r=A7.encode(r)}return EI(r,e)}const ug={hash:r=>Number(xI(r,{size:32})),hashV:(r,e)=>AI(ug.hash(r,e))};function AI(r){let e=r.toString(16);return e.length%2===1&&(e=`0${e}`),W(e,"base16")}const k7=64;class ss{fp;h;seed;constructor(e,t,n,i=2){if(i>k7)throw new TypeError("Invalid Fingerprint Size");const s=t.hashV(e,n),o=Re(i);for(let a=0;a<o.length;a++)o[a]=s[a];o.length===0&&(o[0]=7),this.fp=o,this.h=t,this.seed=n}hash(){return this.h.hash(this.fp,this.seed)}equals(e){return e?.fp instanceof Uint8Array?Te(this.fp,e.fp):!1}}function dd(r,e){return Math.floor(Math.random()*(e-r))+r}let su=class{contents;constructor(e){this.contents=new Array(e).fill(null)}has(e){if(!(e instanceof ss))throw new TypeError("Invalid Fingerprint");return this.contents.some(t=>e.equals(t))}add(e){if(!(e instanceof ss))throw new TypeError("Invalid Fingerprint");for(let t=0;t<this.contents.length;t++)if(this.contents[t]==null)return this.contents[t]=e,!0;return!0}swap(e){if(!(e instanceof ss))throw new TypeError("Invalid Fingerprint");const t=dd(0,this.contents.length-1),n=this.contents[t];return this.contents[t]=e,n}remove(e){if(!(e instanceof ss))throw new TypeError("Invalid Fingerprint");const t=this.contents.findIndex(n=>e.equals(n));return t>-1?(this.contents[t]=null,!0):!1}};const kI=500;class em{bucketSize;filterSize;fingerprintSize;buckets;count;hash;seed;constructor(e){this.filterSize=e.filterSize,this.bucketSize=e.bucketSize??4,this.fingerprintSize=e.fingerprintSize??2,this.count=0,this.buckets=[],this.hash=e.hash??ug,this.seed=e.seed??dd(0,Math.pow(2,10))}add(e){typeof e=="string"&&(e=W(e));const t=new ss(e,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(e,this.seed)%this.filterSize,i=(n^t.hash())%this.filterSize;if(this.buckets[n]==null&&(this.buckets[n]=new su(this.bucketSize)),this.buckets[i]==null&&(this.buckets[i]=new su(this.bucketSize)),this.buckets[n].add(t)||this.buckets[i].add(t))return this.count++,!0;const s=[n,i];let o=s[dd(0,s.length-1)];this.buckets[o]==null&&(this.buckets[o]=new su(this.bucketSize));for(let a=0;a<kI;a++){const c=this.buckets[o].swap(t);if(c!=null&&(o=(o^c.hash())%this.filterSize,this.buckets[o]==null&&(this.buckets[o]=new su(this.bucketSize)),this.buckets[o].add(c)))return this.count++,!0}return!1}has(e){typeof e=="string"&&(e=W(e));const t=new ss(e,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(e,this.seed)%this.filterSize,i=this.buckets[n]?.has(t)??!1;if(i)return i;const s=(n^t.hash())%this.filterSize;return this.buckets[s]?.has(t)??!1}remove(e){typeof e=="string"&&(e=W(e));const t=new ss(e,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(e,this.seed)%this.filterSize,i=this.buckets[n]?.remove(t)??!1;if(i)return this.count--,i;const s=(n^t.hash())%this.filterSize,o=this.buckets[s]?.remove(t)??!1;return o&&this.count--,o}get reliable(){return Math.floor(100*(this.count/this.filterSize))<=90}}const CI={1:.5,2:.84,4:.95,8:.98};function II(r=.001){return r>.002?2:r>1e-5?4:8}function _I(r,e=.001){const t=II(e),n=CI[t],i=Math.round(r/n),s=Math.min(Math.ceil(Math.log2(1/e)+Math.log2(2*t)),k7);return{filterSize:i,bucketSize:t,fingerprintSize:s}}class C7{filterSize;bucketSize;fingerprintSize;scale;filterSeries;hash;seed;constructor(e){this.bucketSize=e.bucketSize??4,this.filterSize=e.filterSize??(1<<18)/this.bucketSize,this.fingerprintSize=e.fingerprintSize??2,this.scale=e.scale??2,this.hash=e.hash??ug,this.seed=e.seed??dd(0,Math.pow(2,10)),this.filterSeries=[new em({filterSize:this.filterSize,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed})]}add(e){if(typeof e=="string"&&(e=W(e)),this.has(e))return!0;let t=this.filterSeries.find(n=>n.reliable);if(t==null){const n=this.filterSize*Math.pow(this.scale,this.filterSeries.length);t=new em({filterSize:n,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed}),this.filterSeries.push(t)}return t.add(e)}has(e){typeof e=="string"&&(e=W(e));for(let t=0;t<this.filterSeries.length;t++)if(this.filterSeries[t].has(e))return!0;return!1}remove(e){typeof e=="string"&&(e=W(e));for(let t=0;t<this.filterSeries.length;t++)if(this.filterSeries[t].remove(e))return!0;return!1}get count(){return this.filterSeries.reduce((e,t)=>e+t.count,0)}}function Mi(r,e=.001,t){return new C7({..._I(r,e)})}function Ne(r){const e=r.getComponents(),t={};let n=0;if(e[n]?.name==="ip6zone"&&(t.zone=`${e[n].value}`,n++),e[n].name==="ip4"||e[n].name==="ip6"||e[n].name==="dns"||e[n].name==="dns4"||e[n].name==="dns6"?(t.type=e[n].name,t.host=e[n].value,n++):e[n].name==="dnsaddr"&&(t.type=e[n].name,t.host=`_dnsaddr.${e[n].value}`,n++),(e[n]?.name==="tcp"||e[n]?.name==="udp")&&(t.protocol=e[n].name==="tcp"?"tcp":"udp",t.port=parseInt(`${e[n].value}`),n++),e[n]?.name==="ipcidr"&&(t.type==="ip4"?t.cidr=parseInt(`${e[n].value}`):t.type==="ip6"&&(t.cidr=`${e[n].value}`),n++),t.type==null||t.host==null)throw new H(`Multiaddr ${r} was not an IPv4, IPv6, DNS, DNS4, DNS6 or DNSADDR address`);return e[n]?.name==="tls"&&e[n+1]?.name==="sni"&&(t.sni=e[n+1].value,n+=2),t}class TI{index=0;input="";new(e){return this.index=0,this.input=e,this}readAtomically(e){const t=this.index,n=e();return n===void 0&&(this.index=t),n}parseWith(e){const t=e();if(this.index===this.input.length)return t}peekChar(){if(!(this.index>=this.input.length))return this.input[this.index]}readChar(){if(!(this.index>=this.input.length))return this.input[this.index++]}readGivenChar(e){return this.readAtomically(()=>{const t=this.readChar();if(t===e)return t})}readSeparator(e,t,n){return this.readAtomically(()=>{if(!(t>0&&this.readGivenChar(e)===void 0))return n()})}readNumber(e,t,n,i){return this.readAtomically(()=>{let s=0,o=0;const a=this.peekChar();if(a===void 0)return;const c=a==="0",l=2**(8*i)-1;for(;;){const u=this.readAtomically(()=>{const d=this.readChar();if(d===void 0)return;const h=Number.parseInt(d,e);if(!Number.isNaN(h))return h});if(u===void 0)break;if(s*=e,s+=u,s>l||(o+=1,t!==void 0&&o>t))return}if(o!==0)return!n&&c&&o>1?void 0:s})}readIPv4Addr(){return this.readAtomically(()=>{const e=new Uint8Array(4);for(let t=0;t<e.length;t++){const n=this.readSeparator(".",t,()=>this.readNumber(10,3,!1,1));if(n===void 0)return;e[t]=n}return e})}readIPv6Addr(){const e=t=>{for(let n=0;n<t.length/2;n++){const i=n*2;if(n<t.length-3){const o=this.readSeparator(":",n,()=>this.readIPv4Addr());if(o!==void 0)return t[i]=o[0],t[i+1]=o[1],t[i+2]=o[2],t[i+3]=o[3],[i+4,!0]}const s=this.readSeparator(":",n,()=>this.readNumber(16,4,!0,2));if(s===void 0)return[i,!1];t[i]=s>>8,t[i+1]=s&255}return[t.length,!1]};return this.readAtomically(()=>{const t=new Uint8Array(16),[n,i]=e(t);if(n===16)return t;if(i||this.readGivenChar(":")===void 0||this.readGivenChar(":")===void 0)return;const s=new Uint8Array(14),o=16-(n+2),[a]=e(s.subarray(0,o));return t.set(s.subarray(0,a),16-a),t})}readIPAddr(){return this.readIPv4Addr()??this.readIPv6Addr()}}const I7=45,PI=15,Oo=new TI;function _7(r){if(!(r.length>PI))return Oo.new(r).parseWith(()=>Oo.readIPv4Addr())}function T7(r){if(r.includes("%")&&(r=r.split("%")[0]),!(r.length>I7))return Oo.new(r).parseWith(()=>Oo.readIPv6Addr())}function I0(r,e=!1){if(r.includes("%")&&(r=r.split("%")[0]),r.length>I7)return;const t=Oo.new(r).parseWith(()=>Oo.readIPAddr());if(t)return e&&t.length===4?Uint8Array.from([0,0,0,0,0,0,0,0,0,0,255,255,t[0],t[1],t[2],t[3]]):t}function RI(r,e,t){let n=0;for(const i of r)if(!(n<e)){if(n>t)break;if(i!==255)return!1;n++}return!0}function NI(r,e,t,n){let i=0;for(const s of r)if(!(i<t)){if(i>n)break;if(s!==e[i])return!1;i++}return!0}function DI(r){switch(r.length){case Uc:return r.join(".");case Fc:{const e=[];for(let t=0;t<r.length;t++)t%2===0&&e.push(r[t].toString(16).padStart(2,"0")+r[t+1].toString(16).padStart(2,"0"));return e.join(":")}default:throw new Error("Invalid ip length")}}function BI(r){let e=0;for(let[t,n]of r.entries()){if(n===255){e+=8;continue}for(;(n&128)!=0;)e++,n=n<<1;if((n&128)!=0)return-1;for(let i=t+1;i<r.length;i++)if(r[i]!=0)return-1;break}return e}function LI(r){let e="0x";for(const t of r)e+=(t>>4).toString(16)+(t&15).toString(16);return e}const Uc=4,Fc=16,OI=new Uint8Array([0,0,0,0,0,0,0,0,0,0,255,255]);function P7(r,e){e.length===Fc&&r.length===Uc&&RI(e,0,11)&&(e=e.slice(12)),e.length===Uc&&r.length===Fc&&NI(r,OI,0,11)&&(r=r.slice(12));const t=r.length;if(t!=e.length)throw new Error("Failed to mask ip");const n=new Uint8Array(t);for(let i=0;i<t;i++)n[i]=r[i]&e[i];return n}function MI(r,e){if(typeof e=="string"&&(e=I0(e)),e==null)throw new Error("Invalid ip");if(e.length!==r.network.length)return!1;for(let t=0;t<e.length;t++)if((r.network[t]&r.mask[t])!==(e[t]&r.mask[t]))return!1;return!0}function $I(r){const[e,t]=r.split("/");if(!e||!t)throw new Error("Failed to parse given CIDR: "+r);let n=Uc,i=_7(e);if(i==null&&(n=Fc,i=T7(e),i==null))throw new Error("Failed to parse given CIDR: "+r);const s=parseInt(t,10);if(Number.isNaN(s)||String(s).length!==t.length||s<0||s>n*8)throw new Error("Failed to parse given CIDR: "+r);const o=R7(s,8*n);return{network:P7(i,o),mask:o}}function R7(r,e){if(e!==8*Uc&&e!==8*Fc)throw new Error("Invalid CIDR mask");if(r<0||r>e)throw new Error("Invalid CIDR mask");const t=e/8,n=new Uint8Array(t);for(let i=0;i<t;i++){if(r>=8){n[i]=255,r-=8;continue}n[i]=255-(255>>r),r=0}return n}class N7{constructor(e,t){if(t==null)({network:this.network,mask:this.mask}=$I(e));else{const n=I0(e);if(n==null)throw new Error("Failed to parse network");t=String(t);const i=parseInt(t,10);if(Number.isNaN(i)||String(i).length!==t.length||i<0||i>n.length*8){const s=I0(t);if(s==null)throw new Error("Failed to parse mask");this.mask=s}else this.mask=R7(i,8*n.length);this.network=P7(n,this.mask)}}contains(e){return MI({network:this.network,mask:this.mask},e)}toString(){const e=BI(this.mask),t=e!==-1?String(e):LI(this.mask);return DI(this.network)+"/"+t}}function UI(r,e){return new N7(r).contains(e)}function D7(r){try{const e=Ne(r);switch(e.type){case"ip6":return UI("2000::/3",e.host);default:return!1}}catch{return!1}}function FI(r){try{const e=Ne(r);switch(e.type){case"ip4":return e.host.startsWith("169.254.");case"ip6":return e.host.toLowerCase().startsWith("fe80");default:return!1}}catch{return!1}}function VI(r){return/^127\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/i.test(r)||/^::1$/.test(r)}function _0(r){try{const e=Ne(r);switch(e.type){case"ip4":case"ip6":return VI(e.host);default:return!1}}catch{return!1}}function en(r){try{return Ne(r),!0}catch{return!1}}function Mo(r){return!!_7(r)}function B7(r){return!!T7(r)}var no={},tm;function zI(){return tm||(tm=1,(function(){var r,e,t,n,i,s,o,a;a=function(c){var l,u,d,h;return l=(c&255<<24)>>>24,u=(c&255<<16)>>>16,d=(c&65280)>>>8,h=c&255,[l,u,d,h].join(".")},o=function(c){var l,u,d,h,f,y;for(l=[],d=h=0;h<=3&&c.length!==0;d=++h){if(d>0){if(c[0]!==".")throw new Error("Invalid IP");c=c.substring(1)}y=e(c),f=y[0],u=y[1],c=c.substring(u),l.push(f)}if(c.length!==0)throw new Error("Invalid IP");switch(l.length){case 1:if(l[0]>4294967295)throw new Error("Invalid IP");return l[0]>>>0;case 2:if(l[0]>255||l[1]>16777215)throw new Error("Invalid IP");return(l[0]<<24|l[1])>>>0;case 3:if(l[0]>255||l[1]>255||l[2]>65535)throw new Error("Invalid IP");return(l[0]<<24|l[1]<<16|l[2])>>>0;case 4:if(l[0]>255||l[1]>255||l[2]>255||l[3]>255)throw new Error("Invalid IP");return(l[0]<<24|l[1]<<16|l[2]<<8|l[3])>>>0;default:throw new Error("Invalid IP")}},t=function(c){return c.charCodeAt(0)},n=t("0"),s=t("a"),i=t("A"),e=function(c){var l,u,d,h,f;for(h=0,l=10,u="9",d=0,c.length>1&&c[d]==="0"&&(c[d+1]==="x"||c[d+1]==="X"?(d+=2,l=16):"0"<=c[d+1]&&c[d+1]<="9"&&(d++,l=8,u="7")),f=d;d<c.length;){if("0"<=c[d]&&c[d]<=u)h=h*l+(t(c[d])-n)>>>0;else if(l===16)if("a"<=c[d]&&c[d]<="f")h=h*l+(10+t(c[d])-s)>>>0;else if("A"<=c[d]&&c[d]<="F")h=h*l+(10+t(c[d])-i)>>>0;else break;else break;if(h>4294967295)throw new Error("too large");d++}if(d===f)throw new Error("empty octet");return[h,d]},r=(function(){function c(l,u){var d,h,f;if(typeof l!="string")throw new Error("Missing `net' parameter");if(u||(f=l.split("/",2),l=f[0],u=f[1]),u||(u=32),typeof u=="string"&&u.indexOf(".")>-1){try{this.maskLong=o(u)}catch{throw new Error("Invalid mask: "+u)}for(d=h=32;h>=0;d=--h)if(this.maskLong===4294967295<<32-d>>>0){this.bitmask=d;break}}else if(u||u===0)this.bitmask=parseInt(u,10),this.maskLong=0,this.bitmask>0&&(this.maskLong=4294967295<<32-this.bitmask>>>0);else throw new Error("Invalid mask: empty");try{this.netLong=(o(l)&this.maskLong)>>>0}catch{throw new Error("Invalid net address: "+l)}if(!(this.bitmask<=32))throw new Error("Invalid mask for ip4: "+u);this.size=Math.pow(2,32-this.bitmask),this.base=a(this.netLong),this.mask=a(this.maskLong),this.hostmask=a(~this.maskLong),this.first=this.bitmask<=30?a(this.netLong+1):this.base,this.last=this.bitmask<=30?a(this.netLong+this.size-2):a(this.netLong+this.size-1),this.broadcast=this.bitmask<=30?a(this.netLong+this.size-1):void 0}return c.prototype.contains=function(l){return typeof l=="string"&&(l.indexOf("/")>0||l.split(".").length!==4)&&(l=new c(l)),l instanceof c?this.contains(l.base)&&this.contains(l.broadcast||l.last):(o(l)&this.maskLong)>>>0===(this.netLong&this.maskLong)>>>0},c.prototype.next=function(l){return l==null&&(l=1),new c(a(this.netLong+this.size*l),this.mask)},c.prototype.forEach=function(l){var u,d,h;for(h=o(this.first),d=o(this.last),u=0;h<=d;)l(a(h),h,u),u++,h++},c.prototype.toString=function(){return this.base+"/"+this.bitmask},c})(),no.ip2long=o,no.long2ip=a,no.Netmask=r}).call(no)),no}var HI=zI();const qI=["0.0.0.0/8","10.0.0.0/8","100.64.0.0/10","127.0.0.0/8","169.254.0.0/16","172.16.0.0/12","192.0.0.0/24","192.0.0.0/29","192.0.0.8/32","192.0.0.9/32","192.0.0.10/32","192.0.0.170/32","192.0.0.171/32","192.0.2.0/24","192.31.196.0/24","192.52.193.0/24","192.88.99.0/24","192.168.0.0/16","192.175.48.0/24","198.18.0.0/15","198.51.100.0/24","203.0.113.0/24","240.0.0.0/4","255.255.255.255/32"],KI=qI.map(r=>new HI.Netmask(r));function dg(r){for(const e of KI)if(e.contains(r))return!0;return!1}function WI(r){return/^::ffff:([0-9a-fA-F]{1,4}):([0-9a-fA-F]{1,4})$/.test(r)}function jI(r){const e=r.split(":");if(e.length<2)return!1;const t=e[e.length-1].padStart(4,"0"),n=e[e.length-2].padStart(4,"0"),i=`${parseInt(n.substring(0,2),16)}.${parseInt(n.substring(2),16)}.${parseInt(t.substring(0,2),16)}.${parseInt(t.substring(2),16)}`;return dg(i)}function GI(r){return/^::ffff:([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(r)}function YI(r){const e=r.split(":"),t=e[e.length-1];return dg(t)}function QI(r){return/^::$/.test(r)||/^::1$/.test(r)||/^64:ff9b::([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(r)||/^100::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001:2[0-9a-fA-F]:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001:db8:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2002:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^f[c-d]([0-9a-fA-F]{2,2}):/i.test(r)||/^fe[8-9a-bA-B][0-9a-fA-F]:/i.test(r)||/^ff([0-9a-fA-F]{2,2}):/i.test(r)}function hg(r){if(Mo(r))return dg(r);if(WI(r))return jI(r);if(GI(r))return YI(r);if(B7(r))return QI(r)}function Or(r){try{const e=Ne(r);switch(e.type){case"ip4":case"ip6":return hg(e.host)??!1;default:return e.host==="localhost"}}catch{return!1}}function Ze(){const r={};return r.promise=new Promise((e,t)=>{r.resolve=e,r.reject=t}),r}class rm{buffer;mask;top;btm;next;constructor(e){if(!(e>0)||(e-1&e)!==0)throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}push(e){return this.buffer[this.top]!==void 0?!1:(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){const e=this.buffer[this.btm];if(e!==void 0)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}isEmpty(){return this.buffer[this.btm]===void 0}}class S1{size;hwm;head;tail;constructor(e={}){this.hwm=e.splitLimit??16,this.head=new rm(this.hwm),this.tail=this.head,this.size=0}calculateSize(e){return e?.byteLength!=null?e.byteLength:1}push(e){if(e?.value!=null&&(this.size+=this.calculateSize(e.value)),!this.head.push(e)){const t=this.head;this.head=t.next=new rm(2*this.head.buffer.length),this.head.push(e)}}shift(){let e=this.tail.shift();if(e===void 0&&this.tail.next!=null){const t=this.tail.next;this.tail.next=null,this.tail=t,e=this.tail.shift()}return e?.value!=null&&(this.size-=this.calculateSize(e.value)),e}isEmpty(){return this.head.isEmpty()}}let XI=class extends Error{type;code;constructor(e,t){super(e??"The operation was aborted"),this.type="aborted",this.code=t??"ABORT_ERR"}};function ii(r={}){return ZI(t=>{const n=t.shift();if(n==null)return{done:!0};if(n.error!=null)throw n.error;return{done:n.done===!0,value:n.value}},r)}function ZI(r,e){e=e??{};let t=e.onEnd,n=new S1,i,s,o,a=Ze();const c=async()=>{try{return n.isEmpty()?o?{done:!0}:await new Promise((p,b)=>{s=A=>{s=null,n.push(A);try{p(r(n))}catch(v){b(v)}return i}}):r(n)}finally{n.isEmpty()&&queueMicrotask(()=>{a.resolve(),a=Ze()})}},l=p=>s!=null?s(p):(n.push(p),i),u=p=>(n=new S1,s!=null?s({error:p}):(n.push({error:p}),i)),d=p=>{if(o)return i;if(e?.objectMode!==!0&&p?.byteLength==null)throw new Error("objectMode was not true but tried to push non-Uint8Array value");return l({done:!1,value:p})},h=p=>o?i:(o=!0,p!=null?u(p):l({done:!0})),f=()=>(n=new S1,h(),{done:!0}),y=p=>(h(p),{done:!0});if(i={[Symbol.asyncIterator](){return this},next:c,return:f,throw:y,push:d,end:h,get readableLength(){return n.size},onEmpty:async p=>{const b=p?.signal;if(b?.throwIfAborted(),n.isEmpty())return;let A,v;b!=null&&(A=new Promise((C,T)=>{v=()=>{T(new XI)},b.addEventListener("abort",v)}));try{await Promise.race([a.promise,A])}finally{v!=null&&b!=null&&b?.removeEventListener("abort",v)}}},t==null)return i;const m=i;return i={[Symbol.asyncIterator](){return this},next(){return m.next()},throw(p){return m.throw(p),t!=null&&(t(p),t=void 0),{done:!0}},return(){return m.return(),t!=null&&(t(),t=void 0),{done:!0}},push:d,end(p){return m.end(p),t!=null&&(t(p),t=void 0),i},get readableLength(){return m.readableLength},onEmpty:p=>m.onEmpty(p)},i}class JI extends Error{constructor(e){super(e),this.name="TimeoutError"}}let e_=class extends Error{constructor(e){super(),this.name="AbortError",this.message=e}};const nm=r=>globalThis.DOMException===void 0?new e_(r):new DOMException(r),im=r=>{const e=r.reason===void 0?nm("This operation was aborted."):r.reason;return e instanceof Error?e:nm(e)};function t_(r,e){const{milliseconds:t,fallback:n,message:i,customTimers:s={setTimeout,clearTimeout}}=e;let o,a;const l=new Promise((u,d)=>{if(typeof t!="number"||Math.sign(t)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${t}\``);if(e.signal){const{signal:f}=e;f.aborted&&d(im(f)),a=()=>{d(im(f))},f.addEventListener("abort",a,{once:!0})}if(t===Number.POSITIVE_INFINITY){r.then(u,d);return}const h=new JI;o=s.setTimeout.call(void 0,()=>{if(n){try{u(n())}catch(f){d(f)}return}typeof r.cancel=="function"&&r.cancel(),i===!1?u():i instanceof Error?d(i):(h.message=i??`Promise timed out after ${t} milliseconds`,d(h))},t),(async()=>{try{u(await r)}catch(f){d(f)}})()}).finally(()=>{l.clear(),a&&e.signal&&e.signal.removeEventListener("abort",a)});return l.clear=()=>{s.clearTimeout.call(void 0,o),o=void 0},l}const r_=r=>{const e=r.addEventListener||r.on||r.addListener,t=r.removeEventListener||r.off||r.removeListener;if(!e||!t)throw new TypeError("Emitter is not compatible");return{addListener:e.bind(r),removeListener:t.bind(r)}};function n_(r,e,t){let n;const i=new Promise((s,o)=>{if(t={rejectionEvents:["error"],multiArgs:!1,rejectionMultiArgs:!1,resolveImmediately:!1,...t},!(t.count>=0&&(t.count===Number.POSITIVE_INFINITY||Number.isInteger(t.count))))throw new TypeError("The `count` option should be at least 0 or more");t.signal?.throwIfAborted();const a=[e].flat(),c=[],{addListener:l,removeListener:u}=r_(r),d=async(...f)=>{const y=t.multiArgs?f:f[0];if(t.filter)try{if(!await t.filter(y))return}catch(m){n(),o(m);return}c.push(y),t.count===c.length&&(n(),s(c))},h=(...f)=>{n(),o(t.rejectionMultiArgs?f:f[0])};n=()=>{for(const f of a)u(f,d);for(const f of t.rejectionEvents)a.includes(f)||u(f,h)};for(const f of a)l(f,d);for(const f of t.rejectionEvents)a.includes(f)||l(f,h);t.signal&&t.signal.addEventListener("abort",()=>{h(t.signal.reason)},{once:!0}),t.resolveImmediately&&s(c)});if(i.cancel=n,typeof t.timeout=="number"){const s=t_(i,{milliseconds:t.timeout});return s.cancel=()=>{n(),s.clear()},s}return i}function bt(r,e,t){typeof t=="function"&&(t={filter:t}),t={...t,count:1,resolveImmediately:!1};const n=n_(r,e,t),i=n.then(s=>s[0]);return i.cancel=n.cancel,i}function Vc(r,e){let t;const n=function(){const i=function(){t=void 0,r()};clearTimeout(t),t=setTimeout(i,e)};return n.start=()=>{},n.stop=()=>{clearTimeout(t)},n}class i_ extends Error{remainingPoints;msBeforeNext;consumedPoints;isFirstInDuration;constructor(e="Rate limit exceeded",t){super(e),this.name="RateLimitError",this.remainingPoints=t.remainingPoints,this.msBeforeNext=t.msBeforeNext,this.consumedPoints=t.consumedPoints,this.isFirstInDuration=t.isFirstInDuration}}let s_=class extends Error{static name="QueueFullError";constructor(e="The queue was full"){super(e),this.name="QueueFullError"}},hd=class extends Error{static name="UnexpectedEOFError";name="UnexpectedEOFError"};class o_ extends Error{static name="MaxEarlyStreamsError";name="MaxEarlyStreamsError"}class a_ extends Error{static name="StreamClosedError";name="StreamClosedError"}function c_(r){return r.reason}async function Yt(r,e,t){if(e==null)return r;const n=t?.translateError??c_;if(e.aborted)return r.catch(()=>{}),Promise.reject(n(e));let i;try{return await Promise.race([r,new Promise((s,o)=>{i=()=>{o(n(e))},e.addEventListener("abort",i)})])}finally{i!=null&&e.removeEventListener("abort",i)}}let l_=class{deferred;signal;constructor(e){this.signal=e,this.deferred=Ze(),this.onAbort=this.onAbort.bind(this),this.signal?.addEventListener("abort",this.onAbort)}onAbort(){this.deferred.reject(this.signal?.reason??new ys)}cleanup(){this.signal?.removeEventListener("abort",this.onAbort)}};function u_(){return`${parseInt(String(Math.random()*1e9),10).toString()}${Date.now()}`}let d_=class{id;fn;options;recipients;status;timeline;controller;constructor(e,t){this.id=u_(),this.status="queued",this.fn=e,this.options=t,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,this.controller.signal,this.onAbort=this.onAbort.bind(this)}abort(e){this.controller.abort(e)}onAbort(){this.recipients.reduce((t,n)=>t&&n.signal?.aborted===!0,!0)&&(this.controller.abort(new ys),this.cleanup())}async join(e={}){const t=new l_(e.signal);return this.recipients.push(t),e.signal?.addEventListener("abort",this.onAbort),t.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();const e=await Yt(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach(t=>{t.deferred.resolve(e)}),this.status="complete"}catch(e){this.recipients.forEach(t=>{t.deferred.reject(e)}),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach(e=>{e.cleanup(),e.signal?.removeEventListener("abort",this.onAbort)})}},$i=class extends Qe{concurrency;maxSize;queue;pending;sort;paused;constructor(e={}){super(),this.concurrency=e.concurrency??Number.POSITIVE_INFINITY,this.maxSize=e.maxSize??Number.POSITIVE_INFINITY,this.pending=0,this.paused=!1,e.metricName!=null&&e.metrics?.registerMetricGroup(e.metricName,{calculate:()=>({size:this.queue.length,running:this.pending,queued:this.queue.length-this.pending})}),this.sort=e.sort,this.queue=[],this.emitEmpty=Vc(this.emitEmpty.bind(this),1),this.emitIdle=Vc(this.emitIdle.bind(this),1)}emitEmpty(){this.size===0&&this.safeDispatchEvent("empty")}emitIdle(){this.running===0&&this.safeDispatchEvent("idle")}pause(){this.paused=!0}resume(){this.paused&&(this.paused=!1,this.tryToStartAnother())}tryToStartAnother(){if(this.paused)return!1;if(this.size===0)return this.emitEmpty(),this.running===0&&this.emitIdle(),!1;if(this.pending<this.concurrency){let e;for(const t of this.queue)if(t.status==="queued"){e=t;break}return e==null?!1:(this.safeDispatchEvent("active"),this.pending++,e.run().finally(()=>{for(let t=0;t<this.queue.length;t++)if(this.queue[t]===e){this.queue.splice(t,1);break}this.pending--,this.tryToStartAnother(),this.safeDispatchEvent("next")}),!0)}return!1}enqueue(e){this.queue.push(e),this.sort!=null&&this.queue.sort(this.sort)}async add(e,t){if(t?.signal?.throwIfAborted(),this.size===this.maxSize)throw new s_;const n=new d_(e,t);return this.enqueue(n),this.safeDispatchEvent("add"),this.tryToStartAnother(),n.join(t).then(i=>(this.safeDispatchEvent("completed",{detail:i}),this.safeDispatchEvent("success",{detail:{job:n,result:i}}),i)).catch(i=>{if(n.status==="queued"){for(let s=0;s<this.queue.length;s++)if(this.queue[s]===n){this.queue.splice(s,1);break}}throw this.safeDispatchEvent("failure",{detail:{job:n,error:i}}),i})}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach(e=>{e.abort(new ys)}),this.clear()}async onEmpty(e){this.size!==0&&await bt(this,"empty",e)}async onSizeLessThan(e,t){this.size<e||await bt(this,"next",{...t,filter:()=>this.size<e})}async onIdle(e){this.pending===0&&this.size===0||await bt(this,"idle",e)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(e){e?.signal?.throwIfAborted();const t=ii({objectMode:!0}),n=c=>{c!=null?this.abort():this.clear(),t.end(c)},i=c=>{c.detail!=null&&t.push(c.detail)},s=c=>{n(c.detail.error)},o=()=>{n()},a=()=>{n(new ys("Queue aborted"))};this.addEventListener("completed",i),this.addEventListener("failure",s),this.addEventListener("idle",o),e?.signal?.addEventListener("abort",a);try{yield*t}finally{this.removeEventListener("completed",i),this.removeEventListener("failure",s),this.removeEventListener("idle",o),e?.signal?.removeEventListener("abort",a),n()}}};const h_=Math.pow(2,20)*4;class fg extends Qe{status;timeline;inactivityTimeout;maxReadBufferLength;maxWriteBufferLength;log;direction;maxMessageSize;readStatus;writeStatus;remoteReadStatus;remoteWriteStatus;writableNeedsDrain;readBuffer;writeBuffer;sendingData;onDrainPromise;constructor(e){super(),this.status="open",this.log=e.log,this.direction=e.direction??"outbound",this.inactivityTimeout=e.inactivityTimeout??12e4,this.maxReadBufferLength=e.maxReadBufferLength??h_,this.maxWriteBufferLength=e.maxWriteBufferLength,this.maxMessageSize=e.maxMessageSize,this.readBuffer=new me,this.writeBuffer=new me,this.readStatus="readable",this.remoteReadStatus="readable",this.writeStatus="writable",this.remoteWriteStatus="writable",this.sendingData=!1,this.writableNeedsDrain=!1,this.timeline={open:Date.now()},this.processSendQueue=this.processSendQueue.bind(this);const t=()=>{this.writableNeedsDrain&&(this.log.trace("drain event received, continue sending data"),this.writableNeedsDrain=!1,this.processSendQueue()),this.onDrainPromise?.resolve()};this.addEventListener("drain",t);const n=i=>{this.onDrainPromise?.reject(i.error??new a_)};this.addEventListener("close",n)}get readBufferLength(){return this.readBuffer.byteLength}get writeBufferLength(){return this.writeBuffer.byteLength}async onDrain(e){return this.writableNeedsDrain!==!0?Promise.resolve():(this.onDrainPromise==null&&(this.onDrainPromise=Promise.withResolvers()),Yt(this.onDrainPromise.promise,e?.signal))}async*[Symbol.asyncIterator](){if(this.readStatus!=="readable"&&this.readStatus!=="paused")return;const e=ii(),t=s=>{e.push(s.data)};this.addEventListener("message",t);const n=s=>{e.end(s.error)};this.addEventListener("close",n);const i=()=>{e.end()};this.addEventListener("remoteCloseWrite",i);try{yield*e}finally{this.removeEventListener("message",t),this.removeEventListener("close",n),this.removeEventListener("remoteCloseWrite",i)}}isReadable(){return this.status==="open"}send(e){if(this.writeStatus==="closed"||this.writeStatus==="closing")throw new co(`Cannot write to a stream that is ${this.writeStatus}`);return this.log.trace("append %d bytes to write buffer",e.byteLength),this.writeBuffer.append(e),this.processSendQueue()}abort(e){if(!(this.status==="aborted"||this.status==="reset"||this.status==="closed")){this.log.error("abort with error - %e",e),this.status="aborted",this.readBuffer.byteLength>0&&this.readBuffer.consume(this.readBuffer.byteLength),this.writeBuffer.byteLength>0&&(this.writeBuffer.consume(this.writeBuffer.byteLength),this.safeDispatchEvent("idle")),this.writeStatus="closed",this.remoteWriteStatus="closed",this.readStatus="closed",this.remoteReadStatus="closed",this.timeline.close=Date.now();try{this.sendReset(e)}catch(t){this.log("failed to send reset to remote - %e",t)}this.dispatchEvent(new xS(e))}}pause(){if(this.readStatus==="closed"||this.readStatus==="closing")throw new co("Cannot pause a stream that is closing/closed");this.readStatus!=="paused"&&(this.readStatus="paused",this.sendPause())}resume(){if(this.readStatus==="closed"||this.readStatus==="closing")throw new co("Cannot resume a stream that is closing/closed");this.readStatus!=="readable"&&(this.readStatus="readable",this.dispatchReadBuffer(),this.sendResume())}push(e){if(this.readStatus==="closed"||this.readStatus==="closing")throw new co(`Cannot push data onto a stream that is ${this.readStatus}`);if(e.byteLength!==0){if(this.readBuffer.append(e),this.readStatus==="paused"||this.listenerCount("message")===0){this.checkReadBufferLength();return}setTimeout(()=>{this.dispatchReadBuffer()},0)}}unshift(e){if(this.readStatus==="closed"||this.readStatus==="closing")throw new co(`Cannot push data onto a stream that is ${this.readStatus}`);if(e.byteLength!==0){if(this.readBuffer.prepend(e),this.readStatus==="paused"||this.listenerCount("message")===0){this.checkReadBufferLength();return}setTimeout(()=>{this.dispatchReadBuffer()},0)}}onData(e){if(e.byteLength!==0){if(this.readStatus==="closing"||this.readStatus==="closed"){this.log("ignoring data - read status %s",this.readStatus);return}this.readBuffer.append(e),this.dispatchReadBuffer()}}addEventListener(...e){super.addEventListener.apply(this,e),e[0]==="message"&&this.readBuffer.byteLength>0&&queueMicrotask(()=>{this.dispatchReadBuffer()})}onRemoteReset(){this.log("remote reset"),this.status="reset",this.writeStatus="closed",this.remoteWriteStatus="closed",this.remoteReadStatus="closed",this.timeline.close=Date.now(),this.readBuffer.byteLength===0&&(this.readStatus="closed");const e=new n8;this.dispatchEvent(new AS(e))}onTransportClosed(e){this.log("transport closed"),this.readStatus==="readable"&&this.readBuffer.byteLength===0&&(this.log("close readable end after transport closed and read buffer is empty"),this.readStatus="closed"),this.remoteReadStatus!=="closed"&&(this.remoteReadStatus="closed"),this.remoteWriteStatus!=="closed"&&(this.remoteWriteStatus="closed"),this.writeStatus!=="closed"&&(this.writeStatus="closed"),e!=null?this.abort(e):(this.status==="open"||this.status==="closing")&&(this.timeline.close=Date.now(),this.status="closed",this.writeStatus="closed",this.remoteWriteStatus="closed",this.remoteReadStatus="closed",this.dispatchEvent(new Oh))}onRemoteCloseWrite(){this.remoteWriteStatus!=="closed"&&(this.log.trace("on remote close write"),this.remoteWriteStatus="closed",this.safeDispatchEvent("remoteCloseWrite"),this.writeStatus==="closed"&&this.onTransportClosed())}onRemoteCloseRead(){this.log.trace("on remote close read"),this.remoteReadStatus="closed",this.writeBuffer.byteLength>0&&(this.writeBuffer.consume(this.writeBuffer.byteLength),this.safeDispatchEvent("idle"))}processSendQueue(){if(this.writableNeedsDrain)return this.log.trace("not processing send queue as drain is required"),this.checkWriteBufferLength(),!1;if(this.writeBuffer.byteLength===0)return this.log.trace("not processing send queue as no bytes to send"),!0;if(this.sendingData)return this.log.trace("not processing send queue as already sending data"),!0;this.sendingData=!0,this.log.trace("processing send queue with %d queued bytes",this.writeBuffer.byteLength);try{let e=!0;const t=this.writeBuffer.byteLength;let n=0;for(;this.writeBuffer.byteLength>0;){const i=Math.min(this.maxMessageSize??this.writeBuffer.byteLength,this.writeBuffer.byteLength);if(i===0){e=!1;break}const s=this.writeBuffer.sublist(0,i),o=new me(s);this.writeBuffer.consume(s.byteLength);const a=this.sendData(s);if(e=a.canSendMore,n+=a.sentBytes,a.sentBytes!==o.byteLength&&(o.consume(a.sentBytes),this.writeBuffer.prepend(o)),!e)break}return e||(this.log.trace("sent %d/%d bytes, pausing sending because underlying stream is full, %d bytes left in the write buffer",n,t,this.writeBuffer.byteLength),this.writableNeedsDrain=!0,this.checkWriteBufferLength()),this.writeBuffer.byteLength===0&&this.safeDispatchEvent("idle"),e}finally{this.sendingData=!1}}dispatchReadBuffer(){try{if(this.listenerCount("message")===0){this.log.trace("not dispatching pause buffer as there are no listeners for the message event");return}if(this.readBuffer.byteLength===0){this.log.trace("not dispatching pause buffer as there is no data to dispatch");return}if(this.readStatus==="paused"){this.log.trace("not dispatching pause buffer we are paused");return}if(this.readStatus==="closing"||this.readStatus==="closed"){this.log("dropping %d bytes because the readable end is %s",this.readBuffer.byteLength,this.readStatus),this.readBuffer.consume(this.readBuffer.byteLength);return}const e=this.readBuffer.sublist();this.readBuffer.consume(e.byteLength),this.dispatchEvent(new SS(e))}finally{this.readBuffer.byteLength===0&&this.remoteWriteStatus==="closed"&&(this.log("close readable end after dispatching read buffer and remote writable end is closed"),this.readStatus="closed"),this.checkReadBufferLength()}}checkReadBufferLength(){this.readBuffer.byteLength>this.maxReadBufferLength&&this.abort(new g4(`Read buffer length of ${this.readBuffer.byteLength} exceeded limit of ${this.maxReadBufferLength}, read status is ${this.readStatus}`))}checkWriteBufferLength(){this.maxWriteBufferLength!=null&&this.writeBuffer.byteLength>this.maxWriteBufferLength&&this.abort(new g4(`Write buffer length of ${this.writeBuffer.byteLength} exceeded limit of ${this.maxWriteBufferLength}, write status is ${this.writeStatus}`))}onMuxerNeedsDrain(){this.writableNeedsDrain=!0}onMuxerDrain(){this.safeDispatchEvent("drain")}}class pg extends fg{remoteAddr;metricPrefix;metrics;constructor(e){super(e),this.metricPrefix=e.metricPrefix??"",this.metrics=e.metrics,this.remoteAddr=e.remoteAddr,this.addEventListener("close",t=>{this.metrics?.increment({[`${this.metricPrefix}end`]:!0}),t.error!=null?t.local?this.metrics?.increment({[`${this.metricPrefix}abort`]:!0}):this.metrics?.increment({[`${this.metricPrefix}reset`]:!0}):t.local?this.metrics?.increment({[`${this.metricPrefix}_local_close`]:!0}):this.metrics?.increment({[`${this.metricPrefix}_remote_close`]:!0})})}async close(e){this.status==="open"&&(this.status="closing",this.writeStatus="closing",this.remoteWriteStatus="closing",this.remoteReadStatus="closing",(this.sendingData||this.writeBuffer.byteLength>0)&&(this.log("waiting for write queue to become idle before closing writable end of stream, %d unsent bytes",this.writeBuffer.byteLength),await bt(this,"idle",{...e,rejectionEvents:["close"]})),this.writableNeedsDrain&&(this.log("waiting for write queue to drain before closing writable end of stream, %d unsent bytes",this.writeBuffer.byteLength),await bt(this,"drain",{...e,rejectionEvents:["close"]})),await this.sendClose(e),this.onTransportClosed())}}function L7(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}class gg extends Qe{streams;protocol;status;log;maConn;streamOptions;earlyStreams;maxEarlyStreams;metrics;constructor(e,t){super(),this.maConn=e,this.protocol=t.protocol,this.streams=[],this.earlyStreams=[],this.status="open",this.log=e.log.newScope(t.name),this.streamOptions=t.streamOptions,this.maxEarlyStreams=t.maxEarlyStreams??10,this.metrics=t.metrics;const n=o=>{try{this.onData(o.data)}catch(a){this.abort(a),this.maConn.abort(a)}};this.maConn.addEventListener("message",n);const i=()=>{this.log("underlying stream drained, signal %d streams to continue writing",this.streams.length),this.streams.forEach(o=>{o.onMuxerDrain()})};this.maConn.addEventListener("drain",i);const s=()=>{this.log("underlying stream closed with status %s and %d streams",this.status,this.streams.length),this.onTransportClosed()};this.maConn.addEventListener("close",s)}send(e){const t=this.maConn.send(e);return t===!1&&(this.log("underlying stream saturated, signal %d streams to pause writing",this.streams.length),this.streams.forEach(n=>{n.onMuxerNeedsDrain()})),t}async close(e){this.status==="closed"||this.status==="closing"||(this.status="closing",await Yt(Promise.all([...this.streams].map(async t=>{await t.close(e)})),e?.signal),this.status="closed")}abort(e){this.status!=="closed"&&(this.status="closing",[...this.streams].forEach(t=>{t.abort(e)}),this.status="closed")}onTransportClosed(e){this.status="closing";try{[...this.streams].forEach(t=>{t.onTransportClosed(e)})}catch(t){this.abort(t)}this.status="closed"}async createStream(e){if(this.status!=="open")throw new fo;let t=this.onCreateStream({...this.streamOptions,...e});return L7(t)&&(t=await t),this.streams.push(t),this.cleanUpStream(t),t}onRemoteStream(e){if(this.streams.push(e),this.cleanUpStream(e),this.listenerCount("stream")===0){this.earlyStreams.push(e),this.earlyStreams.length>this.maxEarlyStreams&&this.abort(new o_(`Too many early streams were opened - ${this.earlyStreams.length}/${this.maxEarlyStreams}`));return}this.safeDispatchEvent("stream",{detail:e})}cleanUpStream(e){const t=n=>{const i=this.streams.findIndex(s=>s===e);i!==-1&&this.streams.splice(i,1),n.error!=null?n.local?this.metrics?.increment({[`${e.direction}_stream_reset`]:!0}):this.metrics?.increment({[`${e.direction}_stream_abort`]:!0}):this.metrics?.increment({[`${e.direction}_stream_end`]:!0})};e.addEventListener("close",t),this.metrics?.increment({[`${e.direction}_stream`]:!0})}addEventListener(...e){super.addEventListener.apply(this,e),e[0]==="stream"&&this.earlyStreams.length>0&&queueMicrotask(()=>{this.earlyStreams.forEach(t=>{this.safeDispatchEvent("stream",{detail:t})}),this.earlyStreams=[]})}}class mg extends fg{id;protocol;constructor(e){super(e),this.id=e.id,this.protocol=e.protocol??""}async close(e){this.writeStatus==="closing"||this.writeStatus==="closed"||(this.writeStatus="closing",(this.sendingData||this.writeBuffer.byteLength>0)&&(this.log("waiting for write queue to become idle before closing writable end of stream, %d unsent bytes",this.writeBuffer.byteLength),await bt(this,"idle",{...e,rejectionEvents:["close"]})),this.writableNeedsDrain&&(this.log("waiting for write queue to drain before closing writable end of stream, %d unsent bytes, sending %s",this.writeBuffer.byteLength,this.sendingData),await bt(this,"drain",{...e,rejectionEvents:["close"]}),this.log("write queue drained, closing writable end of stream, %d unsent bytes, sending %s",this.writeBuffer.byteLength,this.sendingData)),await this.sendCloseWrite(e),this.writeStatus="closed",this.log("closed writable end gracefully"),this.remoteWriteStatus==="closed"&&this.onTransportClosed())}async closeRead(e){this.readStatus==="closing"||this.readStatus==="closed"||(this.readBuffer.byteLength>0&&this.readBuffer.consume(this.readBuffer.byteLength),this.readStatus="closing",await this.sendCloseRead(e),this.readStatus="closed",this.log("closed readable end gracefully"))}}function Ke(r){const e=new globalThis.AbortController;function t(){e.abort();for(const s of r)s?.removeEventListener!=null&&s.removeEventListener("abort",t)}for(const s of r){if(s?.aborted===!0){t();break}s?.addEventListener!=null&&s.addEventListener("abort",t)}function n(){for(const s of r)s?.removeEventListener!=null&&s.removeEventListener("abort",t)}const i=e.signal;return i.clear=n,i}class x1{movingAverage;variance;deviation;forecast;timeSpan;previousTime;constructor(e){this.timeSpan=e,this.movingAverage=0,this.variance=0,this.deviation=0,this.forecast=0}alpha(e,t){return 1-Math.exp(-(e-t)/this.timeSpan)}push(e,t=Date.now()){if(this.previousTime!=null){const n=this.alpha(t,this.previousTime),i=e-this.movingAverage,s=n*i;this.movingAverage=n*e+(1-n)*this.movingAverage,this.variance=(1-n)*(this.variance+i*s),this.deviation=Math.sqrt(this.variance),this.forecast=this.movingAverage+n*i}else this.movingAverage=e;this.previousTime=t}}const f_=1.2,p_=2,g_=5e3,m_=6e4,y_=5e3;class zc{success;failure;next;metric;timeoutMultiplier;failureMultiplier;minTimeout;maxTimeout;constructor(e={}){const t=e.interval??y_;this.success=new x1(t),this.failure=new x1(t),this.next=new x1(t),this.failureMultiplier=e.failureMultiplier??p_,this.timeoutMultiplier=e.timeoutMultiplier??f_,this.minTimeout=e.minTimeout??g_,this.maxTimeout=e.maxTimeout??m_,e.metricName!=null&&(this.metric=e.metrics?.registerMetricGroup(e.metricName))}getTimeoutSignal(e={}){let t=Math.round(this.next.movingAverage*(e.timeoutFactor??this.timeoutMultiplier));t<this.minTimeout&&(t=this.minTimeout),t>this.maxTimeout&&(t=this.maxTimeout);const n=AbortSignal.timeout(t),i=Ke([e.signal,n]);return i.start=Date.now(),i.timeout=t,i}cleanUp(e){const t=Date.now()-e.start;e.aborted?(this.failure.push(t),this.next.push(t*this.failureMultiplier),this.metric?.update({failureMovingAverage:this.failure.movingAverage,failureDeviation:this.failure.deviation,failureForecast:this.failure.forecast,failureVariance:this.failure.variance,failure:t})):(this.success.push(t),this.next.push(t),this.metric?.update({successMovingAverage:this.success.movingAverage,successDeviation:this.success.deviation,successForecast:this.success.forecast,successVariance:this.success.variance,success:t}))}}class Nr extends Error{static name="InvalidMultiaddrError";name="InvalidMultiaddrError"}class Hc extends Error{static name="ValidationError";name="ValidationError"}let w_=class extends Error{static name="InvalidParametersError";name="InvalidParametersError"};class b_ extends Error{static name="UnknownProtocolError";name="UnknownProtocolError"}const fd=4,fs=6,O7=273,v_=33,xs=41,yg=42,wg=43,bg=53,vg=54,Eg=55,Sg=56,E_=132,S_=301,x_=302,M7=400,ge=421,A_=444,k_=445,C_=446,I_=447,ps=448,pd=449,__=454,$7=460,U7=461,F7=465,$o=466,Ao=480,T_=481,T0=443,xg=477,V7=478,P_=479,R_=277,N_=275,D_=276,z7=280,mc=281,da=290,H7=777;function sm(r){return e=>Y(e,r)}function om(r){return e=>W(e,r)}function ja(r){return new DataView(r.buffer).getUint16(r.byteOffset).toString()}function po(r){const e=new ArrayBuffer(2);return new DataView(e).setUint16(0,typeof r=="string"?parseInt(r):r),new Uint8Array(e)}function B_(r){const e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==16)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion address.`);const t=W(e[0],"base32"),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");const i=po(n);return Ot([t,i],t.length+i.length)}function L_(r){const e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==56)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion3 address.`);const t=vr.decode(`b${e[0]}`),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");const i=po(n);return Ot([t,i],t.length+i.length)}function am(r){const e=r.subarray(0,r.length-2),t=r.subarray(r.length-2),n=Y(e,"base32"),i=ja(t);return`${n}:${i}`}const q7=function(r){r=r.toString().trim();const e=new Uint8Array(4);return r.split(/\./g).forEach((t,n)=>{const i=parseInt(t,10);if(isNaN(i)||i<0||i>255)throw new Nr("Invalid byte value in IP address");e[n]=i}),e},O_=function(r){let e=0;r=r.toString().trim();const t=r.split(":",8);let n;for(n=0;n<t.length;n++){const s=Mo(t[n]);let o;s&&(o=q7(t[n]),t[n]=Y(o.subarray(0,2),"base16")),o!=null&&++n<8&&t.splice(n,0,Y(o.subarray(2,4),"base16"))}if(t[0]==="")for(;t.length<8;)t.unshift("0");else if(t[t.length-1]==="")for(;t.length<8;)t.push("0");else if(t.length<8){for(n=0;n<t.length&&t[n]!=="";n++);const s=[n,1];for(n=9-t.length;n>0;n--)s.push("0");t.splice.apply(t,s)}const i=new Uint8Array(e+16);for(n=0;n<t.length;n++){t[n]===""&&(t[n]="0");const s=parseInt(t[n],16);if(isNaN(s)||s<0||s>65535)throw new Nr("Invalid byte value in IP address");i[e++]=s>>8&255,i[e++]=s&255}return i},M_=function(r){if(r.byteLength!==4)throw new Nr("IPv4 address was incorrect length");const e=[];for(let t=0;t<r.byteLength;t++)e.push(r[t]);return e.join(".")},$_=function(r){if(r.byteLength!==16)throw new Nr("IPv6 address was incorrect length");const e=[];for(let n=0;n<r.byteLength;n+=2){const i=r[n],s=r[n+1],o=`${i.toString(16).padStart(2,"0")}${s.toString(16).padStart(2,"0")}`;e.push(o)}const t=e.join(":");try{const n=new URL(`http://[${t}]`);return n.hostname.substring(1,n.hostname.length-1)}catch{throw new Nr(`Invalid IPv6 address "${t}"`)}};function U_(r){try{const e=new URL(`http://[${r}]`);return e.hostname.substring(1,e.hostname.length-1)}catch{throw new Nr(`Invalid IPv6 address "${r}"`)}}const A1=Object.values(rd).map(r=>r.decoder),F_=(function(){let r=A1[0].or(A1[1]);return A1.slice(2).forEach(e=>r=r.or(e)),r})();function V_(r){return F_.decode(r)}function z_(r){return e=>r.encoder.encode(e)}function H_(r){if(parseInt(r).toString()!==r)throw new Hc("Value must be an integer")}function q_(r){if(r<0)throw new Hc("Value must be a positive integer, or zero")}function K_(r){return e=>{if(e>r)throw new Hc(`Value must be smaller than or equal to ${r}`)}}function W_(...r){return e=>{for(const t of r)t(e)}}const ou=W_(H_,q_,K_(65535)),Ht=-1;let j_=class{protocolsByCode=new Map;protocolsByName=new Map;getProtocol(e){let t;if(typeof e=="string"?t=this.protocolsByName.get(e):t=this.protocolsByCode.get(e),t==null)throw new b_(`Protocol ${e} was unknown`);return t}addProtocol(e){this.protocolsByCode.set(e.code,e),this.protocolsByName.set(e.name,e),e.aliases?.forEach(t=>{this.protocolsByName.set(t,e)})}removeProtocol(e){const t=this.protocolsByCode.get(e);t!=null&&(this.protocolsByCode.delete(t.code),this.protocolsByName.delete(t.name),t.aliases?.forEach(n=>{this.protocolsByName.delete(n)}))}};const ha=new j_,G_=[{code:fd,name:"ip4",size:32,valueToBytes:q7,bytesToValue:M_,validate:r=>{if(!Mo(r))throw new Hc(`Invalid IPv4 address "${r}"`)}},{code:fs,name:"tcp",size:16,valueToBytes:po,bytesToValue:ja,validate:ou},{code:O7,name:"udp",size:16,valueToBytes:po,bytesToValue:ja,validate:ou},{code:v_,name:"dccp",size:16,valueToBytes:po,bytesToValue:ja,validate:ou},{code:xs,name:"ip6",size:128,valueToBytes:O_,bytesToValue:$_,stringToValue:U_,validate:r=>{if(!B7(r))throw new Hc(`Invalid IPv6 address "${r}"`)}},{code:yg,name:"ip6zone",size:Ht},{code:wg,name:"ipcidr",size:8,bytesToValue:sm("base10"),valueToBytes:om("base10")},{code:bg,name:"dns",size:Ht},{code:vg,name:"dns4",size:Ht},{code:Eg,name:"dns6",size:Ht},{code:Sg,name:"dnsaddr",size:Ht},{code:E_,name:"sctp",size:16,valueToBytes:po,bytesToValue:ja,validate:ou},{code:S_,name:"udt"},{code:x_,name:"utp"},{code:M7,name:"unix",size:Ht,stringToValue:r=>decodeURIComponent(r),valueToString:r=>encodeURIComponent(r)},{code:ge,name:"p2p",aliases:["ipfs"],size:Ht,bytesToValue:sm("base58btc"),valueToBytes:r=>r.startsWith("Q")||r.startsWith("1")?om("base58btc")(r):ae.parse(r).multihash.bytes},{code:A_,name:"onion",size:96,bytesToValue:am,valueToBytes:B_},{code:k_,name:"onion3",size:296,bytesToValue:am,valueToBytes:L_},{code:C_,name:"garlic64",size:Ht},{code:I_,name:"garlic32",size:Ht},{code:ps,name:"tls"},{code:pd,name:"sni",size:Ht},{code:__,name:"noise"},{code:$7,name:"quic"},{code:U7,name:"quic-v1"},{code:F7,name:"webtransport"},{code:$o,name:"certhash",size:Ht,bytesToValue:z_(Fh),valueToBytes:V_},{code:Ao,name:"http"},{code:T_,name:"http-path",size:Ht,stringToValue:r=>`/${decodeURIComponent(r)}`,valueToString:r=>encodeURIComponent(r.substring(1))},{code:T0,name:"https"},{code:xg,name:"ws"},{code:V7,name:"wss"},{code:P_,name:"p2p-websocket-star"},{code:R_,name:"p2p-stardust"},{code:N_,name:"p2p-webrtc-star"},{code:D_,name:"p2p-webrtc-direct"},{code:z7,name:"webrtc-direct"},{code:mc,name:"webrtc"},{code:da,name:"p2p-circuit"},{code:H7,name:"memory",size:Ht}];G_.forEach(r=>{ha.addProtocol(r)});function Y_(r){const e=[];let t=0;for(;t<r.length;){const n=Vs(r,t),i=ha.getProtocol(n),s=et(n),o=J_(i,r,t+s);let a=0;o>0&&i.size===Ht&&(a=et(o));const c=s+a+o,l={code:n,name:i.name,bytes:r.subarray(t,t+c)};if(o>0){const u=t+s+a,d=r.subarray(u,u+o);l.value=i.bytesToValue?.(d)??Y(d)}e.push(l),t+=c}return e}function Q_(r){let e=0;const t=[];for(const n of r){if(n.bytes==null){const i=ha.getProtocol(n.code),s=et(n.code);let o,a=0,c=0;n.value!=null&&(o=i.valueToBytes?.(n.value)??W(n.value),a=o.byteLength,i.size===Ht&&(c=et(a)));const l=new Uint8Array(s+c+a);let u=0;cd(n.code,l,u),u+=s,o!=null&&(i.size===Ht&&(cd(a,l,u),u+=c),l.set(o,u)),n.bytes=l}t.push(n.bytes),e+=n.bytes.byteLength}return Ot(t,e)}function X_(r){if(r.charAt(0)!=="/")throw new Nr('String multiaddr must start with "/"');const e=[];let t="protocol",n="",i="";for(let s=1;s<r.length;s++){const o=r.charAt(s);o!=="/"&&(t==="protocol"?i+=r.charAt(s):n+=r.charAt(s));const a=s===r.length-1;if(o==="/"||a){const c=ha.getProtocol(i);if(t==="protocol"){if(c.size==null||c.size===0){e.push({code:c.code,name:c.name}),n="",i="",t="protocol";continue}else if(a)throw new Nr(`Component ${i} was missing value`);t="value"}else if(t==="value"){const l={code:c.code,name:c.name};if(c.size!=null&&c.size!==0){if(n==="")throw new Nr(`Component ${i} was missing value`);l.value=c.stringToValue?.(n)??n}e.push(l),n="",i="",t="protocol"}}}if(i!==""&&n!=="")throw new Nr("Incomplete multiaddr");return e}function Z_(r){return`/${r.flatMap(e=>{if(e.value==null)return e.name;const t=ha.getProtocol(e.code);if(t==null)throw new Nr(`Unknown protocol code ${e.code}`);return[e.name,t.valueToString?.(e.value)??e.value]}).join("/")}`}function J_(r,e,t){return r.size==null||r.size===0?0:r.size>0?r.size/8:Vs(e,t)}const eT=Symbol.for("nodejs.util.inspect.custom"),K7=Symbol.for("@multiformats/multiaddr");function tT(r){if(r==null&&(r="/"),Sl(r))return r.getComponents();if(r instanceof Uint8Array)return Y_(r);if(typeof r=="string")return r=r.replace(/\/(\/)+/,"/").replace(/(\/)+$/,""),r===""&&(r="/"),X_(r);if(Array.isArray(r))return r;throw new Nr("Must be a string, Uint8Array, Component[], or another Multiaddr")}class go{[K7]=!0;#e;#t;#r;constructor(e="/",t={}){this.#e=tT(e),t.validate!==!1&&rT(this)}get bytes(){return this.#r==null&&(this.#r=Q_(this.#e)),this.#r}toString(){return this.#t==null&&(this.#t=Z_(this.#e)),this.#t}toJSON(){return this.toString()}getComponents(){return[...this.#e.map(e=>({...e}))]}encapsulate(e){const t=new go(e);return new go([...this.#e,...t.getComponents()],{validate:!1})}decapsulate(e){const t=e.toString(),n=this.toString(),i=n.lastIndexOf(t);if(i<0)throw new w_(`Address ${this.toString()} does not contain subaddress: ${t}`);return new go(n.slice(0,i),{validate:!1})}decapsulateCode(e){let t;for(let n=this.#e.length-1;n>-1;n--)if(this.#e[n].code===e){t=n;break}return new go(this.#e.slice(0,t),{validate:!1})}equals(e){return Te(this.bytes,e.bytes)}[eT](){return`Multiaddr(${this.toString()})`}}function rT(r){r.getComponents().forEach(e=>{const t=ha.getProtocol(e.code);e.value!=null&&t.validate?.(e.value)})}function Sl(r){return!!r?.[K7]}function be(r){return new go(r)}class nT{readNext;haveNext;ended;nextResult;error;constructor(){this.ended=!1,this.readNext=Ze(),this.haveNext=Ze()}[Symbol.asyncIterator](){return this}async next(){if(this.nextResult==null&&await this.haveNext.promise,this.nextResult==null)throw new Error("HaveNext promise resolved but nextResult was undefined");const e=this.nextResult;return this.nextResult=void 0,this.readNext.resolve(),this.readNext=Ze(),e}async throw(e){return this.ended=!0,this.error=e,e!=null&&(this.haveNext.promise.catch(()=>{}),this.haveNext.reject(e)),{done:!0,value:void 0}}async return(){const e={done:!0,value:void 0};return this.ended=!0,this.nextResult=e,this.haveNext.resolve(),e}async push(e,t){await this._push(e,t)}async end(e,t){e!=null?await this.throw(e):await this._push(void 0,t)}async _push(e,t){if(e!=null&&this.ended)throw this.error??new Error("Cannot push value onto an ended pushable");for(;this.nextResult!=null;)await this.readNext.promise;e!=null?this.nextResult={done:!1,value:e}:(this.ended=!0,this.nextResult={done:!0,value:void 0}),this.haveNext.resolve(),this.haveNext=Ze(),await Yt(this.readNext.promise,t?.signal,t)}}function iT(){return new nT}function sT(r){return r[Symbol.asyncIterator]!=null}async function oT(r,e,t){try{await Promise.all(r.map(async n=>{for await(const i of n)await e.push(i,{signal:t}),t.throwIfAborted()})),await e.end(void 0,{signal:t})}catch(n){await e.end(n,{signal:t}).catch(()=>{})}}async function*aT(r){const e=new AbortController,t=iT();oT(r,t,e.signal).catch(()=>{});try{yield*t}finally{e.abort()}}function*cT(r){for(const e of r)yield*e}function Pi(...r){const e=[];for(const t of r)sT(t)||e.push(t);return e.length===r.length?cT(e):aT(r)}function zs(r,...e){if(r==null)throw new Error("Empty pipeline");if(k1(r)){const n=r;r=()=>n.source}else if(j7(r)||W7(r)){const n=r;r=()=>n}const t=[r,...e];if(t.length>1&&k1(t[t.length-1])&&(t[t.length-1]=t[t.length-1].sink),t.length>2)for(let n=1;n<t.length-1;n++)k1(t[n])&&(t[n]=uT(t[n]));return lT(...t)}const lT=(...r)=>{let e;for(;r.length>0;)e=r.shift()(e);return e},W7=r=>r?.[Symbol.asyncIterator]!=null,j7=r=>r?.[Symbol.iterator]!=null,k1=r=>r==null?!1:r.sink!=null&&r.source!=null,uT=r=>e=>{const t=r.sink(e);if(t?.then!=null){const n=ii({objectMode:!0});t.then(()=>{n.end()},o=>{n.end(o)});let i;const s=r.source;if(W7(s))i=async function*(){yield*s,n.end()};else if(j7(s))i=function*(){yield*s,n.end()};else throw new Error("Unknown duplex source type - must be Iterable or AsyncIterable");return Pi(n,i())}return r.source},dT=4194304;class cm extends Error{static name="UnwrappedError";name="UnwrappedError"}let G7=class extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MSG_LENGTH"},hT=class extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"},fT=class extends Error{name="InvalidDataLengthLengthError";code="ERR_MSG_LENGTH_TOO_LONG"};function pT(r){return typeof r?.closeRead=="function"}function gT(r){return typeof r?.close=="function"}function C1(r){return pT(r)?r.remoteWriteStatus!=="writable"&&r.readBufferLength===0:gT(r)?r.status!=="open":!1}function mT(r){return r?.addEventListener!=null&&r?.removeEventListener!=null&&r?.send!=null&&r?.push!=null&&r?.log!=null}function Y7(r,e){const t=e?.maxBufferSize??dT,n=new me;let i,s=!1;if(!mT(r))throw new H("Argument should be a Stream or a Multiaddr");const o=u=>{if(n.append(u.data),n.byteLength>t){const d=n.byteLength;n.consume(n.byteLength),i?.reject(new Error(`Read buffer overflow - ${d} > ${t}`))}i?.resolve()};r.addEventListener("message",o);const a=u=>{u.error!=null?i?.reject(u.error):i?.resolve()};r.addEventListener("close",a);const c=()=>{i?.resolve()};r.addEventListener("remoteCloseWrite",c);const l={readBuffer:n,async read(u){if(s===!0)throw new cm("Stream was unwrapped");if(C1(r)){if(u?.bytes==null)return null;if(n.byteLength<u.bytes)throw r.log.error("closed after reading %d/%d bytes",n.byteLength,u.bytes),new hd(`Unexpected EOF - stream closed after reading ${n.byteLength}/${u.bytes} bytes`)}const d=u?.bytes??1;for(i=Promise.withResolvers();;){if(n.byteLength>=d){i.resolve();break}if(await Yt(i.promise,u?.signal),C1(r)){if(n.byteLength===0&&u?.bytes==null)return null;break}i=Promise.withResolvers()}const h=u?.bytes??n.byteLength;if(n.byteLength<h){if(C1(r))throw r.log.error("closed while reading %d/%d bytes",n.byteLength,h),new hd(`Unexpected EOF - stream closed while reading ${n.byteLength}/${h} bytes`);return l.read(u)}const f=n.sublist(0,h);return n.consume(h),f},async write(u,d){if(s===!0)throw new cm("Stream was unwrapped");r.send(u)||await bt(r,"drain",{signal:d?.signal,rejectionEvents:["close"]})},unwrap(){return s||(s=!0,r.removeEventListener("message",o),r.removeEventListener("close",a),r.removeEventListener("remoteCloseWrite",c),n.byteLength>0&&(r.log("stream unwrapped with %d unread bytes",n.byteLength),r.push(n))),r}};return l}function qc(r,e={}){const t=Y7(r,e);e.maxDataLength!=null&&e.maxLengthLength==null&&(e.maxLengthLength=et(e.maxDataLength));const n=e?.lengthDecoder??Vs,i=e?.lengthEncoder??vn;return{async read(o){let a=-1;const c=new me;for(;;){const u=await t.read({...o,bytes:1});if(u==null)break;c.append(u);try{a=n(c)}catch(d){if(d instanceof RangeError)continue;throw d}if(a<0)throw new G7("Invalid message length");if(e?.maxLengthLength!=null&&c.byteLength>e.maxLengthLength)throw new fT(`Message length length too long - ${c.byteLength} > ${e.maxLengthLength}`);if(a>-1)break}if(e?.maxDataLength!=null&&a>e.maxDataLength)throw new hT(`Message length too long - ${a} > ${e.maxDataLength}`);const l=await t.read({...o,bytes:a});if(l==null)throw r.log.error("tried to read %d bytes but the stream closed",a),new hd(`Unexpected EOF - tried to read ${a} bytes but the stream closed`);if(l.byteLength!==a)throw r.log.error("read %d/%d bytes before the stream closed",l.byteLength,a),new hd(`Unexpected EOF - read ${l.byteLength}/${a} bytes before the stream closed`);return l},async write(o,a){await t.write(new me(i(o.byteLength),o),a)},async writeV(o,a){const c=new me(...o.flatMap(l=>[i(l.byteLength),l]));await t.write(c,a)},unwrap(){return t.unwrap()}}}function Qt(r,e){const t=qc(r,e),n={read:async(i,s)=>{const o=await t.read(s);return i.decode(o)},write:async(i,s,o)=>{await t.write(s.encode(i),o)},writeV:async(i,s,o)=>{await t.writeV(i.map(a=>s.encode(a)),o)},pb:i=>({read:async s=>n.read(i,s),write:async(s,o)=>n.write(s,i,o),writeV:async(s,o)=>n.writeV(s,i,o),unwrap:()=>n}),unwrap:()=>t.unwrap()};return n}const yT=1024*1024*4,wT=1024*1024*4;class bT{buffer;maxBufferSize;lengthDecoder;maxDataLength;encodingLength;constructor(e={}){this.buffer=new me,this.maxBufferSize=e.maxBufferSize??yT,this.maxDataLength=e.maxDataLength??wT,this.lengthDecoder=e.lengthDecoder??Vs,this.encodingLength=e.encodingLength??et}*decode(e){if(this.buffer.append(e),this.buffer.byteLength>this.maxBufferSize)throw new H(`Buffer length limit exceeded - ${this.buffer.byteLength}/${this.maxBufferSize}`);for(;;){let t;try{t=this.lengthDecoder(this.buffer)}catch(s){if(s instanceof RangeError)break;throw s}if(t<0||t>this.maxDataLength)throw new G7("Invalid message length");const n=this.encodingLength(t),i=n+t;if(this.buffer.byteLength>=i){const s=this.buffer.sublist(n,i);this.buffer.consume(i),s.byteLength>0&&(yield s)}else break}}}const vT=["string","number","bigint","symbol"],ET=["Function","Generator","AsyncGenerator","GeneratorFunction","AsyncGeneratorFunction","AsyncFunction","Observable","Array","Buffer","Object","RegExp","Date","Error","Map","Set","WeakMap","WeakSet","ArrayBuffer","SharedArrayBuffer","DataView","Promise","URL","HTMLElement","Int8Array","Uint8Array","Uint8ClampedArray","Int16Array","Uint16Array","Int32Array","Uint32Array","Float32Array","Float64Array","BigInt64Array","BigUint64Array"];function ST(r){if(r===null)return"null";if(r===void 0)return"undefined";if(r===!0||r===!1)return"boolean";const e=typeof r;if(vT.includes(e))return e;if(e==="function")return"Function";if(Array.isArray(r))return"Array";if(xT(r))return"Buffer";const t=AT(r);return t||"Object"}function xT(r){return r&&r.constructor&&r.constructor.isBuffer&&r.constructor.isBuffer.call(null,r)}function AT(r){const e=Object.prototype.toString.call(r).slice(8,-1);if(ET.includes(e))return e}class _{constructor(e,t,n){this.major=e,this.majorEncoded=e<<5,this.name=t,this.terminal=n}toString(){return`Type[${this.major}].${this.name}`}compare(e){return this.major<e.major?-1:this.major>e.major?1:0}}_.uint=new _(0,"uint",!0);_.negint=new _(1,"negint",!0);_.bytes=new _(2,"bytes",!0);_.string=new _(3,"string",!0);_.array=new _(4,"array",!1);_.map=new _(5,"map",!1);_.tag=new _(6,"tag",!1);_.float=new _(7,"float",!0);_.false=new _(7,"false",!0);_.true=new _(7,"true",!0);_.null=new _(7,"null",!0);_.undefined=new _(7,"undefined",!0);_.break=new _(7,"break",!0);class G{constructor(e,t,n){this.type=e,this.value=t,this.encodedLength=n,this.encodedBytes=void 0,this.byteValue=void 0}toString(){return`Token[${this.type}].${this.value}`}}const fa=globalThis.process&&!globalThis.process.browser&&globalThis.Buffer&&typeof globalThis.Buffer.isBuffer=="function",kT=new TextDecoder,CT=new TextEncoder;function gd(r){return fa&&globalThis.Buffer.isBuffer(r)}function Ag(r){return r instanceof Uint8Array?gd(r)?new Uint8Array(r.buffer,r.byteOffset,r.byteLength):r:Uint8Array.from(r)}const IT=fa?(r,e,t)=>t-e>64?globalThis.Buffer.from(r.subarray(e,t)).toString("utf8"):um(r,e,t):(r,e,t)=>t-e>64?kT.decode(r.subarray(e,t)):um(r,e,t),Q7=fa?r=>r.length>64?globalThis.Buffer.from(r):lm(r):r=>r.length>64?CT.encode(r):lm(r),$n=r=>Uint8Array.from(r),kg=fa?(r,e,t)=>gd(r)?new Uint8Array(r.subarray(e,t)):r.slice(e,t):(r,e,t)=>r.slice(e,t),_T=fa?(r,e)=>(r=r.map(t=>t instanceof Uint8Array?t:globalThis.Buffer.from(t)),Ag(globalThis.Buffer.concat(r,e))):(r,e)=>{const t=new Uint8Array(e);let n=0;for(let i of r)n+i.length>t.length&&(i=i.subarray(0,t.length-n)),t.set(i,n),n+=i.length;return t},TT=fa?r=>globalThis.Buffer.allocUnsafe(r):r=>new Uint8Array(r);function PT(r,e){if(gd(r)&&gd(e))return r.compare(e);for(let t=0;t<r.length;t++)if(r[t]!==e[t])return r[t]<e[t]?-1:1;return 0}function lm(r){const e=[];let t=0;for(let n=0;n<r.length;n++){let i=r.charCodeAt(n);i<128?e[t++]=i:i<2048?(e[t++]=i>>6|192,e[t++]=i&63|128):(i&64512)===55296&&n+1<r.length&&(r.charCodeAt(n+1)&64512)===56320?(i=65536+((i&1023)<<10)+(r.charCodeAt(++n)&1023),e[t++]=i>>18|240,e[t++]=i>>12&63|128,e[t++]=i>>6&63|128,e[t++]=i&63|128):(e[t++]=i>>12|224,e[t++]=i>>6&63|128,e[t++]=i&63|128)}return e}function um(r,e,t){const n=[];for(;e<t;){const i=r[e];let s=null,o=i>239?4:i>223?3:i>191?2:1;if(e+o<=t){let a,c,l,u;switch(o){case 1:i<128&&(s=i);break;case 2:a=r[e+1],(a&192)===128&&(u=(i&31)<<6|a&63,u>127&&(s=u));break;case 3:a=r[e+1],c=r[e+2],(a&192)===128&&(c&192)===128&&(u=(i&15)<<12|(a&63)<<6|c&63,u>2047&&(u<55296||u>57343)&&(s=u));break;case 4:a=r[e+1],c=r[e+2],l=r[e+3],(a&192)===128&&(c&192)===128&&(l&192)===128&&(u=(i&15)<<18|(a&63)<<12|(c&63)<<6|l&63,u>65535&&u<1114112&&(s=u))}}s===null?(s=65533,o=1):s>65535&&(s-=65536,n.push(s>>>10&1023|55296),s=56320|s&1023),n.push(s),e+=o}return X7(n)}const dm=4096;function X7(r){const e=r.length;if(e<=dm)return String.fromCharCode.apply(String,r);let t="",n=0;for(;n<e;)t+=String.fromCharCode.apply(String,r.slice(n,n+=dm));return t}const RT=256;class Z7{constructor(e=RT){this.chunkSize=e,this.cursor=0,this.maxCursor=-1,this.chunks=[],this._initReuseChunk=null}reset(){this.cursor=0,this.maxCursor=-1,this.chunks.length&&(this.chunks=[]),this._initReuseChunk!==null&&(this.chunks.push(this._initReuseChunk),this.maxCursor=this._initReuseChunk.length-1)}push(e){let t=this.chunks[this.chunks.length-1];if(this.cursor+e.length<=this.maxCursor+1){const i=t.length-(this.maxCursor-this.cursor)-1;t.set(e,i)}else{if(t){const i=t.length-(this.maxCursor-this.cursor)-1;i<t.length&&(this.chunks[this.chunks.length-1]=t.subarray(0,i),this.maxCursor=this.cursor-1)}e.length<64&&e.length<this.chunkSize?(t=TT(this.chunkSize),this.chunks.push(t),this.maxCursor+=t.length,this._initReuseChunk===null&&(this._initReuseChunk=t),t.set(e,0)):(this.chunks.push(e),this.maxCursor+=e.length)}this.cursor+=e.length}toBytes(e=!1){let t;if(this.chunks.length===1){const n=this.chunks[0];e&&this.cursor>n.length/2?(t=this.cursor===n.length?n:n.subarray(0,this.cursor),this._initReuseChunk=null,this.chunks=[]):t=kg(n,0,this.cursor)}else t=_T(this.chunks,this.cursor);return e&&this.reset(),t}}const pe="CBOR decode error:",gs="CBOR encode error:";function pa(r,e,t){if(r.length-e<t)throw new Error(`${pe} not enough data for type`)}const Nt=[24,256,65536,4294967296,BigInt("18446744073709551616")];function Hs(r,e,t){pa(r,e,1);const n=r[e];if(t.strict===!0&&n<Nt[0])throw new Error(`${pe} integer encoded in more bytes than necessary (strict decode)`);return n}function qs(r,e,t){pa(r,e,2);const n=r[e]<<8|r[e+1];if(t.strict===!0&&n<Nt[1])throw new Error(`${pe} integer encoded in more bytes than necessary (strict decode)`);return n}function Ks(r,e,t){pa(r,e,4);const n=r[e]*16777216+(r[e+1]<<16)+(r[e+2]<<8)+r[e+3];if(t.strict===!0&&n<Nt[2])throw new Error(`${pe} integer encoded in more bytes than necessary (strict decode)`);return n}function Ws(r,e,t){pa(r,e,8);const n=r[e]*16777216+(r[e+1]<<16)+(r[e+2]<<8)+r[e+3],i=r[e+4]*16777216+(r[e+5]<<16)+(r[e+6]<<8)+r[e+7],s=(BigInt(n)<<BigInt(32))+BigInt(i);if(t.strict===!0&&s<Nt[3])throw new Error(`${pe} integer encoded in more bytes than necessary (strict decode)`);if(s<=Number.MAX_SAFE_INTEGER)return Number(s);if(t.allowBigInt===!0)return s;throw new Error(`${pe} integers outside of the safe integer range are not supported`)}function NT(r,e,t,n){return new G(_.uint,Hs(r,e+1,n),2)}function DT(r,e,t,n){return new G(_.uint,qs(r,e+1,n),3)}function BT(r,e,t,n){return new G(_.uint,Ks(r,e+1,n),5)}function LT(r,e,t,n){return new G(_.uint,Ws(r,e+1,n),9)}function js(r,e){return $r(r,0,e.value)}function $r(r,e,t){if(t<Nt[0]){const n=Number(t);r.push([e|n])}else if(t<Nt[1]){const n=Number(t);r.push([e|24,n])}else if(t<Nt[2]){const n=Number(t);r.push([e|25,n>>>8,n&255])}else if(t<Nt[3]){const n=Number(t);r.push([e|26,n>>>24&255,n>>>16&255,n>>>8&255,n&255])}else{const n=BigInt(t);if(n<Nt[4]){const i=[e|27,0,0,0,0,0,0,0];let s=Number(n&BigInt(4294967295)),o=Number(n>>BigInt(32)&BigInt(4294967295));i[8]=s&255,s=s>>8,i[7]=s&255,s=s>>8,i[6]=s&255,s=s>>8,i[5]=s&255,i[4]=o&255,o=o>>8,i[3]=o&255,o=o>>8,i[2]=o&255,o=o>>8,i[1]=o&255,r.push(i)}else throw new Error(`${pe} encountered BigInt larger than allowable range`)}}js.encodedSize=function(e){return $r.encodedSize(e.value)};$r.encodedSize=function(e){return e<Nt[0]?1:e<Nt[1]?2:e<Nt[2]?3:e<Nt[3]?5:9};js.compareTokens=function(e,t){return e.value<t.value?-1:e.value>t.value?1:0};function OT(r,e,t,n){return new G(_.negint,-1-Hs(r,e+1,n),2)}function MT(r,e,t,n){return new G(_.negint,-1-qs(r,e+1,n),3)}function $T(r,e,t,n){return new G(_.negint,-1-Ks(r,e+1,n),5)}const Cg=BigInt(-1),J7=BigInt(1);function UT(r,e,t,n){const i=Ws(r,e+1,n);if(typeof i!="bigint"){const s=-1-i;if(s>=Number.MIN_SAFE_INTEGER)return new G(_.negint,s,9)}if(n.allowBigInt!==!0)throw new Error(`${pe} integers outside of the safe integer range are not supported`);return new G(_.negint,Cg-BigInt(i),9)}function Ig(r,e){const t=e.value,n=typeof t=="bigint"?t*Cg-J7:t*-1-1;$r(r,e.type.majorEncoded,n)}Ig.encodedSize=function(e){const t=e.value,n=typeof t=="bigint"?t*Cg-J7:t*-1-1;return n<Nt[0]?1:n<Nt[1]?2:n<Nt[2]?3:n<Nt[3]?5:9};Ig.compareTokens=function(e,t){return e.value<t.value?1:e.value>t.value?-1:0};function xl(r,e,t,n){pa(r,e,t+n);const i=kg(r,e+t,e+t+n);return new G(_.bytes,i,t+n)}function FT(r,e,t,n){return xl(r,e,1,t)}function VT(r,e,t,n){return xl(r,e,2,Hs(r,e+1,n))}function zT(r,e,t,n){return xl(r,e,3,qs(r,e+1,n))}function HT(r,e,t,n){return xl(r,e,5,Ks(r,e+1,n))}function qT(r,e,t,n){const i=Ws(r,e+1,n);if(typeof i=="bigint")throw new Error(`${pe} 64-bit integer bytes lengths not supported`);return xl(r,e,9,i)}function md(r){return r.encodedBytes===void 0&&(r.encodedBytes=r.type===_.string?Q7(r.value):r.value),r.encodedBytes}function Yh(r,e){const t=md(e);$r(r,e.type.majorEncoded,t.length),r.push(t)}Yh.encodedSize=function(e){const t=md(e);return $r.encodedSize(t.length)+t.length};Yh.compareTokens=function(e,t){return KT(md(e),md(t))};function KT(r,e){return r.length<e.length?-1:r.length>e.length?1:PT(r,e)}function Al(r,e,t,n,i){const s=t+n;pa(r,e,s);const o=new G(_.string,IT(r,e+t,e+s),s);return i.retainStringBytes===!0&&(o.byteValue=kg(r,e+t,e+s)),o}function WT(r,e,t,n){return Al(r,e,1,t,n)}function jT(r,e,t,n){return Al(r,e,2,Hs(r,e+1,n),n)}function GT(r,e,t,n){return Al(r,e,3,qs(r,e+1,n),n)}function YT(r,e,t,n){return Al(r,e,5,Ks(r,e+1,n),n)}function QT(r,e,t,n){const i=Ws(r,e+1,n);if(typeof i=="bigint")throw new Error(`${pe} 64-bit integer string lengths not supported`);return Al(r,e,9,i,n)}const XT=Yh;function ga(r,e,t,n){return new G(_.array,n,t)}function ZT(r,e,t,n){return ga(r,e,1,t)}function JT(r,e,t,n){return ga(r,e,2,Hs(r,e+1,n))}function eP(r,e,t,n){return ga(r,e,3,qs(r,e+1,n))}function tP(r,e,t,n){return ga(r,e,5,Ks(r,e+1,n))}function rP(r,e,t,n){const i=Ws(r,e+1,n);if(typeof i=="bigint")throw new Error(`${pe} 64-bit integer array lengths not supported`);return ga(r,e,9,i)}function nP(r,e,t,n){if(n.allowIndefinite===!1)throw new Error(`${pe} indefinite length items not allowed`);return ga(r,e,1,1/0)}function _g(r,e){$r(r,_.array.majorEncoded,e.value)}_g.compareTokens=js.compareTokens;_g.encodedSize=function(e){return $r.encodedSize(e.value)};function ma(r,e,t,n){return new G(_.map,n,t)}function iP(r,e,t,n){return ma(r,e,1,t)}function sP(r,e,t,n){return ma(r,e,2,Hs(r,e+1,n))}function oP(r,e,t,n){return ma(r,e,3,qs(r,e+1,n))}function aP(r,e,t,n){return ma(r,e,5,Ks(r,e+1,n))}function cP(r,e,t,n){const i=Ws(r,e+1,n);if(typeof i=="bigint")throw new Error(`${pe} 64-bit integer map lengths not supported`);return ma(r,e,9,i)}function lP(r,e,t,n){if(n.allowIndefinite===!1)throw new Error(`${pe} indefinite length items not allowed`);return ma(r,e,1,1/0)}function Tg(r,e){$r(r,_.map.majorEncoded,e.value)}Tg.compareTokens=js.compareTokens;Tg.encodedSize=function(e){return $r.encodedSize(e.value)};function uP(r,e,t,n){return new G(_.tag,t,1)}function dP(r,e,t,n){return new G(_.tag,Hs(r,e+1,n),2)}function hP(r,e,t,n){return new G(_.tag,qs(r,e+1,n),3)}function fP(r,e,t,n){return new G(_.tag,Ks(r,e+1,n),5)}function pP(r,e,t,n){return new G(_.tag,Ws(r,e+1,n),9)}function Pg(r,e){$r(r,_.tag.majorEncoded,e.value)}Pg.compareTokens=js.compareTokens;Pg.encodedSize=function(e){return $r.encodedSize(e.value)};const gP=20,mP=21,yP=22,wP=23;function bP(r,e,t,n){if(n.allowUndefined===!1)throw new Error(`${pe} undefined values are not supported`);return n.coerceUndefinedToNull===!0?new G(_.null,null,1):new G(_.undefined,void 0,1)}function vP(r,e,t,n){if(n.allowIndefinite===!1)throw new Error(`${pe} indefinite length items not allowed`);return new G(_.break,void 0,1)}function Rg(r,e,t){if(t){if(t.allowNaN===!1&&Number.isNaN(r))throw new Error(`${pe} NaN values are not supported`);if(t.allowInfinity===!1&&(r===1/0||r===-1/0))throw new Error(`${pe} Infinity values are not supported`)}return new G(_.float,r,e)}function EP(r,e,t,n){return Rg(Dg(r,e+1),3,n)}function SP(r,e,t,n){return Rg(Bg(r,e+1),5,n)}function xP(r,e,t,n){return Rg(nw(r,e+1),9,n)}function Ng(r,e,t){const n=e.value;if(n===!1)r.push([_.float.majorEncoded|gP]);else if(n===!0)r.push([_.float.majorEncoded|mP]);else if(n===null)r.push([_.float.majorEncoded|yP]);else if(n===void 0)r.push([_.float.majorEncoded|wP]);else{let i,s=!1;(!t||t.float64!==!0)&&(tw(n),i=Dg(Kr,1),n===i||Number.isNaN(n)?(Kr[0]=249,r.push(Kr.slice(0,3)),s=!0):(rw(n),i=Bg(Kr,1),n===i&&(Kr[0]=250,r.push(Kr.slice(0,5)),s=!0))),s||(AP(n),i=nw(Kr,1),Kr[0]=251,r.push(Kr.slice(0,9)))}}Ng.encodedSize=function(e,t){const n=e.value;if(n===!1||n===!0||n===null||n===void 0)return 1;if(!t||t.float64!==!0){tw(n);let i=Dg(Kr,1);if(n===i||Number.isNaN(n))return 3;if(rw(n),i=Bg(Kr,1),n===i)return 5}return 9};const ew=new ArrayBuffer(9),Pr=new DataView(ew,1),Kr=new Uint8Array(ew,0);function tw(r){if(r===1/0)Pr.setUint16(0,31744,!1);else if(r===-1/0)Pr.setUint16(0,64512,!1);else if(Number.isNaN(r))Pr.setUint16(0,32256,!1);else{Pr.setFloat32(0,r);const e=Pr.getUint32(0),t=(e&2139095040)>>23,n=e&8388607;if(t===255)Pr.setUint16(0,31744,!1);else if(t===0)Pr.setUint16(0,(r&2147483648)>>16|n>>13,!1);else{const i=t-127;i<-24?Pr.setUint16(0,0):i<-14?Pr.setUint16(0,(e&2147483648)>>16|1<<24+i,!1):Pr.setUint16(0,(e&2147483648)>>16|i+15<<10|n>>13,!1)}}}function Dg(r,e){if(r.length-e<2)throw new Error(`${pe} not enough data for float16`);const t=(r[e]<<8)+r[e+1];if(t===31744)return 1/0;if(t===64512)return-1/0;if(t===32256)return NaN;const n=t>>10&31,i=t&1023;let s;return n===0?s=i*2**-24:n!==31?s=(i+1024)*2**(n-25):s=i===0?1/0:NaN,t&32768?-s:s}function rw(r){Pr.setFloat32(0,r,!1)}function Bg(r,e){if(r.length-e<4)throw new Error(`${pe} not enough data for float32`);const t=(r.byteOffset||0)+e;return new DataView(r.buffer,t,4).getFloat32(0,!1)}function AP(r){Pr.setFloat64(0,r,!1)}function nw(r,e){if(r.length-e<8)throw new Error(`${pe} not enough data for float64`);const t=(r.byteOffset||0)+e;return new DataView(r.buffer,t,8).getFloat64(0,!1)}Ng.compareTokens=js.compareTokens;function Ue(r,e,t){throw new Error(`${pe} encountered invalid minor (${t}) for major ${r[e]>>>5}`)}function Qh(r){return()=>{throw new Error(`${pe} ${r}`)}}const te=[];for(let r=0;r<=23;r++)te[r]=Ue;te[24]=NT;te[25]=DT;te[26]=BT;te[27]=LT;te[28]=Ue;te[29]=Ue;te[30]=Ue;te[31]=Ue;for(let r=32;r<=55;r++)te[r]=Ue;te[56]=OT;te[57]=MT;te[58]=$T;te[59]=UT;te[60]=Ue;te[61]=Ue;te[62]=Ue;te[63]=Ue;for(let r=64;r<=87;r++)te[r]=FT;te[88]=VT;te[89]=zT;te[90]=HT;te[91]=qT;te[92]=Ue;te[93]=Ue;te[94]=Ue;te[95]=Qh("indefinite length bytes/strings are not supported");for(let r=96;r<=119;r++)te[r]=WT;te[120]=jT;te[121]=GT;te[122]=YT;te[123]=QT;te[124]=Ue;te[125]=Ue;te[126]=Ue;te[127]=Qh("indefinite length bytes/strings are not supported");for(let r=128;r<=151;r++)te[r]=ZT;te[152]=JT;te[153]=eP;te[154]=tP;te[155]=rP;te[156]=Ue;te[157]=Ue;te[158]=Ue;te[159]=nP;for(let r=160;r<=183;r++)te[r]=iP;te[184]=sP;te[185]=oP;te[186]=aP;te[187]=cP;te[188]=Ue;te[189]=Ue;te[190]=Ue;te[191]=lP;for(let r=192;r<=215;r++)te[r]=uP;te[216]=dP;te[217]=hP;te[218]=fP;te[219]=pP;te[220]=Ue;te[221]=Ue;te[222]=Ue;te[223]=Ue;for(let r=224;r<=243;r++)te[r]=Qh("simple values are not supported");te[244]=Ue;te[245]=Ue;te[246]=Ue;te[247]=bP;te[248]=Qh("simple values are not supported");te[249]=EP;te[250]=SP;te[251]=xP;te[252]=Ue;te[253]=Ue;te[254]=Ue;te[255]=vP;const Pn=[];for(let r=0;r<24;r++)Pn[r]=new G(_.uint,r,1);for(let r=-1;r>=-24;r--)Pn[31-r]=new G(_.negint,r,1);Pn[64]=new G(_.bytes,new Uint8Array(0),1);Pn[96]=new G(_.string,"",1);Pn[128]=new G(_.array,0,1);Pn[160]=new G(_.map,0,1);Pn[244]=new G(_.false,!1,1);Pn[245]=new G(_.true,!0,1);Pn[246]=new G(_.null,null,1);function kP(r){switch(r.type){case _.false:return $n([244]);case _.true:return $n([245]);case _.null:return $n([246]);case _.bytes:return r.value.length?void 0:$n([64]);case _.string:return r.value===""?$n([96]):void 0;case _.array:return r.value===0?$n([128]):void 0;case _.map:return r.value===0?$n([160]):void 0;case _.uint:return r.value<24?$n([Number(r.value)]):void 0;case _.negint:if(r.value>=-24)return $n([31-Number(r.value)])}}const CP={float64:!1,mapSorter:TP,quickEncodeToken:kP};function IP(){const r=[];return r[_.uint.major]=js,r[_.negint.major]=Ig,r[_.bytes.major]=Yh,r[_.string.major]=XT,r[_.array.major]=_g,r[_.map.major]=Tg,r[_.tag.major]=Pg,r[_.float.major]=Ng,r}const iw=IP(),I1=new Z7;class yd{constructor(e,t){this.obj=e,this.parent=t}includes(e){let t=this;do if(t.obj===e)return!0;while(t=t.parent);return!1}static createCheck(e,t){if(e&&e.includes(t))throw new Error(`${gs} object contains circular references`);return new yd(t,e)}}const mi={null:new G(_.null,null),undefined:new G(_.undefined,void 0),true:new G(_.true,!0),false:new G(_.false,!1),emptyArray:new G(_.array,0),emptyMap:new G(_.map,0)},Ui={number(r,e,t,n){return!Number.isInteger(r)||!Number.isSafeInteger(r)?new G(_.float,r):r>=0?new G(_.uint,r):new G(_.negint,r)},bigint(r,e,t,n){return r>=BigInt(0)?new G(_.uint,r):new G(_.negint,r)},Uint8Array(r,e,t,n){return new G(_.bytes,r)},string(r,e,t,n){return new G(_.string,r)},boolean(r,e,t,n){return r?mi.true:mi.false},null(r,e,t,n){return mi.null},undefined(r,e,t,n){return mi.undefined},ArrayBuffer(r,e,t,n){return new G(_.bytes,new Uint8Array(r))},DataView(r,e,t,n){return new G(_.bytes,new Uint8Array(r.buffer,r.byteOffset,r.byteLength))},Array(r,e,t,n){if(!r.length)return t.addBreakTokens===!0?[mi.emptyArray,new G(_.break)]:mi.emptyArray;n=yd.createCheck(n,r);const i=[];let s=0;for(const o of r)i[s++]=Fu(o,t,n);return t.addBreakTokens?[new G(_.array,r.length),i,new G(_.break)]:[new G(_.array,r.length),i]},Object(r,e,t,n){const i=e!=="Object",s=i?r.keys():Object.keys(r),o=i?r.size:s.length;if(!o)return t.addBreakTokens===!0?[mi.emptyMap,new G(_.break)]:mi.emptyMap;n=yd.createCheck(n,r);const a=[];let c=0;for(const l of s)a[c++]=[Fu(l,t,n),Fu(i?r.get(l):r[l],t,n)];return _P(a,t),t.addBreakTokens?[new G(_.map,o),a,new G(_.break)]:[new G(_.map,o),a]}};Ui.Map=Ui.Object;Ui.Buffer=Ui.Uint8Array;for(const r of"Uint8Clamped Uint16 Uint32 Int8 Int16 Int32 BigUint64 BigInt64 Float32 Float64".split(" "))Ui[`${r}Array`]=Ui.DataView;function Fu(r,e={},t){const n=ST(r),i=e&&e.typeEncoders&&e.typeEncoders[n]||Ui[n];if(typeof i=="function"){const o=i(r,n,e,t);if(o!=null)return o}const s=Ui[n];if(!s)throw new Error(`${gs} unsupported type: ${n}`);return s(r,n,e,t)}function _P(r,e){e.mapSorter&&r.sort(e.mapSorter)}function TP(r,e){const t=Array.isArray(r[0])?r[0][0]:r[0],n=Array.isArray(e[0])?e[0][0]:e[0];if(t.type!==n.type)return t.type.compare(n.type);const i=t.type.major,s=iw[i].compareTokens(t,n);return s===0&&console.warn("WARNING: complex key types used, CBOR key sorting guarantees are gone"),s}function sw(r,e,t,n){if(Array.isArray(e))for(const i of e)sw(r,i,t,n);else t[e.type.major](r,e,n)}function ow(r,e,t){const n=Fu(r,t);if(!Array.isArray(n)&&t.quickEncodeToken){const i=t.quickEncodeToken(n);if(i)return i;const s=e[n.type.major];if(s.encodedSize){const o=s.encodedSize(n,t),a=new Z7(o);if(s(a,n,t),a.chunks.length!==1)throw new Error(`Unexpected error: pre-calculated length for ${n} was wrong`);return Ag(a.chunks[0])}}return I1.reset(),sw(I1,n,e,t),I1.toBytes(!0)}function Vu(r,e){return e=Object.assign({},CP,e),ow(r,iw,e)}const PP={strict:!1,allowIndefinite:!0,allowUndefined:!0,allowBigInt:!0};class RP{constructor(e,t={}){this._pos=0,this.data=e,this.options=t}pos(){return this._pos}done(){return this._pos>=this.data.length}next(){const e=this.data[this._pos];let t=Pn[e];if(t===void 0){const n=te[e];if(!n)throw new Error(`${pe} no decoder for major type ${e>>>5} (byte 0x${e.toString(16).padStart(2,"0")})`);const i=e&31;t=n(this.data,this._pos,i,this.options)}return this._pos+=t.encodedLength,t}}const Kc=Symbol.for("DONE"),Xh=Symbol.for("BREAK");function NP(r,e,t){const n=[];for(let i=0;i<r.value;i++){const s=Wc(e,t);if(s===Xh){if(r.value===1/0)break;throw new Error(`${pe} got unexpected break to lengthed array`)}if(s===Kc)throw new Error(`${pe} found array but not enough entries (got ${i}, expected ${r.value})`);n[i]=s}return n}function DP(r,e,t){const n=t.useMaps===!0,i=n?void 0:{},s=n?new Map:void 0;for(let o=0;o<r.value;o++){const a=Wc(e,t);if(a===Xh){if(r.value===1/0)break;throw new Error(`${pe} got unexpected break to lengthed map`)}if(a===Kc)throw new Error(`${pe} found map but not enough entries (got ${o} [no key], expected ${r.value})`);if(n!==!0&&typeof a!="string")throw new Error(`${pe} non-string keys not supported (got ${typeof a})`);if(t.rejectDuplicateMapKeys===!0&&(n&&s.has(a)||!n&&a in i))throw new Error(`${pe} found repeat map key "${a}"`);const c=Wc(e,t);if(c===Kc)throw new Error(`${pe} found map but not enough entries (got ${o} [no value], expected ${r.value})`);n?s.set(a,c):i[a]=c}return n?s:i}function Wc(r,e){if(r.done())return Kc;const t=r.next();if(t.type===_.break)return Xh;if(t.type.terminal)return t.value;if(t.type===_.array)return NP(t,r,e);if(t.type===_.map)return DP(t,r,e);if(t.type===_.tag){if(e.tags&&typeof e.tags[t.value]=="function"){const n=Wc(r,e);return e.tags[t.value](n)}throw new Error(`${pe} tag not supported (${t.value})`)}throw new Error("unsupported")}function BP(r,e){if(!(r instanceof Uint8Array))throw new Error(`${pe} data to decode must be a Uint8Array`);e=Object.assign({},PP,e);const t=e.tokenizer||new RP(r,e),n=Wc(t,e);if(n===Kc)throw new Error(`${pe} did not find any content to decode`);if(n===Xh)throw new Error(`${pe} got unexpected break`);return[n,r.subarray(t.pos())]}function vi(r,e){const[t,n]=BP(r,e);if(n.length>0)throw new Error(`${pe} too many terminals, data makes no sense`);return t}const LP=8,Lg=1024*1024*4;let OP=class extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MSG_LENGTH"};class aw extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"}class MP extends Error{name="InvalidDataLengthLengthError";code="ERR_MSG_LENGTH_TOO_LONG"}class hm extends Error{name="UnexpectedEOFError";code="ERR_UNEXPECTED_EOF"}function cw(r){return r[Symbol.asyncIterator]!=null}function lw(r,e){if(r.byteLength>e)throw new aw("Message length too long")}const Zh=r=>{const e=et(r),t=Ar(e);return vn(r,t),Zh.bytes=e,t};Zh.bytes=0;function jc(r,e){e=e??{};const t=e.lengthEncoder??Zh,n=e?.maxDataLength??Lg;function*i(s){lw(s,n);const o=t(s.byteLength);o instanceof Uint8Array?yield o:yield*o,s instanceof Uint8Array?yield s:yield*s}return cw(r)?(async function*(){for await(const s of r)yield*i(s)})():(function*(){for(const s of r)yield*i(s)})()}jc.single=(r,e)=>{e=e??{};const t=e.lengthEncoder??Zh,n=e?.maxDataLength??Lg;return lw(r,n),new me(t(r.byteLength),r)};var es;(function(r){r[r.LENGTH=0]="LENGTH",r[r.DATA=1]="DATA"})(es||(es={}));const Og=r=>{const e=Vs(r);return Og.bytes=et(e),e};Og.bytes=0;function wd(r,e){const t=new me;let n=es.LENGTH,i=-1;const s=e?.lengthDecoder??Og,o=e?.maxLengthLength??LP,a=e?.maxDataLength??Lg;function*c(){for(;t.byteLength>0;){if(n===es.LENGTH)try{if(i=s(t),i<0)throw new OP("Invalid message length");if(i>a)throw new aw("Message length too long");const l=s.bytes;t.consume(l),e?.onLength!=null&&e.onLength(i),n=es.DATA}catch(l){if(l instanceof RangeError){if(t.byteLength>o)throw new MP("Message length length too long");break}throw l}if(n===es.DATA){if(t.byteLength<i)break;const l=t.sublist(0,i);t.consume(i),e?.onData!=null&&e.onData(l),yield l,n=es.LENGTH}}}return cw(r)?(async function*(){for await(const l of r)t.append(l),yield*c();if(t.byteLength>0)throw new hm("Unexpected end of input")})():(function*(){for(const l of r)t.append(l),yield*c();if(t.byteLength>0)throw new hm("Unexpected end of input")})()}wd.fromReader=(r,e)=>{let t=1;const n=(async function*(){for(;;)try{const{done:s,value:o}=await r.next(t);if(s===!0)return;o!=null&&(yield o)}catch(s){if(s.code==="ERR_UNDER_READ")return{done:!0,value:null};throw s}finally{t=1}})();return wd(n,{...e??{},onLength:s=>{t=s}})};const fm=2147483647,uw=Symbol.for("sindresorhus/unlimited-timeout#brand");function $P(r,e,...t){if(typeof r!="function")throw new TypeError("Expected callback to be a function");e??=0,e=Number(e);let n=!1;const i={[uw]:!0,id:void 0,cleared:!1,ref(){return n=!1,i.id?.ref?.(),i},unref(){return n=!0,i.id?.unref?.(),i}};if(e===Number.POSITIVE_INFINITY||e>Number.MAX_SAFE_INTEGER)return i;(!Number.isFinite(e)||e<0)&&(e=0);const s=performance.now()+e,o=a=>{i.cleared||(a<=fm?(i.id=globalThis.setTimeout(()=>{i.cleared||r(...t)},a),n&&i.id?.unref?.()):(i.id=globalThis.setTimeout(()=>{const c=performance.now(),l=Math.max(0,s-c);o(l)},fm),n&&i.id?.unref?.()))};return o(e),i}function UP(r){!r||typeof r!="object"||!r[uw]||(r.cleared=!0,r.id!==void 0&&(globalThis.clearTimeout(r.id),r.id=void 0))}const FP=new WeakMap;function VP({clearTimeout:r,setTimeout:e}={}){return(t,{value:n,signal:i}={})=>{if(i?.aborted)return Promise.reject(i.reason);let s,o,a;const c=r??clearTimeout,l=()=>{c(s),a(i.reason)},u=()=>{i&&i.removeEventListener("abort",l)},d=new Promise((h,f)=>{o=()=>{u(),h(n)},a=f,s=(e??setTimeout)(o,t)});return i&&i.addEventListener("abort",l,{once:!0}),FP.set(d,()=>{c(s),s=null,o()}),d}}const zP=VP({setTimeout:$P,clearTimeout:UP});class Fi extends $i{has(e){return this.find(e)!=null}find(e){return this.queue.find(t=>e.equals(t.options.peerId))}}class HP extends $i{constructor(e={}){super({...e,sort:(t,n)=>t.options.priority>n.options.priority?-1:t.options.priority<n.options.priority?1:0})}}class dw{memoryStorage;points;duration;blockDuration;keyPrefix;constructor(e={}){this.points=e.points??4,this.duration=e.duration??1,this.blockDuration=e.blockDuration??0,this.keyPrefix=e.keyPrefix??"rlflx",this.memoryStorage=new qP}consume(e,t=1,n={}){const i=this.getKey(e),s=this._getKeySecDuration(n);let o=this.memoryStorage.incrby(i,t,s);if(o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o.consumedPoints>this.points)throw this.blockDuration>0&&o.consumedPoints<=this.points+t&&(o=this.memoryStorage.set(i,o.consumedPoints,this.blockDuration)),new i_("Rate limit exceeded",o);return o}penalty(e,t=1,n={}){const i=this.getKey(e),s=this._getKeySecDuration(n),o=this.memoryStorage.incrby(i,t,s);return o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o}reward(e,t=1,n={}){const i=this.getKey(e),s=this._getKeySecDuration(n),o=this.memoryStorage.incrby(i,-t,s);return o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o}block(e,t){const n=t*1e3,i=this.points+1;return this.memoryStorage.set(this.getKey(e),i,t),{remainingPoints:0,msBeforeNext:n===0?-1:n,consumedPoints:i,isFirstInDuration:!1}}set(e,t,n=0){const i=(n>=0?n:this.duration)*1e3;return this.memoryStorage.set(this.getKey(e),t,n),{remainingPoints:0,msBeforeNext:i===0?-1:i,consumedPoints:t,isFirstInDuration:!1}}get(e){const t=this.memoryStorage.get(this.getKey(e));return t!=null&&(t.remainingPoints=Math.max(this.points-t.consumedPoints,0)),t}delete(e){this.memoryStorage.delete(this.getKey(e))}_getKeySecDuration(e){return e?.customDuration!=null&&e.customDuration>=0?e.customDuration:this.duration}getKey(e){return this.keyPrefix.length>0?`${this.keyPrefix}:${e}`:e}parseKey(e){return e.substring(this.keyPrefix.length)}}class qP{storage;constructor(){this.storage=new Map}incrby(e,t,n){const i=this.storage.get(e);if(i!=null){const s=i.expiresAt!=null?i.expiresAt.getTime()-new Date().getTime():-1;return i.expiresAt==null||s>0?(i.value+=t,{remainingPoints:0,msBeforeNext:s,consumedPoints:i.value,isFirstInDuration:!1}):this.set(e,t,n)}return this.set(e,t,n)}set(e,t,n){const i=n*1e3,s=this.storage.get(e);s!=null&&clearTimeout(s.timeoutId);const o={value:t,expiresAt:i>0?new Date(Date.now()+i):void 0};return this.storage.set(e,o),i>0&&(o.timeoutId=setTimeout(()=>{this.storage.delete(e)},i),o.timeoutId.unref!=null&&o.timeoutId.unref()),{remainingPoints:0,msBeforeNext:i===0?-1:i,consumedPoints:o.value,isFirstInDuration:!0}}get(e){const t=this.storage.get(e);if(t!=null)return{remainingPoints:0,msBeforeNext:t.expiresAt!=null?t.expiresAt.getTime()-new Date().getTime():-1,consumedPoints:t.value,isFirstInDuration:!1}}delete(e){const t=this.storage.get(e);return t!=null?(t.timeoutId!=null&&clearTimeout(t.timeoutId),this.storage.delete(e),!0):!1}}function Mg(r,e,t){let n,i,s=!1;function o(){const l={signal:i.signal};if(t?.timeout!=null){const u=Ke([i.signal,AbortSignal.timeout(t.timeout)]);l.signal=u}s=!0,Promise.resolve().then(async()=>{await r(l)}).catch(()=>{}).finally(()=>{s=!1,!i.signal.aborted&&(n=setTimeout(o,e))})}const a=Vc(o,t?.debounce??100);let c=!1;return{setInterval:l=>{e!==l&&(e=l,n!=null&&(clearTimeout(n),n=setTimeout(o,e)))},setTimeout:l=>{t??={},t.timeout=l},run:()=>{s||(clearTimeout(n),a())},start:()=>{c||(c=!0,i=new AbortController,i.signal,t?.runImmediately===!0?queueMicrotask(()=>{o()}):n=setTimeout(o,e))},stop:()=>{clearTimeout(n),i?.abort(),c=!1}}}class KP extends Map{metric;constructor(e){super();const{name:t,metrics:n}=e;this.metric=n.registerMetric(t),this.updateComponentMetric()}set(e,t){return super.set(e,t),this.updateComponentMetric(),this}delete(e){const t=super.delete(e);return this.updateComponentMetric(),t}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}}function an(r){const{name:e,metrics:t}=r;let n;return t!=null?n=new KP({name:e,metrics:t}):n=new Map,n}const Un="/",hw=new TextEncoder().encode(Un),au=hw[0];class Ye{_buf;constructor(e,t){if(typeof e=="string")this._buf=W(e);else if(e instanceof Uint8Array)this._buf=e;else throw new Error("Invalid key, should be String of Uint8Array");if(t==null&&(t=!0),t&&this.clean(),this._buf.byteLength===0||this._buf[0]!==au)throw new Error("Invalid key")}toString(e="utf8"){return Y(this._buf,e)}uint8Array(){return this._buf}get[Symbol.toStringTag](){return`Key(${this.toString()})`}static withNamespaces(e){return new Ye(e.join(Un))}static random(){return new Ye(Math.random().toString().substring(2))}static asKey(e){return e instanceof Uint8Array||typeof e=="string"?new Ye(e):typeof e.uint8Array=="function"?new Ye(e.uint8Array()):null}clean(){if((this._buf==null||this._buf.byteLength===0)&&(this._buf=hw),this._buf[0]!==au){const e=new Uint8Array(this._buf.byteLength+1);e.fill(au,0,1),e.set(this._buf,1),this._buf=e}for(;this._buf.byteLength>1&&this._buf[this._buf.byteLength-1]===au;)this._buf=this._buf.subarray(0,-1)}less(e){const t=this.list(),n=e.list();for(let i=0;i<t.length;i++){if(n.length<i+1)return!1;const s=t[i],o=n[i];if(s<o)return!0;if(s>o)return!1}return t.length<n.length}reverse(){return Ye.withNamespaces(this.list().slice().reverse())}namespaces(){return this.list()}baseNamespace(){const e=this.namespaces();return e[e.length-1]}list(){return this.toString().split(Un).slice(1)}type(){return WP(this.baseNamespace())}name(){return jP(this.baseNamespace())}instance(e){return new Ye(this.toString()+":"+e)}path(){let e=this.parent().toString();return e.endsWith(Un)||(e+=Un),e+=this.type(),new Ye(e)}parent(){const e=this.list();return e.length===1?new Ye(Un):new Ye(e.slice(0,-1).join(Un))}child(e){return this.toString()===Un?e:e.toString()===Un?this:new Ye(this.toString()+e.toString(),!1)}isAncestorOf(e){return e.toString()===this.toString()?!1:e.toString().startsWith(this.toString())}isDecendantOf(e){return e.toString()===this.toString()?!1:this.toString().startsWith(e.toString())}isTopLevel(){return this.list().length===1}concat(...e){return Ye.withNamespaces([...this.namespaces(),...GP(e.map(t=>t.namespaces()))])}}function WP(r){const e=r.split(":");return e.length<2?"":e.slice(0,-1).join(":")}function jP(r){const e=r.split(":");return e[e.length-1]}function GP(r){return[].concat(...r)}function YP(r){return r[Symbol.asyncIterator]!=null}function Jt(r){if(YP(r))return(async()=>{let n=new Uint8Array(0);for await(const i of r)n=Ot([n,i],n.length+i.length);return n})();const e=[];let t=0;for(const n of r)e.push(n),t+=n.byteLength;return Ot(e,t)}function cu({enumerable:r=!0,configurable:e=!1}={}){return{enumerable:r,configurable:e,writable:!1}}function*QP(r,e){if(e!=null&&typeof e=="object")if(Array.isArray(e))for(const[t,n]of e.entries()){const i=[...r,t],s=ae.asCID(n);s!=null?yield[i.join("/"),s]:typeof n=="object"&&(yield*P0(n,i))}else{const t=ae.asCID(e);t!=null?yield[r.join("/"),t]:yield*P0(e,r)}}function*P0(r,e){if(r==null||r instanceof Uint8Array)return;const t=ae.asCID(r);t!=null&&(yield[e.join("/"),t]);for(const[n,i]of Object.entries(r)){const s=[...e,n];yield*QP(s,i)}}function*XP(r,e){if(Array.isArray(e))for(const[t,n]of e.entries()){const i=[...r,t];yield i.join("/"),typeof n=="object"&&ae.asCID(n)==null&&(yield*R0(n,i))}else yield*R0(e,r)}function*R0(r,e){if(!(r==null||typeof r!="object"))for(const[t,n]of Object.entries(r)){const i=[...e,t];yield i.join("/"),n!=null&&!(n instanceof Uint8Array)&&typeof n=="object"&&ae.asCID(n)==null&&(yield*XP(i,n))}}function ZP(r,e){let t=r;for(const[n,i]of e.entries()){if(t=t[i],t==null)throw new Error(`Object has no property at ${e.slice(0,n+1).map(o=>`[${JSON.stringify(o)}]`).join("")}`);const s=ae.asCID(t);if(s!=null)return{value:s,remaining:e.slice(n+1).join("/")}}return{value:t}}let JP=class{cid;bytes;value;asBlock;constructor({cid:e,bytes:t,value:n}){if(e==null||t==null||typeof n>"u")throw new Error("Missing required argument");this.cid=e,this.bytes=t,this.value=n,this.asBlock=this,Object.defineProperties(this,{cid:cu(),bytes:cu(),value:cu(),asBlock:cu()})}links(){return P0(this.value,[])}tree(){return R0(this.value,[])}get(e="/"){return ZP(this.value,e.split("/").filter(Boolean))}};function eR({bytes:r,cid:e,value:t,codec:n}){const i=t!==void 0?t:n?.decode(r);if(i===void 0)throw new Error('Missing required argument, must either provide "value" or "codec"');return new JP({cid:e,bytes:r,value:i})}class tR extends Error{static name="AlreadyPinnedError";name="AlreadyPinnedError"}class pm extends Error{static name="BlockPinnedError";name="BlockPinnedError"}class rR extends Error{static name="InvalidDatastoreVersionError";name="InvalidDatastoreVersionError"}class nR extends Error{static name="InvalidConfigurationError";name="InvalidConfigurationError"}class iR extends AggregateError{static name="GetFailedError";name="GetFailedError"}class sR extends AggregateError{static name="LoadBlockFailedError";name="LoadBlockFailedError"}class gm extends Error{static name="BlockNotFoundWhileOfflineError";name="BlockNotFoundWhileOfflineError"}const fw="/pin/",mm="/pinned-block/",N0=_i,ym=1;function lu(r){return r.version===0&&(r=r.toV1()),new Ye(`${fw}${r.toString(N0)}`)}class oR{datastore;blockstore;getCodec;constructor(e,t,n){this.datastore=e,this.blockstore=t,this.getCodec=n}async*add(e,t={}){const n=lu(e);if(await this.datastore.has(n))throw new tR("Already pinned");const i=Math.round(t.depth??1/0);if(i<0)throw new H("Depth must be greater than or equal to 0");const s=new $i({concurrency:ym});for await(const a of this.#e(e,s,{...t,depth:i}))await this.#t(a,c=>c.pinnedBy.find(l=>Te(l,e.bytes))!=null?!1:(c.pinCount++,c.pinnedBy.push(e.bytes),!0),t),yield a;const o={depth:i,metadata:t.metadata??{}};await this.datastore.put(n,Vu(o),t)}async*#e(e,t,n){if(n.depth===-1)return;const i=await this.getCodec(e.code),s=await Jt(this.blockstore.get(e,n)),o=eR({bytes:s,cid:e,codec:i});yield e;for(const[,a]of o.links())yield*await t.add(async()=>this.#e(a,t,{...n,depth:n.depth-1}))}async#t(e,t,n){const i=new Ye(`${mm}${N0.encode(e.multihash.bytes)}`);let s={pinCount:0,pinnedBy:[]};try{s=vi(await this.datastore.get(i,n))}catch(a){if(a.name!=="NotFoundError")throw a}if(t(s)){if(s.pinCount===0&&await this.datastore.has(i)){await this.datastore.delete(i);return}await this.datastore.put(i,Vu(s),n),n.onProgress?.(new oe("helia:pin:add",e))}}async*rm(e,t={}){const n=lu(e),i=await this.datastore.get(n,t),s=vi(i);await this.datastore.delete(n,t);const o=new $i({concurrency:ym});for await(const a of this.#e(e,o,{...t,depth:s.depth}))await this.#t(a,c=>(c.pinCount--,c.pinnedBy=c.pinnedBy.filter(l=>Te(l,e.bytes)),!0),{...t,depth:s.depth}),yield a}async*ls(e={}){for await(const{key:t,value:n}of this.datastore.query({prefix:fw+(e.cid!=null?`${e.cid.toString(_i)}`:"")},e)){const i=ae.parse(t.toString().substring(5),_i),s=vi(n);yield{cid:i,...s}}}async isPinned(e,t={}){const n=new Ye(`${mm}${N0.encode(e.multihash.bytes)}`);return this.datastore.has(n,t)}async get(e,t){const n=lu(e),i=await this.datastore.get(n,t);return vi(i)}async setMetadata(e,t,n){const i=lu(e),s=await this.datastore.get(i,n),o=vi(s);o.metadata=t??{},await this.datastore.put(i,Vu(o),n)}}const aR=1,cR=5;class lR extends Error{static name="InsufficientProvidersError";constructor(e="Insufficient providers found"){super(e),this.name="InsufficientProvidersError"}}class uu extends Error{static name="NoRoutersAvailableError";constructor(e="No routers available"){super(e),this.name="NoRoutersAvailableError"}}class uR extends Error{static name="UnknownHashAlgorithmError";constructor(e="Unknown hash algorithm"){super(e),this.name="UnknownHashAlgorithmError"}}class dR extends Error{static name="UnknownCodecError";constructor(e="Unknown codec"){super(e),this.name="UnknownCodecError"}}const hR=5;class fR{log;routers;providerLookupConcurrency;constructor(e,t){this.log=e.logger.forComponent("helia:routing"),this.routers=t.routers??[],this.providerLookupConcurrency=t.providerLookupConcurrency??hR,this.findProviders=e.metrics?.traceFunction("helia.routing.findProviders",this.findProviders.bind(this),{optionsIndex:1})??this.findProviders,this.provide=e.metrics?.traceFunction("helia.routing.provide",this.provide.bind(this),{optionsIndex:1})??this.provide,this.cancelReprovide=e.metrics?.traceFunction("helia.routing.cancelReprovide",this.cancelReprovide.bind(this),{optionsIndex:1})??this.cancelReprovide,this.put=e.metrics?.traceFunction("helia.routing.put",this.put.bind(this),{optionsIndex:2})??this.put,this.get=e.metrics?.traceFunction("helia.routing.get",this.get.bind(this),{optionsIndex:1})??this.get,this.findPeer=e.metrics?.traceFunction("helia.routing.findPeer",this.findPeer.bind(this),{optionsIndex:1})??this.findPeer,this.getClosestPeers=e.metrics?.traceFunction("helia.routing.getClosestPeers",this.getClosestPeers.bind(this),{optionsIndex:1})??this.getClosestPeers}async start(){await Cn(...this.routers)}async stop(){await ni(...this.routers)}async*findProviders(e,t={}){if(this.routers.length===0)throw new uu("No content routers available");const n=new Fi({concurrency:this.providerLookupConcurrency});let i=0;const s=this;let o=0;this.log("findProviders for %c start using routers %s",e,this.routers.map(c=>c.toString()).join(", "));const a=Xi(this.routers,"findProviders").map(async function*(c){let l=0;try{for await(const u of c.findProviders(e,t))l++,yield u}catch{}finally{s.log("router %s found %d providers for %c",c,l,e),o++,o===a.length&&n.size===0&&n.emitIdle()}});for await(const c of Pi(n.toGenerator(),...a))if(c!=null){if(c.multiaddrs.length===0){if(n.find(c.id)!=null)continue;n.add(async()=>{try{const l=await this.findPeer(c.id,t);return l.multiaddrs.length===0?null:{...l,protocols:c.protocols,routing:c.routing}}catch(l){return this.log.error("could not load multiaddrs for peer %p - %e",c.id,l),null}},{peerId:c.id,signal:t.signal}).catch(l=>{this.log.error("could not load multiaddrs for peer %p - %e",c.id,l)});continue}i++,yield c}this.log("findProviders finished, found %d providers for %c",i,e)}async provide(e,t={}){if(this.routers.length===0)throw new uu("No content routers available");await Promise.all(Xi(this.routers,"provide").map(async n=>{await n.provide(e,t)}))}async cancelReprovide(e,t={}){await Promise.all(Xi(this.routers,"cancelReprovide").map(async n=>{await n.cancelReprovide(e,t)}))}async put(e,t,n){await Promise.all(Xi(this.routers,"put").map(async i=>{await i.put(e,t,n)}))}async get(e,t){const n=[];let i;try{i=await Promise.any(Xi(this.routers,"get").map(async s=>{try{return await s.get(e,t)}catch(o){this.log("router %s failed with %e",s,o),n.push(o)}}))}catch{}if(i==null)throw new iR(n,`Failed to get value key ${Y(e,"base58btc")}`);return i}async findPeer(e,t){if(this.routers.length===0)throw new uu("No peer routers available");const n=this,i=Pi(...Xi(this.routers,"findPeer").map(s=>(async function*(){try{yield await s.findPeer(e,t)}catch(o){n.log.error(o)}})()));for await(const s of i)if(s!=null)return s;throw new wt("Could not find peer in routing")}async*getClosestPeers(e,t={}){if(this.routers.length===0)throw new uu("No peer routers available");for await(const n of Pi(...Xi(this.routers,"getClosestPeers").map(i=>i.getClosestPeers(e,t))))n!=null&&(yield n)}}function Xi(r,e){return r.filter(t=>t[e]!=null)}let Uo=class extends Error{static name="AbortError";name="AbortError";constructor(e="The operation was aborted",...t){super(e,...t)}};async function bn(r,e,t,n){const i=new Uo(n?.errorMessage);n?.errorCode!=null&&(i.code=n.errorCode);const s=n?.errorEvent??"error";return t?.aborted===!0?Promise.reject(i):new Promise((o,a)=>{function c(){T1(t,"abort",d),T1(r,e,l),T1(r,s,u)}const l=h=>{try{if(n?.filter?.(h)===!1)return}catch(f){c(),a(f);return}c(),o(h)},u=h=>{if(c(),h instanceof Error){a(h);return}a(h.detail??n?.error??new Error(`The "${n?.errorEvent}" event was emitted but the event had no '.detail' field. Pass an 'error' option to race-event to change this message.`))},d=()=>{c(),a(i)};_1(t,"abort",d),_1(r,e,l),_1(r,s,u)})}function _1(r,e,t){r!=null&&(pw(r)?r.addEventListener(e,t):r.addListener(e,t))}function T1(r,e,t){r!=null&&(pw(r)?r.removeEventListener(e,t):r.removeListener(e,t))}function pw(r){return typeof r.addEventListener=="function"&&typeof r.removeEventListener=="function"}class pR extends Error{static name="QueueFullError";constructor(e="The queue was full"){super(e),this.name="QueueFullError"}}class gR{deferred;signal;constructor(e){this.signal=e,this.deferred=Promise.withResolvers(),this.onAbort=this.onAbort.bind(this),this.signal?.addEventListener("abort",this.onAbort)}onAbort(){this.deferred.reject(this.signal?.reason??new Uo)}cleanup(){this.signal?.removeEventListener("abort",this.onAbort)}}function mR(){return`${parseInt(String(Math.random()*1e9),10).toString()}${Date.now()}`}class yR{id;fn;options;recipients;status;timeline;controller;constructor(e,t){this.id=mR(),this.status="queued",this.fn=e,this.options=t,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,this.controller.signal,this.onAbort=this.onAbort.bind(this)}abort(e){this.controller.abort(e)}onAbort(){this.recipients.reduce((t,n)=>t&&n.signal?.aborted===!0,!0)&&(this.controller.abort(new Uo),this.cleanup())}async join(e={}){const t=new gR(e.signal);return this.recipients.push(t),e.signal?.addEventListener("abort",this.onAbort),t.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();const e=await Yt(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach(t=>{t.deferred.resolve(e)}),this.status="complete"}catch(e){this.recipients.forEach(t=>{t.deferred.reject(e)}),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach(e=>{e.cleanup(),e.signal?.removeEventListener("abort",this.onAbort)})}}function wm(r,e){let t;const n=function(){const i=function(){t=void 0,r()};clearTimeout(t),t=setTimeout(i,e)};return n.start=()=>{},n.stop=()=>{clearTimeout(t)},n}class bm extends Qe{concurrency;maxSize;queue;pending;sort;autoStart;constructor(e={}){super(),this.concurrency=e.concurrency??Number.POSITIVE_INFINITY,this.maxSize=e.maxSize??Number.POSITIVE_INFINITY,this.pending=0,this.autoStart=e.autoStart??!0,this.sort=e.sort,this.queue=[],this.emitEmpty=wm(this.emitEmpty.bind(this),1),this.emitIdle=wm(this.emitIdle.bind(this),1)}[Symbol.asyncIterator](){return this.toGenerator()}emitEmpty(){this.size===0&&this.safeDispatchEvent("empty")}emitIdle(){this.running===0&&this.safeDispatchEvent("idle")}tryToStartAnother(){if(this.size===0)return this.emitEmpty(),this.running===0&&this.emitIdle(),!1;if(this.pending<this.concurrency){let e;for(const t of this.queue)if(t.status==="queued"){e=t;break}return e==null?!1:(this.safeDispatchEvent("active"),this.pending++,e.run().finally(()=>{for(let t=0;t<this.queue.length;t++)if(this.queue[t]===e){this.queue.splice(t,1);break}this.pending--,this.safeDispatchEvent("next"),this.autoStart&&this.tryToStartAnother()}),!0)}return!1}enqueue(e){this.queue.push(e),this.sort!=null&&this.queue.sort(this.sort)}start(){this.autoStart===!1&&(this.autoStart=!0,this.tryToStartAnother())}pause(){this.autoStart=!1}async add(e,t){if(t?.signal?.throwIfAborted(),this.size===this.maxSize)throw new pR;const n=new yR(e,t);return this.enqueue(n),this.safeDispatchEvent("add"),this.autoStart&&this.tryToStartAnother(),n.join(t).then(i=>(this.safeDispatchEvent("success",{detail:{job:n,result:i}}),i)).catch(i=>{if(n.status==="queued"){for(let s=0;s<this.queue.length;s++)if(this.queue[s]===n){this.queue.splice(s,1);break}}throw this.safeDispatchEvent("failure",{detail:{job:n,error:i}}),i})}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach(e=>{e.abort(new Uo)}),this.clear()}async onEmpty(e){this.size!==0&&await bn(this,"empty",e?.signal)}async onSizeLessThan(e,t){this.size<e||await bn(this,"next",t?.signal,{filter:()=>this.size<e})}async onIdle(e){this.pending===0&&this.size===0||await bn(this,"idle",e?.signal)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(e){e?.signal?.throwIfAborted();const t=ii({objectMode:!0}),n=c=>{c!=null?this.abort():this.clear(),t.end(c)},i=c=>{c.detail!=null&&t.push(c.detail.result)},s=c=>{n(c.detail.error)},o=()=>{n()},a=()=>{n(new Uo("Queue aborted"))};this.addEventListener("success",i),this.addEventListener("failure",s),this.addEventListener("idle",o),e?.signal?.addEventListener("abort",a);try{yield*t}finally{this.removeEventListener("success",i),this.removeEventListener("failure",s),this.removeEventListener("idle",o),e?.signal?.removeEventListener("abort",a),n()}}}const gw="lock:worker:request-read",mw="lock:worker:abort-read-request",yw="lock:worker:release-read",ww="lock:master:grant-read",bw="lock:master:error-read",vw="lock:worker:request-write",Ew="lock:worker:abort-write-request",Sw="lock:worker:release-write",xw="lock:master:grant-write",Aw="lock:master:error-write",kw="lock:worker:finalize",Cw="mortice",wR={singleProcess:!1},vm=(r,e,t,n,i,s,o,a,c)=>l=>{if(l.data==null)return;const u={type:l.data.type,name:l.data.name,identifier:l.data.identifier};u.type===i&&r.safeDispatchEvent(t,{detail:{name:u.name,identifier:u.identifier,handler:async()=>{e.postMessage({type:c,name:u.name,identifier:u.identifier}),await new Promise(d=>{const h=f=>{if(f?.data==null)return;const y={type:f.data.type,name:f.data.name,identifier:f.data.identifier};y.type===a&&y.identifier===u.identifier&&(e.removeEventListener("message",h),d())};e.addEventListener("message",h)})},onError:d=>{e.postMessage({type:o,name:u.name,identifier:u.identifier,error:{message:d.message,name:d.name,stack:d.stack}})}}}),u.type===s&&r.safeDispatchEvent(n,{detail:{name:u.name,identifier:u.identifier}}),u.type===kw&&r.safeDispatchEvent("finalizeRequest",{detail:{name:u.name}})},bR=(r=10)=>Math.random().toString().substring(2,r+2);class vR{name;channel;constructor(e){this.name=e,this.channel=new BroadcastChannel(Cw)}readLock(e){return this.sendRequest(gw,mw,ww,bw,yw,e)}writeLock(e){return this.sendRequest(vw,Ew,xw,Aw,Sw,e)}finalize(){this.channel.postMessage({type:kw,name:this.name}),this.channel.close()}async sendRequest(e,t,n,i,s,o){o?.signal?.throwIfAborted();const a=bR();return this.channel.postMessage({type:e,identifier:a,name:this.name}),new Promise((c,l)=>{const u=()=>{this.channel.postMessage({type:t,identifier:a,name:this.name})};o?.signal?.addEventListener("abort",u,{once:!0});const d=h=>{if(h.data?.identifier===a&&(h.data?.type===n&&(this.channel.removeEventListener("message",d),o?.signal?.removeEventListener("abort",u),c(()=>{this.channel.postMessage({type:s,identifier:a,name:this.name})})),h.data.type===i)){this.channel.removeEventListener("message",d),o?.signal?.removeEventListener("abort",u);const f=new Error;h.data.error!=null&&(f.message=h.data.error.message,f.name=h.data.error.name,f.stack=h.data.error.stack),l(f)}};this.channel.addEventListener("message",d)})}}const ER=r=>{if(r=Object.assign({},wR,r),!!globalThis.document||r.singleProcess){const t=new BroadcastChannel(Cw),n=new Qe;return t.addEventListener("message",vm(n,t,"requestReadLock","abortReadLockRequest",gw,mw,bw,yw,ww)),t.addEventListener("message",vm(n,t,"requestWriteLock","abortWriteLockRequest",vw,Ew,Aw,Sw,xw)),n}return new vR(r.name)},os=new Map;let $a;function Iw(r){return typeof r?.readLock=="function"&&typeof r?.writeLock=="function"}function SR(r){if($a==null&&($a=ER(r),!Iw($a))){const e=$a;e.addEventListener("requestReadLock",t=>{const n=t.detail.name,i=t.detail.identifier,s=os.get(n);if(s==null)return;const o=new AbortController,a=c=>{c.detail.name!==n||c.detail.identifier!==i||o.abort()};e.addEventListener("abortReadLockRequest",a),s.readLock({signal:o.signal}).then(async c=>{await t.detail.handler().finally(()=>{c()})}).catch(c=>{t.detail.onError(c)}).finally(()=>{e.removeEventListener("abortReadLockRequest",a)})}),e.addEventListener("requestWriteLock",t=>{const n=t.detail.name,i=t.detail.identifier,s=os.get(n);if(s==null)return;const o=new AbortController,a=c=>{c.detail.name!==n||c.detail.identifier!==i||o.abort()};e.addEventListener("abortWriteLockRequest",a),s.writeLock({signal:o.signal}).then(async c=>{await t.detail.handler().finally(()=>{c()})}).catch(c=>{t.detail.onError(c)}).finally(()=>{e.removeEventListener("abortWriteLockRequest",a)})}),e.addEventListener("finalizeRequest",t=>{const n=t.detail.name,i=os.get(n);i?.finalize()})}return $a}async function P1(r,e){let t,n;const i=new Promise((o,a)=>{t=o,n=a}),s=()=>{n(new Uo)};return e?.signal?.addEventListener("abort",s,{once:!0}),r.add(async()=>{await new Promise(o=>{t(()=>{e?.signal?.removeEventListener("abort",s),o()})})},{signal:e?.signal}).catch(o=>{n(o)}),i}const xR=(r,e)=>{let t=os.get(r);if(t!=null)return t;const n=SR(e);if(Iw(n))return t=n,os.set(r,t),t;const i=new bm({concurrency:1});let s;return t={async readLock(o){if(s!=null)return P1(s,o);s=new bm({concurrency:e.concurrency,autoStart:!1});const a=s,c=P1(s,o);return i.add(async()=>{a.start(),await a.onIdle().then(()=>{s===a&&(s=null)})}),c},async writeLock(o){return s=null,P1(i,o)},finalize:()=>{os.delete(r)},queue:i},os.set(r,t),e.autoFinalize===!0&&i.addEventListener("idle",()=>{t.finalize()},{once:!0}),t},AR={name:"lock",concurrency:1/0,singleProcess:!1,autoFinalize:!1};function _w(r){const e=Object.assign({},AR,r);return xR(e.name,e)}class kR{lock;child;pins;started;constructor(e,t,n={}){this.child=e,this.pins=t,this.lock=_w({singleProcess:n.holdGcLock}),this.started=!1}isStarted(){return this.started}async start(){await Cn(this.child),this.started=!0}async stop(){await ni(this.child),this.started=!1}unwrap(){return this.child}async put(e,t,n={}){n?.signal?.throwIfAborted();const i=await this.lock.readLock();try{return await this.child.put(e,t,n)}finally{i()}}async*putMany(e,t={}){t?.signal?.throwIfAborted();const n=await this.lock.readLock();try{yield*this.child.putMany(e,t)}finally{n()}}async*get(e,t={}){t?.signal?.throwIfAborted();const n=await this.lock.readLock();try{yield*this.child.get(e,t)}finally{n()}}async*getMany(e,t={}){t?.signal?.throwIfAborted();const n=await this.lock.readLock();try{yield*this.child.getMany(e,t)}finally{n()}}async delete(e,t={}){t?.signal?.throwIfAborted();const n=await this.lock.writeLock();try{if(await this.pins.isPinned(e))throw new pm("Block was pinned - please unpin and try again");await this.child.delete(e,t)}finally{n()}}async*deleteMany(e,t={}){t?.signal?.throwIfAborted();const n=await this.lock.writeLock();try{const i=this;yield*this.child.deleteMany((async function*(){for await(const s of e){if(await i.pins.isPinned(s))throw new pm("Block was pinned - please unpin and try again");yield s}})(),t)}finally{n()}}async has(e,t={}){t?.signal?.throwIfAborted();const n=await this.lock.readLock();try{return await this.child.has(e,t)}finally{n()}}async*getAll(e={}){e?.signal?.throwIfAborted();const t=await this.lock.readLock();try{yield*this.child.getAll(e)}finally{t()}}createSession(e,t){return t?.signal?.throwIfAborted(),this.child.createSession(e,t)}}const R1=new Ye("/version"),Em=1;async function CR(r){if(!await r.has(R1)){await r.put(R1,W(`${Em}`));return}const e=await r.get(R1),t=Y(e);if(parseInt(t,10)!==Em)throw new rR("Invalid datastore version, a datastore migration may be required")}const Tw=42;function Pw(r){return r instanceof ArrayBuffer?new Uint8Array(r,0,r.byteLength):r}function IR(r){if(r.asCID!==r&&r["/"]!==r.bytes)return null;const e=ae.asCID(r);if(!e)return null;const t=new Uint8Array(e.bytes.byteLength+1);return t.set(e.bytes,1),[new G(_.tag,Tw),new G(_.bytes,t)]}function _R(){throw new Error("`undefined` is not supported by the IPLD Data Model and cannot be encoded")}function TR(r){if(Number.isNaN(r))throw new Error("`NaN` is not supported by the IPLD Data Model and cannot be encoded");if(r===1/0||r===-1/0)throw new Error("`Infinity` and `-Infinity` is not supported by the IPLD Data Model and cannot be encoded");return null}function PR(r){for(const e of r.keys())if(typeof e!="string"||e.length===0)throw new Error("Non-string Map keys are not supported by the IPLD Data Model and cannot be encoded");return null}const D0={float64:!0,typeEncoders:{Map:PR,Object:IR,undefined:_R,number:TR}},RR={...D0,typeEncoders:{...D0.typeEncoders}};function NR(r){if(r[0]!==0)throw new Error("Invalid CID for CBOR tag 42; expected leading 0x00");return ae.decode(r.subarray(1))}const bd={allowIndefinite:!1,coerceUndefinedToNull:!0,allowNaN:!1,allowInfinity:!1,allowBigInt:!0,strict:!0,useMaps:!1,rejectDuplicateMapKeys:!0,tags:[]};bd.tags[Tw]=NR;const DR={...bd,tags:bd.tags.slice()},BR="dag-cbor",$g=113,LR=r=>Vu(r,D0),Rw=r=>vi(Pw(r),bd),OR=Object.freeze(Object.defineProperty({__proto__:null,code:$g,decode:Rw,decodeOptions:DR,encode:LR,encodeOptions:RR,name:BR,toByteView:Pw},Symbol.toStringTag,{value:"Module"}));class MR extends Array{constructor(){super(),this.inRecursive=[]}prefix(e){const t=this.inRecursive[this.inRecursive.length-1];t&&(t.type===_.array&&(t.elements++,t.elements!==1&&e.push([44])),t.type===_.map&&(t.elements++,t.elements!==1&&(t.elements%2===1?e.push([44]):e.push([58]))))}[_.uint.major](e,t){this.prefix(e);const n=String(t.value),i=[];for(let s=0;s<n.length;s++)i[s]=n.charCodeAt(s);e.push(i)}[_.negint.major](e,t){this[_.uint.major](e,t)}[_.bytes.major](e,t){throw new Error(`${gs} unsupported type: Uint8Array`)}[_.string.major](e,t){this.prefix(e);const n=Q7(JSON.stringify(t.value));e.push(n.length>32?Ag(n):n)}[_.array.major](e,t){this.prefix(e),this.inRecursive.push({type:_.array,elements:0}),e.push([91])}[_.map.major](e,t){this.prefix(e),this.inRecursive.push({type:_.map,elements:0}),e.push([123])}[_.tag.major](e,t){}[_.float.major](e,t){if(t.type.name==="break"){const o=this.inRecursive.pop();if(o){if(o.type===_.array)e.push([93]);else if(o.type===_.map)e.push([125]);else throw new Error("Unexpected recursive type; this should not happen!");return}throw new Error("Unexpected break; this should not happen!")}if(t.value===void 0)throw new Error(`${gs} unsupported type: undefined`);if(this.prefix(e),t.type.name==="true"){e.push([116,114,117,101]);return}else if(t.type.name==="false"){e.push([102,97,108,115,101]);return}else if(t.type.name==="null"){e.push([110,117,108,108]);return}const n=String(t.value),i=[];let s=!1;for(let o=0;o<n.length;o++)i[o]=n.charCodeAt(o),!s&&(i[o]===46||i[o]===101||i[o]===69)&&(s=!0);s||(i.push(46),i.push(48)),e.push(i)}}function $R(r,e){if(Array.isArray(r[0])||Array.isArray(e[0]))throw new Error(`${gs} complex map keys are not supported`);const t=r[0],n=e[0];if(t.type!==_.string||n.type!==_.string)throw new Error(`${gs} non-string map keys are not supported`);if(t<n)return-1;if(t>n)return 1;throw new Error(`${gs} unexpected duplicate map keys, this is not supported`)}const UR={addBreakTokens:!0,mapSorter:$R};function FR(r,e){return e=Object.assign({},UR,e),ow(r,new MR,e)}class Nw{constructor(e,t={}){this._pos=0,this.data=e,this.options=t,this.modeStack=["value"],this.lastToken=""}pos(){return this._pos}done(){return this._pos>=this.data.length}ch(){return this.data[this._pos]}currentMode(){return this.modeStack[this.modeStack.length-1]}skipWhitespace(){let e=this.ch();for(;e===32||e===9||e===13||e===10;)e=this.data[++this._pos]}expect(e){if(this.data.length-this._pos<e.length)throw new Error(`${pe} unexpected end of input at position ${this._pos}`);for(let t=0;t<e.length;t++)if(this.data[this._pos++]!==e[t])throw new Error(`${pe} unexpected token at position ${this._pos}, expected to find '${String.fromCharCode(...e)}'`)}parseNumber(){const e=this._pos;let t=!1,n=!1;const i=a=>{for(;!this.done();){const c=this.ch();if(a.includes(c))this._pos++;else break}};if(this.ch()===45&&(t=!0,this._pos++),this.ch()===48)if(this._pos++,this.ch()===46)this._pos++,n=!0;else return new G(_.uint,0,this._pos-e);if(i([48,49,50,51,52,53,54,55,56,57]),t&&this._pos===e+1)throw new Error(`${pe} unexpected token at position ${this._pos}`);if(!this.done()&&this.ch()===46){if(n)throw new Error(`${pe} unexpected token at position ${this._pos}`);n=!0,this._pos++,i([48,49,50,51,52,53,54,55,56,57])}!this.done()&&(this.ch()===101||this.ch()===69)&&(n=!0,this._pos++,!this.done()&&(this.ch()===43||this.ch()===45)&&this._pos++,i([48,49,50,51,52,53,54,55,56,57]));const s=String.fromCharCode.apply(null,this.data.subarray(e,this._pos)),o=parseFloat(s);return n?new G(_.float,o,this._pos-e):this.options.allowBigInt!==!0||Number.isSafeInteger(o)?new G(o>=0?_.uint:_.negint,o,this._pos-e):new G(o>=0?_.uint:_.negint,BigInt(s),this._pos-e)}parseString(){if(this.ch()!==34)throw new Error(`${pe} unexpected character at position ${this._pos}; this shouldn't happen`);this._pos++;for(let s=this._pos,o=0;s<this.data.length&&o<65536;s++,o++){const a=this.data[s];if(a===92||a<32||a>=128)break;if(a===34){const c=String.fromCharCode.apply(null,this.data.subarray(this._pos,s));return this._pos=s+1,new G(_.string,c,o)}}const e=this._pos,t=[],n=()=>{if(this._pos+4>=this.data.length)throw new Error(`${pe} unexpected end of unicode escape sequence at position ${this._pos}`);let s=0;for(let o=0;o<4;o++){let a=this.ch();if(a>=48&&a<=57)a-=48;else if(a>=97&&a<=102)a=a-97+10;else if(a>=65&&a<=70)a=a-65+10;else throw new Error(`${pe} unexpected unicode escape character at position ${this._pos}`);s=s*16+a,this._pos++}return s},i=()=>{const s=this.ch();let o=null,a=s>239?4:s>223?3:s>191?2:1;if(this._pos+a>this.data.length)throw new Error(`${pe} unexpected unicode sequence at position ${this._pos}`);let c,l,u,d;switch(a){case 1:s<128&&(o=s);break;case 2:c=this.data[this._pos+1],(c&192)===128&&(d=(s&31)<<6|c&63,d>127&&(o=d));break;case 3:c=this.data[this._pos+1],l=this.data[this._pos+2],(c&192)===128&&(l&192)===128&&(d=(s&15)<<12|(c&63)<<6|l&63,d>2047&&(d<55296||d>57343)&&(o=d));break;case 4:c=this.data[this._pos+1],l=this.data[this._pos+2],u=this.data[this._pos+3],(c&192)===128&&(l&192)===128&&(u&192)===128&&(d=(s&15)<<18|(c&63)<<12|(l&63)<<6|u&63,d>65535&&d<1114112&&(o=d))}o===null?(o=65533,a=1):o>65535&&(o-=65536,t.push(o>>>10&1023|55296),o=56320|o&1023),t.push(o),this._pos+=a};for(;!this.done();){const s=this.ch();let o;switch(s){case 92:if(this._pos++,this.done())throw new Error(`${pe} unexpected string termination at position ${this._pos}`);switch(o=this.ch(),this._pos++,o){case 34:case 39:case 92:case 47:t.push(o);break;case 98:t.push(8);break;case 116:t.push(9);break;case 110:t.push(10);break;case 102:t.push(12);break;case 114:t.push(13);break;case 117:t.push(n());break;default:throw new Error(`${pe} unexpected string escape character at position ${this._pos}`)}break;case 34:return this._pos++,new G(_.string,X7(t),this._pos-e);default:if(s<32)throw new Error(`${pe} invalid control character at position ${this._pos}`);s<128?(t.push(s),this._pos++):i()}}throw new Error(`${pe} unexpected end of string at position ${this._pos}`)}parseValue(){switch(this.ch()){case 123:return this.modeStack.push("obj-start"),this._pos++,new G(_.map,1/0,1);case 91:return this.modeStack.push("array-start"),this._pos++,new G(_.array,1/0,1);case 34:return this.parseString();case 110:return this.expect([110,117,108,108]),new G(_.null,null,4);case 102:return this.expect([102,97,108,115,101]),new G(_.false,!1,5);case 116:return this.expect([116,114,117,101]),new G(_.true,!0,4);case 45:case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:return this.parseNumber();default:throw new Error(`${pe} unexpected character at position ${this._pos}`)}}next(){switch(this.skipWhitespace(),this.currentMode()){case"value":return this.modeStack.pop(),this.parseValue();case"array-value":{if(this.modeStack.pop(),this.ch()===93)return this._pos++,this.skipWhitespace(),new G(_.break,void 0,1);if(this.ch()!==44)throw new Error(`${pe} unexpected character at position ${this._pos}, was expecting array delimiter but found '${String.fromCharCode(this.ch())}'`);return this._pos++,this.modeStack.push("array-value"),this.skipWhitespace(),this.parseValue()}case"array-start":return this.modeStack.pop(),this.ch()===93?(this._pos++,this.skipWhitespace(),new G(_.break,void 0,1)):(this.modeStack.push("array-value"),this.skipWhitespace(),this.parseValue());case"obj-key":if(this.ch()===125)return this.modeStack.pop(),this._pos++,this.skipWhitespace(),new G(_.break,void 0,1);if(this.ch()!==44)throw new Error(`${pe} unexpected character at position ${this._pos}, was expecting object delimiter but found '${String.fromCharCode(this.ch())}'`);this._pos++,this.skipWhitespace();case"obj-start":{if(this.modeStack.pop(),this.ch()===125)return this._pos++,this.skipWhitespace(),new G(_.break,void 0,1);const e=this.parseString();if(this.skipWhitespace(),this.ch()!==58)throw new Error(`${pe} unexpected character at position ${this._pos}, was expecting key/value delimiter ':' but found '${String.fromCharCode(this.ch())}'`);return this._pos++,this.modeStack.push("obj-value"),e}case"obj-value":return this.modeStack.pop(),this.modeStack.push("obj-key"),this.skipWhitespace(),this.parseValue();default:throw new Error(`${pe} unexpected parse state at position ${this._pos}; this shouldn't happen`)}}}function VR(r,e){return e=Object.assign({tokenizer:new Nw(r,e)},e),vi(r,e)}function zR(r){return r instanceof ArrayBuffer?new Uint8Array(r,0,r.byteLength):r}function HR(r){if(r.asCID!==r&&r["/"]!==r.bytes)return null;const e=ae.asCID(r);if(!e)return null;const t=e.toString();return[new G(_.map,1/0,1),new G(_.string,"/",1),new G(_.string,t,t.length),new G(_.break,void 0,1)]}function vd(r){const e=Br.encode(r).slice(1);return[new G(_.map,1/0,1),new G(_.string,"/",1),new G(_.map,1/0,1),new G(_.string,"bytes",5),new G(_.string,e,e.length),new G(_.break,void 0,1),new G(_.break,void 0,1)]}function zr(r){return vd(new Uint8Array(r.buffer,r.byteOffset,r.byteLength))}function qR(r){return vd(new Uint8Array(r))}function KR(){throw new Error("`undefined` is not supported by the IPLD Data Model and cannot be encoded")}function WR(r){if(Number.isNaN(r))throw new Error("`NaN` is not supported by the IPLD Data Model and cannot be encoded");if(r===1/0||r===-1/0)throw new Error("`Infinity` and `-Infinity` is not supported by the IPLD Data Model and cannot be encoded");return null}const jR={typeEncoders:{Object:HR,Buffer:vd,Uint8Array:vd,Int8Array:zr,Uint16Array:zr,Int16Array:zr,Uint32Array:zr,Int32Array:zr,Float32Array:zr,Float64Array:zr,Uint8ClampedArray:zr,BigInt64Array:zr,BigUint64Array:zr,DataView:zr,ArrayBuffer:qR,undefined:KR,number:WR}};class GR extends Nw{constructor(e,t){super(e,t),this.tokenBuffer=[]}done(){return this.tokenBuffer.length===0&&super.done()}_next(){return this.tokenBuffer.length>0?this.tokenBuffer.pop():super.next()}next(){const e=this._next();if(e.type===_.map){const t=this._next();if(t.type===_.string&&t.value==="/"){const n=this._next();if(n.type===_.string){if(this._next().type!==_.break)throw new Error("Invalid encoded CID form");return this.tokenBuffer.push(n),new G(_.tag,42,0)}if(n.type===_.map){const i=this._next();if(i.type===_.string&&i.value==="bytes"){const s=this._next();if(s.type===_.string){for(let a=0;a<2;a++)if(this._next().type!==_.break)throw new Error("Invalid encoded Bytes form");const o=Br.decode(`m${s.value}`);return new G(_.bytes,o,s.value.length)}this.tokenBuffer.push(s)}this.tokenBuffer.push(i)}this.tokenBuffer.push(n)}this.tokenBuffer.push(t)}return e}}const B0={allowIndefinite:!1,allowUndefined:!1,allowNaN:!1,allowInfinity:!1,allowBigInt:!0,strict:!0,useMaps:!1,rejectDuplicateMapKeys:!0,tags:[]};B0.tags[42]=ae.parse;const YR="dag-json",Ug=297,Dw=r=>FR(r,jR),Fg=r=>{const e=zR(r),t=Object.assign(B0,{tokenizer:new GR(e,B0)});return VR(e,t)},Sm=r=>QR.decode(Dw(r)),QR=new TextDecoder,XR=r=>Fg(ZR.encode(r)),ZR=new TextEncoder,JR=Object.freeze(Object.defineProperty({__proto__:null,code:Ug,decode:Fg,encode:Dw,format:Sm,name:YR,parse:XR,stringify:Sm},Symbol.toStringTag,{value:"Module"})),eN=new TextDecoder;function Vg(r,e){let t=0;for(let n=0;;n+=7){if(n>=64)throw new Error("protobuf: varint overflow");if(e>=r.length)throw new Error("protobuf: unexpected end of data");const i=r[e++];if(t+=n<28?(i&127)<<n:(i&127)*2**n,i<128)break}return[t,e]}function Ed(r,e){let t;[t,e]=Vg(r,e);const n=e+t;if(t<0||n<0)throw new Error("protobuf: invalid length");if(n>r.length)throw new Error("protobuf: unexpected end of data");return[r.subarray(e,n),n]}function Bw(r,e){let t;return[t,e]=Vg(r,e),[t&7,t>>3,e]}function tN(r){const e={},t=r.length;let n=0;for(;n<t;){let i,s;if([i,s,n]=Bw(r,n),s===1){if(e.Hash)throw new Error("protobuf: (PBLink) duplicate Hash section");if(i!==2)throw new Error(`protobuf: (PBLink) wrong wireType (${i}) for Hash`);if(e.Name!==void 0)throw new Error("protobuf: (PBLink) invalid order, found Name before Hash");if(e.Tsize!==void 0)throw new Error("protobuf: (PBLink) invalid order, found Tsize before Hash");[e.Hash,n]=Ed(r,n)}else if(s===2){if(e.Name!==void 0)throw new Error("protobuf: (PBLink) duplicate Name section");if(i!==2)throw new Error(`protobuf: (PBLink) wrong wireType (${i}) for Name`);if(e.Tsize!==void 0)throw new Error("protobuf: (PBLink) invalid order, found Tsize before Name");let o;[o,n]=Ed(r,n),e.Name=eN.decode(o)}else if(s===3){if(e.Tsize!==void 0)throw new Error("protobuf: (PBLink) duplicate Tsize section");if(i!==0)throw new Error(`protobuf: (PBLink) wrong wireType (${i}) for Tsize`);[e.Tsize,n]=Vg(r,n)}else throw new Error(`protobuf: (PBLink) invalid fieldNumber, expected 1, 2 or 3, got ${s}`)}if(n>t)throw new Error("protobuf: (PBLink) unexpected end of data");return e}function rN(r){const e=r.length;let t=0,n,i=!1,s;for(;t<e;){let a,c;if([a,c,t]=Bw(r,t),a!==2)throw new Error(`protobuf: (PBNode) invalid wireType, expected 2, got ${a}`);if(c===1){if(s)throw new Error("protobuf: (PBNode) duplicate Data section");[s,t]=Ed(r,t),n&&(i=!0)}else if(c===2){if(i)throw new Error("protobuf: (PBNode) duplicate Links section");n||(n=[]);let l;[l,t]=Ed(r,t),n.push(tN(l))}else throw new Error(`protobuf: (PBNode) invalid fieldNumber, expected 1 or 2, got ${c}`)}if(t>e)throw new Error("protobuf: (PBNode) unexpected end of data");const o={};return s&&(o.Data=s),o.Links=n||[],o}const Lw=new TextEncoder,xm=2**32,nN=2**31;function iN(r,e){let t=e.length;if(typeof r.Tsize=="number"){if(r.Tsize<0)throw new Error("Tsize cannot be negative");if(!Number.isSafeInteger(r.Tsize))throw new Error("Tsize too large for encoding");t=yc(e,t,r.Tsize)-1,e[t]=24}if(typeof r.Name=="string"){const n=Lw.encode(r.Name);t-=n.length,e.set(n,t),t=yc(e,t,n.length)-1,e[t]=18}return r.Hash&&(t-=r.Hash.length,e.set(r.Hash,t),t=yc(e,t,r.Hash.length)-1,e[t]=10),e.length-t}function sN(r){const e=aN(r),t=new Uint8Array(e);let n=e;if(r.Data&&(n-=r.Data.length,t.set(r.Data,n),n=yc(t,n,r.Data.length)-1,t[n]=10),r.Links)for(let i=r.Links.length-1;i>=0;i--){const s=iN(r.Links[i],t.subarray(0,n));n-=s,n=yc(t,n,s)-1,t[n]=18}return t}function oN(r){let e=0;if(r.Hash){const t=r.Hash.length;e+=1+t+ko(t)}if(typeof r.Name=="string"){const t=Lw.encode(r.Name).length;e+=1+t+ko(t)}return typeof r.Tsize=="number"&&(e+=1+ko(r.Tsize)),e}function aN(r){let e=0;if(r.Data){const t=r.Data.length;e+=1+t+ko(t)}if(r.Links)for(const t of r.Links){const n=oN(t);e+=1+n+ko(n)}return e}function yc(r,e,t){e-=ko(t);const n=e;for(;t>=nN;)r[e++]=t&127|128,t/=128;for(;t>=128;)r[e++]=t&127|128,t>>>=7;return r[e]=t,n}function ko(r){return r%2===0&&r++,Math.floor((cN(r)+6)/7)}function cN(r){let e=0;return r>=xm&&(r=Math.floor(r/xm),e=32),r>=65536&&(r>>>=16,e+=16),r>=256&&(r>>>=8,e+=8),e+lN[r]}const lN=[0,1,2,2,3,3,3,3,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8],uN=["Data","Links"],dN=["Hash","Name","Tsize"],L0=new TextEncoder;function Ow(r,e){if(r===e)return 0;const t=r.Name?L0.encode(r.Name):[],n=e.Name?L0.encode(e.Name):[];let i=t.length,s=n.length;for(let o=0,a=Math.min(i,s);o<a;++o)if(t[o]!==n[o]){i=t[o],s=n[o];break}return i<s?-1:s<i?1:0}function Am(r,e){return!Object.keys(r).some(t=>!e.includes(t))}function Mw(r){if(typeof r.asCID=="object"){const t=ae.asCID(r);if(!t)throw new TypeError("Invalid DAG-PB form");return{Hash:t}}if(typeof r!="object"||Array.isArray(r))throw new TypeError("Invalid DAG-PB form");const e={};if(r.Hash){let t=ae.asCID(r.Hash);try{t||(typeof r.Hash=="string"?t=ae.parse(r.Hash):r.Hash instanceof Uint8Array&&(t=ae.decode(r.Hash)))}catch(n){throw new TypeError(`Invalid DAG-PB form: ${n.message}`)}t&&(e.Hash=t)}if(!e.Hash)throw new TypeError("Invalid DAG-PB form");return typeof r.Name=="string"&&(e.Name=r.Name),typeof r.Tsize=="number"&&(e.Tsize=r.Tsize),e}function kr(r){if((r instanceof Uint8Array||typeof r=="string")&&(r={Data:r}),typeof r!="object"||Array.isArray(r))throw new TypeError("Invalid DAG-PB form");const e={};if(r.Data!==void 0)if(typeof r.Data=="string")e.Data=L0.encode(r.Data);else if(r.Data instanceof Uint8Array)e.Data=r.Data;else throw new TypeError("Invalid DAG-PB form");if(r.Links!==void 0)if(Array.isArray(r.Links))e.Links=r.Links.map(Mw),e.Links.sort(Ow);else throw new TypeError("Invalid DAG-PB form");else e.Links=[];return e}function $w(r){if(!r||typeof r!="object"||Array.isArray(r)||r instanceof Uint8Array||r["/"]&&r["/"]===r.bytes)throw new TypeError("Invalid DAG-PB form");if(!Am(r,uN))throw new TypeError("Invalid DAG-PB form (extraneous properties)");if(r.Data!==void 0&&!(r.Data instanceof Uint8Array))throw new TypeError("Invalid DAG-PB form (Data must be bytes)");if(!Array.isArray(r.Links))throw new TypeError("Invalid DAG-PB form (Links must be a list)");for(let e=0;e<r.Links.length;e++){const t=r.Links[e];if(!t||typeof t!="object"||Array.isArray(t)||t instanceof Uint8Array||t["/"]&&t["/"]===t.bytes)throw new TypeError("Invalid DAG-PB form (bad link)");if(!Am(t,dN))throw new TypeError("Invalid DAG-PB form (extraneous properties on link)");if(t.Hash===void 0)throw new TypeError("Invalid DAG-PB form (link must have a Hash)");if(t.Hash==null||!t.Hash["/"]||t.Hash["/"]!==t.Hash.bytes)throw new TypeError("Invalid DAG-PB form (link Hash must be a CID)");if(t.Name!==void 0&&typeof t.Name!="string")throw new TypeError("Invalid DAG-PB form (link Name must be a string)");if(t.Tsize!==void 0){if(typeof t.Tsize!="number"||t.Tsize%1!==0)throw new TypeError("Invalid DAG-PB form (link Tsize must be an integer)");if(t.Tsize<0)throw new TypeError("Invalid DAG-PB form (link Tsize cannot be negative)")}if(e>0&&Ow(t,r.Links[e-1])===-1)throw new TypeError("Invalid DAG-PB form (links must be sorted by Name bytes)")}}function hN(r,e=[]){return kr({Data:r,Links:e})}function fN(r,e,t){return Mw({Hash:t,Name:r,Tsize:e})}function pN(r){return r instanceof ArrayBuffer?new Uint8Array(r,0,r.byteLength):r}const gN="dag-pb",Rn=112;function pt(r){$w(r);const e={};return r.Links&&(e.Links=r.Links.map(t=>{const n={};return t.Hash&&(n.Hash=t.Hash.bytes),t.Name!==void 0&&(n.Name=t.Name),t.Tsize!==void 0&&(n.Tsize=t.Tsize),n})),r.Data&&(e.Data=r.Data),sN(e)}function cn(r){const e=pN(r),t=rN(e),n={};return t.Data&&(n.Data=t.Data),t.Links&&(n.Links=t.Links.map(i=>{const s={};try{s.Hash=ae.decode(i.Hash)}catch{}if(!s.Hash)throw new Error("Invalid Hash field found in link, expected CID");return i.Name!==void 0&&(s.Name=i.Name),i.Tsize!==void 0&&(s.Tsize=i.Tsize),s})),n}const kl=Object.freeze(Object.defineProperty({__proto__:null,code:Rn,createLink:fN,createNode:hN,decode:cn,encode:pt,name:gN,prepare:kr,validate:$w},Symbol.toStringTag,{value:"Module"}));function zg(r){return r?.then!=null}function mN(r=[],e){const t={[Rn]:kl,[sn]:p8,[$g]:OR,[Ug]:JR,[Vp]:jx};return r.forEach(n=>{t[n.code]=n}),async n=>{let i=t[n];if(i==null&&e!=null){const s=e(n);zg(s)?i=await s:i=s,t[i.code]=i}if(i!=null)return i;throw new dR(`Could not load codec for ${n}`)}}function yN(r=[],e){const t={[Et.code]:Et,[k4.code]:k4,[jn.code]:jn};return r.forEach(n=>{t[n.code]=n}),async n=>{let i=t[n];if(i==null&&e!=null){const s=e(n);zg(s)?i=await s:i=s,t[i.code]=i}if(i!=null)return i;throw new uR(`No hasher configured for multihash code 0x${n.toString(16)}, please configure one. You can look up which hash this is at https://github.com/multiformats/multicodec/blob/master/table.csv`)}}let Hg=class O0 extends Error{static name="NotFoundError";static code="ERR_NOT_FOUND";name=O0.name;code=O0.code;constructor(e="Not Found"){super(e)}};class Uw{has(e,t){return Promise.reject(new Error(".has is not implemented"))}put(e,t,n){return Promise.reject(new Error(".put is not implemented"))}async*putMany(e,t){for await(const{cid:n,bytes:i}of e)await this.put(n,i,t),yield n}get(e,t){throw new Error(".get is not implemented")}async*getMany(e,t){for await(const n of e)yield{cid:n,bytes:this.get(n,t)}}delete(e,t){return Promise.reject(new Error(".delete is not implemented"))}async*deleteMany(e,t){for await(const n of e)await this.delete(n,t),yield n}async*getAll(e){throw new Error(".getAll is not implemented")}}const du=0;class hu extends Error{static name="IdentityHashDigestTooLongError";name="IdentityHashDigestTooLongError"}class wN extends Uw{child;maxDigestLength;constructor(e,t){super(),this.child=e,this.maxDigestLength=t?.maxDigestLength}put(e,t,n){if(e.multihash.code===du){if(this.maxDigestLength!=null&&e.multihash.digest.byteLength>this.maxDigestLength)throw new hu(`Identity digest too long - ${e.multihash.digest.byteLength} > this.maxDigestLength`);return n?.signal?.throwIfAborted(),e}return this.child==null?(n?.signal?.throwIfAborted(),e):this.child.put(e,t,n)}*get(e,t){if(e.multihash.code===du){if(this.maxDigestLength!=null&&e.multihash.digest.byteLength>this.maxDigestLength)throw new hu(`Identity digest too long - ${e.multihash.digest.byteLength} > this.maxDigestLength`);t?.signal?.throwIfAborted(),yield e.multihash.digest;return}if(this.child==null)throw t?.signal?.throwIfAborted(),new Hg;yield*this.child.get(e,t)}has(e,t){if(e.multihash.code===du){if(this.maxDigestLength!=null&&e.multihash.digest.byteLength>this.maxDigestLength)throw new hu(`Identity digest too long - ${e.multihash.digest.byteLength} > this.maxDigestLength`);return t?.signal?.throwIfAborted(),!0}return this.child==null?(t?.signal?.throwIfAborted(),!1):this.child.has(e,t)}delete(e,t){if(e.code===du){if(this.maxDigestLength!=null&&e.multihash.digest.byteLength>this.maxDigestLength)throw new hu(`Identity digest too long - ${e.multihash.digest.byteLength} > this.maxDigestLength`);t?.signal?.throwIfAborted();return}if(this.child!=null)return this.child.delete(e,t)}*getAll(e){this.child!=null&&(yield*this.child.getAll(e)),e?.signal?.throwIfAborted()}}function qg(r){const[e,t]=r[Symbol.asyncIterator]!=null?[r[Symbol.asyncIterator](),Symbol.asyncIterator]:[r[Symbol.iterator](),Symbol.iterator],n=[];return{peek:()=>e.next(),push:i=>{n.push(i)},next:()=>n.length>0?{done:!1,value:n.shift()}:e.next(),[t](){return this}}}function bN(r){return r[Symbol.asyncIterator]!=null}function bi(r,e){let t=0;if(bN(r))return(async function*(){for await(const c of r)await e(c,t++)&&(yield c)})();const n=qg(r),{value:i,done:s}=n.next();if(s===!0)return(function*(){})();const o=e(i,t++);if(typeof o.then=="function")return(async function*(){await o&&(yield i);for(const c of n)await e(c,t++)&&(yield c)})();const a=e;return(function*(){o===!0&&(yield i);for(const c of n)a(c,t++)&&(yield c)})()}function vN(r){return r[Symbol.asyncIterator]!=null}function km(r){return r?.then!=null}function Cm(r,e){let t=0;if(vN(r))return(async function*(){for await(const c of r){const l=e(c,t++);km(l)&&await l,yield c}})();const n=qg(r),{value:i,done:s}=n.next();if(s===!0)return(function*(){})();const o=e(i,t++);if(typeof o?.then=="function")return(async function*(){await o,yield i;for(const c of n){const l=e(c,t++);km(l)&&await l,yield c}})();const a=e;return(function*(){yield i;for(const c of n)a(c,t++),yield c})()}const EN=128;class Fw{child;getHasher;log;logger;components;constructor(e,t={}){this.log=e.logger.forComponent("helia:networked-storage"),this.logger=e.logger,this.components=e,this.child=new wN(e.blockstore,{maxDigestLength:t.maxIdentityHashDigestLength??EN}),this.getHasher=e.getHasher}async put(e,t,n={}){return await this.child.has(e,n)?(n.onProgress?.(new oe("blocks:put:duplicate",e)),e):(n.onProgress?.(new oe("blocks:put:providers:notify",e)),await Promise.all(this.components.blockBrokers.map(async i=>i.announce?.(e,n))),n.onProgress?.(new oe("blocks:put:blockstore:put",e)),this.child.put(e,t,n))}async*putMany(e,t={}){const n=bi(e,async({cid:s})=>{const o=await this.child.has(s,t);return o&&t.onProgress?.(new oe("blocks:put-many:duplicate",s)),!o}),i=Cm(n,async({cid:s})=>{t.onProgress?.(new oe("blocks:put-many:providers:notify",s)),await Promise.all(this.components.blockBrokers.map(async o=>o.announce?.(s,t)))});t.onProgress?.(new oe("blocks:put-many:blockstore:put-many")),yield*this.child.putMany(i,t)}async*get(e,t={}){const n=await this.child.has(e,t),i=t.offline===!0;if(!n){if(i)throw new gm("The block was present in the blockstore and the node is running offline so cannot fetch it");const s=await this.getHasher(e.multihash.code);t?.signal?.throwIfAborted(),t.onProgress?.(new oe("blocks:get:providers:get",e));const o=await Im(e,this.components.blockBrokers,s,{...t,log:this.log});t.onProgress?.(new oe("blocks:get:blockstore:put",e)),await this.child.put(e,o,t),t.onProgress?.(new oe("blocks:get:providers:notify",e)),await Promise.all(this.components.blockBrokers.map(async a=>a.announce?.(e,t))),yield o;return}t.onProgress?.(new oe("blocks:get:blockstore:get",e)),yield*this.child.get(e,t)}async*getMany(e,t={}){t.onProgress?.(new oe("blocks:get-many:blockstore:get-many")),yield*this.child.getMany(Cm(e,async n=>{const i=await this.child.has(n,t),s=t.offline===!0;if(!i){if(s)throw new gm("The block was present in the blockstore and the node is running offline so cannot fetch it");const o=await this.getHasher(n.multihash.code);t?.signal?.throwIfAborted(),t.onProgress?.(new oe("blocks:get-many:providers:get",n));const a=await Im(n,this.components.blockBrokers,o,{...t,log:this.log});t.onProgress?.(new oe("blocks:get-many:blockstore:put",n)),await this.child.put(n,a,t),t.onProgress?.(new oe("blocks:get-many:providers:notify",n)),await Promise.all(this.components.blockBrokers.map(async c=>c.announce?.(n,t)))}}))}async delete(e,t={}){t.onProgress?.(new oe("blocks:delete:blockstore:delete",e)),await this.child.delete(e,t)}async*deleteMany(e,t={}){t.onProgress?.(new oe("blocks:delete-many:blockstore:delete-many")),yield*this.child.deleteMany((async function*(){for await(const n of e)yield n})(),t)}async has(e,t={}){return this.child.has(e,t)}async*getAll(e={}){e.onProgress?.(new oe("blocks:get-all:blockstore:get-many")),yield*this.child.getAll(e)}}class SN extends Fw{started;constructor(e,t={}){super(e,t),this.started=!1}isStarted(){return this.started}async start(){await Cn(this.child,...this.components.blockBrokers),this.started=!0}async stop(){await ni(this.child,...this.components.blockBrokers),this.started=!1}unwrap(){return this.child}createSession(e,t){const n=this.components.blockBrokers.map(i=>i.createSession==null?i:i.createSession(t));return new xN({blockstore:this.child,blockBrokers:n,getHasher:this.getHasher,logger:this.logger},{root:e})}}class xN extends Fw{closeController;constructor(e,t){super(e),this.closeController=new AbortController,this.closeController.signal,this.log=e.logger.forComponent(`helia:session-storage:${t.root}`)}close(){this.closeController.abort()}async put(e,t,n={}){const i=Ke([this.closeController.signal,n.signal]);try{return await super.put(e,t,{...n,signal:i})}finally{i.clear()}}async*putMany(e,t={}){const n=Ke([this.closeController.signal,t.signal]);try{yield*super.putMany(e,{...t,signal:n})}finally{n.clear()}}async*get(e,t={}){const n=Ke([this.closeController.signal,t.signal]);try{yield*super.get(e,{...t,signal:n})}finally{n.clear()}}async*getMany(e,t={}){const n=Ke([this.closeController.signal,t.signal]);try{yield*super.getMany(e,{...t,signal:n})}finally{n.clear()}}async delete(e,t={}){const n=Ke([this.closeController.signal,t.signal]);try{await super.delete(e,{...t,signal:n})}finally{n.clear()}}async*deleteMany(e,t={}){const n=Ke([this.closeController.signal,t.signal]);try{yield*super.deleteMany(e,{...t,signal:n})}finally{n.clear()}}async has(e,t={}){const n=Ke([this.closeController.signal,t.signal]);try{return await super.has(e,{...t,signal:n})}finally{n.clear()}}async*getAll(e={}){const t=Ke([this.closeController.signal,e.signal]);try{yield*super.getAll({...e,signal:t})}finally{t.clear()}}}function AN(r){return typeof r.retrieve=="function"}const kN=(r,e)=>{if(e==null)throw new H(`No hasher configured for multihash code 0x${r.multihash.code.toString(16)}, please configure one. You can look up which hash this is at https://github.com/multiformats/multicodec/blob/master/table.csv`);return async t=>{let n;const i=e.digest(t,{truncate:r.multihash.digest.byteLength});if(zg(i)?n=await i:n=i,!Te(n.digest,r.multihash.digest))throw new Op("Hash of downloaded block did not match multihash from passed CID")}};async function Im(r,e,t,n){const i=kN(r,t),s=new AbortController,o=Ke([s.signal,n.signal]);s.signal;const a=[];for(const c of e)AN(c)&&a.push(c);if(a.length===0)throw new nR(`No block brokers capable of retrieving blocks are configured, the CID ${r} cannot be fetched from the network`);try{return await Promise.any(a.map(async c=>{try{let l=!1;const u=await c.retrieve(r,{...n,signal:o,validateFn:async d=>{await i(d),n.signal?.throwIfAborted(),l=!0}});return l||(await i(u),n.signal?.throwIfAborted()),u}catch(l){throw n.log.error("could not retrieve verified block for %c - %e",r,l),l}}))}catch(c){throw new sR(c.errors,`Failed to load block for ${r}`)}finally{s.abort(),o.clear()}}class Vw extends Qe{initialPeerSearchComplete;requests;name;log;logger;minProviders;maxProviders;providers;evictionFilter;initialProviders;constructor(e,t){super(),this.name=t.name,this.logger=e.logger,this.log=e.logger.forComponent(this.name),this.requests=new Map,this.minProviders=t.minProviders??aR,this.maxProviders=t.maxProviders??cR,this.providers=[],this.evictionFilter=Mi(this.maxProviders),this.initialProviders=t.providers??[]}async retrieve(e,t={}){const n=Br.encode(e.multihash.bytes),i=this.requests.get(n);if(i!=null)return this.log("join existing request for %c",e),i;const s=Ze();if(this.requests.set(n,s.promise),this.providers.length===0){let u=!1;this.initialPeerSearchComplete==null&&(u=!0,this.log=this.logger.forComponent(`${this.name}:${e}`),this.initialPeerSearchComplete=this.findProviders(e,this.minProviders,t));try{await Yt(this.initialPeerSearchComplete,t.signal),u&&this.log("found initial session peers for %c",e)}catch(d){throw u&&this.log("failed to find initial session peers for %c - %e",e,d),this.requests.delete(n),s.reject(d),d}}let o=!1;const a=new $i({concurrency:this.maxProviders});a.addEventListener("failure",u=>{this.log.error("error querying provider %s, evicting from session - %e",u.detail.job.options.provider,u.detail.error),this.evict(u.detail.job.options.provider)}),a.addEventListener("success",u=>{o=!0,s.resolve(u.detail.result)}),a.addEventListener("idle",()=>{if(o){this.log.trace("session idle, found block");return}if(t.signal?.aborted===!0){this.log.trace("session idle, signal aborted");return}Promise.resolve().then(async()=>{this.log("no session peers had block for for %c, finding new providers",e);for(let u=0;u<this.minProviders&&this.providers.length!==0;u++){const d=this.providers[Math.floor(Math.random()*this.providers.length)];this.evict(d)}await this.findProviders(e,this.minProviders,t),this.log("found new providers re-retrieving %c",e),this.requests.delete(n),s.resolve(await this.retrieve(e,t))}).catch(u=>{this.log.error("could not find new providers for %c - %e",e,u),s.reject(u)})});const c=u=>{a.add(async()=>this.queryProvider(e,u.detail,t),{provider:u.detail}).catch(d=>{t.signal?.aborted!==!0&&this.log.error("error retrieving session block for %c - %e",e,d)})};this.addEventListener("provider",c),Promise.all([...this.providers].map(async u=>a.add(async()=>this.queryProvider(e,u,t),{provider:u}))).catch(u=>{t.signal?.aborted!==!0&&this.log.error("error retrieving session block for %c - %e",e,u)});const l=()=>{s.reject(new ys(t.signal?.reason??"Session aborted")),a.abort()};t.signal?.addEventListener("abort",l);try{return await Yt(s.promise,t.signal)}finally{this.removeEventListener("provider",c),t.signal?.removeEventListener("abort",l),a.clear(),this.requests.delete(n)}}evict(e){this.evictionFilter.add(this.toEvictionKey(e));const t=this.providers.findIndex(n=>this.equals(n,e));t!==-1&&this.providers.splice(t,1)}isEvicted(e){return this.evictionFilter.has(this.toEvictionKey(e))}hasProvider(e){return!!(this.providers.find(t=>this.equals(t,e))!=null||this.isEvicted(e))}async findProviders(e,t,n){const i=Ze();let s=0;return Promise.resolve().then(async()=>{if(this.log("finding %d-%d new provider(s) for %c",t,this.maxProviders,e),this.initialProviders.length>0)for(;s<t&&this.initialProviders.length>0;){const o=this.initialProviders.pop();if(o==null)break;const a=await this.convertToProvider(o,n);if(n.signal?.aborted===!0)break;if(a!=null&&!this.hasProvider(a)&&(this.log("found %d/%d new providers",s,this.maxProviders),this.providers.push(a),this.safeDispatchEvent("provider",{detail:a}),s++,s===t&&(this.log("session is ready"),i.resolve()),this.providers.length===this.maxProviders)){this.log("found max session peers",s);break}}if(s<this.maxProviders)for await(const o of this.findNewProviders(e,n)){if(s===this.maxProviders||n.signal?.aborted===!0)break;if(!this.hasProvider(o)&&(this.log("found %d/%d new providers",s,this.maxProviders),this.providers.push(o),this.safeDispatchEvent("provider",{detail:o}),s++,s===t&&(this.log("session is ready"),i.resolve()),this.providers.length===this.maxProviders)){this.log("found max session peers",s);break}}if(this.log("found %d/%d new session peers",s,this.maxProviders),s<t)throw new lR(`Found ${s} of ${t} ${this.name} providers for ${e}`)}).catch(o=>{this.log.error("error searching routing for potential session peers for %c - %e",e,o),i.reject(o)}),i.promise}}class CN{libp2p;blockstore;datastore;events;pins;logger;routing;getCodec;getHasher;dns;metrics;log;constructor(e){this.logger=e.logger??gl(),this.log=this.logger.forComponent("helia"),this.getHasher=yN(e.hashers,e.loadHasher),this.getCodec=mN(e.codecs,e.loadCodec),this.dns=e.dns??x8(),this.metrics=e.metrics,this.libp2p=e.libp2p,this.events=new Qe;const t={blockstore:e.blockstore,datastore:e.datastore,logger:this.logger,libp2p:this.libp2p,blockBrokers:[],getHasher:this.getHasher,getCodec:this.getCodec,dns:this.dns,metrics:this.metrics,...e.components??{}};this.routing=t.routing=new fR(t,{routers:(e.routers??[]).flatMap(i=>{typeof i=="function"&&(i=i(t));const s=[i],o=IN(i);o!=null&&s.push(o);const a=_N(i);return a!=null&&s.push(a),s}),providerLookupConcurrency:e.providerLookupConcurrency});const n=new SN(t,e);this.pins=new oR(e.datastore,n,this.getCodec),this.blockstore=new kR(n,this.pins,{holdGcLock:e.holdGcLock??!0}),this.datastore=e.datastore,t.blockBrokers=e.blockBrokers.map(i=>i(t))}async start(){await CR(this.datastore),await Cn(this.blockstore,this.datastore,this.routing,this.libp2p),this.events.dispatchEvent(new CustomEvent("start",{detail:this}))}async stop(){await ni(this.blockstore,this.datastore,this.routing,this.libp2p),this.events.dispatchEvent(new CustomEvent("stop",{detail:this}))}async gc(e={}){const t=await this.blockstore.lock.writeLock();try{const n=this,i=this.blockstore.unwrap();this.log("gc start"),await Li(i.deleteMany((async function*(){for await(const{cid:s}of i.getAll())try{if(await n.pins.isPinned(s,e))continue;yield s,e.onProgress?.(new oe("helia:gc:deleted",s))}catch(o){n.log.error("error during gc - %e",o),e.onProgress?.(new oe("helia:gc:error",o))}})()))}finally{t()}this.log("gc finished")}}function IN(r){return r?.[Rc]}function _N(r){return r?.[Nc]}function TN(r){return r[Symbol.asyncIterator]!=null}function Ki(r,e){let t=0;if(TN(r))return(async function*(){for await(const c of r)yield e(c,t++)})();const n=qg(r),{value:i,done:s}=n.next();if(s===!0)return(function*(){})();const o=e(i,t++);if(typeof o.then=="function")return(async function*(){yield await o;for(const c of n)yield e(c,t++)})();const a=e;return(function*(){yield o;for(const c of n)yield a(c,t++)})()}function PN(r){return r[Symbol.asyncIterator]!=null}function Sd(r,e){return PN(r)?(async function*(){let t=0;if(!(e<1)){for await(const n of r)if(yield n,t++,t===e)return}})():(function*(){let t=0;if(!(e<1)){for(const n of r)if(yield n,t++,t===e)return}})()}const fu="/ipfs/bitswap/1.2.0",RN=1024,NN=1024,DN=1024,BN=5e3,LN=10,ON=50,MN=!1,$N=3,zw=1024*1024*4,UN=zw;var At;(function(r){r.WantBlock="WantBlock",r.WantHave="WantHave"})(At||(At={}));var M0;(function(r){r[r.WantBlock=0]="WantBlock",r[r.WantHave=1]="WantHave"})(M0||(M0={}));(function(r){r.codec=()=>sr(M0)})(At||(At={}));var Gc;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.cid!=null&&t.cid.byteLength>0&&(n.uint32(10),n.bytes(t.cid)),t.priority!=null&&t.priority!==0&&(n.uint32(16),n.int32(t.priority)),t.cancel!=null&&(n.uint32(24),n.bool(t.cancel)),t.wantType!=null&&(n.uint32(32),At.codec().encode(t.wantType,n)),t.sendDontHave!=null&&(n.uint32(40),n.bool(t.sendDontHave)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{const s={cid:Re(0),priority:0},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.cid=t.bytes();break}case 2:{s.priority=t.int32();break}case 3:{s.cancel=t.bool();break}case 4:{s.wantType=At.codec().decode(t);break}case 5:{s.sendDontHave=t.bool();break}default:{t.skipType(a&7);break}}}return s})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ae(t,r.codec(),n)})(Gc||(Gc={}));var xd;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,i={})=>{if(i.lengthDelimited!==!1&&n.fork(),t.entries!=null)for(const s of t.entries)n.uint32(10),Gc.codec().encode(s,n);t.full!=null&&(n.uint32(16),n.bool(t.full)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{const s={entries:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{if(i.limits?.entries!=null&&s.entries.length===i.limits.entries)throw new Mt('Decode error - map field "entries" had too many elements');s.entries.push(Gc.codec().decode(t,t.uint32(),{limits:i.limits?.entries$}));break}case 2:{s.full=t.bool();break}default:{t.skipType(a&7);break}}}return s})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ae(t,r.codec(),n)})(xd||(xd={}));var Yc;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.prefix!=null&&t.prefix.byteLength>0&&(n.uint32(10),n.bytes(t.prefix)),t.data!=null&&t.data.byteLength>0&&(n.uint32(18),n.bytes(t.data)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{const s={prefix:Re(0),data:Re(0)},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.prefix=t.bytes();break}case 2:{s.data=t.bytes();break}default:{t.skipType(a&7);break}}}return s})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ae(t,r.codec(),n)})(Yc||(Yc={}));var Sn;(function(r){r.HaveBlock="HaveBlock",r.DoNotHaveBlock="DoNotHaveBlock"})(Sn||(Sn={}));var Ad;(function(r){r[r.HaveBlock=0]="HaveBlock",r[r.DoNotHaveBlock=1]="DoNotHaveBlock"})(Ad||(Ad={}));(function(r){r.codec=()=>sr(Ad)})(Sn||(Sn={}));var Qc;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.cid!=null&&t.cid.byteLength>0&&(n.uint32(10),n.bytes(t.cid)),t.type!=null&&Ad[t.type]!==0&&(n.uint32(16),Sn.codec().encode(t.type,n)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{const s={cid:Re(0),type:Sn.HaveBlock},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.cid=t.bytes();break}case 2:{s.type=Sn.codec().decode(t);break}default:{t.skipType(a&7);break}}}return s})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ae(t,r.codec(),n)})(Qc||(Qc={}));var Xc;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,i={})=>{if(i.lengthDelimited!==!1&&n.fork(),t.wantlist!=null&&(n.uint32(10),xd.codec().encode(t.wantlist,n)),t.blocks!=null)for(const s of t.blocks)n.uint32(26),Yc.codec().encode(s,n);if(t.blockPresences!=null)for(const s of t.blockPresences)n.uint32(34),Qc.codec().encode(s,n);t.pendingBytes!=null&&t.pendingBytes!==0&&(n.uint32(40),n.int32(t.pendingBytes)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{const s={blocks:[],blockPresences:[],pendingBytes:0},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.wantlist=xd.codec().decode(t,t.uint32(),{limits:i.limits?.wantlist});break}case 3:{if(i.limits?.blocks!=null&&s.blocks.length===i.limits.blocks)throw new Mt('Decode error - map field "blocks" had too many elements');s.blocks.push(Yc.codec().decode(t,t.uint32(),{limits:i.limits?.blocks$}));break}case 4:{if(i.limits?.blockPresences!=null&&s.blockPresences.length===i.limits.blockPresences)throw new Mt('Decode error - map field "blockPresences" had too many elements');s.blockPresences.push(Qc.codec().decode(t,t.uint32(),{limits:i.limits?.blockPresences$}));break}case 5:{s.pendingBytes=t.int32();break}default:{t.skipType(a&7);break}}}return s})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ae(t,r.codec(),n)})(Xc||(Xc={}));function FN(r,e){for(const[t,n]of e.wantlist.entries()){const i=r.wantlist.get(t);i!=null&&(i.priority>n.priority&&(n.priority=i.priority),n.cancel=n.cancel??i.cancel,n.wantType=n.wantType??i.wantType,n.sendDontHave=n.sendDontHave??i.sendDontHave),r.wantlist.set(t,n)}for(const[t,n]of e.blockPresences.entries())r.blockPresences.set(t,n);for(const[t,n]of e.blocks.entries())r.blocks.set(t,n);return e.full&&!r.full&&(r.full=!0),r}class VN extends Error{static name="BlockTooLargeError";constructor(e="Block too large"){super(e),this.name="BlockTooLargeError"}}const zN=4193648,HN=zN+16;function*qN(r,e){const t=[...r.wantlist.values()],n=[...r.blockPresences.values()],i=[...r.blocks.values()];let s=0,o=0,a=0,c=!1;for(;;){const l={wantlist:{full:r.full??!1,entries:[]},blockPresences:[],blocks:[],pendingBytes:0};let u=Xc.encode(l).byteLength,{added:d,hasMore:h,newSize:f}=N1(i,l.blocks,a,e,u,KN);a+=d,u=f;const y=h;({added:d,hasMore:h,newSize:f}=N1(n,l.blockPresences,o,e,u,WN)),o+=d,u=f;const m=h;if({added:d,hasMore:h,newSize:f}=N1(t,l.wantlist.entries,s,e,u,jN),s+=d,u=f,c=!y&&!m&&!h,c||(l.wantlist.full=!1),yield Xc.encode(l),c)break}}function N1(r,e,t,n,i,s){let o=0,a=!1;for(let c=t;c<r.length;c++){const l=r[c],u=s(l);if(u>HN)throw new VN("Cannot send block as after encoding it is over the max message size");const d=i+u;if(d>n){a=!0;break}e.push(l),o++,i=d}return{hasMore:a,added:o,newSize:i}}function KN(r){return Kg(3,Yc.encode(r))}function WN(r){return Kg(4,Qc.encode(r))}function jN(r){return Kg(1,Gc.encode(r))}function Kg(r,e){const t=et(r),n=et(e.byteLength);return t+n+e.byteLength}let GN=class extends Qe{log;libp2p;routing;protocols;running;maxInboundStreams;maxOutboundStreams;messageReceiveTimeout;registrarIds;metrics;sendQueue;runOnLimitedConnections;maxOutgoingMessageSize;maxIncomingMessageSize;constructor(e,t={}){super(),this.log=e.logger.forComponent("helia:bitswap:network"),this.libp2p=e.libp2p,this.routing=e.routing,this.protocols=t.protocols??[fu],this.registrarIds=[],this.running=!1,this._onStream=this._onStream.bind(this),this.maxInboundStreams=t.maxInboundStreams??NN,this.maxOutboundStreams=t.maxOutboundStreams??DN,this.messageReceiveTimeout=t.messageReceiveTimeout??BN,this.runOnLimitedConnections=t.runOnLimitedConnections??MN,this.maxIncomingMessageSize=t.maxIncomingMessageSize??zw,this.maxOutgoingMessageSize=t.maxOutgoingMessageSize??t.maxIncomingMessageSize??UN,this.metrics={blocksSent:e.metrics?.registerCounter("helia_bitswap_sent_blocks_total"),dataSent:e.metrics?.registerCounter("helia_bitswap_sent_data_bytes_total")},this.sendQueue=new Fi({concurrency:t.messageSendConcurrency??ON,metrics:e.metrics,metricName:"helia_bitswap_message_send_queue"})}async start(){if(this.running)return;this.running=!0,await this.libp2p.handle(this.protocols,this._onStream,{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:this.runOnLimitedConnections});const e={onConnect:t=>{this.safeDispatchEvent("peer:connected",{detail:t})},onDisconnect:t=>{this.safeDispatchEvent("peer:disconnected",{detail:t})}};this.registrarIds=[];for(const t of this.protocols)this.registrarIds.push(await this.libp2p.register(t,e));this.libp2p.getConnections().forEach(t=>{this.safeDispatchEvent("peer:connected",{detail:t.remotePeer})})}async stop(){if(this.running=!1,await this.libp2p.unhandle(this.protocols),this.registrarIds!=null){for(const e of this.registrarIds)this.libp2p.unregister(e);this.registrarIds=[]}}_onStream(e,t){this.running&&Promise.resolve().then(async()=>{this.log("incoming new bitswap %s stream from %p",e.protocol,t.remotePeer);const n=()=>{e.status==="open"?e.abort(new Lh(`Incoming Bitswap stream timed out after ${this.messageReceiveTimeout}ms`)):this.log("stream aborted with status %s",e.status)};let i=AbortSignal.timeout(this.messageReceiveTimeout);i.addEventListener("abort",n),await e.close({signal:i});const s=ii();e.addEventListener("message",o=>{s.push(o.data)}),e.addEventListener("remoteCloseWrite",()=>{s.end()}),e.addEventListener("close",o=>{o.error!=null&&s.end(o.error)});for await(const o of wd(s,{maxDataLength:this.maxIncomingMessageSize}))try{const a=Xc.decode(o);this.log("incoming new bitswap %s message from %p on stream",e.protocol,t.remotePeer,e.id),this.safeDispatchEvent("bitswap:message",{detail:{peer:t.remotePeer,message:a}}),i.removeEventListener("abort",n),i=AbortSignal.timeout(this.messageReceiveTimeout),i.addEventListener("abort",n)}catch(a){this.log.error("error reading incoming bitswap message from %p on stream - %e",t.remotePeer,e.id,a),e.abort(a);break}}).catch(n=>{this.log.error("error handling incoming stream from %p - %e",t.remotePeer,n),e.abort(n)})}async*findProviders(e,t){t?.onProgress?.(new oe("bitswap:find-providers",e));for await(const n of this.routing.findProviders(e,t)){if(!await this.libp2p.isDialable(n.multiaddrs,{runOnLimitedConnection:this.runOnLimitedConnections})){this.log("skipping peer %p as they are not dialable - %a[]",n.id,n.multiaddrs);continue}t?.onProgress?.(new oe("bitswap:found-provider",{type:"bitswap",cid:e,provider:n,routing:n.routing})),yield n}}async findAndConnect(e,t){t?.providers!=null&&await Promise.all(t.providers.map(async n=>this.connectTo(n).catch(i=>{this.log.error("could not connect to supplied provider - %e",i)}))),await Li(Ki(Sd(this.findProviders(e,t),t?.maxProviders??$N),async n=>this.connectTo(n.id,t))).catch(n=>{this.log.error(n)})}async sendMessage(e,t,n){if(!this.running)throw new Error("network isn't running");const i=this.sendQueue.queue.find(s=>e.equals(s.options.peerId)&&s.status==="queued");if(i!=null){i.options.message=FN(i.options.message,t),await i.join({signal:n?.signal});return}await this.sendQueue.add(async s=>{const o=s?.message;if(o==null)throw new H("No message to send");this.log("sendMessage to %p",e),s?.onProgress?.(new oe("bitswap:network:send-wantlist",e));const a=await this.libp2p.dialProtocol(e,fu,s);await a.closeRead();try{for(const c of qN(o,this.maxOutgoingMessageSize))a.send(jc.single(c))||await a.onDrain(s);await a.close(s)}catch(c){s?.onProgress?.(new oe("bitswap:network:send-wantlist:error",{peer:e,error:c})),this.log.error("error sending message to %p - %e",e,c),a.abort(c)}this._updateSentStats(o.blocks)},{peerId:e,signal:n?.signal,message:t})}async connectTo(e,t){if(!this.running)throw new Po("Network isn't running");t?.onProgress?.(new oe("bitswap:network:dial",e));const[n]=await Promise.all([this.libp2p.dial(e,t),bn(this.libp2p,"peer:identify",t?.signal,{filter:i=>{if(!i.detail.peerId.equals(e))return!1;if(i.detail.protocols.includes(fu))return!0;throw new s8(`${e} did not support ${fu}`)}})]);return n}_updateSentStats(e){let t=0;for(const n of e.values())t+=n.data.byteLength;this.metrics.dataSent?.increment(t),this.metrics.blocksSent?.increment(e.size)}};const Hw=Symbol.for("nodejs.util.inspect.custom"),YN=114;class Wg{type;multihash;publicKey;string;constructor(e){this.type=e.type,this.multihash=e.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[Mp]=!0;toString(){return this.string==null&&(this.string=Ct.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return ae.createV1(YN,this.multihash)}toJSON(){return this.toString()}equals(e){if(e==null)return!1;if(e instanceof Uint8Array)return Te(this.multihash.bytes,e);if(typeof e=="string")return this.toString()===e;if(e?.toMultihash()?.bytes!=null)return Te(this.multihash.bytes,e.toMultihash().bytes);throw new Error("not valid Id")}[Hw](){return`PeerId(${this.toString()})`}}class qw extends Wg{type="RSA";publicKey;constructor(e){super({...e,type:"RSA"}),this.publicKey=e.publicKey}}class Kw extends Wg{type="Ed25519";publicKey;constructor(e){super({...e,type:"Ed25519"}),this.publicKey=e.publicKey}}class Ww extends Wg{type="secp256k1";publicKey;constructor(e){super({...e,type:"secp256k1"}),this.publicKey=e.publicKey}}const QN=2336;class jw{type="url";multihash;publicKey;url;constructor(e){this.url=e.toString(),this.multihash=jn.digest(W(this.url))}[Hw](){return`PeerId(${this.url})`}[Mp]=!0;toString(){return this.toCID().toString()}toMultihash(){return this.multihash}toCID(){return ae.createV1(QN,this.toMultihash())}toJSON(){return this.toString()}equals(e){return e==null?!1:(e instanceof Uint8Array&&(e=Y(e)),e.toString()===this.toString())}}const XN=114,_m=2336;function or(r,e){let t;if(r.charAt(0)==="1"||r.charAt(0)==="Q")t=Zt(Ct.decode(`z${r}`));else{if(r.startsWith("k51qzi5uqu5")||r.startsWith("kzwfwjn5ji4")||r.startsWith("k2k4r8")||r.startsWith("bafz"))return ya(ae.parse(r));throw new H('Please pass a multibase decoder for strings that do not start with "1" or "Q"')}return ln(t)}function Fo(r){if(r.type==="Ed25519")return new Kw({multihash:r.toCID().multihash,publicKey:r});if(r.type==="secp256k1")return new Ww({multihash:r.toCID().multihash,publicKey:r});if(r.type==="RSA")return new qw({multihash:r.toCID().multihash,publicKey:r});throw new ca}function ZN(r){return Fo(r.publicKey)}function ln(r){if(eD(r))return new qw({multihash:r});if(JN(r))try{const e=w7(r);if(e.type==="Ed25519")return new Kw({multihash:r,publicKey:e});if(e.type==="secp256k1")return new Ww({multihash:r,publicKey:e})}catch{const t=Y(r.digest);return new jw(new URL(t))}throw new Op("Supplied PeerID Multihash is invalid")}function ya(r){if(r?.multihash==null||r.version==null||r.version===1&&r.code!==XN&&r.code!==_m)throw new vS("Supplied PeerID CID is invalid");if(r.code===_m){const e=Y(r.multihash.digest);return new jw(new URL(e))}return ln(r.multihash)}function JN(r){return r.code===jn.code}function eD(r){return r.code===Et.code}function wc(r,e){const t={[Symbol.iterator]:()=>t,next:()=>{const n=r.next(),i=n.value;return n.done===!0||i==null?{done:!0,value:void 0}:{done:!1,value:e(i)}}};return t}function D1(r){const e=Zt(Ct.decode(`z${r}`));return ln(e)}class Gs{map;constructor(e){if(this.map=new Map,e!=null)for(const[t,n]of e.entries())this.map.set(t.toString(),{key:t,value:n})}[Symbol.iterator](){return this.entries()}clear(){this.map.clear()}delete(e){return this.map.delete(e.toString())}entries(){return wc(this.map.entries(),e=>[e[1].key,e[1].value])}forEach(e){this.map.forEach((t,n)=>{e(t.value,t.key,this)})}get(e){return this.map.get(e.toString())?.value}has(e){return this.map.has(e.toString())}set(e,t){this.map.set(e.toString(),{key:e,value:t})}keys(){return wc(this.map.values(),e=>e.key)}values(){return wc(this.map.values(),e=>e.value)}get size(){return this.map.size}}class xn{set;constructor(e){if(this.set=new Set,e!=null)for(const t of e)this.set.add(t.toString())}get size(){return this.set.size}[Symbol.iterator](){return this.values()}add(e){this.set.add(e.toString())}clear(){this.set.clear()}delete(e){this.set.delete(e.toString())}entries(){return wc(this.set.entries(),e=>{const t=D1(e[0]);return[t,t]})}forEach(e){this.set.forEach(t=>{const n=D1(t);e(n,n,this)})}has(e){return this.set.has(e.toString())}values(){return wc(this.set.values(),e=>D1(e))}intersection(e){const t=new xn;for(const n of e)this.has(n)&&t.add(n);return t}difference(e){const t=new xn;for(const n of this)e.has(n)||t.add(n);return t}union(e){const t=new xn;for(const n of e)t.add(n);for(const n of this)t.add(n);return t}}function tD(){return new xn}class rD{filter;constructor(e,t){this.filter=Mi(e,t)}has(e){return this.filter.has(e.toMultihash().bytes)}add(e){this.filter.add(e.toMultihash().bytes)}remove(e){this.filter.remove?.(e.toMultihash().bytes)}}function nD(r,e=.001){return new rD(r,e)}class iD extends Gs{metric;constructor(e){super();const{name:t,metrics:n}=e;this.metric=n.registerMetric(t),this.updateComponentMetric()}set(e,t){return super.set(e,t),this.updateComponentMetric(),this}delete(e){const t=super.delete(e);return this.updateComponentMetric(),t}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}}function Jh(r){const{name:e,metrics:t}=r;let n;return t!=null?n=new iD({name:e,metrics:t}):n=new Gs,n}class Ga{full;pendingBytes;wantlist;blocks;blockPresences;constructor(e=!1,t=0){this.full=e,this.wantlist=new Map,this.blocks=new Map,this.blockPresences=new Map,this.pendingBytes=0}addWantlistEntry(e,t){const n=Br.encode(e.multihash.bytes);this.wantlist.set(n,t)}addBlockPresence(e,t){const n=Br.encode(e.multihash.bytes);this.blockPresences.set(n,t)}addBlock(e,t){const n=Br.encode(e.multihash.bytes);this.blocks.set(n,t)}}function sD(r){let e=new Uint8Array(r.reduce((n,i)=>n+et(i),0)),t=0;for(const n of r)e=vn(n,e,t),t+=et(n);return e}function Tm(r){return sD([r.version,r.code,r.multihash.code,r.multihash.digest.byteLength])}class oD{peerId;blockstore;network;wants;exchangeCount;bytesSent;bytesReceived;lastExchange;maxSizeReplaceHasWithBlock;log;constructor(e,t){this.peerId=e.peerId,this.blockstore=e.blockstore,this.network=e.network,this.wants=new Map,this.log=e.logger.forComponent(`helia:bitswap:ledger:${e.peerId}`),this.exchangeCount=0,this.bytesSent=0,this.bytesReceived=0,this.maxSizeReplaceHasWithBlock=t.maxSizeReplaceHasWithBlock??RN}sentBytes(e){this.exchangeCount++,this.lastExchange=new Date().getTime(),this.bytesSent+=e}receivedBytes(e){this.exchangeCount++,this.lastExchange=new Date().getTime(),this.bytesReceived+=e}debtRatio(){return this.bytesSent/(this.bytesReceived+1)}async sendBlocksToPeer(e){const t=new Ga,n=new Set;for(const[i,s]of this.wants.entries())try{const o=await Jt(this.blockstore.get(s.cid,e));s.wantType===At.WantHave?o.byteLength<this.maxSizeReplaceHasWithBlock?(this.log("sending have and block for %c",s.cid),n.add(i),t.addBlock(s.cid,{data:o,prefix:Tm(s.cid)})):(this.log("sending have for %c",s.cid),t.addBlockPresence(s.cid,{cid:s.cid.bytes,type:Sn.HaveBlock})):(this.log("sending block for %c",s.cid),n.add(i),t.addBlock(s.cid,{data:o,prefix:Tm(s.cid)}))}catch(o){if(o.name!=="NotFoundError")throw o;if(this.log("do not have block for %c",s.cid),!s.sendDontHave||s.sentDoNotHave===!0)continue;s.sentDoNotHave=!0,t.addBlockPresence(s.cid,{cid:s.cid.bytes,type:Sn.DoNotHaveBlock})}if(t.blocks.size>0||t.blockPresences.size>0){this.log("sending message"),await this.network.sendMessage(this.peerId,t,e),this.log("sent message"),this.sentBytes([...t.blocks.values()].reduce((i,s)=>i+s.data.byteLength,0));for(const i of n)this.wants.delete(i)}}}class aD{blockstore;network;ledgerMap;maxSizeReplaceHasWithBlock;log;logger;constructor(e,t={}){this.blockstore=e.blockstore,this.network=e.network,this.maxSizeReplaceHasWithBlock=t.maxSizeReplaceHasWithBlock,this.log=e.logger.forComponent("helia:bitswap:peer-want-lists"),this.logger=e.logger,this.ledgerMap=Jh({name:"helia_bitswap_ledger_map",metrics:e.metrics}),this.network.addEventListener("bitswap:message",n=>{this.receiveMessage(n.detail.peer,n.detail.message).catch(i=>{this.log.error("error receiving bitswap message from %p - %e",n.detail.peer,i)})}),this.network.addEventListener("peer:disconnected",n=>{this.peerDisconnected(n.detail)})}ledgerForPeer(e){const t=this.ledgerMap.get(e);if(t!=null)return{peer:t.peerId,value:t.debtRatio(),sent:t.bytesSent,received:t.bytesReceived,exchanged:t.exchangeCount}}wantListForPeer(e){const t=this.ledgerMap.get(e);if(t!=null)return[...t.wants.values()]}peers(){return Array.from(this.ledgerMap.values()).map(e=>e.peerId)}async receiveMessage(e,t){let n=this.ledgerMap.get(e);if(n==null&&(n=new oD({peerId:e,blockstore:this.blockstore,network:this.network,logger:this.logger},{maxSizeReplaceHasWithBlock:this.maxSizeReplaceHasWithBlock}),this.ledgerMap.set(e,n)),n.receivedBytes(t.blocks?.reduce((i,s)=>i+s.data.byteLength,0)??0),t.wantlist!=null){t.wantlist.full===!0&&n.wants.clear();for(const i of t.wantlist.entries){const s=ae.decode(i.cid),o=Y(s.multihash.bytes,"base64");i.cancel===!0?(this.log("peer %p cancelled want of block for %c",e,s),n.wants.delete(o)):(i.wantType===At.WantHave?this.log("peer %p wanted block presence for %c",e,s):this.log("peer %p wanted block for %c",e,s),n.wants.set(o,{cid:s,priority:i.priority,wantType:i.wantType??At.WantBlock,sendDontHave:i.sendDontHave??!1}))}}this.log("send blocks to peer"),await n.sendBlocksToPeer()}async receivedBlock(e,t){const n=Y(e.multihash.bytes,"base64"),i=[];for(const s of this.ledgerMap.values())s.wants.has(n)&&i.push(s);await Promise.all(i.map(async s=>s.sendBlocksToPeer(t)))}peerDisconnected(e){this.ledgerMap.delete(e)}}class cD extends Vw{wantList;network;libp2p;constructor(e,t){super(e,{...t,name:"helia:bitswap:session"}),this.wantList=e.wantList,this.network=e.network,this.libp2p=e.libp2p}async queryProvider(e,t,n){this.log("sending WANT-BLOCK for %c to %p",e,t);const i=await this.wantList.wantSessionBlock(e,t,n);if(this.log("%p %s %c",t,i.has?"has":"does not have",e),i.has&&i.block!=null)return i.block;throw new Error("Provider did not have block")}async*findNewProviders(e,t={}){for await(const n of this.network.findProviders(e,t))yield n.id}toEvictionKey(e){return e.toMultihash().bytes}equals(e,t){return e.equals(t)}async convertToProvider(e,t){return Ii(e)?e:(await this.libp2p.dial(e,t)).remotePeer}}function lD(r,e){return new cD(r,e)}class uD{blocksReceived;duplicateBlocksReceived;dataReceived;duplicateDataReceived;constructor(e){this.blocksReceived=e.metrics?.registerMetricGroup("helia_bitswap_received_blocks"),this.duplicateBlocksReceived=e.metrics?.registerMetricGroup("helia_bitswap_duplicate_received_blocks"),this.dataReceived=e.metrics?.registerMetricGroup("helia_bitswap_data_received_bytes"),this.duplicateDataReceived=e.metrics?.registerMetricGroup("helia_bitswap_duplicate_data_received_bytes")}updateBlocksReceived(e=1,t){const n={global:e};t!=null&&(n[t.toString()]=e),this.blocksReceived?.increment(n)}updateDuplicateBlocksReceived(e=1,t){const n={global:e};t!=null&&(n[t.toString()]=e),this.duplicateBlocksReceived?.increment(n)}updateDataReceived(e,t){const n={global:e};t!=null&&(n[t.toString()]=e),this.dataReceived?.increment(n)}updateDuplicateDataReceived(e,t){const n={global:e};t!=null&&(n[t.toString()]=e),this.duplicateDataReceived?.increment(n)}}function dD(r){if(!(r instanceof Uint8Array))throw new Error("arg needs to be a Uint8Array");const e=[];for(;r.length>0;){const t=Vs(r);e.push(t),r=r.slice(et(t))}return e}class hD extends Qe{peers;wants;network;log;sendMessagesDelay;sendMessagesTimeout;hashLoader;sendingMessages;constructor(e,t={}){super(),this.peers=Jh({name:"helia_bitswap_peers",metrics:e.metrics}),this.wants=an({name:"helia_bitswap_wantlist",metrics:e.metrics}),this.network=e.network,this.sendMessagesDelay=t.sendMessagesDelay??LN,this.log=e.logger.forComponent("helia:bitswap:wantlist"),this.hashLoader=t.hashLoader,this.network.addEventListener("bitswap:message",n=>{this.receiveMessage(n.detail.peer,n.detail.message).catch(i=>{this.log.error("error receiving bitswap message from %p - %e",n.detail.peer,i)})}),this.network.addEventListener("peer:connected",n=>{this.peerConnected(n.detail).catch(i=>{this.log.error("error processing newly connected bitswap peer %p - %e",n.detail,i)})}),this.network.addEventListener("peer:disconnected",n=>{this.peerDisconnected(n.detail)})}async addEntry(e,t){const n=Y(e.multihash.bytes,"base64");let i=this.wants.get(n);i==null&&(i={cid:e,priority:t.priority??1,wantType:t.wantType??At.WantBlock,cancel:!1,sendDontHave:!0},this.wants.set(n,i)),i.wantType===At.WantHave&&t.wantType===At.WantBlock&&(i.wantType=At.WantBlock),await this.sendMessagesDebounced();try{return t.wantType===At.WantBlock?(await bn(this,"block",t?.signal,{filter:a=>Te(e.multihash.digest,a.detail.cid.multihash.digest),errorMessage:"Want was aborted"})).detail:(await bn(this,"presence",t?.signal,{filter:o=>Te(e.multihash.digest,o.detail.cid.multihash.digest),errorMessage:"Want was aborted"})).detail}finally{t.signal?.aborted===!0&&(this.log("want for %c was aborted, cancelling want",e),i.cancel=!0,await this.sendMessagesDebounced())}}async sendMessagesDebounced(){await this.sendingMessages?.promise,clearTimeout(this.sendMessagesTimeout),this.sendMessagesTimeout=setTimeout(()=>{this.sendMessages().catch(e=>{this.log("error sending messages to peers - %e",e)})},this.sendMessagesDelay)}async sendMessages(){this.sendingMessages=Ze(),await Promise.all([...this.peers.entries()].map(async([e,t])=>{const n=new Set,i=new Ga;for(const[s,o]of this.wants.entries())t.has(s)||o.cancel||(n.add(s),i.addWantlistEntry(o.cid,{cid:o.cid.bytes,priority:o.priority,wantType:o.wantType,cancel:o.cancel,sendDontHave:o.sendDontHave}));if(i.wantlist.size!==0)try{await this.network.sendMessage(e,i);for(const s of n)t.add(s)}catch(s){this.log.error("error sending full wantlist to new peer - %e",s)}})).catch(e=>{this.log.error("error sending messages - %e",e)});for(const[e,t]of this.wants)if(t.cancel){this.wants.delete(e);for(const n of this.peers.values())n.delete(e)}this.sendingMessages.resolve()}has(e){const t=Y(e.multihash.bytes,"base64");return this.wants.has(t)}async wantSessionPresence(e,t,n={}){const i=new Ga;return i.addWantlistEntry(e,{cid:e.bytes,sendDontHave:!0,wantType:At.WantHave,priority:1}),await this.network.sendMessage(t,i),(await bn(this,"presence",n.signal,{filter:o=>t.equals(o.detail.sender)&&Te(e.multihash.digest,o.detail.cid.multihash.digest)})).detail}async wantBlock(e,t={}){return this.addEntry(e,{...t,wantType:At.WantBlock})}async wantSessionBlock(e,t,n={}){const i=new Ga;return i.addWantlistEntry(e,{cid:e.bytes,sendDontHave:!0,wantType:At.WantBlock,priority:1}),await this.network.sendMessage(t,i),(await bn(this,"presence",n.signal,{filter:o=>t.equals(o.detail.sender)&&Te(e.multihash.digest,o.detail.cid.multihash.digest)})).detail}async receivedBlock(e,t){const n=Y(e.multihash.bytes,"base64"),i=this.wants.get(n);i!=null&&(i.cancel=!0,await this.sendMessagesDebounced())}async receiveMessage(e,t){this.log("received message from %p with %d blocks",e,t.blocks.length);let n=!1;for(const i of t.blocks){if(i.prefix==null||i.data==null)continue;const s=dD(i.prefix),o=s[0],a=s[1],c=s[2],l=s[3],u=c===Et.code?Et:await this.hashLoader?.getHasher(c);if(u==null){this.log.error("unknown hash algorithm",c);continue}let d=u.digest(i.data,{truncate:l});d.then!=null&&(d=await d);const h=ae.create(o===0?0:1,a,d);this.log("received block from %p for %c",e,h),this.safeDispatchEvent("block",{detail:{sender:e,cid:h,block:i.data}}),this.safeDispatchEvent("presence",{detail:{sender:e,cid:h,has:!0,block:i.data}});const f=Y(h.multihash.bytes,"base64"),y=this.wants.get(f);y!=null&&(y.cancel=!0,n=!0)}for(const{cid:i,type:s}of t.blockPresences){const o=ae.decode(i);this.log("received %s from %p for %c",s,e,o),this.safeDispatchEvent("presence",{detail:{sender:e,cid:o,has:s===Sn.HaveBlock}})}n&&await this.sendMessagesDebounced()}async peerConnected(e){const t=new Set,n=new Ga(!0);for(const[i,s]of this.wants.entries())s.cancel||(t.add(i),n.addWantlistEntry(s.cid,{cid:s.cid.bytes,priority:1,wantType:At.WantBlock,cancel:!1,sendDontHave:!1}));if(n.wantlist.size===0){this.peers.set(e,t);return}try{await this.network.sendMessage(e,n),this.peers.set(e,t)}catch(i){this.log.error("error sending full wantlist to new peer %p - %e",e,i)}}peerDisconnected(e){this.peers.delete(e)}start(){}stop(){this.peers.clear(),clearTimeout(this.sendMessagesTimeout)}}class fD{log;logger;stats;network;blockstore;peerWantLists;wantList;libp2p;constructor(e,t={}){this.logger=e.logger,this.log=e.logger.forComponent("helia:bitswap"),this.blockstore=e.blockstore,this.libp2p=e.libp2p,this.stats=new uD(e),this.network=new GN(e,t),this.peerWantLists=new aD({...e,network:this.network},t),this.wantList=new hD({...e,network:this.network},t)}createSession(e={}){return lD({wantList:this.wantList,network:this.network,logger:this.logger,libp2p:this.libp2p},e)}async want(e,t={}){const n=new AbortController,i=Ke([n.signal,t.signal]);n.signal,this.network.findAndConnect(e,{...t,signal:i}).catch(s=>{n.signal.aborted||this.log.error("error during finding and connect for cid %c - %e",e,s)});try{const s=await this.wantList.wantBlock(e,{...t,signal:i});return t.onProgress?.(new oe("bitswap:block",{cid:e,sender:s.sender})),s.block}finally{n.abort(),i.clear()}}async notify(e,t={}){await Promise.all([this.peerWantLists.receivedBlock(e,t),this.wantList.receivedBlock(e,t)])}getWantlist(){return[...this.wantList.wants.values()].filter(e=>!e.cancel).map(e=>({cid:e.cid,priority:e.priority,wantType:e.wantType}))}getPeerWantlist(e){return this.peerWantLists.wantListForPeer(e)}async start(){this.wantList.start(),await this.network.start()}async stop(){this.wantList.stop(),await this.network.stop()}}const pD=(r,e={})=>new fD(r,e);class gD{bitswap;started;constructor(e,t={}){const{getHasher:n}=e;this.bitswap=pD(e,{hashLoader:{getHasher:async i=>n(i)},...t}),this.started=!1}isStarted(){return this.started}async start(){await this.bitswap.start(),this.started=!0}async stop(){await this.bitswap.stop(),this.started=!1}async announce(e,t){await this.bitswap.notify(e,t)}async retrieve(e,t={}){return this.bitswap.want(e,t)}createSession(e){const t=this.bitswap.createSession(e);return{announce:async(n,i)=>{await this.bitswap.notify(n,i)},retrieve:async(n,i)=>t.retrieve(n,i)}}}function mD(r={}){return e=>new gD(e,r)}const yD=[fs,bg,Sg,vg,Eg];function Pm(r){return Gw("sni",r)?.value}function Rm(r){const e=Gw("tcp",r)?.value;return e==null?"":`:${e}`}function Gw(r,e){return e.find(t=>t.name===r)}function Nm(r){return r.some(({code:e})=>e===ps)}function Hr(r,e){const t=Yw[r.name];if(t==null)throw new Error(`Can't interpret protocol ${r.name}`);const n=t(r,e);return r.code===xs?`[${n}]`:n}const Yw={ip4:(r,e)=>r.value,ip6:(r,e)=>e.length===0?r.value:`[${r.value}]`,tcp:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`tcp://${Hr(t,e)}:${r.value}`},udp:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`udp://${Hr(t,e)}:${r.value}`},dnsaddr:(r,e)=>r.value,dns4:(r,e)=>r.value,dns6:(r,e)=>r.value,dns:(r,e)=>r.value,ipfs:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`${Hr(t,e)}`},p2p:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`${Hr(t,e)}`},http:(r,e)=>{const t=Nm(e),n=Pm(e),i=Rm(e);if(t&&n!=null)return`https://${n}${i}`;const s=t?"https://":"http://",o=e.pop();if(o==null)throw new Error("Unexpected end of multiaddr");let a=Hr(o,e);return a=a?.replace("tcp://",""),`${s}${a}`},"http-path":(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");const n=Hr(t,e),i=decodeURIComponent(r.value??"");return`${n}${i}`},tls:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return Hr(t,e)},sni:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return Hr(t,e)},https:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");let n=Hr(t,e);return n=n?.replace("tcp://",""),`https://${n}`},ws:(r,e)=>{const t=Nm(e),n=Pm(e),i=Rm(e);if(t&&n!=null)return`wss://${n}${i}`;const s=t?"wss://":"ws://",o=e.pop();if(o==null)throw new Error("Unexpected end of multiaddr");let a=Hr(o,e);return a=a?.replace("tcp://",""),`${s}${a}`},wss:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");let n=Hr(t,e);return n=n?.replace("tcp://",""),`wss://${n}`}};function ef(r,e){const n=be(r).getComponents(),i=n.pop();if(i==null)throw new Error("Unexpected end of multiaddr");const s=Yw[i.name];if(s==null)throw new Error(`No interpreter found for ${i.name}`);let o=s(i,n)??"";return yD.includes(i.code)&&(o=o.replace(/^.*:\/\//,""),i.value==="443"?o=`https://${o}`:o=`http://${o}`),(o.startsWith("http://")||o.startsWith("https://")||o.startsWith("ws://")||o.startsWith("wss://"))&&(o=new URL(o).toString(),o.endsWith("/")&&(o=o.substring(0,o.length-1))),o}const je=r=>({match:e=>{const t=e[0];return t==null||t.code!==r||t.value!=null?!1:e.slice(1)}}),we=(r,e)=>({match:t=>{const n=t[0];return n?.code!==r||n.value==null||e!=null&&n.value!==e?!1:t.slice(1)}}),wD=r=>({match:e=>r.match(e)===!1?e:!1}),Be=r=>({match:e=>{const t=r.match(e);return t===!1?e:t}}),ar=(...r)=>({match:e=>{let t;for(const n of r){const i=n.match(e);i!==!1&&(t==null||i.length<t.length)&&(t=i)}return t??!1}}),He=(...r)=>({match:e=>{for(const t of r){const n=t.match(e);if(n===!1)return!1;e=n}return e}});function Ge(...r){function e(i){if(i==null)return!1;let s=i.getComponents();for(const o of r){const a=o.match(s);if(a===!1)return!1;s=a}return s}function t(i){return e(i)!==!1}function n(i){const s=e(i);return s===!1?!1:s.length===0}return{matchers:r,matches:t,exactMatch:n}}const bD=we(ge),vD=Ge(bD),tf=we(vg),rf=we(Eg),nf=we(Sg),jg=we(bg);Ge(tf,Be(we(ge)));Ge(rf,Be(we(ge)));Ge(nf,Be(we(ge)));const Qw=Ge(ar(jg,nf,tf,rf),Be(we(ge))),Xw=He(we(fd),Be(we(wg))),Zw=He(Be(we(yg)),we(xs),Be(we(wg))),Gg=ar(Xw,Zw),As=ar(Gg,jg,tf,rf,nf),ED=Ge(ar(Gg,He(ar(jg,nf,tf,rf),Be(we(ge))))),Dm=Ge(Xw),Bm=Ge(Zw),SD=Ge(Gg),Yg=He(As,we(fs)),Cl=He(As,we(O7)),kd=Ge(He(Yg,Be(we(ge))));Ge(Cl);const Qg=He(Cl,je($7),Be(we(ge))),sf=He(Cl,je(U7),Be(we(ge))),xD=ar(Qg,sf);Ge(Qg);const AD=Ge(sf),$0=ar(As,Yg,Cl,Qg,sf),Jw=ar(He($0,je(xg),Be(we(ge)))),Zc=Ge(Jw),e9=ar(He($0,je(V7),Be(we(ge))),He($0,je(ps),Be(we(pd)),je(xg),Be(we(ge)))),Cd=Ge(e9),t9=He(Cl,je(z7),Be(we($o)),Be(we($o)),Be(we(ge))),U0=Ge(t9),r9=He(sf,je(F7),Be(we($o)),Be(we($o)),Be(we(ge))),Lm=Ge(r9),Id=ar(Jw,e9,He(Yg,Be(we(ge))),He(xD,Be(we(ge))),He(As,Be(we(ge))),t9,r9,we(ge)),Xg=Ge(Id),kD=He(Be(Id),je(da),wD(je(mc)),Be(we(ge))),_n=Ge(kD),CD=ar(He(Id,je(da),je(mc),Be(we(ge))),He(Id,je(mc),Be(we(ge))),He(je(mc),Be(we(ge)))),F0=Ge(CD),ID=ar(He(As,we(fs),je(Ao),Be(we(ge))),He(As,je(Ao),Be(we(ge)))),_D=Ge(ID),TD=He(As,ar(He(we(fs,"443"),je(Ao)),He(we(fs),je(T0)),He(we(fs),je(ps),je(Ao)),He(je(ps),je(Ao)),je(ps),je(T0)),Be(we(ge))),PD=Ge(TD),RD=ar(He(we(H7),Be(we(ge))));Ge(RD);const ND=ar(He(we(M7),Be(we(ge))));Ge(ND);function n9(r,e,t){return r.filter(n=>{if(PD.matches(n)||e&&_D.matches(n))return t||Qw.matches(n)?!0:Or(n)===!1;if(!e&&t){const{host:i}=Ne(n);if(i==="127.0.0.1"||i==="localhost"||i.endsWith(".localhost"))return!0}return!1})}async function*i9(r,e,t,n,i,s={}){for await(const o of e.findProviders(r,s)){const a=n9(o.multiaddrs,n,i);if(a.length===0)continue;const c=ef(a[0]),l={type:"trustless-gateway",cid:r,url:c.toString(),routing:o.routing};s?.onProgress?.(new oe("trustless-gateway:found-provider",l)),yield new s9(c,{logger:t,transformRequestInit:s.transformRequestInit})}}async function DD(r,e,t){const{signal:n,log:i}=t??{},s=r.headers.get("content-length");if(s!=null){const c=parseInt(s,10);if(c>e)throw i?.error("content-length header (%d) is greater than the limit (%d)",c,e),r.body!=null&&await r.body.cancel().catch(l=>{i?.error("error cancelling response body after content-length check - %e",l)}),new Error(`Content-Length header (${c}) is greater than the limit (${e}).`)}const o=r.body?.getReader();if(o==null)throw new Error("Response body is not readable");const a=new me;try{for(;;){if(n?.aborted===!0)throw new Error("Response body read was aborted.");const{done:c,value:l}=await o.read();if(c)break;if(a.append(l),a.byteLength>e)throw new Error(`Response body is greater than the limit (${e}), received ${a.byteLength} bytes.`)}}finally{o.cancel().catch(c=>{i?.error("error cancelling reader - %e",c)}).finally(()=>{o.releaseLock()})}return a.subarray()}class s9{url;#e=0;#t=0;#r=0;#o=0;#s=new Map;log;transformRequestInit;constructor(e,{logger:t,transformRequestInit:n}){this.url=e instanceof URL?e:new URL(e),this.transformRequestInit=n,this.log=t.forComponent(`helia:trustless-gateway-block-broker:${this.url.hostname}`)}#d(e){const t=e.multihash.bytes;return Br.encode(t)}async getRawBlock(e,{signal:t,maxSize:n=MD}={}){const i=new URL(this.url.toString());if(i.pathname=`/ipfs/${e.toString()}`,i.search="?format=raw",t?.aborted===!0)throw new Error(`Signal to fetch raw block for CID ${e} from gateway ${this.url} was aborted prior to fetch`);const s=this.#d(e),o=new AbortController,a=()=>{o.abort()};t?.addEventListener("abort",a);try{let c=this.#s.get(s);if(c==null){this.#e++;const l={signal:o.signal,headers:{Accept:"application/vnd.ipld.raw"},cache:"force-cache"},u=this.transformRequestInit!=null?await this.transformRequestInit(l):l,d=new Headers(u.headers);this.log(`sending request
%s %s HTTP/1.1
%s
`,u.method??"GET",i,[...d.entries()].map(([h,f])=>`${h}: ${f}`).join(`
`)),c=fetch(i.toString(),u).then(async h=>{if(this.log(`received response
HTTP/1.1 %d %s
%s
`,h.status,h.statusText,[...h.headers.entries()].map(([y,m])=>`${y}: ${m}`).join(`
`)),!h.ok)throw this.#t++,new Error(`Unable to fetch raw block for CID ${e} from gateway ${this.url}, recieved ${h.status} ${h.statusText}`);const f=await DD(h,n,{signal:o.signal,log:this.log});return this.#o++,f}),this.#s.set(s,c)}return await c}catch(c){throw t?.aborted===!0?new Error(`Fetching raw block for CID ${e} from gateway ${this.url} was aborted`):(this.#t++,new Error(`Unable to fetch raw block for CID ${e} - ${c.message}`))}finally{t?.removeEventListener("abort",a),this.#s.delete(s)}}reliability(){return this.#e===0?1:this.#r>0?-1/0:this.#o/(this.#e+this.#t*3)}incrementInvalidBlocks(){this.#r++}getStats(){return{attempts:this.#e,errors:this.#t,invalidBlocks:this.#r,successes:this.#o,pendingResponses:this.#s.size}}toString(){return`TrustlessGateway(${this.url})`}}class BD extends Vw{routing;allowInsecure;allowLocal;transformRequestInit;constructor(e,t){super(e,{...t,name:"helia:trustless-gateway:session"}),this.routing=e.routing,this.allowInsecure=t.allowInsecure??o9,this.allowLocal=t.allowLocal??a9,this.transformRequestInit=t.transformRequestInit}async queryProvider(e,t,n){this.log("fetching BLOCK for %c from %s",e,t.url);const i=await t.getRawBlock(e,n);return this.log.trace("got block for %c from %s",e,t.url),await n.validateFn?.(i),i}async*findNewProviders(e,t={}){yield*i9(e,this.routing,this.logger,this.allowInsecure,this.allowLocal,{...t,transformRequestInit:this.transformRequestInit})}toEvictionKey(e){return e.url.toString()}equals(e,t){return e.url.toString()===t.url.toString()}async convertToProvider(e,t){if(Ii(e))return;const n=n9(Array.isArray(e)?e:[e],this.allowInsecure,this.allowLocal);if(n.length===0)return;const i=ef(n[0]);return new s9(i,{logger:this.logger,transformRequestInit:this.transformRequestInit})}}function LD(r,e){return new BD(r,e)}class OD{allowInsecure;allowLocal;transformRequestInit;routing;log;logger;constructor(e,t={}){this.log=e.logger.forComponent("helia:trustless-gateway-block-broker"),this.logger=e.logger,this.routing=e.routing,this.allowInsecure=t.allowInsecure??o9,this.allowLocal=t.allowLocal??a9,this.transformRequestInit=t.transformRequestInit}async retrieve(e,t={}){const n=[];for await(const i of i9(e,this.routing,this.logger,this.allowInsecure,this.allowLocal,{...t,transformRequestInit:this.transformRequestInit})){this.log("getting block for %c from %s",e,i.url);try{const s=await i.getRawBlock(e,t);this.log.trace("got block for %c from %s",e,i.url);try{await t.validateFn?.(s)}catch(o){this.log.error("failed to validate block for %c from %s - %e",e,i.url,o);continue}return s}catch(s){if(this.log.error("failed to get block for %c from %s - %e",e,i.url,s),s instanceof Error?n.push(s):n.push(new Error(`Unable to fetch raw block for CID ${e} from gateway ${i.url}`)),t.signal?.aborted===!0){this.log.trace("request aborted while fetching raw block for CID %c from gateway %s",e,i.url);break}}}throw n.length>0?new AggregateError(n,`Unable to fetch raw block for CID ${e} from any gateway`):new Error(`Unable to fetch raw block for CID ${e} from any gateway`)}createSession(e={}){return LD({logger:this.logger,routing:this.routing},{...e,allowLocal:this.allowLocal,allowInsecure:this.allowInsecure,transformRequestInit:this.transformRequestInit})}}const o9=!1,a9=!1,MD=2097152;function $D(r={}){return e=>new OD(e,r)}async function*Om(r,e={}){const t=r.getReader();try{for(;;){const n=await t.read();if(n.done)return;yield n.value}}finally{e.preventCancel!==!0&&await t.cancel(),t.releaseLock()}}var B1={exports:{}},Mm;function UD(){return Mm||(Mm=1,(function(r){(function(){r.exports=p;var e=86400,t=3200,n=146097*t/400,i=e*n,s=1e3*i,o=864e13,a=4294967296,c=1e6,l="000000000",u=Math.trunc||function(E){var O=E-E%1;return O==0&&(E<0||E===0&&1/E!=1/0)?-0:O},d=p.prototype,h=(p.fromDate=function(E){return new p(+E)},p.fromInt64BE=T(0,1,2,3,0,4),p.fromInt64LE=T(3,2,1,0,4,0),p.fromString=function($){var O,V=new p,$=($+="").replace(/^\s*[+\-]?\d+/,function(k){var k=+k,S=1970+(k-1970)%400;return V.year=k-S,S}).replace(/(?:Z|([+\-]\d{2}):?(\d{2}))$/,function(I,k,S){return k<0&&(S*=-1),O=6e4*(60*+k+ +S),""}).replace(/\.\d+$/,function(I){return V.nano=+(I+l).substr(1,9),""}).split(/\D+/);if(1<$.length?$[1]--:$[1]=0,V.time=O=Date.UTC.apply(Date,$)-(O||0),isNaN(O))throw new TypeError("Invalid Date");return b(V)},p.fromTimeT=function(E){return v(E,0)},d.year=0,d.time=0,d.nano=0,d.addNano=function(E){return this.nano+=+E||0,this},d.getNano=function(){var E=b(this);return(E.time%1e3*c+ +E.nano+1e9)%1e9},d.getTimeT=function(){var O=b(this),E=Math.floor(O.time/1e3),O=O.year;return O&&(E+=O*n*e/t),E},d.getYear=function(){return this.toDate().getUTCFullYear()+this.year},d.toDate=function(){return A(b(this).time)},d.toJSON=function(){return this.toString().replace(/0{1,6}Z$/,"Z")},d.toString=function(E){var O=this,V=O.toDate(),$={H:function(){return L(V.getUTCHours())},L:function(){return N(V.getUTCMilliseconds(),3)},M:function(){return L(V.getUTCMinutes())},N:function(){return N(O.getNano(),9)},S:function(){return L(V.getUTCSeconds())},Y:function(){var I=O.getYear();return 999999<I?"+"+I:9999<I?"+"+N(I,6):0<=I?N(I,4):-999999<=I?"-"+N(-I,6):I},a:function(){return y[V.getUTCDay()]},b:function(){return f[V.getUTCMonth()]},d:function(){return L(V.getUTCDate())},e:function(){return(function(I){return(9<I?"":" ")+(0|I)})(V.getUTCDate())},m:function(){return L(V.getUTCMonth()+1)}};return(function I(k){return k.replace(/%./g,function(S){var U=S[1],B=m[U],U=$[U];return B?I(B):U?U():S})})(E||h)},d.writeInt64BE=C(0,1,2,3,0,4),d.writeInt64LE=C(3,2,1,0,4,0),"%Y-%m-%dT%H:%M:%S.%NZ"),f=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],y=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],m={"%":"%",F:"%Y-%m-%d",n:`
`,R:"%H:%M",T:"%H:%M:%S",t:"	",X:"%T",Z:"GMT",z:"+0000"};return p;function p(E,O,V){var $=this;if(!($ instanceof p))return new p(E,O,V);$.time=+E||0,$.nano=+O||0,$.year=+V||0,b($)}function b(E){var O,V,$,I=E.year,k=E.time,S=E.nano,B=((S<0||c<=S)&&(S-=(V=Math.floor(S/c))*c,k+=V,V=1),I%t);return(k<-o||o<k||B)&&((O=u(k/s))&&(I+=O*t,k-=O*s),($=A(k)).setUTCFullYear(B+$.getUTCFullYear()),$=(k=+$)+(O=u((I-=B)/t))*s,O&&-o<=$&&$<=o&&(I-=O*t,k=$),V=1),V&&(E.year=I,E.time=k,E.nano=S),E}function A(E){var O=new Date(0);return O.setTime(E),O}function v(I,$){I=+I||0;var V=u(($=($|0)*a)/i)+u(I/i),$=$%i+I%i,I=u($/i);return I&&(V+=I,$-=I*i),new p(1e3*$,0,V*t)}function C(E,O,V,$,I,k){return function(B,U){var M=b(this);B=B||new Array(8),R(B,U|=0);var K=Math.floor(M.time/1e3),M=M.year*(n*e/t),q=u(M/a)+u(K/a),M=M%a+K%a,K=Math.floor(M/a);return K&&(q+=K,M-=K*a),S(B,U+I,q),S(B,U+k,M),B};function S(B,U,q){B[U+E]=q>>24&255,B[U+O]=q>>16&255,B[U+V]=q>>8&255,B[U+$]=255&q}}function T(E,O,V,$,I,k){return function(B,U){R(B,U|=0);var q=S(B,U+I);return v(S(B,U+k),q)};function S(B,U){return 16777216*B[U+E]+(B[U+O]<<16|B[U+V]<<8|B[U+$])}}function R(E,O){if(E=E&&E.length,E==null)throw new TypeError("Invalid Buffer");if(E<O+8)throw new RangeError("Out of range")}function L(E){return(9<E?"":"0")+(0|E)}function N(E,O){return(l+(0|E)).substr(-O)}})()})(B1)),B1.exports}var FD=UD();const V0=Us(FD);class ts extends Error{static name="SignatureVerificationError";constructor(e="Record signature verification failed"){super(e),this.name="SignatureVerificationError"}}class VD extends Error{static name="RecordExpiredError";constructor(e="Record has expired"){super(e),this.name="RecordExpiredError"}}class c9 extends Error{static name="UnsupportedValidityError";constructor(e="The validity type is unsupported"){super(e),this.name="UnsupportedValidityError"}}class zD extends Error{static name="RecordTooLargeError";constructor(e="The record is too large"){super(e),this.name="RecordTooLargeError"}}class HD extends Error{static name="InvalidValueError";constructor(e="Value must be a valid content path starting with /"){super(e),this.name="InvalidValueError"}}class qD extends Error{static name="InvalidRecordDataError";constructor(e="Invalid record data"){super(e),this.name="InvalidRecordDataError"}}class $m extends Error{static name="InvalidEmbeddedPublicKeyError";constructor(e="Invalid embedded public key"){super(e),this.name="InvalidEmbeddedPublicKeyError"}}var tn;(function(r){(function(n){n.EOL="EOL"})(r.ValidityType||(r.ValidityType={}));let e;(function(n){n[n.EOL=0]="EOL"})(e||(e={})),(function(n){n.codec=()=>sr(e)})(r.ValidityType||(r.ValidityType={}));let t;r.codec=()=>(t==null&&(t=Ce((n,i,s={})=>{s.lengthDelimited!==!1&&i.fork(),n.value!=null&&(i.uint32(10),i.bytes(n.value)),n.signatureV1!=null&&(i.uint32(18),i.bytes(n.signatureV1)),n.validityType!=null&&(i.uint32(24),r.ValidityType.codec().encode(n.validityType,i)),n.validity!=null&&(i.uint32(34),i.bytes(n.validity)),n.sequence!=null&&(i.uint32(40),i.uint64(n.sequence)),n.ttl!=null&&(i.uint32(48),i.uint64(n.ttl)),n.pubKey!=null&&(i.uint32(58),i.bytes(n.pubKey)),n.signatureV2!=null&&(i.uint32(66),i.bytes(n.signatureV2)),n.data!=null&&(i.uint32(74),i.bytes(n.data)),s.lengthDelimited!==!1&&i.ldelim()},(n,i,s={})=>{const o={},a=i==null?n.len:n.pos+i;for(;n.pos<a;){const c=n.uint32();switch(c>>>3){case 1:{o.value=n.bytes();break}case 2:{o.signatureV1=n.bytes();break}case 3:{o.validityType=r.ValidityType.codec().decode(n);break}case 4:{o.validity=n.bytes();break}case 5:{o.sequence=n.uint64();break}case 6:{o.ttl=n.uint64();break}case 7:{o.pubKey=n.bytes();break}case 8:{o.signatureV2=n.bytes();break}case 9:{o.data=n.bytes();break}default:{n.skipType(c&7);break}}}return o})),t),r.encode=n=>ke(n,r.codec()),r.decode=(n,i)=>Ae(n,r.codec(),i)})(tn||(tn={}));const KD=Xt("ipns:utils"),l9=W("/ipns/"),WD=0,jD=18;function GD(r){let e;if(r.pubKey!=null)try{e=on(r.pubKey)}catch(t){throw KD.error(t),t}if(e!=null)return e}function YD(r){const e=W("ipns-signature:");return Ot([e,r])}function u9(r){return"signatureV1"in r?tn.encode({value:W(r.value),signatureV1:r.signatureV1,validityType:r.validityType,validity:W(r.validity),sequence:r.sequence,ttl:r.ttl,pubKey:r.pubKey,signatureV2:r.signatureV2,data:r.data}):tn.encode({pubKey:r.pubKey,signatureV2:r.signatureV2,data:r.data})}function Il(r){const e=tn.decode(r);if(e.sequence!=null&&(e.sequence=BigInt(e.sequence)),e.ttl!=null&&(e.ttl=BigInt(e.ttl)),e.signatureV2==null||e.data==null)throw new ts("Missing data or signatureV2");const t=h9(e.data),n=QD(t.Value),i=Y(t.Validity);if(e.value!=null&&e.signatureV1!=null)return XD(e),{value:n,validityType:tn.ValidityType.EOL,validity:i,sequence:t.Sequence,ttl:t.TTL,pubKey:e.pubKey,signatureV1:e.signatureV1,signatureV2:e.signatureV2,data:e.data};if(e.signatureV2!=null)return{value:n,validityType:tn.ValidityType.EOL,validity:i,sequence:t.Sequence,ttl:t.TTL,pubKey:e.pubKey,signatureV2:e.signatureV2,data:e.data};throw new Error("invalid record: does not include signatureV1 or signatureV2")}function d9(r){return Ot([l9,r.bytes])}function z0(r){const e=Zt(r.slice(l9.length));if(!H0(e,WD)&&!H0(e,jD))throw new Op("Multihash in IPNS key was not identity or sha2-256");return e}function h9(r){const e=vi(r);if(e.ValidityType===0)e.ValidityType=tn.ValidityType.EOL;else throw new c9("The validity type is unsupported");return Number.isInteger(e.Sequence)&&(e.Sequence=BigInt(e.Sequence)),Number.isInteger(e.TTL)&&(e.TTL=BigInt(e.TTL)),e}function QD(r){const e=Y(r).trim();if(e.startsWith("/"))return e;try{return`/ipfs/${ae.decode(r).toV1().toString()}`}catch{}try{return`/ipfs/${ae.parse(e).toV1().toString()}`}catch{}throw new HD("Value must be a valid content path starting with /")}function XD(r){if(r.data==null)throw new qD("Record data is missing");const e=h9(r.data);if(!Te(e.Value,r.value??new Uint8Array(0)))throw new ts('Field "value" did not match between protobuf and CBOR');if(!Te(e.Validity,r.validity??new Uint8Array(0)))throw new ts('Field "validity" did not match between protobuf and CBOR');if(e.ValidityType!==r.validityType)throw new ts('Field "validityType" did not match between protobuf and CBOR');if(e.Sequence!==r.sequence)throw new ts('Field "sequence" did not match between protobuf and CBOR');if(e.TTL!==r.ttl)throw new ts('Field "ttl" did not match between protobuf and CBOR')}function H0(r,e){return r.code===e}const pu=Xt("ipns:validator"),ZD=1024*10;async function JD(r,e){const t=Il(e);let n;try{const i=YD(t.data);n=await r.verify(i,t.signatureV2)}catch{n=!1}if(!n)throw pu.error("record signature verification failed"),new ts("Record signature verification failed");if(t.validityType===tn.ValidityType.EOL){if(V0.fromString(t.validity).toDate().getTime()<Date.now())throw pu.error("record has expired"),new VD("record has expired")}else if(t.validityType!=null)throw pu.error("the validity type is unsupported"),new c9("The validity type is unsupported");pu("ipns record for %s is valid",t.value)}async function f9(r,e){if(e.byteLength>ZD)throw new zD("The record is too large");const t=z0(r);let n;H0(t,0)&&(n=w7(t));const i=Il(e),s=GD(i)??n;if(s==null)throw new $m("Could not extract public key from IPNS record or routing key");const o=d9(s.toMultihash());if(!Te(o,r))throw new $m("Embedded public key did not match routing key");await JD(s,e)}class eB extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MESSAGE_LENGTH"}async function*Um(r,e={}){const t=/\r?\n/,n=new TextDecoder("utf8");let i="";for await(let s of r){if(typeof s=="string"&&(s=new TextEncoder().encode(s)),Ka(s)&&(s=s.subarray()),i+=n.decode(s,{stream:!0}),i.length>(e?.maxMessageLength??i.length))throw new eB("Incoming message too long");const o=i.split(t);i=o.pop()??"";for(let a=0;a<o.length;a++)yield JSON.parse(o[a])}i+=n.decode(),i!==""&&(yield JSON.parse(i))}class L1 extends Error{static name="InvalidRequestError";constructor(e="Invalid request"){super(e),this.name="InvalidRequestError"}}class yi extends Error{static name="BadResponseError";constructor(e="Bad response"){super(e),this.name="BadResponseError"}}function tB(r){return r[Symbol.asyncIterator]!=null}function Zg(r){if(tB(r))return(async()=>{for await(const e of r)return e})();for(const e of r)return e}const Fm=W("/ipns/");function Vm(r){return Te(r.subarray(0,Fm.byteLength),Fm)}class rB{client;constructor(e){this.client=e}async*findProviders(e,t={}){try{yield*Ki(this.client.getProviders(e,t),n=>({id:n.ID,multiaddrs:n.Addrs??[],routing:"delegated-http-routing-v1"}))}catch(n){if(n instanceof wt)return;throw n}}async provide(){}async cancelReprovide(){}async put(e,t,n){if(!Vm(e))return;const i=z0(e),s=ae.createV1(114,i),o=Il(t);await this.client.putIPNS(s,o,n)}async get(e,t){if(!Vm(e))throw new wt("Not found");const n=z0(e),i=ae.createV1(114,n);try{const s=await this.client.getIPNS(i,t);return u9(s)}catch(s){throw s.name==="BadResponseError"?new wt("Not found"):s}}toString(){return`DelegatedRoutingV1HttpApiClientContentRouting(${this.client.url})`}}class nB{client;constructor(e){this.client=e}async findPeer(e,t={}){const n=await Zg(this.client.getPeers(e,t));if(n!=null)return{id:n.ID,multiaddrs:n.Addrs??[]};throw new wt("Not found")}async*getClosestPeers(e,t={}){}toString(){return`DelegatedRoutingV1HttpApiClientPeerRouting(${this.client.url})`}}const gu={concurrentRequests:4,timeout:3e4,cacheTTL:300*1e3,cacheName:"delegated-routing-v1-cache"};class iB{url;started;httpQueue;shutDownController;timeout;contentRouting;peerRouting;filterAddrs;filterProtocols;inFlightRequests;cacheName;cache;cacheTTL;log;constructor(e,t){this.log=e.logger.forComponent("delegated-routing-v1-http-api-client"),this.started=!1,this.shutDownController=new AbortController,this.shutDownController.signal,this.httpQueue=new Fp({concurrency:t.concurrentRequests??gu.concurrentRequests}),this.inFlightRequests=new Map,this.url=t.url instanceof URL?t.url:new URL(t.url),this.timeout=t.timeout??gu.timeout,this.filterAddrs=t.filterAddrs,this.filterProtocols=t.filterProtocols,this.contentRouting=new rB(this),this.peerRouting=new nB(this),this.cacheName=t.cacheName??gu.cacheName,this.cacheTTL=t.cacheTTL??gu.cacheTTL}get[Rc](){return this.contentRouting}get[Nc](){return this.peerRouting}isStarted(){return this.started}async start(){this.started||(this.started=!0,this.cacheTTL>0&&(this.cache=await globalThis.caches?.open(this.cacheName),this.cache!=null&&this.log("cache enabled with ttl %d",this.cacheTTL)))}async stop(){this.httpQueue.clear(),this.shutDownController.abort(),await globalThis.caches?.delete(this.cacheName),this.started=!1}async*getProviders(e,t={}){this.log("getProviders starts: %c",e);const n=AbortSignal.timeout(this.timeout),i=Ke([this.shutDownController.signal,n,t.signal]),s=Ze(),o=Ze();let a=0;this.httpQueue.add(async()=>(s.resolve(),o.promise));try{await s.promise;const c=new URL(`${this.url}routing/v1/providers/${e}`);this.#t(c,t.filterAddrs,t.filterProtocols);const l={headers:{accept:"application/x-ndjson, application/json;q=0.8"},signal:i},u=await this.#r(c.toString(),l);if(!u.ok){if(u.status===404)return;throw u.status===422?new L1("Request does not conform to schema or semantic constraints"):new yi(`Unexpected status code: ${u.status}`)}const d=u.headers.get("Content-Type");if(d==null)throw new yi("No Content-Type header received");if(u.body==null){if(d!=="application/x-ndjson")throw new yi("Routing response had no body");return}if(d.startsWith("application/json")){const f=(await u.json()).Providers??[];for(const y of f){const m=this.#e(y);m!=null&&(a++,yield m)}}else if(d.includes("application/x-ndjson"))for await(const h of Um(Om(u.body))){const f=this.#e(h);f!=null&&(a++,yield f)}else throw new yi(`Unsupported Content-Type: ${d}`)}finally{i.clear(),o.resolve(),this.log("getProviders finished found %d providers for %c",a,e)}}async*getPeers(e,t={}){this.log("getPeers starts: %c",e);const n=AbortSignal.timeout(this.timeout),i=Ke([this.shutDownController.signal,n,t.signal]),s=Ze(),o=Ze();this.httpQueue.add(async()=>(s.resolve(),o.promise));try{await s.promise;const a=new URL(`${this.url}routing/v1/peers/${e.toCID().toString()}`);this.#t(a,t.filterAddrs,t.filterProtocols);const c={headers:{Accept:"application/x-ndjson"},signal:i},l=await this.#r(a.toString(),c);if(l.status===404)return;if(l.status===422)throw new L1("Request does not conform to schema or semantic constraints");if(l.body==null)throw new yi("Routing response had no body");if(l.headers.get("Content-Type")?.startsWith("application/json")){const h=(await l.json()).Peers??[];for(const f of h){const y=this.#e(f);y!=null&&(yield y)}}else for await(const d of Um(Om(l.body))){const h=this.#e(d);h!=null&&(yield h)}}catch(a){this.log.error("getPeers errored - %e",a)}finally{i.clear(),o.resolve(),this.log("getPeers finished: %c",e)}}async getIPNS(e,t={}){this.log("getIPNS starts: %s",e);const n=AbortSignal.timeout(this.timeout),i=Ke([this.shutDownController.signal,n,t.signal]),s=Ze(),o=Ze();this.httpQueue.add(async()=>(s.resolve(),o.promise));const a=`${this.url}routing/v1/ipns/${e}`;try{await s.promise;const c={headers:{Accept:"application/vnd.ipfs.ipns-record"},signal:i},l=await this.#r(a,c);if(this.log("getIPNS GET %s %d",a,l.status),l.status===404)throw new wt("No matching records found");if(l.status===422)throw new L1("Request does not conform to schema or semantic constraints");if(!l.ok)throw new yi(`Unexpected status code: ${l.status}`);const u=l.headers.get("Content-Type");if(u==null||!u.includes("application/vnd.ipfs.ipns-record"))throw new wt("No matching records found");if(l.body==null)throw new yi("GET ipns response had no body");const d=await l.arrayBuffer(),h=new Uint8Array(d,0,d.byteLength);return t.validate!==!1&&await f9(d9(e.multihash),h),Il(h)}catch(c){throw this.log.error("getIPNS GET %s error - %e",a,c),c}finally{i.clear(),o.resolve(),this.log("getIPNS finished: %s",e)}}async putIPNS(e,t,n={}){this.log("putIPNS starts: %c",e);const i=AbortSignal.timeout(this.timeout),s=Ke([this.shutDownController.signal,i,n.signal]),o=Ze(),a=Ze();this.httpQueue.add(async()=>(o.resolve(),a.promise));const c=`${this.url}routing/v1/ipns/${e}`;try{await o.promise;const l=u9(t),u={method:"PUT",headers:{"Content-Type":"application/vnd.ipfs.ipns-record"},body:l,signal:s},d=await this.#r(c,u);if(this.log("putIPNS PUT %s %d",c,d.status),d.status!==200)throw new yi("PUT ipns response had status other than 200")}catch(l){throw this.log.error("putIPNS PUT %s error - %e",c,l.stack),l}finally{s.clear(),a.resolve(),this.log("putIPNS finished: %c",e)}}#e(e){try{const t=[],n=e.Addrs?.map(be)??[];return e.Protocols!=null&&t.push(...e.Protocols),e.Protocol!=null&&(t.push(e.Protocol),delete e.Protocol),{...e,Schema:"peer",ID:or(e.ID),Addrs:n,Protocols:t}}catch(t){this.log.error("could not conform record to peer schema - %e",t)}}#t(e,t,n){if(t!=null||this.filterAddrs!=null){const i=t?.join(",")??this.filterAddrs?.join(",")??"";i!==""&&e.searchParams.set("filter-addrs",i)}if(n!=null||this.filterProtocols!=null){const i=n?.join(",")??this.filterProtocols?.join(",")??"";i!==""&&e.searchParams.set("filter-protocols",i)}}async#r(e,t){const n=t.method??"GET",i=`${n}-${e}`;if(n==="GET"){const c=await this.cache?.match(e);if(c!=null){if(parseInt(c.headers.get("x-cache-expires")??"0",10)>Date.now())return this.log("returning cached response for %s",i),this.logResponse(c),c;this.log("evicting cached response for %s",i),await this.cache?.delete(e)}else this.cache!=null&&this.log("cache miss for %s",i)}const s=this.inFlightRequests.get(i);if(s!=null){const c=await s;return this.log("deduplicating outgoing request for %s",i),c.clone()}this.log("outgoing request:"),this.logRequest(e,t);const o=fetch(e,t).then(async c=>{if(this.log("incoming response:"),this.logResponse(c),this.cache!=null&&c.ok&&n==="GET"){const l=Date.now()+this.cacheTTL,u=new Headers(c.headers);u.set("x-cache-expires",l.toString());const d=new Response(c.clone().body,{status:c.status,statusText:c.statusText,headers:u});await this.cache.put(e,d)}return c}).finally(()=>{this.inFlightRequests.delete(i)});return this.inFlightRequests.set(i,o),await o}toString(){return`DefaultDelegatedRoutingV1HttpApiClient(${this.url})`}logRequest(e,t){const n=new Headers(t.headers);this.log("%s %s HTTP/1.1",t.method??"GET",e);for(const[i,s]of n.entries())this.log("%s: %s",i,s)}logResponse(e){this.log("HTTP/1.1 %d %s",e.status,e.statusText);for(const[t,n]of e.headers.entries())this.log("%s: %s",t,n)}}function sB(r,e={}){return new iB({logger:gl()},{...e,url:new URL(r)})}function oB(){return{filterProtocols:["unknown","transport-bitswap","transport-ipfs-gateway-http"],filterAddrs:["https","webtransport","webrtc","webrtc-direct","wss","tls"]}}const zm="[a-fA-F\\d:]",Si=r=>r&&r.includeBoundaries?`(?:(?<=\\s|^)(?=${zm})|(?<=${zm})(?=\\s|$))`:"",Gr="(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)(?:\\.(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)){3}",gt="[a-fA-F\\d]{1,4}",of=`
(?:
(?:${gt}:){7}(?:${gt}|:)|                                    // 1:2:3:4:5:6:7::  1:2:3:4:5:6:7:8
(?:${gt}:){6}(?:${Gr}|:${gt}|:)|                             // 1:2:3:4:5:6::    1:2:3:4:5:6::8   1:2:3:4:5:6::8  1:2:3:4:5:6::1.2.3.4
(?:${gt}:){5}(?::${Gr}|(?::${gt}){1,2}|:)|                   // 1:2:3:4:5::      1:2:3:4:5::7:8   1:2:3:4:5::8    1:2:3:4:5::7:1.2.3.4
(?:${gt}:){4}(?:(?::${gt}){0,1}:${Gr}|(?::${gt}){1,3}|:)| // 1:2:3:4::        1:2:3:4::6:7:8   1:2:3:4::8      1:2:3:4::6:7:1.2.3.4
(?:${gt}:){3}(?:(?::${gt}){0,2}:${Gr}|(?::${gt}){1,4}|:)| // 1:2:3::          1:2:3::5:6:7:8   1:2:3::8        1:2:3::5:6:7:1.2.3.4
(?:${gt}:){2}(?:(?::${gt}){0,3}:${Gr}|(?::${gt}){1,5}|:)| // 1:2::            1:2::4:5:6:7:8   1:2::8          1:2::4:5:6:7:1.2.3.4
(?:${gt}:){1}(?:(?::${gt}){0,4}:${Gr}|(?::${gt}){1,6}|:)| // 1::              1::3:4:5:6:7:8   1::8            1::3:4:5:6:7:1.2.3.4
(?::(?:(?::${gt}){0,5}:${Gr}|(?::${gt}){1,7}|:))             // ::2:3:4:5:6:7:8  ::2:3:4:5:6:7:8  ::8             ::1.2.3.4
)(?:%[0-9a-zA-Z]{1,})?                                             // %eth0            %1
`.replace(/\s*\/\/.*$/gm,"").replace(/\n/g,"").trim(),aB=new RegExp(`(?:^${Gr}$)|(?:^${of}$)`),cB=new RegExp(`^${Gr}$`),lB=new RegExp(`^${of}$`),af=r=>r&&r.exact?aB:new RegExp(`(?:${Si(r)}${Gr}${Si(r)})|(?:${Si(r)}${of}${Si(r)})`,"g");af.v4=r=>r&&r.exact?cB:new RegExp(`${Si(r)}${Gr}${Si(r)}`,"g");af.v6=r=>r&&r.exact?lB:new RegExp(`${Si(r)}${of}${Si(r)}`,"g");function uB(r){const e=(...t)=>r(...t);return Object.defineProperty(e,"name",{value:`functionTimeout(${r.name||"<anonymous>"})`,configurable:!0}),e}const{toString:dB}=Object.prototype;function hB(r){return dB.call(r)==="[object RegExp]"}const Hm={global:"g",ignoreCase:"i",multiline:"m",dotAll:"s",sticky:"y",unicode:"u"};function fB(r,e={}){if(!hB(r))throw new TypeError("Expected a RegExp instance");const t=Object.keys(Hm).map(i=>(typeof e[i]=="boolean"?e[i]:r[i])?Hm[i]:"").join(""),n=new RegExp(e.source||r.source,t);return n.lastIndex=typeof e.lastIndex=="number"?e.lastIndex:r.lastIndex,n}function p9(r,e,{timeout:t}={}){try{return uB(()=>fB(r).test(e),{timeout:t})()}catch(n){throw n}}const pB=15,gB=45,g9={timeout:400};function qm(r){return r.length>gB?!1:p9(af.v6({exact:!0}),r,g9)}function mB(r){return r.length>pB?!1:p9(af.v4({exact:!0}),r,g9)}const Km={http:"80",https:"443",ws:"80",wss:"443"},yB=["http","https","ws","wss"];function m9(r,e){e=e??{};const t=e.defaultDnsType??"dns",{scheme:n,hostname:i,port:s,path:o}=wB(r),a=[bB(i,t),vB(s,n),EB(n)];o!=null&&a.push(SB(o));const c="/"+a.filter(l=>!!l).reduce((l,u)=>l.concat(u),[]).join("/");return be(c)}function wB(r){const[e]=r.split(":");yB.includes(e)||(r="http"+r.substring(e.length));let{protocol:t,hostname:n,port:i,pathname:s,search:o}=new URL(r);if(i==null||i===""){const c=xB(e);c!=null&&(i=c),c==null&&t==="http:"&&(i="80")}let a;return s!=null&&s!==""&&s!=="/"&&(s.startsWith("/")&&(s=s.substring(1)),a=s),o!=null&&o!==""&&(a=a??"",a+=o),{scheme:e,hostname:n,port:i,path:a}}function bB(r,e){if(!(r==null||r==="")){if(mB(r))return["ip4",r];if(qm(r))return["ip6",r];if(r[0]==="["){const t=r.substring(1,r.length-1);if(qm(t))return["ip6",t]}return[e,r]}}function vB(r,e){if(!(r==null||r===""))return e==="udp"?["udp",r]:["tcp",r]}function EB(r){if(r.match(/^tcp$|^udp$/)==null)return r==="https"?["/tls/http"]:r==="wss"?["/tls/ws"]:[r]}function SB(r){if(!(r==null||r===""))return["http-path",encodeURIComponent(r)]}function xB(r){if(!(r==null||r===""||Km[r]==null))return Km[r]}const AB=["https://trustless-gateway.link","https://4everland.io"],kB=2336;function CB(r){return r=r.toString(),{id:ya(ae.createV1(kB,jn.digest(W(r)))),multiaddrs:[m9(r)]}}function IB(r){return new URL(Y(r.id.toMultihash().digest))}class _B{gateways;shuffle;constructor(e={}){this.gateways=(e.gateways??AB).map(t=>CB(t)),this.shuffle=e.shuffle??!0}async*findProviders(e,t){yield*(this.shuffle?this.gateways.toSorted(()=>Math.random()>.5?1:-1):this.gateways).map(n=>({...n,protocols:["transport-ipfs-gateway-http"],routing:"http-gateway-routing"}))}toString(){return`HTTPGatewayRouter([${this.gateways.map(e=>IB(e)).join(", ")}])`}}function TB(r={}){return new _B(r)}class PB{libp2p;constructor(e){this.libp2p=e}async provide(e,t){await this.libp2p.contentRouting.provide(e,t)}async cancelReprovide(e,t){await this.libp2p.contentRouting.cancelReprovide(e,t)}async*findProviders(e,t){yield*this.libp2p.contentRouting.findProviders(e,t)}async put(e,t,n){await this.libp2p.contentRouting.put(e,t,n)}async get(e,t){return this.libp2p.contentRouting.get(e,t)}async findPeer(e,t){return this.libp2p.peerRouting.findPeer(e,t)}async*getClosestPeers(e,t){yield*this.libp2p.peerRouting.getClosestPeers(e,t)}toString(){return"Libp2pRouter()"}}function RB(r){return new PB(r)}function NB(r){return r[Symbol.asyncIterator]!=null}function Vo(r){if(NB(r))return(async()=>{const t=[];for await(const n of r)t.push(n);return t})();const e=[];for(const t of r)e.push(t);return e}function DB(r){return typeof r?.then=="function"}class BB extends Uw{data;constructor(){super(),this.data=new Map}put(e,t,n){n?.signal?.throwIfAborted();let i;if(t instanceof Uint8Array)i=[t];else{const s=Vo(t);if(DB(s))return s.then(o=>this._put(e,o,n));i=s}return this._put(e,i,n)}_put(e,t,n){return n?.signal?.throwIfAborted(),this.data.set(vr.encode(e.multihash.bytes),t),e}*get(e,t){t?.signal?.throwIfAborted();const n=this.data.get(vr.encode(e.multihash.bytes));if(n==null)throw new Hg;yield*n}has(e,t){return t?.signal?.throwIfAborted(),this.data.has(vr.encode(e.multihash.bytes))}async delete(e,t){t?.signal?.throwIfAborted(),this.data.delete(vr.encode(e.multihash.bytes))}*getAll(e){e?.signal?.throwIfAborted();for(const[t,n]of this.data.entries())yield{cid:ae.createV1(sn,Zt(vr.decode(t))),bytes:(async function*(){yield*n})()},e?.signal?.throwIfAborted()}}Xt("blockstore:core:tiered");const LB="SHARDING";function OB(r){return r[Symbol.asyncIterator]!=null}function Wm(r,e){return OB(r)?(async function*(){yield*(await Vo(r)).sort(e)})():(function*(){yield*Vo(r).sort(e)})()}class MB{put(e,t,n){return Promise.reject(new Error(".put is not implemented"))}get(e,t){return Promise.reject(new Error(".get is not implemented"))}has(e,t){return Promise.reject(new Error(".has is not implemented"))}delete(e,t){return Promise.reject(new Error(".delete is not implemented"))}async*putMany(e,t={}){for await(const{key:n,value:i}of e)await this.put(n,i,t),yield n}async*getMany(e,t={}){for await(const n of e)yield{key:n,value:await this.get(n,t)}}async*deleteMany(e,t={}){for await(const n of e)await this.delete(n,t),yield n}batch(){let e=[],t=[];return{put(n,i){e.push({key:n,value:i})},delete(n){t.push(n)},commit:async n=>{await Li(this.putMany(e,n)),e=[],await Li(this.deleteMany(t,n)),t=[]}}}async*_all(e,t){throw new Error("._all is not implemented")}async*_allKeys(e,t){throw new Error("._allKeys is not implemented")}query(e,t){let n=this._all(e,t);if(e.prefix!=null){const i=e.prefix;n=bi(n,s=>s.key.toString().startsWith(i))}if(Array.isArray(e.filters)&&(n=e.filters.reduce((i,s)=>bi(i,s),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((i,s)=>Wm(i,s),n)),e.offset!=null){let i=0;const s=e.offset;n=bi(n,()=>i++>=s)}return e.limit!=null&&(n=Sd(n,e.limit)),n}queryKeys(e,t){let n=this._allKeys(e,t);if(e.prefix!=null){const i=e.prefix;n=bi(n,s=>s.toString().startsWith(i))}if(Array.isArray(e.filters)&&(n=e.filters.reduce((i,s)=>bi(i,s),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((i,s)=>Wm(i,s),n)),e.offset!=null){const i=e.offset;let s=0;n=bi(n,()=>s++>=i)}return e.limit!=null&&(n=Sd(n,e.limit)),n}}class y9 extends MB{data;constructor(){super(),this.data=new Map}put(e,t,n){return n?.signal?.throwIfAborted(),this.data.set(e.toString(),t),e}get(e,t){t?.signal?.throwIfAborted();const n=this.data.get(e.toString());if(n==null)throw new Hg;return n}has(e,t){return t?.signal?.throwIfAborted(),this.data.has(e.toString())}delete(e,t){t?.signal?.throwIfAborted(),this.data.delete(e.toString())}*_all(e,t){t?.signal?.throwIfAborted();for(const[n,i]of this.data.entries())yield{key:new Ye(n),value:i},t?.signal?.throwIfAborted()}*_allKeys(e,t){t?.signal?.throwIfAborted();for(const n of this.data.keys())yield new Ye(n),t?.signal?.throwIfAborted()}}new Ye(LB);Xt("datastore:core:tiered");var $B={};async function UB(r){if(r.connectionProtector===null&&$B?.LIBP2P_FORCE_PNET!=null)throw new H("Private network is enforced, but no protector was provided");return r}var _d;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.publicKey!=null&&t.publicKey.byteLength>0&&(n.uint32(10),n.bytes(t.publicKey)),t.payloadType!=null&&t.payloadType.byteLength>0&&(n.uint32(18),n.bytes(t.payloadType)),t.payload!=null&&t.payload.byteLength>0&&(n.uint32(26),n.bytes(t.payload)),t.signature!=null&&t.signature.byteLength>0&&(n.uint32(42),n.bytes(t.signature)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{const s={publicKey:Re(0),payloadType:Re(0),payload:Re(0),signature:Re(0)},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.publicKey=t.bytes();break}case 2:{s.payloadType=t.bytes();break}case 3:{s.payload=t.bytes();break}case 5:{s.signature=t.bytes();break}default:{t.skipType(a&7);break}}}return s})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ae(t,r.codec(),n)})(_d||(_d={}));class FB extends Error{constructor(e="Invalid signature"){super(e),this.name="InvalidSignatureError"}}class An{static createFromProtobuf=e=>{const t=_d.decode(e),n=on(t.publicKey);return new An({publicKey:n,payloadType:t.payloadType,payload:t.payload,signature:t.signature})};static seal=async(e,t,n)=>{if(t==null)throw new Error("Missing private key");const i=e.domain,s=e.codec,o=e.marshal(),a=jm(i,s,o),c=await t.sign(a.subarray(),n);return new An({publicKey:t.publicKey,payloadType:s,payload:o,signature:c})};static openAndCertify=async(e,t,n)=>{const i=An.createFromProtobuf(e);if(!await i.validate(t,n))throw new FB("Envelope signature is not valid for the given domain");return i};publicKey;payloadType;payload;signature;marshaled;constructor(e){const{publicKey:t,payloadType:n,payload:i,signature:s}=e;this.publicKey=t,this.payloadType=n,this.payload=i,this.signature=s}marshal(){return this.marshaled==null&&(this.marshaled=_d.encode({publicKey:En(this.publicKey),payloadType:this.payloadType,payload:this.payload.subarray(),signature:this.signature})),this.marshaled}equals(e){return e==null?!1:Te(this.marshal(),e.marshal())}async validate(e,t){const n=jm(e,this.payloadType,this.payload);return this.publicKey.verify(n.subarray(),this.signature,t)}}const jm=(r,e,t)=>{const n=W(r),i=vn(n.byteLength),s=vn(e.length),o=vn(t.length);return new me(i,n,s,e,o,t)},VB="libp2p-peer-record",zB=Uint8Array.from([3,1]);var Td;(function(r){(function(t){let n;t.codec=()=>(n==null&&(n=Ce((i,s,o={})=>{o.lengthDelimited!==!1&&s.fork(),i.multiaddr!=null&&i.multiaddr.byteLength>0&&(s.uint32(10),s.bytes(i.multiaddr)),o.lengthDelimited!==!1&&s.ldelim()},(i,s,o={})=>{const a={multiaddr:Re(0)},c=s==null?i.len:i.pos+s;for(;i.pos<c;){const l=i.uint32();switch(l>>>3){case 1:{a.multiaddr=i.bytes();break}default:{i.skipType(l&7);break}}}return a})),n),t.encode=i=>ke(i,t.codec()),t.decode=(i,s)=>Ae(i,t.codec(),s)})(r.AddressInfo||(r.AddressInfo={}));let e;r.codec=()=>(e==null&&(e=Ce((t,n,i={})=>{if(i.lengthDelimited!==!1&&n.fork(),t.peerId!=null&&t.peerId.byteLength>0&&(n.uint32(10),n.bytes(t.peerId)),t.seq!=null&&t.seq!==0n&&(n.uint32(16),n.uint64(t.seq)),t.addresses!=null)for(const s of t.addresses)n.uint32(26),r.AddressInfo.codec().encode(s,n);i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{const s={peerId:Re(0),seq:0n,addresses:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.peerId=t.bytes();break}case 2:{s.seq=t.uint64();break}case 3:{if(i.limits?.addresses!=null&&s.addresses.length===i.limits.addresses)throw new Mt('Decode error - map field "addresses" had too many elements');s.addresses.push(r.AddressInfo.codec().decode(t,t.uint32(),{limits:i.limits?.addresses$}));break}default:{t.skipType(a&7);break}}}return s})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ae(t,r.codec(),n)})(Td||(Td={}));function HB(r,e){const t=(n,i)=>n.toString().localeCompare(i.toString());return r.length!==e.length?!1:(e.sort(t),r.sort(t).every((n,i)=>e[i].equals(n)))}class xr{static createFromProtobuf=e=>{const t=Td.decode(e),n=ln(Zt(t.peerId)),i=(t.addresses??[]).map(o=>be(o.multiaddr)),s=t.seq;return new xr({peerId:n,multiaddrs:i,seqNumber:s})};static DOMAIN=VB;static CODEC=zB;peerId;multiaddrs;seqNumber;domain=xr.DOMAIN;codec=xr.CODEC;marshaled;constructor(e){const{peerId:t,multiaddrs:n,seqNumber:i}=e;this.peerId=t,this.multiaddrs=n??[],this.seqNumber=i??BigInt(Date.now())}marshal(){return this.marshaled==null&&(this.marshaled=Td.encode({peerId:this.peerId.toMultihash().bytes,seq:BigInt(this.seqNumber),addresses:this.multiaddrs.map(e=>({multiaddr:e.bytes}))})),this.marshaled}equals(e){return!(!(e instanceof xr)||!this.peerId.equals(e.peerId)||this.seqNumber!==e.seqNumber||!HB(this.multiaddrs,e.multiaddrs))}}const qB=36e5,KB=216e5;var as;(function(r){(function(t){let n;t.codec=()=>(n==null&&(n=Ce((i,s,o={})=>{o.lengthDelimited!==!1&&s.fork(),i.key!=null&&i.key!==""&&(s.uint32(10),s.string(i.key)),i.value!=null&&i.value.byteLength>0&&(s.uint32(18),s.bytes(i.value)),o.lengthDelimited!==!1&&s.ldelim()},(i,s,o={})=>{const a={key:"",value:Re(0)},c=s==null?i.len:i.pos+s;for(;i.pos<c;){const l=i.uint32();switch(l>>>3){case 1:{a.key=i.string();break}case 2:{a.value=i.bytes();break}default:{i.skipType(l&7);break}}}return a})),n),t.encode=i=>ke(i,t.codec()),t.decode=(i,s)=>Ae(i,t.codec(),s)})(r.Peer$metadataEntry||(r.Peer$metadataEntry={})),(function(t){let n;t.codec=()=>(n==null&&(n=Ce((i,s,o={})=>{o.lengthDelimited!==!1&&s.fork(),i.key!=null&&i.key!==""&&(s.uint32(10),s.string(i.key)),i.value!=null&&(s.uint32(18),Rd.codec().encode(i.value,s)),o.lengthDelimited!==!1&&s.ldelim()},(i,s,o={})=>{const a={key:""},c=s==null?i.len:i.pos+s;for(;i.pos<c;){const l=i.uint32();switch(l>>>3){case 1:{a.key=i.string();break}case 2:{a.value=Rd.codec().decode(i,i.uint32(),{limits:o.limits?.value});break}default:{i.skipType(l&7);break}}}return a})),n),t.encode=i=>ke(i,t.codec()),t.decode=(i,s)=>Ae(i,t.codec(),s)})(r.Peer$tagsEntry||(r.Peer$tagsEntry={}));let e;r.codec=()=>(e==null&&(e=Ce((t,n,i={})=>{if(i.lengthDelimited!==!1&&n.fork(),t.addresses!=null)for(const s of t.addresses)n.uint32(10),Pd.codec().encode(s,n);if(t.protocols!=null)for(const s of t.protocols)n.uint32(18),n.string(s);if(t.publicKey!=null&&(n.uint32(34),n.bytes(t.publicKey)),t.peerRecordEnvelope!=null&&(n.uint32(42),n.bytes(t.peerRecordEnvelope)),t.metadata!=null&&t.metadata.size!==0)for(const[s,o]of t.metadata.entries())n.uint32(50),r.Peer$metadataEntry.codec().encode({key:s,value:o},n);if(t.tags!=null&&t.tags.size!==0)for(const[s,o]of t.tags.entries())n.uint32(58),r.Peer$tagsEntry.codec().encode({key:s,value:o},n);t.updated!=null&&(n.uint32(64),n.uint64Number(t.updated)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{const s={addresses:[],protocols:[],metadata:new Map,tags:new Map},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{if(i.limits?.addresses!=null&&s.addresses.length===i.limits.addresses)throw new Mt('Decode error - map field "addresses" had too many elements');s.addresses.push(Pd.codec().decode(t,t.uint32(),{limits:i.limits?.addresses$}));break}case 2:{if(i.limits?.protocols!=null&&s.protocols.length===i.limits.protocols)throw new Mt('Decode error - map field "protocols" had too many elements');s.protocols.push(t.string());break}case 4:{s.publicKey=t.bytes();break}case 5:{s.peerRecordEnvelope=t.bytes();break}case 6:{if(i.limits?.metadata!=null&&s.metadata.size===i.limits.metadata)throw new Y4('Decode error - map field "metadata" had too many elements');const c=r.Peer$metadataEntry.codec().decode(t,t.uint32());s.metadata.set(c.key,c.value);break}case 7:{if(i.limits?.tags!=null&&s.tags.size===i.limits.tags)throw new Y4('Decode error - map field "tags" had too many elements');const c=r.Peer$tagsEntry.codec().decode(t,t.uint32(),{limits:{value:i.limits?.tags$value}});s.tags.set(c.key,c.value);break}case 8:{s.updated=t.uint64Number();break}default:{t.skipType(a&7);break}}}return s})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ae(t,r.codec(),n)})(as||(as={}));var Pd;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.multiaddr!=null&&t.multiaddr.byteLength>0&&(n.uint32(10),n.bytes(t.multiaddr)),t.isCertified!=null&&(n.uint32(16),n.bool(t.isCertified)),t.observed!=null&&(n.uint32(24),n.uint64Number(t.observed)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{const s={multiaddr:Re(0)},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.multiaddr=t.bytes();break}case 2:{s.isCertified=t.bool();break}case 3:{s.observed=t.uint64Number();break}default:{t.skipType(a&7);break}}}return s})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ae(t,r.codec(),n)})(Pd||(Pd={}));var Rd;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.value!=null&&t.value!==0&&(n.uint32(8),n.uint32(t.value)),t.expiry!=null&&(n.uint32(16),n.uint64(t.expiry)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{const s={value:0},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.value=t.uint32();break}case 2:{s.expiry=t.uint64();break}default:{t.skipType(a&7);break}}}return s})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ae(t,r.codec(),n)})(Rd||(Rd={}));function WB(r,e){if(r.publicKey!=null||e.publicKey==null)return r;let t;r.type==="RSA"&&(t=r.toMultihash());const n=on(e.publicKey,t);return Fo(n)}function jB(r,e,t){const n=as.decode(e);return Ya(r,n,t)}function Ya(r,e,t){const n=new Map,i=BigInt(Date.now());for(const[s,o]of e.tags.entries())o.expiry!=null&&o.expiry<i||n.set(s,o);return{...e,id:WB(r,e),addresses:e.addresses.filter(({observed:s})=>s!=null&&s>Date.now()-t).map(({multiaddr:s,isCertified:o})=>({multiaddr:be(s),isCertified:o??!1})),metadata:e.metadata,peerRecordEnvelope:e.peerRecordEnvelope??void 0,tags:n}}function GB(r,e){return YB(r.addresses,e.addresses)&&QB(r.protocols,e.protocols)&&XB(r.publicKey,e.publicKey)&&ZB(r.peerRecordEnvelope,e.peerRecordEnvelope)&&JB(r.metadata,e.metadata)&&eL(r.tags,e.tags)}function YB(r,e){return b9(r,e,(t,n)=>!(t.isCertified!==n.isCertified||!Te(t.multiaddr,n.multiaddr)))}function QB(r,e){return b9(r,e,(t,n)=>t===n)}function XB(r,e){return w9(r,e)}function ZB(r,e){return w9(r,e)}function JB(r,e){return v9(r,e,(t,n)=>Te(t,n))}function eL(r,e){return v9(r,e,(t,n)=>t.value===n.value&&t.expiry===n.expiry)}function w9(r,e){return r==null&&e==null?!0:r!=null&&e!=null?Te(r,e):!1}function b9(r,e,t){if(r.length!==e.length)return!1;for(let n=0;n<r.length;n++)if(!t(r[n],e[n]))return!1;return!0}function v9(r,e,t){if(r.size!==e.size)return!1;for(const[n,i]of r.entries()){const s=e.get(n);if(s==null||!t(i,s))return!1}return!0}const E9="/peers/";function mu(r){if(!Ii(r)||r.type==null)throw new H("Invalid PeerId");const e=r.toCID().toString();return new Ye(`${E9}${e}`)}async function tL(r,e,t,n,i){const s=new Map;for(const o of t){if(o==null)continue;if(o.multiaddr instanceof Uint8Array&&(o.multiaddr=be(o.multiaddr)),!Sl(o.multiaddr))throw new H("Multiaddr was invalid");if(!await e(r,o.multiaddr,i))continue;const a=o.isCertified??!1,c=o.multiaddr.toString(),l=s.get(c);l!=null?o.isCertified=l.isCertified||a:s.set(c,{multiaddr:o.multiaddr,isCertified:a})}return[...s.values()].sort((o,a)=>o.multiaddr.toString().localeCompare(a.multiaddr.toString())).map(({isCertified:o,multiaddr:a})=>{const c=a.getComponents().find(l=>l.code===ge)?.value;return r.equals(c)&&(a=a.decapsulate(be(`/p2p/${r}`))),{isCertified:o,multiaddr:a.bytes}})}async function O1(r,e,t,n){if(e==null)throw new H("Invalid PeerData");if(e.publicKey!=null&&r.publicKey!=null&&!e.publicKey.equals(r.publicKey))throw new H("publicKey bytes do not match peer id publicKey bytes");const i=n.existingPeer?.peer;if(i!=null&&!r.equals(i.id))throw new H("peer id did not match existing peer id");let s=i?.addresses??[],o=new Set(i?.protocols??[]),a=i?.metadata??new Map,c=i?.tags??new Map,l=i?.peerRecordEnvelope;if(t==="patch"){if((e.multiaddrs!=null||e.addresses!=null)&&(s=[],e.multiaddrs!=null&&s.push(...e.multiaddrs.map(h=>({isCertified:!1,multiaddr:h}))),e.addresses!=null&&s.push(...e.addresses)),e.protocols!=null&&(o=new Set(e.protocols)),e.metadata!=null){const h=e.metadata instanceof Map?[...e.metadata.entries()]:Object.entries(e.metadata);a=yu(h,{validate:Gm})}if(e.tags!=null){const h=e.tags instanceof Map?[...e.tags.entries()]:Object.entries(e.tags);c=yu(h,{validate:Ym,map:Qm})}e.peerRecordEnvelope!=null&&(l=e.peerRecordEnvelope)}if(t==="merge"){if(e.multiaddrs!=null&&s.push(...e.multiaddrs.map(h=>({isCertified:!1,multiaddr:h}))),e.addresses!=null&&s.push(...e.addresses),e.protocols!=null&&(o=new Set([...o,...e.protocols])),e.metadata!=null){const h=e.metadata instanceof Map?[...e.metadata.entries()]:Object.entries(e.metadata);for(const[f,y]of h)y==null?a.delete(f):a.set(f,y);a=yu([...a.entries()],{validate:Gm})}if(e.tags!=null){const h=e.tags instanceof Map?[...e.tags.entries()]:Object.entries(e.tags),f=new Map(c);for(const[y,m]of h)m==null?f.delete(y):f.set(y,m);c=yu([...f.entries()],{validate:Ym,map:Qm})}e.peerRecordEnvelope!=null&&(l=e.peerRecordEnvelope)}let u;i?.id.publicKey!=null?u=En(i.id.publicKey):e.publicKey!=null?u=En(e.publicKey):r.publicKey!=null&&(u=En(r.publicKey));const d={addresses:await tL(r,n.addressFilter??(async()=>!0),s,n.existingPeer?.peerPB.addresses,n),protocols:[...o.values()].sort((h,f)=>h.localeCompare(f)),metadata:a,tags:c,publicKey:u,peerRecordEnvelope:l};return d.addresses.forEach(h=>{h.observed=n.existingPeer?.peerPB.addresses?.find(f=>Te(f.multiaddr,f.multiaddr))?.observed??Date.now()}),r.type!=="RSA"&&delete d.publicKey,d}function yu(r,e){const t=new Map;for(const[n,i]of r)i!=null&&e.validate(n,i);for(const[n,i]of r.sort(([s],[o])=>s.localeCompare(o)))i!=null&&t.set(n,e.map?.(n,i)??i);return t}function Gm(r,e){if(typeof r!="string")throw new H("Metadata key must be a string");if(!(e instanceof Uint8Array))throw new H("Metadata value must be a Uint8Array")}function Ym(r,e){if(typeof r!="string")throw new H("Tag name must be a string");if(e.value!=null){if(parseInt(`${e.value}`,10)!==e.value)throw new H("Tag value must be an integer");if(e.value<0||e.value>100)throw new H("Tag value must be between 0-100")}if(e.ttl!=null){if(parseInt(`${e.ttl}`,10)!==e.ttl)throw new H("Tag ttl must be an integer");if(e.ttl<0)throw new H("Tag ttl must be between greater than 0")}}function Qm(r,e){let t;e.expiry!=null&&(t=e.expiry),e.ttl!=null&&(t=BigInt(Date.now()+Number(e.ttl)));const n={value:e.value??0};return t!=null&&(n.expiry=t),n}function S9(r){const e=r.toString().split("/")[2],t=ae.parse(e,vr);return ya(t)}function M1(r,e,t){const n=S9(r);return jB(n,e,t)}function rL(r,e){return{prefix:E9,filters:(r.filters??[]).map(t=>({key:n,value:i})=>t(M1(n,i,e))),orders:(r.orders??[]).map(t=>(n,i)=>t(M1(n.key,n.value,e),M1(i.key,i.value,e)))}}class nL{peerId;datastore;locks;addressFilter;log;maxAddressAge;maxPeerAge;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:peer-store"),this.peerId=e.peerId,this.datastore=e.datastore,this.addressFilter=t.addressFilter,this.locks=Jh({name:"libp2p_peer_store_locks",metrics:e.metrics}),this.maxAddressAge=t.maxAddressAge??qB,this.maxPeerAge=t.maxPeerAge??KB}getLock(e){let t=this.locks.get(e);return t==null&&(t={refs:0,lock:_w({name:e.toString(),singleProcess:!0})},this.locks.set(e,t)),t.refs++,t}maybeRemoveLock(e,t){t.refs--,t.refs===0&&(t.lock.finalize(),this.locks.delete(e))}async getReadLock(e,t){const n=this.getLock(e);try{const i=await n.lock.readLock(t);return()=>{i(),this.maybeRemoveLock(e,n)}}catch(i){throw this.maybeRemoveLock(e,n),i}}async getWriteLock(e,t){const n=this.getLock(e);try{const i=await n.lock.writeLock(t);return()=>{i(),this.maybeRemoveLock(e,n)}}catch(i){throw this.maybeRemoveLock(e,n),i}}async has(e,t){try{return await this.load(e,t),!0}catch(n){if(n.name!=="NotFoundError")throw n}return!1}async delete(e,t){this.peerId.equals(e)||await this.datastore.delete(mu(e),t)}async load(e,t){const n=mu(e),i=await this.datastore.get(n,t),s=as.decode(i);if(this.#r(e,s))throw await this.datastore.delete(n,t),new wt;return Ya(e,s,this.peerId.equals(e)?1/0:this.maxAddressAge)}async save(e,t,n){const i=await this.#e(e,n),s=await O1(e,t,"patch",{...n,addressFilter:this.addressFilter});return this.#t(e,s,i)}async patch(e,t,n){const i=await this.#e(e,n),s=await O1(e,t,"patch",{...n,addressFilter:this.addressFilter,existingPeer:i});return this.#t(e,s,i)}async merge(e,t,n){const i=await this.#e(e,n),s=await O1(e,t,"merge",{addressFilter:this.addressFilter,existingPeer:i});return this.#t(e,s,i)}async*all(e){for await(const{key:t,value:n}of this.datastore.query(rL(e??{},this.maxAddressAge),e)){const i=S9(t);if(i.equals(this.peerId))continue;const s=as.decode(n);if(this.#r(i,s)){await this.datastore.delete(t,e);continue}yield Ya(i,s,this.peerId.equals(i)?1/0:this.maxAddressAge)}}async#e(e,t){try{const n=mu(e),i=await this.datastore.get(n,t),s=as.decode(i);if(this.#r(e,s))throw await this.datastore.delete(n,t),new wt;return{peerPB:s,peer:Ya(e,s,this.maxAddressAge)}}catch(n){n.name!=="NotFoundError"&&this.log.error("invalid peer data found in peer store - %e",n)}}async#t(e,t,n,i){t.updated=Date.now();const s=as.encode(t);return await this.datastore.put(mu(e),s,i),{peer:Ya(e,t,this.maxAddressAge),previous:n?.peer,updated:n==null||!GB(t,n.peerPB)}}#r(e,t){if(t.updated==null)return!0;if(this.peerId.equals(e))return!1;const n=t.updated<Date.now()-this.maxPeerAge,i=Date.now()-this.maxAddressAge,s=t.addresses.filter(o=>o.observed!=null&&o.observed>i);return n&&s.length===0}}class iL{store;events;peerId;log;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:peer-store"),this.events=e.events,this.peerId=e.peerId,this.store=new nL(e,t)}[Symbol.toStringTag]="@libp2p/peer-store";async forEach(e,t){for await(const n of this.store.all(t))e(n)}async all(e){return Vo(this.store.all(e))}async delete(e,t){const n=await this.store.getReadLock(e,t);try{await this.store.delete(e,t)}finally{n()}}async has(e,t){const n=await this.store.getReadLock(e,t);try{return await this.store.has(e,t)}finally{this.log.trace("has release read lock"),n?.()}}async get(e,t){const n=await this.store.getReadLock(e,t);try{return await this.store.load(e,t)}finally{n?.()}}async getInfo(e,t){const n=await this.get(e,t);return{id:n.id,multiaddrs:n.addresses.map(({multiaddr:i})=>i)}}async save(e,t,n){const i=await this.store.getWriteLock(e,n);try{const s=await this.store.save(e,t,n);return this.#e(e,s),s.peer}finally{i?.()}}async patch(e,t,n){const i=await this.store.getWriteLock(e,n);try{const s=await this.store.patch(e,t,n);return this.#e(e,s),s.peer}finally{i?.()}}async merge(e,t,n){const i=await this.store.getWriteLock(e,n);try{const s=await this.store.merge(e,t,n);return this.#e(e,s),s.peer}finally{i?.()}}async consumePeerRecord(e,t,n){const i=Ii(t)?t:Ii(t?.expectedPeer)?t.expectedPeer:void 0,s=Ii(t)||t===void 0?n:t,o=await An.openAndCertify(e,xr.DOMAIN,s),a=ya(o.publicKey.toCID());if(i?.equals(a)===!1)return this.log("envelope peer id was not the expected peer id - expected: %p received: %p",i,a),!1;const c=xr.createFromProtobuf(o.payload);let l;try{l=await this.get(a,s)}catch(u){if(u.name!=="NotFoundError")throw u}if(l?.peerRecordEnvelope!=null){const u=An.createFromProtobuf(l.peerRecordEnvelope),d=xr.createFromProtobuf(u.payload);if(d.seqNumber>=c.seqNumber)return this.log("sequence number was lower or equal to existing sequence number - stored: %d received: %d",d.seqNumber,c.seqNumber),!1}return await this.patch(c.peerId,{peerRecordEnvelope:e,addresses:c.multiaddrs.map(u=>({isCertified:!0,multiaddr:u}))},s),!0}#e(e,t){t.updated&&(this.peerId.equals(e)?this.events.safeDispatchEvent("self:peer:update",{detail:t}):this.events.safeDispatchEvent("peer:update",{detail:t}))}}function sL(r,e={}){return new iL(r,e)}const Xm=864e13;class oL{log;mappings;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:dns-mappings"),this.mappings=an({name:"libp2p_address_manager_dns_mappings",metrics:e.metrics})}has(e){const t=Ne(e);let n=t.host;(t.type==="ip4"||t.type==="ip6")&&t.sni!=null&&(n=t.sni);for(const i of this.mappings.values())if(i.domain===n)return!0;return!1}add(e,t){t.forEach(n=>{this.log("add DNS mapping %s to %s",n,e);const i=hg(n)===!0;this.mappings.set(n,{domain:e,verified:i,expires:i?Xm-Date.now():0,lastVerified:i?Xm-Date.now():void 0})})}remove(e){const t=Ne(e);if(t.type!=="ip4"&&t.type!=="ip6")return!1;let n=!1;for(const[i,s]of this.mappings.entries())s.domain===t.sni&&(this.log("removing %s to %s DNS mapping %e",i,s.domain),this.mappings.delete(i),n=n||s.verified);return n}getAll(e){const t=[];for(let n=0;n<e.length;n++){const i=e[n].multiaddr;if(!en(i))continue;const s=Ne(i);for(const[o,a]of this.mappings.entries()){if(s.host!==o)continue;const c=this.maybeAddSNIComponent(i,a.domain);c!=null&&(e.splice(n,1),n--,t.push({multiaddr:c,verified:a.verified,type:"dns-mapping",expires:a.expires,lastVerified:a.lastVerified}))}}return t}maybeAddSNIComponent(e,t){const n=e.getComponents();for(let i=0;i<n.length;i++)if(n[i].code===ps&&n[i+1]?.code!==pd)return n.splice(i+1,0,{name:"sni",code:pd,value:t}),be(n)}confirm(e,t){const n=Ne(e);let i=n.host;(n.type==="ip4"||n.type==="ip6")&&n.sni!=null&&(i=n.sni);let s=!1;for(const[o,a]of this.mappings.entries())a.domain===i&&(this.log("marking %s to %s DNS mapping as verified",o,a.domain),s=a.verified,a.verified=!0,a.expires=Date.now()+t,a.lastVerified=Date.now());return s}unconfirm(e,t){const n=Ne(e);if(n.type!=="ip4"&&n.type!=="ip6")return!1;const i=n.sni??n.host;let s=!1;for(const[o,a]of this.mappings.entries())a.domain===i&&(this.log("removing verification of %s to %s DNS mapping",o,a.domain),s=s||a.verified,a.verified=!1,a.expires=Date.now()+t);return s}}class aL{log;mappings;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:ip-mappings"),this.mappings=an({name:"libp2p_address_manager_ip_mappings",metrics:e.metrics})}has(e){const t=Ne(e);if(t.type!=="ip4"&&t.type!=="ip6")return!1;for(const n of this.mappings.values())for(const i of n)if(i.externalIp===t.host)return!0;return!1}add(e,t,n,i=t,s="tcp"){const o=`${e}-${t}-${s}`,a=this.mappings.get(o)??[],c={internalIp:e,internalPort:t,externalIp:n,externalPort:i,externalFamily:Mo(n)?4:6,protocol:s,verified:!1,expires:0};a.push(c),this.mappings.set(o,a)}remove(e){const t=Ne(e);if(t.type!=="ip4"&&t.type!=="ip6")return!1;let n=!1;for(const[i,s]of this.mappings.entries()){for(let o=0;o<s.length;o++){const a=s[o];a.externalIp===t.host&&a.externalPort===t.port&&a.protocol===t.protocol&&(this.log("removing %s:%s to %s:%s %s IP mapping",a.externalIp,a.externalPort,t.host,t.port,t.protocol),n=n||a.verified,s.splice(o,1),o--)}s.length===0&&this.mappings.delete(i)}return n}getAll(e){const t=[];for(const{multiaddr:n}of e){if(!en(n))continue;const i=Ne(n);if(i.type!=="ip4"&&i.type!=="ip6")continue;let s;if(i.protocol==="tcp"?s=`${i.host}-${i.port}-tcp`:i.protocol==="udp"&&(s=`${i.host}-${i.port}-udp`),s==null)continue;const o=this.mappings.get(s);if(o!=null)for(const a of o)t.push({multiaddr:this.maybeOverrideIp(n,a.externalIp,a.externalFamily,a.protocol,a.externalPort),verified:a.verified,type:"ip-mapping",expires:a.expires,lastVerified:a.lastVerified})}return t}maybeOverrideIp(e,t,n,i,s){const o=e.getComponents(),a=o.findIndex(l=>l.code===fd||l.code===xs),c=o.findIndex(l=>l.name===i);return a>-1&&c>-1?(o[a].value=t,o[a].code=n===4?fd:xs,o[c].value=`${s}`,be(o)):e}confirm(e,t){if(!en(e))return!1;const n=Ne(e);let i=!1;for(const s of this.mappings.values())for(const o of s)o.externalIp===n.host&&(this.log("marking %s to %s IP mapping as verified",o.internalIp,o.externalIp),i=o.verified,o.verified=!0,o.expires=Date.now()+t,o.lastVerified=Date.now());return i}unconfirm(e,t){if(!en(e))return!1;const n=Ne(e);let i=!1;for(const s of this.mappings.values())for(let o=0;o<s.length;o++){const a=s[o];a.externalIp===n.host&&a.externalPort===n.port&&a.protocol===n.protocol&&(this.log("removing verification of %s:%s to %s:%s %s IP mapping",a.externalIp,a.externalPort,n.host,n.port,n.protocol),i=i||a.verified,a.verified=!1,a.expires=Date.now()+t)}return i}}const cL={maxObservedAddresses:10};class lL{log;addresses;maxObservedAddresses;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:observed-addresses"),this.addresses=an({name:"libp2p_address_manager_observed_addresses",metrics:e.metrics}),this.maxObservedAddresses=t.maxObservedAddresses??cL.maxObservedAddresses}has(e){return this.addresses.has(e.toString())}removePrefixed(e){for(const t of this.addresses.keys())t.toString().startsWith(e)&&this.addresses.delete(t)}add(e){this.addresses.size!==this.maxObservedAddresses&&(Or(e)||FI(e)||(this.log("adding observed address %a",e),this.addresses.set(e.toString(),{verified:!1,expires:0})))}getAll(){return Array.from(this.addresses).map(([e,t])=>({multiaddr:be(e),verified:t.verified,type:"observed",expires:t.expires,lastVerified:t.lastVerified}))}remove(e){const t=this.addresses.get(e.toString())?.verified??!1;return this.log("removing observed address %a",e),this.addresses.delete(e.toString()),t}confirm(e,t){const n=e.toString(),i=this.addresses.get(n)??{verified:!1,expires:Date.now()+t,lastVerified:Date.now()},s=i.verified;return i.verified=!0,i.expires=Date.now()+t,i.lastVerified=Date.now(),this.log("marking observed address %a as verified",n),this.addresses.set(n,i),s}}const uL={maxObservedAddresses:10};class dL{log;addresses;maxObservedAddresses;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:observed-addresses"),this.addresses=an({name:"libp2p_address_manager_transport_addresses",metrics:e.metrics}),this.maxObservedAddresses=t.maxObservedAddresses??uL.maxObservedAddresses}get(e,t){if(Or(e))return{multiaddr:e,verified:!0,type:"transport",expires:Date.now()+t,lastVerified:Date.now()};const n=this.toKey(e);let i=this.addresses.get(n);return i==null&&(i={verified:!en(e),expires:0},this.addresses.set(n,i)),{multiaddr:e,verified:i.verified,type:"transport",expires:i.expires,lastVerified:i.lastVerified}}has(e){const t=this.toKey(e);return this.addresses.has(t)}remove(e){const t=this.toKey(e),n=this.addresses.get(t)?.verified??!1;return this.log("removing observed address %a",e),this.addresses.delete(t),n}confirm(e,t){const n=this.toKey(e),i=this.addresses.get(n)??{verified:!1,expires:0,lastVerified:0},s=i.verified;return i.verified=!0,i.expires=Date.now()+t,i.lastVerified=Date.now(),this.addresses.set(n,i),s}unconfirm(e,t){const n=this.toKey(e),i=this.addresses.get(n)??{verified:!1,expires:0},s=i.verified;return i.verified=!1,i.expires=Date.now()+t,this.addresses.set(n,i),s}toKey(e){if(!en(e))return e.toString();const t=Ne(e);return`${t.host}-${t.port}-${t.protocol}`}}const Zm=6e4,Jm={addressVerificationTTL:Zm*10,addressVerificationRetry:Zm*5},hL=r=>r;function $1(r,e){const t=r.getComponents().findLast(n=>n.code===ge)?.value;return t!=null&&or(t).equals(e)&&(r=r.decapsulate(be(`/p2p/${e.toString()}`))),r}class fL{log;components;listen;announce;appendAnnounce;announceFilter;observed;dnsMappings;ipMappings;transportAddresses;observedAddressFilter;addressVerificationTTL;addressVerificationRetry;constructor(e,t={}){const{listen:n=[],announce:i=[],appendAnnounce:s=[]}=t;this.components=e,this.log=e.logger.forComponent("libp2p:address-manager"),this.listen=n.map(o=>o.toString()),this.announce=new Set(i.map(o=>o.toString())),this.appendAnnounce=new Set(s.map(o=>o.toString())),this.observed=new lL(e,t),this.dnsMappings=new oL(e,t),this.ipMappings=new aL(e,t),this.transportAddresses=new dL(e,t),this.announceFilter=t.announceFilter??hL,this.observedAddressFilter=Mi(1024),this.addressVerificationTTL=t.addressVerificationTTL??Jm.addressVerificationTTL,this.addressVerificationRetry=t.addressVerificationRetry??Jm.addressVerificationRetry,this._updatePeerStoreAddresses=Vc(this._updatePeerStoreAddresses.bind(this),1e3),e.events.addEventListener("transport:listening",()=>{this._updatePeerStoreAddresses()}),e.events.addEventListener("transport:close",()=>{this._updatePeerStoreAddresses()})}[Symbol.toStringTag]="@libp2p/address-manager";_updatePeerStoreAddresses(){const e=this.getAddresses().map(t=>t.getComponents().findLast(n=>n.code===ge)?.value===this.components.peerId.toString()?t.decapsulate(`/p2p/${this.components.peerId.toString()}`):t);this.components.peerStore.patch(this.components.peerId,{multiaddrs:e}).catch(t=>{this.log.error("error updating addresses - %e",t)})}getListenAddrs(){return Array.from(this.listen).map(e=>be(e))}getAnnounceAddrs(){return Array.from(this.announce).map(e=>be(e))}getAppendAnnounceAddrs(){return Array.from(this.appendAnnounce).map(e=>be(e))}getObservedAddrs(){return this.observed.getAll().map(e=>e.multiaddr)}addObservedAddr(e){const t=Ne(e);let n;switch(t.type){case"ip4":{n=`${t.host}:${t.port}`;break}case"ip6":{n=`[${t.host}]:${t.port}`;break}default:return}this.observedAddressFilter.has(n)||(this.observedAddressFilter.add(n),e=$1(e,this.components.peerId),!this.ipMappings.has(e)&&(this.dnsMappings.has(e)||this.observed.add(e)))}confirmObservedAddr(e,t){e=$1(e,this.components.peerId);let n=!0;(t?.type==="transport"||this.transportAddresses.has(e))&&!this.transportAddresses.confirm(e,t?.ttl??this.addressVerificationTTL)&&n&&(n=!1),(t?.type==="dns-mapping"||this.dnsMappings.has(e))&&!this.dnsMappings.confirm(e,t?.ttl??this.addressVerificationTTL)&&n&&(n=!1),(t?.type==="ip-mapping"||this.ipMappings.has(e))&&!this.ipMappings.confirm(e,t?.ttl??this.addressVerificationTTL)&&n&&(n=!1),(t?.type==="observed"||this.observed.has(e))&&(this.maybeUpgradeToIPMapping(e)?(this.ipMappings.confirm(e,t?.ttl??this.addressVerificationTTL),n=!1):!this.observed.confirm(e,t?.ttl??this.addressVerificationTTL)&&n&&(n=!1)),n||this._updatePeerStoreAddresses()}removeObservedAddr(e,t){e=$1(e,this.components.peerId),this.observed.has(e)&&this.observed.remove(e),this.transportAddresses.has(e)&&this.transportAddresses.unconfirm(e,t?.ttl??this.addressVerificationRetry),this.dnsMappings.has(e)&&this.dnsMappings.unconfirm(e,t?.ttl??this.addressVerificationRetry),this.ipMappings.has(e)&&this.ipMappings.unconfirm(e,t?.ttl??this.addressVerificationRetry)}getAddresses(){const e=new Set,t=this.getAddressesWithMetadata().filter(n=>{if(!n.verified)return!1;const i=n.multiaddr.toString();return e.has(i)?!1:(e.add(i),!0)}).map(n=>n.multiaddr);return this.announceFilter(t.map(n=>{const i=be(n);return i.getComponents().pop()?.value===this.components.peerId.toString()?i:i.encapsulate(`/p2p/${this.components.peerId.toString()}`)}))}getAddressesWithMetadata(){const e=this.getAnnounceAddrs();if(e.length>0)return this.components.transportManager.getListeners().forEach(i=>{i.updateAnnounceAddrs(e)}),e.map(i=>({multiaddr:i,verified:!0,type:"announce",expires:Date.now()+this.addressVerificationTTL,lastVerified:Date.now()}));let t=[];t=t.concat(this.components.transportManager.getAddrs().map(i=>this.transportAddresses.get(i,this.addressVerificationTTL)));const n=this.getAppendAnnounceAddrs();return n.length>0&&(this.components.transportManager.getListeners().forEach(i=>{i.updateAnnounceAddrs(n)}),t=t.concat(n.map(i=>({multiaddr:i,verified:!0,type:"announce",expires:Date.now()+this.addressVerificationTTL,lastVerified:Date.now()})))),t=t.concat(this.observed.getAll()),t=t.concat(this.ipMappings.getAll(t)),t=t.concat(this.dnsMappings.getAll(t)),t}addDNSMapping(e,t){this.dnsMappings.add(e,t)}removeDNSMapping(e){this.dnsMappings.remove(be(`/dns/${e}`))&&this._updatePeerStoreAddresses()}addPublicAddressMapping(e,t,n,i=t,s="tcp"){this.ipMappings.add(e,t,n,i,s),this.observed.removePrefixed(`/ip${Mo(n)?4:6}/${n}/${s}/${i}`)}removePublicAddressMapping(e,t,n,i=t,s="tcp"){this.ipMappings.remove(be(`/ip${Mo(n)?4:6}/${n}/${s}/${i}`))&&this._updatePeerStoreAddresses()}maybeUpgradeToIPMapping(e){if(this.ipMappings.has(e)||!en(e))return!1;const t=Ne(e);if(t.type!=="ip4"||hg(t.host)===!0)return!1;const n=this.components.transportManager.getListeners(),i=[s=>Zc.exactMatch(s)||Cd.exactMatch(s),s=>kd.exactMatch(s),s=>AD.exactMatch(s)];for(const s of i){if(!s(e))continue;const o=n.filter(l=>l.getAddrs().filter(u=>Ne(u).type==="ip4"&&s(u)).length>0);if(o.length!==1)continue;const a=o[0].getAddrs().filter(l=>!_0(l)).pop();if(a==null)continue;const c=Ne(a);return c.port==null?!1:(this.observed.remove(e),this.ipMappings.add(c.host,c.port,t.host,t.port,t.protocol),!0)}return!1}}var ey;(function(r){r.NOT_STARTED_YET="The libp2p node is not started yet",r.NOT_FOUND="Not found"})(ey||(ey={}));class pL extends Error{constructor(e="Missing service"){super(e),this.name="MissingServiceError"}}class gL extends Error{constructor(e="Unmet service dependencies"){super(e),this.name="UnmetServiceDependenciesError"}}class U1 extends Error{constructor(e="No content routers available"){super(e),this.name="NoContentRoutersError"}}class ty extends Error{constructor(e="No peer routers available"){super(e),this.name="NoPeerRoutersError"}}class mL extends Error{constructor(e="Should not try to find self"){super(e),this.name="QueriedForSelfError"}}class yL extends Error{constructor(e="Unhandled protocol error"){super(e),this.name="UnhandledProtocolError"}}class wL extends Error{constructor(e="Duplicate protocol handler error"){super(e),this.name="DuplicateProtocolHandlerError"}}class ry extends Error{constructor(e="Dial denied error"){super(e),this.name="DialDeniedError"}}class bL extends Error{constructor(e="No transport was configured to listen on this address"){super(e),this.name="UnsupportedListenAddressError"}}class vL extends Error{constructor(e="Configured listen addresses could not be listened on"){super(e),this.name="UnsupportedListenAddressesError"}}class EL extends Error{constructor(e="No valid addresses"){super(e),this.name="NoValidAddressesError"}}class SL extends Error{constructor(e="Connection intercepted"){super(e),this.name="ConnectionInterceptedError"}}class xL extends Error{constructor(e="Connection denied"){super(e),this.name="ConnectionDeniedError"}}class zu extends Error{constructor(e="Stream is not multiplexed"){super(e),this.name="MuxerUnavailableError"}}class wu extends Error{constructor(e="Encryption failed"){super(e),this.name="EncryptionFailedError"}}class AL extends Error{constructor(e="Transport unavailable"){super(e),this.name="TransportUnavailableError"}}class kL extends Error{constructor(e="Max recursive depth reached"){super(e),this.name="RecursionLimitError"}}class CL{components={};_started=!1;constructor(e={}){this.components={};for(const[t,n]of Object.entries(e))this.components[t]=n;this.components.logger==null&&(this.components.logger=gl())}isStarted(){return this._started}async _invokeStartableMethod(e){await Promise.all(Object.values(this.components).filter(t=>$p(t)).map(async t=>{await t[e]?.()}))}async beforeStart(){await this._invokeStartableMethod("beforeStart")}async start(){await this._invokeStartableMethod("start"),this._started=!0}async afterStart(){await this._invokeStartableMethod("afterStart")}async beforeStop(){await this._invokeStartableMethod("beforeStop")}async stop(){await this._invokeStartableMethod("stop"),this._started=!1}async afterStop(){await this._invokeStartableMethod("afterStop")}}const IL=["metrics","connectionProtector","dns"],_L=["components","isStarted","beforeStart","start","afterStart","beforeStop","stop","afterStop","then","_invokeStartableMethod"];function TL(r={}){const e=new CL(r);return new Proxy(e,{get(n,i,s){if(typeof i=="string"&&!_L.includes(i)){const o=e.components[i];if(o==null&&!IL.includes(i))throw new pL(`${i} not set`);return o}return Reflect.get(n,i,s)},set(n,i,s){return typeof i=="string"?e.components[i]=s:Reflect.set(n,i,s),!0}})}function PL(r){const e={};for(const t of Object.values(r.components))for(const n of RL(t))e[n]=!0;for(const t of Object.values(r.components))for(const n of NL(t))if(e[n]!==!0)throw new gL(`Service "${DL(t)}" required capability "${n}" but it was not provided by any component, you may need to add additional configuration when creating your node.`)}function RL(r){return Array.isArray(r?.[It])?r[It]:[]}function NL(r){return Array.isArray(r?.[ws])?r[ws]:[]}function DL(r){return r?.[Symbol.toStringTag]??r?.toString()??"unknown"}function BL(r={}){return r.denyDialMultiaddr==null&&(r.denyDialMultiaddr=e=>Zc.matches(e)?!0:Or(e)),r}function x9(r){if(Ii(r))return{peerId:r,multiaddrs:[]};let e=Array.isArray(r)?r:[r],t;if(e.length>0){const n=e[0].getComponents().findLast(i=>i.code===ge)?.value;t=n==null?void 0:or(n),e.forEach(i=>{if(!Sl(i))throw new Bh("Invalid multiaddr");const s=i.getComponents().findLast(o=>o.code===ge)?.value;if(s==null){if(t!=null)throw new H("Multiaddrs must all have the same peer id or have no peer id")}else{const o=or(s);if(t?.equals(o)!==!0)throw new H("Multiaddrs must all have the same peer id or have no peer id")}})}return e=e.filter(n=>!vD.exactMatch(n)),{peerId:t,multiaddrs:e}}const LL=["/ipfs/id/1.0.0","/ipfs/id/push/1.0.0","/libp2p/autonat/1.0.0","/libp2p/dcutr"];async function OL(r,e){const t=r?.streams?.map(i=>i.protocol)??[],n=e?.closableProtocols??LL;if(!(t.filter(i=>i!=null&&!n.includes(i)).length>0))try{await r?.close(e)}catch(i){r?.abort(i)}}function q0(r){const e=Ne(r);let t=e.cidr;if(e.type!=="ip4"&&e.type!=="ip6")throw new H(`Multiaddr ${r} was not an IPv4 or IPv6 address`);if(t==null)switch(e.type){case"ip4":{t=32;break}case"ip6":{t=128;break}default:throw new H(`Multiaddr ${r} was not an IPv4 or IPv6 address`)}return new N7(e.host,t)}function A9(r){return!_n.exactMatch(r)}function k9(r,e,t){if(r==null||e==null)return;const n=e.sort((s,o)=>s.direct?-1:o.direct?1:0).find(s=>s.limits==null);if(n==null||n.direct||t==null)return n;if(!t.some(s=>A9(s)))return n}class ML{connectionManager;peerStore;allow;events;log;constructor(e,t={}){this.allow=(t.allow??[]).map(n=>q0(n)),this.connectionManager=e.connectionManager,this.peerStore=e.peerStore,this.events=e.events,this.log=e.logger.forComponent("libp2p:connection-manager:connection-pruner"),this.maybePruneConnections=this.maybePruneConnections.bind(this)}start(){this.events.addEventListener("connection:open",this.maybePruneConnections)}stop(){this.events.removeEventListener("connection:open",this.maybePruneConnections)}maybePruneConnections(){this._maybePruneConnections().catch(e=>{this.log.error("error while pruning connections - %e",e)})}async _maybePruneConnections(){const e=this.connectionManager.getConnections(),t=e.length,n=this.connectionManager.getMaxConnections();if(this.log("checking max connections limit %d/%d",t,n),t<=n)return;const i=new Gs;for(const c of e){const l=c.remotePeer;if(!i.has(l)){i.set(l,0);try{const u=await this.peerStore.get(l);i.set(l,[...u.tags.values()].reduce((d,h)=>d+h.value,0))}catch(u){u.name!=="NotFoundError"&&this.log.error("error loading peer tags - %e",u)}}}const s=this.sortConnections(e,i),o=Math.max(t-n,0),a=[];for(const c of s)if(this.log("too many connections open - closing a connection to %p",c.remotePeer),this.allow.some(u=>{if(en(c.remoteAddr)){const d=Ne(c.remoteAddr);return u.contains(d.host)}return!0})||a.push(c),a.length===o)break;await Promise.all(a.map(async c=>{await OL(c,{signal:AbortSignal.timeout(1e3)})})),this.events.safeDispatchEvent("connection:prune",{detail:a})}sortConnections(e,t){return e.sort((n,i)=>{const s=n.timeline.open,o=i.timeline.open;return s<o?1:s>o?-1:0}).sort((n,i)=>n.direction==="outbound"&&i.direction==="inbound"?1:n.direction==="inbound"&&i.direction==="outbound"?-1:0).sort((n,i)=>n.streams.length>i.streams.length?1:n.streams.length<i.streams.length?-1:0).sort((n,i)=>{const s=t.get(n.remotePeer)??0,o=t.get(i.remotePeer)??0;return s>o?1:s<o?-1:0})}}const C9=1e4,I9=1e3,$L=1e4,Nd=1e4,_9=25,UL=5,FL=10,VL=5,zL="last-dial-failure",HL="last-dial-success",T9=500,qL=32,KL=100,P9=50;function WL(r,e){const t=kd.exactMatch(r.multiaddr),n=kd.exactMatch(e.multiaddr);if(t&&!n)return-1;if(!t&&n)return 1;const i=Cd.exactMatch(r.multiaddr),s=Cd.exactMatch(e.multiaddr);if(i&&!s)return-1;if(!i&&s)return 1;const o=Zc.exactMatch(r.multiaddr),a=Zc.exactMatch(e.multiaddr);if(o&&!a)return-1;if(!o&&a)return 1;const c=F0.exactMatch(r.multiaddr),l=F0.exactMatch(e.multiaddr);if(c&&!l)return-1;if(!c&&l)return 1;const u=U0.exactMatch(r.multiaddr),d=U0.exactMatch(e.multiaddr);if(u&&!d)return-1;if(!u&&d)return 1;const h=Lm.exactMatch(r.multiaddr),f=Lm.exactMatch(e.multiaddr);return h&&!f?-1:!h&&f?1:0}function jL(r,e){const t=_0(r.multiaddr),n=_0(e.multiaddr);return t&&!n?1:!t&&n?-1:0}function GL(r,e){const t=Or(r.multiaddr),n=Or(e.multiaddr);return t&&!n?1:!t&&n?-1:0}function YL(r,e){return r.isCertified&&!e.isCertified?-1:!r.isCertified&&e.isCertified?1:0}function QL(r,e){const t=_n.exactMatch(r.multiaddr),n=_n.exactMatch(e.multiaddr);return t&&!n?1:!t&&n?-1:0}function XL(r){return r.sort(WL).sort(YL).sort(QL).sort(GL).sort(jL)}class ZL{dns;canResolve(e){return e.getComponents().some(({name:t})=>t==="dnsaddr")}async resolve(e,t){const n=e.getComponents().find(c=>c.name==="dnsaddr")?.value;if(n==null)return[e];const s=await this.getDNS(t).query(`_dnsaddr.${n}`,{signal:t?.signal,types:[Bi.TXT]}),o=e.getComponents().find(c=>c.name==="p2p")?.value,a=[];for(const c of s.Answer){const l=c.data.replace(/["']/g,"").trim().split("=")[1];l!=null&&(o!=null&&!l.includes(o)||a.push(be(l)))}return a}getDNS(e){return e.dns!=null?e.dns:(this.dns==null&&(this.dns=x8()),this.dns)}}const R9=new ZL;async function N9(r,e,t){const n=t.depth??0;if(n>(t.maxRecursiveDepth??qL))throw new kL("Max recursive depth reached");let i=!1;const s=[];for(const o of Object.values(e))if(o.canResolve(r)){i=!0;const a=await o.resolve(r,t);for(const c of a)s.push(...await N9(c,e,{...t,depth:n+1}))}return i===!1&&s.push(r),s}const Ua={maxParallelDials:P9,maxDialQueueLength:T9,maxPeerAddrsToDial:_9,dialTimeout:C9,resolvers:{dnsaddr:R9}};class JL{queue;components;addressSorter;maxPeerAddrsToDial;maxDialQueueLength;dialTimeout;shutDownController;connections;log;resolvers;constructor(e,t={}){this.addressSorter=t.addressSorter,this.maxPeerAddrsToDial=t.maxPeerAddrsToDial??Ua.maxPeerAddrsToDial,this.maxDialQueueLength=t.maxDialQueueLength??Ua.maxDialQueueLength,this.dialTimeout=t.dialTimeout??Ua.dialTimeout,this.connections=t.connections??new Gs,this.log=e.logger.forComponent("libp2p:connection-manager:dial-queue"),this.components=e,this.resolvers=t.resolvers??Ua.resolvers,this.shutDownController=new AbortController,this.shutDownController.signal,this.queue=new HP({concurrency:t.maxParallelDials??Ua.maxParallelDials,metricName:"libp2p_dial_queue",metrics:e.metrics}),this.queue.addEventListener("failure",n=>{n.detail?.error.name!==ys.name&&this.log.error("error in dial queue - %e",n.detail.error)})}start(){this.shutDownController=new AbortController,this.shutDownController.signal}stop(){this.shutDownController.abort(),this.queue.abort()}async dial(e,t={}){const{peerId:n,multiaddrs:i}=x9(e);if(n!=null&&t.force!==!0){const o=k9(n,this.connections.get(n),i);if(o!=null)return this.log("already connected to %a",o.remoteAddr),t.onProgress?.(new oe("dial-queue:already-connected")),o}const s=this.queue.queue.find(o=>{if(n?.equals(o.options.peerId)===!0)return!0;const a=o.options.multiaddrs;if(a==null)return!1;for(const c of i)if(a.has(c.toString()))return!0;return!1});if(s!=null){this.log("joining existing dial target for %p",n);for(const o of i)s.options.multiaddrs.add(o.toString());return t.onProgress?.(new oe("dial-queue:already-in-dial-queue")),s.join(t)}if(this.queue.size>=this.maxDialQueueLength)throw new Ou("Dial queue is full");return this.log("creating dial target for %p",n,i.map(o=>o.toString())),t.onProgress?.(new oe("dial-queue:add-to-dial-queue")),this.queue.add(async o=>{o.onProgress?.(new oe("dial-queue:start-dial"));const a=Ke([this.shutDownController.signal,o.signal]);try{return await this.dialPeer(o,a)}finally{a.clear()}},{peerId:n,priority:t.priority??D9,multiaddrs:new Set(i.map(o=>o.toString())),signal:t.signal??AbortSignal.timeout(this.dialTimeout),onProgress:t.onProgress})}async dialPeer(e,t){const n=e.peerId,i=e.multiaddrs,s=new Set;let o=e.multiaddrs.size===0,a=0,c=0;const l=[];for(this.log("starting dial to %p",n);o||i.size>0;){c++,o=!1;const u=[],d=new Set(e.multiaddrs);i.clear(),this.log("calculating addrs to dial %p from %s",n,[...d]);const h=await this.calculateMultiaddrs(n,d,{...e,signal:t});for(const f of h){if(s.has(f.multiaddr.toString())){this.log.trace("skipping previously failed multiaddr %a while dialing %p",f.multiaddr,n);continue}u.push(f)}this.log("%s dial to %p with %s",c===1?"starting":"continuing",n,u.map(f=>f.multiaddr.toString())),e?.onProgress?.(new oe("dial-queue:calculated-addresses",u));for(const f of u){if(a===this.maxPeerAddrsToDial)throw this.log("dialed maxPeerAddrsToDial (%d) addresses for %p, not trying any others",a,e.peerId),new Ou("Peer had more than maxPeerAddrsToDial");a++;try{const y=await this.components.transportManager.dial(f.multiaddr,{...e,signal:t});this.log("dial to %a succeeded",f.multiaddr);try{await this.components.peerStore.merge(y.remotePeer,{multiaddrs:[y.remoteAddr],metadata:{[HL]:W(Date.now().toString())}})}catch(m){this.log.error("could not update last dial failure key for %p - %e",n,m)}return y}catch(y){if(this.log.error("dial failed to %a - %e",f.multiaddr,y),s.add(f.multiaddr.toString()),n!=null)try{await this.components.peerStore.merge(n,{metadata:{[zL]:W(Date.now().toString())}})}catch(m){this.log.error("could not update last dial failure key for %p - %e",n,m)}if(t.aborted)throw new Lh(y.message);l.push(y)}}}throw l.length===1?l[0]:new AggregateError(l,"All multiaddr dials failed")}async calculateMultiaddrs(e,t=new Set,n={}){const i=[...t].map(d=>({multiaddr:be(d),isCertified:!1}));if(e!=null){if(this.components.peerId.equals(e))throw new Ou("Tried to dial self");if(await this.components.connectionGater.denyDialPeer?.(e)===!0)throw new ry("The dial request is blocked by gater.allowDialPeer");if(i.length===0){this.log("loading multiaddrs for %p",e);try{const d=await this.components.peerStore.get(e);i.push(...d.addresses),this.log("loaded multiaddrs for %p",e,i.map(({multiaddr:h})=>h.toString()))}catch(d){if(d.name!=="NotFoundError")throw d}}if(i.length===0){this.log("looking up multiaddrs for %p in the peer routing",e);try{const d=await this.components.peerRouting.findPeer(e,n);this.log("found multiaddrs for %p in the peer routing",e,i.map(({multiaddr:h})=>h.toString())),i.push(...d.multiaddrs.map(h=>({multiaddr:h,isCertified:!1})))}catch(d){d.name==="NoPeerRoutersError"?this.log("no peer routers configured",e):this.log.error("looking up multiaddrs for %p in the peer routing failed - %e",e,d)}}}let s=(await Promise.all(i.map(async d=>{const h=await N9(d.multiaddr,this.resolvers,{dns:this.components.dns,log:this.log,...n});return h.length===1&&h[0].equals(d.multiaddr)?d:h.map(f=>({multiaddr:f,isCertified:!1}))}))).flat();if(e!=null){const d=`/p2p/${e.toString()}`;s=s.map(h=>h.multiaddr.getComponents().pop()?.name!=="p2p"?{multiaddr:h.multiaddr.encapsulate(d),isCertified:h.isCertified}:h)}const o=s.filter(d=>{if(this.components.transportManager.dialTransportForMultiaddr(d.multiaddr)==null)return!1;const h=d.multiaddr.getComponents().findLast(f=>f.code===ge)?.value;return e!=null&&h!=null?e.equals(h):!0}),a=new Map;for(const d of o){const h=d.multiaddr.toString(),f=a.get(h);if(f!=null){f.isCertified=f.isCertified||d.isCertified||!1;continue}a.set(h,d)}const c=[...a.values()];if(c.length===0)throw new EL("The dial request has no valid addresses");const l=[];for(const d of c)this.components.connectionGater.denyDialMultiaddr!=null&&await this.components.connectionGater.denyDialMultiaddr(d.multiaddr)||l.push(d);const u=this.addressSorter==null?XL(l):l.sort(this.addressSorter);if(u.length===0)throw new ry("The connection gater denied all addresses in the dial request");return this.log.trace("addresses for %p before filtering",e??"unknown peer",s.map(({multiaddr:d})=>d.toString())),this.log.trace("addresses for %p after filtering",e??"unknown peer",u.map(({multiaddr:d})=>d.toString())),u}async isDialable(e,t={}){Array.isArray(e)||(e=[e]);try{const n=await this.calculateMultiaddrs(void 0,new Set(e.map(i=>i.toString())),t);return t.runOnLimitedConnection===!1?n.find(i=>!_n.matches(i.multiaddr))!=null:!0}catch{}return!1}}const eO=Object.prototype.toString,tO=r=>eO.call(r)==="[object Error]",rO=new Set(["network error","Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed","fetch failed","terminated"," A network error occurred.","Network connection lost"]);function nO(r){if(!(r&&tO(r)&&r.name==="TypeError"&&typeof r.message=="string"))return!1;const{message:t,stack:n}=r;return t==="Load failed"?n===void 0||"__sentry_captured__"in r:t.startsWith("error sending request for url")?!0:rO.has(t)}function iO(r){if(typeof r=="number"){if(r<0)throw new TypeError("Expected `retries` to be a non-negative number.");if(Number.isNaN(r))throw new TypeError("Expected `retries` to be a valid number or Infinity, got NaN.")}else if(r!==void 0)throw new TypeError("Expected `retries` to be a number or Infinity.")}function bu(r,e,{min:t=0,allowInfinity:n=!1}={}){if(e!==void 0){if(typeof e!="number"||Number.isNaN(e))throw new TypeError(`Expected \`${r}\` to be a number${n?" or Infinity":""}.`);if(!n&&!Number.isFinite(e))throw new TypeError(`Expected \`${r}\` to be a finite number.`);if(e<t)throw new TypeError(`Expected \`${r}\` to be â‰¥ ${t}.`)}}class sO extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,{message:e}=e):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}}function oO(r,e){const t=Math.max(1,r+1),n=e.randomize?Math.random()+1:1;let i=Math.round(n*e.minTimeout*e.factor**(t-1));return i=Math.min(i,e.maxTimeout),i}function ny(r,e){return Number.isFinite(e)?e-(performance.now()-r):e}async function aO({error:r,attemptNumber:e,retriesConsumed:t,startTime:n,options:i}){const s=r instanceof Error?r:new TypeError(`Non-error was thrown: "${r}". You should only throw errors.`);if(s instanceof sO)throw s.originalError;const o=Number.isFinite(i.retries)?Math.max(0,i.retries-t):i.retries,a=i.maxRetryTime??Number.POSITIVE_INFINITY,c=Object.freeze({error:s,attemptNumber:e,retriesLeft:o,retriesConsumed:t});if(await i.onFailedAttempt(c),ny(n,a)<=0)throw s;const l=await i.shouldConsumeRetry(c),u=ny(n,a);if(u<=0||o<=0)throw s;if(s instanceof TypeError&&!nO(s)){if(l)throw s;return i.signal?.throwIfAborted(),!1}if(!await i.shouldRetry(c))throw s;if(!l)return i.signal?.throwIfAborted(),!1;const d=oO(t,i),h=Math.min(d,u);return i.signal?.throwIfAborted(),h>0&&await new Promise((f,y)=>{const m=()=>{clearTimeout(p),i.signal?.removeEventListener("abort",m),y(i.signal.reason)},p=setTimeout(()=>{i.signal?.removeEventListener("abort",m),f()},h);i.unref&&p.unref?.(),i.signal?.addEventListener("abort",m,{once:!0})}),i.signal?.throwIfAborted(),!0}async function cO(r,e={}){if(e={...e},iO(e.retries),Object.hasOwn(e,"forever"))throw new Error("The `forever` option is no longer supported. For many use-cases, you can set `retries: Infinity` instead.");e.retries??=10,e.factor??=2,e.minTimeout??=1e3,e.maxTimeout??=Number.POSITIVE_INFINITY,e.maxRetryTime??=Number.POSITIVE_INFINITY,e.randomize??=!1,e.onFailedAttempt??=()=>{},e.shouldRetry??=()=>!0,e.shouldConsumeRetry??=()=>!0,bu("factor",e.factor,{min:0,allowInfinity:!1}),bu("minTimeout",e.minTimeout,{min:0,allowInfinity:!1}),bu("maxTimeout",e.maxTimeout,{min:0,allowInfinity:!0}),bu("maxRetryTime",e.maxRetryTime,{min:0,allowInfinity:!0}),e.factor>0||(e.factor=1),e.signal?.throwIfAborted();let t=0,n=0;const i=performance.now();for(;!Number.isFinite(e.retries)||n<=e.retries;){t++;try{e.signal?.throwIfAborted();const s=await r(t);return e.signal?.throwIfAborted(),s}catch(s){await aO({error:s,attemptNumber:t,retriesConsumed:n,startTime:i,options:e})&&n++}}throw new Error("Retry attempts exhausted without throwing an error.")}class lO{log;queue;started;peerStore;retries;retryInterval;backoffFactor;connectionManager;events;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:reconnect-queue"),this.peerStore=e.peerStore,this.connectionManager=e.connectionManager,this.queue=new Fi({concurrency:t.maxParallelReconnects??VL,metricName:"libp2p_reconnect_queue",metrics:e.metrics}),this.started=!1,this.retries=t.retries??5,this.backoffFactor=t.backoffFactor,this.retryInterval=t.retryInterval,this.events=e.events,e.events.addEventListener("peer:disconnect",n=>{this.maybeReconnect(n.detail).catch(i=>{this.log.error("failed to maybe reconnect to %p - %e",n.detail,i)})})}async maybeReconnect(e){if(!this.started)return;const t=await this.peerStore.get(e);iy(t)&&(this.queue.has(e)||this.queue.add(async n=>{await cO(async i=>{if(this.started)try{await this.connectionManager.openConnection(e,{signal:n?.signal})}catch(s){throw this.log("reconnecting to %p attempt %d of %d failed - %e",e,i,this.retries,s),s}},{signal:n?.signal,retries:this.retries,factor:this.backoffFactor,minTimeout:this.retryInterval})},{peerId:e}).catch(async n=>{this.log.error("failed to reconnect to %p - %e",e,n);const i={};[...t.tags.keys()].forEach(s=>{s.startsWith(Mh)&&(i[s]=void 0)}),await this.peerStore.merge(e,{tags:i}),this.events.safeDispatchEvent("peer:reconnect-failure",{detail:e})}).catch(async n=>{this.log.error("failed to remove keep-alive tag from %p - %e",e,n)}))}start(){this.started=!0}async afterStart(){Promise.resolve().then(async()=>{const e=await this.peerStore.all({filters:[t=>iy(t)]});await Promise.all(e.map(async t=>{await this.connectionManager.openConnection(t.id).catch(n=>{this.log.error("could not open connection to keepalive peer - %e",n)})}))}).catch(e=>{this.log.error("error reconnect to peers after start - %e",e)})}stop(){this.started=!1,this.queue.abort()}}function iy(r){for(const e of r.tags.keys())if(e.startsWith(Mh))return!0;return!1}const D9=50,F1={maxConnections:KL,inboundConnectionThreshold:UL,maxIncomingPendingConnections:FL};class uO{started;connections;allow;deny;maxIncomingPendingConnections;incomingPendingConnections;outboundPendingConnections;maxConnections;dialQueue;reconnectQueue;connectionPruner;inboundConnectionRateLimiter;peerStore;metrics;events;log;peerId;constructor(e,t={}){if(this.maxConnections=t.maxConnections??F1.maxConnections,this.maxConnections<1)throw new H("Connection Manager maxConnections must be greater than 0");this.connections=new Gs,this.started=!1,this.peerId=e.peerId,this.peerStore=e.peerStore,this.metrics=e.metrics,this.events=e.events,this.log=e.logger.forComponent("libp2p:connection-manager"),this.onConnect=this.onConnect.bind(this),this.onDisconnect=this.onDisconnect.bind(this),this.allow=(t.allow??[]).map(n=>q0(be(n))),this.deny=(t.deny??[]).map(n=>q0(be(n))),this.incomingPendingConnections=0,this.maxIncomingPendingConnections=t.maxIncomingPendingConnections??F1.maxIncomingPendingConnections,this.outboundPendingConnections=0,this.inboundConnectionRateLimiter=new dw({points:t.inboundConnectionThreshold??F1.inboundConnectionThreshold,duration:1}),this.connectionPruner=new ML({connectionManager:this,peerStore:e.peerStore,events:e.events,logger:e.logger},{allow:t.allow?.map(n=>be(n))}),this.dialQueue=new JL(e,{addressSorter:t.addressSorter,maxParallelDials:t.maxParallelDials??P9,maxDialQueueLength:t.maxDialQueueLength??T9,maxPeerAddrsToDial:t.maxPeerAddrsToDial??_9,dialTimeout:t.dialTimeout??C9,resolvers:t.resolvers??{dnsaddr:R9},connections:this.connections}),this.reconnectQueue=new lO({events:e.events,peerStore:e.peerStore,logger:e.logger,connectionManager:this},{retries:t.reconnectRetries,retryInterval:t.reconnectRetryInterval,backoffFactor:t.reconnectBackoffFactor,maxParallelReconnects:t.maxParallelReconnects})}[Symbol.toStringTag]="@libp2p/connection-manager";async start(){this.metrics?.registerMetricGroup("libp2p_connection_manager_connections",{calculate:()=>{const e={inbound:0,"inbound pending":this.incomingPendingConnections,outbound:0,"outbound pending":this.outboundPendingConnections};for(const t of this.connections.values())for(const n of t)e[n.direction]++;return e}}),this.metrics?.registerMetricGroup("libp2p_protocol_streams_total",{label:"protocol",calculate:()=>{const e={};for(const t of this.connections.values())for(const n of t)for(const i of n.streams){const s=`${i.direction} ${i.protocol??"unnegotiated"}`;e[s]=(e[s]??0)+1}return e}}),this.metrics?.registerMetricGroup("libp2p_connection_manager_protocol_streams_per_connection_90th_percentile",{label:"protocol",calculate:()=>{const e={};for(const n of this.connections.values())for(const i of n){const s={};for(const o of i.streams){const a=`${o.direction} ${o.protocol??"unnegotiated"}`;s[a]=(s[a]??0)+1}for(const[o,a]of Object.entries(s))e[o]=e[o]??[],e[o].push(a)}const t={};for(let[n,i]of Object.entries(e)){i=i.sort((o,a)=>o-a);const s=Math.floor(i.length*.9);t[n]=i[s]}return t}}),this.events.addEventListener("connection:open",this.onConnect),this.events.addEventListener("connection:close",this.onDisconnect),await Cn(this.dialQueue,this.reconnectQueue,this.connectionPruner),this.started=!0,this.log("started")}async stop(){this.events.removeEventListener("connection:open",this.onConnect),this.events.removeEventListener("connection:close",this.onDisconnect),await ni(this.reconnectQueue,this.dialQueue,this.connectionPruner);const e=[];for(const t of this.connections.values())for(const n of t)e.push(Promise.all([bt(n,"close",{signal:AbortSignal.timeout(500)}),n.close({signal:AbortSignal.timeout(500)})]).catch(i=>{n.abort(i)}));this.log("closing %d connections",e.length),await Promise.all(e),this.connections.clear(),this.log("stopped")}getMaxConnections(){return this.maxConnections}setMaxConnections(e){if(this.maxConnections<1)throw new H("Connection Manager maxConnections must be greater than 0");let t=!1;e<this.maxConnections&&(t=!0),this.maxConnections=e,t&&this.connectionPruner.maybePruneConnections()}onConnect(e){this._onConnect(e).catch(t=>{this.log.error("could not connect - %e",t)})}async _onConnect(e){const{detail:t}=e;if(!this.started){await t.close();return}if(t.status!=="open")return;const n=t.remotePeer,i=!this.connections.has(n),s=this.connections.get(n)??[];s.push(t),this.connections.set(n,s),n.publicKey!=null&&n.type==="RSA"&&await this.peerStore.patch(n,{publicKey:n.publicKey}),i&&this.events.safeDispatchEvent("peer:connect",{detail:t.remotePeer})}onDisconnect(e){const{detail:t}=e,n=t.remotePeer,s=(this.connections.get(n)??[]).filter(o=>o.id!==t.id);this.connections.set(n,s),s.length===0&&(this.log.trace("peer %p disconnected, removing connection map entry",n),this.connections.delete(n),this.events.safeDispatchEvent("peer:disconnect",{detail:n}))}getConnections(e){if(e!=null)return this.connections.get(e)??[];let t=[];for(const n of this.connections.values())t=t.concat(n);return t}getConnectionsMap(){return this.connections}async openConnection(e,t={}){if(!this.started)throw new Po("Not started");this.outboundPendingConnections++;try{t.signal?.throwIfAborted();const{peerId:n,multiaddrs:i}=x9(e);if(this.peerId.equals(n))throw new i8("Can not dial self");if(n!=null&&t.force!==!0){this.log("dial %p",n);const c=k9(n,this.getConnections(n),i);if(c!=null)return this.log("had an existing connection to %p as %a",n,c.remoteAddr),t.onProgress?.(new oe("dial-queue:already-connected")),c}const s=await this.dialQueue.dial(e,{...t,priority:t.priority??D9});if(s.status!=="open")throw new f0("Remote closed connection during opening");let o=this.connections.get(s.remotePeer);o==null&&(o=[],this.connections.set(s.remotePeer,o));let a=!1;for(const c of o)if(c.id===s.id&&(a=!0),t.force!==!0&&c.id!==s.id&&c.remoteAddr.equals(s.remoteAddr))return s.abort(new Bh("Duplicate multiaddr connection")),c;return a||o.push(s),s}finally{this.outboundPendingConnections--}}async openStream(e,t,n={}){return(await this.openConnection(e,n)).newStream(t,n)}async closeConnections(e,t={}){const n=this.connections.get(e)??[];await Promise.all(n.map(async i=>{try{await Promise.all([bt(i,"close",t),i.close(t)])}catch(s){i.abort(s)}}))}acceptIncomingConnection(e){if(this.deny.some(i=>{if(en(e.remoteAddr)){const s=Ne(e.remoteAddr);return i.contains(s.host)}return!1}))return this.log("connection from %a refused - connection remote address was in deny list",e.remoteAddr),!1;if(this.allow.some(i=>{if(en(e.remoteAddr)){const s=Ne(e.remoteAddr);return i.contains(s.host)}return!0}))return this.incomingPendingConnections++,!0;if(this.incomingPendingConnections===this.maxIncomingPendingConnections)return this.log("connection from %a refused - incomingPendingConnections exceeded by host",e.remoteAddr),!1;if(en(e.remoteAddr)){const i=Ne(e.remoteAddr);try{this.inboundConnectionRateLimiter.consume(i.host,1)}catch{return this.log("connection from %a refused - inboundConnectionThreshold exceeded by host %s",e.remoteAddr,i.host),!1}}return this.getConnections().length<this.maxConnections?(this.incomingPendingConnections++,!0):(this.log("connection from %a refused - maxConnections exceeded",e.remoteAddr),!1)}afterUpgradeInbound(){this.incomingPendingConnections--}getDialQueue(){const e={queued:"queued",running:"active",errored:"error",complete:"success"};return this.dialQueue.queue.queue.map(t=>({id:t.id,status:e[t.status],peerId:t.options.peerId,multiaddrs:[...t.options.multiaddrs].map(n=>be(n))}))}async isDialable(e,t={}){return this.dialQueue.isDialable(e,t)}}const dO=1e4,hO="1.0.0",fO="ping",pO="ipfs",sy=32,gO=!0;class mO{protocol;components;log;heartbeatInterval;pingIntervalMs;abortController;timeout;abortConnectionOnPingFailure;constructor(e,t={}){this.components=e,this.protocol=`/${t.protocolPrefix??pO}/${fO}/${hO}`,this.log=e.logger.forComponent("libp2p:connection-monitor"),this.pingIntervalMs=t.pingInterval??dO,this.abortConnectionOnPingFailure=t.abortConnectionOnPingFailure??gO,this.timeout=new zc({...t.pingTimeout??{},metrics:e.metrics,metricName:"libp2p_connection_monitor_ping_time_milliseconds"})}[Symbol.toStringTag]="@libp2p/connection-monitor";[It]=["@libp2p/connection-monitor"];start(){this.abortController=new AbortController,this.abortController.signal,this.heartbeatInterval=setInterval(()=>{this.components.connectionManager.getConnections().forEach(e=>{Promise.resolve().then(async()=>{let t=Date.now();try{const n=this.timeout.getTimeoutSignal({signal:this.abortController?.signal}),i=await e.newStream(this.protocol,{signal:n,runOnLimitedConnection:!0}),s=Y7(i);t=Date.now(),await Promise.all([s.write(Ss(sy),{signal:n}),s.read({bytes:sy,signal:n})]),e.rtt=Date.now()-t,await i.close({signal:n})}catch(n){if(n.name!=="UnsupportedProtocolError")throw n;e.rtt=(Date.now()-t)/2}}).catch(t=>{this.log.error("error during heartbeat - %e",t),this.abortConnectionOnPingFailure?(this.log.error("aborting connection due to ping failure"),e.abort(t)):this.log("connection ping failed, but not aborting due to abortConnectionOnPingFailure flag")})})},this.pingIntervalMs)}stop(){this.abortController?.abort(),this.heartbeatInterval!=null&&clearInterval(this.heartbeatInterval)}}class yO{routers;started;components;constructor(e,t){this.routers=t.routers??[],this.started=!1,this.components=e,this.findProviders=e.metrics?.traceFunction("libp2p.contentRouting.findProviders",this.findProviders.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],i)=>({...i,cid:n.toString()}),getAttributesFromYieldedValue:(n,i)=>({...i,providers:[...Array.isArray(i.providers)?i.providers:[],n.id.toString()]})})??this.findProviders,this.provide=e.metrics?.traceFunction("libp2p.contentRouting.provide",this.provide.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],i)=>({...i,cid:n.toString()})})??this.provide,this.cancelReprovide=e.metrics?.traceFunction("libp2p.contentRouting.cancelReprovide",this.cancelReprovide.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],i)=>({...i,cid:n.toString()})})??this.cancelReprovide,this.put=e.metrics?.traceFunction("libp2p.contentRouting.put",this.put.bind(this),{optionsIndex:2,getAttributesFromArgs:([n])=>({key:Y(n,"base36")})})??this.put,this.get=e.metrics?.traceFunction("libp2p.contentRouting.get",this.get.bind(this),{optionsIndex:1,getAttributesFromArgs:([n])=>({key:Y(n,"base36")})})??this.get}[Symbol.toStringTag]="@libp2p/content-routing";isStarted(){return this.started}async start(){this.started=!0}async stop(){this.started=!1}async*findProviders(e,t={}){if(this.routers.length===0)throw new U1("No content routers available");const n=this,i=new xn;for await(const s of Pi(...n.routers.filter(o=>o.findProviders instanceof Function).map(o=>o.findProviders(e,t))))s!=null&&(s.multiaddrs.length>0&&await this.components.peerStore.merge(s.id,{multiaddrs:s.multiaddrs},t),!i.has(s.id)&&(i.add(s.id),yield s))}async provide(e,t={}){if(this.routers.length===0)throw new U1("No content routers available");await Promise.all(this.routers.filter(n=>n.provide instanceof Function).map(async n=>{await n.provide(e,t)}))}async cancelReprovide(e,t={}){if(this.routers.length===0)throw new U1("No content routers available");await Promise.all(this.routers.filter(n=>n.cancelReprovide instanceof Function).map(async n=>{await n.cancelReprovide(e,t)}))}async put(e,t,n){if(!this.isStarted())throw new Po;await Promise.all(this.routers.filter(i=>i.put instanceof Function).map(async i=>{await i.put(e,t,n)}))}async get(e,t){if(!this.isStarted())throw new Po;return Promise.any(this.routers.filter(n=>n.get instanceof Function).map(async n=>n.get(e,t)))}}const vu=globalThis.CustomEvent??Event;async function*Ys(r,e={}){let t=e.concurrency??1/0;t<1&&(t=1/0);const n=e.ordered??!1,i=new EventTarget,s=[];let o=Ze(),a=Ze(),c=!1,l,u=!1;i.addEventListener("task-complete",()=>{a.resolve()}),Promise.resolve().then(async()=>{try{for await(const y of r){if(s.length===t&&(o=Ze(),await o.promise),u)break;const m={done:!1};s.push(m),y().then(p=>{m.done=!0,m.ok=!0,m.value=p,i.dispatchEvent(new vu("task-complete"))},p=>{m.done=!0,m.err=p,i.dispatchEvent(new vu("task-complete"))})}c=!0,i.dispatchEvent(new vu("task-complete"))}catch(y){l=y,i.dispatchEvent(new vu("task-complete"))}});function d(){return n?s[0]?.done:!!s.find(y=>y.done)}function*h(){for(;s.length>0&&s[0].done;){const y=s[0];if(s.shift(),y.ok)yield y.value;else throw u=!0,o.resolve(),y.err;o.resolve()}}function*f(){for(;d();)for(let y=0;y<s.length;y++)if(s[y].done){const m=s[y];if(s.splice(y,1),y--,m.ok)yield m.value;else throw u=!0,o.resolve(),m.err;o.resolve()}}for(;;){if(d()||(a=Ze(),await a.promise),l!=null||(n?yield*h():yield*f(),l!=null))throw l;if(c&&s.length===0)break}}class wO{log;peerId;peerStore;routers;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:peer-routing"),this.peerId=e.peerId,this.peerStore=e.peerStore,this.routers=t.routers??[],this.findPeer=e.metrics?.traceFunction("libp2p.peerRouting.findPeer",this.findPeer.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],i)=>({...i,peer:n.toString()})})??this.findPeer,this.getClosestPeers=e.metrics?.traceFunction("libp2p.peerRouting.getClosestPeers",this.getClosestPeers.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],i)=>({...i,key:Y(n,"base36")}),getAttributesFromYieldedValue:(n,i)=>({...i,peers:[...Array.isArray(i.peers)?i.peers:[],n.id.toString()]})})??this.getClosestPeers}[Symbol.toStringTag]="@libp2p/peer-routing";async findPeer(e,t){if(this.routers.length===0)throw new ty("No peer routers available");if(e.toString()===this.peerId.toString())throw new mL("Should not try to find self");const n=this,i=Pi(...this.routers.filter(s=>s.findPeer instanceof Function).map(s=>(async function*(){try{yield await s.findPeer(e,t)}catch(o){n.log.error("router failed to find peer - %e",o)}})()));for await(const s of i)if(s!=null)return s.multiaddrs.length>0&&await this.peerStore.merge(s.id,{multiaddrs:s.multiaddrs},t),s;throw new wt}async*getClosestPeers(e,t={}){if(this.routers.length===0)throw new ty("No peer routers available");const n=this,i=Mi(1024);for await(const s of Ys((async function*(){const o=Pi(...n.routers.filter(a=>a.getClosestPeers instanceof Function).map(a=>a.getClosestPeers(e,t)));for await(let a of o)yield async()=>{if(a.multiaddrs.length===0)try{a=await n.findPeer(a.id,{...t,useCache:!1})}catch(c){n.log.error("could not find peer multiaddrs - %e",c);return}return a}})()))s!=null&&(s.multiaddrs.length>0&&await this.peerStore.merge(s.id,{multiaddrs:s.multiaddrs},t),!i.has(s.id.toMultihash().bytes)&&(i.add(s.id.toMultihash().bytes),yield s))}}class bO extends Qe{peerRouting;log;walking;walkers;shutdownController;walkController;needNext;constructor(e){super(),this.log=e.logger.forComponent("libp2p:random-walk"),this.peerRouting=e.peerRouting,this.walkers=0,this.walking=!1,this.shutdownController=new AbortController,this.shutdownController.signal}[Symbol.toStringTag]="@libp2p/random-walk";start(){this.shutdownController=new AbortController,this.shutdownController.signal}stop(){this.shutdownController.abort()}async*walk(e){this.walking||this.startWalk(),this.walkers++;const t=Ke([this.shutdownController.signal,e?.signal]);try{for(;;)this.needNext?.resolve(),this.needNext=Ze(),yield(await bt(this,"walk:peer",{signal:t,rejectionEvents:["walk:error"]})).detail}catch(n){throw n.detail!=null?n.detail:n}finally{t.clear(),this.walkers--,this.walkers===0&&(this.walkController?.abort(),this.walkController=void 0)}}startWalk(){this.walking=!0,this.walkController=new AbortController,this.walkController.signal;const e=Ke([this.walkController.signal,this.shutdownController.signal]),t=Date.now();let n=0;Promise.resolve().then(async()=>{for(this.log("start walk");this.walkers>0;)try{const i=Ss(32);let s=Date.now();for await(const o of this.peerRouting.getClosestPeers(i,{signal:e}))e.aborted&&this.log("aborting walk"),e.throwIfAborted(),this.log("found peer %p after %dms for %d walkers",o.id,Date.now()-s,this.walkers),n++,this.safeDispatchEvent("walk:peer",{detail:o}),this.walkers===1&&this.needNext!=null&&(this.log("wait for need next"),await Yt(this.needNext.promise,e)),s=Date.now();this.log("walk iteration for %b and %d walkers finished, found %d peers",i,this.walkers,n)}catch(i){this.log.error("random walk errored - %e",i),this.safeDispatchEvent("walk:error",{detail:i})}this.log("no walkers left, ended walk")}).catch(i=>{this.log.error("random walk errored - %e",i)}).finally(()=>{this.log("finished walk, found %d peers after %dms",n,Date.now()-t),this.walking=!1})}}const B9=32,L9=64;class vO{log;topologies;handlers;components;middleware;constructor(e){this.components=e,this.log=e.logger.forComponent("libp2p:registrar"),this.middleware=new Map,this.topologies=new Map,e.metrics?.registerMetricGroup("libp2p_registrar_topologies",{calculate:()=>{const t={};for(const[n,i]of this.topologies)t[n]=i.size;return t}}),this.handlers=an({name:"libp2p_registrar_protocol_handlers",metrics:e.metrics}),this._onDisconnect=this._onDisconnect.bind(this),this._onPeerUpdate=this._onPeerUpdate.bind(this),this._onPeerIdentify=this._onPeerIdentify.bind(this),this.components.events.addEventListener("peer:disconnect",this._onDisconnect),this.components.events.addEventListener("peer:update",this._onPeerUpdate),this.components.events.addEventListener("peer:identify",this._onPeerIdentify)}[Symbol.toStringTag]="@libp2p/registrar";getProtocols(){return Array.from(new Set([...this.handlers.keys()])).sort()}getHandler(e){const t=this.handlers.get(e);if(t==null)throw new yL(`No handler registered for protocol ${e}`);return t}getTopologies(e){const t=this.topologies.get(e);return t==null?[]:[...t.values()]}async handle(e,t,n){if(this.handlers.has(e)&&n?.force!==!0)throw new wL(`Handler already registered for protocol ${e}`);this.handlers.set(e,{handler:t,options:{maxInboundStreams:B9,maxOutboundStreams:L9,...n}}),await this.components.peerStore.merge(this.components.peerId,{protocols:[e]},n)}async unhandle(e,t){(Array.isArray(e)?e:[e]).forEach(i=>{this.handlers.delete(i)}),await this.components.peerStore.patch(this.components.peerId,{protocols:this.getProtocols()},t)}async register(e,t){if(t==null)throw new H("invalid topology");const n=`${(Math.random()*1e9).toString(36)}${Date.now()}`;let i=this.topologies.get(e);return i==null&&(i=new Map,this.topologies.set(e,i)),i.set(n,t),n}unregister(e){for(const[t,n]of this.topologies.entries())n.has(e)&&(n.delete(e),n.size===0&&this.topologies.delete(t))}use(e,t){this.middleware.set(e,t)}unuse(e){this.middleware.delete(e)}getMiddleware(e){return this.middleware.get(e)??[]}async _onDisconnect(e){const t=e.detail,n={signal:AbortSignal.timeout(5e3)};try{const i=await this.components.peerStore.get(t,n);for(const s of i.protocols){const o=this.topologies.get(s);o!=null&&await Promise.all([...o.values()].map(async a=>{a.filter?.has(t)!==!1&&(a.filter?.remove(t),await a.onDisconnect?.(t))}))}}catch(i){if(i.name==="NotFoundError")return;this.log.error("could not inform topologies of disconnecting peer %p - %e",t,i)}}async _onPeerUpdate(e){const{peer:t,previous:n}=e.detail,i=(n?.protocols??[]).filter(s=>!t.protocols.includes(s));try{for(const s of i){const o=this.topologies.get(s);o!=null&&await Promise.all([...o.values()].map(async a=>{a.filter?.has(t.id)!==!1&&(a.filter?.remove(t.id),await a.onDisconnect?.(t.id))}))}}catch(s){this.log.error("could not inform topologies of updated peer %p - %e",t.id,s)}}async _onPeerIdentify(e){const t=e.detail.protocols,n=e.detail.connection,i=e.detail.peerId;try{for(const s of t){const o=this.topologies.get(s);o!=null&&await Promise.all([...o.values()].map(async a=>{n.limits!=null&&a.notifyOnLimitedConnection!==!0||a.filter?.has(i)!==!0&&(a.filter?.add(i),await a.onConnect?.(i,n))}))}}catch(s){this.log.error("could not inform topologies of updated peer after identify %p - %e",i,s)}}}class EO{log;components;transports;listeners;faultTolerance;started;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:transports"),this.components=e,this.started=!1,this.transports=an({name:"libp2p_transport_manager_transports",metrics:this.components.metrics}),this.listeners=an({name:"libp2p_transport_manager_listeners",metrics:this.components.metrics}),this.faultTolerance=t.faultTolerance??Xu.FATAL_ALL}[Symbol.toStringTag]="@libp2p/transport-manager";add(e){const t=e[Symbol.toStringTag];if(t==null)throw new H("Transport must have a valid tag");if(this.transports.has(t))throw new H(`There is already a transport with the tag ${t}`);this.log("adding transport %s",t),this.transports.set(t,e),this.listeners.has(t)||this.listeners.set(t,[])}isStarted(){return this.started}start(){this.started=!0}async afterStart(){const e=this.components.addressManager.getListenAddrs();await this.listen(e)}async stop(){const e=[];for(const[t,n]of this.listeners)for(this.log("closing listeners for %s",t);n.length>0;){const i=n.pop();i!=null&&e.push(i.close())}await Promise.all(e),this.log("all listeners closed");for(const t of this.listeners.keys())this.listeners.set(t,[]);this.started=!1}async dial(e,t){const n=this.dialTransportForMultiaddr(e);if(n==null)throw new AL(`No transport available for address ${String(e)}`);return t?.onProgress?.(new oe("transport-manager:selected-transport",n[Symbol.toStringTag])),n.dial(e,{...t,upgrader:this.components.upgrader})}getAddrs(){let e=[];for(const t of this.listeners.values())for(const n of t)e=[...e,...n.getAddrs()];return e}getTransports(){return Array.of(...this.transports.values())}getListeners(){return Array.of(...this.listeners.values()).flat()}dialTransportForMultiaddr(e){for(const t of this.transports.values())if(t.dialFilter([e]).length>0)return t}listenTransportForMultiaddr(e){for(const t of this.transports.values())if(t.listenFilter([e]).length>0)return t}async listen(e){if(!this.isStarted())throw new Po("Not started");if(e==null||e.length===0){this.log("no addresses were provided for listening, this node is dial only");return}const t={errors:new Map,ipv4:{success:0,attempts:0},ipv6:{success:0,attempts:0}};e.forEach(s=>{t.errors.set(s.toString(),new bL)});const n=[];for(const[s,o]of this.transports.entries()){const a=o.listenFilter(e);for(const c of a){this.log("creating listener for %s on %a",s,c);const l=o.createListener({upgrader:this.components.upgrader});let u=this.listeners.get(s)??[];u==null&&(u=[],this.listeners.set(s,u)),u.push(l),l.addEventListener("listening",()=>{this.components.events.safeDispatchEvent("transport:listening",{detail:l})}),l.addEventListener("close",()=>{const d=u.findIndex(h=>h===l);u.splice(d,1),this.components.events.safeDispatchEvent("transport:close",{detail:l})}),Dm.matches(c)?t.ipv4.attempts++:Bm.matches(c)&&t.ipv6.attempts++,n.push(l.listen(c).then(()=>{t.errors.delete(c.toString()),Dm.matches(c)&&t.ipv4.success++,Bm.matches(c)&&t.ipv6.success++},d=>{throw this.log.error("transport %s could not listen on address %a - %e",s,c,d),t.errors.set(c.toString(),d),d}))}}const i=await Promise.allSettled(n);if(!(i.length>0&&i.every(s=>s.status==="fulfilled"))){if(this.ipv6Unsupported(t)){this.log("all IPv4 addresses succeed but all IPv6 failed");return}if(this.faultTolerance===Xu.NO_FATAL){this.log("failed to listen on any address but fault tolerance allows this");return}throw new vL(`Some configured addresses failed to be listened on, you may need to remove one or more listen addresses from your configuration or set \`transportManager.faultTolerance\` to NO_FATAL:
${[...t.errors.entries()].map(([s,o])=>`
  ${s}: ${`${SO(o)}`.split(`
`).join(`
  `)}
`).join("")}`)}}ipv6Unsupported(e){if(e.ipv4.attempts===0||e.ipv6.attempts===0)return!1;const t=e.ipv4.attempts===e.ipv4.success,n=e.ipv6.success===0;return t&&n}async remove(e){const t=this.listeners.get(e)??[];this.log.trace("removing transport %s",e);const n=[];for(this.log.trace("closing listeners for %s",e);t.length>0;){const i=t.pop();i!=null&&n.push(i.close())}await Promise.all(n),this.transports.delete(e),this.listeners.delete(e)}async removeAll(){const e=[];for(const t of this.transports.keys())e.push(this.remove(t));await Promise.all(e)}}function SO(r){return r.stack!=null&&r.stack.trim()!==""?r.stack:r.message!=null?r.message:r.toString()}const cs="/multistream/1.0.0",O9=1024,xO=W(`
`);async function K0(r,e){const n=(await r.read(e)).subarray();if(n.byteLength===0||n[n.length-1]!==xO[0])throw new Je("Missing newline");return Y(n).trimEnd()}async function W0(r,e,t={}){if(e=Array.isArray(e)?[...e]:[e],e.length===0)throw new Error("At least one protocol must be specified");const n=r.log.newScope("mss:select"),i=qc(r,{...t,maxDataLength:O9});for(let s=0;s<e.length;s++){const o=e[s];let a;if(s===0){n.trace('write ["%s", "%s"]',cs,o);const c=W(`${cs}
`),l=W(`${o}
`);if(await i.writeV([c,l],t),n.trace("reading multistream-select header"),a=await K0(i,t),n.trace('read "%s"',a),a!==cs){n.error("did not read multistream-select header from response");break}}else n.trace('write "%s"',o),await i.write(W(`${o}
`),t);if(n.trace("reading protocol response"),a=await K0(i,t),n.trace('read "%s"',a),a===o)return n.trace('selected "%s" after negotiation',a),i.unwrap(),o}throw new s8(`Protocol selection failed - could not negotiate ${e}`)}async function j0(r,e,t={}){e=Array.isArray(e)?e:[e];const n=r.log.newScope("mss:handle"),i=qc(r,{...t,maxDataLength:O9,maxLengthLength:2});for(;;){n.trace("reading incoming string");const s=await K0(i,t);if(n.trace('read "%s"',s),s===cs){n.trace('respond with "%s" for "%s"',cs,s),await i.write(W(`${cs}
`),t),n.trace('responded with "%s" for "%s"',cs,s);continue}if(e.includes(s))return n.trace('respond with "%s" for "%s"',s,s),await i.write(W(`${s}
`),t),n.trace('responded with "%s" for "%s"',s,s),i.unwrap(),s;if(s==="ls"){const o=new me(...e.map(a=>jc.single(W(`${a}
`))),W(`
`));n.trace('respond with "%s" for %s',e,s),await i.write(o,t),n.trace('responded with "%s" for %s',e,s);continue}n.trace('respond with "na" for "%s"',s),await i.write(W(`na
`),t),n('responded with "na" for "%s"',s)}}class AO extends Qe{id;remoteAddr;remotePeer;direction;timeline;direct;multiplexer;encryption;limits;log;maConn;muxer;components;outboundStreamProtocolNegotiationTimeout;inboundStreamProtocolNegotiationTimeout;closeTimeout;constructor(e,t){super(),this.components=e,this.id=t.id,this.remoteAddr=t.maConn.remoteAddr,this.remotePeer=t.remotePeer,this.direction=t.direction??"outbound",this.timeline=t.maConn.timeline,this.encryption=t.cryptoProtocol,this.limits=t.limits,this.maConn=t.maConn,this.log=t.maConn.log,this.outboundStreamProtocolNegotiationTimeout=t.outboundStreamProtocolNegotiationTimeout??Nd,this.inboundStreamProtocolNegotiationTimeout=t.inboundStreamProtocolNegotiationTimeout??Nd,this.closeTimeout=t.closeTimeout??I9,this.direct=A9(t.maConn.remoteAddr),this.onIncomingStream=this.onIncomingStream.bind(this),this.remoteAddr.getComponents().find(n=>n.code===ge)==null&&(this.remoteAddr=this.remoteAddr.encapsulate(`/p2p/${this.remotePeer}`)),t.muxer!=null&&(this.multiplexer=t.muxer.protocol,this.muxer=t.muxer,this.muxer.addEventListener("stream",this.onIncomingStream)),this.maConn.addEventListener("close",n=>{this.dispatchEvent(new Oh(n.local,n.error))})}[Symbol.toStringTag]="Connection";[yS]=!0;get streams(){return this.muxer?.streams??[]}get status(){return this.maConn.status}newStream=async(e,t={})=>{if(this.muxer==null)throw new zu("Connection is not multiplexed");if(this.muxer.status!=="open")throw new f0(`The connection muxer is "${this.muxer.status}" and not "open"`);if(this.maConn.status!=="open")throw new f0(`The connection is "${this.status}" and not "open"`);if(this.limits!=null&&t?.runOnLimitedConnection!==!0)throw new m4("Cannot open protocol stream on limited connection");Array.isArray(e)||(e=[e]),this.log.trace("starting new stream for protocols %s",e);const n=await this.muxer.createStream({...t,protocol:e.length===1?e[0]:void 0});this.log.trace("started new stream %s for protocols %s",n.id,e);try{if(t.signal==null){n.log("no abort signal was passed while trying to negotiate protocols %s falling back to default timeout",e);const a=AbortSignal.timeout(this.outboundStreamProtocolNegotiationTimeout);t={...t,signal:a}}n.protocol===""?(n.log.trace("selecting protocol from protocols %s",e),n.protocol=await W0(n,e,t),n.log("negotiated protocol %s",n.protocol)):n.log("pre-negotiated protocol %s",n.protocol);const i=IO(n.protocol,this.components.registrar,t),s=oy(n.protocol,"outbound",this);if(s>i){const a=new o8(`Too many outbound protocol streams for protocol "${n.protocol}" - ${s}/${i}`);throw n.abort(a),a}await this.components.peerStore.merge(this.remotePeer,{protocols:[n.protocol]}),this.components.metrics?.trackProtocolStream(n);const o=this.components.registrar.getMiddleware(n.protocol);return await this.runMiddlewareChain(n,this,o)}catch(i){throw n.status==="open"?n.abort(i):this.log.error("could not create new outbound stream on connection %s %a for protocols %s - %e",this.direction==="inbound"?"from":"to",this.remoteAddr,e,i),i}};async onIncomingStream(e){const t=e.detail,n=AbortSignal.timeout(this.inboundStreamProtocolNegotiationTimeout);t.log("start protocol negotiation, timing out after %dms",this.inboundStreamProtocolNegotiationTimeout);try{if(t.protocol===""){const l=this.components.registrar.getProtocols();t.log.trace("selecting protocol from protocols %s",l),t.protocol=await j0(t,l,{signal:n}),t.log("negotiated protocol %s",t.protocol)}else t.log("pre-negotiated protocol %s",t.protocol);const i=CO(t.protocol,this.components.registrar);if(oy(t.protocol,"inbound",this)>i)throw new ES(`Too many inbound protocol streams for protocol "${t.protocol}" - limit ${i}`);await this.components.peerStore.merge(this.remotePeer,{protocols:[t.protocol]},{signal:n}),this.components.metrics?.trackProtocolStream(t);const{handler:o,options:a}=this.components.registrar.getHandler(t.protocol);if(this.limits!=null&&a.runOnLimitedConnection!==!0)throw new m4("Cannot open protocol stream on limited connection");const c=this.components.registrar.getMiddleware(t.protocol);c.push(async(l,u,d)=>{await o(l,u),d(l,u)}),await this.runMiddlewareChain(t,this,c)}catch(i){t.abort(i)}}async runMiddlewareChain(e,t,n){for(let i=0;i<n.length;i++){const s=n[i];e.log.trace("running middleware",i,s),await new Promise((o,a)=>{try{const c=s(e,t,(l,u)=>{e=l,t=u,o()});c instanceof Promise&&c.catch(a)}catch(c){a(c)}}),e.log.trace("ran middleware",i,s)}return e}async close(e={}){if(this.log("closing connection to %a",this.remoteAddr),e.signal==null){const t=AbortSignal.timeout(this.closeTimeout);e={...e,signal:t}}await this.muxer?.close(e),await this.maConn.close(e)}abort(e){this.muxer?.abort(e),this.maConn.abort(e)}}function kO(r,e){return new AO(r,e)}function CO(r,e){try{const{options:t}=e.getHandler(r);if(t.maxInboundStreams!=null)return t.maxInboundStreams}catch(t){if(t.name!=="UnhandledProtocolError")throw t}return B9}function IO(r,e,t={}){try{const{options:n}=e.getHandler(r);if(n.maxOutboundStreams!=null)return n.maxOutboundStreams}catch(n){if(n.name!=="UnhandledProtocolError")throw n}return t.maxOutboundStreams??L9}function oy(r,e,t){let n=0;return t.streams.forEach(i=>{i.direction===e&&i.protocol===r&&n++}),n}class _O{components;connectionEncrypters;streamMuxers;inboundUpgradeTimeout;inboundStreamProtocolNegotiationTimeout;outboundStreamProtocolNegotiationTimeout;events;metrics;connectionCloseTimeout;constructor(e,t){this.components=e,this.connectionEncrypters=an({name:"libp2p_upgrader_connection_encrypters",metrics:this.components.metrics}),t.connectionEncrypters.forEach(n=>{this.connectionEncrypters.set(n.protocol,n)}),this.streamMuxers=an({name:"libp2p_upgrader_stream_multiplexers",metrics:this.components.metrics}),t.streamMuxers.forEach(n=>{this.streamMuxers.set(n.protocol,n)}),this.inboundUpgradeTimeout=t.inboundUpgradeTimeout??$L,this.inboundStreamProtocolNegotiationTimeout=t.inboundStreamProtocolNegotiationTimeout??Nd,this.outboundStreamProtocolNegotiationTimeout=t.outboundStreamProtocolNegotiationTimeout??Nd,this.connectionCloseTimeout=t.connectionCloseTimeout??I9,this.events=e.events,this.metrics={dials:e.metrics?.registerCounterGroup("libp2p_connection_manager_dials_total"),errors:e.metrics?.registerCounterGroup("libp2p_connection_manager_dial_errors_total"),inboundErrors:e.metrics?.registerCounterGroup("libp2p_connection_manager_dials_inbound_errors_total"),outboundErrors:e.metrics?.registerCounterGroup("libp2p_connection_manager_dials_outbound_errors_total")}}[Symbol.toStringTag]="@libp2p/upgrader";async shouldBlockConnection(e,...t){const n=this.components.connectionGater[e];if(n==null)return;if(await n.apply(this.components.connectionGater,t)===!0)throw new SL(`The multiaddr connection is blocked by gater.${e}`)}createInboundAbortSignal(e){return Ke([AbortSignal.timeout(this.inboundUpgradeTimeout),e])}async upgradeInbound(e,t){let n=!1;const i=this.createInboundAbortSignal(t.signal);try{if(this.metrics.dials?.increment({inbound:!0}),n=this.components.connectionManager.acceptIncomingConnection(e),!n)throw new xL("Connection denied");await Yt(this.shouldBlockConnection("denyInboundConnection",e),i),await this._performUpgrade(e,"inbound",{...t,signal:i})}catch(s){throw this.metrics.errors?.increment({inbound:!0}),this.metrics.inboundErrors?.increment({[s.name??"Error"]:!0}),s}finally{i.clear(),n&&this.components.connectionManager.afterUpgradeInbound()}}async upgradeOutbound(e,t){try{this.metrics.dials?.increment({outbound:!0});const n=e.remoteAddr.getComponents().findLast(o=>o.code===ge)?.value;let i;n!=null&&(i=or(n),await Yt(this.shouldBlockConnection("denyOutboundConnection",i,e),t.signal));let s="outbound";return t.initiator===!1&&(s="inbound"),await this._performUpgrade(e,s,t)}catch(n){throw this.metrics.errors?.increment({outbound:!0}),this.metrics.outboundErrors?.increment({[n.name??"Error"]:!0}),n}}async _performUpgrade(e,t,n){let i=e,s,o,a,c;const l=`${parseInt(String(Math.random()*1e9)).toString(36)}${Date.now()}`;if(e.log=e.log.newScope(`${t}:${l}`),this.components.metrics?.trackMultiaddrConnection(e),e.log.trace("starting the %s connection upgrade",t),n?.skipProtection!==!0){const d=this.components.connectionProtector;d!=null&&(e.log("protecting the %s connection",t),i=await d.protect(i,n))}try{if(TO(n)){if(n.remotePeer==null)throw new Bh(`${t} connection that skipped encryption must have a peer id`);c="native",s=n.remotePeer}else{const d=e.remoteAddr.getComponents().findLast(f=>f.code===ge)?.value;let h;d!=null&&(h=or(d)),n?.onProgress?.(new oe(`upgrader:encrypt-${t}-connection`)),{connection:i,remotePeer:s,protocol:c,streamMuxer:o}=await(t==="inbound"?this._encryptInbound(i,{...n,remotePeer:h}):this._encryptOutbound(i,{...n,remotePeer:h}))}if(s.equals(this.components.peerId)){const d=new i8("Can not dial self");throw e.abort(d),d}await this.shouldBlockConnection(t==="inbound"?"denyInboundEncryptedConnection":"denyOutboundEncryptedConnection",s,e),n?.muxerFactory!=null?o=n.muxerFactory:o==null&&this.streamMuxers.size>0&&(n?.onProgress?.(new oe(`upgrader:multiplex-${t}-connection`)),o=await(t==="inbound"?this._multiplexInbound(i,this.streamMuxers,n):this._multiplexOutbound(i,this.streamMuxers,n)))}catch(d){throw e.log.error("failed to upgrade %s connection %s %a - %e",t,t==="inbound"?"from":"to",e.remoteAddr,d),d}o!=null&&(e.log("create muxer %s",o.protocol),a=o.createStreamMuxer(i)),await this.shouldBlockConnection(t==="inbound"?"denyInboundUpgradedConnection":"denyOutboundUpgradedConnection",s,e);const u=this._createConnection({id:l,cryptoProtocol:c,direction:t,maConn:e,stream:i,muxer:a,remotePeer:s,limits:n?.limits,closeTimeout:this.connectionCloseTimeout});return u.log("successfully upgraded connection"),u}_createConnection(e){const t=kO(this.components,{...e,outboundStreamProtocolNegotiationTimeout:this.outboundStreamProtocolNegotiationTimeout,inboundStreamProtocolNegotiationTimeout:this.inboundStreamProtocolNegotiationTimeout});return t.addEventListener("close",()=>{this.events.safeDispatchEvent("connection:close",{detail:t})}),this.events.safeDispatchEvent("connection:open",{detail:t}),t}async _encryptInbound(e,t){const n=Array.from(this.connectionEncrypters.keys());try{const i=await j0(e,n,t),s=this.connectionEncrypters.get(i);if(s==null)throw new wu(`no crypto module found for ${i}`);return e.log("encrypting inbound connection using %s",i),{...await s.secureInbound(e,t),protocol:i}}catch(i){throw new wu(i.message)}}async _encryptOutbound(e,t){const n=Array.from(this.connectionEncrypters.keys());try{e.log.trace("selecting encrypter from %s",n);const i=await W0(e,n,t),s=this.connectionEncrypters.get(i);if(s==null)throw new wu(`no crypto module found for ${i}`);return e.log("encrypting outbound connection using %s",i),{...await s.secureOutbound(e,t),protocol:i}}catch(i){throw new wu(i.message)}}async _multiplexOutbound(e,t,n){const i=Array.from(t.keys());e.log("outbound selecting muxer %s",i);try{e.log.trace("selecting stream muxer from %s",i);const s=await W0(e,i,n),o=t.get(s);if(o==null)throw new zu(`No muxer configured for protocol "${s}"`);return e.log("selected %s as muxer protocol",s),o}catch(s){throw e.log.error("error multiplexing outbound connection - %e",s),new zu(String(s))}}async _multiplexInbound(e,t,n){const i=Array.from(t.keys());e.log("inbound handling muxers %s",i);try{e.log.trace("selecting stream muxer from %s",i);const s=await j0(e,i,n),o=t.get(s);if(o==null)throw new zu(`No muxer configured for protocol "${s}"`);return e.log("selected %s as muxer protocol",s),o}catch(s){throw e.log.error("error multiplexing inbound connection - %e",s),s}}getConnectionEncrypters(){return this.connectionEncrypters}getStreamMuxers(){return this.streamMuxers}}function TO(r){return r.skipEncryption===!0}const M9="3.1.2",$9="js-libp2p";function U9(r,e){return`${r??$9}/${e??M9} browser/${globalThis.navigator.userAgent}`}class F9 extends Qe{peerId;peerStore;contentRouting;peerRouting;metrics;services;logger;status;components;log;constructor(e){super(),this.status="stopped";const t=new Qe,n=t.dispatchEvent.bind(t);t.dispatchEvent=l=>{const u=n(l),d=this.dispatchEvent(new CustomEvent(l.type,{detail:l.detail}));return u||d},this.peerId=e.peerId,this.logger=e.logger??gl(),this.log=this.logger.forComponent("libp2p"),this.services={};const i=e.nodeInfo?.name??$9,s=e.nodeInfo?.version??M9,o=this.components=TL({peerId:e.peerId,privateKey:e.privateKey,nodeInfo:{name:i,version:s,userAgent:e.nodeInfo?.userAgent??U9(i,s)},logger:this.logger,events:t,datastore:e.datastore??new y9,connectionGater:BL(e.connectionGater),dns:e.dns});e.metrics!=null&&(this.metrics=this.configureComponent("metrics",e.metrics(this.components))),this.peerStore=this.configureComponent("peerStore",sL(o,{addressFilter:this.components.connectionGater.filterMultiaddrForPeer,...e.peerStore})),o.events.addEventListener("peer:update",l=>{if(l.detail.previous==null){const u={id:l.detail.peer.id,multiaddrs:l.detail.peer.addresses.map(d=>d.multiaddr)};o.events.safeDispatchEvent("peer:discovery",{detail:u})}}),e.connectionProtector!=null&&this.configureComponent("connectionProtector",e.connectionProtector(o)),this.components.upgrader=new _O(this.components,{connectionEncrypters:(e.connectionEncrypters??[]).map((l,u)=>this.configureComponent(`connection-encryption-${u}`,l(this.components))),streamMuxers:(e.streamMuxers??[]).map((l,u)=>this.configureComponent(`stream-muxers-${u}`,l(this.components))),inboundUpgradeTimeout:e.connectionManager?.inboundUpgradeTimeout,inboundStreamProtocolNegotiationTimeout:e.connectionManager?.inboundStreamProtocolNegotiationTimeout,outboundStreamProtocolNegotiationTimeout:e.connectionManager?.outboundStreamProtocolNegotiationTimeout,connectionCloseTimeout:e.connectionManager?.connectionCloseTimeout}),this.configureComponent("transportManager",new EO(this.components,e.transportManager)),this.configureComponent("connectionManager",new uO(this.components,e.connectionManager)),e.connectionMonitor?.enabled!==!1&&this.configureComponent("connectionMonitor",new mO(this.components,e.connectionMonitor)),this.configureComponent("registrar",new vO(this.components)),this.configureComponent("addressManager",new fL(this.components,e.addresses));const a=(e.peerRouters??[]).map((l,u)=>this.configureComponent(`peer-router-${u}`,l(this.components)));this.peerRouting=this.components.peerRouting=this.configureComponent("peerRouting",new wO(this.components,{routers:a}));const c=(e.contentRouters??[]).map((l,u)=>this.configureComponent(`content-router-${u}`,l(this.components)));if(this.contentRouting=this.components.contentRouting=this.configureComponent("contentRouting",new yO(this.components,{routers:c})),this.configureComponent("randomWalk",new bO(this.components)),(e.peerDiscovery??[]).forEach((l,u)=>{this.configureComponent(`peer-discovery-${u}`,l(this.components)).addEventListener("peer",h=>{this.#e(h)})}),e.transports?.forEach((l,u)=>{this.components.transportManager.add(this.configureComponent(`transport-${u}`,l(this.components)))}),e.services!=null)for(const l of Object.keys(e.services)){const u=e.services[l],d=u(this.components);if(d==null){this.log.error("service factory %s returned null or undefined instance",l);continue}this.services[l]=d,this.configureComponent(l,d),d[Rc]!=null&&(this.log("registering service %s for content routing",l),c.push(d[Rc])),d[Nc]!=null&&(this.log("registering service %s for peer routing",l),a.push(d[Nc])),d[Qu]!=null&&(this.log("registering service %s for peer discovery",l),d[Qu].addEventListener?.("peer",h=>{this.#e(h)}))}PL(o)}configureComponent(e,t){return t==null&&this.log.error("component %s was null or undefined",e),this.components[e]=t,t}async start(){if(this.status==="stopped"){this.status="starting",this.log("libp2p is starting");try{await this.components.beforeStart?.(),await this.components.start(),await this.components.afterStart?.(),this.status="started",this.safeDispatchEvent("start",{detail:this}),this.log("libp2p has started with peer id %p",this.peerId)}catch(e){throw this.log.error("an error occurred starting libp2p - %e",e),this.status="started",await this.stop(),e}}}async stop(){this.status==="started"&&(this.log("libp2p is stopping"),this.status="stopping",await this.components.beforeStop?.(),await this.components.stop(),await this.components.afterStop?.(),this.status="stopped",this.safeDispatchEvent("stop",{detail:this}),this.log("libp2p has stopped"))}getConnections(e){return this.components.connectionManager.getConnections(e)}getDialQueue(){return this.components.connectionManager.getDialQueue()}getPeers(){const e=new xn;for(const t of this.components.connectionManager.getConnections())e.add(t.remotePeer);return Array.from(e)}async dial(e,t={}){return this.components.connectionManager.openConnection(e,{priority:75,...t})}async dialProtocol(e,t,n={}){if(t==null)throw new H("no protocols were provided to open a stream");if(t=Array.isArray(t)?t:[t],t.length===0)throw new H("no protocols were provided to open a stream");return this.components.connectionManager.openStream(e,t,n)}getMultiaddrs(){return this.components.addressManager.getAddresses()}getProtocols(){return this.components.registrar.getProtocols()}async hangUp(e,t={}){Sl(e)&&(e=or(e.getComponents().findLast(n=>n.code===ge)?.value??"")),await this.components.connectionManager.closeConnections(e,t)}async getPublicKey(e,t={}){if(this.log("getPublicKey %p",e),e.publicKey!=null)return e.publicKey;try{const o=await this.peerStore.get(e,t);if(o.id.publicKey!=null)return o.id.publicKey}catch(o){if(o.name!=="NotFoundError")throw o}const n=Ot([W("/pk/"),e.toMultihash().bytes]),i=await this.contentRouting.get(n,t),s=on(i);return await this.peerStore.patch(e,{publicKey:s},t),s}async handle(e,t,n){Array.isArray(e)||(e=[e]),await Promise.all(e.map(async i=>{await this.components.registrar.handle(i,t,n)}))}async unhandle(e,t){Array.isArray(e)||(e=[e]),await Promise.all(e.map(async n=>{await this.components.registrar.unhandle(n,t)}))}async register(e,t,n){return this.components.registrar.register(e,t,n)}unregister(e){this.components.registrar.unregister(e)}use(e,t){this.components.registrar.use(e,Array.isArray(t)?t:[t])}unuse(e){this.components.registrar.unuse(e)}async isDialable(e,t={}){return this.components.connectionManager.isDialable(e,t)}#e(e){const{detail:t}=e;if(t.id.toString()===this.peerId.toString()){this.log.error("peer discovery mechanism discovered self");return}this.components.peerStore.merge(t.id,{multiaddrs:t.multiaddrs}).catch(n=>{this.log.error("could not update multiaddrs of discovered peer - %e",n)})}}async function V9(r={}){r.privateKey??=await cg("Ed25519");const e=new F9({...await UB(r),peerId:ZN(r.privateKey)});return r.start!==!1&&await e.start(),e}const PO=["dial","dialProtocol","hangUp","handle","unhandle","getMultiaddrs","getProtocols"];function RO(r){return r==null?!1:r instanceof F9?!0:PO.every(e=>typeof r[e]=="function")}var V1,ay;function NO(){if(ay)return V1;ay=1;function r(t){return t>=55296&&t<=56319}function e(t){return t>=56320&&t<=57343}return V1=function(n,i,s){if(typeof i!="string")throw new Error("Input must be string");for(var o=i.length,a=0,c,l,u=0;u<o;u+=1){if(c=i.charCodeAt(u),l=i[u],r(c)&&e(i.charCodeAt(u+1))&&(u+=1,l+=i[u]),a+=n(l),a===s)return i.slice(0,u+1);if(a>s)return i.slice(0,u-l.length+1)}return i},V1}var z1,cy;function DO(){if(cy)return z1;cy=1;function r(t){return t>=55296&&t<=56319}function e(t){return t>=56320&&t<=57343}return z1=function(n){if(typeof n!="string")throw new Error("Input must be string");for(var i=n.length,s=0,o=null,a=null,c=0;c<i;c++)o=n.charCodeAt(c),e(o)?a!=null&&r(a)?s+=1:s+=3:o<=127?s+=1:o>=128&&o<=2047?s+=2:o>=2048&&o<=65535&&(s+=3),a=o;return s},z1}var H1,ly;function BO(){if(ly)return H1;ly=1;var r=NO(),e=DO();return H1=r.bind(null,e),H1}var q1,uy;function LO(){if(uy)return q1;uy=1;var r=BO(),e=/[\/\?<>\\:\*\|"]/g,t=/[\x00-\x1f\x80-\x9f]/g,n=/^\.+$/,i=/^(con|prn|aux|nul|com[0-9]|lpt[0-9])(\..*)?$/i,s=/[\. ]+$/;function o(a,c){if(typeof a!="string")throw new Error("Input must be string");var l=a.replace(e,c).replace(t,c).replace(n,c).replace(i,c).replace(s,c);return r(l,255)}return q1=function(a,c){var l=c&&c.replacement||"",u=o(a,l);return l===""?u:o(u,"")},q1}var OO=LO();const MO=Us(OO),dy={keyLength:512/8,iterationCount:1e4,salt:"you should override this value with a crypto secure random number",hash:"sha2-512"},K1={alg:"A128GCM",ext:!0,k:"scm9jmO_4BJAgdwWGVulLg",key_ops:["encrypt","decrypt"],kty:"oct"};function z9(r){const e="AES-GCM";let t=16;const n=12,i="SHA-256",s=16,o=32767,a=ir.get();t*=8;async function c(d,h){const f=a.getRandomValues(new Uint8Array(s)),y=a.getRandomValues(new Uint8Array(n)),m={name:e,iv:y};typeof h=="string"&&(h=W(h));let p;if(h.length===0){p=await a.subtle.importKey("jwk",K1,{name:"AES-GCM"},!0,["encrypt"]);try{const A={name:"PBKDF2",salt:f,iterations:o,hash:{name:i}},v=await a.subtle.importKey("raw",h,{name:"PBKDF2"},!1,["deriveKey"]);p=await a.subtle.deriveKey(A,v,{name:e,length:t},!0,["encrypt"])}catch{p=await a.subtle.importKey("jwk",K1,{name:"AES-GCM"},!0,["encrypt"])}}else{const A={name:"PBKDF2",salt:f,iterations:o,hash:{name:i}},v=await a.subtle.importKey("raw",h,{name:"PBKDF2"},!1,["deriveKey"]);p=await a.subtle.deriveKey(A,v,{name:e,length:t},!0,["encrypt"])}const b=await a.subtle.encrypt(m,p,d);return Ot([f,m.iv,new Uint8Array(b)])}async function l(d,h){const f=d.subarray(0,s),y=d.subarray(s,s+n),m=d.subarray(s+n),p={name:e,iv:y};typeof h=="string"&&(h=W(h));let b;if(h.length===0)try{const v={name:"PBKDF2",salt:f,iterations:o,hash:{name:i}},C=await a.subtle.importKey("raw",h,{name:"PBKDF2"},!1,["deriveKey"]);b=await a.subtle.deriveKey(v,C,{name:e,length:t},!0,["decrypt"])}catch{b=await a.subtle.importKey("jwk",K1,{name:"AES-GCM"},!0,["decrypt"])}else{const v={name:"PBKDF2",salt:f,iterations:o,hash:{name:i}},C=await a.subtle.importKey("raw",h,{name:"PBKDF2"},!1,["deriveKey"]);b=await a.subtle.deriveKey(v,C,{name:e,length:t},!0,["decrypt"])}const A=await a.subtle.decrypt(p,b,m);return new Uint8Array(A)}return{encrypt:c,decrypt:l}}const $O="[object ArrayBuffer]";class J{static isArrayBuffer(e){return Object.prototype.toString.call(e)===$O}static toArrayBuffer(e){return this.isArrayBuffer(e)?e:e.byteLength===e.buffer.byteLength||e.byteOffset===0&&e.byteLength===e.buffer.byteLength?e.buffer:this.toUint8Array(e.buffer).slice(e.byteOffset,e.byteOffset+e.byteLength).buffer}static toUint8Array(e){return this.toView(e,Uint8Array)}static toView(e,t){if(e.constructor===t)return e;if(this.isArrayBuffer(e))return new t(e);if(this.isArrayBufferView(e))return new t(e.buffer,e.byteOffset,e.byteLength);throw new TypeError("The provided value is not of type '(ArrayBuffer or ArrayBufferView)'")}static isBufferSource(e){return this.isArrayBufferView(e)||this.isArrayBuffer(e)}static isArrayBufferView(e){return ArrayBuffer.isView(e)||e&&this.isArrayBuffer(e.buffer)}static isEqual(e,t){const n=J.toUint8Array(e),i=J.toUint8Array(t);if(n.length!==i.byteLength)return!1;for(let s=0;s<n.length;s++)if(n[s]!==i[s])return!1;return!0}static concat(...e){let t;Array.isArray(e[0])&&!(e[1]instanceof Function)||Array.isArray(e[0])&&e[1]instanceof Function?t=e[0]:e[e.length-1]instanceof Function?t=e.slice(0,e.length-1):t=e;let n=0;for(const o of t)n+=o.byteLength;const i=new Uint8Array(n);let s=0;for(const o of t){const a=this.toUint8Array(o);i.set(a,s),s+=a.length}return e[e.length-1]instanceof Function?this.toView(i,e[e.length-1]):i.buffer}}const W1="string",UO=/^[0-9a-f\s]+$/i,FO=/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/,VO=/^[a-zA-Z0-9-_]+$/;class hy{static fromString(e){const t=unescape(encodeURIComponent(e)),n=new Uint8Array(t.length);for(let i=0;i<t.length;i++)n[i]=t.charCodeAt(i);return n.buffer}static toString(e){const t=J.toUint8Array(e);let n="";for(let s=0;s<t.length;s++)n+=String.fromCharCode(t[s]);return decodeURIComponent(escape(n))}}class fn{static toString(e,t=!1){const n=J.toArrayBuffer(e),i=new DataView(n);let s="";for(let o=0;o<n.byteLength;o+=2){const a=i.getUint16(o,t);s+=String.fromCharCode(a)}return s}static fromString(e,t=!1){const n=new ArrayBuffer(e.length*2),i=new DataView(n);for(let s=0;s<e.length;s++)i.setUint16(s*2,e.charCodeAt(s),t);return n}}class ue{static isHex(e){return typeof e===W1&&UO.test(e)}static isBase64(e){return typeof e===W1&&FO.test(e)}static isBase64Url(e){return typeof e===W1&&VO.test(e)}static ToString(e,t="utf8"){const n=J.toUint8Array(e);switch(t.toLowerCase()){case"utf8":return this.ToUtf8String(n);case"binary":return this.ToBinary(n);case"hex":return this.ToHex(n);case"base64":return this.ToBase64(n);case"base64url":return this.ToBase64Url(n);case"utf16le":return fn.toString(n,!0);case"utf16":case"utf16be":return fn.toString(n);default:throw new Error(`Unknown type of encoding '${t}'`)}}static FromString(e,t="utf8"){if(!e)return new ArrayBuffer(0);switch(t.toLowerCase()){case"utf8":return this.FromUtf8String(e);case"binary":return this.FromBinary(e);case"hex":return this.FromHex(e);case"base64":return this.FromBase64(e);case"base64url":return this.FromBase64Url(e);case"utf16le":return fn.fromString(e,!0);case"utf16":case"utf16be":return fn.fromString(e);default:throw new Error(`Unknown type of encoding '${t}'`)}}static ToBase64(e){const t=J.toUint8Array(e);if(typeof btoa<"u"){const n=this.ToString(t,"binary");return btoa(n)}else return Buffer.from(t).toString("base64")}static FromBase64(e){const t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!ue.isBase64(t))throw new TypeError("Argument 'base64Text' is not Base64 encoded");return typeof atob<"u"?this.FromBinary(atob(t)):new Uint8Array(Buffer.from(t,"base64")).buffer}static FromBase64Url(e){const t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!ue.isBase64Url(t))throw new TypeError("Argument 'base64url' is not Base64Url encoded");return this.FromBase64(this.Base64Padding(t.replace(/\-/g,"+").replace(/\_/g,"/")))}static ToBase64Url(e){return this.ToBase64(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/\=/g,"")}static FromUtf8String(e,t=ue.DEFAULT_UTF8_ENCODING){switch(t){case"ascii":return this.FromBinary(e);case"utf8":return hy.fromString(e);case"utf16":case"utf16be":return fn.fromString(e);case"utf16le":case"usc2":return fn.fromString(e,!0);default:throw new Error(`Unknown type of encoding '${t}'`)}}static ToUtf8String(e,t=ue.DEFAULT_UTF8_ENCODING){switch(t){case"ascii":return this.ToBinary(e);case"utf8":return hy.toString(e);case"utf16":case"utf16be":return fn.toString(e);case"utf16le":case"usc2":return fn.toString(e,!0);default:throw new Error(`Unknown type of encoding '${t}'`)}}static FromBinary(e){const t=e.length,n=new Uint8Array(t);for(let i=0;i<t;i++)n[i]=e.charCodeAt(i);return n.buffer}static ToBinary(e){const t=J.toUint8Array(e);let n="";for(let i=0;i<t.length;i++)n+=String.fromCharCode(t[i]);return n}static ToHex(e){const t=J.toUint8Array(e);let n="";const i=t.length;for(let s=0;s<i;s++){const o=t[s];o<16&&(n+="0"),n+=o.toString(16)}return n}static FromHex(e){let t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!ue.isHex(t))throw new TypeError("Argument 'hexString' is not HEX encoded");t.length%2&&(t=`0${t}`);const n=new Uint8Array(t.length/2);for(let i=0;i<t.length;i=i+2){const s=t.slice(i,i+2);n[i/2]=parseInt(s,16)}return n.buffer}static ToUtf16String(e,t=!1){return fn.toString(e,t)}static FromUtf16String(e,t=!1){return fn.fromString(e,t)}static Base64Padding(e){const t=4-e.length%4;if(t<4)for(let n=0;n<t;n++)e+="=";return e}static formatString(e){return e?.replace(/[\n\r\t ]/g,"")||""}}ue.DEFAULT_UTF8_ENCODING="utf8";function zO(...r){const e=r.map(i=>i.byteLength).reduce((i,s)=>i+s),t=new Uint8Array(e);let n=0;return r.map(i=>new Uint8Array(i)).forEach(i=>{for(const s of i)t[n++]=s}),t.buffer}function H9(r,e){if(!(r&&e)||r.byteLength!==e.byteLength)return!1;const t=new Uint8Array(r),n=new Uint8Array(e);for(let i=0;i<r.byteLength;i++)if(t[i]!==n[i])return!1;return!0}function zo(r,e){let t=0;if(r.length===1)return r[0];for(let n=r.length-1;n>=0;n--)t+=r[r.length-1-n]*Math.pow(2,e*n);return t}function ks(r,e,t=-1){const n=t;let i=r,s=0,o=Math.pow(2,e);for(let a=1;a<8;a++){if(r<o){let c;if(n<0)c=new ArrayBuffer(a),s=a;else{if(n<a)return new ArrayBuffer(0);c=new ArrayBuffer(n),s=n}const l=new Uint8Array(c);for(let u=a-1;u>=0;u--){const d=Math.pow(2,u*e);l[s-u-1]=Math.floor(i/d),i-=l[s-u-1]*d}return c}o*=Math.pow(2,e)}return new ArrayBuffer(0)}function G0(...r){let e=0,t=0;for(const s of r)e+=s.length;const n=new ArrayBuffer(e),i=new Uint8Array(n);for(const s of r)i.set(s,t),t+=s.length;return i}function q9(){const r=new Uint8Array(this.valueHex);if(this.valueHex.byteLength>=2){const a=r[0]===255&&r[1]&128,c=r[0]===0&&(r[1]&128)===0;(a||c)&&this.warnings.push("Needlessly long format")}const e=new ArrayBuffer(this.valueHex.byteLength),t=new Uint8Array(e);for(let a=0;a<this.valueHex.byteLength;a++)t[a]=0;t[0]=r[0]&128;const n=zo(t,8),i=new ArrayBuffer(this.valueHex.byteLength),s=new Uint8Array(i);for(let a=0;a<this.valueHex.byteLength;a++)s[a]=r[a];return s[0]&=127,zo(s,8)-n}function HO(r){const e=r<0?r*-1:r;let t=128;for(let n=1;n<8;n++){if(e<=t){if(r<0){const o=t-e,a=ks(o,8,n),c=new Uint8Array(a);return c[0]|=128,a}let i=ks(e,8,n),s=new Uint8Array(i);if(s[0]&128){const o=i.slice(0),a=new Uint8Array(o);i=new ArrayBuffer(i.byteLength+1),s=new Uint8Array(i);for(let c=0;c<o.byteLength;c++)s[c+1]=a[c];s[0]=0}return i}t*=Math.pow(2,8)}return new ArrayBuffer(0)}function qO(r,e){if(r.byteLength!==e.byteLength)return!1;const t=new Uint8Array(r),n=new Uint8Array(e);for(let i=0;i<t.length;i++)if(t[i]!==n[i])return!1;return!0}function wr(r,e){const t=r.toString(10);if(e<t.length)return"";const n=e-t.length,i=new Array(n);for(let o=0;o<n;o++)i[o]="0";return i.join("").concat(t)}function Dd(){if(typeof BigInt>"u")throw new Error("BigInt is not defined. Your environment doesn't implement BigInt.")}function Jg(r){let e=0,t=0;for(let i=0;i<r.length;i++){const s=r[i];e+=s.byteLength}const n=new Uint8Array(e);for(let i=0;i<r.length;i++){const s=r[i];n.set(new Uint8Array(s),t),t+=s.byteLength}return n.buffer}function si(r,e,t,n){return e instanceof Uint8Array?e.byteLength?t<0?(r.error="Wrong parameter: inputOffset less than zero",!1):n<0?(r.error="Wrong parameter: inputLength less than zero",!1):e.byteLength-t-n<0?(r.error="End of input reached before message was fully decoded (inconsistent offset and length values)",!1):!0:(r.error="Wrong parameter: inputBuffer has zero length",!1):(r.error="Wrong parameter: inputBuffer must be 'Uint8Array'",!1)}class cf{constructor(){this.items=[]}write(e){this.items.push(e)}final(){return Jg(this.items)}}const Fa=[new Uint8Array([1])],fy="0123456789",j1="name",py="valueHexView",KO="isHexOnly",WO="idBlock",jO="tagClass",GO="tagNumber",YO="isConstructed",QO="fromBER",XO="toBER",ZO="local",hr="",Nn=new ArrayBuffer(0),lf=new Uint8Array(0),Jc="EndOfContent",K9="OCTET STRING",W9="BIT STRING";function Dn(r){var e;return e=class extends r{get valueHex(){return this.valueHexView.slice().buffer}set valueHex(n){this.valueHexView=new Uint8Array(n)}constructor(...n){var i;super(...n);const s=n[0]||{};this.isHexOnly=(i=s.isHexOnly)!==null&&i!==void 0?i:!1,this.valueHexView=s.valueHex?J.toUint8Array(s.valueHex):lf}fromBER(n,i,s){const o=n instanceof ArrayBuffer?new Uint8Array(n):n;if(!si(this,o,i,s))return-1;const a=i+s;return this.valueHexView=o.subarray(i,a),this.valueHexView.length?(this.blockLength=s,a):(this.warnings.push("Zero buffer length"),i)}toBER(n=!1){return this.isHexOnly?n?new ArrayBuffer(this.valueHexView.byteLength):this.valueHexView.byteLength===this.valueHexView.buffer.byteLength?this.valueHexView.buffer:this.valueHexView.slice().buffer:(this.error="Flag 'isHexOnly' is not set, abort",Nn)}toJSON(){return{...super.toJSON(),isHexOnly:this.isHexOnly,valueHex:ue.ToHex(this.valueHexView)}}},e.NAME="hexBlock",e}class Qs{static blockName(){return this.NAME}get valueBeforeDecode(){return this.valueBeforeDecodeView.slice().buffer}set valueBeforeDecode(e){this.valueBeforeDecodeView=new Uint8Array(e)}constructor({blockLength:e=0,error:t=hr,warnings:n=[],valueBeforeDecode:i=lf}={}){this.blockLength=e,this.error=t,this.warnings=n,this.valueBeforeDecodeView=J.toUint8Array(i)}toJSON(){return{blockName:this.constructor.NAME,blockLength:this.blockLength,error:this.error,warnings:this.warnings,valueBeforeDecode:ue.ToHex(this.valueBeforeDecodeView)}}}Qs.NAME="baseBlock";class cr extends Qs{fromBER(e,t,n){throw TypeError("User need to make a specific function in a class which extends 'ValueBlock'")}toBER(e,t){throw TypeError("User need to make a specific function in a class which extends 'ValueBlock'")}}cr.NAME="valueBlock";class j9 extends Dn(Qs){constructor({idBlock:e={}}={}){var t,n,i,s;super(),e?(this.isHexOnly=(t=e.isHexOnly)!==null&&t!==void 0?t:!1,this.valueHexView=e.valueHex?J.toUint8Array(e.valueHex):lf,this.tagClass=(n=e.tagClass)!==null&&n!==void 0?n:-1,this.tagNumber=(i=e.tagNumber)!==null&&i!==void 0?i:-1,this.isConstructed=(s=e.isConstructed)!==null&&s!==void 0?s:!1):(this.tagClass=-1,this.tagNumber=-1,this.isConstructed=!1)}toBER(e=!1){let t=0;switch(this.tagClass){case 1:t|=0;break;case 2:t|=64;break;case 3:t|=128;break;case 4:t|=192;break;default:return this.error="Unknown tag class",Nn}if(this.isConstructed&&(t|=32),this.tagNumber<31&&!this.isHexOnly){const i=new Uint8Array(1);if(!e){let s=this.tagNumber;s&=31,t|=s,i[0]=t}return i.buffer}if(!this.isHexOnly){const i=ks(this.tagNumber,7),s=new Uint8Array(i),o=i.byteLength,a=new Uint8Array(o+1);if(a[0]=t|31,!e){for(let c=0;c<o-1;c++)a[c+1]=s[c]|128;a[o]=s[o-1]}return a.buffer}const n=new Uint8Array(this.valueHexView.byteLength+1);if(n[0]=t|31,!e){const i=this.valueHexView;for(let s=0;s<i.length-1;s++)n[s+1]=i[s]|128;n[this.valueHexView.byteLength]=i[i.length-1]}return n.buffer}fromBER(e,t,n){const i=J.toUint8Array(e);if(!si(this,i,t,n))return-1;const s=i.subarray(t,t+n);if(s.length===0)return this.error="Zero buffer length",-1;switch(s[0]&192){case 0:this.tagClass=1;break;case 64:this.tagClass=2;break;case 128:this.tagClass=3;break;case 192:this.tagClass=4;break;default:return this.error="Unknown tag class",-1}this.isConstructed=(s[0]&32)===32,this.isHexOnly=!1;const a=s[0]&31;if(a!==31)this.tagNumber=a,this.blockLength=1;else{let c=1,l=this.valueHexView=new Uint8Array(255),u=255;for(;s[c]&128;){if(l[c-1]=s[c]&127,c++,c>=s.length)return this.error="End of input reached before message was fully decoded",-1;if(c===u){u+=255;const h=new Uint8Array(u);for(let f=0;f<l.length;f++)h[f]=l[f];l=this.valueHexView=new Uint8Array(u)}}this.blockLength=c+1,l[c-1]=s[c]&127;const d=new Uint8Array(c);for(let h=0;h<c;h++)d[h]=l[h];l=this.valueHexView=new Uint8Array(c),l.set(d),this.blockLength<=9?this.tagNumber=zo(l,7):(this.isHexOnly=!0,this.warnings.push("Tag too long, represented as hex-coded"))}if(this.tagClass===1&&this.isConstructed)switch(this.tagNumber){case 1:case 2:case 5:case 6:case 9:case 13:case 14:case 23:case 24:case 31:case 32:case 33:case 34:return this.error="Constructed encoding used for primitive type",-1}return t+this.blockLength}toJSON(){return{...super.toJSON(),tagClass:this.tagClass,tagNumber:this.tagNumber,isConstructed:this.isConstructed}}}j9.NAME="identificationBlock";class G9 extends Qs{constructor({lenBlock:e={}}={}){var t,n,i;super(),this.isIndefiniteForm=(t=e.isIndefiniteForm)!==null&&t!==void 0?t:!1,this.longFormUsed=(n=e.longFormUsed)!==null&&n!==void 0?n:!1,this.length=(i=e.length)!==null&&i!==void 0?i:0}fromBER(e,t,n){const i=J.toUint8Array(e);if(!si(this,i,t,n))return-1;const s=i.subarray(t,t+n);if(s.length===0)return this.error="Zero buffer length",-1;if(s[0]===255)return this.error="Length block 0xFF is reserved by standard",-1;if(this.isIndefiniteForm=s[0]===128,this.isIndefiniteForm)return this.blockLength=1,t+this.blockLength;if(this.longFormUsed=!!(s[0]&128),this.longFormUsed===!1)return this.length=s[0],this.blockLength=1,t+this.blockLength;const o=s[0]&127;if(o>8)return this.error="Too big integer",-1;if(o+1>s.length)return this.error="End of input reached before message was fully decoded",-1;const a=t+1,c=i.subarray(a,a+o);return c[o-1]===0&&this.warnings.push("Needlessly long encoded length"),this.length=zo(c,8),this.longFormUsed&&this.length<=127&&this.warnings.push("Unnecessary usage of long length form"),this.blockLength=o+1,t+this.blockLength}toBER(e=!1){let t,n;if(this.length>127&&(this.longFormUsed=!0),this.isIndefiniteForm)return t=new ArrayBuffer(1),e===!1&&(n=new Uint8Array(t),n[0]=128),t;if(this.longFormUsed){const i=ks(this.length,8);if(i.byteLength>127)return this.error="Too big length",Nn;if(t=new ArrayBuffer(i.byteLength+1),e)return t;const s=new Uint8Array(i);n=new Uint8Array(t),n[0]=i.byteLength|128;for(let o=0;o<i.byteLength;o++)n[o+1]=s[o];return t}return t=new ArrayBuffer(1),e===!1&&(n=new Uint8Array(t),n[0]=this.length),t}toJSON(){return{...super.toJSON(),isIndefiniteForm:this.isIndefiniteForm,longFormUsed:this.longFormUsed,length:this.length}}}G9.NAME="lengthBlock";const se={};class $t extends Qs{constructor({name:e=hr,optional:t=!1,primitiveSchema:n,...i}={},s){super(i),this.name=e,this.optional=t,n&&(this.primitiveSchema=n),this.idBlock=new j9(i),this.lenBlock=new G9(i),this.valueBlock=s?new s(i):new cr(i)}fromBER(e,t,n){const i=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?n:this.lenBlock.length);return i===-1?(this.error=this.valueBlock.error,i):(this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),i)}toBER(e,t){const n=t||new cf;t||Y9(this);const i=this.idBlock.toBER(e);if(n.write(i),this.lenBlock.isIndefiniteForm)n.write(new Uint8Array([128]).buffer),this.valueBlock.toBER(e,n),n.write(new ArrayBuffer(2));else{const s=this.valueBlock.toBER(e);this.lenBlock.length=s.byteLength;const o=this.lenBlock.toBER(e);n.write(o),n.write(s)}return t?Nn:n.final()}toJSON(){const e={...super.toJSON(),idBlock:this.idBlock.toJSON(),lenBlock:this.lenBlock.toJSON(),valueBlock:this.valueBlock.toJSON(),name:this.name,optional:this.optional};return this.primitiveSchema&&(e.primitiveSchema=this.primitiveSchema.toJSON()),e}toString(e="ascii"){return e==="ascii"?this.onAsciiEncoding():ue.ToHex(this.toBER())}onAsciiEncoding(){const e=this.constructor.NAME,t=ue.ToHex(this.valueBlock.valueBeforeDecodeView);return`${e} : ${t}`}isEqual(e){if(this===e)return!0;if(!(e instanceof this.constructor))return!1;const t=this.toBER(),n=e.toBER();return qO(t,n)}}$t.NAME="BaseBlock";function Y9(r){var e;if(r instanceof se.Constructed)for(const t of r.valueBlock.value)Y9(t)&&(r.lenBlock.isIndefiniteForm=!0);return!!(!((e=r.lenBlock)===null||e===void 0)&&e.isIndefiniteForm)}class e3 extends $t{getValue(){return this.valueBlock.value}setValue(e){this.valueBlock.value=e}constructor({value:e=hr,...t}={},n){super(t,n),e&&this.fromString(e)}fromBER(e,t,n){const i=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?n:this.lenBlock.length);return i===-1?(this.error=this.valueBlock.error,i):(this.fromBuffer(this.valueBlock.valueHexView),this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),i)}onAsciiEncoding(){return`${this.constructor.NAME} : '${this.valueBlock.value}'`}}e3.NAME="BaseStringBlock";class Q9 extends Dn(cr){constructor({isHexOnly:e=!0,...t}={}){super(t),this.isHexOnly=e}}Q9.NAME="PrimitiveValueBlock";var X9;class _l extends $t{constructor(e={}){super(e,Q9),this.idBlock.isConstructed=!1}}X9=_l;se.Primitive=X9;_l.NAME="PRIMITIVE";function JO(r,e){if(r instanceof e)return r;const t=new e;return t.idBlock=r.idBlock,t.lenBlock=r.lenBlock,t.warnings=r.warnings,t.valueBeforeDecodeView=r.valueBeforeDecodeView,t}function wa(r,e=0,t=r.length){const n=e;let i=new $t({},cr);const s=new Qs;if(!si(s,r,e,t))return i.error=s.error,{offset:-1,result:i};if(!r.subarray(e,e+t).length)return i.error="Zero buffer length",{offset:-1,result:i};let a=i.idBlock.fromBER(r,e,t);if(i.idBlock.warnings.length&&i.warnings.concat(i.idBlock.warnings),a===-1)return i.error=i.idBlock.error,{offset:-1,result:i};if(e=a,t-=i.idBlock.blockLength,a=i.lenBlock.fromBER(r,e,t),i.lenBlock.warnings.length&&i.warnings.concat(i.lenBlock.warnings),a===-1)return i.error=i.lenBlock.error,{offset:-1,result:i};if(e=a,t-=i.lenBlock.blockLength,!i.idBlock.isConstructed&&i.lenBlock.isIndefiniteForm)return i.error="Indefinite length form used for primitive encoding form",{offset:-1,result:i};let c=$t;switch(i.idBlock.tagClass){case 1:if(i.idBlock.tagNumber>=37&&i.idBlock.isHexOnly===!1)return i.error="UNIVERSAL 37 and upper tags are reserved by ASN.1 standard",{offset:-1,result:i};switch(i.idBlock.tagNumber){case 0:if(i.idBlock.isConstructed&&i.lenBlock.length>0)return i.error="Type [UNIVERSAL 0] is reserved",{offset:-1,result:i};c=se.EndOfContent;break;case 1:c=se.Boolean;break;case 2:c=se.Integer;break;case 3:c=se.BitString;break;case 4:c=se.OctetString;break;case 5:c=se.Null;break;case 6:c=se.ObjectIdentifier;break;case 10:c=se.Enumerated;break;case 12:c=se.Utf8String;break;case 13:c=se.RelativeObjectIdentifier;break;case 14:c=se.TIME;break;case 15:return i.error="[UNIVERSAL 15] is reserved by ASN.1 standard",{offset:-1,result:i};case 16:c=se.Sequence;break;case 17:c=se.Set;break;case 18:c=se.NumericString;break;case 19:c=se.PrintableString;break;case 20:c=se.TeletexString;break;case 21:c=se.VideotexString;break;case 22:c=se.IA5String;break;case 23:c=se.UTCTime;break;case 24:c=se.GeneralizedTime;break;case 25:c=se.GraphicString;break;case 26:c=se.VisibleString;break;case 27:c=se.GeneralString;break;case 28:c=se.UniversalString;break;case 29:c=se.CharacterString;break;case 30:c=se.BmpString;break;case 31:c=se.DATE;break;case 32:c=se.TimeOfDay;break;case 33:c=se.DateTime;break;case 34:c=se.Duration;break;default:{const l=i.idBlock.isConstructed?new se.Constructed:new se.Primitive;l.idBlock=i.idBlock,l.lenBlock=i.lenBlock,l.warnings=i.warnings,i=l}}break;case 2:case 3:case 4:default:c=i.idBlock.isConstructed?se.Constructed:se.Primitive}return i=JO(i,c),a=i.fromBER(r,e,i.lenBlock.isIndefiniteForm?t:i.lenBlock.length),i.valueBeforeDecodeView=r.subarray(n,n+i.blockLength),{offset:a,result:i}}function Kn(r){if(!r.byteLength){const e=new $t({},cr);return e.error="Input buffer has zero length",{offset:-1,result:e}}return wa(J.toUint8Array(r).slice(),0,r.byteLength)}function eM(r,e){return r?1:e}class Ri extends cr{constructor({value:e=[],isIndefiniteForm:t=!1,...n}={}){super(n),this.value=e,this.isIndefiniteForm=t}fromBER(e,t,n){const i=J.toUint8Array(e);if(!si(this,i,t,n))return-1;if(this.valueBeforeDecodeView=i.subarray(t,t+n),this.valueBeforeDecodeView.length===0)return this.warnings.push("Zero buffer length"),t;let s=t;for(;eM(this.isIndefiniteForm,n)>0;){const o=wa(i,s,n);if(o.offset===-1)return this.error=o.result.error,this.warnings.concat(o.result.warnings),-1;if(s=o.offset,this.blockLength+=o.result.blockLength,n-=o.result.blockLength,this.value.push(o.result),this.isIndefiniteForm&&o.result.constructor.NAME===Jc)break}return this.isIndefiniteForm&&(this.value[this.value.length-1].constructor.NAME===Jc?this.value.pop():this.warnings.push("No EndOfContent block encoded")),s}toBER(e,t){const n=t||new cf;for(let i=0;i<this.value.length;i++)this.value[i].toBER(e,n);return t?Nn:n.final()}toJSON(){const e={...super.toJSON(),isIndefiniteForm:this.isIndefiniteForm,value:[]};for(const t of this.value)e.value.push(t.toJSON());return e}}Ri.NAME="ConstructedValueBlock";var Z9;class nr extends $t{constructor(e={}){super(e,Ri),this.idBlock.isConstructed=!0}fromBER(e,t,n){this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm;const i=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?n:this.lenBlock.length);return i===-1?(this.error=this.valueBlock.error,i):(this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),i)}onAsciiEncoding(){const e=[];for(const n of this.valueBlock.value)e.push(n.toString("ascii").split(`
`).map(i=>`  ${i}`).join(`
`));const t=this.idBlock.tagClass===3?`[${this.idBlock.tagNumber}]`:this.constructor.NAME;return e.length?`${t} :
${e.join(`
`)}`:`${t} :`}}Z9=nr;se.Constructed=Z9;nr.NAME="CONSTRUCTED";class J9 extends cr{fromBER(e,t,n){return t}toBER(e){return Nn}}J9.override="EndOfContentValueBlock";var eb;class t3 extends $t{constructor(e={}){super(e,J9),this.idBlock.tagClass=1,this.idBlock.tagNumber=0}}eb=t3;se.EndOfContent=eb;t3.NAME=Jc;var tb;class Yn extends $t{constructor(e={}){super(e,cr),this.idBlock.tagClass=1,this.idBlock.tagNumber=5}fromBER(e,t,n){return this.lenBlock.length>0&&this.warnings.push("Non-zero length of value block for Null type"),this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.blockLength+=n,t+n>e.byteLength?(this.error="End of input reached before message was fully decoded (inconsistent offset and length values)",-1):t+n}toBER(e,t){const n=new ArrayBuffer(2);if(!e){const i=new Uint8Array(n);i[0]=5,i[1]=0}return t&&t.write(n),n}onAsciiEncoding(){return`${this.constructor.NAME}`}}tb=Yn;se.Null=tb;Yn.NAME="NULL";class rb extends Dn(cr){get value(){for(const e of this.valueHexView)if(e>0)return!0;return!1}set value(e){this.valueHexView[0]=e?255:0}constructor({value:e,...t}={}){super(t),t.valueHex?this.valueHexView=J.toUint8Array(t.valueHex):this.valueHexView=new Uint8Array(1),e&&(this.value=e)}fromBER(e,t,n){const i=J.toUint8Array(e);return si(this,i,t,n)?(this.valueHexView=i.subarray(t,t+n),n>1&&this.warnings.push("Boolean value encoded in more then 1 octet"),this.isHexOnly=!0,q9.call(this),this.blockLength=n,t+n):-1}toBER(){return this.valueHexView.slice()}toJSON(){return{...super.toJSON(),value:this.value}}}rb.NAME="BooleanValueBlock";var nb;let uf=class extends $t{getValue(){return this.valueBlock.value}setValue(e){this.valueBlock.value=e}constructor(e={}){super(e,rb),this.idBlock.tagClass=1,this.idBlock.tagNumber=1}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.getValue}`}};nb=uf;se.Boolean=nb;uf.NAME="BOOLEAN";class ib extends Dn(Ri){constructor({isConstructed:e=!1,...t}={}){super(t),this.isConstructed=e}fromBER(e,t,n){let i=0;if(this.isConstructed){if(this.isHexOnly=!1,i=Ri.prototype.fromBER.call(this,e,t,n),i===-1)return i;for(let s=0;s<this.value.length;s++){const o=this.value[s].constructor.NAME;if(o===Jc){if(this.isIndefiniteForm)break;return this.error="EndOfContent is unexpected, OCTET STRING may consists of OCTET STRINGs only",-1}if(o!==K9)return this.error="OCTET STRING may consists of OCTET STRINGs only",-1}}else this.isHexOnly=!0,i=super.fromBER(e,t,n),this.blockLength=n;return i}toBER(e,t){return this.isConstructed?Ri.prototype.toBER.call(this,e,t):e?new ArrayBuffer(this.valueHexView.byteLength):this.valueHexView.slice().buffer}toJSON(){return{...super.toJSON(),isConstructed:this.isConstructed}}}ib.NAME="OctetStringValueBlock";var r3;let Yr=class extends $t{constructor({idBlock:e={},lenBlock:t={},...n}={}){var i,s;(i=n.isConstructed)!==null&&i!==void 0||(n.isConstructed=!!(!((s=n.value)===null||s===void 0)&&s.length)),super({idBlock:{isConstructed:n.isConstructed,...e},lenBlock:{...t,isIndefiniteForm:!!n.isIndefiniteForm},...n},ib),this.idBlock.tagClass=1,this.idBlock.tagNumber=4}fromBER(e,t,n){if(this.valueBlock.isConstructed=this.idBlock.isConstructed,this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm,n===0)return this.idBlock.error.length===0&&(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length===0&&(this.blockLength+=this.lenBlock.blockLength),t;if(!this.valueBlock.isConstructed){const s=(e instanceof ArrayBuffer?new Uint8Array(e):e).subarray(t,t+n);try{if(s.byteLength){const o=wa(s,0,s.byteLength);o.offset!==-1&&o.offset===n&&(this.valueBlock.value=[o.result])}}catch{}}return super.fromBER(e,t,n)}onAsciiEncoding(){if(this.valueBlock.isConstructed||this.valueBlock.value&&this.valueBlock.value.length)return nr.prototype.onAsciiEncoding.call(this);const e=this.constructor.NAME,t=ue.ToHex(this.valueBlock.valueHexView);return`${e} : ${t}`}getValue(){if(!this.idBlock.isConstructed)return this.valueBlock.valueHexView.slice().buffer;const e=[];for(const t of this.valueBlock.value)t instanceof r3&&e.push(t.valueBlock.valueHexView);return J.concat(e)}};r3=Yr;se.OctetString=r3;Yr.NAME=K9;class sb extends Dn(Ri){constructor({unusedBits:e=0,isConstructed:t=!1,...n}={}){super(n),this.unusedBits=e,this.isConstructed=t,this.blockLength=this.valueHexView.byteLength}fromBER(e,t,n){if(!n)return t;let i=-1;if(this.isConstructed){if(i=Ri.prototype.fromBER.call(this,e,t,n),i===-1)return i;for(const a of this.value){const c=a.constructor.NAME;if(c===Jc){if(this.isIndefiniteForm)break;return this.error="EndOfContent is unexpected, BIT STRING may consists of BIT STRINGs only",-1}if(c!==W9)return this.error="BIT STRING may consists of BIT STRINGs only",-1;const l=a.valueBlock;if(this.unusedBits>0&&l.unusedBits>0)return this.error='Using of "unused bits" inside constructive BIT STRING allowed for least one only',-1;this.unusedBits=l.unusedBits}return i}const s=J.toUint8Array(e);if(!si(this,s,t,n))return-1;const o=s.subarray(t,t+n);if(this.unusedBits=o[0],this.unusedBits>7)return this.error="Unused bits for BitString must be in range 0-7",-1;if(!this.unusedBits){const a=o.subarray(1);try{if(a.byteLength){const c=wa(a,0,a.byteLength);c.offset!==-1&&c.offset===n-1&&(this.value=[c.result])}}catch{}}return this.valueHexView=o.subarray(1),this.blockLength=o.length,t+n}toBER(e,t){if(this.isConstructed)return Ri.prototype.toBER.call(this,e,t);if(e)return new ArrayBuffer(this.valueHexView.byteLength+1);if(!this.valueHexView.byteLength){const i=new Uint8Array(1);return i[0]=0,i.buffer}const n=new Uint8Array(this.valueHexView.length+1);return n[0]=this.unusedBits,n.set(this.valueHexView,1),n.buffer}toJSON(){return{...super.toJSON(),unusedBits:this.unusedBits,isConstructed:this.isConstructed}}}sb.NAME="BitStringValueBlock";var ob;let ms=class extends $t{constructor({idBlock:e={},lenBlock:t={},...n}={}){var i,s;(i=n.isConstructed)!==null&&i!==void 0||(n.isConstructed=!!(!((s=n.value)===null||s===void 0)&&s.length)),super({idBlock:{isConstructed:n.isConstructed,...e},lenBlock:{...t,isIndefiniteForm:!!n.isIndefiniteForm},...n},sb),this.idBlock.tagClass=1,this.idBlock.tagNumber=3}fromBER(e,t,n){return this.valueBlock.isConstructed=this.idBlock.isConstructed,this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm,super.fromBER(e,t,n)}onAsciiEncoding(){if(this.valueBlock.isConstructed||this.valueBlock.value&&this.valueBlock.value.length)return nr.prototype.onAsciiEncoding.call(this);{const e=[],t=this.valueBlock.valueHexView;for(const o of t)e.push(o.toString(2).padStart(8,"0"));const n=e.join(""),i=this.constructor.NAME,s=n.substring(0,n.length-this.valueBlock.unusedBits);return`${i} : ${s}`}}};ob=ms;se.BitString=ob;ms.NAME=W9;var ab;function tM(r,e){const t=new Uint8Array([0]),n=new Uint8Array(r),i=new Uint8Array(e);let s=n.slice(0);const o=s.length-1,a=i.slice(0),c=a.length-1;let l=0;const u=c<o?o:c;let d=0;for(let h=u;h>=0;h--,d++){switch(!0){case d<a.length:l=s[o-d]+a[c-d]+t[0];break;default:l=s[o-d]+t[0]}switch(t[0]=l/10,!0){case d>=s.length:s=G0(new Uint8Array([l%10]),s);break;default:s[o-d]=l%10}}return t[0]>0&&(s=G0(t,s)),s}function gy(r){if(r>=Fa.length)for(let e=Fa.length;e<=r;e++){const t=new Uint8Array([0]);let n=Fa[e-1].slice(0);for(let i=n.length-1;i>=0;i--){const s=new Uint8Array([(n[i]<<1)+t[0]]);t[0]=s[0]/10,n[i]=s[0]%10}t[0]>0&&(n=G0(t,n)),Fa.push(n)}return Fa[r]}function rM(r,e){let t=0;const n=new Uint8Array(r),i=new Uint8Array(e),s=n.slice(0),o=s.length-1,a=i.slice(0),c=a.length-1;let l,u=0;for(let d=c;d>=0;d--,u++)switch(l=s[o-u]-a[c-u]-t,!0){case l<0:t=1,s[o-u]=l+10;break;default:t=0,s[o-u]=l}if(t>0)for(let d=o-c+1;d>=0;d--,u++)if(l=s[o-u]-t,l<0)t=1,s[o-u]=l+10;else{t=0,s[o-u]=l;break}return s.slice()}class n3 extends Dn(cr){setValueHex(){this.valueHexView.length>=4?(this.warnings.push("Too big Integer for decoding, hex only"),this.isHexOnly=!0,this._valueDec=0):(this.isHexOnly=!1,this.valueHexView.length>0&&(this._valueDec=q9.call(this)))}constructor({value:e,...t}={}){super(t),this._valueDec=0,t.valueHex&&this.setValueHex(),e!==void 0&&(this.valueDec=e)}set valueDec(e){this._valueDec=e,this.isHexOnly=!1,this.valueHexView=new Uint8Array(HO(e))}get valueDec(){return this._valueDec}fromDER(e,t,n,i=0){const s=this.fromBER(e,t,n);if(s===-1)return s;const o=this.valueHexView;return o[0]===0&&(o[1]&128)!==0?this.valueHexView=o.subarray(1):i!==0&&o.length<i&&(i-o.length>1&&(i=o.length+1),this.valueHexView=o.subarray(i-o.length)),s}toDER(e=!1){const t=this.valueHexView;switch(!0){case(t[0]&128)!==0:{const n=new Uint8Array(this.valueHexView.length+1);n[0]=0,n.set(t,1),this.valueHexView=n}break;case(t[0]===0&&(t[1]&128)===0):this.valueHexView=this.valueHexView.subarray(1);break}return this.toBER(e)}fromBER(e,t,n){const i=super.fromBER(e,t,n);return i===-1||this.setValueHex(),i}toBER(e){return e?new ArrayBuffer(this.valueHexView.length):this.valueHexView.slice().buffer}toJSON(){return{...super.toJSON(),valueDec:this.valueDec}}toString(){const e=this.valueHexView.length*8-1;let t=new Uint8Array(this.valueHexView.length*8/3),n=0,i;const s=this.valueHexView;let o="",a=!1;for(let c=s.byteLength-1;c>=0;c--){i=s[c];for(let l=0;l<8;l++){if((i&1)===1)switch(n){case e:t=rM(gy(n),t),o="-";break;default:t=tM(t,gy(n))}n++,i>>=1}}for(let c=0;c<t.length;c++)t[c]&&(a=!0),a&&(o+=fy.charAt(t[c]));return a===!1&&(o+=fy.charAt(0)),o}}ab=n3;n3.NAME="IntegerValueBlock";Object.defineProperty(ab.prototype,"valueHex",{set:function(r){this.valueHexView=new Uint8Array(r),this.setValueHex()},get:function(){return this.valueHexView.slice().buffer}});var bc;class Wn extends $t{constructor(e={}){super(e,n3),this.idBlock.tagClass=1,this.idBlock.tagNumber=2}toBigInt(){return Dd(),BigInt(this.valueBlock.toString())}static fromBigInt(e){Dd();const t=BigInt(e),n=new cf,i=t.toString(16).replace(/^-/,""),s=new Uint8Array(ue.FromHex(i));if(t<0){const a=new Uint8Array(s.length+(s[0]&128?1:0));a[0]|=128;const l=BigInt(`0x${ue.ToHex(a)}`)+t,u=J.toUint8Array(ue.FromHex(l.toString(16)));u[0]|=128,n.write(u)}else s[0]&128&&n.write(new Uint8Array([0])),n.write(s);return new bc({valueHex:n.final()})}convertToDER(){const e=new bc({valueHex:this.valueBlock.valueHexView});return e.valueBlock.toDER(),e}convertFromDER(){return new bc({valueHex:this.valueBlock.valueHexView[0]===0?this.valueBlock.valueHexView.subarray(1):this.valueBlock.valueHexView})}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()}`}}bc=Wn;se.Integer=bc;Wn.NAME="INTEGER";var cb;class df extends Wn{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=10}}cb=df;se.Enumerated=cb;df.NAME="ENUMERATED";class Y0 extends Dn(cr){constructor({valueDec:e=-1,isFirstSid:t=!1,...n}={}){super(n),this.valueDec=e,this.isFirstSid=t}fromBER(e,t,n){if(!n)return t;const i=J.toUint8Array(e);if(!si(this,i,t,n))return-1;const s=i.subarray(t,t+n);this.valueHexView=new Uint8Array(n);for(let a=0;a<n&&(this.valueHexView[a]=s[a]&127,this.blockLength++,(s[a]&128)!==0);a++);const o=new Uint8Array(this.blockLength);for(let a=0;a<this.blockLength;a++)o[a]=this.valueHexView[a];return this.valueHexView=o,(s[this.blockLength-1]&128)!==0?(this.error="End of input reached before message was fully decoded",-1):(this.valueHexView[0]===0&&this.warnings.push("Needlessly long format of SID encoding"),this.blockLength<=8?this.valueDec=zo(this.valueHexView,7):(this.isHexOnly=!0,this.warnings.push("Too big SID for decoding, hex only")),t+this.blockLength)}set valueBigInt(e){Dd();let t=BigInt(e).toString(2);for(;t.length%7;)t="0"+t;const n=new Uint8Array(t.length/7);for(let i=0;i<n.length;i++)n[i]=parseInt(t.slice(i*7,i*7+7),2)+(i+1<n.length?128:0);this.fromBER(n.buffer,0,n.length)}toBER(e){if(this.isHexOnly){if(e)return new ArrayBuffer(this.valueHexView.byteLength);const i=this.valueHexView,s=new Uint8Array(this.blockLength);for(let o=0;o<this.blockLength-1;o++)s[o]=i[o]|128;return s[this.blockLength-1]=i[this.blockLength-1],s.buffer}const t=ks(this.valueDec,7);if(t.byteLength===0)return this.error="Error during encoding SID value",Nn;const n=new Uint8Array(t.byteLength);if(!e){const i=new Uint8Array(t),s=t.byteLength-1;for(let o=0;o<s;o++)n[o]=i[o]|128;n[s]=i[s]}return n}toString(){let e="";if(this.isHexOnly)e=ue.ToHex(this.valueHexView);else if(this.isFirstSid){let t=this.valueDec;this.valueDec<=39?e="0.":this.valueDec<=79?(e="1.",t-=40):(e="2.",t-=80),e+=t.toString()}else e=this.valueDec.toString();return e}toJSON(){return{...super.toJSON(),valueDec:this.valueDec,isFirstSid:this.isFirstSid}}}Y0.NAME="sidBlock";class lb extends cr{constructor({value:e=hr,...t}={}){super(t),this.value=[],e&&this.fromString(e)}fromBER(e,t,n){let i=t;for(;n>0;){const s=new Y0;if(i=s.fromBER(e,i,n),i===-1)return this.blockLength=0,this.error=s.error,i;this.value.length===0&&(s.isFirstSid=!0),this.blockLength+=s.blockLength,n-=s.blockLength,this.value.push(s)}return i}toBER(e){const t=[];for(let n=0;n<this.value.length;n++){const i=this.value[n].toBER(e);if(i.byteLength===0)return this.error=this.value[n].error,Nn;t.push(i)}return Jg(t)}fromString(e){this.value=[];let t=0,n=0,i="",s=!1;do if(n=e.indexOf(".",t),n===-1?i=e.substring(t):i=e.substring(t,n),t=n+1,s){const o=this.value[0];let a=0;switch(o.valueDec){case 0:break;case 1:a=40;break;case 2:a=80;break;default:this.value=[];return}const c=parseInt(i,10);if(isNaN(c))return;o.valueDec=c+a,s=!1}else{const o=new Y0;if(i>Number.MAX_SAFE_INTEGER){Dd();const a=BigInt(i);o.valueBigInt=a}else if(o.valueDec=parseInt(i,10),isNaN(o.valueDec))return;this.value.length||(o.isFirstSid=!0,s=!0),this.value.push(o)}while(n!==-1)}toString(){let e="",t=!1;for(let n=0;n<this.value.length;n++){t=this.value[n].isHexOnly;let i=this.value[n].toString();n!==0&&(e=`${e}.`),t?(i=`{${i}}`,this.value[n].isFirstSid?e=`2.{${i} - 80}`:e+=i):e+=i}return e}toJSON(){const e={...super.toJSON(),value:this.toString(),sidArray:[]};for(let t=0;t<this.value.length;t++)e.sidArray.push(this.value[t].toJSON());return e}}lb.NAME="ObjectIdentifierValueBlock";var ub;class Vn extends $t{getValue(){return this.valueBlock.toString()}setValue(e){this.valueBlock.fromString(e)}constructor(e={}){super(e,lb),this.idBlock.tagClass=1,this.idBlock.tagNumber=6}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()||"empty"}`}toJSON(){return{...super.toJSON(),value:this.getValue()}}}ub=Vn;se.ObjectIdentifier=ub;Vn.NAME="OBJECT IDENTIFIER";class Q0 extends Dn(Qs){constructor({valueDec:e=0,...t}={}){super(t),this.valueDec=e}fromBER(e,t,n){if(n===0)return t;const i=J.toUint8Array(e);if(!si(this,i,t,n))return-1;const s=i.subarray(t,t+n);this.valueHexView=new Uint8Array(n);for(let a=0;a<n&&(this.valueHexView[a]=s[a]&127,this.blockLength++,(s[a]&128)!==0);a++);const o=new Uint8Array(this.blockLength);for(let a=0;a<this.blockLength;a++)o[a]=this.valueHexView[a];return this.valueHexView=o,(s[this.blockLength-1]&128)!==0?(this.error="End of input reached before message was fully decoded",-1):(this.valueHexView[0]===0&&this.warnings.push("Needlessly long format of SID encoding"),this.blockLength<=8?this.valueDec=zo(this.valueHexView,7):(this.isHexOnly=!0,this.warnings.push("Too big SID for decoding, hex only")),t+this.blockLength)}toBER(e){if(this.isHexOnly){if(e)return new ArrayBuffer(this.valueHexView.byteLength);const i=this.valueHexView,s=new Uint8Array(this.blockLength);for(let o=0;o<this.blockLength-1;o++)s[o]=i[o]|128;return s[this.blockLength-1]=i[this.blockLength-1],s.buffer}const t=ks(this.valueDec,7);if(t.byteLength===0)return this.error="Error during encoding SID value",Nn;const n=new Uint8Array(t.byteLength);if(!e){const i=new Uint8Array(t),s=t.byteLength-1;for(let o=0;o<s;o++)n[o]=i[o]|128;n[s]=i[s]}return n.buffer}toString(){let e="";return this.isHexOnly?e=ue.ToHex(this.valueHexView):e=this.valueDec.toString(),e}toJSON(){return{...super.toJSON(),valueDec:this.valueDec}}}Q0.NAME="relativeSidBlock";class db extends cr{constructor({value:e=hr,...t}={}){super(t),this.value=[],e&&this.fromString(e)}fromBER(e,t,n){let i=t;for(;n>0;){const s=new Q0;if(i=s.fromBER(e,i,n),i===-1)return this.blockLength=0,this.error=s.error,i;this.blockLength+=s.blockLength,n-=s.blockLength,this.value.push(s)}return i}toBER(e,t){const n=[];for(let i=0;i<this.value.length;i++){const s=this.value[i].toBER(e);if(s.byteLength===0)return this.error=this.value[i].error,Nn;n.push(s)}return Jg(n)}fromString(e){this.value=[];let t=0,n=0,i="";do{n=e.indexOf(".",t),n===-1?i=e.substring(t):i=e.substring(t,n),t=n+1;const s=new Q0;if(s.valueDec=parseInt(i,10),isNaN(s.valueDec))return!0;this.value.push(s)}while(n!==-1);return!0}toString(){let e="",t=!1;for(let n=0;n<this.value.length;n++){t=this.value[n].isHexOnly;let i=this.value[n].toString();n!==0&&(e=`${e}.`),t&&(i=`{${i}}`),e+=i}return e}toJSON(){const e={...super.toJSON(),value:this.toString(),sidArray:[]};for(let t=0;t<this.value.length;t++)e.sidArray.push(this.value[t].toJSON());return e}}db.NAME="RelativeObjectIdentifierValueBlock";var hb;class i3 extends $t{getValue(){return this.valueBlock.toString()}setValue(e){this.valueBlock.fromString(e)}constructor(e={}){super(e,db),this.idBlock.tagClass=1,this.idBlock.tagNumber=13}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()||"empty"}`}toJSON(){return{...super.toJSON(),value:this.getValue()}}}hb=i3;se.RelativeObjectIdentifier=hb;i3.NAME="RelativeObjectIdentifier";var fb;class yt extends nr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=16}}fb=yt;se.Sequence=fb;yt.NAME="SEQUENCE";var pb;let kn=class extends nr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=17}};pb=kn;se.Set=pb;kn.NAME="SET";class gb extends Dn(cr){constructor({...e}={}){super(e),this.isHexOnly=!0,this.value=hr}toJSON(){return{...super.toJSON(),value:this.value}}}gb.NAME="StringValueBlock";class mb extends gb{}mb.NAME="SimpleStringValueBlock";class Cr extends e3{constructor({...e}={}){super(e,mb)}fromBuffer(e){this.valueBlock.value=String.fromCharCode.apply(null,J.toUint8Array(e))}fromString(e){const t=e.length,n=this.valueBlock.valueHexView=new Uint8Array(t);for(let i=0;i<t;i++)n[i]=e.charCodeAt(i);this.valueBlock.value=e}}Cr.NAME="SIMPLE STRING";class yb extends Cr{fromBuffer(e){this.valueBlock.valueHexView=J.toUint8Array(e);try{this.valueBlock.value=ue.ToUtf8String(e)}catch(t){this.warnings.push(`Error during "decodeURIComponent": ${t}, using raw string`),this.valueBlock.value=ue.ToBinary(e)}}fromString(e){this.valueBlock.valueHexView=new Uint8Array(ue.FromUtf8String(e)),this.valueBlock.value=e}}yb.NAME="Utf8StringValueBlock";var wb;class oi extends yb{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=12}}wb=oi;se.Utf8String=wb;oi.NAME="UTF8String";class bb extends Cr{fromBuffer(e){this.valueBlock.value=ue.ToUtf16String(e),this.valueBlock.valueHexView=J.toUint8Array(e)}fromString(e){this.valueBlock.value=e,this.valueBlock.valueHexView=new Uint8Array(ue.FromUtf16String(e))}}bb.NAME="BmpStringValueBlock";var vb;class hf extends bb{constructor({...e}={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=30}}vb=hf;se.BmpString=vb;hf.NAME="BMPString";class Eb extends Cr{fromBuffer(e){const t=ArrayBuffer.isView(e)?e.slice().buffer:e.slice(0),n=new Uint8Array(t);for(let i=0;i<n.length;i+=4)n[i]=n[i+3],n[i+1]=n[i+2],n[i+2]=0,n[i+3]=0;this.valueBlock.value=String.fromCharCode.apply(null,new Uint32Array(t))}fromString(e){const t=e.length,n=this.valueBlock.valueHexView=new Uint8Array(t*4);for(let i=0;i<t;i++){const s=ks(e.charCodeAt(i),8),o=new Uint8Array(s);if(o.length>4)continue;const a=4-o.length;for(let c=o.length-1;c>=0;c--)n[i*4+c+a]=o[c]}this.valueBlock.value=e}}Eb.NAME="UniversalStringValueBlock";var Sb;class ff extends Eb{constructor({...e}={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=28}}Sb=ff;se.UniversalString=Sb;ff.NAME="UniversalString";var xb;class pf extends Cr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=18}}xb=pf;se.NumericString=xb;pf.NAME="NumericString";var Ab;class gf extends Cr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=19}}Ab=gf;se.PrintableString=Ab;gf.NAME="PrintableString";var kb;class mf extends Cr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=20}}kb=mf;se.TeletexString=kb;mf.NAME="TeletexString";var Cb;class yf extends Cr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=21}}Cb=yf;se.VideotexString=Cb;yf.NAME="VideotexString";var Ib;class wf extends Cr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=22}}Ib=wf;se.IA5String=Ib;wf.NAME="IA5String";var _b;class bf extends Cr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=25}}_b=bf;se.GraphicString=_b;bf.NAME="GraphicString";var Tb;class Tl extends Cr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=26}}Tb=Tl;se.VisibleString=Tb;Tl.NAME="VisibleString";var Pb;class vf extends Cr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=27}}Pb=vf;se.GeneralString=Pb;vf.NAME="GeneralString";var Rb;class Ef extends Cr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=29}}Rb=Ef;se.CharacterString=Rb;Ef.NAME="CharacterString";var Nb;class Pl extends Tl{constructor({value:e,valueDate:t,...n}={}){if(super(n),this.year=0,this.month=0,this.day=0,this.hour=0,this.minute=0,this.second=0,e){this.fromString(e),this.valueBlock.valueHexView=new Uint8Array(e.length);for(let i=0;i<e.length;i++)this.valueBlock.valueHexView[i]=e.charCodeAt(i)}t&&(this.fromDate(t),this.valueBlock.valueHexView=new Uint8Array(this.toBuffer())),this.idBlock.tagClass=1,this.idBlock.tagNumber=23}fromBuffer(e){this.fromString(String.fromCharCode.apply(null,J.toUint8Array(e)))}toBuffer(){const e=this.toString(),t=new ArrayBuffer(e.length),n=new Uint8Array(t);for(let i=0;i<e.length;i++)n[i]=e.charCodeAt(i);return t}fromDate(e){this.year=e.getUTCFullYear(),this.month=e.getUTCMonth()+1,this.day=e.getUTCDate(),this.hour=e.getUTCHours(),this.minute=e.getUTCMinutes(),this.second=e.getUTCSeconds()}toDate(){return new Date(Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second))}fromString(e){const n=/(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})Z/ig.exec(e);if(n===null){this.error="Wrong input string for conversion";return}const i=parseInt(n[1],10);i>=50?this.year=1900+i:this.year=2e3+i,this.month=parseInt(n[2],10),this.day=parseInt(n[3],10),this.hour=parseInt(n[4],10),this.minute=parseInt(n[5],10),this.second=parseInt(n[6],10)}toString(e="iso"){if(e==="iso"){const t=new Array(7);return t[0]=wr(this.year<2e3?this.year-1900:this.year-2e3,2),t[1]=wr(this.month,2),t[2]=wr(this.day,2),t[3]=wr(this.hour,2),t[4]=wr(this.minute,2),t[5]=wr(this.second,2),t[6]="Z",t.join("")}return super.toString(e)}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.toDate().toISOString()}`}toJSON(){return{...super.toJSON(),year:this.year,month:this.month,day:this.day,hour:this.hour,minute:this.minute,second:this.second}}}Nb=Pl;se.UTCTime=Nb;Pl.NAME="UTCTime";var Db;class Sf extends Pl{constructor(e={}){var t;super(e),(t=this.millisecond)!==null&&t!==void 0||(this.millisecond=0),this.idBlock.tagClass=1,this.idBlock.tagNumber=24}fromDate(e){super.fromDate(e),this.millisecond=e.getUTCMilliseconds()}toDate(){const e=Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second,this.millisecond);return new Date(e)}fromString(e){let t=!1,n="",i="",s=0,o,a=0,c=0;if(e[e.length-1]==="Z")n=e.substring(0,e.length-1),t=!0;else{const d=new Number(e[e.length-1]);if(isNaN(d.valueOf()))throw new Error("Wrong input string for conversion");n=e}if(t){if(n.indexOf("+")!==-1)throw new Error("Wrong input string for conversion");if(n.indexOf("-")!==-1)throw new Error("Wrong input string for conversion")}else{let d=1,h=n.indexOf("+"),f="";if(h===-1&&(h=n.indexOf("-"),d=-1),h!==-1){if(f=n.substring(h+1),n=n.substring(0,h),f.length!==2&&f.length!==4)throw new Error("Wrong input string for conversion");let y=parseInt(f.substring(0,2),10);if(isNaN(y.valueOf()))throw new Error("Wrong input string for conversion");if(a=d*y,f.length===4){if(y=parseInt(f.substring(2,4),10),isNaN(y.valueOf()))throw new Error("Wrong input string for conversion");c=d*y}}}let l=n.indexOf(".");if(l===-1&&(l=n.indexOf(",")),l!==-1){const d=new Number(`0${n.substring(l)}`);if(isNaN(d.valueOf()))throw new Error("Wrong input string for conversion");s=d.valueOf(),i=n.substring(0,l)}else i=n;switch(!0){case i.length===8:if(o=/(\d{4})(\d{2})(\d{2})/ig,l!==-1)throw new Error("Wrong input string for conversion");break;case i.length===10:if(o=/(\d{4})(\d{2})(\d{2})(\d{2})/ig,l!==-1){let d=60*s;this.minute=Math.floor(d),d=60*(d-this.minute),this.second=Math.floor(d),d=1e3*(d-this.second),this.millisecond=Math.floor(d)}break;case i.length===12:if(o=/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})/ig,l!==-1){let d=60*s;this.second=Math.floor(d),d=1e3*(d-this.second),this.millisecond=Math.floor(d)}break;case i.length===14:if(o=/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})/ig,l!==-1){const d=1e3*s;this.millisecond=Math.floor(d)}break;default:throw new Error("Wrong input string for conversion")}const u=o.exec(i);if(u===null)throw new Error("Wrong input string for conversion");for(let d=1;d<u.length;d++)switch(d){case 1:this.year=parseInt(u[d],10);break;case 2:this.month=parseInt(u[d],10);break;case 3:this.day=parseInt(u[d],10);break;case 4:this.hour=parseInt(u[d],10)+a;break;case 5:this.minute=parseInt(u[d],10)+c;break;case 6:this.second=parseInt(u[d],10);break;default:throw new Error("Wrong input string for conversion")}if(t===!1){const d=new Date(this.year,this.month,this.day,this.hour,this.minute,this.second,this.millisecond);this.year=d.getUTCFullYear(),this.month=d.getUTCMonth(),this.day=d.getUTCDay(),this.hour=d.getUTCHours(),this.minute=d.getUTCMinutes(),this.second=d.getUTCSeconds(),this.millisecond=d.getUTCMilliseconds()}}toString(e="iso"){if(e==="iso"){const t=[];return t.push(wr(this.year,4)),t.push(wr(this.month,2)),t.push(wr(this.day,2)),t.push(wr(this.hour,2)),t.push(wr(this.minute,2)),t.push(wr(this.second,2)),this.millisecond!==0&&(t.push("."),t.push(wr(this.millisecond,3))),t.push("Z"),t.join("")}return super.toString(e)}toJSON(){return{...super.toJSON(),millisecond:this.millisecond}}}Db=Sf;se.GeneralizedTime=Db;Sf.NAME="GeneralizedTime";var Bb;class s3 extends oi{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=31}}Bb=s3;se.DATE=Bb;s3.NAME="DATE";var Lb;class o3 extends oi{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=32}}Lb=o3;se.TimeOfDay=Lb;o3.NAME="TimeOfDay";var Ob;class a3 extends oi{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=33}}Ob=a3;se.DateTime=Ob;a3.NAME="DateTime";var Mb;class c3 extends oi{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=34}}Mb=c3;se.Duration=Mb;c3.NAME="Duration";var $b;class l3 extends oi{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=14}}$b=l3;se.TIME=$b;l3.NAME="TIME";class Cs{constructor({name:e=hr,optional:t=!1}={}){this.name=e,this.optional=t}}class u3 extends Cs{constructor({value:e=[],...t}={}){super(t),this.value=e}}class Bd extends Cs{constructor({value:e=new Cs,local:t=!1,...n}={}){super(n),this.value=e,this.local=t}}class nM{get data(){return this.dataView.slice().buffer}set data(e){this.dataView=J.toUint8Array(e)}constructor({data:e=lf}={}){this.dataView=J.toUint8Array(e)}fromBER(e,t,n){const i=t+n;return this.dataView=J.toUint8Array(e).subarray(t,i),i}toBER(e){return this.dataView.slice().buffer}}function xi(r,e,t){if(t instanceof u3){for(const s of t.value)if(xi(r,e,s).verified)return{verified:!0,result:r};{const s={verified:!1,result:{error:"Wrong values for Choice type"}};return t.hasOwnProperty(j1)&&(s.name=t.name),s}}if(t instanceof Cs)return t.hasOwnProperty(j1)&&(r[t.name]=e),{verified:!0,result:r};if(!(r instanceof Object))return{verified:!1,result:{error:"Wrong root object"}};if(!(e instanceof Object))return{verified:!1,result:{error:"Wrong ASN.1 data"}};if(!(t instanceof Object))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(!(WO in t))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(!(QO in t.idBlock))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(!(XO in t.idBlock))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};const n=t.idBlock.toBER(!1);if(n.byteLength===0)return{verified:!1,result:{error:"Error encoding idBlock for ASN.1 schema"}};if(t.idBlock.fromBER(n,0,n.byteLength)===-1)return{verified:!1,result:{error:"Error decoding idBlock for ASN.1 schema"}};if(t.idBlock.hasOwnProperty(jO)===!1)return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(t.idBlock.tagClass!==e.idBlock.tagClass)return{verified:!1,result:r};if(t.idBlock.hasOwnProperty(GO)===!1)return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(t.idBlock.tagNumber!==e.idBlock.tagNumber)return{verified:!1,result:r};if(t.idBlock.hasOwnProperty(YO)===!1)return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(t.idBlock.isConstructed!==e.idBlock.isConstructed)return{verified:!1,result:r};if(!(KO in t.idBlock))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(t.idBlock.isHexOnly!==e.idBlock.isHexOnly)return{verified:!1,result:r};if(t.idBlock.isHexOnly){if(!(py in t.idBlock))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};const s=t.idBlock.valueHexView,o=e.idBlock.valueHexView;if(s.length!==o.length)return{verified:!1,result:r};for(let a=0;a<s.length;a++)if(s[a]!==o[1])return{verified:!1,result:r}}if(t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,hr),t.name&&(r[t.name]=e)),t instanceof se.Constructed){let s=0,o={verified:!1,result:{error:"Unknown error"}},a=t.valueBlock.value.length;if(a>0&&t.valueBlock.value[0]instanceof Bd&&(a=e.valueBlock.value.length),a===0)return{verified:!0,result:r};if(e.valueBlock.value.length===0&&t.valueBlock.value.length!==0){let c=!0;for(let l=0;l<t.valueBlock.value.length;l++)c=c&&(t.valueBlock.value[l].optional||!1);return c?{verified:!0,result:r}:(t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,hr),t.name&&delete r[t.name]),r.error="Inconsistent object length",{verified:!1,result:r})}for(let c=0;c<a;c++)if(c-s>=e.valueBlock.value.length){if(t.valueBlock.value[c].optional===!1){const l={verified:!1,result:r};return r.error="Inconsistent length between ASN.1 data and schema",t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,hr),t.name&&(delete r[t.name],l.name=t.name)),l}}else if(t.valueBlock.value[0]instanceof Bd){if(o=xi(r,e.valueBlock.value[c],t.valueBlock.value[0].value),o.verified===!1)if(t.valueBlock.value[0].optional)s++;else return t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,hr),t.name&&delete r[t.name]),o;if(j1 in t.valueBlock.value[0]&&t.valueBlock.value[0].name.length>0){let l={};ZO in t.valueBlock.value[0]&&t.valueBlock.value[0].local?l=e:l=r,typeof l[t.valueBlock.value[0].name]>"u"&&(l[t.valueBlock.value[0].name]=[]),l[t.valueBlock.value[0].name].push(e.valueBlock.value[c])}}else if(o=xi(r,e.valueBlock.value[c-s],t.valueBlock.value[c]),o.verified===!1)if(t.valueBlock.value[c].optional)s++;else return t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,hr),t.name&&delete r[t.name]),o;if(o.verified===!1){const c={verified:!1,result:r};return t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,hr),t.name&&(delete r[t.name],c.name=t.name)),c}return{verified:!0,result:r}}if(t.primitiveSchema&&py in e.valueBlock){const s=wa(e.valueBlock.valueHexView);if(s.offset===-1){const o={verified:!1,result:s.result};return t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,hr),t.name&&(delete r[t.name],o.name=t.name)),o}return xi(r,s.result,t.primitiveSchema)}return{verified:!0,result:r}}function iM(r,e){if(!(e instanceof Object))return{verified:!1,result:{error:"Wrong ASN.1 schema type"}};const t=wa(J.toUint8Array(r));return t.offset===-1?{verified:!1,result:t.result}:xi(t.result,t.result,e)}const Ub=Object.freeze(Object.defineProperty({__proto__:null,Any:Cs,BaseBlock:$t,BaseStringBlock:e3,BitString:ms,BmpString:hf,Boolean:uf,CharacterString:Ef,Choice:u3,Constructed:nr,DATE:s3,DateTime:a3,Duration:c3,EndOfContent:t3,Enumerated:df,GeneralString:vf,GeneralizedTime:Sf,GraphicString:bf,HexBlock:Dn,IA5String:wf,Integer:Wn,Null:Yn,NumericString:pf,ObjectIdentifier:Vn,OctetString:Yr,Primitive:_l,PrintableString:gf,RawData:nM,RelativeObjectIdentifier:i3,Repeated:Bd,Sequence:yt,Set:kn,TIME:l3,TeletexString:mf,TimeOfDay:o3,UTCTime:Pl,UniversalString:ff,Utf8String:oi,ValueBlock:cr,VideotexString:yf,ViewWriter:cf,VisibleString:Tl,compareSchema:xi,fromBER:Kn,verifySchema:iM},Symbol.toStringTag,{value:"Module"})),sM=16,X0=32,Z0=1e4;async function xf(r,e){const n=await z9().encrypt(r,e);return Br.encode(n)}async function my(r,e,t){if(r.type==="RSA")return lM(r,e,t);if(r.type==="Ed25519")return oM(r,e,t);if(r.type==="secp256k1")return aM(r,e,t);if(r.type==="ECDSA")return cM(r,e,t);throw new ca}async function oM(r,e,t="libp2p-key"){if(t==="libp2p-key")return xf(El(r),e);throw new H(`export format '${t}' is not supported`)}async function aM(r,e,t="libp2p-key"){if(t==="libp2p-key")return xf(El(r),e);throw new H("Export format is not supported")}async function cM(r,e,t="libp2p-key"){if(t==="libp2p-key")return xf(El(r),e);throw new H(`export format '${t}' is not supported`)}async function lM(r,e,t="pkcs-8"){if(t==="pkcs-8")return uM(r,e);if(t==="libp2p-key")return xf(El(r),e);throw new H("Export format is not supported")}async function uM(r,e){const t=ir.get(),i=new yt({value:[new Wn({value:0}),new yt({value:[new Vn({value:"1.2.840.113549.1.1.1"}),new Yn]}),new Yr({valueHex:r.raw})]}).toBER(),s=new Uint8Array(i,0,i.byteLength),o=Ss(sM),a=await S7(qh,e,o,{c:Z0,dkLen:X0}),c=Ss(16),l=await t.subtle.importKey("raw",a,"AES-CBC",!1,["encrypt"]),u=await t.subtle.encrypt({name:"AES-CBC",iv:c},l,s),d=new yt({value:[new Yr({valueHex:o}),new Wn({value:Z0}),new Wn({value:X0}),new yt({value:[new Vn({value:"1.2.840.113549.2.11"}),new Yn]})]}),h=new yt({value:[new Vn({value:"1.2.840.113549.1.5.13"}),new yt({value:[new yt({value:[new Vn({value:"1.2.840.113549.1.5.12"}),d]}),new yt({value:[new Vn({value:"2.16.840.1.101.3.4.1.42"}),new Yr({valueHex:c})]})]})]}),y=new yt({value:[h,new Yr({valueHex:u})]}).toBER(),m=new Uint8Array(y,0,y.byteLength);return["-----BEGIN ENCRYPTED PRIVATE KEY-----",...Y(m,"base64pad").split(/(.{64})/).filter(Boolean),"-----END ENCRYPTED PRIVATE KEY-----"].join(`
`)}async function yy(r,e){try{const t=await dM(r,e);return pI(t)}catch{}if(!r.includes("BEGIN"))throw new H("Encrypted key was not a libp2p-key or a PEM file");return hM(r,e)}async function dM(r,e){const t=Br.decode(r);return z9().decrypt(t,e)}async function hM(r,e){const t=ir.get();let n;if(r.includes("-----BEGIN ENCRYPTED PRIVATE KEY-----")){const s=W(r.replace("-----BEGIN ENCRYPTED PRIVATE KEY-----","").replace("-----END ENCRYPTED PRIVATE KEY-----","").replace(/\n/g,"").trim(),"base64pad"),{result:o}=Kn(s),{iv:a,salt:c,iterations:l,keySize:u,cipherText:d}=fM(o),h=await S7(qh,e,c,{c:l,dkLen:u}),f=await t.subtle.importKey("raw",h,"AES-CBC",!1,["decrypt"]),y=vc(await t.subtle.decrypt({name:"AES-CBC",iv:a},f,d)),{result:m}=Kn(y);n=wy(m)}else if(r.includes("-----BEGIN PRIVATE KEY-----")){const s=W(r.replace("-----BEGIN PRIVATE KEY-----","").replace("-----END PRIVATE KEY-----","").replace(/\n/g,"").trim(),"base64pad"),{result:o}=Kn(s);n=wy(o)}else throw new H("Could not parse private key from PEM data");const i=gI(n);if(i.type!=="RSA")throw new H("Could not parse RSA private key from PEM data");return i}function fM(r){const e=r.valueBlock.value[0];if(e.valueBlock.value[0].toString()!=="OBJECT IDENTIFIER : 1.2.840.113549.1.5.13")throw new H("Only pkcs5PBES2 encrypted private keys are supported");const n=e.valueBlock.value[1].valueBlock.value[0];if(n.valueBlock.value[0].toString()!=="OBJECT IDENTIFIER : 1.2.840.113549.1.5.12")throw new H("Only pkcs5PBKDF2 key derivation functions are supported");const s=n.valueBlock.value[1],o=vc(s.valueBlock.value[0].getValue());let a=Z0,c=X0;if(s.valueBlock.value.length===3)a=Number(s.valueBlock.value[1].toBigInt()),c=Number(s.valueBlock.value[2].toBigInt());else if(s.valueBlock.value.length===2)throw new H("Could not derive key size and iterations from PEM file - please use @libp2p/rsa to re-import your key");const l=e.valueBlock.value[1].valueBlock.value[1],u=l.valueBlock.value[0].toString();if(u!=="OBJECT IDENTIFIER : 1.2.840.113549.3.7"){if(u!=="OBJECT IDENTIFIER : 1.3.14.3.2.7"){if(u!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.2"){if(u!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.22"){if(u!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.42")throw new H("Only AES-CBC encryption schemes are supported")}}}}const d=vc(l.valueBlock.value[1].getValue());return{cipherText:vc(r.valueBlock.value[1].getValue()),salt:o,iterations:a,keySize:c,iv:d}}function wy(r){return vc(r.valueBlock.value[2].getValue())}function vc(r){return new Uint8Array(r,0,r.byteLength)}const pM="/pkcs8/",J0="/info/",Va=new WeakMap,Zi={minKeyLength:112/8,minSaltLength:128/8,minIterationCount:1e3};function io(r){return r==null||typeof r!="string"?!1:r===MO(r.trim())&&r.length>0}async function Tt(){const t=Math.random()*800+200;await new Promise(n=>setTimeout(n,t))}function Ji(r){return new Ye(pM+r)}function so(r){return new Ye(J0+r)}async function gM(r){const e=El(r),t=await Et.digest(e);return Ct.encode(t.bytes).substring(1)}class mM{components;init;log;self;constructor(e,t){if(this.components=e,this.log=e.logger.forComponent("libp2p:keychain"),this.init={...t,dek:{...dy,...t.dek}},this.self=t.selfKey??"self",this.init.pass!=null&&this.init.pass?.length<20)throw new Error("pass must be least 20 characters");if(this.init.dek?.keyLength!=null&&this.init.dek.keyLength<Zi.minKeyLength)throw new Error(`dek.keyLength must be least ${Zi.minKeyLength} bytes`);if(this.init.dek?.salt?.length!=null&&this.init.dek.salt.length<Zi.minSaltLength)throw new Error(`dek.saltLength must be least ${Zi.minSaltLength} bytes`);if(this.init.dek?.iterationCount!=null&&this.init.dek.iterationCount<Zi.minIterationCount)throw new Error(`dek.iterationCount must be least ${Zi.minIterationCount}`);const n=this.init.pass!=null&&this.init.dek?.salt!=null?J4(this.init.pass,this.init.dek?.salt,this.init.dek?.iterationCount,this.init.dek?.keyLength,this.init.dek?.hash):"";Va.set(this,{dek:n})}[Symbol.toStringTag]="@libp2p/keychain";[It]=["@libp2p/keychain"];static generateOptions(){const e=Object.assign({},this.options),t=Math.ceil(Zi.minSaltLength/3)*3;return e.dek!=null&&(e.dek.salt=Y(Ss(t),"base64")),e}static get options(){return{dek:{...dy}}}async findKeyByName(e){if(!io(e))throw await Tt(),new H(`Invalid key name '${e}'`);const t=so(e);try{const n=await this.components.datastore.get(t);return JSON.parse(Y(n))}catch(n){throw await Tt(),this.log.error("could not read key from datastore - %e",n),new wt(`Key '${e}' does not exist.`)}}async findKeyById(e){try{const t={prefix:J0};for await(const n of this.components.datastore.query(t)){const i=JSON.parse(Y(n.value));if(i.id===e)return i}throw new H(`Key with id '${e}' does not exist.`)}catch(t){throw await Tt(),t}}async importKey(e,t){if(!io(e))throw await Tt(),new H(`Invalid key name '${e}'`);if(t==null)throw await Tt(),new H("Key is required");const n=Ji(e);if(await this.components.datastore.has(n))throw await Tt(),new H(`Key '${e}' already exists`);let s,o;try{s=await gM(t);const l=Va.get(this);if(l==null)throw new H("dek missing");const u=l.dek;o=await my(t,u,t.type==="RSA"?"pkcs-8":"libp2p-key")}catch(l){throw await Tt(),l}const a={name:e,id:s},c=this.components.datastore.batch();return c.put(n,W(o)),c.put(so(e),W(JSON.stringify(a))),await c.commit(),a}async exportKey(e){if(!io(e))throw await Tt(),new H(`Invalid key name '${e}'`);const t=Ji(e);try{const n=await this.components.datastore.get(t),i=Y(n),s=Va.get(this);if(s==null)throw new H("dek missing");const o=s.dek;return await yy(i,o)}catch(n){throw await Tt(),n}}async removeKey(e){if(!io(e)||e===this.self)throw await Tt(),new H(`Invalid key name '${e}'`);const t=Ji(e),n=await this.findKeyByName(e),i=this.components.datastore.batch();return i.delete(t),i.delete(so(e)),await i.commit(),n}async listKeys(){const e={prefix:J0},t=[];for await(const n of this.components.datastore.query(e))t.push(JSON.parse(Y(n.value)));return t}async renameKey(e,t){if(!io(e)||e===this.self)throw await Tt(),new H(`Invalid old key name '${e}'`);if(!io(t)||t===this.self)throw await Tt(),new H(`Invalid new key name '${t}'`);const n=Ji(e),i=Ji(t),s=so(e),o=so(t);if(await this.components.datastore.has(i))throw await Tt(),new H(`Key '${t}' already exists`);try{const c=await this.components.datastore.get(n),l=await this.components.datastore.get(s),u=JSON.parse(Y(l));u.name=t;const d=this.components.datastore.batch();return d.put(i,c),d.put(o,W(JSON.stringify(u))),d.delete(n),d.delete(s),await d.commit(),u}catch(c){throw await Tt(),c}}async rotateKeychainPass(e,t){if(typeof e!="string")throw await Tt(),new H(`Invalid old pass type '${typeof e}'`);if(typeof t!="string")throw await Tt(),new H(`Invalid new pass type '${typeof t}'`);if(t.length<20)throw await Tt(),new H(`Invalid pass length ${t.length}`);this.log("recreating keychain");const n=Va.get(this);if(n==null)throw new H("dek missing");const i=n.dek;this.init.pass=t;const s=t!=null&&this.init.dek?.salt!=null?J4(t,this.init.dek.salt,this.init.dek?.iterationCount,this.init.dek?.keyLength,this.init.dek?.hash):"";Va.set(this,{dek:s});const o=await this.listKeys();for(const a of o){const c=await this.components.datastore.get(Ji(a.name)),l=Y(c),u=await yy(l,i),d=s.toString(),h=await my(u,d,u.type==="RSA"?"pkcs-8":"libp2p-key"),f=this.components.datastore.batch(),y={name:a.name,id:a.id};f.put(Ji(a.name),W(h)),f.put(so(a.name),W(JSON.stringify(y))),await f.commit()}this.log("keychain reconstructed")}}function Fb(r={}){return e=>new mM(e,r)}async function yM(r,e={}){const t=e.selfKey??"self",n=Fb(e)({datastore:r,logger:gl()});let i;return await r.has(new Ye(`/pkcs8/${t}`))?i=await n.exportKey(t):(i=await cg(e.keyType??"Ed25519"),await n.importKey(t,i)),i}var wM={};const el=65535,by=el-16,Rl=!!wM?.DUMP_SESSION_KEYS,vy=16;function bM(r){return r instanceof Uint8Array||ArrayBuffer.isView(r)&&r.constructor.name==="Uint8Array"}function e2(r){if(typeof r!="boolean")throw new Error(`boolean expected, not ${r}`)}function G1(r){if(!Number.isSafeInteger(r)||r<0)throw new Error("positive integer expected, got "+r)}function tr(r,e,t=""){const n=bM(r),i=r?.length,s=e!==void 0;if(!n||s&&i!==e){const o=t&&`"${t}" `,a=s?` of length ${e}`:"",c=n?`length=${i}`:`type=${typeof r}`;throw new Error(o+"expected Uint8Array"+a+", got "+c)}return r}function Ey(r,e=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(e&&r.finished)throw new Error("Hash#digest() has already been called")}function vM(r,e){tr(r,void 0,"output");const t=e.outputLen;if(r.length<t)throw new Error("digestInto() expects output buffer of length at least "+t)}function Ni(r){return new Uint32Array(r.buffer,r.byteOffset,Math.floor(r.byteLength/4))}function Ho(...r){for(let e=0;e<r.length;e++)r[e].fill(0)}function EM(r){return new DataView(r.buffer,r.byteOffset,r.byteLength)}const SM=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;function xM(r,e){if(e==null||typeof e!="object")throw new Error("options must be defined");return Object.assign(r,e)}function AM(r,e){if(r.length!==e.length)return!1;let t=0;for(let n=0;n<r.length;n++)t|=r[n]^e[n];return t===0}const kM=(r,e)=>{function t(n,...i){if(tr(n,void 0,"key"),!SM)throw new Error("Non little-endian hardware is not yet supported");if(r.nonceLength!==void 0){const u=i[0];tr(u,r.varSizeNonce?void 0:r.nonceLength,"nonce")}const s=r.tagLength;s&&i[1]!==void 0&&tr(i[1],void 0,"AAD");const o=e(n,...i),a=(u,d)=>{if(d!==void 0){if(u!==2)throw new Error("cipher output not supported");tr(d,void 0,"output")}};let c=!1;return{encrypt(u,d){if(c)throw new Error("cannot encrypt() twice with same key + nonce");return c=!0,tr(u),a(o.encrypt.length,d),o.encrypt(u,d)},decrypt(u,d){if(tr(u),s&&u.length<s)throw new Error('"ciphertext" expected length bigger than tagLength='+s);return a(o.decrypt.length,d),o.decrypt(u,d)}}}return Object.assign(t,r),t};function Sy(r,e,t=!0){if(e===void 0)return new Uint8Array(r);if(e.length!==r)throw new Error('"output" expected Uint8Array of length '+r+", got: "+e.length);if(t&&!IM(e))throw new Error("invalid output, must be aligned");return e}function CM(r,e,t){e2(t);const n=new Uint8Array(16),i=EM(n);return i.setBigUint64(0,BigInt(e),t),i.setBigUint64(8,BigInt(r),t),n}function IM(r){return r.byteOffset%4===0}function Ld(r){return Uint8Array.from(r)}const Vb=r=>Uint8Array.from(r.split(""),e=>e.charCodeAt(0)),_M=Vb("expand 16-byte k"),TM=Vb("expand 32-byte k"),PM=Ni(_M),RM=Ni(TM);function Me(r,e){return r<<e|r>>>32-e}function t2(r){return r.byteOffset%4===0}const Eu=64,NM=16,zb=2**32-1,xy=Uint32Array.of();function DM(r,e,t,n,i,s,o,a){const c=i.length,l=new Uint8Array(Eu),u=Ni(l),d=t2(i)&&t2(s),h=d?Ni(i):xy,f=d?Ni(s):xy;for(let y=0;y<c;o++){if(r(e,t,n,u,o,a),o>=zb)throw new Error("arx: counter overflow");const m=Math.min(Eu,c-y);if(d&&m===Eu){const p=y/4;if(y%4!==0)throw new Error("arx: invalid block position");for(let b=0,A;b<NM;b++)A=p+b,f[A]=h[A]^u[b];y+=Eu;continue}for(let p=0,b;p<m;p++)b=y+p,s[b]=i[b]^l[p];y+=m}}function BM(r,e){const{allowShortKeys:t,extendNonceFn:n,counterLength:i,counterRight:s,rounds:o}=xM({allowShortKeys:!1,counterLength:8,counterRight:!1,rounds:20},e);if(typeof r!="function")throw new Error("core must be a function");return G1(i),G1(o),e2(s),e2(t),(a,c,l,u,d=0)=>{tr(a,void 0,"key"),tr(c,void 0,"nonce"),tr(l,void 0,"data");const h=l.length;if(u===void 0&&(u=new Uint8Array(h)),tr(u,void 0,"output"),G1(d),d<0||d>=zb)throw new Error("arx: counter overflow");if(u.length<h)throw new Error(`arx: output (${u.length}) is shorter than data (${h})`);const f=[];let y=a.length,m,p;if(y===32)f.push(m=Ld(a)),p=RM;else if(y===16&&t)m=new Uint8Array(32),m.set(a),m.set(a,16),p=PM,f.push(m);else throw tr(a,32,"arx key"),new Error("invalid key size");t2(c)||f.push(c=Ld(c));const b=Ni(m);if(n){if(c.length!==24)throw new Error("arx: extended nonce must be 24 bytes");n(p,b,Ni(c.subarray(0,16)),b),c=c.subarray(16)}const A=16-i;if(A!==c.length)throw new Error(`arx: nonce must be ${A} or 16 bytes`);if(A!==12){const C=new Uint8Array(12);C.set(c,s?0:12-c.length),c=C,f.push(c)}const v=Ni(c);return DM(r,p,b,v,l,u,d,o),Ho(...f),u}}function Pt(r,e){return r[e++]&255|(r[e++]&255)<<8}class LM{blockLen=16;outputLen=16;buffer=new Uint8Array(16);r=new Uint16Array(10);h=new Uint16Array(10);pad=new Uint16Array(8);pos=0;finished=!1;constructor(e){e=Ld(tr(e,32,"key"));const t=Pt(e,0),n=Pt(e,2),i=Pt(e,4),s=Pt(e,6),o=Pt(e,8),a=Pt(e,10),c=Pt(e,12),l=Pt(e,14);this.r[0]=t&8191,this.r[1]=(t>>>13|n<<3)&8191,this.r[2]=(n>>>10|i<<6)&7939,this.r[3]=(i>>>7|s<<9)&8191,this.r[4]=(s>>>4|o<<12)&255,this.r[5]=o>>>1&8190,this.r[6]=(o>>>14|a<<2)&8191,this.r[7]=(a>>>11|c<<5)&8065,this.r[8]=(c>>>8|l<<8)&8191,this.r[9]=l>>>5&127;for(let u=0;u<8;u++)this.pad[u]=Pt(e,16+2*u)}process(e,t,n=!1){const i=n?0:2048,{h:s,r:o}=this,a=o[0],c=o[1],l=o[2],u=o[3],d=o[4],h=o[5],f=o[6],y=o[7],m=o[8],p=o[9],b=Pt(e,t+0),A=Pt(e,t+2),v=Pt(e,t+4),C=Pt(e,t+6),T=Pt(e,t+8),R=Pt(e,t+10),L=Pt(e,t+12),N=Pt(e,t+14);let E=s[0]+(b&8191),O=s[1]+((b>>>13|A<<3)&8191),V=s[2]+((A>>>10|v<<6)&8191),$=s[3]+((v>>>7|C<<9)&8191),I=s[4]+((C>>>4|T<<12)&8191),k=s[5]+(T>>>1&8191),S=s[6]+((T>>>14|R<<2)&8191),B=s[7]+((R>>>11|L<<5)&8191),U=s[8]+((L>>>8|N<<8)&8191),q=s[9]+(N>>>5|i),M=0,K=M+E*a+O*(5*p)+V*(5*m)+$*(5*y)+I*(5*f);M=K>>>13,K&=8191,K+=k*(5*h)+S*(5*d)+B*(5*u)+U*(5*l)+q*(5*c),M+=K>>>13,K&=8191;let Q=M+E*c+O*a+V*(5*p)+$*(5*m)+I*(5*y);M=Q>>>13,Q&=8191,Q+=k*(5*f)+S*(5*h)+B*(5*d)+U*(5*u)+q*(5*l),M+=Q>>>13,Q&=8191;let re=M+E*l+O*c+V*a+$*(5*p)+I*(5*m);M=re>>>13,re&=8191,re+=k*(5*y)+S*(5*f)+B*(5*h)+U*(5*d)+q*(5*u),M+=re>>>13,re&=8191;let X=M+E*u+O*l+V*c+$*a+I*(5*p);M=X>>>13,X&=8191,X+=k*(5*m)+S*(5*y)+B*(5*f)+U*(5*h)+q*(5*d),M+=X>>>13,X&=8191;let Se=M+E*d+O*u+V*l+$*c+I*a;M=Se>>>13,Se&=8191,Se+=k*(5*p)+S*(5*m)+B*(5*y)+U*(5*f)+q*(5*h),M+=Se>>>13,Se&=8191;let ve=M+E*h+O*d+V*u+$*l+I*c;M=ve>>>13,ve&=8191,ve+=k*a+S*(5*p)+B*(5*m)+U*(5*y)+q*(5*f),M+=ve>>>13,ve&=8191;let fe=M+E*f+O*h+V*d+$*u+I*l;M=fe>>>13,fe&=8191,fe+=k*c+S*a+B*(5*p)+U*(5*m)+q*(5*y),M+=fe>>>13,fe&=8191;let Fe=M+E*y+O*f+V*h+$*d+I*u;M=Fe>>>13,Fe&=8191,Fe+=k*l+S*c+B*a+U*(5*p)+q*(5*m),M+=Fe>>>13,Fe&=8191;let ot=M+E*m+O*y+V*f+$*h+I*d;M=ot>>>13,ot&=8191,ot+=k*u+S*l+B*c+U*a+q*(5*p),M+=ot>>>13,ot&=8191;let De=M+E*p+O*m+V*y+$*f+I*h;M=De>>>13,De&=8191,De+=k*d+S*u+B*l+U*c+q*a,M+=De>>>13,De&=8191,M=(M<<2)+M|0,M=M+K|0,K=M&8191,M=M>>>13,Q+=M,s[0]=K,s[1]=Q,s[2]=re,s[3]=X,s[4]=Se,s[5]=ve,s[6]=fe,s[7]=Fe,s[8]=ot,s[9]=De}finalize(){const{h:e,pad:t}=this,n=new Uint16Array(10);let i=e[1]>>>13;e[1]&=8191;for(let a=2;a<10;a++)e[a]+=i,i=e[a]>>>13,e[a]&=8191;e[0]+=i*5,i=e[0]>>>13,e[0]&=8191,e[1]+=i,i=e[1]>>>13,e[1]&=8191,e[2]+=i,n[0]=e[0]+5,i=n[0]>>>13,n[0]&=8191;for(let a=1;a<10;a++)n[a]=e[a]+i,i=n[a]>>>13,n[a]&=8191;n[9]-=8192;let s=(i^1)-1;for(let a=0;a<10;a++)n[a]&=s;s=~s;for(let a=0;a<10;a++)e[a]=e[a]&s|n[a];e[0]=(e[0]|e[1]<<13)&65535,e[1]=(e[1]>>>3|e[2]<<10)&65535,e[2]=(e[2]>>>6|e[3]<<7)&65535,e[3]=(e[3]>>>9|e[4]<<4)&65535,e[4]=(e[4]>>>12|e[5]<<1|e[6]<<14)&65535,e[5]=(e[6]>>>2|e[7]<<11)&65535,e[6]=(e[7]>>>5|e[8]<<8)&65535,e[7]=(e[8]>>>8|e[9]<<5)&65535;let o=e[0]+t[0];e[0]=o&65535;for(let a=1;a<8;a++)o=(e[a]+t[a]|0)+(o>>>16)|0,e[a]=o&65535;Ho(n)}update(e){Ey(this),tr(e),e=Ld(e);const{buffer:t,blockLen:n}=this,i=e.length;for(let s=0;s<i;){const o=Math.min(n-this.pos,i-s);if(o===n){for(;n<=i-s;s+=n)this.process(e,s);continue}t.set(e.subarray(s,s+o),this.pos),this.pos+=o,s+=o,this.pos===n&&(this.process(t,0,!1),this.pos=0)}return this}destroy(){Ho(this.h,this.r,this.buffer,this.pad)}digestInto(e){Ey(this),vM(e,this),this.finished=!0;const{buffer:t,h:n}=this;let{pos:i}=this;if(i){for(t[i++]=1;i<16;i++)t[i]=0;this.process(t,0,!0)}this.finalize();let s=0;for(let o=0;o<8;o++)e[s++]=n[o]>>>0,e[s++]=n[o]>>>8;return e}digest(){const{buffer:e,outputLen:t}=this;this.digestInto(e);const n=e.slice(0,t);return this.destroy(),n}}function OM(r){const e=(n,i)=>r(i).update(n).digest(),t=r(new Uint8Array(32));return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=n=>r(n),e}const MM=OM(r=>new LM(r));function $M(r,e,t,n,i,s=20){let o=r[0],a=r[1],c=r[2],l=r[3],u=e[0],d=e[1],h=e[2],f=e[3],y=e[4],m=e[5],p=e[6],b=e[7],A=i,v=t[0],C=t[1],T=t[2],R=o,L=a,N=c,E=l,O=u,V=d,$=h,I=f,k=y,S=m,B=p,U=b,q=A,M=v,K=C,Q=T;for(let X=0;X<s;X+=2)R=R+O|0,q=Me(q^R,16),k=k+q|0,O=Me(O^k,12),R=R+O|0,q=Me(q^R,8),k=k+q|0,O=Me(O^k,7),L=L+V|0,M=Me(M^L,16),S=S+M|0,V=Me(V^S,12),L=L+V|0,M=Me(M^L,8),S=S+M|0,V=Me(V^S,7),N=N+$|0,K=Me(K^N,16),B=B+K|0,$=Me($^B,12),N=N+$|0,K=Me(K^N,8),B=B+K|0,$=Me($^B,7),E=E+I|0,Q=Me(Q^E,16),U=U+Q|0,I=Me(I^U,12),E=E+I|0,Q=Me(Q^E,8),U=U+Q|0,I=Me(I^U,7),R=R+V|0,Q=Me(Q^R,16),B=B+Q|0,V=Me(V^B,12),R=R+V|0,Q=Me(Q^R,8),B=B+Q|0,V=Me(V^B,7),L=L+$|0,q=Me(q^L,16),U=U+q|0,$=Me($^U,12),L=L+$|0,q=Me(q^L,8),U=U+q|0,$=Me($^U,7),N=N+I|0,M=Me(M^N,16),k=k+M|0,I=Me(I^k,12),N=N+I|0,M=Me(M^N,8),k=k+M|0,I=Me(I^k,7),E=E+O|0,K=Me(K^E,16),S=S+K|0,O=Me(O^S,12),E=E+O|0,K=Me(K^E,8),S=S+K|0,O=Me(O^S,7);let re=0;n[re++]=o+R|0,n[re++]=a+L|0,n[re++]=c+N|0,n[re++]=l+E|0,n[re++]=u+O|0,n[re++]=d+V|0,n[re++]=h+$|0,n[re++]=f+I|0,n[re++]=y+k|0,n[re++]=m+S|0,n[re++]=p+B|0,n[re++]=b+U|0,n[re++]=A+q|0,n[re++]=v+M|0,n[re++]=C+K|0,n[re++]=T+Q|0}const UM=BM($M,{counterRight:!1,counterLength:4,allowShortKeys:!1}),FM=new Uint8Array(16),Ay=(r,e)=>{r.update(e);const t=e.length%16;t&&r.update(FM.subarray(t))},VM=new Uint8Array(32);function ky(r,e,t,n,i){i!==void 0&&tr(i,void 0,"AAD");const s=r(e,t,VM),o=CM(n.length,i?i.length:0,!0),a=MM.create(s);i&&Ay(a,i),Ay(a,n),a.update(o);const c=a.digest();return Ho(s,o),c}const zM=r=>(e,t,n)=>({encrypt(s,o){const a=s.length;o=Sy(a+16,o,!1),o.set(s);const c=o.subarray(0,-16);r(e,t,c,c,1);const l=ky(r,e,t,c,n);return o.set(l,a),Ho(l),o},decrypt(s,o){o=Sy(s.length-16,o,!1);const a=s.subarray(0,-16),c=s.subarray(-16),l=ky(r,e,t,a,n);if(!AM(c,l))throw new Error("invalid tag");return o.set(s.subarray(0,-16)),r(e,t,o,o,1),Ho(l),o}}),Cy=kM({blockSize:64,nonceLength:12,tagLength:16},zM(UM));function HM(r,e,t){return yl(r),t===void 0&&(t=new Uint8Array(r.outputLen)),vl(r,t,e)}const Y1=Uint8Array.of(0),Iy=Uint8Array.of();function qM(r,e,t,n=32){yl(r),Jr(n,"length");const i=r.outputLen;if(n>255*i)throw new Error("Length must be <= 255*HashLen");const s=Math.ceil(n/i);t===void 0?t=Iy:_e(t,void 0,"info");const o=new Uint8Array(s*i),a=vl.create(r,e),c=a._cloneInto(),l=new Uint8Array(a.outputLen);for(let u=0;u<s;u++)Y1[0]=u+1,c.update(u===0?Iy:l).update(t).update(Y1).digestInto(l),o.set(l,i*u),a._cloneInto(c);return a.destroy(),c.destroy(),In(l,Y1),o.slice(0,n)}const KM={hashSHA256(r){return Ti(r.subarray())},getHKDF(r,e){const t=HM(Ti,e,r),i=qM(Ti,t,void 0,96),s=i.subarray(0,32),o=i.subarray(32,64),a=i.subarray(64,96);return[s,o,a]},generateX25519KeyPair(){const r=tu.utils.randomSecretKey();return{publicKey:tu.getPublicKey(r),privateKey:r}},generateX25519KeyPairFromSeed(r){return{publicKey:tu.getPublicKey(r),privateKey:r}},generateX25519SharedKey(r,e){return tu.getSharedSecret(r.subarray(),e.subarray())},chaCha20Poly1305Encrypt(r,e,t,n){return Cy(n,e,t).encrypt(r.subarray())},chaCha20Poly1305Decrypt(r,e,t,n,i){return Cy(n,e,t).decrypt(r.subarray(),i)}},WM=KM;function jM(r){return{generateKeypair:r.generateX25519KeyPair,dh:(e,t)=>r.generateX25519SharedKey(e.privateKey,t).subarray(0,32),encrypt:r.chaCha20Poly1305Encrypt,decrypt:r.chaCha20Poly1305Decrypt,hash:r.hashSHA256,hkdf:r.getHKDF}}const Od=r=>{const e=Ar(2);return e[0]=r>>8,e[1]=r,e};Od.bytes=2;const Md=r=>{if(r.length<2)throw RangeError("Could not decode int16BE");if(r instanceof Uint8Array){let e=0;return e+=r[0]<<8,e+=r[1],e}return r.getUint16(0)};Md.bytes=2;function GM(r){return{xxHandshakeSuccesses:r.registerCounter("libp2p_noise_xxhandshake_successes_total",{help:"Total count of noise xxHandshakes successes_"}),xxHandshakeErrors:r.registerCounter("libp2p_noise_xxhandshake_error_total",{help:"Total count of noise xxHandshakes errors"}),encryptedPackets:r.registerCounter("libp2p_noise_encrypted_packets_total",{help:"Total count of noise encrypted packets successfully"}),decryptedPackets:r.registerCounter("libp2p_noise_decrypted_packets_total",{help:"Total count of noise decrypted packets"}),decryptErrors:r.registerCounter("libp2p_noise_decrypt_errors_total",{help:"Total count of noise decrypt errors"})}}function Hb(r,e){!e.enabled||!Rl||(r?(e(`LOCAL_STATIC_PUBLIC_KEY ${Y(r.publicKey,"hex")}`),e(`LOCAL_STATIC_PRIVATE_KEY ${Y(r.privateKey,"hex")}`)):e("Missing local static keys."))}function qb(r,e){!e.enabled||!Rl||(r?(e(`LOCAL_PUBLIC_EPHEMERAL_KEY ${Y(r.publicKey,"hex")}`),e(`LOCAL_PRIVATE_EPHEMERAL_KEY ${Y(r.privateKey,"hex")}`)):e("Missing local ephemeral keys."))}function YM(r,e){!e.enabled||!Rl||e(r?`REMOTE_STATIC_PUBLIC_KEY ${Y(r.subarray(),"hex")}`:"Missing remote static public key.")}function Kb(r,e){!e.enabled||!Rl||e(r?`REMOTE_EPHEMERAL_PUBLIC_KEY ${Y(r.subarray(),"hex")}`:"Missing remote ephemeral keys.")}function Wb(r,e,t){!t.enabled||!Rl||(t(`CIPHER_STATE_1 ${r.n.getUint64()} ${r.k&&Y(r.k,"hex")}`),t(`CIPHER_STATE_2 ${e.n.getUint64()} ${e.k&&Y(e.k,"hex")}`))}function qo(r,e){if(r.length!==e.length)throw new Error("Inputs should have the same length");const t=Ar(r.length);for(let n=0;n<r.length;n++)t[n]=r[n]^e[n];return t}class Ec extends Error{code;constructor(e="Invalid crypto exchange"){super(e),this.code=Ec.code}static code="ERR_INVALID_CRYPTO_EXCHANGE"}const QM=0,XM=4294967295,ZM="Cipherstate has reached maximum n, a new handshake must be performed";class JM{n;bytes;view;constructor(e=QM){this.n=e,this.bytes=Re(12),this.view=new DataView(this.bytes.buffer,this.bytes.byteOffset,this.bytes.byteLength),this.view.setUint32(4,e,!0)}increment(){this.n++,this.view.setUint32(4,this.n,!0)}getBytes(){return this.bytes}getUint64(){return this.n}assertValue(){if(this.n>XM)throw new Error(ZM)}}const Co=Re(0);class Su{k;n;crypto;constructor(e,t=void 0,n=0){this.crypto=e,this.k=t,this.n=new JM(n)}hasKey(){return!!this.k}encryptWithAd(e,t){if(!this.hasKey())return t;this.n.assertValue();const n=this.crypto.encrypt(t,this.n.getBytes(),e,this.k);return this.n.increment(),n}decryptWithAd(e,t,n){if(!this.hasKey())return t;this.n.assertValue();const i=this.crypto.decrypt(t,this.n.getBytes(),e,this.k,n);return this.n.increment(),i}}class e${cs;ck;h;crypto;constructor(e,t){this.crypto=e;const n=W(t,"utf-8");this.h=r$(e,n),this.ck=this.h,this.cs=new Su(e)}mixKey(e){const[t,n]=this.crypto.hkdf(this.ck,e);this.ck=t,this.cs=new Su(this.crypto,n)}mixHash(e){this.h=this.crypto.hash(new me(this.h,e))}encryptAndHash(e){const t=this.cs.encryptWithAd(this.h,e);return this.mixHash(t),t}decryptAndHash(e){const t=this.cs.decryptWithAd(this.h,e);return this.mixHash(e),t}split(){const[e,t]=this.crypto.hkdf(this.ck,Co);return[new Su(this.crypto,e),new Su(this.crypto,t)]}}class t${ss;s;e;rs;re;initiator;crypto;constructor(e){const{crypto:t,protocolName:n,prologue:i,initiator:s,s:o,e:a,rs:c,re:l}=e;this.crypto=t,this.ss=new e$(t,n),this.ss.mixHash(i),this.initiator=s,this.s=o,this.e=a,this.rs=c,this.re=l}writeE(){if(this.e)throw new Error("ephemeral keypair is already set");const e=this.crypto.generateKeypair();return this.ss.mixHash(e.publicKey),this.e=e,e.publicKey}writeS(){if(!this.s)throw new Error("static keypair is not set");return this.ss.encryptAndHash(this.s.publicKey)}writeEE(){if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.re))}writeES(){if(this.initiator){if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.rs)throw new Error("remote static public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.rs))}else{if(!this.s)throw new Error("static keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.s,this.re))}}writeSE(){if(this.initiator){if(!this.s)throw new Error("static keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.s,this.re))}else{if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.rs)throw new Error("remote static public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.rs))}}readE(e,t=0){if(this.re)throw new Error("remote ephemeral public key is already set");if(e.byteLength<t+32)throw new Error("message is not long enough");this.re=e.sublist(t,t+32),this.ss.mixHash(this.re)}readS(e,t=0){if(this.rs)throw new Error("remote static public key is already set");const n=32+(this.ss.cs.hasKey()?16:0);if(e.byteLength<t+n)throw new Error("message is not long enough");const i=e.sublist(t,t+n);return this.rs=this.ss.decryptAndHash(i),n}readEE(){this.writeEE()}readES(){this.writeES()}readSE(){this.writeSE()}}class jb extends t${writeMessageA(e){return new me(this.writeE(),this.ss.encryptAndHash(e))}writeMessageB(e){const t=this.writeE();this.writeEE();const n=this.writeS();return this.writeES(),new me(t,n,this.ss.encryptAndHash(e))}writeMessageC(e){const t=this.writeS();return this.writeSE(),new me(t,this.ss.encryptAndHash(e))}readMessageA(e){try{return this.readE(e),this.ss.decryptAndHash(e.sublist(32))}catch(t){throw new Ec(`handshake stage 0 validation fail: ${t.message}`)}}readMessageB(e){try{this.readE(e),this.readEE();const t=this.readS(e,32);return this.readES(),this.ss.decryptAndHash(e.sublist(32+t))}catch(t){throw new Ec(`handshake stage 1 validation fail: ${t.message}`)}}readMessageC(e){try{const t=this.readS(e);return this.readSE(),this.ss.decryptAndHash(e.sublist(t))}catch(t){throw new Ec(`handshake stage 2 validation fail: ${t.message}`)}}}function r$(r,e){if(e.length<=32){const t=Re(32);return t.set(e),t}else return r.hash(e)}var $d;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,i={})=>{if(i.lengthDelimited!==!1&&n.fork(),t.webtransportCerthashes!=null)for(const s of t.webtransportCerthashes)n.uint32(10),n.bytes(s);if(t.streamMuxers!=null)for(const s of t.streamMuxers)n.uint32(18),n.string(s);i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{const s={webtransportCerthashes:[],streamMuxers:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{if(i.limits?.webtransportCerthashes!=null&&s.webtransportCerthashes.length===i.limits.webtransportCerthashes)throw new Mt('Decode error - map field "webtransportCerthashes" had too many elements');s.webtransportCerthashes.push(t.bytes());break}case 2:{if(i.limits?.streamMuxers!=null&&s.streamMuxers.length===i.limits.streamMuxers)throw new Mt('Decode error - map field "streamMuxers" had too many elements');s.streamMuxers.push(t.string());break}default:{t.skipType(a&7);break}}}return s})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ae(t,r.codec(),n)})($d||($d={}));var Ud;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.identityKey!=null&&t.identityKey.byteLength>0&&(n.uint32(10),n.bytes(t.identityKey)),t.identitySig!=null&&t.identitySig.byteLength>0&&(n.uint32(18),n.bytes(t.identitySig)),t.extensions!=null&&(n.uint32(34),$d.codec().encode(t.extensions,n)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{const s={identityKey:Re(0),identitySig:Re(0)},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.identityKey=t.bytes();break}case 2:{s.identitySig=t.bytes();break}case 4:{s.extensions=$d.codec().decode(t,t.uint32(),{limits:i.limits?.extensions});break}default:{t.skipType(a&7);break}}}return s})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ae(t,r.codec(),n)})(Ud||(Ud={}));async function Gb(r,e,t){const n=await r.sign(Qb(e));return Ud.encode({identityKey:En(r.publicKey),identitySig:n,extensions:t})}async function Yb(r,e,t){try{const n=Ud.decode(r),i=on(n.identityKey);if(t?.equals(i)===!1)throw new Error(`Payload identity key ${i} does not match expected remote identity key ${t}`);if(!e)throw new Error("Remote static does not exist");const s=Qb(e);if(!await i.verify(s,n.identitySig))throw new Error("Invalid payload signature");return n}catch(n){throw new wS(n.message)}}function Qb(r){const e=W("noise-libp2p-static-key:");return r instanceof Uint8Array?Ot([e,r],e.length+r.length):(r.prepend(e),r)}class n$ extends fg{stream;handshake;metrics;decoder;constructor(e,t,n){super({log:e.log,inactivityTimeout:e.inactivityTimeout,maxReadBufferLength:e.maxReadBufferLength,direction:e.direction}),this.stream=e,this.handshake=t,this.metrics=n,this.decoder=new bT({lengthDecoder:Md,maxBufferSize:16*1024*1024,encodingLength:()=>2});const i=c=>{try{for(const l of this.decoder.decode(c.data))this.onData(this.decrypt(l))}catch(l){this.abort(l)}};this.stream.addEventListener("message",i);const s=c=>{c.error!=null?c.local===!0?this.abort(c.error):this.onRemoteReset():this.onTransportClosed()};this.stream.addEventListener("close",s);const o=()=>{this.safeDispatchEvent("drain")};this.stream.addEventListener("drain",o);const a=()=>{this.onRemoteCloseWrite()};this.stream.addEventListener("remoteCloseWrite",a)}encrypt(e){const t=new me;for(let n=0;n<e.byteLength;n+=by){let i=n+by;i>e.byteLength&&(i=e.byteLength);let s;e instanceof Uint8Array?s=this.handshake.encrypt(e.subarray(n,i)):s=this.handshake.encrypt(e.sublist(n,i)),this.metrics?.encryptedPackets.increment(),t.append(Od(s.byteLength)),t.append(s)}return t}decrypt(e){const t=new me;for(let n=0;n<e.byteLength;n+=el){let i=n+el;if(i>e.byteLength&&(i=e.byteLength),i-vy<n)throw new Error("Invalid chunk");let s;e instanceof Uint8Array?s=e.subarray(n,i):s=e.sublist(n,i);const o=e.subarray(n,i-vy);try{const a=this.handshake.decrypt(s,o);this.metrics?.decryptedPackets.increment(),t.append(a)}catch(a){throw this.metrics?.decryptErrors.increment(),a}}return t}close(e){return this.stream.close(e)}sendPause(){this.stream.pause()}sendResume(){this.stream.resume()}sendReset(e){this.stream.abort(e)}sendData(e){return{sentBytes:e.byteLength,canSendMore:this.stream.send(this.encrypt(e))}}}function _y(r,e,t){return new n$(r,e,t)}async function i$(r,e){const{log:t,connection:n,crypto:i,privateKey:s,prologue:o,s:a,remoteIdentityKey:c,extensions:l}=r,u=await Gb(s,a.publicKey,l),d=new jb({crypto:i,protocolName:"Noise_XX_25519_ChaChaPoly_SHA256",initiator:!0,prologue:o,s:a});Hb(d.s,t),t.trace("Stage 0 - Initiator starting to send first message."),await n.write(d.writeMessageA(Co),e),t.trace("Stage 0 - Initiator finished sending first message."),qb(d.e,t),t.trace("Stage 1 - Initiator waiting to receive first message from responder...");const h=d.readMessageB(await n.read(e));t.trace("Stage 1 - Initiator received the message."),Kb(d.re,t),YM(d.rs,t),t.trace("Initiator going to check remote's signature...");const f=await Yb(h,d.rs,c);t.trace("All good with the signature!"),t.trace("Stage 2 - Initiator sending third handshake message."),await n.write(d.writeMessageC(u),e),t.trace("Stage 2 - Initiator sent message with signed payload.");const[y,m]=d.ss.split();return Wb(y,m,t),{payload:f,encrypt:p=>y.encryptWithAd(Co,p),decrypt:(p,b)=>m.decryptWithAd(Co,p,b)}}async function s$(r,e){const{log:t,connection:n,crypto:i,privateKey:s,prologue:o,s:a,remoteIdentityKey:c,extensions:l}=r,u=await Gb(s,a.publicKey,l),d=new jb({crypto:i,protocolName:"Noise_XX_25519_ChaChaPoly_SHA256",initiator:!1,prologue:o,s:a});Hb(d.s,t),t.trace("Stage 0 - Responder waiting to receive first message."),d.readMessageA(await n.read(e)),t.trace("Stage 0 - Responder received first message."),Kb(d.re,t),t.trace("Stage 1 - Responder sending out first message with signed payload and static key."),await n.write(d.writeMessageB(u),e),t.trace("Stage 1 - Responder sent the second handshake message with signed payload."),qb(d.e,t),t.trace("Stage 2 - Responder waiting for third handshake message...");const h=d.readMessageC(await n.read(e));t.trace("Stage 2 - Responder received the message, finished handshake.");const f=await Yb(h,d.rs,c),[y,m]=d.ss.split();return Wb(y,m,t),{payload:f,encrypt:p=>m.encryptWithAd(Co,p),decrypt:(p,b)=>y.decryptWithAd(Co,p,b)}}class o${protocol="/noise";crypto;prologue;staticKey;extensions;metrics;components;log;constructor(e,t={}){const{staticNoiseKey:n,extensions:i,crypto:s,prologueBytes:o}=t,{metrics:a}=e;this.components=e,this.log=e.logger.forComponent("libp2p:noise");const c=s??WM;this.crypto=jM(c),this.extensions={webtransportCerthashes:[],...i},this.metrics=a?GM(a):void 0,n?this.staticKey=c.generateX25519KeyPairFromSeed(n):this.staticKey=c.generateX25519KeyPair(),this.prologue=o??Re(0)}[Symbol.toStringTag]="@chainsafe/libp2p-noise";[It]=["@libp2p/connection-encryption","@chainsafe/libp2p-noise"];async secureOutbound(e,t){const n=e.log?.newScope("noise")??this.log,i=qc(e,{lengthEncoder:Od,lengthDecoder:Md,maxDataLength:el}),s=await this.performHandshakeInitiator(i,this.components.privateKey,n,t?.remotePeer?.publicKey,t),o=on(s.payload.identityKey);return{connection:_y(i.unwrap(),s,this.metrics),remoteExtensions:s.payload.extensions,remotePeer:Fo(o),streamMuxer:t?.skipStreamMuxerNegotiation===!0?void 0:this.getStreamMuxer(s.payload.extensions?.streamMuxers)}}getStreamMuxer(e){if(e==null||e.length===0)return;const t=this.components.upgrader.getStreamMuxers();if(t!=null)for(const n of e){const i=t.get(n);if(i!=null)return i}if(e.length)throw new bS("Early muxer negotiation was requested but the initiator and responder had no common muxers")}async secureInbound(e,t){const n=e.log?.newScope("noise")??this.log,i=qc(e,{lengthEncoder:Od,lengthDecoder:Md,maxDataLength:el}),s=await this.performHandshakeResponder(i,this.components.privateKey,n,t?.remotePeer?.publicKey,t),o=on(s.payload.identityKey);return{connection:_y(i.unwrap(),s,this.metrics),remoteExtensions:s.payload.extensions,remotePeer:Fo(o),streamMuxer:t?.skipStreamMuxerNegotiation===!0?void 0:this.getStreamMuxer(s.payload.extensions?.streamMuxers)}}async performHandshakeInitiator(e,t,n,i,s){let o;const a=s?.skipStreamMuxerNegotiation===!0?[]:[...this.components.upgrader.getStreamMuxers().keys()];try{o=await i$({connection:e,privateKey:t,remoteIdentityKey:i,log:n.newScope("xxhandshake"),crypto:this.crypto,prologue:this.prologue,s:this.staticKey,extensions:{streamMuxers:a,webtransportCerthashes:[],...this.extensions}},s),this.metrics?.xxHandshakeSuccesses.increment()}catch(c){throw this.metrics?.xxHandshakeErrors.increment(),c}return o}async performHandshakeResponder(e,t,n,i,s){let o;const a=s?.skipStreamMuxerNegotiation===!0?[]:[...this.components.upgrader.getStreamMuxers().keys()];try{o=await s$({connection:e,privateKey:t,remoteIdentityKey:i,log:n.newScope("xxhandshake"),crypto:this.crypto,prologue:this.prologue,s:this.staticKey,extensions:{streamMuxers:a,webtransportCerthashes:[],...this.extensions}},s),this.metrics?.xxHandshakeSuccesses.increment()}catch(c){throw this.metrics?.xxHandshakeErrors.increment(),c}return o}}function d3(r={}){return e=>new o$(e,r)}var mt;(function(r){r[r.Data=0]="Data",r[r.WindowUpdate=1]="WindowUpdate",r[r.Ping=2]="Ping",r[r.GoAway=3]="GoAway"})(mt||(mt={}));var Ve;(function(r){r[r.SYN=1]="SYN",r[r.ACK=2]="ACK",r[r.FIN=4]="FIN",r[r.RST=8]="RST"})(Ve||(Ve={}));Object.values(Ve).filter(r=>typeof r!="string");const a$=0;var br;(function(r){r[r.NormalTermination=0]="NormalTermination",r[r.ProtocolError=1]="ProtocolError",r[r.InternalError=2]="InternalError"})(br||(br={}));const ls=12;class Af extends Error{static name="ProtocolError";reason;constructor(e,t){super(e),this.name="ProtocolError",this.reason=t}}function c$(r){return r?.reason!==null}class mo extends Af{static name="InvalidFrameError";constructor(e="The frame was invalid"){super(e,br.ProtocolError),this.name="InvalidFrameError"}}class l$ extends Af{static name="UnRequestedPingError";constructor(e="Un-requested ping error"){super(e,br.ProtocolError),this.name="UnRequestedPingError"}}class u$ extends Af{static name="NotMatchingPingError";constructor(e="Not matching ping error"){super(e,br.ProtocolError),this.name="NotMatchingPingError"}}class d$ extends Af{static name="ReceiveWindowExceededError";constructor(e="Receive window exceeded"){super(e,br.ProtocolError),this.name="ReceiveWindowExceededError"}}const Xb=256*1024,h$=16*1024*1024,xu={enableKeepAlive:!0,keepAliveInterval:3e4,maxInboundStreams:1e3,maxOutboundStreams:1e3};function f$(r){if(r.keepAliveInterval!=null&&r.keepAliveInterval<=0)throw new H("keep-alive interval must be positive");if(r.maxInboundStreams!=null&&r.maxInboundStreams<0)throw new H("max inbound streams must be larger or equal 0");if(r.maxOutboundStreams!=null&&r.maxOutboundStreams<0)throw new H("max outbound streams must be larger or equal 0");if(r.maxMessageSize!=null&&r.maxMessageSize<1024)throw new H("MaxMessageSize must be greater than a kilobyte");if(r.streamOptions?.initialStreamWindowSize!=null&&r.streamOptions?.initialStreamWindowSize<Xb)throw new H("InitialStreamWindowSize must be larger or equal 256 kB");if(r.streamOptions?.maxStreamWindowSize!=null&&r.streamOptions?.initialStreamWindowSize!=null&&r.streamOptions?.maxStreamWindowSize<r.streamOptions?.initialStreamWindowSize)throw new H("MaxStreamWindowSize must be larger than the InitialStreamWindowSize");if(r.streamOptions?.maxStreamWindowSize!=null&&r.streamOptions?.maxStreamWindowSize>2**32-1)throw new H("MaxStreamWindowSize must be less than equal MAX_UINT32")}function p$(r){return r.header.type===mt.Data&&r.data!==null}const Ty=2**24;function g$(r){if(r[0]!==a$)throw new mo("Invalid frame version");return{type:r[1],flag:(r[2]<<8)+r[3],streamID:r[4]*Ty+(r[5]<<16)+(r[6]<<8)+r[7],length:r[8]*Ty+(r[9]<<16)+(r[10]<<8)+r[11]}}let m$=class{buffer;constructor(){this.buffer=new me}*emitFrames(e){for(this.buffer.append(e);;){const t=this.readFrame();if(t===void 0)break;yield t}}readFrame(){let e=ls;if(this.buffer.byteLength<ls)return;const t=g$(this.buffer.subarray(0,ls));if(t.type===mt.Data){if(e+=t.length,this.buffer.byteLength<e)return;const n=this.buffer.sublist(ls,e);return this.buffer.consume(e),{header:t,data:n}}return this.buffer.consume(e),{header:t}}};function Py(r){const e=new Uint8Array(ls);return e[1]=r.type,e[2]=r.flag>>>8,e[3]=r.flag,e[4]=r.streamID>>>24,e[5]=r.streamID>>>16,e[6]=r.streamID>>>8,e[7]=r.streamID,e[8]=r.length>>>24,e[9]=r.length>>>16,e[10]=r.length>>>8,e[11]=r.length,e}var dr;(function(r){r[r.Init=0]="Init",r[r.SYNSent=1]="SYNSent",r[r.SYNReceived=2]="SYNReceived",r[r.Established=3]="Established",r[r.Finished=4]="Finished",r[r.Paused=5]="Paused"})(dr||(dr={}));class y$ extends mg{streamId;state;sendWindowCapacity;recvWindow;recvWindowCapacity;maxStreamWindowSize;epochStart;getRTT;sendFrame;constructor(e){const t=e.initialStreamWindowSize??Xb;super({...e,maxMessageSize:t-ls}),this.streamId=e.streamId,this.state=e.state,this.sendWindowCapacity=t,this.recvWindow=t,this.recvWindowCapacity=this.recvWindow,this.maxStreamWindowSize=e.maxStreamWindowSize??h$,this.epochStart=Date.now(),this.getRTT=e.getRTT,this.sendFrame=e.sendFrame;const n=()=>{this.state=dr.Finished};this.addEventListener("close",n)}sendData(e){const t=e.byteLength;let n=0,i=!0;for(this.log?.trace("send window capacity is %d bytes",this.sendWindowCapacity);e.byteLength>0;){if(this.sendWindowCapacity===0){i=!1,this.log?.trace("sent %d/%d bytes, exhausted send window, waiting for window update",n,t);break}const s=Math.min(this.sendWindowCapacity,e.byteLength),o=this.getSendFlags(),a=e.sublist(0,s);e.consume(s);const c=this.sendFrame({type:mt.Data,flag:o,streamID:this.streamId,length:s},a);if(this.sendWindowCapacity-=s,n+=s,!c){i=c,this.log.trace("sent %d/%d bytes, wait for muxer to have more send capacity",n,t);break}}return{sentBytes:n,canSendMore:i}}sendReset(){this.sendFrame({type:mt.WindowUpdate,flag:Ve.RST,streamID:this.streamId,length:0})}async sendCloseWrite(){const e=this.getSendFlags()|Ve.FIN;this.sendFrame({type:mt.WindowUpdate,flag:e,streamID:this.streamId,length:0})}async sendCloseRead(e){e?.signal?.throwIfAborted()}sendPause(){this.state=dr.Paused}sendResume(){this.state=dr.Established,this.sendWindowUpdate()}handleWindowUpdate(e){this.processFlags(e.header.flag),this.sendWindowCapacity+=e.header.length,this.maxMessageSize=this.sendWindowCapacity-ls,this.maxMessageSize<0&&(this.maxMessageSize=0),this.maxMessageSize!==0&&this.writeBuffer.byteLength>0&&(this.log?.trace("window update of %d bytes allows more data to be sent, have %d bytes queued, sending data %s",e.header.length,this.writeBuffer.byteLength,this.sendingData),this.safeDispatchEvent("drain"))}handleData(e){if(!p$(e))throw new mo("Frame was not data frame");if(this.processFlags(e.header.flag),this.recvWindowCapacity<e.header.length)throw new d$("Receive window exceeded");this.recvWindowCapacity-=e.header.length,this.onData(e.data),this.sendWindowUpdate()}processFlags(e){(e&Ve.ACK)===Ve.ACK&&this.state===dr.SYNSent&&(this.state=dr.Established),(e&Ve.FIN)===Ve.FIN&&this.onRemoteCloseWrite(),(e&Ve.RST)===Ve.RST&&this.onRemoteReset()}getSendFlags(){switch(this.state){case dr.Init:return this.state=dr.SYNSent,Ve.SYN;case dr.SYNReceived:return this.state=dr.Established,Ve.ACK;default:return 0}}sendWindowUpdate(){if(this.state===dr.Paused){this.epochStart=Date.now();return}const e=this.getSendFlags(),t=Date.now(),n=this.getRTT();if(e===0&&n>-1&&t-this.epochStart<=n*4&&(this.recvWindow=Math.min(this.recvWindow*2,this.maxStreamWindowSize)),this.recvWindowCapacity>=this.recvWindow&&e===0)return;const i=this.recvWindow-this.recvWindowCapacity;this.recvWindowCapacity=this.recvWindow,this.epochStart=t,this.sendFrame({type:mt.WindowUpdate,flag:e,streamID:this.streamId,length:i})}}function Ry(r){return{type:mt[r.type],flags:[(r.flag&Ve.SYN)===Ve.SYN?"SYN":void 0,(r.flag&Ve.ACK)===Ve.ACK?"ACK":void 0,(r.flag&Ve.FIN)===Ve.FIN?"FIN":void 0,(r.flag&Ve.RST)===Ve.RST?"RST":void 0].filter(Boolean),streamID:r.streamID,length:r.length}}const Zb="/yamux/1.0.0";class w${protocol=Zb;_init;constructor(e={}){this._init=e}[Symbol.toStringTag]="@chainsafe/libp2p-yamux";[It]=["@libp2p/stream-multiplexing"];createStreamMuxer(e){return new b$(e,{...this._init})}}class b$ extends gg{nextStreamID;nextPingID;activePing;rtt;client;localGoAway;remoteGoAway;numInboundStreams;numOutboundStreams;decoder;keepAlive;enableKeepAlive;keepAliveInterval;maxInboundStreams;maxOutboundStreams;constructor(e,t={}){super(e,{...t,protocol:Zb,name:"yamux"}),this.client=e.direction==="outbound",f$(t),this.enableKeepAlive=t.enableKeepAlive??xu.enableKeepAlive,this.keepAliveInterval=t.keepAliveInterval??xu.keepAliveInterval,this.maxInboundStreams=t.maxInboundStreams??xu.maxInboundStreams,this.maxOutboundStreams=t.maxOutboundStreams??xu.maxOutboundStreams,this.decoder=new m$,this.numInboundStreams=0,this.numOutboundStreams=0,this.nextStreamID=this.client?1:2,this.nextPingID=0,this.rtt=-1,this.log.trace("muxer created"),this.enableKeepAlive&&(this.log.trace("muxer keepalive enabled interval=%s",this.keepAliveInterval),this.keepAlive=Mg(async n=>{try{await this.ping(n)}catch(i){this.log.error("ping error: %s",i)}},this.keepAliveInterval,{runImmediately:!0}),this.keepAlive.start())}onData(e){for(const t of this.decoder.emitFrames(e))this.handleFrame(t)}onCreateStream(){if(this.remoteGoAway!==void 0)throw new fo("Muxer closed remotely");if(this.localGoAway!==void 0)throw new fo("Muxer closed locally");const e=this.nextStreamID;if(this.nextStreamID+=2,this.numOutboundStreams>=this.maxOutboundStreams)throw new o8("max outbound streams exceeded");this.log.trace("new outgoing stream id=%s",e);const t=this._newStream(e,dr.Init,"outbound");return this.numOutboundStreams++,queueMicrotask(()=>{t.sendWindowUpdate()}),t}async ping(e){if(this.remoteGoAway!==void 0)throw new fo("Muxer closed remotely");if(this.localGoAway!==void 0)throw new fo("Muxer closed locally");if(this.activePing!=null)return Yt(this.activePing.promise,e?.signal);this.activePing=Object.assign(Promise.withResolvers(),{id:this.nextPingID++,start:Date.now()}),this.sendPing(this.activePing.id);try{this.rtt=await Yt(this.activePing.promise,e?.signal)}finally{this.activePing=void 0}return this.rtt}getRTT(){return this.rtt}async close(e={}){if(this.status==="open")try{const t=e?.reason??br.NormalTermination;this.log.trace("muxer close reason=%s",br[t]),await super.close(e),this.sendGoAway(t)}finally{this.keepAlive?.stop()}}abort(e){if(this.status==="open")try{super.abort(e);let t=br.InternalError;c$(e)&&(t=e.reason),this.log.error("muxer abort reason=%s error=%s",t,e),this.sendGoAway(t)}finally{this.keepAlive?.stop()}}onTransportClosed(){try{super.onTransportClosed()}finally{this.keepAlive?.stop()}}_newStream(e,t,n){if(this.streams.find(s=>s.streamId===e)!=null)throw new H("Stream already exists with that id");const i=new y$({...this.streamOptions,id:`${e}`,streamId:e,state:t,direction:n,sendFrame:this.sendFrame.bind(this),log:this.log.newScope(`${n}:${e}`),getRTT:this.getRTT.bind(this)});return i.addEventListener("close",()=>{this.closeStream(e)},{once:!0}),i}closeStream(e){this.client===(e%2===0)?this.numInboundStreams--:this.numOutboundStreams--}handleFrame(e){const{streamID:t,type:n,length:i}=e.header;if(this.log.trace("received frame %o",Ry(e.header)),t===0)switch(n){case mt.Ping:{this.handlePing(e.header);return}case mt.GoAway:{this.handleGoAway(i);return}default:throw new mo("Invalid frame type")}else switch(e.header.type){case mt.Data:case mt.WindowUpdate:{this.handleStreamMessage(e);return}default:throw new mo("Invalid frame type")}}handlePing(e){if(e.flag===Ve.SYN)this.log.trace("received ping request pingId=%s",e.length),this.sendPing(e.length,Ve.ACK);else if(e.flag===Ve.ACK)this.log.trace("received ping response pingId=%s",e.length),this.handlePingResponse(e.length);else throw new mo("Invalid frame flag")}handlePingResponse(e){if(this.activePing===void 0)throw new l$("ping not requested");if(this.activePing.id!==e)throw new u$("ping doesn't match our id");this.activePing.resolve(Date.now()-this.activePing.start)}handleGoAway(e){this.log.trace("received GoAway reason=%s",br[e]??"unknown"),this.remoteGoAway=e,e===br.NormalTermination?this.onTransportClosed():this.abort(new Error("Remote sent GoAway"))}handleStreamMessage(e){const{streamID:t,flag:n,type:i}=e.header;(n&Ve.SYN)===Ve.SYN&&this.incomingStream(t);const s=this.streams.find(o=>o.streamId===t);if(s===void 0){this.log.trace("frame for missing stream id=%s",t);return}switch(i){case mt.WindowUpdate:{s.handleWindowUpdate(e);return}case mt.Data:{s.handleData(e);return}default:throw new Error("unreachable")}}incomingStream(e){if(this.client!==(e%2===0))throw new H("Both endpoints are clients");if(this.streams.find(n=>n.streamId===e))return;if(this.log.trace("new incoming stream id=%s",e),this.localGoAway!==void 0){this.sendFrame({type:mt.WindowUpdate,flag:Ve.RST,streamID:e,length:0});return}if(this.numInboundStreams>=this.maxInboundStreams){this.log("maxIncomingStreams exceeded, forcing stream reset"),this.sendFrame({type:mt.WindowUpdate,flag:Ve.RST,streamID:e,length:0});return}const t=this._newStream(e,dr.SYNReceived,"inbound");this.numInboundStreams++,this.onRemoteStream(t)}sendFrame(e,t){let n;if(e.type===mt.Data){if(t==null)throw new mo("Invalid frame");n=new me(Py(e),t)}else n=Py(e);return this.log.trace("sending frame %o",Ry(e)),this.send(n)}sendPing(e,t=Ve.SYN){t===Ve.SYN?this.log.trace("sending ping request pingId=%s",e):this.log.trace("sending ping response pingId=%s",e),this.sendFrame({type:mt.Ping,flag:t,streamID:0,length:e})}sendGoAway(e=br.NormalTermination){this.log("sending GoAway reason=%s",br[e]),this.localGoAway=e,this.sendFrame({type:mt.GoAway,flag:0,streamID:0,length:e})}}function Jb(r={}){return()=>new w$(r)}const v$="libp2p",E$="autonat",S$="1.0.0",x$=3e4,A$=2,k$=20,C$=80,I$=8192;var rt;(function(r){(function(i){i.DIAL="DIAL",i.DIAL_RESPONSE="DIAL_RESPONSE"})(r.MessageType||(r.MessageType={}));let e;(function(i){i[i.DIAL=0]="DIAL",i[i.DIAL_RESPONSE=1]="DIAL_RESPONSE"})(e||(e={})),(function(i){i.codec=()=>sr(e)})(r.MessageType||(r.MessageType={})),(function(i){i.OK="OK",i.E_DIAL_ERROR="E_DIAL_ERROR",i.E_DIAL_REFUSED="E_DIAL_REFUSED",i.E_BAD_REQUEST="E_BAD_REQUEST",i.E_INTERNAL_ERROR="E_INTERNAL_ERROR"})(r.ResponseStatus||(r.ResponseStatus={}));let t;(function(i){i[i.OK=0]="OK",i[i.E_DIAL_ERROR=100]="E_DIAL_ERROR",i[i.E_DIAL_REFUSED=101]="E_DIAL_REFUSED",i[i.E_BAD_REQUEST=200]="E_BAD_REQUEST",i[i.E_INTERNAL_ERROR=300]="E_INTERNAL_ERROR"})(t||(t={})),(function(i){i.codec=()=>sr(t)})(r.ResponseStatus||(r.ResponseStatus={})),(function(i){let s;i.codec=()=>(s==null&&(s=Ce((o,a,c={})=>{if(c.lengthDelimited!==!1&&a.fork(),o.id!=null&&(a.uint32(10),a.bytes(o.id)),o.addrs!=null)for(const l of o.addrs)a.uint32(18),a.bytes(l);c.lengthDelimited!==!1&&a.ldelim()},(o,a,c={})=>{const l={addrs:[]},u=a==null?o.len:o.pos+a;for(;o.pos<u;){const d=o.uint32();switch(d>>>3){case 1:{l.id=o.bytes();break}case 2:{if(c.limits?.addrs!=null&&l.addrs.length===c.limits.addrs)throw new Mt('Decode error - map field "addrs" had too many elements');l.addrs.push(o.bytes());break}default:{o.skipType(d&7);break}}}return l})),s),i.encode=o=>ke(o,i.codec()),i.decode=(o,a)=>Ae(o,i.codec(),a)})(r.PeerInfo||(r.PeerInfo={})),(function(i){let s;i.codec=()=>(s==null&&(s=Ce((o,a,c={})=>{c.lengthDelimited!==!1&&a.fork(),o.peer!=null&&(a.uint32(10),r.PeerInfo.codec().encode(o.peer,a)),c.lengthDelimited!==!1&&a.ldelim()},(o,a,c={})=>{const l={},u=a==null?o.len:o.pos+a;for(;o.pos<u;){const d=o.uint32();switch(d>>>3){case 1:{l.peer=r.PeerInfo.codec().decode(o,o.uint32(),{limits:c.limits?.peer});break}default:{o.skipType(d&7);break}}}return l})),s),i.encode=o=>ke(o,i.codec()),i.decode=(o,a)=>Ae(o,i.codec(),a)})(r.Dial||(r.Dial={})),(function(i){let s;i.codec=()=>(s==null&&(s=Ce((o,a,c={})=>{c.lengthDelimited!==!1&&a.fork(),o.status!=null&&(a.uint32(8),r.ResponseStatus.codec().encode(o.status,a)),o.statusText!=null&&(a.uint32(18),a.string(o.statusText)),o.addr!=null&&(a.uint32(26),a.bytes(o.addr)),c.lengthDelimited!==!1&&a.ldelim()},(o,a,c={})=>{const l={},u=a==null?o.len:o.pos+a;for(;o.pos<u;){const d=o.uint32();switch(d>>>3){case 1:{l.status=r.ResponseStatus.codec().decode(o);break}case 2:{l.statusText=o.string();break}case 3:{l.addr=o.bytes();break}default:{o.skipType(d&7);break}}}return l})),s),i.encode=o=>ke(o,i.codec()),i.decode=(o,a)=>Ae(o,i.codec(),a)})(r.DialResponse||(r.DialResponse={}));let n;r.codec=()=>(n==null&&(n=Ce((i,s,o={})=>{o.lengthDelimited!==!1&&s.fork(),i.type!=null&&(s.uint32(8),r.MessageType.codec().encode(i.type,s)),i.dial!=null&&(s.uint32(18),r.Dial.codec().encode(i.dial,s)),i.dialResponse!=null&&(s.uint32(26),r.DialResponse.codec().encode(i.dialResponse,s)),o.lengthDelimited!==!1&&s.ldelim()},(i,s,o={})=>{const a={},c=s==null?i.len:i.pos+s;for(;i.pos<c;){const l=i.uint32();switch(l>>>3){case 1:{a.type=r.MessageType.codec().decode(i);break}case 2:{a.dial=r.Dial.codec().decode(i,i.uint32(),{limits:o.limits?.dial});break}case 3:{a.dialResponse=r.DialResponse.codec().decode(i,i.uint32(),{limits:o.limits?.dialResponse});break}default:{i.skipType(l&7);break}}}return a})),n),r.encode=i=>ke(i,r.codec()),r.decode=(i,s)=>Ae(i,r.codec(),s)})(rt||(rt={}));const _$=4,T$=8;class P${components;protocol;timeout;maxInboundStreams;maxOutboundStreams;maxMessageSize;started;log;topologyId;dialResults;findPeers;addressFilter;connectionThreshold;constructor(e,t){this.components=e,this.log=e.logger.forComponent("libp2p:auto-nat"),this.started=!1,this.protocol=`/${t.protocolPrefix??v$}/${E$}/${S$}`,this.timeout=t.timeout??x$,this.maxInboundStreams=t.maxInboundStreams??A$,this.maxOutboundStreams=t.maxOutboundStreams??k$,this.connectionThreshold=t.connectionThreshold??C$,this.maxMessageSize=t.maxMessageSize??I$,this.dialResults=an({name:"libp2p_autonat_dial_results",metrics:e.metrics}),this.findPeers=Mg(this.findRandomPeers.bind(this),6e4),this.addressFilter=Mi(1024)}[Symbol.toStringTag]="@libp2p/autonat";[It]=["@libp2p/autonat"];get[ws](){return["@libp2p/identify"]}isStarted(){return this.started}async start(){this.started||(await this.components.registrar.handle(this.protocol,(e,t)=>{this.handleIncomingAutonatStream(e,t).catch(n=>{this.log.error("error handling incoming autonat stream - %e",n)})},{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams}),this.topologyId=await this.components.registrar.register(this.protocol,{onConnect:(e,t)=>{this.verifyExternalAddresses(t).catch(n=>{this.log.error("could not verify addresses - %e",n)})}}),this.findPeers.start(),this.started=!0)}async stop(){await this.components.registrar.unhandle(this.protocol),this.topologyId!=null&&await this.components.registrar.unhandle(this.topologyId),this.dialResults.clear(),this.findPeers.stop(),this.started=!1}allAddressesAreVerified(){return this.components.addressManager.getAddressesWithMetadata().every(e=>e.expires>Date.now()?!0:e.verified)}async findRandomPeers(e){if(this.allAddressesAreVerified())return;const t=Ke([AbortSignal.timeout(1e4),e?.signal]);try{this.log("starting random walk to find peers to run AutoNAT");for await(const n of this.components.randomWalk.walk({signal:t})){if(!await this.components.connectionManager.isDialable(n.multiaddrs)){this.log.trace("random peer %p was not dialable %s",n.id,n.multiaddrs.map(i=>i.toString()).join(", "));continue}try{this.log.trace("dial random peer %p",n.id),await this.components.connectionManager.openConnection(n.multiaddrs,{signal:t})}catch{}if(this.allAddressesAreVerified()){this.log("stopping random walk, all addresses are verified");return}if(!this.hasConnectionCapacity()){this.log("stopping random walk, too close to max connections");return}}}catch{}}async handleIncomingAutonatStream(e,t){const n=AbortSignal.timeout(this.timeout);try{const i=Qt(e,{maxDataLength:this.maxMessageSize}).pb(rt),s=await i.read({signal:n}),o=await this.handleAutonatMessage(s,t,{signal:n});await i.write(o,{signal:n}),await e.close({signal:n})}catch(i){this.log.error("error handling incoming autonat stream - %e",i),e.abort(i)}}async handleAutonatMessage(e,t,n){const i=this.components.addressManager.getAddresses().map(d=>Ne(d).host),s=e.dial;if(s==null)return this.log.error("dial was missing from message"),{type:rt.MessageType.DIAL_RESPONSE,dialResponse:{status:rt.ResponseStatus.E_BAD_REQUEST,statusText:"No Dial message found in message"}};let o;const a=s.peer;if(a?.id==null)return this.log.error("peerId missing from message"),{type:rt.MessageType.DIAL_RESPONSE,dialResponse:{status:rt.ResponseStatus.E_BAD_REQUEST,statusText:"missing peer info"}};try{const d=Zt(a.id);o=ln(d)}catch(d){return this.log.error("invalid PeerId - %e",d),{type:rt.MessageType.DIAL_RESPONSE,dialResponse:{status:rt.ResponseStatus.E_BAD_REQUEST,statusText:"bad peer id"}}}if(this.log("incoming request from %p",o),!t.remotePeer.equals(o))return this.log("target peer %p did not equal sending peer %p",o,t.remotePeer),{type:rt.MessageType.DIAL_RESPONSE,dialResponse:{status:rt.ResponseStatus.E_BAD_REQUEST,statusText:"peer id mismatch"}};const c=a.addrs.map(d=>be(d)).filter(d=>{try{const h=Ne(d);return Or(d)?!1:h.host!==Ne(t.remoteAddr).host?(this.log.trace("not dialing %a - target host did not match remote host %a",d,t.remoteAddr),!1):i.includes(h.host)?!1:this.components.transportManager.dialTransportForMultiaddr(d)==null?(this.log.trace("not dialing %a - transport unsupported",d),!1):!0}catch{return!1}}).map(d=>(d.getComponents().find(h=>h.code===ge)?.value==null&&(d=d.encapsulate(`/p2p/${o.toString()}`)),d));if(c.length===0)return this.log("refused to dial all multiaddrs for %p from message",o),{type:rt.MessageType.DIAL_RESPONSE,dialResponse:{status:rt.ResponseStatus.E_DIAL_REFUSED,statusText:"no dialable addresses"}};this.log("dial multiaddrs %s for peer %p",c.map(d=>d.toString()).join(", "),o);let l="",u=c[0];for(const d of c){let h;u=d;try{if(h=await this.components.connectionManager.openConnection(d,n),!h.remoteAddr.equals(d))throw this.log.error("tried to dial %a but dialed %a",d,h.remoteAddr),new Error("Unexpected remote address");return this.log("successfully dialed %p via %a",o,d),{type:rt.MessageType.DIAL_RESPONSE,dialResponse:{status:rt.ResponseStatus.OK,addr:h.remoteAddr.decapsulateCode(ge).bytes}}}catch(f){this.log.error("could not dial %p - %e",o,f),l=f.message}finally{h!=null&&await h.close()}}return{type:rt.MessageType.DIAL_RESPONSE,dialResponse:{status:rt.ResponseStatus.E_DIAL_ERROR,statusText:l,addr:u.bytes}}}getFirstUnverifiedMultiaddr(e,t){const n=this.components.addressManager.getAddressesWithMetadata().sort((i,s)=>i.type==="observed"&&s.type!=="observed"?1:s.type==="observed"&&i.type!=="observed"?-1:0).filter(i=>!(!(i.expires<Date.now())||Ne(i.multiaddr).type==="ip6"&&(!t||!D7(i.multiaddr))||Or(i.multiaddr)));for(const i of n){const s=i.multiaddr.toString();let o=this.dialResults.get(s);if(o!=null){if(o.networkSegments.includes(e)){this.log.trace("%a already has a network segment result from %s",o.multiaddr,e);continue}if(o.queue.size>10){this.log.trace("%a already has enough peers queued",o.multiaddr);continue}}if(o==null){const a=i.expires<Date.now();if(a&&this.addressFilter.remove?.(s),this.addressFilter.has(s))continue;this.addressFilter.add(s),this.log.trace("creating dial result %s %s",a?"to revalidate":"for",s),o={multiaddr:i.multiaddr,success:0,failure:0,networkSegments:[],verifyingPeers:tD(),queue:new Fi({concurrency:3,maxSize:50}),type:i.type,lastVerified:i.lastVerified},this.dialResults.set(s,o)}return o}}removeOutdatedMultiaddrResults(){const e=new Set(this.components.addressManager.getAddressesWithMetadata().filter(({expires:t})=>t<Date.now()).map(({multiaddr:t})=>t.toString()));for(const t of this.dialResults.keys())e.has(t)||(this.log.trace("remove results for %a",t),this.dialResults.delete(t))}async verifyExternalAddresses(e){if(!this.isStarted())return;this.removeOutdatedMultiaddrResults();const n=(await this.components.peerStore.get(e.remotePeer)).addresses.some(({multiaddr:o})=>Ne(o).type==="ip6"),i=this.getNetworkSegment(e.remoteAddr),s=this.getFirstUnverifiedMultiaddr(i,n);if(s==null){this.log.trace("no unverified public addresses found for peer %p to verify, not requesting verification",e.remotePeer);return}if(!this.hasConnectionCapacity()){s.lastVerified!=null?(this.log("automatically re-verifying %a because we are too close to the connection limit",s.multiaddr),this.confirmAddress(s)):this.log("skipping verifying %a because we are too close to the connection limit",s.multiaddr);return}s.queue.add(async o=>{await this.askPeerToVerify(e,i,o)},{peerId:e.remotePeer,multiaddr:s.multiaddr}).catch(o=>{s?.result==null&&this.log.error("error from %p verifying address %a - %e",e.remotePeer,s?.multiaddr,o)})}async askPeerToVerify(e,t,n){let i=this.dialResults.get(n.multiaddr.toString());if(i==null){this.log("%a was verified while %p was queued",n.multiaddr,e.remotePeer);return}const s=AbortSignal.timeout(this.timeout);this.log.trace("asking %a to verify multiaddr %s",e.remoteAddr,n.multiaddr);const o=await e.newStream(this.protocol,{signal:s});try{const a=Qt(o).pb(rt),[,c]=await Promise.all([a.write({type:rt.MessageType.DIAL,dial:{peer:{id:this.components.peerId.toMultihash().bytes,addrs:[n.multiaddr.bytes]}}},{signal:s}),a.read({signal:s})]);if(c.type!==rt.MessageType.DIAL_RESPONSE||c.dialResponse==null){this.log("invalid autonat response from %p - %j",e.remotePeer,c);return}const l=c.dialResponse.status;if(this.log.trace("autonat response from %p for %a is %s",e.remotePeer,n.multiaddr,l),l!==rt.ResponseStatus.OK&&l!==rt.ResponseStatus.E_DIAL_ERROR)return;if(i=this.dialResults.get(n.multiaddr.toString()),i==null){this.log.trace("peer reported %a as %s but there is no result object",n.multiaddr,c.dialResponse.status);return}if(i.networkSegments.includes(t)){this.log.trace("%a results included network segment %s",n.multiaddr,t);return}if(i.result!=null){this.log.trace("already resolved result for %a, ignoring response from",n.multiaddr,e.remotePeer);return}if(i.verifyingPeers.has(e.remotePeer)){this.log.trace("peer %p has already verified %a, ignoring response",e.remotePeer,n.multiaddr);return}if(i.verifyingPeers.add(e.remotePeer),i.networkSegments.push(t),l===rt.ResponseStatus.OK){if(i.success++,i.type!=="observed"){this.confirmAddress(i);return}}else l===rt.ResponseStatus.E_DIAL_ERROR&&i.failure++;this.log("%a success %d failure %d",i.multiaddr,i.success,i.failure),i.success===_$&&this.confirmAddress(i),i.failure===T$&&this.unconfirmAddress(i)}finally{try{await o.close({signal:s})}catch(a){o.abort(a)}}}hasConnectionCapacity(){const t=this.components.connectionManager.getConnections().length,n=this.components.connectionManager.getMaxConnections();return t/n*100<this.connectionThreshold}confirmAddress(e){this.log("%s address %a is externally dialable",e.type,e.multiaddr),this.components.addressManager.confirmObservedAddr(e.multiaddr),this.dialResults.delete(e.multiaddr.toString()),e.result=!0,e.queue.abort()}unconfirmAddress(e){this.log("%s address %a is not externally dialable",e.type,e.multiaddr),this.components.addressManager.removeObservedAddr(e.multiaddr),this.dialResults.delete(e.multiaddr.toString()),e.result=!1,e.queue.abort()}getNetworkSegment(e){const t=Ne(e);switch(t.type){case"ip4":return t.host.split(".")[0].padStart(3,"0");case"ip6":return t.host.split(":")[0].padStart(4,"0");default:throw new H(`Remote address ${e} was not an IPv4 or Ipv6 address`)}}}function R$(r={}){return e=>new P$(e,r)}const N$="bootstrap",D$=50,B$=1e3;class L$ extends Qe{static tag="bootstrap";log;timer;list;timeout;components;_init;constructor(e,t={list:[]}){if(t.list==null||t.list.length===0)throw new Error("Bootstrap requires a list of peer addresses");super(),this.components=e,this.log=e.logger.forComponent("libp2p:bootstrap"),this.timeout=t.timeout??B$,this.list=t.list.map(n=>be(n)).filter(n=>Xg.matches(n)?n.getComponents().findLast(s=>s.code===ge)?.value==null?(this.log.error("invalid bootstrap multiaddr without peer id"),!1):!0:(this.log.error("invalid multiaddr %a",n),!1)).map(n=>({id:or(n.getComponents().findLast(i=>i.code===ge)?.value??""),multiaddrs:[n]})),this._init=t}[Qu]=this;[Symbol.toStringTag]="@libp2p/bootstrap";[It]=["@libp2p/peer-discovery"];isStarted(){return!!this.timer}start(){this.isStarted()||(this.log("Starting bootstrap node discovery, discovering peers after %s ms",this.timeout),this.timer=setTimeout(()=>{this._discoverBootstrapPeers().catch(e=>{this.log.error("failed to discover bootstrap peers - %e",e)})},this.timeout))}async _discoverBootstrapPeers(){if(this.timer!=null)for(const e of this.list){if(await this.components.peerStore.merge(e.id,{tags:{[this._init.tagName??N$]:{value:this._init.tagValue??D$,ttl:this._init.tagTTL}},multiaddrs:e.multiaddrs}),this.timer==null)return;this.safeDispatchEvent("peer",{detail:e}),this.components.connectionManager.openConnection(e.id).catch(t=>{this.log.error("could not dial bootstrap peer %p - %e",e.id,t)})}}stop(){this.timer!=null&&clearTimeout(this.timer),this.timer=void 0}}function ev(r){return e=>new L$(e,r)}const O$=1,tv=5e3,M$=100,Au=`${Mh}-circuit-relay`;BigInt(1<<17);const Fd="/libp2p/circuit/relay/0.2.0/hop",Ny="/libp2p/circuit/relay/0.2.0/stop",Dy=300,$$=4096,U$=.001;var Ko;(function(r){(function(n){n.RESERVE="RESERVE",n.CONNECT="CONNECT",n.STATUS="STATUS"})(r.Type||(r.Type={}));let e;(function(n){n[n.RESERVE=0]="RESERVE",n[n.CONNECT=1]="CONNECT",n[n.STATUS=2]="STATUS"})(e||(e={})),(function(n){n.codec=()=>sr(e)})(r.Type||(r.Type={}));let t;r.codec=()=>(t==null&&(t=Ce((n,i,s={})=>{s.lengthDelimited!==!1&&i.fork(),n.type!=null&&(i.uint32(8),r.Type.codec().encode(n.type,i)),n.peer!=null&&(i.uint32(18),Wo.codec().encode(n.peer,i)),n.reservation!=null&&(i.uint32(26),Vd.codec().encode(n.reservation,i)),n.limit!=null&&(i.uint32(34),jo.codec().encode(n.limit,i)),n.status!=null&&(i.uint32(40),rr.codec().encode(n.status,i)),s.lengthDelimited!==!1&&i.ldelim()},(n,i,s={})=>{const o={},a=i==null?n.len:n.pos+i;for(;n.pos<a;){const c=n.uint32();switch(c>>>3){case 1:{o.type=r.Type.codec().decode(n);break}case 2:{o.peer=Wo.codec().decode(n,n.uint32(),{limits:s.limits?.peer});break}case 3:{o.reservation=Vd.codec().decode(n,n.uint32(),{limits:s.limits?.reservation});break}case 4:{o.limit=jo.codec().decode(n,n.uint32(),{limits:s.limits?.limit});break}case 5:{o.status=rr.codec().decode(n);break}default:{n.skipType(c&7);break}}}return o})),t),r.encode=n=>ke(n,r.codec()),r.decode=(n,i)=>Ae(n,r.codec(),i)})(Ko||(Ko={}));var Fn;(function(r){(function(n){n.CONNECT="CONNECT",n.STATUS="STATUS"})(r.Type||(r.Type={}));let e;(function(n){n[n.CONNECT=0]="CONNECT",n[n.STATUS=1]="STATUS"})(e||(e={})),(function(n){n.codec=()=>sr(e)})(r.Type||(r.Type={}));let t;r.codec=()=>(t==null&&(t=Ce((n,i,s={})=>{s.lengthDelimited!==!1&&i.fork(),n.type!=null&&(i.uint32(8),r.Type.codec().encode(n.type,i)),n.peer!=null&&(i.uint32(18),Wo.codec().encode(n.peer,i)),n.limit!=null&&(i.uint32(26),jo.codec().encode(n.limit,i)),n.status!=null&&(i.uint32(32),rr.codec().encode(n.status,i)),s.lengthDelimited!==!1&&i.ldelim()},(n,i,s={})=>{const o={},a=i==null?n.len:n.pos+i;for(;n.pos<a;){const c=n.uint32();switch(c>>>3){case 1:{o.type=r.Type.codec().decode(n);break}case 2:{o.peer=Wo.codec().decode(n,n.uint32(),{limits:s.limits?.peer});break}case 3:{o.limit=jo.codec().decode(n,n.uint32(),{limits:s.limits?.limit});break}case 4:{o.status=rr.codec().decode(n);break}default:{n.skipType(c&7);break}}}return o})),t),r.encode=n=>ke(n,r.codec()),r.decode=(n,i)=>Ae(n,r.codec(),i)})(Fn||(Fn={}));var Wo;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,i={})=>{if(i.lengthDelimited!==!1&&n.fork(),t.id!=null&&t.id.byteLength>0&&(n.uint32(10),n.bytes(t.id)),t.addrs!=null)for(const s of t.addrs)n.uint32(18),n.bytes(s);i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{const s={id:Re(0),addrs:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.id=t.bytes();break}case 2:{if(i.limits?.addrs!=null&&s.addrs.length===i.limits.addrs)throw new Mt('Decode error - map field "addrs" had too many elements');s.addrs.push(t.bytes());break}default:{t.skipType(a&7);break}}}return s})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ae(t,r.codec(),n)})(Wo||(Wo={}));var Vd;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,i={})=>{if(i.lengthDelimited!==!1&&n.fork(),t.expire!=null&&t.expire!==0n&&(n.uint32(8),n.uint64(t.expire)),t.addrs!=null)for(const s of t.addrs)n.uint32(18),n.bytes(s);t.voucher!=null&&(n.uint32(26),Hd.codec().encode(t.voucher,n)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{const s={expire:0n,addrs:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.expire=t.uint64();break}case 2:{if(i.limits?.addrs!=null&&s.addrs.length===i.limits.addrs)throw new Mt('Decode error - map field "addrs" had too many elements');s.addrs.push(t.bytes());break}case 3:{s.voucher=Hd.codec().decode(t,t.uint32(),{limits:i.limits?.voucher});break}default:{t.skipType(a&7);break}}}return s})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ae(t,r.codec(),n)})(Vd||(Vd={}));var jo;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.duration!=null&&(n.uint32(8),n.uint32(t.duration)),t.data!=null&&(n.uint32(16),n.uint64(t.data)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{const s={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.duration=t.uint32();break}case 2:{s.data=t.uint64();break}default:{t.skipType(a&7);break}}}return s})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ae(t,r.codec(),n)})(jo||(jo={}));var rr;(function(r){r.UNUSED="UNUSED",r.OK="OK",r.RESERVATION_REFUSED="RESERVATION_REFUSED",r.RESOURCE_LIMIT_EXCEEDED="RESOURCE_LIMIT_EXCEEDED",r.PERMISSION_DENIED="PERMISSION_DENIED",r.CONNECTION_FAILED="CONNECTION_FAILED",r.NO_RESERVATION="NO_RESERVATION",r.MALFORMED_MESSAGE="MALFORMED_MESSAGE",r.UNEXPECTED_MESSAGE="UNEXPECTED_MESSAGE"})(rr||(rr={}));var r2;(function(r){r[r.UNUSED=0]="UNUSED",r[r.OK=100]="OK",r[r.RESERVATION_REFUSED=200]="RESERVATION_REFUSED",r[r.RESOURCE_LIMIT_EXCEEDED=201]="RESOURCE_LIMIT_EXCEEDED",r[r.PERMISSION_DENIED=202]="PERMISSION_DENIED",r[r.CONNECTION_FAILED=203]="CONNECTION_FAILED",r[r.NO_RESERVATION=204]="NO_RESERVATION",r[r.MALFORMED_MESSAGE=400]="MALFORMED_MESSAGE",r[r.UNEXPECTED_MESSAGE=401]="UNEXPECTED_MESSAGE"})(r2||(r2={}));(function(r){r.codec=()=>sr(r2)})(rr||(rr={}));var zd;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.relay!=null&&t.relay.byteLength>0&&(n.uint32(10),n.bytes(t.relay)),t.peer!=null&&t.peer.byteLength>0&&(n.uint32(18),n.bytes(t.peer)),t.expiration!=null&&t.expiration!==0n&&(n.uint32(24),n.uint64(t.expiration)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{const s={relay:Re(0),peer:Re(0),expiration:0n},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.relay=t.bytes();break}case 2:{s.peer=t.bytes();break}case 3:{s.expiration=t.uint64();break}default:{t.skipType(a&7);break}}}return s})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ae(t,r.codec(),n)})(zd||(zd={}));var Hd;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.publicKey!=null&&t.publicKey.byteLength>0&&(n.uint32(10),n.bytes(t.publicKey)),t.payloadType!=null&&t.payloadType.byteLength>0&&(n.uint32(18),n.bytes(t.payloadType)),t.payload!=null&&(n.uint32(26),zd.codec().encode(t.payload,n)),t.signature!=null&&t.signature.byteLength>0&&(n.uint32(42),n.bytes(t.signature)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{const s={publicKey:Re(0),payloadType:Re(0),signature:Re(0)},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.publicKey=t.bytes();break}case 2:{s.payloadType=t.bytes();break}case 3:{s.payload=zd.codec().decode(t,t.uint32(),{limits:i.limits?.payload});break}case 5:{s.signature=t.bytes();break}default:{t.skipType(a&7);break}}}return s})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ae(t,r.codec(),n)})(Hd||(Hd={}));class By extends Error{static name="HadEnoughRelaysError";name="HadEnoughRelaysError"}class F$ extends Error{static name="DoubleRelayError";name="DoubleRelayError"}class V$ extends Error{static name="RelayQueueFullError";name="RelayQueueFullError"}function Ly(r){const e=r*BigInt(1e3),t=new Date().getTime();return Number(e-BigInt(t))}class Oy{expires;bytes;constructor(e){e?.duration!=null&&e?.duration!==0&&(this.expires=Date.now()+e.duration*1e3),this.bytes=e?.data,this.bytes===0n&&(this.bytes=void 0),this.onData=this.onData.bind(this)}onData(e){this.bytes!=null&&(this.bytes-=BigInt(e.byteLength),this.bytes<0n&&(this.bytes=0n))}getLimits(){if(this.expires==null&&this.bytes==null)return;const e={};if(this.bytes!=null){const t=this;Object.defineProperty(e,"bytes",{get(){return t.bytes}})}if(this.expires!=null){const t=this;Object.defineProperty(e,"seconds",{get(){return Math.round(((t.expires??0)-Date.now())/1e3)}})}return e}}const rv=Ge(He(Xg.matchers[0],je(da))),nv=Ge(je(da));class z$ extends Qe{components;started;running;topologyId;log;discoveryController;filter;queue;constructor(e,t={}){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:discover-relays"),this.components=e,this.started=!1,this.running=!1,this.filter=t.filter,this.discoveryController=new AbortController,this.discoveryController.signal,this.dialPeer=this.dialPeer.bind(this),this.onPeer=this.onPeer.bind(this)}isStarted(){return this.started}async start(){this.topologyId=await this.components.registrar.register(Fd,{filter:this.filter,onConnect:e=>{this.log.trace("discovered relay %p queue (length: %d, active %d)",e,this.queue?.size,this.queue?.running),this.safeDispatchEvent("relay:discover",{detail:e})}}),this.started=!0}stop(){this.topologyId!=null&&this.components.registrar.unregister(this.topologyId),this.running&&this.stopDiscovery(),this.started=!1}startDiscovery(){this.running||(this.log("start discovery"),this.running=!0,this.discoveryController=new AbortController,this.discoveryController.signal,this.components.events.addEventListener("peer:discovery",this.onPeer),Promise.resolve().then(async()=>{this.log("searching peer store for relays");const e=await this.components.peerStore.all({filters:[n=>n.protocols.includes(Fd)],orders:[()=>Math.random()<.5?1:-1,(n,i)=>{const s=My(n),o=My(i);return s>o?-1:o>s?1:0}]});for(const n of e)this.log.trace("found relay peer %p in peer store",n.id),this.safeDispatchEvent("relay:discover",{detail:n.id});this.log("found %d relay peers in peer store",e.length);const t=this.queue=new Fi({concurrency:5});this.log("start random walk");for await(const n of this.components.randomWalk.walk({signal:this.discoveryController.signal})){if(this.log.trace("found random peer %p",n.id),t.has(n.id)){this.log.trace("random peer %p was already in queue",n.id);continue}if(this.components.connectionManager.getConnections(n.id)?.length>0){this.log.trace("random peer %p was already connected",n.id);continue}if(!await this.components.connectionManager.isDialable(n.multiaddrs)){this.log.trace("random peer %p was not dialable",n.id,n.multiaddrs.map(i=>i.toString()));continue}t.queued>10&&(this.log.trace("wait for space in queue for %p",n.id),await t.onSizeLessThan(10,{signal:this.discoveryController.signal})),this.log("adding random peer %p to dial queue (length: %d, active %d)",n.id,t.size,t.running),t.add(this.dialPeer,{peerId:n.id,signal:this.discoveryController.signal}).catch(i=>{this.log.error("error opening connection to random peer %p - %e",n.id,i)})}this.log("stop random walk"),await t.onIdle()}).catch(e=>{this.discoveryController.signal.aborted||this.log.error("failed when finding relays on the network - %e",e)}))}stopDiscovery(){this.log("stop discovery"),this.running=!1,this.discoveryController?.abort(),this.queue?.clear(),this.components.events.removeEventListener("peer:discovery",this.onPeer)}onPeer(e){this.log.trace("maybe dialing discovered peer %p",e.detail.id),this.maybeDialPeer(e).catch(t=>{this.log.trace("error dialing discovered peer %p - %e",e.detail.id,t)})}async maybeDialPeer(e){if(this.queue==null)return;const t=e.detail.id,n=e.detail.multiaddrs;if(this.queue.has(t)){this.log.trace("random peer %p was already in queue",t);return}if(this.components.connectionManager.getConnections(t)?.length>0){this.log.trace("random peer %p was already connected",t);return}if(!await this.components.connectionManager.isDialable(n)){this.log.trace("random peer %p was not dialable",t);return}this.queue?.add(this.dialPeer,{peerId:e.detail.id,signal:this.discoveryController.signal}).catch(i=>{this.log.error("error opening connection to discovered peer %p - %e",e.detail.id,i)})}async dialPeer({peerId:e,signal:t}){const n=Ke([AbortSignal.timeout(5e3),t]);try{await this.components.connectionManager.openConnection(e,{signal:n})}finally{n.clear()}}}function My(r){const e=r.metadata.get("last-dial-success");return e==null?0:new Date(Y(e)).getTime()}class H$ extends Qe{connectionManager;addressManager;reservationStore;listeningAddrs;log;listenTimeout;reservationId;relay;constructor(e,t={}){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:transport:listener"),this.connectionManager=e.connectionManager,this.addressManager=e.addressManager,this.reservationStore=e.reservationStore,this.listeningAddrs=[],this.listenTimeout=t.listenTimeout??tv,this.reservationStore.addEventListener("relay:removed",this._onRemoveRelayPeer),this.reservationStore.addEventListener("relay:created-reservation",this._onAddRelayPeer)}_onRemoveRelayPeer=e=>{this.log("relay removed %p our relay %p",e.detail.relay,this.relay,this.relay?.equals(e.detail.relay)),this.relay?.equals(e.detail.relay)===!0&&(this.log("relay peer removed %p",e.detail.relay),this.listeningAddrs.forEach(t=>{this.addressManager.removeObservedAddr(t)}),this.listeningAddrs=[],this.safeDispatchEvent("listening"))};_onAddRelayPeer=e=>{const{details:t}=e.detail;t.type!=="configured"&&t.id===this.reservationId&&this.addedRelay(e.detail)};async listen(e){if(nv.exactMatch(e))this.log("searching for circuit relay servers"),this.reservationId=this.reservationStore.reserveRelay();else if(rv.exactMatch(e)){this.log("listen on specific relay server %a",e);const t=AbortSignal.timeout(this.listenTimeout),n=e.decapsulate("/p2p-circuit"),i=await this.connectionManager.openConnection(n,{signal:t});if(!this.reservationStore.hasReservation(i.remotePeer)){this.log("making reservation on peer %p",i.remotePeer);const s=await this.reservationStore.addRelay(i.remotePeer,"configured");this.addedRelay(s)}}else throw new g0(`Could not listen on p2p-circuit address "${e}"`)}getAddrs(){return[...this.listeningAddrs.values()].flat()}updateAnnounceAddrs(){}async close(){this.reservationStore.cancelReservations(),this.listeningAddrs=[],this.reservationStore.removeEventListener("relay:removed",this._onRemoveRelayPeer),queueMicrotask(()=>{this.safeDispatchEvent("close")})}addedRelay(e){this.log("relay peer added %p",e.relay),this.relay=e.relay,this.listeningAddrs=e.details.reservation.addrs.map(t=>be(t).encapsulate("/p2p-circuit")),this.listeningAddrs.forEach(t=>{this.addressManager.confirmObservedAddr(t,{type:"transport"})}),queueMicrotask(()=>{this.safeDispatchEvent("listening")})}}function q$(r){return new H$(r)}const K$="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";let W$=(r=21)=>{let e="",t=crypto.getRandomValues(new Uint8Array(r|=0));for(;r--;)e+=K$[t[r]&63];return e};const j$=60*1e3*10,G$=60*1e3*5,Y$=30*1e3;class Q$ extends Qe{peerId;connectionManager;peerStore;events;reserveQueue;reservations;pendingReservations;maxReservationQueueLength;reservationCompletionTimeout;started;log;relayFilter;constructor(e,t){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:transport:reservation-store"),this.peerId=e.peerId,this.connectionManager=e.connectionManager,this.peerStore=e.peerStore,this.events=e.events,this.reservations=new Gs,this.pendingReservations=[],this.maxReservationQueueLength=t?.maxReservationQueueLength??M$,this.reservationCompletionTimeout=t?.reservationCompletionTimeout??tv,this.started=!1,this.relayFilter=Mi(100),this.reserveQueue=new Fi({concurrency:t?.reservationConcurrency??O$,metricName:"libp2p_relay_reservation_queue",metrics:e.metrics}),this.events.addEventListener("connection:close",n=>{[...this.reservations.values()].find(s=>s.connection===n.detail.id)!=null&&this.#t(n.detail.remotePeer).catch(s=>{this.log("could not remove relay %p - %e",n.detail,s)})})}isStarted(){return this.started}start(){this.started=!0}afterStart(){Promise.resolve().then(async()=>{const e=await this.peerStore.all({filters:[t=>t.tags.has(Au)]});this.log("removing tag from %d old relays",e.length),await Promise.all(e.map(async t=>{await this.peerStore.merge(t.id,{tags:{[Au]:void 0}})})),this.log("redialing %d old relays",e.length),await Promise.all(e.map(async t=>this.addRelay(t.id,"discovered"))),this.#r()}).catch(e=>{this.log.error("failed to clean up and redial old relays during afterStart - %e",e)})}stop(){this.reserveQueue.clear(),this.reservations.forEach(({timeout:e})=>{clearTimeout(e)}),this.reservations.clear(),this.started=!1}reserveRelay(){const e=W$();return this.pendingReservations.push(e),this.#r(),e}async addRelay(e,t){if(this.peerId.equals(e))throw this.log.trace("not trying to use self as relay"),new g0("Cannot use self as relay");if(this.reserveQueue.size>this.maxReservationQueueLength)throw new V$("The reservation queue is full");const n=this.reserveQueue.find(e);if(n!=null)return this.log.trace("potential relay peer %p is already in the reservation queue",e),n.join();if(this.relayFilter.has(e.toMultihash().bytes))throw new g0("The relay was previously invalid");return this.log.trace("try to reserve relay slot with %p",e),this.reserveQueue.add(async()=>{const i=Date.now();try{const s=this.reservations.get(e);if(s!=null){const y=this.connectionManager.getConnections(e);let m=!1;if(y.length===0&&this.log("already have relay reservation with %p but we are no longer connected",e),y.map(p=>p.id).includes(s.connection)&&(this.log("already have relay reservation with %p and the original connection is still open",e),m=!0),m&&Ly(s.reservation.expire)>j$)return this.log("already have relay reservation with %p but we are still connected and it does not expire soon",e),{relay:e,details:s};await this.#t(e)}if(t==="discovered"&&this.pendingReservations.length===0)throw new By("Not making reservation on discovered relay because we do not need any more relays");const o=AbortSignal.timeout(this.reservationCompletionTimeout);const a=await this.connectionManager.openConnection(e,{signal:o});if(_n.matches(a.remoteAddr))throw new F$("not creating reservation over relayed connection");const c=await this.#e(a,{signal:o}),l=Ly(c.expire);this.log("created reservation on relay peer %p, expiry date is %s",e,new Date(Date.now()+l).toString());const u=Math.min(Math.max(l-G$,Y$),Math.pow(2,31)-1),d=setTimeout(()=>{this.log("refresh reservation to relay %p",e),this.addRelay(e,t).catch(async y=>{this.log.error("could not refresh reservation to relay %p - %e",e,y),await this.#t(e)}).catch(y=>{this.log.error("could not remove expired reservation to relay %p - %e",e,y)})},u);let h;if(t==="discovered"){const y=this.pendingReservations.pop();if(y==null)throw new By("Made reservation on relay but did not need any more discovered relays");h={timeout:d,reservation:c,type:t,connection:a.id,id:y}}else h={timeout:d,reservation:c,type:t,connection:a.id};this.reservations.set(e,h),await this.peerStore.merge(e,{tags:{[Au]:{value:1,ttl:l}}}),this.#r();const f={relay:e,details:h};return this.safeDispatchEvent("relay:created-reservation",{detail:f}),f}catch(s){throw t==="discovered"&&s.name==="HadEnoughRelaysError"||this.log.error("could not reserve slot on %p after %dms - %e",e,Date.now()-i,s),(s.name==="DialError"||s.name==="UnsupportedProtocolError")&&this.relayFilter.add(e.toMultihash().bytes),this.#t(e).catch(o=>{this.log.error("could not remove reservation on %p after reserving slot failed - %e",e,o)}),s}},{peerId:e})}hasReservation(e){return this.reservations.has(e)}getReservation(e){return this.reservations.get(e)?.reservation}reservationCount(e){return e==null?this.reservations.size:[...this.reservations.values()].reduce((t,n)=>(n.type===e&&t++,t),0)}cancelReservations(){[...this.reservations.values()].forEach(e=>{clearTimeout(e.timeout)}),this.reservations.clear()}async#e(e,t){t.signal?.throwIfAborted(),this.log("requesting reservation from %p",e.remotePeer);const n=await e.newStream(Fd,t),s=Qt(n).pb(Ko);this.log.trace("send RESERVE to %p",e.remotePeer),await s.write({type:Ko.Type.RESERVE},t);let o;try{this.log.trace("reading response from %p",e.remotePeer),o=await s.read(t)}catch(c){throw n.abort(c),c}finally{n.status!=="closed"&&await n.close(t)}if(this.log.trace("read response %s",o.status),o.status===rr.OK&&o.reservation!=null){const c=new Set;c.add(e.remoteAddr.toString());for(const l of o.reservation.addrs){let u=be(l);u.getComponents().find(d=>d.code===ge)==null&&(u=u.encapsulate(`/p2p/${e.remotePeer}`)),u=be(u.toString().replace(`/p2p/${e.remotePeer}/p2p/${e.remotePeer}`,`/p2p/${e.remotePeer}`)),c.add(u.toString())}return o.reservation.addrs=[...c].map(l=>be(l).bytes),o.reservation}const a=`reservation failed with status ${o.status??"undefined"}`;throw this.log.error(a),new Error(a)}async#t(e){const t=this.reservations.get(e);t!=null&&(this.log("removing relay reservation with %p from local store",e),clearTimeout(t.timeout),this.reservations.delete(e),t.type==="discovered"&&this.pendingReservations.push(t.id),await this.peerStore.merge(e,{tags:{[Au]:void 0}}),this.safeDispatchEvent("relay:removed",{detail:{relay:e,details:t}}),this.#r())}#r(){if(this.pendingReservations.length===0){this.log.trace("have discovered enough relays"),this.reserveQueue.clear(),this.safeDispatchEvent("relay:found-enough-relays");return}this.relayFilter=Mi(100),this.log("not discovered enough relays %d/%d",this.reservations.size,this.pendingReservations.length),this.safeDispatchEvent("relay:not-enough-relays")}}class X$ extends pg{stream;init;constructor(e){super({...e,direction:e.stream.direction}),this.init=e,this.stream=e.stream,this.stream.addEventListener("close",t=>{this.onTransportClosed(t.error)}),this.stream.addEventListener("remoteCloseWrite",t=>{this.onRemoteCloseWrite(),this.close().catch(n=>{this.abort(n)})}),this.stream.addEventListener("message",t=>{e.onDataRead?.(t.data),this.onData(t.data)}),this.stream.addEventListener("drain",()=>{this.safeDispatchEvent("drain")})}sendData(e){return this.init.onDataWrite?.(e),{sentBytes:e.byteLength,canSendMore:this.stream.send(e)}}async sendClose(e){await this.stream.close(e)}sendReset(){this.stream.abort(new Error("An error occurred"))}sendPause(){this.stream.pause()}sendResume(){this.stream.resume()}}function $y(r){return new X$(r)}const Z$=r=>{if(r.peer==null)return!1;try{r.peer.addrs.forEach(be)}catch{return!1}return!0},Uy={maxInboundStopStreams:Dy,maxOutboundStopStreams:Dy};class J${components;discovery;reservationStore;maxInboundStopStreams;maxOutboundStopStreams;started;log;shutdownController;constructor(e,t={}){this.components=e,this.log=e.logger.forComponent("libp2p:circuit-relay:transport"),this.maxInboundStopStreams=t.maxInboundStopStreams??Uy.maxInboundStopStreams,this.maxOutboundStopStreams=t.maxOutboundStopStreams??Uy.maxOutboundStopStreams,this.shutdownController=new AbortController,this.discovery=new z$(e,{filter:t.discoveryFilter??nD($$,U$)}),this.discovery.addEventListener("relay:discover",n=>{this.reservationStore.addRelay(n.detail,"discovered").catch(i=>{i.name!=="HadEnoughRelaysError"&&i.name!=="RelayQueueFullError"&&this.log.error("could not add discovered relay %p - %e",n.detail,i)})}),this.reservationStore=new Q$(e,t),this.reservationStore.addEventListener("relay:not-enough-relays",()=>{this.discovery?.startDiscovery()}),this.reservationStore.addEventListener("relay:found-enough-relays",()=>{this.discovery?.stopDiscovery()}),this.started=!1,this.onStop=this.onStop.bind(this)}[Symbol.toStringTag]="@libp2p/circuit-relay-v2-transport";[It]=["@libp2p/transport","@libp2p/circuit-relay-v2-transport"];get[ws](){return this.discovery!=null?["@libp2p/identify"]:[]}[$h]=!0;isStarted(){return this.started}async start(){this.shutdownController=new AbortController,this.shutdownController.signal,await this.components.registrar.handle(Ny,this.onStop,{maxInboundStreams:this.maxInboundStopStreams,maxOutboundStreams:this.maxOutboundStopStreams,runOnLimitedConnection:!0}),await Cn(this.discovery,this.reservationStore),this.started=!0}async stop(){this.shutdownController.abort(),await ni(this.discovery,this.reservationStore),await this.components.registrar.unhandle(Ny),this.started=!1}async dial(e,t){const n=e.toString().split("/p2p-circuit"),i=be(n[0]),s=be(n[n.length-1]),o=i.getComponents().find(f=>f.code===ge)?.value,a=s.getComponents().find(f=>f.code===ge)?.value;if(o==null||a==null){const f=`ircuit relay dial to ${e.toString()} failed as address did not have both relay and destination PeerIDs`;throw this.log.error(`c${f}`),new Ou(`C${f}`)}const c=or(o),l=or(a);let d=this.components.connectionManager.getConnections(c)[0];d==null?(await this.components.peerStore.merge(c,{multiaddrs:[i]}),t.onProgress?.(new oe("circuit-relay:open-connection")),d=await this.components.connectionManager.openConnection(c,t)):t.onProgress?.(new oe("circuit-relay:reuse-connection"));let h;try{t.onProgress?.(new oe("circuit-relay:open-hop-stream")),h=await d.newStream(Fd,t);const f=Qt(h).pb(Ko);t.onProgress?.(new oe("circuit-relay:write-connect-message")),await f.write({type:Ko.Type.CONNECT,peer:{id:l.toMultihash().bytes,addrs:[be(s).bytes]}},t),t.onProgress?.(new oe("circuit-relay:read-connect-response"));const y=await f.read(t);if(y.status!==rr.OK)throw new Je(`failed to connect via relay with status ${y?.status?.toString()??"undefined"}`);const m=new Oy(y.limit),p=$y({stream:f.unwrap().unwrap(),remoteAddr:e,localAddr:i.encapsulate(`/p2p-circuit/p2p/${this.components.peerId.toString()}`),onDataRead:m.onData,onDataWrite:m.onData,log:h.log.newScope("circuit-relay:connection")}),b=await this.components.upgrader.upgradeOutbound(p,{...t,limits:m.getLimits()});return b.log("outbound relayed connection established to %p with limits %o, over connection %s",b.remotePeer,y.limit??"none",d.id),b}catch(f){throw this.log.error("circuit relay dial to destination %p via relay %p failed - %e",l,c,f),h?.abort(f),f}}createListener(e){return q$({peerId:this.components.peerId,connectionManager:this.components.connectionManager,addressManager:this.components.addressManager,reservationStore:this.reservationStore,logger:this.components.logger})}listenFilter(e){return e=Array.isArray(e)?e:[e],e.filter(t=>rv.exactMatch(t)||nv.exactMatch(t))}dialFilter(e){return e=Array.isArray(e)?e:[e],e.filter(t=>_n.exactMatch(t))}async onStop(e,t){const n=this.components.upgrader.createInboundAbortSignal(this.shutdownController.signal);try{if(!this.reservationStore.hasReservation(t.remotePeer))try{this.log("dialed via relay we did not have a reservation on, start listening on that relay address"),await this.components.transportManager.listen([t.remoteAddr.encapsulate("/p2p-circuit")])}catch(d){this.log.error("failed to listen on a relay peer we were dialed via but did not have a reservation on - %e",d)}const i=Qt(e).pb(Fn),s=await i.read({signal:n});if(this.log("new circuit relay v2 stop stream from %p with type %s",t.remotePeer,s.type),s?.type===void 0){this.log.error("type was missing from circuit v2 stop protocol request from %s",t.remotePeer),await i.write({type:Fn.Type.STATUS,status:rr.MALFORMED_MESSAGE},{signal:n}),await e.close({signal:n});return}if(s.type!==Fn.Type.CONNECT){this.log.error("invalid stop connect request via peer %p",t.remotePeer),await i.write({type:Fn.Type.STATUS,status:rr.UNEXPECTED_MESSAGE},{signal:n}),await e.close({signal:n});return}if(!Z$(s)){this.log.error("invalid stop connect request via peer %p",t.remotePeer),await i.write({type:Fn.Type.STATUS,status:rr.MALFORMED_MESSAGE},{signal:n}),await e.close({signal:n});return}const o=ln(Zt(s.peer.id));if(await this.components.connectionGater.denyInboundRelayedConnection?.(t.remotePeer,o)===!0){this.log.error("connection gater denied inbound relayed connection from %p",t.remotePeer),await i.write({type:Fn.Type.STATUS,status:rr.PERMISSION_DENIED},{signal:n}),await e.close({signal:n});return}this.log.trace("sending success response to %p",t.remotePeer),await i.write({type:Fn.Type.STATUS,status:rr.OK},{signal:n});const a=new Oy(s.limit),c=t.remoteAddr.encapsulate(`/p2p-circuit/p2p/${o.toString()}`),l=this.components.addressManager.getAddresses()[0],u=$y({stream:i.unwrap().unwrap(),remoteAddr:c,localAddr:l,onDataRead:a.onData,onDataWrite:a.onData,log:e.log.newScope("circuit-relay:connection")});await this.components.upgrader.upgradeInbound(u,{limits:a.getLimits(),signal:n}),u.log("inbound relayed connection established to %p with limits %o, over connection %s",o,s.limit??"none",t.id)}finally{n?.clear()}}}function iv(r={}){return e=>new J$(e,r)}var pn;(function(r){(function(n){n.UNUSED="UNUSED",n.CONNECT="CONNECT",n.SYNC="SYNC"})(r.Type||(r.Type={}));let e;(function(n){n[n.UNUSED=0]="UNUSED",n[n.CONNECT=100]="CONNECT",n[n.SYNC=300]="SYNC"})(e||(e={})),(function(n){n.codec=()=>sr(e)})(r.Type||(r.Type={}));let t;r.codec=()=>(t==null&&(t=Ce((n,i,s={})=>{if(s.lengthDelimited!==!1&&i.fork(),n.type!=null&&(i.uint32(8),r.Type.codec().encode(n.type,i)),n.observedAddresses!=null)for(const o of n.observedAddresses)i.uint32(18),i.bytes(o);s.lengthDelimited!==!1&&i.ldelim()},(n,i,s={})=>{const o={observedAddresses:[]},a=i==null?n.len:n.pos+i;for(;n.pos<a;){const c=n.uint32();switch(c>>>3){case 1:{o.type=r.Type.codec().decode(n);break}case 2:{if(s.limits?.observedAddresses!=null&&o.observedAddresses.length===s.limits.observedAddresses)throw new Mt('Decode error - map field "observedAddresses" had too many elements');o.observedAddresses.push(n.bytes());break}default:{n.skipType(c&7);break}}}return o})),t),r.encode=n=>ke(n,r.codec()),r.decode=(n,i)=>Ae(n,r.codec(),i)})(pn||(pn={}));function Fy(r,e){return _n.matches(r)||e.dialTransportForMultiaddr(r)==null?!1:Qw.matches(r)?!0:SD.matches(r)?!Or(r):!1}const Vy=1024*4,zy=100,ku={timeout:5e3,retries:3,maxInboundStreams:1,maxOutboundStreams:1};class eU{started;timeout;retries;maxInboundStreams;maxOutboundStreams;peerStore;registrar;connectionManager;addressManager;transportManager;topologyId;log;constructor(e,t){this.log=e.logger.forComponent("libp2p:dcutr"),this.started=!1,this.peerStore=e.peerStore,this.registrar=e.registrar,this.addressManager=e.addressManager,this.connectionManager=e.connectionManager,this.transportManager=e.transportManager,this.timeout=t.timeout??ku.timeout,this.retries=t.retries??ku.retries,this.maxInboundStreams=t.maxInboundStreams??ku.maxInboundStreams,this.maxOutboundStreams=t.maxOutboundStreams??ku.maxOutboundStreams,this.handleIncomingUpgrade=this.handleIncomingUpgrade.bind(this)}[Symbol.toStringTag]="@libp2p/dcutr";[ws]=["@libp2p/identify"];isStarted(){return this.started}async start(){this.started||(this.topologyId=await this.registrar.register(Cu,{notifyOnLimitedConnection:!0,onConnect:(e,t)=>{_n.exactMatch(t.remoteAddr)&&t.direction==="inbound"&&this.upgradeInbound(t).catch(n=>{this.log.error("error during outgoing DCUtR attempt - %e",n)})}}),await this.registrar.handle(Cu,this.handleIncomingUpgrade,{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:!0}),this.started=!0)}async stop(){await this.registrar.unhandle(Cu),this.topologyId!=null&&this.registrar.unregister(this.topologyId),this.started=!1}async upgradeInbound(e){if(await this.attemptUnilateralConnectionUpgrade(e))return;let t;for(let n=0;n<this.retries;n++){const i={signal:AbortSignal.timeout(this.timeout)};try{t=await e.newStream([Cu],{signal:i.signal,runOnLimitedConnection:!0});const s=Qt(t,{maxDataLength:Vy}).pb(pn);this.log("B sending connect to %p",e.remotePeer);const o=Date.now();await s.write({type:pn.Type.CONNECT,observedAddresses:this.addressManager.getAddresses().map(d=>d.bytes)},i),this.log("B receiving connect from %p",e.remotePeer);const a=await s.read(i);if(a.type!==pn.Type.CONNECT)throw this.log("A sent wrong message type"),new Je("DCUtR message type was incorrect");const c=this.getDialableMultiaddrs(a.observedAddresses);if(c.length===0)throw this.log("A did not have any dialable multiaddrs"),new Je("DCUtR connect message had no multiaddrs");const l=Date.now()-o;this.log("A sending sync, rtt %dms",l),await s.write({type:pn.Type.SYNC,observedAddresses:[]},i),this.log("A waiting for half RTT"),await zP(l/2),this.log("B dialing",c);const u=await this.connectionManager.openConnection(c,{signal:i.signal,priority:zy,force:!0,initiator:!1});this.log("DCUtR to %p succeeded to address %a, closing relayed connection",e.remotePeer,u.remoteAddr),await e.close(i);break}catch(s){if(this.log.error("error while attempting DCUtR on attempt %d of %d - %e",n+1,this.retries,s),t?.abort(s),n===this.retries)throw s}finally{t!=null&&await t.close(i)}}}async attemptUnilateralConnectionUpgrade(e){const n=(await this.peerStore.get(e.remotePeer)).addresses.map(i=>{const s=i.multiaddr;return s.getComponents().find(o=>o.code===ge)?.value==null?s.encapsulate(`/p2p/${e.remotePeer}`):s}).filter(i=>Fy(i,this.transportManager));if(n.length>0){const i=AbortSignal.timeout(this.timeout);try{this.log("attempting unilateral connection upgrade to %a",n);const s=await this.connectionManager.openConnection(n,{signal:i,force:!0});if(_n.exactMatch(s.remoteAddr))throw new Error("Could not open a new, non-limited, connection");return this.log("unilateral connection upgrade to %p succeeded via %a, closing relayed connection",e.remotePeer,s.remoteAddr),await e.close({signal:i}),!0}catch(s){this.log.error("unilateral connection upgrade to %p on addresses %a failed - %e",e.remotePeer,n,s)}}else this.log("peer %p has no public addresses, not attempting unilateral connection upgrade",e.remotePeer);return!1}async handleIncomingUpgrade(e,t){const n={signal:AbortSignal.timeout(this.timeout)},i=Qt(e,{maxDataLength:Vy}).pb(pn);this.log("A receiving connect");const s=await i.read(n);if(s.type!==pn.Type.CONNECT)throw this.log("B sent wrong message type"),new Je("DCUtR message type was incorrect");if(s.observedAddresses.length===0)throw this.log("B sent no multiaddrs"),new Je("DCUtR connect message had no multiaddrs");const o=this.getDialableMultiaddrs(s.observedAddresses);if(o.length===0)throw this.log("B had no dialable multiaddrs in %o",s.observedAddresses.map(l=>be(l))),new Je("DCUtR connect message had no dialable multiaddrs");if(this.log("A sending connect"),await i.write({type:pn.Type.CONNECT,observedAddresses:this.addressManager.getAddresses().map(l=>l.bytes)}),this.log("A receiving sync"),(await i.read(n)).type!==pn.Type.SYNC)throw new Je("DCUtR message type was incorrect");this.log("A dialing",o);const c=await this.connectionManager.openConnection(o,{signal:n.signal,priority:zy,force:!0});this.log("DCUtR to %p succeeded via %a, closing relayed connection",t.remotePeer,c.remoteAddr),await t.close(n),await e.close(n)}getDialableMultiaddrs(e){const t=[];for(const n of e)if(!(n==null||n.length===0))try{const i=be(n);if(!Fy(i,this.transportManager))continue;t.push(i)}catch{}return t}}const Cu="/libp2p/dcutr";function tU(r={}){return e=>new eU(e,r)}function le(r){if(r!==void 0&&r!==le.REQUEST&&r!==le.RESPONSE)throw new Error("type must be REQUEST or RESPONSE");r===void 0||this.initialize(r),this.maxHeaderSize=le.maxHeaderSize}le.prototype.initialize=function(r,e){if(r!==le.REQUEST&&r!==le.RESPONSE)throw new Error("type must be REQUEST or RESPONSE");this.type=r,this.state=r+"_LINE",this.info={headers:[],upgrade:!1},this.trailers=[],this.line="",this.isChunked=!1,this.connection="",this.headerSize=0,this.body_bytes=null,this.isUserCall=!1,this.hadError=!1};le.encoding="ascii";le.maxHeaderSize=80*1024;le.REQUEST="REQUEST";le.RESPONSE="RESPONSE";var sv=le.kOnHeaders=1,n2=le.kOnHeadersComplete=2,kf=le.kOnBody=3,h3=le.kOnMessageComplete=4;le.prototype[sv]=le.prototype[n2]=le.prototype[kf]=le.prototype[h3]=function(){};var ov=!0;Object.defineProperty(le,"kOnExecute",{get:function(){return ov=!1,99}});const av=le.methods=["DELETE","GET","HEAD","POST","PUT","CONNECT","OPTIONS","TRACE","COPY","LOCK","MKCOL","MOVE","PROPFIND","PROPPATCH","SEARCH","UNLOCK","BIND","REBIND","UNBIND","ACL","REPORT","MKACTIVITY","CHECKOUT","MERGE","M-SEARCH","NOTIFY","SUBSCRIBE","UNSUBSCRIBE","PATCH","PURGE","MKCALENDAR","LINK","UNLINK","SOURCE"];var cv=av.indexOf("CONNECT");le.prototype.reinitialize=le;le.prototype.close=le.prototype.pause=le.prototype.resume=le.prototype.remove=le.prototype.free=function(){};le.prototype._compatMode0_11=!1;le.prototype.getAsyncId=function(){return 0};var rU={REQUEST_LINE:!0,RESPONSE_LINE:!0,HEADER:!0};le.prototype.execute=function(r,e,t){if(!(this instanceof le))throw new TypeError("not a HTTPParser");e=e||0,t=typeof t=="number"?t:r.length,this.chunk=r,this.offset=e;var n=this.end=e+t;try{for(;this.offset<n&&!this[this.state](););}catch(i){if(this.isUserCall)throw i;return this.hadError=!0,i}return this.chunk=null,t=this.offset-e,rU[this.state]&&(this.headerSize+=t,this.headerSize>(this.maxHeaderSize||le.maxHeaderSize))?new Error("max header size exceeded"):t};var nU={REQUEST_LINE:!0,RESPONSE_LINE:!0,BODY_RAW:!0};le.prototype.finish=function(){if(!this.hadError){if(!nU[this.state])return new Error("invalid state for EOF");this.state==="BODY_RAW"&&this.userCall()(this[h3]())}};le.prototype.consume=le.prototype.unconsume=le.prototype.getCurrentBuffer=function(){};le.prototype.userCall=function(){this.isUserCall=!0;var r=this;return function(e){return r.isUserCall=!1,e}};le.prototype.nextRequest=function(){this.userCall()(this[h3]()),this.reinitialize(this.type)};le.prototype.consumeLine=function(){for(var r=this.end,e=this.chunk,t=this.offset;t<r;t++)if(e[t]===10){var n=this.line+Y(e.subarray(this.offset,t),le.encoding);return n.charAt(n.length-1)==="\r"&&(n=n.substr(0,n.length-1)),this.line="",this.offset=t+1,n}this.line+=Y(e.subarray(this.offset,this.end),le.encoding),this.offset=this.end};var iU=/^([^: \t]+):[ \t]*((?:.*[^ \t])|)/,sU=/^[ \t]+(.*[^ \t])/;le.prototype.parseHeader=function(r,e){if(r.indexOf("\r")!==-1)throw Cf("HPE_LF_EXPECTED");var t=iU.exec(r),n=t&&t[1];if(n)e.push(n),e.push(t[2]);else{var i=sU.exec(r);i&&e.length&&(e[e.length-1]&&(e[e.length-1]+=" "),e[e.length-1]+=i[1])}};var oU=/^([A-Z-]+) ([^ ]+) HTTP\/(\d)\.(\d)$/;le.prototype.REQUEST_LINE=function(){var r=this.consumeLine();if(r){var e=oU.exec(r);if(e===null)throw Cf("HPE_INVALID_CONSTANT");if(this.info.method=this._compatMode0_11?e[1]:av.indexOf(e[1]),this.info.method===-1)throw new Error("invalid request method");this.info.url=e[2],this.info.versionMajor=+e[3],this.info.versionMinor=+e[4],this.body_bytes=0,this.state="HEADER"}};var aU=/^HTTP\/(\d)\.(\d) (\d{3}) ?(.*)$/;le.prototype.RESPONSE_LINE=function(){var r=this.consumeLine();if(r){var e=aU.exec(r);if(e===null)throw Cf("HPE_INVALID_CONSTANT");this.info.versionMajor=+e[1],this.info.versionMinor=+e[2];var t=this.info.statusCode=+e[3];this.info.statusMessage=e[4],((t/100|0)===1||t===204||t===304)&&(this.body_bytes=0),this.state="HEADER"}};le.prototype.shouldKeepAlive=function(){if(this.info.versionMajor>0&&this.info.versionMinor>0){if(this.connection.indexOf("close")!==-1)return!1}else if(this.connection.indexOf("keep-alive")===-1)return!1;return!!(this.body_bytes!==null||this.isChunked)};le.prototype.HEADER=function(){var r=this.consumeLine();if(r!==void 0){var e=this.info;if(r)this.parseHeader(r,e.headers);else{for(var t=e.headers,n=!1,i,s=!1,o=0;o<t.length;o+=2)switch(t[o].toLowerCase()){case"transfer-encoding":this.isChunked=t[o+1].toLowerCase()==="chunked";break;case"content-length":if(i=+t[o+1],n){if(i!==this.body_bytes)throw Cf("HPE_UNEXPECTED_CONTENT_LENGTH")}else n=!0,this.body_bytes=i;break;case"connection":this.connection+=t[o+1].toLowerCase();break;case"upgrade":s=!0;break}this.isChunked&&n&&(n=!1,this.body_bytes=null),s&&this.connection.indexOf("upgrade")!=-1?e.upgrade=this.type===le.REQUEST||e.statusCode===101:e.upgrade=e.method===cv,this.isChunked&&e.upgrade&&(this.isChunked=!1),e.shouldKeepAlive=this.shouldKeepAlive();var a;if(ov?a=this.userCall()(this[n2](e)):a=this.userCall()(this[n2](e.versionMajor,e.versionMinor,e.headers,e.method,e.url,e.statusCode,e.statusMessage,e.upgrade,e.shouldKeepAlive)),a===2)return this.nextRequest(),!0;if(this.isChunked&&!a)this.state="BODY_CHUNKHEAD";else{if(a||this.body_bytes===0)return this.nextRequest(),e.upgrade;this.body_bytes===null?this.state="BODY_RAW":this.state="BODY_SIZED"}}}};le.prototype.BODY_CHUNKHEAD=function(){var r=this.consumeLine();r!==void 0&&(this.body_bytes=parseInt(r,16),this.body_bytes?this.state="BODY_CHUNK":this.state="BODY_CHUNKTRAILERS")};le.prototype.BODY_CHUNK=function(){var r=Math.min(this.end-this.offset,this.body_bytes);this.userCall()(this[kf](this.chunk.slice(this.offset,this.offset+r),0,r)),this.offset+=r,this.body_bytes-=r,this.body_bytes||(this.state="BODY_CHUNKEMPTYLINE")};le.prototype.BODY_CHUNKEMPTYLINE=function(){var r=this.consumeLine();if(r!==void 0){if(r!=="")throw new Error("Expected empty line");this.state="BODY_CHUNKHEAD"}};le.prototype.BODY_CHUNKTRAILERS=function(){var r=this.consumeLine();r!==void 0&&(r?this.parseHeader(r,this.trailers):(this.trailers.length&&this.userCall()(this[sv](this.trailers,"")),this.nextRequest()))};le.prototype.BODY_RAW=function(){this.userCall()(this[kf](this.chunk.slice(this.offset,this.end),0,this.end-this.offset)),this.offset=this.end};le.prototype.BODY_SIZED=function(){var r=Math.min(this.end-this.offset,this.body_bytes);this.userCall()(this[kf](this.chunk.slice(this.offset,this.offset+r),0,r)),this.offset+=r,this.body_bytes-=r,this.body_bytes||this.nextRequest()};["Headers","HeadersComplete","Body","MessageComplete"].forEach(function(r){var e=le["kOn"+r];Object.defineProperty(le.prototype,"on"+r,{get:function(){return this[e]},set:function(t){return this._compatMode0_11=!0,cv="CONNECT",this[e]=t}})});function Cf(r){var e=new Error("Parse Error");return e.code=r,e}function cU(r){if(r!=null){if(typeof r[Symbol.iterator]=="function")return r[Symbol.iterator]();if(typeof r[Symbol.asyncIterator]=="function")return r[Symbol.asyncIterator]();if(typeof r.next=="function")return r}throw new Error("argument is not an iterator or iterable")}function lU(r,e={}){const t=cU(r),n={_cancelled:!1,async start(){this._cancelled=!1},async pull(i){try{const{value:s,done:o}=await t.next();if(this._cancelled)return;if(o===!0){i.close();return}i.enqueue(s)}catch(s){i.error(s)}},cancel(){this._cancelled=!0}};return new globalThis.ReadableStream(n,e)}const uU=r=>async e=>new Uint8Array(await crypto.subtle.digest(r,e)),dU=Vh({name:"sha-1",code:17,encode:uU("SHA-1")});class hU extends globalThis.Request{constructor(e,t={}){const n=t.method??"GET",i=Io(t),s=t.body;hv(n,i)&&(t.method="UPGRADE"),super(e,t),Object.defineProperties(this,{body:{value:s,writable:!1},method:{value:n,writable:!1},headers:{value:i,writable:!1}})}}const fU={100:"Continue",101:"Switching Protocols",102:"Processing",103:"Early Hints",200:"OK",201:"Created",202:"Accepted",203:"Non-Authoritative Information",204:"No Content",205:"Reset Content",206:"Partial Content",207:"Multi-Status",208:"Already Reported",226:"IM Used",300:"Multiple Choices",301:"Moved Permanently",302:"Found",303:"See Other",304:"Not Modified",305:"Use Proxy",307:"Temporary Redirect",308:"Permanent Redirect",400:"Bad Request",401:"Unauthorized",402:"Payment Required",403:"Forbidden",404:"Not Found",405:"Method Not Allowed",406:"Not Acceptable",407:"Proxy Authentication Required",408:"Request Timeout",409:"Conflict",410:"Gone",411:"Length Required",412:"Precondition Failed",413:"Payload Too Large",414:"URI Too Long",415:"Unsupported Media Type",416:"Range Not Satisfiable",417:"Expectation Failed",418:"I'm a Teapot",421:"Misdirected Request",422:"Unprocessable Entity",423:"Locked",424:"Failed Dependency",425:"Too Early",426:"Upgrade Required",428:"Precondition Required",429:"Too Many Requests",431:"Request Header Fields Too Large",451:"Unavailable For Legal Reasons",500:"Internal Server Error",501:"Not Implemented",502:"Bad Gateway",503:"Service Unavailable",504:"Gateway Timeout",505:"HTTP Version Not Supported",506:"Variant Also Negotiates",507:"Insufficient Storage",508:"Loop Detected",509:"Bandwidth Limit Exceeded",510:"Not Extended",511:"Network Authentication Required"};let Sc=class extends globalThis.Response{constructor(e,t={}){const n=Io(t),i=t.status??200;(i<200||i>599)&&(t.status=200),super(e,t),Object.defineProperties(this,{status:{value:i,writable:!1},statusText:{value:fU[i],writable:!1},headers:{value:n,writable:!1}})}};const pU=["dns","dns4","dns6","dnsaddr"];function i2(r,e){if(r instanceof URL)return r;const t=o2(r,e),{httpPath:n}=a2(r);return new URL(`http://${t}${n}`)}function s2(r){return r instanceof Uint8Array?r:r instanceof DataView?new Uint8Array(r.buffer,r.byteOffset,r.byteLength):new Uint8Array(r,0,r.byteLength)}function gU(r,e){const t={method:r.method,headers:r.headers};if((t.method!=="GET"||r.upgrade)&&t.method!=="HEAD"){let n=e;r.upgrade||(n=wU(e,r.headers.get("content-length"))),t.body=lU(n),t.duplex="half"}return new hU(dv(r).toString(),t)}async function mU(r,e){if(e.send(W([`HTTP/1.1 ${r.status} ${r.statusText}`,...lv(r.headers),"",""].join(`\r
`))),r.body==null){await e.close().catch(n=>{e.abort(n)});return}const t=r.body.getReader();for(;;){const n=await t.read();if(n.value!=null&&(e.send(n.value)||await e.onDrain()),n.done)break}await e.close().catch(n=>{e.abort(n)})}const yU=W(["HTTP/1.1 404 Not Found","Connection: close","",""].join(`\r
`));W(["HTTP/1.1 400 Bad Request","Connection: close","",""].join(`\r
`));W(["HTTP/1.1 500 Internal Server Error","Connection: close","",""].join(`\r
`));W(["HTTP/1.1 501 Not Implemented","Connection: close","",""].join(`\r
`));function lv(r){const e=[];r.get("Connection")==null&&r.set("Connection","close");for(const[t,n]of r.entries())e.push(`${t}: ${n}`);return e}async function*wU(r,e){if(e=parseInt(`${e??""}`),e==null||isNaN(e))return r;let t=0;for await(const n of r){if(t+=n.byteLength,t>e){yield n.subarray(0,t-e);return}if(yield n.subarray(),t===e)return}}function za(r,e){if(typeof r=="string"&&(r.startsWith("/")?r=be(r):r=new URL(r)),Ii(r)&&(r=be(`/p2p/${r}`)),r instanceof URL&&r.protocol==="multiaddr:"&&(r=m9(r.toString())),Sl(r)&&(r=[r]),Array.isArray(r)){for(const t of r)if(t.getComponents().some(({name:i})=>i==="http")){const i=ef(t);return new URL(`${i}${e??""}`)}}return e==null?r:r instanceof URL?new URL(`${r}${e.substring(1)}`):r.map(t=>t.encapsulate(`/http-path/${encodeURIComponent(e.substring(1))}`))}function Io(r={}){return r.headers instanceof Headers||(r.headers=new Headers(r.headers)),r.headers}function Ha(r){return r!=null&&r!==""}function o2(r,e){let t,n=80,i="http:";if(r instanceof URL&&(t=r.hostname,n=parseInt(r.port,10),i=r.protocol),Ha(t)||(t=e.get("host")??void 0),!Ha(t)&&Array.isArray(r))for(const s of r){const a=s.getComponents().filter(({name:c})=>pU.includes(c))?.[0]?.value;if(a!=null){t=a;break}}if(!Ha(t)&&Array.isArray(r))for(const s of r){const o=s.getComponents().findLast(a=>a.code===ge)?.value;try{const a=Ne(s);a.port!=null&&(n=a.port)}catch{}if(o!=null){t=or(o).toCID().toString(_i);break}}if(!Ha(t)&&Array.isArray(r))for(const s of r)try{const o=Ne(s);o.host!=null&&(t=o.host);break}catch{}if(Ha(t))return i==="http:"&&n!==80&&(t=`${t}:${n}`),i==="https:"&&n!==443&&(t=`${t}:${n}`),t;throw new H("Could not determine request host name - a request must have a host header, be made to a DNS or IP-based multiaddr or an http(s) URL")}function a2(r){let e="/";return r=r.map(t=>be(t.getComponents().filter(n=>n.name==="http-path"?(e=n.value??"/",!1):!0))),{httpPath:e,addresses:r}}function uv(r,e=["GET"]){return r==null?e:(typeof r=="string"&&(r=[r]),r.map(t=>t.toUpperCase()))}function dv(r){const e=r.url??"/";if(e.startsWith("http"))return new URL(e);const t=bU(r);return new URL(`http://${t}${e}`)}function bU(r){let e=r.headers?.host;if(e==null&&(e=r.headers?.Host),e==null&&typeof r.headers.get=="function"&&(e=r.headers.get("host")),e==null)throw new H("Could not read host");return e}function hv(r,e){return r==="GET"&&e.get("connection")?.toLowerCase()==="upgrade"&&e.get("upgrade")?.toLowerCase()==="websocket"}function Hy(r,e){if(r instanceof Headers)return r.get(e)??void 0;const t=r[e];return Array.isArray(t)?t.join(","):t}async function vU(r){if(Hy(r,"sec-websocket-version")!=="13")throw new p0("Invalid version");const e=Hy(r,"sec-websocket-key");if(e==null)throw new p0("Missing sec-websocket-key");const t=`${e}258EAFA5-E914-47DA-95CA-C5AB0DC85B11`,n=await dU.digest(W(t)),i=Up.encode(n.digest).substring(1);return new Headers({Upgrade:"websocket",Connection:"upgrade","Sec-WebSocket-Accept":i})}async function EU(r,e){const t=new le("REQUEST"),n=new me;let i;t[le.kOnHeadersComplete]=s=>{const o=new Headers;for(let a=0;a<s.headers.length;a+=2)o.set(s.headers[a].toLowerCase(),s.headers[a+1]);i={...s,headers:o,raw:n,method:le.methods[s.method]}};try{for(;;){const{data:s}=await bn(r,"message",e?.signal),o=s.subarray(),a=t.execute(o,0,o.byteLength);if(a instanceof Error)throw a;if(n.append(o.subarray(0,a)),a<o.byteLength&&r.push(o.subarray(a)),i!=null)return i}}catch(s){r.abort(s)}finally{t.finish()}throw new Error("Failed to read header info from request")}class SU extends Error{static name="InvalidResponseError";name="InvalidResponseError"}const xU=[101,204,205,304];async function AU(r,e,t){const n=Promise.withResolvers(),i=new TransformStream,s=i.writable.getWriter();let o=!1;const a=new le("RESPONSE");a.maxHeaderSize=t.maxHeaderSize??le.maxHeaderSize,a[le.kOnHeadersComplete]=l=>{t.log("response headers complete"),o=!0;const u=new Headers;for(let f=0;f<l.headers.length;f+=2)u.append(l.headers[f],l.headers[f+1]);let d=i.readable;xU.includes(l.statusCode)&&(i.writable.close().catch(()=>{}),i.readable.cancel().catch(()=>{}),d=null);const h=new Sc(d,{status:l.statusCode,statusText:l.statusMessage,headers:u});n.resolve(h)},a[le.kOnBody]=l=>{t.log("response read body %d bytes",l.byteLength),s.write(l).catch(u=>{n.reject(u)})},a[le.kOnMessageComplete]=()=>{t.log("response message complete"),s.close().catch(l=>{n.reject(l)})};let c=0;return r.addEventListener("message",({data:l})=>{t.log("response stream read %d bytes",l.byteLength),c+=l.byteLength;const u=a.execute(l.subarray(),0,l.byteLength);u instanceof Error&&(r.abort(u),a.finish())}),r.addEventListener("remoteCloseWrite",()=>{o||n.reject(new SU(`Response ended before headers were received, read ${c} bytes`)),a.finish()}),n.promise}function kU(r,e){return e.set("Content-Length",`${r.size}`),e.set("Content-Type",r.type!=null&&r.type!==""?r.type:"application/octet-stream"),r.stream()}function CU(r,e){return e.set("Content-Length",`${r.byteLength}`),e.set("Content-Type","application/octet-stream"),new ReadableStream({start(t){t.enqueue(s2(r)),t.close()}})}function IU(r,e,t){const n=[`--${t}`];let i=0;const s=2;return typeof e=="string"?(n.push(`Content-Disposition: form-data; name="${r}"`,'Content-Type: text/plain; charset="UTF-8"',`Content-Length: ${e.length}`,""),i=e.length+s):(n.push(`Content-Disposition: form-data; name="${r}"; filename="${encodeURIComponent(e.name)}"`,"Content-Type: application/octet-stream",`Content-Length: ${e.size}`,""),i=e.size+s),W(n.join(`\r
`)).byteLength+i}function _U(r,e){const t=`-----------------------------${crypto.randomUUID()}`;e.set("Content-Type",`multipart/form-data; boundary=${t}`);let n=0;for(const[c,l]of r.entries())n+=IU(c,l,t);e.set("Content-Length",`${n}`);const i=r.entries();let s;function o(c,l,u,d){const h=[`--${d}`];typeof u=="string"?h.push(`Content-Disposition: form-data; name="${l}"`,'Content-Type: text/plain; charset="UTF-8"',`Content-Length: ${u.length}`,"",u,""):(h.push(`Content-Disposition: form-data; name="${l}"; filename="${encodeURIComponent(u.name)}"`,"Content-Type: application/octet-stream",`Content-Length: ${u.size}`,""),s=u.stream().getReader()),c.enqueue(W(h.join(`\r
`)))}async function a(c,l){if(s!=null){const h=await s.read();h.value!=null&&c.enqueue(h.value),h.done&&(c.enqueue(W(`\r
`)),s=void 0);return}const{done:u,value:d}=i.next();if(d!=null){const[h,f]=d;o(c,h,f,l)}u===!0&&c.close()}return new ReadableStream({async pull(c){await a(c,t)}})}function TU(r,e){e.set("Content-Type","application/octet-stream"),e.set("Transfer-Encoding","chunked");const t=r.getReader();return new ReadableStream({async pull(n){const{done:i,value:s}=await t.read();s!=null&&(n.enqueue(W(`${s.byteLength}\r
`)),n.enqueue(s),n.enqueue(W(`\r
`))),i&&(n.enqueue(W(`0\r
\r
`)),n.close())}})}function qy(r,e){return e.set("Content-Length",`${r.length}`),e.set("Content-Type",'text/plain; charset="UTF-8"'),new ReadableStream({start(t){t.enqueue(W(r)),t.close()}})}function PU(r,e){if(r!=null){if(typeof r=="string")return qy(r,e);if(r instanceof Blob)return kU(r,e);if(RU(r))return CU(r,e);if(r instanceof URLSearchParams)return qy(r.toString(),e);if(r instanceof ReadableStream)return TU(r,e);if(r instanceof FormData)return _U(r,e);throw new Error("Unsupported body type")}}function RU(r){return r==null?!1:r.byteLength!=null}async function NU(r,e,t){const n=new Headers(t.headers),i=n.get("host")??e.hostname;n.set("host",i),n.get("user-agent")==null&&n.set("user-agent","libp2p/fetch");const s=PU(t.body,n),o=[`${t?.method?.toUpperCase()??"GET"} ${e.pathname??"/"} HTTP/1.1`,...lv(n),"",""];r.send(W(o.join(`\r
`)))||await r.onDrain({signal:t.signal??void 0}),s!=null&&(t.log("request sending body"),await DU(r,s,t))}async function DU(r,e,t){const n=e.getReader();for(;;){const{done:i,value:s}=await n.read();if(s!=null&&(t.log("request send %d bytes",s.byteLength),r.send(s)||await r.onDrain({signal:t.signal??void 0})),i){t.log("request finished sending body");break}}}async function BU(r,e,t={}){const n=r.log.newScope("http-fetch");e=typeof e=="string"?new URL(e):e;const[i]=await Promise.all([AU(r,e,{...t,log:n}),NU(r,e,{...t,log:n})]);return await r.close({signal:t.signal??void 0}),i}class LU extends Event{message;error;filename="";lineno=0;colno=0;constructor(e){super("error"),this.error=e,this.message=e.message}}class Ky extends Event{code;reason;wasClean;constructor(e,t){super(e),this.code=t?.code??0,this.reason=t?.reason??"",this.wasClean=t?.wasClean??!0}}const OU={CONTINUATION:0,TEXT:1,BINARY:2,CONNECTION_CLOSE:8,PING:9,PONG:10},Q1={0:"CONTINUATION",1:"TEXT",2:"BINARY",8:"CONNECTION_CLOSE",9:"PING",10:"PONG"},fv={NORMAL_CLOSURE:1e3,MESSAGE_TOO_BIG:1009};function MU(r){let e=0;if(r.byteLength<e+1)return;const n=r.get(e)&15;if(e++,Q1[n]==null)throw new Error(`Unknown opcode: ${n}`);if(r.byteLength<e+1)return;const i=r.get(e),s=(i&128)===128;let o=i&127;if(e++,o===126){if(r.byteLength<e+2)return;o=r.getUint16(e),e+=2}else if(o===127){if(r.byteLength<e+8)return;o=r.getUint32(e),e+=8}if(o===0)return r.consume(e),{type:Q1[n]};let a;if(s){if(r.byteLength<e+4)return;a=r.subarray(e,e+4),e+=4}if(r.byteLength<e+o)return;let c=r.subarray(e,e+o);return e+=o,a!=null&&(c=pv(c,a)),r.consume(e),{type:Q1[n],data:c}}function pv(r,e){let t=0;for(let n=0;n<r.byteLength;n++)r[n]=r[n]^e[t],t++,t===e.byteLength&&(t=0);return r}function $U(r,e,t){const n=new me(Uint8Array.from([128|OU[r]])),i=e?.byteLength??0;if(i<126)n.append(Uint8Array.from([i|(t===!0?128:0)]));else if(i<65535){const s=new me(new Uint8Array(3));s.set(0,126|(t===!0?128:0)),s.setUint16(1,i),n.append(s)}else if(i<18446744073709552e3){const s=new me(new Uint8Array(9));s.set(0,127|(t===!0?128:0)),s.setUint32(1,i),n.append(s)}else throw new Error("Payload too large");if(t===!0&&e!=null){const s=Uint8Array.from([0,0,0,0]);n.append(s),e=pv(e,s)}return e!=null&&n.append(e),n}function UU(r){if(r instanceof Uint8Array||r instanceof ArrayBuffer||r instanceof DataView)return s2(r);if(typeof r=="string")return W(r);if(r instanceof Blob)return r.arrayBuffer().then(e=>s2(e));throw new H("Unsupported data type")}async function FU(r,e){return new Promise((t,n)=>{let i=!1;const s=new le("RESPONSE");s[le.kOnHeadersComplete]=o=>{i=!0;const a=[];for(let c=0;c<o.headers.length;c+=2)a.push([o.headers[c],o.headers[c+1]]);t(new Sc(null,{status:o.statusCode,statusText:o.statusMessage,headers:new Headers(a)}))},Promise.resolve().then(async()=>{for(;;){const{data:o}=await bn(r,"message",e.signal),a=o.subarray(),c=s.execute(a,0,a.byteLength);if(c instanceof Error)throw c;if(c<a.byteLength&&r.push(a.subarray(c)),i)break}}).catch(o=>{n(o)})})}async function*VU(r,e=[],t){const n=Up.encode(crypto.getRandomValues(new Uint8Array(16))).substring(1);t.set("host",r.hostname),t.set("connection","upgrade"),t.set("upgrade","websocket"),t.set("pragma","no-cache"),t.set("cache-control","no-cache"),t.set("sec-websocket-version","13"),t.set("sec-websocket-key",n),e.length>0&&t.set("sec-websocket-protocol",e.join(", ")),yield W([`GET ${r.pathname??"/"} HTTP/1.1`,...[...t.entries()].map(([i,s])=>`${i}: ${s}`),"",""].join(`\r
`))}const zU=["BINARY","TEXT","CONTINUATION"],HU=10485760,qU="/http/1.1";class gv extends Qe{binaryType="arraybuffer";bufferedAmount=0;extensions="";protocol="";readyState;url;CONNECTING=0;OPEN=1;CLOSING=2;CLOSED=3;_onclose;_onerror;_onmessage;_onopen;sentClose;isClient;buffer;maxMessageSize;_url;closeController;constructor(e,t={}){super(),this.readyState=this.CONNECTING,this.url=e.pathname,this.sentClose=!1,this.isClient=t.isClient??!0,this.buffer=new me,this.closeController=new AbortController,this.maxMessageSize=t.maxMessageSize??HU}send(e){if(this.readyState!==this.OPEN)throw new Error("WebSocket was not open");const t=UU(e);L7(t)?t.then(n=>{this._send("BINARY",n)}).catch(n=>{this._errored(n)}):this._send("BINARY",t)}_send(e,t){if(this.readyState!==this.OPEN)return;const n=$U(e,t,this.isClient),i=n.byteLength;this.bufferedAmount+=i,this._write(n,s=>{this.bufferedAmount-=i,s!=null&&this._errored(s)})}close(e,t){if(this.readyState!==this.OPEN)throw new Error("WebSocket was not open");this.readyState=this.CLOSING,this.sentClose=!0,this._send("CONNECTION_CLOSE")}_errored(e){this.readyState=this.CLOSED,this.dispatchEvent(new LU(e))}set onclose(e){this._onclose=e,this.addEventListener("close",e)}get onclose(){return this._onclose??null}set onerror(e){this._onerror=e,this.addEventListener("error",e)}get onerror(){return this._onerror??null}set onmessage(e){this._onmessage=e,this.addEventListener("message",e)}get onmessage(){return this._onmessage??null}set onopen(e){this._onopen=e,this.addEventListener("open",e)}get onopen(){return this._onopen??null}_push(e){if(this.buffer.append(e),this.buffer.byteLength>this.maxMessageSize){this.close(fv.MESSAGE_TOO_BIG,"Max message size exceeded");return}for(;;){const t=MU(this.buffer);if(t==null)break;if(zU.includes(t.type)&&t.data!=null){let n;this.binaryType==="blob"?n=new Blob([t.data]):t.data.byteOffset===0&&t.data.byteLength===t.data.buffer.byteLength?n=t.data.buffer:(n=new ArrayBuffer(t.data.byteLength),new Uint8Array(n,0,n.byteLength).set(t.data)),this.dispatchEvent(new MessageEvent("message",{data:n,origin:this._url?.hostname}))}t.type==="PING"&&this._send("PONG",t.data),t.type==="CONNECTION_CLOSE"&&(this.sentClose||this.close(),this.closeController.abort(),this._close(void 0,()=>{this.readyState=this.CLOSED,this.dispatchEvent(new Ky("close"))}))}}_remoteClosed(e){this.readyState=this.CLOSING,this._close(e,()=>{this.readyState=this.CLOSED,this.dispatchEvent(new Ky("close"))})}}class KU extends gv{writer;writable;constructor(e,t,n={}){if(super(new URL(e.url),{...n,isClient:!1}),e.body==null)throw new H("Request body cannot be null");this.readyState=this.OPEN,this.writable=t,this.writer=t.getWriter();const i=e.body.getReader();Promise.resolve().then(async()=>{for(this.dispatchEvent(new Event("open"));;){const{value:s,done:o}=await i.read();if(s!=null&&this._push(s),o){this._remoteClosed();break}}}).catch(s=>{this._errored(s)})}_write(e,t){this.writer?.write(e).then(()=>{t()},n=>{t(n)})}_close(e,t){e!=null?this.writable.abort(e).then(()=>{t()},()=>{t()}):this.writable.close().then(()=>{t()},()=>{t()})}}let WU=class extends gv{stream;handshakeTimeout;drainTimeout;constructor(e,t,n,i){super(t,{...i,isClient:!0}),this.handshakeTimeout=i.handshakeTimeout??1e4,this.drainTimeout=i.drainTimeout??1e4,Promise.resolve().then(async()=>{const s=AbortSignal.timeout(this.handshakeTimeout);this.stream=await n.openStream(e,qU,{...i,signal:s});for await(const a of VU(t,i.protocols,Io(i)))this.stream.send(a)||await this.stream.onDrain({signal:s});const o=await FU(this.stream,{signal:s});if(o.status!==101)throw new Error("Invalid WebSocket handshake - response status "+o.status);await i.onHandshakeResponse?.(o,{signal:s}),this.protocol=o.headers.get("Sec-WebSocket-Protocol")??"",this.readyState=this.OPEN,this.dispatchEvent(new Event("open"));for await(const a of this.stream)this._push(a)}).catch(s=>{this._errored(s)})}_write(e,t){if(this.stream==null){t(new Error("WebSocket was not open"));return}this.stream.send(e)?t():this.stream.onDrain({signal:AbortSignal.timeout(this.drainTimeout)}).then(()=>{t()},n=>{t(n)})}_close(e,t){if(this.stream==null){t();return}if(e!=null){this.stream.abort(e),t();return}this.stream.close().catch(n=>{this.stream?.abort(n)}).finally(()=>{t()})}};const c2="/http/1.1",mv=Symbol.for("@libp2p/http/websocket-handler");var qr={},Wy;function jU(){if(Wy)return qr;Wy=1,Object.defineProperty(qr,"__esModule",{value:!0}),qr.parseCookie=a,qr.parse=a,qr.stringifyCookie=c,qr.stringifySetCookie=l,qr.serialize=l,qr.parseSetCookie=u,qr.stringifySetCookie=l,qr.serialize=l;const r=/^[\u0021-\u003A\u003C\u003E-\u007E]+$/,e=/^[\u0021-\u003A\u003C-\u007E]*$/,t=/^([.]?[a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?)([.][a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?)*$/i,n=/^[\u0020-\u003A\u003D-\u007E]*$/,i=/^-?\d+$/,s=Object.prototype.toString,o=(()=>{const p=function(){};return p.prototype=Object.create(null),p})();function a(p,b){const A=new o,v=p.length;if(v<2)return A;const C=b?.decode||y;let T=0;do{const R=h(p,T,v);if(R===-1)break;const L=d(p,T,v);if(R>L){T=p.lastIndexOf(";",R-1)+1;continue}const N=f(p,T,R);A[N]===void 0&&(A[N]=C(f(p,R+1,L))),T=L+1}while(T<v);return A}function c(p,b){const A=b?.encode||encodeURIComponent,v=[];for(const C of Object.keys(p)){const T=p[C];if(T===void 0)continue;if(!r.test(C))throw new TypeError(`cookie name is invalid: ${C}`);const R=A(T);if(!e.test(R))throw new TypeError(`cookie val is invalid: ${T}`);v.push(`${C}=${R}`)}return v.join("; ")}function l(p,b,A){const v=typeof p=="object"?p:{...A,name:p,value:String(b)},T=(typeof b=="object"?b:A)?.encode||encodeURIComponent;if(!r.test(v.name))throw new TypeError(`argument name is invalid: ${v.name}`);const R=v.value?T(v.value):"";if(!e.test(R))throw new TypeError(`argument val is invalid: ${v.value}`);let L=v.name+"="+R;if(v.maxAge!==void 0){if(!Number.isInteger(v.maxAge))throw new TypeError(`option maxAge is invalid: ${v.maxAge}`);L+="; Max-Age="+v.maxAge}if(v.domain){if(!t.test(v.domain))throw new TypeError(`option domain is invalid: ${v.domain}`);L+="; Domain="+v.domain}if(v.path){if(!n.test(v.path))throw new TypeError(`option path is invalid: ${v.path}`);L+="; Path="+v.path}if(v.expires){if(!m(v.expires)||!Number.isFinite(v.expires.valueOf()))throw new TypeError(`option expires is invalid: ${v.expires}`);L+="; Expires="+v.expires.toUTCString()}if(v.httpOnly&&(L+="; HttpOnly"),v.secure&&(L+="; Secure"),v.partitioned&&(L+="; Partitioned"),v.priority)switch(typeof v.priority=="string"?v.priority.toLowerCase():void 0){case"low":L+="; Priority=Low";break;case"medium":L+="; Priority=Medium";break;case"high":L+="; Priority=High";break;default:throw new TypeError(`option priority is invalid: ${v.priority}`)}if(v.sameSite)switch(typeof v.sameSite=="string"?v.sameSite.toLowerCase():v.sameSite){case!0:case"strict":L+="; SameSite=Strict";break;case"lax":L+="; SameSite=Lax";break;case"none":L+="; SameSite=None";break;default:throw new TypeError(`option sameSite is invalid: ${v.sameSite}`)}return L}function u(p,b){const A=b?.decode||y,v=p.length,C=d(p,0,v),T=h(p,0,C),R=T===-1?{name:"",value:A(f(p,0,C))}:{name:f(p,0,T),value:A(f(p,T+1,C))};let L=C+1;for(;L<v;){const N=d(p,L,v),E=h(p,L,N),O=E===-1?f(p,L,N):f(p,L,E),V=E===-1?void 0:f(p,E+1,N);switch(O.toLowerCase()){case"httponly":R.httpOnly=!0;break;case"secure":R.secure=!0;break;case"partitioned":R.partitioned=!0;break;case"domain":R.domain=V;break;case"path":R.path=V;break;case"max-age":V&&i.test(V)&&(R.maxAge=Number(V));break;case"expires":if(!V)break;const $=new Date(V);Number.isFinite($.valueOf())&&(R.expires=$);break;case"priority":if(!V)break;const I=V.toLowerCase();(I==="low"||I==="medium"||I==="high")&&(R.priority=I);break;case"samesite":if(!V)break;const k=V.toLowerCase();(k==="lax"||k==="strict"||k==="none")&&(R.sameSite=k);break}L=N+1}return R}function d(p,b,A){const v=p.indexOf(";",b);return v===-1?A:v}function h(p,b,A){const v=p.indexOf("=",b);return v<A?v:-1}function f(p,b,A){let v=b,C=A;do{const T=p.charCodeAt(v);if(T!==32&&T!==9)break}while(++v<C);for(;C>v;){const T=p.charCodeAt(C-1);if(T!==32&&T!==9)break;C--}return p.slice(v,C)}function y(p){if(p.indexOf("%")===-1)return p;try{return decodeURIComponent(p)}catch{return p}}function m(p){return s.call(p)==="[object Date]"}return qr}var GU=jU();const YU=Us(GU);class QU{log;cookies;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:http:cookies"),this.cookies=new Map}async prepareRequest(e,t){if((t.credentials??"same-origin")==="omit")return;const i=t.headers.get("origin");if(i==null||i==="null")return;const s=i2(e,t.headers),o=(this.cookies.get(s.hostname)??[]).filter(a=>!(a.expires!=null&&a.expires<Date.now()||a.path!=null&&!s.pathname.startsWith(a.path))).map(a=>`${a.name}=${a.value}`).join("; ");o.length>0&&t.headers.set("cookie",o)}async processResponse(e,t,n){if((t.credentials??"same-origin")==="omit"){jy(n);return}const s=t.headers.get("origin");if(s==null||s==="null")return;const o=i2(e,t.headers);for(const a of n.headers.getSetCookie()){const c=[...this.cookies.get(o.hostname)??[],...XU(YU.parse(a))];this.cookies.set(o.hostname,c)}jy(n)}}function jy(r){return r.headers.has("set-cookie")&&r.headers.delete("set-cookie"),r}function XU(r){const e={},t=[];return Object.entries(r).forEach(([n,i])=>{n.toLowerCase()==="domain"&&i!=null&&(e.domain=i),n.toLowerCase()==="max-age"&&i!=null&&(e.expires=Date.now()+parseInt(i,10)*1e3),!ZU.includes(n.toLowerCase())&&i!=null&&t.push({name:n,value:i})}),t.map(n=>({...n,...e}))}const ZU=["domain","expires","httponly","max-age","partitioned","path","samesite","secure"];class JU{async prepareRequest(e,t){if(t.headers.get("origin")!=null||t.mode==="no-cors")return;const n=i2(e,t.headers);t.headers.set("origin",`${n.protocol}//${n.host}`)}}function eF(r){return typeof r.init=="function"}function yv(r,e){if(eF(r)){const t=r;return t.handler=r.init(e),delete t.init,t}return r}function tF(r){const e=uv(r.method,["GET"]);if(r.fallback==null&&e.filter(n=>n!=="GET").length>0)throw new H("WebSocket handlers only support the GET HTTP method");const t={...r,init:n=>{const i=yv(r,n);return t[mv]=i.handler,async s=>{if(!hv(s.method,s.headers))return r?.fallback!=null?r.fallback(s):new Sc(null,{status:400});const o=new TransformStream;try{const a=new Sc(o.readable,{status:101,headers:await vU(s.headers)}),c=new KU(s,o.writable,r);return i.handler(c),a}catch{return new Sc(null,{status:500})}}}};return t}const wv="/.well-known/libp2p/protocols";function rF(r){return tF({path:wv,method:["GET"],cors:!0,handler:e=>{const t=JSON.stringify(r.getProtocolMap());e.send(t),e.close()},fallback:async e=>{const t=JSON.stringify(r.getProtocolMap());return new Response(t,{headers:{"Content-Type":"application/json","Content-Length":`${t.length}`}})}})}class nF{log;components;protocols;endpoint;constructor(e,t={}){this.components=e,this.log=e.logger.forComponent("libp2p:http:registrar"),this.protocols=[],this.onStream=this.onStream.bind(this),this.endpoint=t.server,this.handle("",rF(this))}async start(){await this.components.registrar.handle(c2,this.onStream.bind(this))}async stop(){await this.components.registrar.unhandle(c2)}async onStream(e,t){const n=await EU(e);if(this.canHandle(n)){this.log("handling incoming request %s %s",n.method,n.url);const i=await this.onRequest(gU(n,e));await mU(i,e),await e.close();return}if(this.endpoint==null){this.log("cannot handle incoming request %s %s and no endpoint configured",n.method,n.url),e.send(yU),await e.close();return}this.log("passing incoming request %s %s to endpoint",n.method,n.url),this.endpoint.inject(n,e,t).catch(i=>{this.log.error("error injecting request to endpoint - %e",i),e.abort(i)})}canHandle(e){const t=dv(e).pathname;return this.protocols.find(n=>n.route.path===t)!=null?(this.log.trace("can handle %s",t),!0):(this.log.trace("cannot handle %s",t),!1)}async onRequest(e){this.log("incoming request %s %s",e.method,e.url);const t=this.findHandler(e.url);if(t==null)return new Response(null,{status:404});let n;return t.route.method.includes(e.method)?n=await t.route.handler(e):e.method==="OPTIONS"?n=new Response(null,{status:204}):n=new Response(null,{status:405}),iF(n,e,t),this.log("%s %s %d %s",e.method,e.url,n.status,n.statusText),n}onWebSocket(e){const t=this.findHandler(e.url);if(t!=null){const n=t.route[mv];if(n!=null){n(e);return}}e.close(fv.NORMAL_CLOSURE)}findHandler(e){const t=e.startsWith("/")?e:new URL(e).pathname;this.log("search for handler on path %s",t);const n=this.protocols.find(i=>i.route.path===t);return n!=null&&this.log("found handler for HTTP protocol %s on path %s",n.protocol,e),n}handle(e,t){if(t.path=t.path??e,this.protocols.find(n=>n.protocol===e)!=null)throw new H(`HTTP protocol handler for ${e} already registered`);(t.path===""||!t.path.startsWith("/"))&&(t.path=`/${t.path}`),t.cors=t.cors??!0,t.method=uv(t.method),t=yv(t,this.components),this.protocols.push({protocol:e,route:t}),this.protocols.sort(({route:{path:n}},{route:{path:i}})=>i.length-n.length)}unhandle(e){this.protocols=this.protocols.filter(t=>t.protocol===e)}getProtocolMap(){const e={};for(const t of this.protocols)t.protocol!==""&&(e[t.protocol]={path:t.route.path});return e}}function iF(r,e,t){const n=[...new Set(["OPTIONS",...t.route.method])].join(", ");t.route.cors&&(e.headers.get("Access-Control-Request-Method")!=null&&r.headers.set("access-control-allow-methods",n),e.headers.get("Access-Control-Request-Headers")!=null&&r.headers.set("access-control-allow-headers",e.headers.get("Access-Control-Request-Headers")??""),e.headers.get("Origin")!=null&&(r.headers.set("access-control-allow-origin",e.headers.get("Origin")??""),r.headers.set("vary","Origin"))),e.method==="OPTIONS"&&r.headers.set("allow",n)}async function sF(r,e,t){for(const n of e.middleware)await n.prepareRequest?.(r,e);return t()}async function oF(r,e,t){for(const n of e.middleware)await n.prepareRequest?.(r,e);return t()}async function aF(r,e,t){for(const n of e.middleware)await n.processResponse?.(r,e,t);return t}class cF{log;components;httpRegistrar;origin;cookies;constructor(e,t={}){this.components=e,this.log=e.logger.forComponent("libp2p:http"),this.httpRegistrar=new nF(e,t),this.origin=new JU,this.cookies=new QU(e,t)}[Symbol.toStringTag]="@libp2p/http";[It]=["@libp2p/http"];async start(){await Cn(this.httpRegistrar)}async stop(){await ni(this.httpRegistrar)}agent(...e){throw new p4("This method is not supported in browsers")}dispatcher(...e){throw new p4("This method is not supported in browsers")}async connect(e,t={}){const n=za(e),i=Io(t),s={...t,headers:i,method:"GET",middleware:t.middleware?.map(o=>o(this.components))??[]};return i.set("connection","upgrade"),i.set("upgrade","websocket"),oF(n,s,async()=>{if(n instanceof URL){const c=new globalThis.WebSocket(n,t.protocols);return c.binaryType="arraybuffer",c}const{addresses:o,httpPath:a}=a2(n);return new WU(o,new URL(`http://${o2(n,s.headers)}${decodeURIComponent(a)}`),this.components.connectionManager,s)})}async fetch(e,t={}){const n=za(e),i={...t,headers:Io(t),method:"GET",middleware:[this.origin,this.cookies,...t.middleware?.map(o=>o(this.components))??[]]},s=await sF(n,i,async()=>this.sendRequest(n,t));return aF(n,i,s)}async connectProtocol(e,t,n){const i=await this.getProtocolPath(e,t,n),s=za(e,i);return this.connect(s,n)}async fetchProtocol(e,t,n={}){const i=await this.getProtocolPath(e,t,n),s=za(e,i);return this.fetch(s,n)}async getSupportedProtocols(e,t={}){const n=za(e,wv),i=await this.fetch(n,{method:"GET",headers:{Accept:"application/json"},signal:t.signal});if(i.status!==200)throw new Error(`Unexpected status code: ${i.status}`);return i.json()}async getProtocolPath(e,t,n={}){const i=await this.getSupportedProtocols(e,n);if(i[t]==null)throw new Error(`Peer does not serve protocol: ${t}`);return i[t].path}canHandle(e){return this.httpRegistrar.canHandle(e)}async onRequest(e){return this.httpRegistrar.onRequest(e)}onWebSocket(e){this.httpRegistrar.onWebSocket(e)}handle(e,t){this.httpRegistrar.handle(e,t)}unhandle(e){this.httpRegistrar.unhandle(e)}getProtocolMap(){return this.httpRegistrar.getProtocolMap()}async sendRequest(e,t){if(e instanceof URL)return this.log("making request to %s with global fetch"),globalThis.fetch(e,t);this.log("making request to %s with libp2p fetch",e);const n=o2(e,Io(t)),{addresses:i,httpPath:s}=a2(e),a=await(await this.components.connectionManager.openConnection(i,{signal:t.signal??void 0})).newStream(c2,{signal:t.signal??void 0});return BU(a,new URL(`http://${n}${decodeURIComponent(s)}`),t)}}function lF(r={}){return e=>new cF(e,r)}const uF="0.1.0",dF="id",hF="id/push",fF="1.0.0",pF="1.0.0",gF=1024*8,mF=32,yF=1e3;var Go;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,i={})=>{if(i.lengthDelimited!==!1&&n.fork(),t.protocolVersion!=null&&(n.uint32(42),n.string(t.protocolVersion)),t.agentVersion!=null&&(n.uint32(50),n.string(t.agentVersion)),t.publicKey!=null&&(n.uint32(10),n.bytes(t.publicKey)),t.listenAddrs!=null)for(const s of t.listenAddrs)n.uint32(18),n.bytes(s);if(t.observedAddr!=null&&(n.uint32(34),n.bytes(t.observedAddr)),t.protocols!=null)for(const s of t.protocols)n.uint32(26),n.string(s);t.signedPeerRecord!=null&&(n.uint32(66),n.bytes(t.signedPeerRecord)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{const s={listenAddrs:[],protocols:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 5:{s.protocolVersion=t.string();break}case 6:{s.agentVersion=t.string();break}case 1:{s.publicKey=t.bytes();break}case 2:{if(i.limits?.listenAddrs!=null&&s.listenAddrs.length===i.limits.listenAddrs)throw new Mt('Decode error - map field "listenAddrs" had too many elements');s.listenAddrs.push(t.bytes());break}case 4:{s.observedAddr=t.bytes();break}case 3:{if(i.limits?.protocols!=null&&s.protocols.length===i.limits.protocols)throw new Mt('Decode error - map field "protocols" had too many elements');s.protocols.push(t.string());break}case 8:{s.signedPeerRecord=t.bytes();break}default:{t.skipType(a&7);break}}}return s})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ae(t,r.codec(),n)})(Go||(Go={}));const Rr={protocolPrefix:"ipfs",timeout:5e3,maxInboundStreams:1,maxOutboundStreams:1,maxObservedAddresses:10,maxMessageSize:gF,runOnConnectionOpen:!0,runOnSelfUpdate:!0,runOnLimitedConnection:!0,concurrency:mF};function wF(r){if(r!=null&&r.length>0)try{return be(r)}catch{}}async function bv(r,e,t,n,i){if(t("received identify from %p",n.remotePeer),i==null)throw new Je("message was null or undefined");const s={};if(i.listenAddrs.length>0&&(s.addresses=i.listenAddrs.map(c=>({isCertified:!1,multiaddr:be(c)}))),i.protocols.length>0&&(s.protocols=i.protocols),i.publicKey!=null){const c=on(i.publicKey);if(!Fo(c).equals(n.remotePeer))throw new Je("public key did not match remote PeerId");s.publicKey=c}let o;if(i.signedPeerRecord!=null){t.trace("received signedPeerRecord from %p",n.remotePeer);let c=i.signedPeerRecord;const l=await An.openAndCertify(c,xr.DOMAIN);let u=xr.createFromProtobuf(l.payload);const d=ya(l.publicKey.toCID());if(!u.peerId.equals(d))throw new Je("signing key does not match PeerId in the PeerRecord");if(!n.remotePeer.equals(u.peerId))throw new Je("signing key does not match remote PeerId");let h;try{h=await r.get(u.peerId)}catch(f){if(f.name!=="NotFoundError")throw f}if(h!=null&&(s.metadata=h.metadata,h.peerRecordEnvelope!=null)){const f=An.createFromProtobuf(h.peerRecordEnvelope),y=xr.createFromProtobuf(f.payload);y.seqNumber>=u.seqNumber&&(t("sequence number was lower or equal to existing sequence number - stored: %d received: %d",y.seqNumber,u.seqNumber),u=y,c=h.peerRecordEnvelope)}s.peerRecordEnvelope=c,s.addresses=u.multiaddrs.map(f=>({isCertified:!0,multiaddr:f})),o={seq:u.seqNumber,addresses:u.multiaddrs}}else t("%p did not send a signed peer record",n.remotePeer);if(t.trace("patching %p with",n.remotePeer,s),await r.patch(n.remotePeer,s),i.agentVersion!=null||i.protocolVersion!=null){const c={};i.agentVersion!=null&&(c.AgentVersion=W(i.agentVersion)),i.protocolVersion!=null&&(c.ProtocolVersion=W(i.protocolVersion)),t.trace("merging %p metadata",n.remotePeer,c),await r.merge(n.remotePeer,{metadata:c})}const a={peerId:n.remotePeer,protocolVersion:i.protocolVersion,agentVersion:i.agentVersion,publicKey:i.publicKey,listenAddrs:i.listenAddrs.map(c=>be(c)),observedAddr:i.observedAddr==null?void 0:be(i.observedAddr),protocols:i.protocols,signedPeerRecord:o,connection:n};return e.safeDispatchEvent("peer:identify",{detail:a}),a}class vv{host;components;protocol;started;timeout;maxInboundStreams;maxOutboundStreams;maxMessageSize;maxObservedAddresses;runOnLimitedConnection;log;constructor(e,t){this.protocol=t.protocol,this.started=!1,this.components=e,this.log=t.log,this.timeout=t.timeout??Rr.timeout,this.maxInboundStreams=t.maxInboundStreams??Rr.maxInboundStreams,this.maxOutboundStreams=t.maxOutboundStreams??Rr.maxOutboundStreams,this.maxMessageSize=t.maxMessageSize??Rr.maxMessageSize,this.maxObservedAddresses=t.maxObservedAddresses??Rr.maxObservedAddresses,this.runOnLimitedConnection=t.runOnLimitedConnection??Rr.runOnLimitedConnection,this.host={protocolVersion:`${t.protocolPrefix??Rr.protocolPrefix}/${uF}`,agentVersion:e.nodeInfo.userAgent},this.handleProtocol=this.handleProtocol.bind(this)}isStarted(){return this.started}async start(){this.started||(await this.components.peerStore.merge(this.components.peerId,{metadata:{AgentVersion:W(this.host.agentVersion),ProtocolVersion:W(this.host.protocolVersion)}}),await this.components.registrar.handle(this.protocol,this.handleProtocol,{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:this.runOnLimitedConnection}),this.started=!0)}async stop(){await this.components.registrar.unhandle(this.protocol),this.started=!1}}class bF extends vv{connectionManager;concurrency;_push;constructor(e,t={}){super(e,{...t,protocol:`/${t.protocolPrefix??Rr.protocolPrefix}/${hF}/${pF}`,log:e.logger.forComponent("libp2p:identify-push")}),this.connectionManager=e.connectionManager,this.concurrency=t.concurrency??Rr.concurrency,this._push=Vc(this.sendPushMessage.bind(this),t.debounce??yF),(t.runOnSelfUpdate??Rr.runOnSelfUpdate)&&e.events.addEventListener("self:peer:update",n=>{this.push().catch(i=>{this.log.error("error pushing updates to peers - %e",i)})})}[It]=["@libp2p/identify-push"];async push(){this._push()}async sendPushMessage(){if(this.isStarted())try{const e=this.components.addressManager.getAddresses().map(u=>u.decapsulateCode(ge)),t=new xr({peerId:this.components.peerId,multiaddrs:e}),n=await An.seal(t,this.components.privateKey),i=this.components.registrar.getProtocols(),s=await this.components.peerStore.get(this.components.peerId),o=Y(s.metadata.get("AgentVersion")??W(this.host.agentVersion)),a=Y(s.metadata.get("ProtocolVersion")??W(this.host.protocolVersion)),c=this;async function*l(){for(const u of c.connectionManager.getConnections())(await c.components.peerStore.get(u.remotePeer)).protocols.includes(c.protocol)&&(yield async()=>{let h;const f=AbortSignal.timeout(c.timeout);try{h=await u.newStream(c.protocol,{signal:f,runOnLimitedConnection:c.runOnLimitedConnection}),await Qt(h,{maxDataLength:c.maxMessageSize}).pb(Go).write({listenAddrs:e.map(m=>m.bytes),signedPeerRecord:n.marshal(),protocols:i,agentVersion:o,protocolVersion:a},{signal:f}),await h.close({signal:f})}catch(y){h?.log.newScope("identify-push")?.error("could not push identify update to peer",y),h?.abort(y)}})}await Li(Ys(l(),{concurrency:this.concurrency}))}catch(e){this.log.error("error pushing updates to peers - %e",e)}}async handleProtocol(e,t){const n=e.log.newScope("identify-push");if(this.components.peerId.equals(t.remotePeer))throw new Error("received push from ourselves?");const i={signal:AbortSignal.timeout(this.timeout)},o=await Qt(e,{maxDataLength:this.maxMessageSize}).pb(Go).read(i);await e.close(i),await bv(this.components.peerStore,this.components.events,n,t,o),n.trace("handled push from %p",t.remotePeer)}}class vF extends vv{constructor(e,t={}){super(e,{...t,protocol:`/${t.protocolPrefix??Rr.protocolPrefix}/${dF}/${fF}`,log:e.logger.forComponent("libp2p:identify")}),(t.runOnConnectionOpen??Rr.runOnConnectionOpen)&&e.events.addEventListener("connection:open",n=>{const i=n.detail;this.identify(i).catch(()=>{})})}[It]=["@libp2p/identify"];async _identify(e,t={}){let n,i;if(t.signal==null){const s=AbortSignal.timeout(this.timeout);t={...t,signal:s}}this.log("run identify on new connection %a",e.remoteAddr);try{n=await e.newStream(this.protocol,{...t,runOnLimitedConnection:this.runOnLimitedConnection}),i=n.log.newScope("identify");const s=Qt(n,{maxDataLength:this.maxMessageSize}).pb(Go),o=await s.read(t);return await s.unwrap().unwrap().close(t),o}catch(s){throw i?.error("identify failed - %e",s),n?.abort(s),s}}async identify(e,t={}){const n=await this._identify(e,t),{publicKey:i,protocols:s,observedAddr:o}=n;if(i==null)throw new Je("Public key was missing from identify message");const a=on(i),c=ya(a.toCID());if(!e.remotePeer.equals(c))throw new Je("Identified peer does not match the expected peer");if(this.components.peerId.equals(c))throw new Je("Identified peer is our own peer id?");return this.maybeAddObservedAddress(o),this.log("completed for peer %p and protocols %o",c,s),bv(this.components.peerStore,this.components.events,this.log,e,n)}maybeAddObservedAddress(e){const t=wF(e);if(t==null||(this.log.trace("our observed address was %a",t),Or(t)))return;const n=t.getComponents();if((n[0].code===xs||n[0].code===yg&&n[1].code===xs)&&!D7(t)){this.log.trace("our observed address was IPv6 but not a global unicast address");return}kd.exactMatch(t)||(this.log.trace("storing the observed address"),this.components.addressManager.addObservedAddr(t))}async handleProtocol(e,t){const n=e.log.newScope("identify");n("responding to identify");const i=AbortSignal.timeout(this.timeout),s=await this.components.peerStore.get(this.components.peerId,{signal:i}),o=this.components.addressManager.getAddresses().map(u=>u.decapsulateCode(ge));let a=s.peerRecordEnvelope;if(o.length>0&&a==null){const u=new xr({peerId:this.components.peerId,multiaddrs:o});a=(await An.seal(u,this.components.privateKey,{signal:i})).marshal().subarray()}let c=t.remoteAddr.bytes;ED.matches(t.remoteAddr)||(c=void 0);const l=Qt(e).pb(Go);n("send response"),await l.write({protocolVersion:this.host.protocolVersion,agentVersion:this.host.agentVersion,publicKey:En(this.components.privateKey.publicKey),listenAddrs:o.map(u=>u.bytes),signedPeerRecord:a,observedAddr:c,protocols:s.protocols},{signal:i}),n("close write"),await l.unwrap().unwrap().close({signal:i})}}function Ev(r={}){return e=>new vF(e,r)}function EF(r={}){return e=>new bF(e,r)}const ba=1e3,f3=60*ba,If=60*f3,SF="/ipfs/kad/1.0.0",Sv=48*If,xF=24*If,AF=10,kF=16384,CF=If,Gy=If,IF=10*ba,xv=20,_f=10,_F=5*f3,TF=ba,PF=5*ba,RF=5*f3,NF=30*ba,DF=180*ba,Yy=`${Mh}-kad-dht`;var qd;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.key!=null&&t.key.byteLength>0&&(n.uint32(10),n.bytes(t.key)),t.value!=null&&t.value.byteLength>0&&(n.uint32(18),n.bytes(t.value)),t.timeReceived!=null&&t.timeReceived!==""&&(n.uint32(42),n.string(t.timeReceived)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{const s={key:Re(0),value:Re(0),timeReceived:""},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.key=t.bytes();break}case 2:{s.value=t.bytes();break}case 5:{s.timeReceived=t.string();break}default:{t.skipType(a&7);break}}}return s})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ae(t,r.codec(),n)})(qd||(qd={}));function BF(r){const e=r.getUTCFullYear(),t=String(r.getUTCMonth()+1).padStart(2,"0"),n=String(r.getUTCDate()).padStart(2,"0"),i=String(r.getUTCHours()).padStart(2,"0"),s=String(r.getUTCMinutes()).padStart(2,"0"),o=String(r.getUTCSeconds()).padStart(2,"0"),a=r.getUTCMilliseconds(),c=String(a*1e3*1e3).padStart(9,"0");return`${e}-${t}-${n}T${i}:${s}:${o}.${c}Z`}function LF(r){const e=new RegExp("(\\d{4})-(\\d{2})-(\\d{2})T(\\d{2}):(\\d{2}):(\\d{2})\\.(\\d+)Z"),t=String(r).trim().match(e);if(t==null)throw new Error("Invalid format");const n=parseInt(t[1],10),i=parseInt(t[2],10)-1,s=parseInt(t[3],10),o=parseInt(t[4],10),a=parseInt(t[5],10),c=parseInt(t[6],10),l=parseInt(t[7].slice(0,-6),10);return new Date(Date.UTC(n,i,s,o,a,c,l))}class Lr{key;value;timeReceived;constructor(e,t,n){if(!(e instanceof Uint8Array))throw new Error("key must be a Uint8Array");if(!(t instanceof Uint8Array))throw new Error("value must be a Uint8Array");this.key=e,this.value=t,this.timeReceived=n}serialize(){return qd.encode(this.prepareSerialize())}prepareSerialize(){return{key:this.key,value:this.value,timeReceived:BF(this.timeReceived)}}static deserialize(e){const t=qd.decode(e);return new Lr(t.key,t.value,new Date(t.timeReceived))}static fromDeserialized(e){const t=LF(e.timeReceived);if(e.key==null)throw new Error("key missing from deserialized object");if(e.value==null)throw new Error("value missing from deserialized object");return new Lr(e.key,e.value,t)}}class Kd extends Error{constructor(e="Query error"){super(e),this.name="QueryError"}}class OF extends Error{constructor(e="Invalid record"){super(e),this.name="InvalidRecordError"}}class MF extends Error{constructor(e="No selector function configured for prefix"){super(e),this.name="MissingSelectorError"}}var Qy;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.key!=null&&(n.uint32(10),n.bytes(t.key)),t.value!=null&&(n.uint32(18),n.bytes(t.value)),t.author!=null&&(n.uint32(26),n.bytes(t.author)),t.signature!=null&&(n.uint32(34),n.bytes(t.signature)),t.timeReceived!=null&&(n.uint32(42),n.string(t.timeReceived)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{const s={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.key=t.bytes();break}case 2:{s.value=t.bytes();break}case 3:{s.author=t.bytes();break}case 4:{s.signature=t.bytes();break}case 5:{s.timeReceived=t.string();break}default:{t.skipType(a&7);break}}}return s})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ae(t,r.codec(),n)})(Qy||(Qy={}));var it;(function(r){r.PUT_VALUE="PUT_VALUE",r.GET_VALUE="GET_VALUE",r.ADD_PROVIDER="ADD_PROVIDER",r.GET_PROVIDERS="GET_PROVIDERS",r.FIND_NODE="FIND_NODE",r.PING="PING"})(it||(it={}));var Wd;(function(r){r[r.PUT_VALUE=0]="PUT_VALUE",r[r.GET_VALUE=1]="GET_VALUE",r[r.ADD_PROVIDER=2]="ADD_PROVIDER",r[r.GET_PROVIDERS=3]="GET_PROVIDERS",r[r.FIND_NODE=4]="FIND_NODE",r[r.PING=5]="PING"})(Wd||(Wd={}));(function(r){r.codec=()=>sr(Wd)})(it||(it={}));var Yo;(function(r){r.NOT_CONNECTED="NOT_CONNECTED",r.CONNECTED="CONNECTED",r.CAN_CONNECT="CAN_CONNECT",r.CANNOT_CONNECT="CANNOT_CONNECT"})(Yo||(Yo={}));var l2;(function(r){r[r.NOT_CONNECTED=0]="NOT_CONNECTED",r[r.CONNECTED=1]="CONNECTED",r[r.CAN_CONNECT=2]="CAN_CONNECT",r[r.CANNOT_CONNECT=3]="CANNOT_CONNECT"})(l2||(l2={}));(function(r){r.codec=()=>sr(l2)})(Yo||(Yo={}));var yo;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,i={})=>{if(i.lengthDelimited!==!1&&n.fork(),t.id!=null&&t.id.byteLength>0&&(n.uint32(10),n.bytes(t.id)),t.multiaddrs!=null)for(const s of t.multiaddrs)n.uint32(18),n.bytes(s);t.connection!=null&&(n.uint32(24),Yo.codec().encode(t.connection,n)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{const s={id:Re(0),multiaddrs:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.id=t.bytes();break}case 2:{if(i.limits?.multiaddrs!=null&&s.multiaddrs.length===i.limits.multiaddrs)throw new Mt('Decode error - map field "multiaddrs" had too many elements');s.multiaddrs.push(t.bytes());break}case 3:{s.connection=Yo.codec().decode(t);break}default:{t.skipType(a&7);break}}}return s})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ae(t,r.codec(),n)})(yo||(yo={}));var _o;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,i={})=>{if(i.lengthDelimited!==!1&&n.fork(),t.type!=null&&Wd[t.type]!==0&&(n.uint32(8),it.codec().encode(t.type,n)),t.clusterLevel!=null&&(n.uint32(80),n.int32(t.clusterLevel)),t.key!=null&&(n.uint32(18),n.bytes(t.key)),t.record!=null&&(n.uint32(26),n.bytes(t.record)),t.closer!=null)for(const s of t.closer)n.uint32(66),yo.codec().encode(s,n);if(t.providers!=null)for(const s of t.providers)n.uint32(74),yo.codec().encode(s,n);i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{const s={type:it.PUT_VALUE,closer:[],providers:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.type=it.codec().decode(t);break}case 10:{s.clusterLevel=t.int32();break}case 2:{s.key=t.bytes();break}case 3:{s.record=t.bytes();break}case 8:{if(i.limits?.closer!=null&&s.closer.length===i.limits.closer)throw new Mt('Decode error - map field "closer" had too many elements');s.closer.push(yo.codec().decode(t,t.uint32(),{limits:i.limits?.closer$}));break}case 9:{if(i.limits?.providers!=null&&s.providers.length===i.limits.providers)throw new Mt('Decode error - map field "providers" had too many elements');s.providers.push(yo.codec().decode(t,t.uint32(),{limits:i.limits?.providers$}));break}default:{t.skipType(a&7);break}}}return s})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ae(t,r.codec(),n)})(_o||(_o={}));function Xy(r,e={}){const t={...r,name:"SEND_QUERY",type:0,messageName:r.type,messageType:r.type};return e.onProgress?.(new CustomEvent("kad-dht:query:send-query",{detail:t})),t}function u2(r,e={}){const t={...r,name:"PEER_RESPONSE",type:1,messageName:r.messageType,closer:r.closer??[],providers:r.providers??[]};return e.onProgress?.(new CustomEvent("kad-dht:query:peer-response",{detail:t})),t}function X1(r,e={}){const t={...r,name:"FINAL_PEER",type:2};return e.onProgress?.(new CustomEvent("kad-dht:query:final-peer",{detail:t})),t}function Qo(r,e={}){const t={...r,name:"QUERY_ERROR",type:3};return e.onProgress?.(new CustomEvent("kad-dht:query:query-error",{detail:t})),t}function Zy(r,e={}){const t={...r,name:"PROVIDER",type:4};return e.onProgress?.(new CustomEvent("kad-dht:query:provider",{detail:t})),t}function d2(r,e={}){const t={...r,name:"VALUE",type:5};return e.onProgress?.(new CustomEvent("kad-dht:query:value",{detail:t})),t}function Jy(r,e={}){const t={...r,name:"DIAL_PEER",type:7};return e.onProgress?.(new CustomEvent("kad-dht:query:dial-peer",{detail:t})),t}function $F(r,e={}){const t={...r,name:"PATH_ENDED",type:8};return e.onProgress?.(new CustomEvent("kad-dht:query:path-ended",{detail:t})),t}function UF(r,e,t){if(t.length===0)throw new H("No records given");const i=Y(e).split("/");if(i.length<3)throw new H("Record key does not have a selector function");const s=r[i[1].toString()];if(s==null)throw new MF(`No selector function configured for key type "${i[1]}"`);return t.length===1?0:s(e,t)}function FF(r,e){return 0}const VF={pk:FF};async function p3(r,e,t){const n=e.key,s=Y(n).split("/");if(s.length<3)return;const o=r[s[1].toString()];if(o==null)throw new H(`No validator available for key type "${s[1]}"`);await o(n,e.value,t)}const zF=async(r,e,t)=>{if(!(r instanceof Uint8Array))throw new H('"key" must be a Uint8Array');if(r.byteLength<5)throw new H("Invalid public key record");if(Y(r.subarray(0,4))!=="/pk/")throw new H("key was not prefixed with /pk/");const i=on(e),s=r.slice(4);if(!Te(s,i.toMultihash().bytes))throw new H("public key does not match passed in key")},HF={pk:zF},qF=W("/pk/");function KF(r){return{...r,multiaddrs:r.multiaddrs.filter(e=>!Or(e))}}async function tl(r,e){const t=await Et.digest(r);return e?.signal?.throwIfAborted(),t.digest}async function Qn(r,e){return tl(r.toMultihash().bytes,e)}function xc(r,e){return new Ye(`${r}/${Y(e,"base32")}`,!1)}function WF(r){return Ot([qF,r.toMultihash().bytes])}function jF(r){return Y(r.subarray(0,4))==="/pk/"}function GF(r){const e=Zt(r.subarray(4));return ln(e)}function e6(r,e){const t=new Date;return new Lr(r,e,t).serialize()}function Av(r){const e=r.toString().split("/"),t=e.pop(),n=e.pop();if(t==null||n==null)throw new Error(`incorrectly formatted provider entry key in datastore: ${r.toString()}`);return{cid:ae.createV1(sn,Zt(W(n,"base32"))),peerId:or(t)}}function Z1(r,e,t){const n=typeof e=="string"?e:Y(e.multihash.bytes,"base32"),i=[r,n];return t!=null&&i.push(t.toString()),new Ye(i.join("/"))}function kv(r){return new Date(Vs(r))}function oo(r,e,t){return async function*(...n){const i=e.queryTime?.timer(t),s=e.errorTime?.timer(t);let o=!1;try{e.queries?.increment({[t]:!0}),yield*r(...n)}catch(a){throw o=!0,s?.(),e.errors?.increment({[t]:!0}),a}finally{e.queries?.decrement({[t]:!0}),o||i?.()}}}function Cv(r,e,t){return async function(...n){const i=e?.queryTime?.timer(t),s=e?.errorTime?.timer(t);let o=!1;try{return e.queries?.increment({[t]:!0}),await r(...n)}catch(a){throw o=!0,s?.(),e.errors?.increment({[t]:!0}),a}finally{e.queries?.decrement({[t]:!0}),o||i?.()}}}class YF{log;components;validators;selectors;peerRouting;queryManager;network;datastorePrefix;constructor(e,t){const{validators:n,selectors:i,peerRouting:s,queryManager:o,network:a,logPrefix:c}=t;this.components=e,this.log=e.logger.forComponent(`${c}:content-fetching`),this.datastorePrefix=`${t.datastorePrefix}/record`,this.validators=n,this.selectors=i,this.peerRouting=s,this.queryManager=o,this.network=a,this.get=e.metrics?.traceFunction("libp2p.kadDHT.get",this.get.bind(this),{optionsIndex:1})??this.get,this.put=e.metrics?.traceFunction("libp2p.kadDHT.put",this.put.bind(this),{optionsIndex:2})??this.put}async getLocal(e,t){this.log("getLocal %b",e);const n=xc(this.datastorePrefix,e);this.log("fetching record for key %k",n);const i=await this.components.datastore.get(n,t);this.log("found %k in local datastore",n);const s=Lr.deserialize(i);return await p3(this.validators,s,t),s}async*sendCorrectionRecord(e,t,n,i){this.log("sendCorrection for %b",e);const s=e6(e,n);for(const{value:o,from:a}of t){if(Te(o,n)){this.log("record was ok");continue}if(this.components.peerId.equals(a)){try{const u=xc(this.datastorePrefix,e);this.log(`Storing corrected record for key ${u.toString()}`),await this.components.datastore.put(u,s.subarray(),i)}catch(u){this.log.error("failed error correcting self - %e",u)}continue}let c=!1;const l={type:it.PUT_VALUE,key:e,record:s};for await(const u of this.network.sendRequest(a,l,i))u.name==="PEER_RESPONSE"&&u.record!=null&&Te(u.record.value,Lr.deserialize(s).value)&&(c=!0),yield u;if(!c)throw new Kd("Could not send correction");this.log.error("failed error correcting entry")}}async*put(e,t,n){this.log("put key %b value %b",e,t);const i=e6(e,t),s=xc(this.datastorePrefix,e);this.log(`storing record for key ${s.toString()}`),await this.components.datastore.put(s,i.subarray(),n),yield*zs(this.peerRouting.getClosestPeers(e,{...n,signal:n.signal}),o=>Ki(o,a=>async()=>{if(a.name!=="FINAL_PEER")return[a];const c=[],l={type:it.PUT_VALUE,key:e,record:i};this.log("send put to %p",a.peer.id);for await(const u of this.network.sendRequest(a.peer.id,l,{...n,path:a.path}))c.push(u),u.name==="PEER_RESPONSE"&&(u.record!=null&&Te(u.record.value,Lr.deserialize(i).value)||c.push(Qo({from:a.peer.id,error:new Kd("Value not put correctly"),path:u.path},n)));return c}),o=>Ys(o,{ordered:!1,concurrency:_f}),async function*(o){for await(const a of o)yield*a})}async*get(e,t){this.log("get %b",e);const n=[];for await(const a of this.getMany(e,t)){if(a.name==="VALUE"){n.push(a);continue}yield a}if(n.length===0)return;const i=n.map(a=>a.value);let s=0;try{s=UF(this.selectors,e,i)}catch(a){if(a.name!=="InvalidParametersError")throw a}const o=i[s];if(this.log("GetValue %b %b",e,o),o==null)throw new wt("Best value was not found");yield*this.sendCorrectionRecord(e,n,o,{...t,path:{index:-1,queued:0,running:0,total:0}}),yield n[s]}async*getMany(e,t={}){this.log("getMany values for %b",e);try{const s=await this.getLocal(e,t);yield d2({value:s.value,from:this.components.peerId,path:{index:-1,running:0,queued:0,total:0}},t)}catch(s){this.log("error getting local value for %b",e,s)}const n=this,i=async function*({peer:s,signal:o,path:a}){for await(const c of n.peerRouting.getValueOrPeers(s.id,e,{...t,signal:o,path:a}))yield c,c.name==="PEER_RESPONSE"&&c.record!=null&&(yield d2({from:s.id,value:c.record.value,path:a},t))};yield*this.queryManager.run(e,i,t)}}function QF(r,e){return{id:r.id.toMultihash().bytes,multiaddrs:(r.multiaddrs??[]).map(n=>n.bytes),connection:e}}function Iu(r){if(r.id==null)throw new Error("Invalid peer in message");const e=Zt(r.id);return{id:ln(e),multiaddrs:(r.multiaddrs??[]).map(t=>be(t))}}class XF{log;components;network;peerRouting;queryManager;routingTable;providers;constructor(e,t){const{network:n,peerRouting:i,queryManager:s,routingTable:o,providers:a,logPrefix:c}=t;this.components=e,this.log=e.logger.forComponent(`${c}:content-routing`),this.network=n,this.peerRouting=i,this.queryManager=s,this.routingTable=o,this.providers=a,this.findProviders=e.metrics?.traceFunction("libp2p.kadDHT.findProviders",this.findProviders.bind(this),{optionsIndex:1,getAttributesFromYieldedValue:(l,u)=>(l.name==="PROVIDER"&&(u.providers??=[],u.providers.push(...l.providers.map(d=>d.id.toString()))),u)})??this.findProviders,this.provide=e.metrics?.traceFunction("libp2p.kadDHT.provide",this.provide.bind(this),{optionsIndex:1,getAttributesFromYieldedValue:(l,u)=>(l.name==="PEER_RESPONSE"&&l.messageName==="ADD_PROVIDER"&&(u.providers??=[],u.providers.push(l.from.toString())),u)})??this.provide}async*provide(e,t,n={}){this.log("provide %s",e);const i=e.multihash.bytes;await this.providers.addProvider(e,this.components.peerId,n);const s={type:it.ADD_PROVIDER,key:i,providers:[QF({id:this.components.peerId,multiaddrs:t})]};let o=0;const a=this;async function*c(d){try{a.log("sending provider record for %s to %p",e,d.peer.id);for await(const h of a.network.sendMessage(d.peer.id,s,{...n,path:d.path}))h.name==="PEER_RESPONSE"&&(a.log("sent provider record for %s to %p",e,d.peer.id),o++),yield h}catch(h){a.log.error("error sending provide record to peer %p - %e",d.peer.id,h),yield Qo({from:d.peer.id,error:h,path:d.path},n)}}const l=ii({objectMode:!0}),u=new $i({concurrency:_f});u.addEventListener("idle",()=>{l.end()}),u.addEventListener("failure",d=>{this.log.error("error publishing provider record to peer - %e",d.detail.error)}),u.add(async()=>{const d=[];for await(const h of this.peerRouting.getClosestPeers(i,n))l.push(h),h.name==="FINAL_PEER"&&d.push(h);d.forEach(h=>{u.add(async()=>{for await(const f of c(h))l.push(f)}).catch(f=>{this.log.error("error publishing provider record to peer - %e",f)})})}).catch(d=>{l.end(d)}),yield*l,this.log("sent provider records to %d peers",o)}async*findProviders(e,t){const n=this.routingTable.kBucketSize;let i=0;const s=e.multihash.bytes,o=this;this.log("findProviders %c",e);const a=await this.providers.getProviders(e,t);if(a.length>0){const u=[];for(const d of a.slice(0,n))try{const h=await this.components.peerStore.get(d,t);u.push({id:d,multiaddrs:h.addresses.map(({multiaddr:f})=>f)})}catch(h){if(h.name!=="NotFoundError")throw h;this.log("no peer store entry for %p",d)}if(yield u2({from:this.components.peerId,messageType:it.GET_PROVIDERS,providers:u,path:{index:-1,queued:0,running:0,total:0}},t),yield Zy({from:this.components.peerId,providers:u,path:{index:-1,queued:0,running:0,total:0}},t),i+=u.length,i>=n)return}const c=async function*({peer:u,signal:d,path:h}){const f={type:it.GET_PROVIDERS,key:s};yield*o.network.sendRequest(u.id,f,{...t,signal:d,path:h})},l=new xn(a);for await(const u of this.queryManager.run(s,c,t))if(yield u,u.name==="PEER_RESPONSE"){this.log("Found %d provider entries for %c and %d closer peers",u.providers.length,e,u.closer.length);const d=[];for(const h of u.providers)l.has(h.id)||(l.add(h.id),d.push(h));if(d.length>0&&(yield Zy({from:u.from,providers:d,path:u.path},t),i+=d.length,i>=n))return}}}class ZF extends Qe{log;protocol;running;components;timeout;metrics;constructor(e,t){super(),this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:network`),this.running=!1,this.protocol=t.protocol,this.timeout=new zc({...t.timeout??{},metrics:e.metrics,metricName:`${t.metricsPrefix}_network_message_send_times_milliseconds`}),this.metrics={operations:e.metrics?.registerCounterGroup(`${t.metricsPrefix}_outbound_rpc_requests_total`),errors:e.metrics?.registerCounterGroup(`${t.metricsPrefix}_outbound_rpc_errors_total`)},this.sendRequest=e.metrics?.traceFunction("libp2p.kadDHT.sendRequest",this.sendRequest.bind(this),{optionsIndex:2,getAttributesFromArgs([n,i],s){return{...s,to:n.toString(),"message type":`${i.type}`}},getAttributesFromYieldedValue:(n,i)=>(n.name==="PEER_RESPONSE"&&(n.providers.length>0&&n.providers.forEach((s,o)=>{i[`providers-${o}`]=s.id.toString()}),n.closer.length>0&&n.closer.forEach((s,o)=>{i[`closer-${o}`]=s.id.toString()})),i)})??this.sendRequest,this.sendMessage=e.metrics?.traceFunction("libp2p.kadDHT.sendMessage",this.sendMessage.bind(this),{optionsIndex:2,getAttributesFromArgs([n,i],s){return{...s,to:n.toString(),"message type":`${i.type}`}},getAttributesFromYieldedValue:(n,i)=>(n.name==="PEER_RESPONSE"&&(n.providers.length>0&&n.providers.forEach((s,o)=>{i[`providers-${o}`]=s.id.toString()}),n.closer.length>0&&n.closer.forEach((s,o)=>{i[`closer-${o}`]=s.id.toString()})),i)})??this.sendMessage}async start(){this.running||(this.running=!0)}async stop(){this.running=!1}isStarted(){return this.running}async*sendRequest(e,t,n){if(!this.running)return;const i=t.type;if(i==null)throw new H("Message type was missing");let s;const o=this.timeout.getTimeoutSignal(n);n={...n,signal:o};try{this.metrics.operations?.increment({[i]:!0}),this.log("dialling %p",e),yield Jy({peer:e,path:n.path},n),s=await this.components.connectionManager.openStream(e,this.protocol,n),this.log("sending %s to %p",t.type,e),yield Xy({to:e,type:i,path:n.path},n);const a=await this._writeReadMessage(s,t,n);s.close(n).catch(c=>{this.log.error("error closing stream to %p - %e",e,c),s?.abort(c)}),yield u2({from:e,messageType:a.type,closer:a.closer.map(Iu),providers:a.providers.map(Iu),record:a.record==null?void 0:Lr.deserialize(a.record),path:n.path},n)}catch(a){this.metrics.errors?.increment({[i]:!0}),s?.abort(a),n.signal?.aborted!==!0&&this.log.error("could not send %s to %p - %e",t.type,e,a),yield Qo({from:e,error:a,path:n.path},n)}finally{this.timeout.cleanUp(o)}}async*sendMessage(e,t,n){if(!this.running)return;const i=t.type;if(i==null)throw new H("Message type was missing");let s;const o=this.timeout.getTimeoutSignal(n);n={...n,signal:o};try{this.metrics.operations?.increment({[i]:!0}),this.log("dialling %p",e),yield Jy({peer:e,path:n.path},n),s=await this.components.connectionManager.openStream(e,this.protocol,n),this.log("sending %s to %p",t.type,e),yield Xy({to:e,type:i,path:n.path},n),await this._writeMessage(s,t,n),s.close(n).catch(a=>{this.log.error("error closing stream to %p - %e",e,a),s?.abort(a)}),yield u2({from:e,messageType:i,path:n.path},n)}catch(a){this.metrics.errors?.increment({[i]:!0}),s?.abort(a),yield Qo({from:e,error:a,path:n.path},n)}finally{this.timeout.cleanUp(o)}}async _writeMessage(e,t,n){await Qt(e).write(t,_o,n)}async _writeReadMessage(e,t,n){const i=Qt(e);await i.write(t,_o,n);const s=await i.read(_o,n);return s.closer.forEach(o=>{this.safeDispatchEvent("peer",{detail:Iu(o)})}),s.providers.forEach(o=>{this.safeDispatchEvent("peer",{detail:Iu(o)})}),s}}function Ac(r,e){if(r.byteLength!==e.byteLength)throw new Error("Inputs should have the same length");for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return r[t]<e[t]?-1:1;return 0}class g3{originDhtKey;capacity;peerDistances;constructor(e,t){this.originDhtKey=e,this.capacity=t,this.peerDistances=[]}get length(){return this.peerDistances.length}get peers(){return[...this.peerDistances]}async add(e,t={index:-1,queued:0,running:0,total:0},n){const i=await Qn(e.id,n);this.addWithKadId(e,i,t)}addWithKadId(e,t,n={index:-1,queued:0,running:0,total:0}){if(this.peerDistances.find(o=>o.peer.id.equals(e.id))!=null)return;const i={peer:e,distance:qo(this.originDhtKey,t),path:n};if(this.peerDistances.length===this.capacity){const o=this.peerDistances[this.peerDistances.length-1];if(o!=null&&Ac(i.distance,o.distance)!==-1)return}let s=!1;for(let o=0;o<this.peerDistances.length;o++){const a=Ac(this.peerDistances[o].distance,i.distance);if(a===0||a===1){s=!0,this.peerDistances.splice(o,0,i);break}}s||this.peerDistances.push(i),this.peerDistances=this.peerDistances.slice(0,this.capacity)}async isCloser(e,t){if(this.length===0)return!0;const n=await Qn(e,t),i=qo(n,this.originDhtKey),s=this.peerDistances[this.peerDistances.length-1].distance;return Ac(i,s)===-1}async anyCloser(e,t){return e.length===0?!1:Promise.any(e.map(async n=>this.isCloser(n,t)))}}class JF{log;routingTable;network;validators;queryManager;components;constructor(e,t){this.routingTable=t.routingTable,this.network=t.network,this.validators=t.validators,this.queryManager=t.queryManager,this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:peer-routing`),this.findPeer=e.metrics?.traceFunction("libp2p.kadDHT.findPeer",this.findPeer.bind(this),{optionsIndex:1})??this.findPeer,this.getClosestPeers=e.metrics?.traceFunction("libp2p.kadDHT.getClosestPeers",this.getClosestPeers.bind(this),{optionsIndex:1})??this.getClosestPeers}async findPeerLocal(e,t){let n;const i=await this.routingTable.find(e,t);if(i!=null){this.log("findPeerLocal found %p in routing table",e);try{n=await this.components.peerStore.get(i,t)}catch(s){if(s.name!=="NotFoundError")throw s}}if(n==null)try{n=await this.components.peerStore.get(e,t)}catch(s){if(s.name!=="NotFoundError")throw s}if(n!=null)return this.log("findPeerLocal found %p in peer store",e),{id:n.id,multiaddrs:n.addresses.map(s=>s.multiaddr)}}async*_getValueSingle(e,t,n){const i={type:it.GET_VALUE,key:t};yield*this.network.sendRequest(e,i,n)}async*getPublicKeyFromNode(e,t={}){const n=WF(e),i={index:-1,queued:0,running:0,total:0};for await(const s of this._getValueSingle(e,n,{...t,path:i}))if(yield s,s.name==="PEER_RESPONSE"&&s.record!=null){const o=on(s.record.value),a=Fo(o);if(!a.equals(e))throw new Yu("public key does not match id");if(a.publicKey==null)throw new Yu("public key missing");yield d2({from:e,value:s.record.value,path:i},t)}throw new Kd(`Node not responding with its public key: ${e.toString()}`)}async*findPeer(e,t={}){if(this.log("findPeer %p",e),t.useCache!==!1){const i=await this.findPeerLocal(e,t);if(i!=null){this.log("found local"),yield X1({from:this.components.peerId,peer:i,path:{index:-1,queued:0,running:0,total:0}},t);return}}let n=!1;if(t.useNetwork!==!1){const i=this,s=async function*({peer:o,signal:a,path:c}){const l={type:it.FIND_NODE,key:e.toMultihash().bytes};for await(const u of i.network.sendRequest(o.id,l,{...t,signal:a,path:c}))if(yield u,u.name==="PEER_RESPONSE"){const d=u.closer.find(h=>h.id.equals(e));d!=null&&(yield X1({from:u.from,peer:d,path:u.path},t))}};for await(const o of this.queryManager.run(e.toMultihash().bytes,s,t))o.name==="FINAL_PEER"&&(n=!0),yield o}if(!n)throw new wt("Not found")}async*getClosestPeers(e,t={}){this.log("getClosestPeers to %b",e);const n=await tl(e,t),i=new g3(n,this.routingTable.kBucketSize),s=this,o=async function*({peer:a,path:c,peerKadId:l,signal:u}){s.log("getClosestPeers asking %p",a.id);const d={type:it.FIND_NODE,key:e};yield*s.network.sendRequest(a.id,d,{...t,signal:u,path:c}),i.addWithKadId(a,l,c)};yield*this.queryManager.run(e,o,t),this.log("found %d peers close to %b",i.length,e);for(let{peer:a,path:c}of i.peers)try{if(a.multiaddrs.length===0&&(a=await s.components.peerStore.getInfo(a.id,t)),a.multiaddrs.length===0)continue;yield X1({from:this.components.peerId,peer:await s.components.peerStore.getInfo(a.id,t),path:{index:c.index,queued:0,running:0,total:0}},t)}catch{continue}}async*getValueOrPeers(e,t,n){for await(const i of this._getValueSingle(e,t,n)){if(i.name==="PEER_RESPONSE"&&i.record!=null)try{await this._verifyRecordOnline(i.record,n)}catch{const o="invalid record received, discarded";this.log(o),yield Qo({from:i.from,error:new Kd(o),path:n.path},n);continue}yield i}}async _verifyRecordOnline(e,t){if(e.timeReceived==null)throw new OF("invalid record received");await p3(this.validators,new Lr(e.key,e.value,e.timeReceived),t)}async getClosestPeersOffline(e,t){const n=[];try{const o=Zt(e),a=ln(o),c=await this.components.peerStore.get(a,t);n.push({id:c.id,multiaddrs:c.addresses.map(({multiaddr:l})=>l)})}catch{}const i=await tl(e,t),s=this.routingTable.closestPeers(i,t);for(const o of s)try{n.push(await this.components.peerStore.getInfo(o,t))}catch(a){if(a.name!=="NotFoundError")throw a}return n.length>0?this.log("getClosestPeersOffline returning the %d closest peer(s) we know to %b",n.length,e):this.log("getClosestPeersOffline could not any peers close to %b with %d peers in the routing table",e,this.routingTable.size),n}}class eV{log;datastore;datastorePrefix;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:providers`),this.datastorePrefix=`${t.datastorePrefix}/provider`,this.datastore=e.datastore}async addProvider(e,t,n){this.log.trace("%p provides %s",t,e),await this.writeProviderEntry(e,t,n)}async removeProvider(e,t,n){const i=Z1(this.datastorePrefix,e,t);this.log.trace("%p no longer provides %s",t,e),await this.datastore.delete(i,n)}async getProviders(e,t){this.log.trace("get providers for %c",e);const n=await this.loadProviders(e,t);return this.log.trace("got %d providers for %c",n.size,e),[...n.keys()]}async writeProviderEntry(e,t,n){const i=Z1(this.datastorePrefix,e,t),s=vn(n?.time?.getTime()??Date.now());await this.datastore.put(i,s,n)}async loadProviders(e,t){const n=new Gs,i=Z1(this.datastorePrefix,e);for await(const s of this.datastore.query({prefix:i.toString()},t)){const{peerId:o}=Av(s.key);n.set(o,kv(s.value))}return n}}async function*tV(r){const{key:e,startingPeers:t,ourPeerId:n,query:i,alpha:s,path:o,numPaths:a,log:c,peersSeen:l,connectionManager:u,signal:d}=r,h=ii({objectMode:!0}),f=new $i({concurrency:s,sort:(p,b)=>Ac(p.options.distance,b.options.distance)});f.addEventListener("idle",()=>{h.push($F({path:{index:o,queued:f.queued,running:f.running,total:f.size}},r)),h.end()}),f.addEventListener("failure",p=>{c.error("error during query - %e",p.detail.error)});const y=()=>{f.abort(),h.end(new ys)};d.addEventListener("abort",y);try{let b=function(A,v){if(A==null)return;l.add(A.id.toMultihash().bytes);const C=qo(v,p);f.add(async()=>{try{for await(const T of i({...r,key:e,peer:A,path:{index:o,queued:f.queued,running:f.running,total:f.size},numPaths:a,peerKadId:v,signal:d})){if(T.name==="PEER_RESPONSE")for(const R of T.closer){if(l.has(R.id.toMultihash().bytes)){c("already seen %p in query",R.id);continue}if(n.equals(R.id)){c("not querying ourselves");continue}if(!await u.isDialable(R.multiaddrs)){c("not querying undialable peer");continue}const L=await Qn(R.id,{signal:d}),N=qo(L,p);if(Ac(N,C)!==-1){c("skipping %p as they are not closer to %b than %p",R.id,e,A.id);continue}c("querying closer peer %p",R.id),b(R,L)}h.push({...T,path:{index:o,queued:f.queued,running:f.running,total:f.size}})}}catch(T){h.push(Qo({from:A.id,error:T,path:{index:o,queued:f.queued,running:f.running-1,total:f.size-1}},r))}},{distance:C}).catch(T=>{c.error("error during query - %e",T)})};var m=b;const p=await tl(e,{signal:d});await Promise.all(t.map(async A=>{b({id:A,multiaddrs:[]},await Qn(A,{signal:d}))})),yield*h}finally{d.removeEventListener("abort",y)}}class rV{disjointPaths;alpha;shutDownController;running;logger;peerId;connectionManager;routingTable;initialQuerySelfHasRun;logPrefix;allowQueryWithZeroPeers;constructor(e,t){this.logPrefix=t.logPrefix,this.disjointPaths=t.disjointPaths??xv,this.alpha=t.alpha??_f,this.initialQuerySelfHasRun=t.initialQuerySelfHasRun,this.routingTable=t.routingTable,this.logger=e.logger,this.peerId=e.peerId,this.connectionManager=e.connectionManager,this.allowQueryWithZeroPeers=t.allowQueryWithZeroPeers??!1,this.shutDownController=new AbortController,this.shutDownController.signal,this.running=!1}isStarted(){return this.running}async start(){this.running||(this.running=!0,this.shutDownController=new AbortController,this.shutDownController.signal,void 0)}async stop(){this.running=!1,this.shutDownController.abort()}async*run(e,t,n={}){if(!this.running)throw new Error("QueryManager not started");if(n.signal==null){const c=AbortSignal.timeout(DF);n={...n,signal:c}}const i=new AbortController,s=Ke([this.shutDownController.signal,i.signal,n.signal]);i.signal;const o=this.logger.forComponent(`${this.logPrefix}:query:`+Y(e,"base58btc"));let a=!1;try{this.routingTable.size===0&&!this.allowQueryWithZeroPeers&&(o("routing table was empty, waiting for some peers before running%s query",n.isSelfQuery===!0?" self":""),await bt(this.routingTable,"peer:add",{signal:s,filter:f=>!this.peerId.equals(f.detail)}),o("routing table has peers, continuing with%s query",n.isSelfQuery===!0?" self":"")),n.isSelfQuery!==!0&&this.initialQuerySelfHasRun!=null&&(o("waiting for initial self query before continuing"),await Yt(this.initialQuerySelfHasRun.promise,s),this.initialQuerySelfHasRun=void 0),o("query:start");const c=await tl(e,{signal:s}),l=this.routingTable.closestPeers(c,{count:this.routingTable.kBucketSize}),u=l.sort(()=>Math.random()>.5?1:-1).reduce((f,y,m)=>(f[m%this.disjointPaths].push(y),f),new Array(this.disjointPaths).fill(0).map(()=>[])).filter(f=>f.length>0);if(l.length===0){o.error("running query with no peers");return}const d=Mi(1024),h=u.map((f,y)=>tV({...n,key:e,startingPeers:f,ourPeerId:this.peerId,signal:s,query:t,path:y,numPaths:u.length,alpha:this.alpha,log:o,peersSeen:d,onProgress:n.onProgress,connectionManager:this.connectionManager}));for await(const f of Pi(...h)){if(f.name==="QUERY_ERROR"&&o.error("query error - %e",f.error),f.name==="PEER_RESPONSE")for(const y of[...f.closer,...f.providers])await this.connectionManager.isDialable(y.multiaddrs,{signal:s})&&await this.routingTable.add(y.id,{signal:s});s.throwIfAborted(),yield f}a=!0}catch(c){if(this.running)throw c}finally{a||(o("query exited early"),i.abort()),s.clear(),o("query finished")}}}function nV(r){return r[Symbol.asyncIterator]!=null}function Iv(r){if(nV(r))return(async()=>{let e=0;for await(const t of r)e++;return e})();{let e=0;for(const t of r)e++;return e}}class iV{log;peerId;peerRouting;events;count;interval;initialInterval;queryTimeout;running;timeoutId;controller;initialQuerySelfHasRun;querySelfPromise;constructor(e,t){this.peerId=e.peerId,this.log=e.logger.forComponent(`${t.logPrefix}:query-self`),this.events=e.events,this.running=!1,this.peerRouting=t.peerRouting,this.count=t.count??xv,this.interval=t.interval??_F,this.initialInterval=t.initialInterval??TF,this.queryTimeout=t.queryTimeout??PF,this.initialQuerySelfHasRun=t.initialQuerySelfHasRun,this.querySelf=Cv(this.querySelf.bind(this),t.operationMetrics,"SELF_QUERY")}isStarted(){return this.running}start(){this.running||(this.running=!0,clearTimeout(this.timeoutId),this.timeoutId=setTimeout(()=>{this.querySelf().catch(e=>{this.log.error("error running self-query - %e",e)})},this.initialInterval))}stop(){this.running=!1,this.timeoutId!=null&&clearTimeout(this.timeoutId),this.controller!=null&&this.controller.abort()}async querySelf(){if(!this.running){this.log("skip self-query because we are not started");return}if(this.querySelfPromise!=null)return this.log("joining existing self query"),this.querySelfPromise.promise;if(this.querySelfPromise=Ze(),this.running){this.controller=new AbortController;const e=[this.controller.signal];if(this.initialQuerySelfHasRun==null){const n=AbortSignal.timeout(this.queryTimeout);e.push(n)}const t=Ke(e);this.controller.signal;try{this.log("run self-query, look for %d peers timing out after %dms",this.count,this.queryTimeout);const n=Date.now(),i=await zs(this.peerRouting.getClosestPeers(this.peerId.toMultihash().bytes,{signal:t,isSelfQuery:!0}),o=>Sd(o,this.count),async o=>Iv(o));t?.throwIfAborted();const s=Date.now()-n;this.log("self-query found %d peers in %dms",i,s),this.events.dispatchEvent(new CustomEvent("kad-dht:query:self",{detail:{peers:i,duration:s}}))}catch(n){this.log.error("self-query error - %e",n)}finally{t.clear(),this.initialQuerySelfHasRun!=null&&(this.initialQuerySelfHasRun.resolve(),this.initialQuerySelfHasRun=void 0)}}this.querySelfPromise.resolve(),this.querySelfPromise=void 0,this.running&&(this.timeoutId=setTimeout(()=>{this.querySelf().catch(e=>{this.log.error("error running self-query - %e",e)})},this.interval))}}class sV extends Qe{log;reprovideQueue;maxQueueSize;datastore;timeout;reprovideTimeout;running;shutdownController;reprovideThreshold;contentRouting;datastorePrefix;addressManager;validity;interval;peerId;constructor(e,t){super(),this.log=e.logger.forComponent(`${t.logPrefix}:reprovider`),this.peerId=e.peerId,this.reprovideQueue=new $i({concurrency:t.concurrency??AF,metrics:e.metrics,metricName:`${t.metricsPrefix}_reprovide_queue`}),this.reprovideTimeout=new zc({...t.timeout??{},metrics:e.metrics,metricName:`${t.metricsPrefix}_reprovide_timeout_milliseconds`}),this.datastore=e.datastore,this.addressManager=e.addressManager,this.datastorePrefix=`${t.datastorePrefix}/provider`,this.reprovideThreshold=t.threshold??xF,this.maxQueueSize=t.maxQueueSize??kF,this.validity=t.validity??Sv,this.interval=t.interval??CF,this.contentRouting=t.contentRouting,this.running=!1,this.reprovide=Cv(this.reprovide.bind(this),t.operationMetrics,"PROVIDE")}start(){this.running||(this.running=!0,this.shutdownController=new AbortController,this.shutdownController.signal,this.timeout=setTimeout(()=>{this.processRecords({signal:AbortSignal.timeout(Gy)}).catch(e=>{this.log.error("error running process to reprovide/cleanup - %e",e)})},this.interval))}stop(){this.running=!1,this.reprovideQueue.clear(),clearTimeout(this.timeout),this.shutdownController?.abort()}async processRecords(e){try{this.safeDispatchEvent("reprovide:start"),this.log("starting reprovide/cleanup");for await(const t of this.datastore.query({prefix:this.datastorePrefix},e))try{const{cid:n,peerId:i}=Av(t.key),o=kv(t.value).getTime()+this.validity,a=Date.now(),c=a>o,l=this.peerId.equals(i);this.log.trace("comparing: %d (now) < %d (expires) = %s %s",a,o,c,c?"(expired)":"(valid)"),c&&!l&&await this.datastore.delete(t.key,e),this.shouldReprovide(l,o)&&(this.log("reproviding %c as it is within the reprovide threshold (%d)",n,this.reprovideThreshold),this.queueReprovide(n).catch(u=>{this.log.error("could not reprovide %c - %e",n,u)}))}catch(n){this.log.error("error processing datastore key %s - %s",t.key,n.message)}this.log("reprovide/cleanup successful")}finally{this.safeDispatchEvent("reprovide:end"),this.running&&(this.log("queuing next re-provide/cleanup run in %d ms",this.interval),this.timeout=setTimeout(()=>{this.processRecords({signal:AbortSignal.timeout(Gy)}).catch(t=>{this.log.error("error running re-provide - %e",t)})},this.interval))}}shouldReprovide(e,t){if(!e)return!1;const n=Date.now();return t<n?!0:t-n<this.reprovideThreshold}async queueReprovide(e,t){if(!this.running)return;this.log.trace("waiting for queue capacity before adding %c to re-provide queue",e),await this.reprovideQueue.onSizeLessThan(this.maxQueueSize,t);const n=this.reprovideQueue.queue.find(i=>i.options.cid.equals(e));if(n!=null)return this.log.trace("not adding %c to re-provide queue - already in queue",e),n.join();this.log.trace("adding %c to re-provide queue",e),this.reprovideQueue.add(async i=>{if(i.signal?.throwIfAborted(),!this.running)return;this.log.trace("re-providing %c",e);const s=this.reprovideTimeout.getTimeoutSignal(i);try{await this.reprovide(i.cid,i)}finally{this.reprovideTimeout.cleanUp(s)}this.log.trace("re-provided %c",e)},{signal:this.shutdownController?.signal,cid:e}).catch(i=>{this.log.error("could not re-provide key %c - %e",e,i)})}async reprovide(e,t){await Li(this.contentRouting.provide(e,this.addressManager.getAddresses(),t))}}const oV=20,aV=5e3,cV="kad-close",lV=50;class uV{routingTable;components;closestPeers;newPeers;refreshInterval;peerSetSize;timeout;closeTagName;closeTagValue;log;running;constructor(e,t){this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:routing-table`),this.routingTable=t.routingTable,this.refreshInterval=t.refreshInterval??aV,this.peerSetSize=t.peerSetSize??oV,this.closeTagName=t.closeTagName??cV,this.closeTagValue=t.closeTagValue??lV,this.closestPeers=new xn,this.onPeerPing=this.onPeerPing.bind(this),this.running=!1}async start(){if(this.running)return;this.running=!0;const e=await Qn(this.components.peerId);this.newPeers=new g3(e,this.peerSetSize),this.routingTable.addEventListener("peer:ping",this.onPeerPing),this.timeout=setInterval(()=>{this.updatePeerTags().catch(t=>{this.log.error("error updating peer tags - %e",t)})},this.refreshInterval)}stop(){this.running=!1,this.routingTable.removeEventListener("peer:ping",this.onPeerPing),clearTimeout(this.timeout)}onPeerPing(e){this.newPeers?.add({id:e.detail,multiaddrs:[]}).catch(t=>{this.log.error("error adding peer to distance list - %e",t)})}async updatePeerTags(){const e=new xn(this.newPeers?.peers.map(({peer:i})=>i.id)),t=e.difference(this.closestPeers),n=this.closestPeers.difference(e);this.closestPeers=e,await Promise.all([...[...t].map(async i=>{await this.components.peerStore.merge(i,{tags:{[this.closeTagName]:{value:this.closeTagValue},[Yy]:{value:1}}})}),...[...n].map(async i=>{await this.components.peerStore.merge(i,{tags:{[this.closeTagName]:void 0,[Yy]:void 0}})})])}}function Hu(r){return Array.isArray(r?.peers)}class dV{peerId;root;localPeer;prefixLength;splitThreshold;kBucketSize;numberOfNodesToPing;lastPingThreshold;ping;verify;onAdd;onRemove;onMove;addingPeerMap;constructor(e,t){this.peerId=e.peerId,this.prefixLength=t.prefixLength??pV,this.kBucketSize=t.kBucketSize??m3,this.splitThreshold=t.splitThreshold??this.kBucketSize,this.numberOfNodesToPing=t.numberOfOldContactsToPing??yV,this.lastPingThreshold=t.lastPingThreshold??EV,this.ping=t.ping,this.verify=t.verify,this.onAdd=t.onAdd,this.onRemove=t.onRemove,this.addingPeerMap=Jh({name:`${t.metricsPrefix}_adding_peer_map`,metrics:e.metrics}),this.root={prefix:"",depth:0,peers:[]}}async start(){await this.addSelfPeer(this.peerId)}stop(){this.addingPeerMap.clear(),this.root={prefix:"",depth:0,peers:[]}}async addSelfPeer(e,t){this.localPeer={peerId:e,kadId:await Qn(e,t),lastPing:Date.now()}}async add(e,t){const n={peerId:e,kadId:await Qn(e,t),lastPing:0},i=this.addingPeerMap.get(e);if(i!=null)return i;try{const s=this._add(n,t);this.addingPeerMap.set(e,s),await s}finally{this.addingPeerMap.delete(e)}}async _add(e,t){const n=this._determineBucket(e.kadId);if(this._indexOf(n,e.kadId)>-1)return;if(n.peers.length===this.splitThreshold&&n.depth<this.prefixLength){await this._split(n,t),await this._add(e,t);return}if(n.peers.length<this.kBucketSize){if(!fV(e,this.lastPingThreshold)){n.peers.push(e),await this.onAdd?.(e,n,t);return}await this.verify(e,t)&&(e.lastPing=Date.now(),await this._add(e,t));return}const i=n.peers.filter(o=>!(o.peerId.equals(this.localPeer?.peerId)||o.lastPing>Date.now()-this.lastPingThreshold)).sort((o,a)=>o.lastPing<a.lastPing?-1:o.lastPing>a.lastPing?1:0).slice(0,this.numberOfNodesToPing);let s=!1;for await(const o of this.ping(i,t))s=!0,await this.remove(o.kadId,t);s&&await this._add(e,t)}*closest(e,t){const n=new g3(e,t?.count??this.kBucketSize);for(const i of this.toIterable())t?.exclude?.some(s=>s.equals(i.peerId))!==!0&&n.addWithKadId({id:i.peerId,multiaddrs:[]},i.kadId);yield*Ki(n.peers,({peer:i})=>i.id)}count(){function e(t){if(Hu(t))return t.peers.length;let n=0;return t.left!=null&&(n+=e(t.left)),t.right!=null&&(n+=e(t.right)),n}return e(this.root)}get(e){const t=this._determineBucket(e),n=this._indexOf(t,e);return t.peers[n]}async remove(e,t){const n=this._determineBucket(e),i=this._indexOf(n,e);if(i>-1){const s=n.peers.splice(i,1)[0];await this.onRemove?.(s,n,t)}}*toIterable(){function*e(t){if(Hu(t)){yield*t.peers;return}yield*e(t.left),yield*e(t.right)}yield*e(this.root)}distance(e,t){return BigInt("0x"+Y(qo(e,t),"base16"))}_determineBucket(e){const t=Y(e,"base2");function n(i,s=0){return Hu(i)?i:t[s]==="0"?n(i.left,s+1):n(i.right,s+1)}return n(this.root)}_indexOf(e,t){return e.peers.findIndex(n=>Te(n.kadId,t))}async _split(e,t){const n={prefix:"0",depth:e.depth+1,peers:[]},i={prefix:"1",depth:e.depth+1,peers:[]};for(const s of e.peers)Y(s.kadId,"base2")[e.depth]==="0"?(n.peers.push(s),await this.onMove?.(s,e,n,t)):(i.peers.push(s),await this.onMove?.(s,e,i,t));hV(e,n,i)}}function hV(r,e,t){return delete r.peers,r.left=e,r.right=t,r.prefix===""&&(delete r.depth,delete r.prefix),!0}function fV(r,e){return r.lastPing<Date.now()-e}const m3=20,pV=6,gV=20,mV=100,yV=3,wV=20,bV=100,t6="kad-peer",vV=1,EV=6e5,SV=!0,xV=1e3;class AV extends Qe{kBucketSize;kb;network;closestPeerTagger;log;components;running;pingNewContactTimeout;pingNewContactQueue;pingOldContactTimeout;pingOldContactQueue;populateFromDatastoreOnStart;populateFromDatastoreLimit;protocol;peerTagName;peerTagValue;metrics;shutdownController;constructor(e,t){super(),this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:routing-table`),this.kBucketSize=t.kBucketSize??m3,this.running=!1,this.protocol=t.protocol,this.network=t.network,this.peerTagName=t.peerTagName??t6,this.peerTagValue=t.peerTagValue??vV,this.pingOldContacts=this.pingOldContacts.bind(this),this.verifyNewContact=this.verifyNewContact.bind(this),this.peerAdded=this.peerAdded.bind(this),this.peerRemoved=this.peerRemoved.bind(this),this.populateFromDatastoreOnStart=t.populateFromDatastoreOnStart??SV,this.populateFromDatastoreLimit=t.populateFromDatastoreLimit??xV,this.shutdownController=new AbortController,this.shutdownController.signal,this.pingOldContactQueue=new Fi({concurrency:t.pingOldContactConcurrency??wV,metricName:`${t.metricsPrefix}_ping_old_contact_queue`,metrics:this.components.metrics,maxSize:t.pingOldContactMaxQueueSize??bV}),this.pingOldContactTimeout=new zc({...t.pingOldContactTimeout??{},metrics:this.components.metrics,metricName:`${t.metricsPrefix}_routing_table_ping_old_contact_time_milliseconds`}),this.pingNewContactQueue=new Fi({concurrency:t.pingNewContactConcurrency??gV,metricName:`${t.metricsPrefix}_ping_new_contact_queue`,metrics:this.components.metrics,maxSize:t.pingNewContactMaxQueueSize??mV}),this.pingNewContactTimeout=new zc({...t.pingNewContactTimeout??{},metrics:this.components.metrics,metricName:`${t.metricsPrefix}_routing_table_ping_new_contact_time_milliseconds`}),this.kb=new dV(e,{kBucketSize:t.kBucketSize,prefixLength:t.prefixLength,splitThreshold:t.splitThreshold,numberOfOldContactsToPing:t.numberOfOldContactsToPing,lastPingThreshold:t.lastPingThreshold,ping:this.pingOldContacts,verify:this.verifyNewContact,onAdd:this.peerAdded,onRemove:this.peerRemoved,metricsPrefix:t.metricsPrefix}),this.closestPeerTagger=new uV(this.components,{logPrefix:t.logPrefix,routingTable:this,peerSetSize:t.closestPeerSetSize,refreshInterval:t.closestPeerSetRefreshInterval,closeTagName:t.closeTagName,closeTagValue:t.closeTagValue}),this.components.metrics!=null&&(this.metrics={routingTableSize:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_size`),routingTableKadBucketTotal:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_total`),routingTableKadBucketAverageOccupancy:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_average_occupancy`),routingTableKadBucketMinOccupancy:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_min_occupancy`),routingTableKadBucketMaxOccupancy:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_max_occupancy`),routingTableKadBucketMaxDepth:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_max_depth`),kadBucketEvents:this.components.metrics.registerCounterGroup(`${t.metricsPrefix}_kad_bucket_events_total`)})}isStarted(){return this.running}async start(){this.running||(this.running=!0,this.shutdownController=new AbortController,this.shutdownController.signal,await Cn(this.closestPeerTagger,this.kb))}async afterStart(){let e=0;Promise.resolve().then(async()=>{if(!this.populateFromDatastoreOnStart)return;const t=Ke([this.shutdownController.signal,AbortSignal.timeout(2e4)]);try{for(const n of await this.components.peerStore.all({filters:[i=>i.protocols.includes(this.protocol)&&i.tags.has(t6)],limit:this.populateFromDatastoreLimit,signal:t})){if(!this.running)return;try{await this.add(n.id,{signal:t}),e++}catch{this.log("failed to add peer %p to routing table, removing kad-dht peer tags - %e"),await this.components.peerStore.merge(n.id,{tags:{[this.peerTagName]:void 0}})}}}finally{t.clear()}this.log("added %d peer store peers to the routing table",e)}).catch(t=>{this.log.error("error adding %d, peer store peers to the routing table - %e",e,t)})}async stop(){this.running=!1,await ni(this.closestPeerTagger,this.kb),this.pingOldContactQueue.abort(),this.pingNewContactQueue.abort(),this.shutdownController.abort()}async peerAdded(e,t,n){this.components.peerId.equals(e.peerId)||await this.components.peerStore.merge(e.peerId,{tags:{[this.peerTagName]:{value:this.peerTagValue}}},n),this.updateMetrics(),this.metrics?.kadBucketEvents.increment({peer_added:!0}),this.safeDispatchEvent("peer:add",{detail:e.peerId})}async peerRemoved(e,t,n){this.components.peerId.equals(e.peerId)||await this.components.peerStore.merge(e.peerId,{tags:{[this.peerTagName]:void 0}},n),this.updateMetrics(),this.metrics?.kadBucketEvents.increment({peer_removed:!0}),this.safeDispatchEvent("peer:remove",{detail:e.peerId})}async*pingOldContacts(e,t){if(!this.running)return;const n=[];for(const i of e){if(this.kb.get(i.kadId)==null){this.log("asked to ping contact %p that was not in routing table",i.peerId);continue}this.metrics?.kadBucketEvents.increment({ping_old_contact:!0}),n.push(async()=>{const s=this.pingOldContactQueue.find(i.peerId);if(s!=null)return this.log("asked to ping contact %p was already being pinged",i.peerId),await s.join(t)?void 0:i;if(!await this.pingOldContactQueue.add(async a=>{const c=this.pingOldContactTimeout.getTimeoutSignal(),l=Ke([c,this.shutdownController.signal,a?.signal]);try{return await this.pingContact(i,a)}catch{return this.metrics?.kadBucketEvents.increment({ping_old_contact_error:!0}),!0}finally{this.pingOldContactTimeout.cleanUp(c),l.clear()}},{peerId:i.peerId,signal:t?.signal}))return i})}for await(const i of Ys(n))i!=null&&(yield i)}async verifyNewContact(e,t){const n=this.pingNewContactTimeout.getTimeoutSignal(),i=Ke([n,this.shutdownController.signal,t?.signal]);try{const s=this.pingNewContactQueue.find(e.peerId);return s!=null?(this.log("joining existing ping to add new peer %p to routing table",e.peerId),await s.join({signal:i})):await this.pingNewContactQueue.add(async o=>(this.metrics?.kadBucketEvents.increment({ping_new_contact:!0}),this.log("pinging new peer %p before adding to routing table",e.peerId),this.pingContact(e,o)),{peerId:e.peerId,signal:i})}catch{return this.log.trace("tried to add peer %p but they were not online",e.peerId),this.metrics?.kadBucketEvents.increment({ping_new_contact_error:!0}),!1}finally{this.pingNewContactTimeout.cleanUp(n),i.clear()}}async pingContact(e,t){try{return this.log("pinging contact %p",e.peerId),await this.components.ping.ping(e.peerId,t),this.log("contact %p ping ok",e.peerId),this.safeDispatchEvent("peer:ping",{detail:e.peerId}),!0}catch(n){return this.log("error pinging old contact %p - %e",e.peerId,n),!1}}get size(){return this.kb==null?0:this.kb.count()}async find(e,t){const n=await Qn(e,t);return this.kb.get(n)?.peerId}closestPeer(e){const t=this.closestPeers(e,{count:1});if(t.length>0)return t[0]}closestPeers(e,t){return this.kb==null?[]:[...this.kb.closest(e,t)]}async add(e,t){if(this.kb==null)throw new Error("RoutingTable is not started");await this.kb.add(e,t)}async remove(e,t){if(this.kb==null)throw new Error("RoutingTable is not started");const n=await Qn(e,t);await this.kb.remove(n,t)}updateMetrics(){if(this.metrics==null||this.kb==null)return;let e=0,t=0,n=0,i=20,s=0;function o(a){if(Hu(a)){a.depth>n&&(n=a.depth),t++,e+=a.peers.length,a.peers.length<i&&(i=a.peers.length),a.peers.length>s&&(s=a.peers.length);return}o(a.left),o(a.right)}o(this.kb.root),this.metrics.routingTableSize.update(e),this.metrics.routingTableKadBucketTotal.update(t),this.metrics.routingTableKadBucketAverageOccupancy.update(Math.round(e/t)),this.metrics.routingTableKadBucketMinOccupancy.update(i),this.metrics.routingTableKadBucketMaxOccupancy.update(s),this.metrics.routingTableKadBucketMaxDepth.update(n)}}const kV=[77591,22417,43971,28421,740,29829,71467,228973,196661,78537,27689,36431,44415,14362,19456,106025,96308,2882,49509,21149,87173,131409,75844,23676,121838,30291,17492,2953,7564,110620,129477,127283,53113,72417,165166,109690,21200,102125,24049,71504,90342,25307,72039,26812,26715,32264,133800,71161,88956,171987,51779,24425,16671,30251,186294,247761,14202,2121,8465,35024,4876,85917,169730,3638,256836,96184,943,18678,6583,52907,35807,112254,214097,18796,11595,9243,23554,887,268203,382004,24590,111335,11625,16619,29039,102425,69006,97976,92362,32552,63717,41433,128974,137630,59943,10019,13986,35430,33665,108037,43799,43280,38195,29078,58629,18265,14425,46832,235538,40830,77881,110717,58937,3463,325358,51300,47623,117252,19007,10170,20540,91237,294813,4951,79841,56232,36270,128547,69209,66275,100156,32063,73531,34439,80937,28892,44466,88595,216307,32583,49620,16605,82127,45807,21630,78726,20235,40163,111007,96926,5567,72083,21665,58844,39419,179767,48328,42662,51550,5251,37811,49608,81056,50854,55513,20922,18891,197409,164656,32593,71449,220474,58919,85682,67854,13758,35066,3565,61905,214793,119572,141419,21504,10302,27354,67003,46131,32668,15165,64871,34450,17821,2757,11452,34189,5160,12257,85523,560,53385,65887,119549,135620,312353,115979,122356,10867,193231,124537,54783,90675,120791,4715,142253,50943,17271,43358,25331,4917,120566,34580,12878,33786,160528,32523,4869,301307,104817,81491,23276,8832,97911,31265,52065,7998,49622,9715,43998,34091,84587,20664,69041,29419,53205,10838,58288,116145,6185,5154,141795,35924,21307,144738,43730,12085,8279,10002,119,133779,199668,72938,31768,39176,67875,38453,9700,44144,4121,116048,41733,12868,82669,92308,128,34262,11332,7712,90764,36141,13553,71312,77470,117314,96549,49135,23602,54468,28605,6327,62308,17171,67531,21319,14105,894,107722,46157,8503,51069,100472,45138,15246,14577,35609,191464,1757,13364,161349,32067,91705,81144,52339,5408,91066,21983,14157,100545,4372,26630,129112,1423,29676,213626,4397,88436,99190,6877,49958,26122,114348,60661,29818,293118,50042,179738,16400,163423,89627,31040,43973,36638,45952,5153,1894,109322,1898,134021,12402,112077,68309,190269,69866,31938,107383,11522,105232,11248,14868,39852,71707,186525,16530,38162,106212,11700,5130,16608,26998,59586,108399,230033,43683,48135,82179,2073,5015,196684,189293,16378,23452,8301,35640,11632,214551,29240,57644,33137,91949,55157,52384,117313,5090,17717,89668,49363,82238,241035,66216,29066,184088,97206,62820,26595,4241,135635,173672,8202,459,71355,146294,29587,3008,135385,141203,14803,6634,45094,69362,50925,546,51884,62011,83296,234584,44515,56050,89476,87751,19373,12691,149923,19794,13833,35846,87557,58339,2884,19145,25647,12224,11024,77338,64608,122297,53025,7205,36189,36294,170779,21750,7739,173883,75192,35664,224240,113121,30181,26267,27036,117827,92015,106516,55628,203549,67949,60462,60844,35911,20457,1820,920,19773,8738,73173,181993,38521,98254,76257,46008,92796,5384,26868,151566,22124,2411,15919,186872,180021,28099,152961,78811,80237,62352,102653,74259,184890,16792,123702,224945,29940,19512,75283,14059,112691,92811,233329,20411,138569,53341,109802,50600,134528,66747,5529,166531,31578,64732,67189,1596,126357,967,167999,206598,109752,119431,207825,78791,91938,10301,27311,24233,252343,28831,32812,66002,112267,90895,8786,8095,16824,22866,21813,60507,174833,19549,130985,117051,52110,6938,81923,123864,38061,919,18680,53534,46739,112893,161529,85429,26761,11900,81121,91968,15390,217947,56524,1713,6654,37089,85630,138866,61850,16491,75577,16884,98296,73523,6140,44645,6062,36366,29844,57946,37932,42472,5266,20834,19309,33753,127182,134259,35810,41805,45878,312001,14881,47757,49251,120050,44252,3708,25856,107864,120347,1228,36550,41682,34496,47025,8393,173365,246526,12894,161607,35670,90785,126572,2095,124731,157033,58694,554,12786,9642,4817,16136,47864,174698,66992,4639,69284,10625,40710,27763,51738,30404,264105,137904,109882,52487,42824,57514,2740,10479,146799,107390,16586,88038,174951,9410,16185,44158,5568,40658,46108,12763,97385,26175,108859,664,230732,67470,46663,14395,50750,141320,93140,15361,47997,55784,6791,307840,118569,107326,18056,58281,260415,54691,8790,73332,45633,7511,45674,143373,14031,11799,94491,35646,96544,14560,26049,32983,25791,83814,42094,231370,63955,139212,2359,169908,3108,183486,105867,28197,32941,124968,26402,88267,149768,23053,3078,19091,52924,25383,19209,111548,97361,3959,24880,235061,9099,24921,161254,151405,20508,7159,34381,20133,11434,74036,19974,34769,36585,1076,22454,17354,38727,235160,111547,96454,117448,156940,91330,37299,7310,26915,117060,51369,22620,61861,322264,106850,111694,15091,2624,40345,300446,177064,1707,27389,54792,327783,132669,183543,59003,17744,20603,151134,106923,53084,71803,279424,319816,11579,21946,16728,38274,72711,5085,83391,88646,40159,25027,34680,10752,12988,54126,30365,18338,100445,230674,44874,84974,143877,123253,139372,28082,91477,144002,13096,219729,46016,50029,42377,14601,6660,58244,58978,23918,88206,113611,64452,17541,41032,10942,12021,49189,10978,40175,37156,10947,71709,106894,112538,57007,137486,150608,152719,40615,7746,279716,13101,19524,28708,40578,72320,1096,182051,94527,51275,22833,45164,81917,77519,48508,5421,140302,37845,149830,5587,27579,5357,428725,248187,6326,206760,39814,32585,89923,44341,288753,284443,96368,31201,94189,119504,20359,52073,103216,179,27934,32801,96035,34111,34309,101326,18198,20704,210266,37643,27880,141873,106e3,19414,56614,167714,66483,107885,86602,4379,20796,75467,4987,5017,118857,26003,34308,114428,29198,6686,29697,73632,3739,69795,16798,41504,7207,30722,21436,36735,28067,28545,3239,11221,36031,41889,100010,19247,317673,29495,174554,6424,129725,53845,94986,7955,59676,2604,191497,19735,102214,62954,23844,11872,179525,261436,34492,428,78404,142035,16747,17246,27578,37021,33672,57944,26056,135760,2369,61674,122066,31327,19374,157065,40553,130982,69619,71290,38855,72100,92903,95940,51422,165999,65713,57873,50726,7288,20272,2081,42326,22624,81120,57914,79352,19447,1684,72302,11774,302559,161481,96396,13692,414988,3721,79066,56627,46883,21150,11747,12184,5856,113458,176117,84416,52079,27933,3354,59765,141359,2212,216309,2555,23458,196722,142463,45701,44548,28798,19418,215,29916,9396,10574,114226,84475,13520,18694,34056,4524,90302,62930,13539,19407,77209,7728,38088,9535,2263,23875,183945,17750,26274,67172,10585,28042,22199,7478,51331,66030,26774,192929,31434,25850,50197,52926,178158,4679,181256,70184,229600,9959,105594,72158,73974,2726,35085,78087,23284,35568,51713,155676,5401,27254,11966,17569,223253,71993,103357,111477,55722,30504,26034,46774,35392,36285,214814,41143,163465,1051,16094,81044,6636,76489,179102,20712,39178,35683,125177,54219,30617,52994,25324,50123,2543,87529,58995,10688,125199,12388,60158,125481,131646,7642,133350,65874,3438,97277,101450,10075,56344,116821,50778,60547,98016,106135,13859,14255,16300,77373,173521,8285,45932,37426,4054,114295,55947,7703,39114,52,51119,128135,19714,60715,9554,50492,88180,2823,118271,52993,122625,97919,23859,37895,25040,33614,32102,20431,3577,9275,15686,43031,157741,110358,1884,40291,125391,13736,5008,64881,87336,77381,70711,43032,49155,118587,70494,4318,10168,30126,12580,10524,280104,104001,145413,2862,84140,6603,106005,13566,12780,11251,42830,571,179910,82443,13146,469,42714,32591,265217,424024,92553,54721,134100,6007,15242,114681,59030,16718,85465,200214,85982,55174,165013,23493,56964,82529,109150,32706,27568,82442,5350,14976,13165,44890,60021,21343,33978,17264,4655,22328,27819,75730,16567,55483,14510,17926,45827,150609,3704,7385,272531,161543,76904,122163,52405,2039,19165,41623,14423,228354,3369,176360,85491,7122,35789,303724,4465,13628,2233,55311,118771,20713,10006,221519,45115,71021,35650,29775,7337,10864,20665,21142,1746,15080,1624,32449,10905,105743,229797,7701,3940,22997,178467,57208,389057,39683,59403,63344,63125,54847,69691,18336,56448,3362,37202,18282,29648,138224,35867,10495,5911,28814,26653,31514,176702,26550,45621,11734,4525,40543,73944,121080,27858,155561,14887,44670,30742,8796,107455,113472,56369,75581,183777,240095,133699,153299,8768,160464,26058,49078,103971,21875,71486,44888,17156,9678,89541,123019,102337,3972,83930,21245,87852,109660,287918,183019,686,10100,39177,283941,11274,24736,26793,26214,25995,77011,141580,4070,23742,46285,46632,30700,26669,19056,35951,115575,174034,56097,35463,87425,24575,44245,38701,82317,85922,281616,100333,147697,61503,7730,84330,8530,59917,61597,17173,9092,32658,90288,193136,39023,20381,56654,31132,7779,1919,1375,117128,30819,11169,40938,23935,115201,101155,151034,4835,11231,74550,89388,59951,91704,107312,167882,115062,12732,72738,88703,464019,158267,57995,60496,737,14371,123867,4174,243339,159946,7568,16025,134556,110916,38103,191,80226,88794,29688,27230,10454,76308,57647,77409,113483,66864,14745,19808,12023,46583,84805,16015,17102,2231,20611,3547,95740,250131,34559,108894,8498,15853,159169,148920,20942,2813,93160,45188,210613,45531,52587,149062,39782,28194,57849,60965,84954,89766,84453,100927,16501,27658,165311,103841,54192,207341,19558,20084,319622,5672,205467,98462,61849,36279,13609,147177,24726,165015,209489,59591,31157,6551,117580,75060,141146,277310,21072,22023,106474,63041,137443,122965,68371,5383,42146,98961,113467,30863,23794,4843,99630,30392,82679,13699,241612,33601,93146,24319,18643,32155,95669,40440,15333,34089,67799,142144,58245,38633,114531,117400,77861,188726,5507,2568,8853,10987,107222,2663,2421,11530,13345,30075,41785,118661,104786,17459,12490,16281,71936,193555,17431,5944,71758,26485,77317,20803,367167,158,7362,93430,11735,172445,46002,11532,54482,930,62911,2235,23004,179236,4764,101859,208113,22477,55163,95579,14098,67320,162556,90709,156949,3826,57492,4025,34092,87442,104565,6718,186015,28214,14209,10039,107186,233912,58877,81637,55265,39828,6194,145813,50831,105849,4974,88319,122296,10272,197216,95714,51540,72418,23324,91555,8743,140452,250249,51666,34124,7229,38592,129641,78169,174242,22464,149964,51450,14034,10026,95376,26190,120062,14401,8700,265,31386,143573,7203,229889,61567,4227,140981,2466,72052,10787,10062,30958,6099,38471,30103,23202,208101,70847,467,58934,32271,32984,36637,24107,30771,17109,73353,13650,2098,157040,67366,66904,106018,265380,107238,18535,44025,32681,144983,62505,91295,56120,3082,77508,10322,63023,36700,81885,224127,16721,45023,239261,111272,13852,7866,149243,204199,32309,22084,42029,38316,126644,104973,14406,43454,67322,61310,15789,40285,24026,181047,6301,70927,23319,115823,27248,66693,115875,278566,63007,146844,56841,59007,87368,180001,22370,42114,80605,12022,10374,308,25079,14689,12618,63368,7936,264973,212291,136713,95999,105801,18965,32075,48700,52230,35119,96912,32992,8586,16606,101333,101812,14969,39930,759,193090,27387,42914,12937,5058,62646,64528,38624,25743,37502,3716,4435,30352,178687,26461,132611,42002,138442,35833,59582,16345,8048,60319,49349,309,47800,49739,90482,26405,34470,63786,32479,85028,39866,47846,11649,23934,29466,2816,42864,31828,7410,74885,49632,47629,111801,90749,19536,18767,105764,59606,21223,10746,76298,22220,39408,7190,79654,64856,11602,82156,272765,17079,70089,245473,51813,184407,384678,1576,122249,5064,27481,6188,25790,74361,27541,318284,45430,31488,620,93579,45723,192118,22670,51913,4162,70244,35966,26397,16199,50899,209613,121702,287507,2993,36101,132229,67345,33062,76295,118628,78705,52316,34375,107083,107454,44863,127561,33964,3073,154010,190914,55967,39074,6272,31047,5550,41123,26154,98638,47110,19998,148091,50229,31329,59900,195442,19106,61347,73497,70015,682,45850,25776,38022,148951,6288,37411,232526,109277,27286,32342,9262,5220,16651,23175,46740,129438,78614,121925,66914,88710,127952,5563,21500,34521,10739,14863,191006,62956,17359,16749,67027,56284,69134,43301,35039,58883,54466,60823,404451,75743,59856,86979,7923,34273,83785,32142,7693,268986,197428,282681,17049,22346,22990,92245,107180,3357,37104,96724,49153,7683,31197,43267,82231,164276,23696,20848,188364,22309,24821,158707,1018,22514,70922,27792,45589,59709,10765,736,35218,63479,51987,24275,63588,55361,92929,81964,4658,20122,12330,44058,13065,311456,72224,8337,211229,38979,22590,138478,52757,32595,133600,8838,31549,94412,43391,90056,1585,94802,127271,6223,31889,137038,132910,2165,57616,230152,6080,10748,36737,74579,134062,50525,180532,119270,34556,76155,82394,52595,29258,31435,87820,67996,26943,183878,38007,2410,13526,180297,69856,3503,187396,167700,7838,16701,9199,56267,3661,37407,65994,23767,5708,62508,221700,67088,86978,46776,84434,32088,5612,9149,88244,21685,95151,46750,189612,2979,506311,2594,3628,40074,105039,78243,28523,6651,38058,71999,30992,12764,68261,108991,6165,26450,61961,13400,22426,7490,60890,109623,2070,12958,50355,67979,257096,7213,42578,52121,35716,65461,7516,124758,39268,302,64712,14977,1467,219452,2840,34229,11121,21602,19270,63574,8024,1532,17331,79839,78885,52029,180767,57957,6069,91265,61380,55767,8927,32881,287603,22149,35029,68876,6428,199567,46926,13412,104132,21434,366616,45060,110046,81924,128910,45886,52821,130416,29416,77342,21762,67329,121432,79924,11724,38625,81006,102033,28338,13326,3250,82056,82526,38212,21112,12382,111495,3263,7414,86274,93490,40844,30224,45212,24019,48411,71367,24941,76729,57776,3769,38114,202019,197745,31953,237533,33270,201580,255648,100798,44741,32241,98468,106931,10085,15090,170358,33154,66787,18819,69760,25061,234005,82660,6295,131975,16874,9076,4094,25005,17740,40908,19533,220019,44330,99792,50040,19619,13950,55228,24423,31253,95308,103177,184795,28590,82285,5059,3210,75525,49894,70007,56178,10580,36051,139681,21617,98736,3555,106306,164189,37352,63915,47824,24883,145530,61904,28444,11483,19837,145446,30420,112972,85939,11835,191233,2262,20705,58630,1753,148334,1197,144714,6887,11223,107667,60879,77914,4151,57417,81594,96681,169430,1784,20444,95138,254041,27038,596,7117,72808,13759,3353,126776,21074,55322,27081,36942,39547,139830,179275,4453,713,8722,71399,19204,25785,22794,23923,104114,11291,25458,102309,88396,75288,230440,206396,104551,58447,130857,37247,94734,31548,176529,226077,65159,20104,10096,66881,94191,237909,27109,37404,1520,27421,25220,113003,23423,24884,50585,6286,231877,150800,11789,3226,90004,60642,5053,202400,61442,132531,175329,57138,30116,103847,9973,75367,16452,32360,59119,21246,10191,164804,23305,61051,37348,154530,13214,5468,50403,66754,130976,50559,80515,14436,155492,84017,5472,43107,41240,2890,90431,70188,382,76234,48040,50211,281038,237007,32115,142178,1536,22761,96429,1811,31243,1679,49143,55209,17402,235054,61494,7462,77030,34925,87609,78002,9499,9027,73289,201078,101379,63544,27666,5469,10642,30029,49816,132979,95620,58086,351930,116300,2110,2043,30845,6154,11279,16727,4122,2277,27281,4971,3650,39060,61970,65951,39674,75686,38151,11370,130809,177895,32665,63725,122267,7857,39618,118483,44792,157755,178624,136994,24260,41308,22471,12404,21707,12486,30473,52781,50246,20247,39065,909,56825,103158,128603,31542,1089,41935,32744,12428,37963,84420,33134,72921,208449,42622,168151,127335,147107,46699,38216,12591,94342,85814,31423,24944,2605,87542,67473,192551,4496,56321,91819,17630,6300,256183,114569,202090,33209,35289,34897,24967,40520,43470,5344,10199,34810,14283,10381,10017,62923,49924,23233,64539,13051,35686,19698,11570,135555,120868,44924,87065,52318,52335,47586,140906,245885,109834,78668,9065,46990,25258,72022,61243,40838,4545,146387,10537,11557,17470,36930,68104,46711,24264,79401,81043,18225,120488,24746,84338,81652,28266,13776,21878,46973,1047,230465,73357,95777,24973,210160,62210,58404,110633,169651,6937,41870,9909,26822,191062,76553,27519,96256,239070,2478,205678,67955,58532,20601,50120,19148,78501,195724,110740,8249,109665,27446,30568,57631,31425,49752,32820,65504,50079,3663,102256,219898,23849,211315,14645,4359,91767,9528,12449,49366,7941,49763,107848,8930,27086,50686,9744,10447,81935,39513,46514,1670,29229,6172,22312,137280,97759,9806,14445,22976,56458,73391,34983,93760,174219,52573,33149,59747,2429,136277,75123,165263,91040,7446,57632,48633,97140,246081,84766,151684,79918,93268,120346,54059,54875,77858,32996,103590,45276,11968,19600,25849,17159,132907,42828,16817,4913,99462,103303,27395,5737,74184,20749,21160,14377,77062,131403,158735,10999,27799,77785,9320,34366,51593,61070,33746,47048,29268,36675,30262,53297,9832,82e3,20188,122292,39917,7331,18160,68301,185935,134830,15031,4935,10004,165845,185534,46923,30109,44134,122631,18874,22903,112790,26561,18549,348902,82871,140345,255565,135390,63556,103747,145055,179600,145662,296111,61661,211987,23952,52342,126343,48450,32919,44277,82185,9591,62139,205363,376969,394874,108461,18040,120885,14798,39863,16571,16794,58271,81025,55206,14640,118656,6361,44092,85970,6262,153863,108244,180200,72264,79947,38044,10050,5735,61221,80712,5471,115689,11391,11661,184257,20010,60116,30320,19327,134598,45455,27542,18004,125092,452272,1549,91523,46567,180063,156026,2608,11174,58848,37788,65907,80194,30490,5786,40775,119519,106241,11323,156297,8425,61495,2617,29675,2425,59886,112582,49142,59618,4863,50597,86710,50650,168632,27693,85641,83643,18993,25768,84284,28090,93592,36627,312804,43381,9887,9402,100931,97165,3311,173330,66805,28935,4963,184460,3201,78102,19126,21607,37496,24938,22615,16153,32862,134792,153318,61120,6067,2812,12826,12792,23825,37559,64662,202250,102694,155488,85881,149193,46233,65383,15521,106982,11358,176786,25752,39717,34208,24510,32464,77742,39371,72028,138229,60688,71386,102834,132477,2208,11548,63670,271279,28351,30338,38620,32491,99845,143885,152266,13252,2825,178663,108097,1775,78201,14897,113573,163346,62292,171129,22183,96598,38733,64971,166776,117445,9968,146393,44677,74867,20908,97328,12761,25656,26785,9148,112344,26115,99176,110121,22437,49547,6180,79320,5835,31392,43328,33377,75870,119860,69497,80273,7325,155219,43167,111173,28347,20222,3763,71752,55041,47252,14618,28088,15012,97805,194698,54636,2036,41349,6173,96604,61530,51859,43782,13361,24334,22668,24792,7070,23441,16789,3209,36211,208475,26242,32880,122181,182407,21444,31060,88459,29929,77907,12716,10934,97005,20599,31690,8403,58445,30303,22700,10336,86731,103115,337709,72556,46788,112566,47684,67089,53548,36874,56487,41387,125985,26893,40071,106683,73712,18787,40105,72992,67246,137276,50802,36790,70328,138827,22466,39263,183295,29858,50975,9322,57397,10654,24364,30383,55799,41600,23584,127295,296610,129078,143558,244131,86397,36049,1085,80677,3820,108139,5476,34767,24683,7758,13060,7239,131671,250593,59556,103392,29810,4188,252323,39404,116877,7651,43600,40338,13554,157253,39196,25978,144387,61211,234,50104,6129,10449,93777,9240,356378,274148,4439,72970,3724,147770,78680,62570,115877,40027,40547,36817,224392,64609,34795,165027,67440,2477,37206,23431,50754,164797,46018,94995,170982,27051,7957,22767,3674,27900,56419,18930,60701,41302,2692,84749,339721,61996,111094,80221,50129,1045,8153,62945,19202,8250,37208,37418,32560,79477,41106,88569,33963,36693,5892,30570,1581,66471,49647,11922,160717,29442,5643,114865,82962,95982,132098,22633,22838,94726,54556,28566,205039,162340,33216,16849,35847,221339,94851,26533,71469,1805,3804,12935,45483,71020,36310,65381,192960,34240,35165,59773,1248,46954,155332,96864,4246,388800,16129,57133,74592,44807,442014,38203,42574,80818,91592,26377,36424,65760,977,77387,22628,147610,28018,30561,98454,6969,119628,63648,18170,36854,26601,64018,22027,37279,51395,152934,21153,9430,58760,194742,5330,55115,34158,28917,174111,13171,122326,1526,43896,66094,25325,4234,148354,11450,275,18999,112191,44365,22723,68409,8733,57746,96565,75007,14196,108844,29475,88599,177563,100792,106156,86323,93726,14248,135341,194131,40126,47099,14779,8272,39597,95983,171398,65882,28052,10393,47213,40689,22120,72212,106829,34964,109146,753,648,21660,30047,17527,181025,5619,145357,4085,216883,9359,186951,24779,53931,24545,36197,223296,62628,168101,4243,107313,30321,26642,13049,51059,31027,107912,807,73550,26551,84369,122422,165872,49754,74213,234264,33151,52014,33100,87183,22365,52500,40013,23302,5652,72723,21404,26107,48434,587,94049,168493,96418,32871,70860,31709,25128,443,71597,166253,15670,70994,26341,133675,28280,75491,54756,47955,56028,26182,11952,113272,472197,64640,110753,17919,337,50642,22576,142,87371,53391,93210,126694,15285,19642,85667,14148,1506,42092,52962,33243,11970,20734,135843,57044,58880,13002,219134,22876,64754,232519,4257,43120,321573,24799,64526,124728,52579,81472,70831,276848,17403,74359,23021,182101,74597,23744,148267,12055,7976,5349,11772,67540,167347,65318,18720,127832,108238,22828,90233,9987,259080,118185,73209,79270,13775,90100,137742,90799,70569,15699,19961,9087,67475,57872,39731,8810,134897,131868,146849,19898,3334,2281,167061,91073,60356,467742,74712,188,53179,137679,92769,29241,9537,132595,80119,1041,88962,5976,40171,44911,102859,139059,104558,98987,47761,19272,71472,113864,175377,73338,10857,23402,23758,1591,139864,5644,4076,118760,16427,134198,18853,20291,100849,37423,22038,36677,19071,195521,57445,11069,31869,55718,66882,148490,44,41296,75242,49704,166810,9906,20943,122258,49112,105667,15969,10344,6408,187694,21399,72742,58970,14867,14376,81889,41856,23225,15042,56993,16074,131389,74276,72407,53875,383108,53597,37363,68993,44854,122548,430927,198279,38430,80409,12245,2981,628,2818,17760,37437,238229,7968,46892,2200,3730,34190,65983,37959,112291,87850,70827,6522,20750,73913,111621,41652,19587,2780,58668,25916,85259,18200,168962,95781,42445,102050,7776,57662,103313,47742,96358,41964,66174,100396,29069,204735,19679,27978,7479,40264,22534,61183,36081,107436,58223,14680,23002,101311,24716,124108,12908,5646,31750,40380,14215,232799,102772,14122,96775,61398,50917,12096,149880,67833,598749,124194,155871,49216,790,14677,65319,56917,7440,145744,95701,12206,49405,129269,76199,45732,9767,11058,9047,210885,11051,7392,26307,2130,8132,147526,20802,232698,115660,50060,59789,57344,107623,80343,112676,23291,9866,160971,34032,118291,15719,59730,164911,28975,2659,58046,78480,21854,66209,53863,109085,116045,29021,46481,107552,22130,18764,70254,31272,11300,52460,43933,84738,20721,53869,190840,79673,105300,7561,321817,66924,13940,33281,101046,183181,32176,71878,5678,62924,79535,56646,40303,19559,27703,93042,73368,42187,3670,37376,46440,7023,36816,109628,20680,5940,276440,275233,170848,112093,136996,14984,20226,111441,77693,112960,48577,39370,55707,50314,123404,26570,54281,61372,123391,4857,35928,246740,132507,106646,44241,7196,92258,9825,37688,51197,303141,5590,15476,132986,10955,85782,34486,26696,7991,28813,18858,39546,11703,11365,38185,5716,93555,11925,40121,60002,6985,10976,171384,3887,43394,13337,56346,6381,252336,39573,75042,53711,1028,31781,44295,95925,131713,7214,68125,43571,70954,213234,1628,8760,13391,65485,17320,56038,1710,25248,60803,57399,19839,3870,326,281556,50945,72400,21460,316244,75619,56246,98775,481,13513,55765,50427,7388,123519,32929,57908,27124,61316,101097,57467,30228,48792,10788,20402,37318,50526,155730,34456,158065,145305,17832,43733,64052,4506,35072,205355,177028,184004,187081,68616,35938,83703,10367,36892,93186,260137,51934,89970,4985,23445,26755,21558,7948,78741,23376,124405,85594,68596,57536,49351,12619,56593,132668,99924,109728,71844,71935,196018,65464,17617,14987,89701,143773,33997,8687,22701,33258,2914,4436,72108,85610,9671,49067,2327,82988,1361,1672,44033,35777,30269,24057,10605,82236,616,15793,13919,47249,112086,116698,9484,80207,90574,33304,68624,93127,56101,42210,160929,4827,38995,38095,4701,125119,5027,33680,9236,231236,14135,87837,23318,70261,78893,30151,81482,14332,1084,74256,27532,46644,79185,3148,62615,6981,55672,31668,36825,1849,14536,37446,14738,23779,43058,162749,72199,1168,21346,5592,85932,85302,9668,18351,57135,150360,2080,228015,77953,34670,119302,151751,31009,106725,84265,45214,59289,74178,113071,263206,111009,4021,44449,188119,192629,123592,392506,292847,114487,12831,205858,9852,20780,79648,75767,357014,97721,18166,21005,67950,33226,204009,16536,2987,11335,66717,144910,47950,17262,55060,15063,2934,51038,26775,178497,66008,3427,49433,128592,20036,157553,63861,3089,23015,51210,28696,35933,49942,71135,231518,99620,17248,21835,176536,20676,16944,38700,165831,233253,295625,36723,13023,52745,10907,19423,67972,125868,95473,82875,1183,108455,52685,33417,64095,21433,52438,33191,127809,44505,211823,7810,2752,95548,162031,7185,91196,47563,61721,33359,17897,23682,42806,178101,22874,49707,199897,75419,82456,8618,11171,79712,116847,18783,44190,46564,5346,59046,95032,7893,14916,3214,26800,24172,121453,34362,10250,17408,18888,4840,68696,22831,13162,36005,32512,14800,62357,41723,45046,27247,37486,5372,2564,34261,298500,66509,133920,89138,31305,117697,19097,108304,81386,84106,23802,46411,63304,946,51417,41777,41041,19501,115864,60743,294354,37955,94165,18116,1156,17937,20645,57114,90804,58042,48643,92288,9861,2557,88546,61333,101008,12853,5148,87856,4152,144503,73841,18718,9789,147565,10846,42085,12789,30223,8993,56352,67203,2448,28215,6052,23540,126319,75933,36689,80235,23231,23561,21383,38800,77548,102798,21234,31468,158608,46188,63960,191679,8051,67014,11185,170078,42186,28827,34777,41930,212079,12421,34750,24111,110344,73918,45171,70826,141949,40063,23979,24254,37309,26724,27179,24718,83648,54938,14591,17425,29525,102675,48975,48654,12316,8929,60640,41709,50168,63264,89812,50716,48632,38755,138583,160123,55579,71829,24230,233277,46322,39650,166388,34718,24108,98252,7031,106695,62498,18258,35062,217827,78731,34824,33354,19520,60852,2432,60224,8587,2836,62955,702,20227,42285,40560,95592,62486,11094,53035,143291,18842,46177,77994,1770,9657,107422,172915,32655,128716,25886,25164,156740,119928,165875,85817,11007,89110,33956,12652,65156,180266,8494,36889,19958,20955,96,1264,118288,135769,44754,86671,5632,19026,168220,289120,33569,93821,66144,70635,7687,5642,2714,55445,56636,71545,184182,93133,7332,37389,12643,52315,22729,11014,158742,17050,152889,50178,34601,41945,52136,9948,26914,63548,95721,115951,40759,8960,158258,38938,49232,48325,42234,81523,253019,66128,40978,20048,238048,38760,62928,122560,118532,43687,137472,163689,26680,9878,17448,51035,16211,60834,36749,29178,14241,59868,150086,2305,26477,42422,34342,165341,83279,33894,14257,29928,12743,13957,125571,89134,66712,10952,16507,147839,30146,7249,16565,45399,39874,114565,215780,31990,230881,171477,102,196546,44538,10880,84948,281705,86651,10617,31395,2342,453658,43569,60561,132901,21845,17727,58556,258242,22262,58728,4008,77997,11806,37431,30599,81375,109137,185787,114085,217292,97453,169085,30593,60212,11544,102056,65580,2384,91655,4855,95725,7295,157994,16228,20669,53276,141590,105246,17334,25440,76067,17967,39321,38911,11362,28559,63807,21627,26468,85816,40120,1025,15234,58319,69516,66512,124548,75845,78873,22137,46681,51242,85683,32909,76747,35555,43396,101465,1765,73094,1077,2962,39028,66777,57831,42048,15828,13962,36041,63657,52412,5242,58846,2141,5506,219012,134451,3936,182230,17558,17153,152237,22621,49377,170216,35257,68233,65374,6510,11126,212151,7184,2480,22517,3437,33073,30156,16557,3768,55067,86829,91e3,12350,148650,66017,79424,70885,49066,28250,21369,51213,34533,11510,3258,18176,18465,84413,6315,36411,163765,4346,356,107618,598,13727,285026,162695,8749,14583,7132,63521,184253,32378,25991,5604,30961,53675,4874,84693,5086,34811,26978,56564,7904,33519,51221,113942,69253,6664,125563,22055,220680,102008,742,51930,19494,176108,44424,35123,13025,75685,11759,74335,22250,181453,131147,16984,132115,154311,11991,76452,52609,85351,196,30969,9198,74919,2529,56838,71779,29187,116304,3504,62330,41190,86153,28393,254926,104228,105189,13264,84359,3574,12415,8534,57147,10175,188174,59504,60932,66318,16407,107921,17638,99103,49278,28403,39786,145865,8462,3558,43406,142271,29139,21989,36552,93955,72365,7176,13556,106185,37957,321774,17782,129017,51154,27938,24952,1935,39366,2791,33489,41582,56078,24558,9311,5449,218786,27808,190429,68013,36020,86003,29735,3404,87348,119357,115714,2324,86796,81973,40992,43376,93621,28784,16808,36367,2517,2909,191926,24978,55303,53308,205724,60068,3098,21375,64784,23949,26579,63121,12319,80145,39967,97861,6757,70143,67642,37082,34698,69140,122883,46151,62187,80934,429,19437,135071,137885,222647,13331,154065,327,61778,74257,40116,37493,14855,85079,237641,42342,102164,199965,71204,4662,29368,5042,113914,122214,8955,13149,102503,43173,5659,163787,69003,307084,63392,171080,21390,81918,86666,36622,24126,28887,5736,28054,207170,163428,79891,346467,95363,38980,111806,80828,9200,19288,294896,114468,87405,111715,141705,7015,72754,68463,48738,243147,33397,101210,37051,98801,82847,20397,4940,185559,18716,54718,83491,11725,40803,1128,12128,23060,5174,7745,67007,46701,1571,27807,180186,256996,18975,16837,7877,212758,250379,15440,87954,57755,24719,124057,83461,258,50864,8874,29038,71289,31627,15429,9005,4061,113851,107716,82819,13651,79656,117851,17539,111446,12938,39724,190787,4352,15402,21070,62708,8539,23777,73853,13552,38810,86117,16285,56400,1718,75342,142863,29033,378,110113,180321,32586,23606,26393,160984,207987,23783,8406,16904,24596,47274,11693,46539,60524,78595,48423,31718,20170,9009,146268,15183,191060,172765,1349,138436,37365,10970,40509,225817,20021,70394,152138,21541,66559,66544,89352,2725,17258,91345,7313,3815,115868,8660,40362,4071,103524,39388,118275,21950,6549,38226,32754,209574,29201,43495,18028,20296,40597,18370,47520,202450,24134,2219,8195,69545,38041,136934,46374,19041,159811,84865,58620,846,98749,13569,30714,97246,32186,4479,27355,92973,35214,151491,75963,37631,1561,27200,238083,23182,60756,12291,25766,39355,102333,87362,65741,59906,19538,201575,48772,102938,24438,292580,39964,66366,9004,61379,50548,37622,38732,28379,68180,76622,17488,69849,5963,7219,48143,43413,55358,540,58691,29506,19245,52193,48621,5518,13048,118625,44755,191081,42061,89197,2259,60665,66994,71210,51232,3585,142096,55024,7892,8345,58653,463307,65658,64319,137941,136323,53499,12746,43492,6978,95163,29925,60175,5128,7352,41463,184756,121146,20473,18426,4598,5309,54580,14277,121151,10691,56711,43880,63409,76682,11830,172218,264898,32632,66536,81062,31649,25788,92774,60222,11100,63159,9432,224657,25240,53613,152,138620,163829,2397,85345,12501,37507,64932,38575,43522,65789,80198,78796,35226,3851,108891,73311,3060,28391,93671,39663,46142,30982,66041,37281,68157,26553,71872,81142,211527,39747,118119,22695,2859,11066,20232,168911,7933,197005,17066,111071,44434,133994,120798,12766,227798,45756,132852,29917,36076,55352,65281,129800,41958,18944,84678,18580,168093,132621,39997,54092,27740,32354,3770,114118,103242,43918,15899,18574,145944,3190,123469,219903,24169,100571,62403,16776,92779,14535,17168,16475,14304,37231,1712,28218,242754,61688,28980,1318,51359,222657,99200,67989,31772,23932,35351,201251,49041,27306,19128,40135,3986,77333,19649,120683,151927,21081,7076,78375,77501,101599,8011,89585,96715,58179,5378,102138,106793,26051,217276,4197,16297,27014,46721,13322,22806,5278,29629,70632,9647,71519,58818,40603,128530,8903,36770,56900,31483,26935,43845,34265,34920,87658,6114,84767,64250,47318,50720,19264,162514,33357,13117,6705,46696,75032,71054,87004,42035,69138,11903,99854,102328,19611,34525,69312,6431,49842,101600,133178,108751,41829,89939,225664,48916,99556,9195,130387,5960,36857,116724,53518,94002,39077,53996,6945,22261,64291,8314,152785,57588,16522,9091,5048,87671,35441,39509,1945,12423,158923,178413,37549,14095,1475,73188,62878,4819,24012,68534,42606,4010,120809,57497,59564,101758,103718,32701,80116,12345,95834,46918,21468,53213,15665,31200,3867,5140,96013,250744,21016,10069,13968,35449,180829,27683,39704,59956,22893,3115,26293,32785,75934,62445,141162,62720,2018,83638,19949,114012,95006,3330,99829,130935,309272,9565,55874,121727,37017,23586,319858,40970,27602,8625,112329,61060,100088,118525,25922,16232,1907,60671,51583,44553,80993,5262,94679,8676,940,20736,11823,3020,16476,12340,152600,97416,3703,25744,66826,16245,16876,46446,84798,74227,176020,45192,61955,75496,23946,23626,40372,26036,6149,11822,30582,16541,41914,82385,232823,40921,80773,14930,3631,7517,39619,4348,36180,126106,138939,62611,1477,113512,47321,25052,14546,118881,29060,23589,128322,36795,18401,137921,104699,267929,36194,172791,18113,4766,188215,30083,332586,94089,5805,77909,22194,68234,154976,43220,40660,70001,184893,138095,11128,103010,22663,5108,212615,8485,5565,49222,54614,26530,42639,16319,55062,152662,105595,21114,22216,10294,68158,10436,86950,7206,62115,3977,3657,59874,456,118617,18156,106663,112229,80992,17442,8217,55551,5133,34344,251927,51153,39364,201321,7816,66803,23057,156724,145664,14276,95705,979,2796,6875,13429,212525,50602,26276,28284,3424,19465,52397,46963,31420,51399,206476,92317,48851,637,100820,83349,10317,60227,21972,6908,282439,32857,224767,95629,83882,42106,87338,69757,29840,68709,37665,45244,114577,49188,175943,54009,186746,106158,70168,3358,234002,50555,9221,129338,9562,20118,32923,78479,118280,65752,4977,10474,102174,60947,129006,10570,83451,8598,8078,159367,123785,80438,16742,5905,5281,181513,42402,6977,163136,93179,42191,14968,50421,112401,105440,33456,57347,121611,4221,94954,36517,24046,27796,6255,33394,72990,135408,116627,1233,57874,25654,95419,68156,401399,313338,55208,45573,93124,119251,47200,38196,11909,130667,45391,73904,64964,167846,4137,115606,52036,62214,7969,160925,7187,1132,134835,40309,73195,64494,80472,444841,61111,26500,45323,40743,53625,52797,22659,15631,29739,36706,28841,39147,102836,26794,10536,14845,87305,45874,12241,127587,83833,57183,79722,30844,41304,84655,20825,92500,3722,25655,27811,10157,81634,31362,34088,92487,70123,22190,185100,72658,139035,192523,88241,2078,230490,44528,85638,100198,22088,29982,291233,241062,13865,4445,137791,37835,107218,31726,19718,38234,72528,23046,19177,66695,5109,17251,28077,5617,21554,47839,72425,133825,1486,73065,181275,141508,21768,62971,63082,2512,34200,9904,120309,6392,91243,68416,268253,41199,116757,138551,185526,41246,28986,4093,19057,17295,4148,245766,122360,35356,112075,20301,75441,10998,7977,19769,62922,937,63547,100196,26427,157820,20983,236696,22935,8140,90315,156004,47204,140973,7726,45097,52725,22636,23436,257282,105247,522,88389,216031,202204,46812,211666,19693,68828,81691,45925,11256,30292,372,5236,167826,88328,232776,151611,5360,82104,18841,80393,25465,18285,20320,72377,31730,33160,45803,38715,27705,37379,24163,18360,103586,4015,32305,269494,91252,20080,36567,54650,7797,57073,12650,31164,42209,6375,261663,105528,81661,106002,2800,5375,17247,43151,4442,15727,194619,100855,144898,62320,78465,39929,16454,1967,28311,61363,17219,9395,8745,121445,76939,80385,162380,22009,54191,44248,16299,122830,48151,74429,78291,64755,14238,44966,2511,17712,67954,93583,829,105899,49935,84750,11591,33185,85447,42717,27409,208542,28965,62052,52525,5597,25694,65594,16343,63224,276188,12475,9331,127507,38522,57287,24128,133161,79723,105548,133695,48917,27558,43278,46520,13778,141954,110785,83366,17715,46317,105763,66298,147013,41086,94180,16478,220447,44611,730,19722,78975,117889,125643,26254,16574,18480,65006,15806,38549,246418,46052,36056,8440,34984,30170,3163,59800,4458,115442,4283,41970,33507,104078,1653,22,121158,276486,3655,6338,24048,133421,23641,2161,24422,36006,8086,10675,181474,12307,29514,59143,14729,52509,87128,122470,19446,80852,33314,24573,119864,14237,9652,57779,6612,51851,15284,98871,90581,124466,156831,21190,22015,71380,161906,87247,69201,18392,17908,108470,72962,40719,14338,17911,95260,43339,20610,78916,20710,72451,11315,31448,17263,58853,178878,48111,116002,45497,80506,82605,85880,36300,121755,25215,36118,301929,88728,405223,276136,553,34704,212438,49970,78329,922,20711,25036,257130,38295,145369,18128,15385,30829,55656,48345,8012,3561,28004,122041,192900,58338,112508,41085,29976,87040,47117,23905,4336,92061,138880,97407,42083,172121,6256,25192,172671,5,93568,1420,12677,31605,56743,40620,6015,78415,231077,31298,80026,13902,19048,24924,170586,32955,176119,87859,36731,6773,27711,24658,26475,115216,133207,93250,95820,88522,8317,5714,124047,55219,86860,19677,23961,22928,162209,8904,225992,359835,56084,96201,29392,96558,86071,93643,55114,13347,8183,95129,82012,2017,123336,34219,115554,157159,47747,101684,41008,18735,193781,104151,226906,7552,179874,124113,31159,21162,44010,14771,51268,166128,31382,73124,77438,92830,205709,12113,1292,38937,13114,1334,2118,15597,69581,14449,21934,76618,48728,67038,14967,51495,24243,87736,147249,26720,11119,46063,43749,5843,44147,152629,133428,65703,14269,45604,57982,28672,55616,45957,8438,95433,37698,220862,132034,39456,61870,4161,26501,73560,56418,9845,4654,20916,10456,88920,119358,9015,65931,96507,48029,38534,21676,109081,43078,34943,25089,6131,28766,23665,5477,10255,16695,67,45778,42443,42770,29534,23733,100513,62617,42630,48746,14191,43753,50295,26007,8792,57243,43119,54725,164253,58250,112304,131796,25165,4651,3188,24831,47748,3705,19540,13211,102095,5593,18699,23666,32005,117571,33541,60584,74573,86311,99443,25172,27222,168938,7143,11853,53560,18834,19960,86522,28217,53266,117700,72989,34323,18721,66450,34346,74056,47217,202002,46269,9429,68582,75458,37823,82843,96652,32549,145144,27958,19820,158086,31955,201406,135379,31207,192545,12950,51704,9094,248263,76147,64028,110009,79407,89345,99284,223492,47966,26848,15359,201137,2861,110507,71231,72297,31851,118777,71039,151051,240855,16333,50766,14727,7939,4149,80908,418780,88378,59276,1327,7284,38576,79814,65820,42199,84860,49574,62596,12396,70598,40117,8648,7994,16836,7630,14047,359699,106878,525,29037,28064,13380,11675,50669,74216,103539,180314,27449,56299,172344,19274,7301,246099,32043,19422,36506,129317,6806,30140,4614,46639,66926,932,86600,6322,27847,233103,10541,39025,34887,3517,12972,26220,2031,66561,115015,48658,47596,12714,33845,3893,16165,35237,89983,14769,11962,147224,47018,29977,27979,5552,82338,86023,131368,1218,24853,237840,132193,15455,40873,3668,65351,53388,15229,59889,272245,47934,11858,34347,18038,90853,86981,300602,19343,114181,29362,84921,6095,106059,79472,38015,1206,48741,6208,8e4,21916,17423,6002,108083,24479,34931,56661,9511,26995,100694,163853,35997,81254,58321,18919,171890,86877,91341,74503,70477,53412,7027,59281,39892,131302,5864,15947,61301,67466,162369,47956,27874,35624,282324,21270,111847,102548,41482,30955,116737,28264,8592,55458,22301,75090,29821,30697,51709,3041,19208,8038,24634,30467,87509,126428,19389,18814,152686,20701,83474,45832,80891,105808,11378,153223,120770,98186,150633,49838,9141,12755,30962,5260,74490,21256,31678,65062,33326,289838,187831,20595,89768,2805,58535,10844,70085,12090,2451,138068,98544,24461,4511,6754,41684,28203,3383,65355,82833,30161,83924,234361,128424,28921,222594,33975,125491,34069,11508,67464,144226,41850,98703,34371,7901,21254,38398,65651,23549,53883,213340,123269,12028,71764,177701,28758,2623,68395,11549,15232,68603,9660,63116,36079,57093,31198,20475,48467,89984,35619,186847,107469,31389,43631,73867,41949,68841,114250,1605,30564,63403,17588,27680,99533,12641,70325,50428,73426,78379,11855,91651,72081,91720,60198,15743,12065,83398,140046,6761,46598,45900,5068,886,62448,148968,37347,19405,9680,15819,43496,63370,75667,163700,37639,3633,22774,34341,183131,134335,37200,23915,7054,14194,12970,26438,13350,285521,25594,8219,104410,91039,168804,138480,149734,15907,33818,61132,60082,4622,110187,56736,13551,73571,3945,73463,65498,17758,263266,17593,2710,27585,54469,38200,45367,63754,28881,3473,12791,98287,31895,65787,4463,94536,24951,36332,59901,28803,52130,86403,7668,181822,74831,18977,9850,177206,145485,109798,7292,31421,26280,77211,58511,12507,127004,11113,147,8729,56208,43066,79926,129937,31345,83947,39915,46146,98763,42566,1337,13192,18323,105163,80570,117753,16555,72883,11077,159438,40764,70933,83329,26066,12276,72059,21655,173836,126713,69454,153482,91585,70644,102558,110483,6764,127864,190133,3961,101798,20945,71138,82402,90884,69669,44753,923,16939,59700,164258,25969,27082,31399,43846,6306,246093,51342,6153,151581,202801,182731,56475,162188,89426,141356,14355,121815,27536,28023,65257,77523,106668,127314,24947,12790,38796,169698,23555,10725,44573,183083,42088,62716,43265,105958,32050,44067,50118,1668,3874,6243,318411,16599,1691,94999,52378,28671,216728,123258,2059,34969,69225,5913,136280,171443,141515,91662,22175,135282,80020,92270,1663,4808,4482,3495,34691,5226,109830,108512,17342,107488,11606,123190,100247,29666,146527,113014,15794,30894,13224,39585,243192,22351,9903,7836,47699,11078,25468,122291,48821,26780,122679,75521,81450,630,4895,92900,55074,74293,17441,3563,111657,103102,51613,12318,52370,36191,68245,34269,40445,41354,122901,168604,182500,62012,42557,11259,24428,115113,86345,12362,3909,78430,86852,134602,20459,47853,93879,22577,7659,3688,38555,13349,17381,56715,91639,12493,10895,92438,3142,37057,28928,2004,36427,32268,34222,209974,10432,67436,41989,173518,107930,27079,62729,30908,55558,5828,45031,14902,53546,8204,144263,60255,14520,88212,86582,109589,69356,8064,47449,8505,66558,16886,4844,52817,111260,215129,12941,91118,650,20770,6273,73089,40618,62790,2873,35002,14023,97208,19386,102646,36993,143736,135457,35385,113601,17893,32627,84439,100619,56016,6581,57264,172160,45452,111710,203627,70131,24100,322787,1996,35665,70078,22358,90922,83658,4097,63200,58499,14542,99153,52159,6615,12414,63415,31986,16823,1579,65405,137809,8841,16898,48082,259,33014,42375,12260,179850,73667,91389,98882,29532,17311,326251,41092,5928,20742,44964,48019,43505,9317,49265,6643,192712,48424,163487,19861,20113,70848,31928,105333,23685,78563,14638,54755,7158,24142,44018,20774,125255,20331,24280,10163,1285,2336,39851,4299,117269,46714,63816,87779,159624,11731,9971,990,137317,108831,50994,74554,162680,23640,131597,146962,170620,34829,91205,21184,1913,63616,18427,93136,156592,17519,67565,115882,138220,78622,88535,18115,2711,33554,109492,54298,971,24914,25863,36363,45715,27099,194995,14299,178181,111488,72395,322385,157719,130787,11897,81843,83999,11369,49280,118604,40922,61332,110343,53407,75639,40582,300440,54722,25637,13694,48248,48278,194521,56203,52779,48783,72627,10953,376,16733,280238,26351,230789,15132,25168,137270,3588,63704,73376,94031,74284,19443,159557,9697,39901,13351,119050,15406,146455,3460,29556,75195,37673,102524,92329,47289,98413,15311,100684,56345,7116,95480,11590,7200,167,23610,58426,17730,136656,27944,53151,2701,8824,103124,3017,90744,113588,53216,79736,65940,26931,498,29568,80540,143543,21292,1740,59268,16561,180816,42323,50174,40890,52866,10703,57169,4700,17191,4424,93511,49698,166650,26972,48631,165169,82879,69326,202970,4007,2376,231325,139592,22119,62851,37504,68816,58345,67398,186643,43331,277416,53749,15746,23102,17432,4793,151138,48822,54265,48203,198688,14305,54287,2291,18018,113378,123260,7180,97549,87027,120085,2920,76080,8190,102005,5641,64580,14955,59802,54028,58884,19367,81779,412567,85957,97053,103637,78871,29364,27637,141728,4767,30686,112738,130146,42745,12730,105040,14844,232,210944,36581,152317,135543,29744,3129,55647,58149,46319,27265,17499,28005,59948,7170,34138,5702,293047,110892,408,91760,218674,18469,46095,81403,14389,4610,35672,73060,11006,74848,104820,118143,190357,20043,105358,141735,5115,27093,45924,123073,52599,29433,9616,238350,78610,24851,58858,26769,31969,24613,18294,4982,32735,39639,143563,112073,202205,12567,4873,88601,44897,81503,101648,81362,34662,85277,17574,48173,21435,221188,40215,39576,80786,26544,64668,81841,10731,37733,247986,149188,127703,495,18382,54388,72446,43071,30974,198723,89608,41360,190,33045,8386,31658,19992,237838,119015,137622,50890,100913,6460,116233,267230,26621,104129,65114,14190,41542,14888,85962,23342,23041,26453,43725,71809,45186,4770,46452,53894,56616,221286,18973,9038,109299,55365,19366,26863,18808,60909,69353,41738,83463,12100,68561,72860,3980,13796,49340,12332,31311,27418,4255,53430,18976,45523,510,14224,30477,26581,4530,3651,101663,139840,22709,150861,31996,63923,120623,262522,3076,10528,2929,14672,130238,18087,9816,121894,100308,25085,55111,14565,18952,53293,2042,369988,23674,61789,133529,28783,108293,35477,47119,36448,71049,40015,33055,78598,198442,1833,159937,40654,77444,189245,113153,8621,18599,38553,35223,166072,2375,11659,21786,89523,6032,12116,63046,159398,18454,3678,32521,47626,11411,103527,38896,42946,15696,26370,10185,8413,37080,165583,4331,63555,14907,72220,50056,6623,62236,36565,49783,10049,17503,100581,55951,146244,24724,9626,17969,25524,109300,173965,99994,101056,46459,43647,53737,277968,8347,123521,74858,33829,44762,77574,877,81377,222525,123532,30602,43881,53145,2973,16284,81940,61281,127044,63620,9875,14756,114829,19032,9202,52759,119141,23928,120551,19607,3599,33401,76821,73233,117430,39968,36539,7071,5446,121735,194059,15206,45283,6706,15603,65615,1207,165723,92275,34773,104447,8396,32353,205240,164323,13600,60555,79205,25532,22907,33410,57480,107111,69630,32137,47832,70913,33161,20321,2371,117348,10714,86246,1625,11763,17900,268,78457,99175,97940,101092,86660,32221,14041,128504,125080,53744,124263,31017,13897,403,31859,21964,5633,111630,5547,77329,17961,18241,84995,25984,12983,67491,62168,47262,5241,297,51191,7351,8967,147212,82060,16821,782,11033,82431,62957,5026,43459,77963,203477,53528,6247,191852,87774,74164,215654,13467,1522,219964,28589,244104,16242,117821,67725,72570,156792,17186,15979,26990,44128,193014,35276,57125,16212,166451,68017,6905,77608,16364,53777,75921,76426,37975,26203,269296,64099,84122,12077,38533,830,4407,20139,963,43028,38902,42911,37503,83343,85045,16979,1165,60835,137387,58380,86990,110066,134540,56331,193845,81238,17922,163093,38744,110641,12502,56404,34862,26865,125964,12965,111648,25547,7771,27196,136980,9555,29551,107158,57885,18831,37705,35505,101742,13970,102109,62548,124657,23328,11124,89592,146376,248050,6241,22033,18337,80685,29898,11908,216623,67721,106162,146610,21377,15085,91552,42041,62560,122532,125336,102365,121537,142559,29693,223919,11515,110495,18776,22494,5895,185059,103592,229351,51220,100102,37027,257855,29359,54123,36066,106493,12244,79258,32002,432,56205,94836,90182,6726,14762,29391,48938,26864,38083,60364,3310,60192,14766,205567,57504,110760,22649,24666,46333,21517,3430,13135,28873,27052,158809,11597,20529,6695,23138,22960,37137,45574,6545,305877,43423,26153,24769,59844,14501,10430,134352,56169,13213,103432,49523,35181,13435,12408,129475,64620,230854,77390,51990,15653,83248,33466,44571,117828,51481,2187,10559,68019,18021,54895,48247,18354,33737,4554,108595,37288,39767,116707,9175,3726,108877,21616,83684,49862,1938,8543,276466,20134,108498,48770,102254,31914,131520,185291,100559,51890,209,19526,76471,50544,71814,99351,8172,198526,28816,20419,9109,98389,136777,76479,75596,30635,165417,48216,120220,25955,211071,39314,24308,32164,2559,146280,43403,9233,17947,90585,1786,86920,125662,2457,64741,32152,32918,122882,78538,44001,31723,56426,23375,103172,88177,145697,52506,49319,68016,31664,41488,18486,110400,7030,28241,986,109199,19900,42147,56864,65287,49183,7858,24e3,30453,840,16673,25907,68916,89927,6309,158335,36407,199737,130464,13137,59603,201778,195292,21015,42466,179062,172561,89492,11075,180407,31868,72493,20998,60217,9865,19530,39274,130266,54539,21623,12535,13505,40641,73375,4087,85633,2153,3117,70680,55788,92096,47509,98493,37490,271936,151475,3032,16171,96642,34106,78425,125761,19591,3366,19316,54508,24183,50786,194248,91528,33253,34622,108355,41741,705,3814,3883,108929,13203,67831,10142,59754,68208,29128,84820,56880,38794,24972,48571,40821,40476,18137,164254,24064,236309,79181,11282,395,39169,2013,51587,28551,9645,701,109513,115899,113566,12762,62045,58322,103726,41343,40866,244102,143816,2490,70346,40973,52618,15412,30720,104315,38917,42027,93676,17513,107418,20706,123890,13399,97727,24044,87962,65606,44250,98044,65276,74790,101473,19350,91570,1326,87790,172042,7577,100813,86896,85891,41512,108130,27794,14875,71431,12835,156250,58135,3759,22476,42176,115873,34686,56523,73643,108505,51491,20838,12721,32863,45700,29496,13700,34294,55360,29206,155942,123812,7706,163234,203,132720,49358,144431,8130,175788,35818,3270,76832,25710,54095,97274,28779,94621,74396,19092,128242,58067,20885,14670,93255,15107,63291,23654,126900,129421,59294,262659,9798,3251,67344,28600,44629,50672,29072,26999,31526,23183,49175,165843,175455,17282,175411,32022,45989,30298,90690,78118,83156,23749,35636,31317,7069,80381,94561,133756,14960,97404,6138,41065,78041,32843,16601,34123,9559,146529,123377,96395,54441,42012,84257,123541,10745,22139,106459,11720,150883,172651,154996,110538,4728,53447,25704,2009,71152,119354,21166,66604,1429,216162,8637,122250,63520,27180,29172,36124,276428,107787,77184,4680,14952,104903,24418,14793,51561,52931,8371,26342,48526,7118,92066,67280,40653,8847,34597,105438,14198,50163,61188,146286,50315,41205,170829,161496,585,197359,95056,1687,365794,91349,48507,5804,49263,5146,104902,96365,117343,132222,46084,96919,16875,8073,262381,79982,52663,13928,16056,153908,15145,109256,132308,18763,24904,167644,13618,40750,18686,147124,114709,150038,52849,2938,12568,48617,8778,5459,44202,44591,74914,17183,248689,13878,7822,80060,23116,194037,18487,2067,7798,43077,33678,244028,31320,74273,2794,19466,8218,36280,183997,48124,19416,29656,19280,98734,7715,18311,30701,133602,150307,126956,7378,2933,79903,13178,12593,86571,26604,92446,13574,44205,65699,427599,21118,8245,14407,27877,47936,33542,7916,26460,117762,21596,37818,2249,127359,209394,60044,47677,308089,36791,154971,31417,6998,150042,174360,12255,43009,29335,48739,3912,101398,53340,2580,146939,151295,45360,125275,15273,45383,27456,48761,23314,8750,60801,85823,104759,27894,123685,66968,39480,26917,55290,83305,2696,98390,57569,145853,340733,4919,20024,52268,30884,7413,203685,70989,112855,4129,50536,349518,68205,332641,159581,135361,236026,37563,176404,64899,6578,122033,63871,1850,85234,82089,66124,74145,121098,107351,12687,36881,117334,13136,14698,85933,93866,18047,32620,310,15094,46e3,88451,23632,36645,27940,87618,80520,58892,20976,27702,140090,96075,67841,103292,238964,87778,107338,17019,83427,67522,7302,8261,47570,116787,8730,80484,61772,174422,56005,131193,52875,14588,28471,59817,9586,15720,158155,51307,109734,15196,11025,59331,3884,52626,102602,84797,25158,27314,4437,20488,76214,189248,35023,114952,157376,2827,62439,102878,129749,36405,10329,109339,108633,36662,1254,13267,5470,87105,58004,15397,10434,159667,21864,52022,179464,3013,32147,31496,116832,18494,105502,129227,107267,50033,13481,9954,24267,22141,16257,116154,36185,950,115685,11305,176708,2048,178671,112573,287867,162328,497663,95170,50979,193861,50987,30368,136257,31830,46549,15119,169876,23788,17462,249887,57377,1949,35448,14791,43769,210091,3783,34612,282103,88380,245190,5457,20491,98908,11402,86899,117916,16028,162584,60644,320177,156096,31065,55876,22e3,77655,9992,23397,13757,317623,63978,215255,2443,17648,93231,27388,104529,93807,55505,140477,12046,112040,70887,40152,94365,112353,25063,114679,266061,71248,119555,15589,2244,617,14129,211431,70110,100652,7777,4383,85911,89221,21010,120615,58357,86405,37554,41647,18,15143,69662,60491,14714,186134,148344,42347,5410,168175,44535,42449,343894,129417,99682,20659,27272,140483,63455,222159,17536,13722,42637,62324,11976,114691,148109,2283,32057,182393,4295,147364,33705,2075,44303,30274,28331,63740,69740,29148,10346,44862,33716,73937,153333,12930,38784,247159,2515,41053,20256,83368,256189,54639,115240,5096,24661,175419,153552,26516,141,138176,63885,34115,47222,55709,2765,28479,38875,236608,12229,22921,77291,54426,45388,2860,57787,114579,295139,105782,17826,71066,19119,54364,69385,16568,12323,28057,33346,34919,124763,155533,101386,31644,8627,49001,303600,29868,63213,9103,77280,71333,9696,138789,37059,24823,5057,21352,32368,114208,56803,19424,10445,58514,8661,209508,26187,171838,10460,63454,14016,122504,41328,21329,46618,32493,38225,7855,31763,7945,29876,8734,6438,24205,97490,139977,130740,47323,33195,85390,57194,13813,60600,21313,96251,7699,27584,170521,139271,1363,4402,336738,129223,84983,69150,13147,3590,163929,207225,155260,55916,20288,4503,8398,98490,11773,27512,37113,84976,86558,28365,11756,116005,182148,13733,115313,47644,67208,85069,9347,14995,226141,14704,101835,41159,35314,13113,63526,214039,29978,50446,83339,17440,129441,72522,118641,97816,24907,73844,15717,118884,167255,96509,162793,30847,36849,51297,78974,77793,10427,1873,2972,9999,35074,28190,64297,146836,46298,60038,163007,108919,61219,2403,75022,127339,4233,110389,69022,9833,128097,88016,79390,222936,22570,94657,28462,56956,38803,81536,30474,152794,19566,16481,147408,74574,81895,20731,1918,1366,76367,187321,54494,24366,21690,61696,33283,107477,77499,31112,414383,74362,18463,218441,120929,59848,258629,201924,69269,454,19989,13054,59894,3623,58908,20681,35723,78523,102680,38988,184112,108087,50944,132704,52966,21699,18860,96349,201411,82697,85395,95658,5093,6427,177894,44191,32755,26961,155739,6249,31310,81030,26574,84311,120155,86730,113535,7424,48888,13516,45747,98098,20077,183995,81945,43210,26704,40420,75831,45648,11180,6855,57927,65528,124096,34851,2598,156633,107572,127352,38169,123845,60142,62722,105584,232364,23211,68120,1601,22169,89299,747,258039,80572,7258,152249,11862,101204,8834,121434,33761,19175,133142,46343,40178,48723,3589,41977,30210,38868,62257,10087,82658,87827,90646,16415,47552,351723,28298,72225,91146,272760,1701,11295,1652,109651,300747,51863,198800,29446,11794,32345,37538,22356,33102,37590,113544,37970,11478,179743,25454,103417,59905,221970,105196,145604,7817,164809,102360,16974,75840,255333,56902,6659,1954,645,59400,67769,7689,18675,5215,13793,20536,27852,3387,29523,259718,16860,94625,43143,29245,15848,233581,22685,63631,78557,22836,133302,84513,1348,51826,47129,98836,58284,1830,1749,94642,10933,6145,12506,10975,13879,103781,144434,10268,28409,32346,52968,121567,107374,77268,23686,35097,10501,155275,15303,47136,21102,168741,55332,90385,15996,84817,681,137803,25054,142275,6163,38175,8056,124296,240642,65621,4934,178205,16101,62803,60964,18230,100622,76465,44689,14545,9543,47514,16852,93380,28048,12047,107106,37575,101485,77047,57326,34819,96137,76916,6469,46264,115983,75768,87668,69942,13027,165,8373,114231,26434,52844,42799,182044,23580,146254,38081,43236,33883,146220,382894,14606,46035,36481,166621,35417,95382,2957,59384,60428,36358,66343,75378,22267,22950,83528,17577,56474,25285,4619,179691,75355,95836,53295,34588,171410,4487,14679,84208,44015,18562,109133,54101,11531,86052,174479,303157,28095,9953,35642,14564,39802,16145,77606,117406,53038,121117,53624,22062,1212,7632,127157,237292,189087,10478,127345,102515,181997,86752,87623,10966,121602,68783,68681,83042,114380,138349,191305,67176,50085,39016,1427,42384,1412,67118,122616,72389,25260,2237,13576,137346,19938,20304,2191,68759,5373,61364,238507,75814,23931,69565,38993,131741,38364,12528,87762,5679,129853,5310,186831,32653,90338,260176,389531,108118,26843,43985,50175,30563,25106,56965,18130,140428,4542,165503,117991,24219,229605,1819,129663,1240,3797,76093,18398,71339,51919,93043,27175,47060,216257,6483,35051,1217,16512,80798,129064,13225,69339,8548,237079,72298,2575,34280,51379,117910,55671,53345,247552,29486,39328,140821,34681,57045,60177,5004,90269,78522,2479,322607,48474,61296,13057,31558,4678,59271,6699,27044,31988,35944,12503,83480,4389,136508,3781,114121,70279,4488,155829,42214,2898,68191,75695,305850,45041,74344,106509,30087,17429,93292,12477,290,23080,114802,35714,18751,26554,105424,17775,2144,2412,100610,65192,113975,52975,180272,135050,129815,76238,106483,21440,63186,4260,46189,9711,28249,4169,23429,23390,8324,141585,63809,67668,38457,38063,39226,59972,1189,203916,62368,14403,16949,61767,85801,1739,40147,35049,76757,33124,62102,15780,103593,103009,53484,22952,67973,114645,6566,5245,50462,7601,8288,3513,194571,80276,1908,54592,5124,58571,2513,6800,273997,193904,1119,17991,117245,2508,129156,82366,26278,71465,63341,56943,39662,106116,94966,156875,9736,2204,122308,94418,27134,1280,24539,49022,45314,3764,50904,46424,30699,28087,293839,9400,33646,40165,822,147499,50263,116179,29085,11863,31314,5578,17797,5104,12454,1604,15342,219206,10232,67800,94261,25872,13565,90339,78971,75377,26649,41184,47695,11514,35369,20767,14227,41953,309396,148270,147938,33074,14453,27499,109019,39018,25738,240196,158931,52820,8612,95853,21524,137010,84901,70869,70021,116794,48404,38771,6732,1070,70990,187297,49140,5238,576,3564,253975,16027,16483,2811,37775,19034,25259,4053,2e3,70083,95774,19713,33431,92703,91314,42381,288770,48194,95985,3991,77418,13406,241328,245086,56533,35275,62725,9246,51924,70181,95331,16163,31410,79016,39312,120878,119371,275987,80124,27712,9186,220,23598,146167,85209,68238,282190,57048,31273,30555,80913,17594,75779,59160,135002,101219,189377,29225,96735,60126,62522,104e3,27620,86814,17240,147533,11001,5425,43682,410,49460,87270,69480,46315,59448,1816,76201,9431,11788,87960,29063,65539,47347,11678,33846,7008,196704,9895,6753,8633,120892,59970,572824,115934,6646,202559,892,48351,37611,251282,57823,67263,57750,26527,34485,90747,7685,88370,6144,64182,1709,41969,21458,62327,181657,49247,225330,122600,114574,107124,85361,111833,63243,71420,15655,191178,72430,18063,51425,54002,12364,53225,86557,18193,97580,41232,138398,67821,128724,8944,233212,101353,52099,42127,14006,120107,32789,32132,3498,18123,33758,56058,5779,128760,59888,98869,18445,84702,51911,13234,218379,20093,39031,8074,70195,20708,23462,24355,131384,60189,26390,10403,41060,7140,10781,49410,42261,87202,82566,41663,43105,60276,2768,5733,74176,28329,2297,145430,131632,83615,122915,105441,655,224102,5284,136426,67763,16294,188511,32538,61049,27893,3394,13951,159099,28542,17930,145360,9492,190122,32285,78855,26440,13570,58648,73908,4239,124561,2444,74172,53131,11468,10794,73566,11623,35343,64710,30481,4163,10328,38309,29901,10538,154377,76132,92405,24839,11679,3465,13449,11637,7824,2337,57754,1260,14458,41118,19878,38661,13416,159180,37074,163164,54137,28627,52134,184900,8520,40385,29546,30502,22386,66527,107458,6850,24022,47983,30603,35083,8934,304066,39500,9,28261,33026,77251,9374,44833,116312,34990,29236,63563,125639,135405,165398,159055,55690,88141,69643,236964,31983,25572,20436,36746,60896,31850,16179,11828,5888,3043,66368,9750,31167,7915,53111,36430,1333,64344,93659,20061,60596,180191,51630,6792,30244,43509,101058,22409,420,44210,109783,43223,27030,72477,72831,32679,29235,7675,47556,12258,39907,149412,84926,118247,24692,71717,105038,86009,45941,41189,89453,29856,52543,30627,226798,67303,59230,67415,34408,1367,99685,16867,128419,52147,4111,125381,117881,16173,44093,102224,31575,23234,24870,83790,127407,239098,3200,994,1255,100903,242275,117266,55116,38205,16140,29662,11307,40414,208793,123355,56470,4862,75600,30119,58218,70828,24075,26974,7802,192353,4851,5475,78720,66596,3409,28573,64396,30381,30690,59859,88256,5406,99945,103064,34463,37727,24238,86643,60088,4057,23741,5967,162904,38240,28356,93858,25510,122879,6897,3278,7057,11971,4400,35461,211413,21395,59615,39471,87233,55795,128426,3051,22470,41950,14705,3974,180108,80476,78442,204996,91987,15634,67610,139015,142373,35611,51134,10387,4353,153456,57749,181039,14183,68447,151532,21107,36452,20551,3186,46247,46383,129666,88736,140662,146243,2066,8360,7978,64818,106963,17896,47801,10723,114821,223295,74192,3293,3393,16987,74064,11277,91622,4270,29828,27951,387869,103235,1374,61988,120083,477,145892,128378,11779,211263,61354,18221,17869,46530,83061,108538,157981,90608,67199,95080,49064,195814,12302,66307,10348,231346,160732,112859,63633,146558,21271,31037,198802,47622,12862,95710,3910,77850,73961,85585,34752,61e3,4082,24595,103679,71107,8208,79568,150019,16615,24961,139857,32664,197366,4559,54735,32696,4126,162019,75698,13916,70108,159638,19834,9349,24675,175560,49643,18206,52459,27992,10809,88865,401975,133172,29e3,34558,30915,3658,25834,42430,36562,125265,18182,10155,40149,97082,208980,19575,60853,90529,66545,9600,789,46420,2317,88593,55595,98980,115302,5742,169155,1073,177901,3472,11189,63711,78643,65472,50459,127979,93,42202,67053,21720,157650,11145,141378,42033,22824,85705,79114,35584,15974,1510,54172,28562,12451,104226,19190,97151,73024,20948,5151,81741,21499,29006,84183,198074,54003,45120,170125,26240,35177,28389,64863,79974,60778,176915,232183,45342,2038,80253,41564,40703,32689,5430,100689,5366,23007,134279,14266,26712,73993,24934,64242,52113,102887,61801,46415,201049,54251,62133,122757,164883,30815,139966,2319,30842,766,13362,10287,134518,86111,81665,82440,28333,43019,18963,8804,161944,23439,102144,101145,80029,39052,248708,30350,117340,11878,128467,974,138625,63961,5237,74778,61834,67040,43814,13690,65947,33809,232476,115258,181745,28824,94013,9510,10246,93722,81976,7217,114383,3493,16014,69045,72692,12145,80981,9507,6692,1620,60820,330444,35474,33962,4797,7053,295463,46445,27026,12491,77988,49524,35675,90947,29114,166705,101385,133782,32704,6186,84595,176031,185623,45966,151302,63069,1699,107491,947,15458,74452,196212,6046,10498,12163,10239,35191,243951,9277,9090,29539,54460,22820,26514,112549,60372,51753,48756,21812,70861,260326,41,44222,10441,16961,48148,138771,216194,5914,52153,53400,212036,56519,26245,10117,45888,15294,138019,90913,26368,43842,42111,23348,6082,194845,161089,156206,51546,11647,30759,302912,262094,8635,78876,26535,35283,54183,31183,85484,147873,12989,5197,6356,72894,65347,20150,27370,73787,1493,45918,12366,190217,20724,13858,10981,67449,81213,7553,14115,72242,271517,11842,48310,88743,143726,22177,3290,243231,58452,62937,12592,1654,40066,33477,13751,9921,128442,15868,7106,75236,83773,10775,36938,10482,170465,17368,17469,161508,32752,98340,800,19824,264456,3901,87319,2867,26782,9630,113102,185815,24197,44584,86366,40224,3636,140916,31731,267731,9567,53678,72984,29389,27963,17106,50282,284911,60170,8322,12608,23374,89652,5268,39044,229766,8869,151350,31436,177342,12269,183212,120418,116270,2843,78888,69192,7865,184099,1086,129897,18383,70508,20242,18508,229924,124569,35749,50589,55626,9884,83115,40971,30671,18135,14452,38861,17844,201826,5549,26413,17189,13561,38539,10679,143331,3314,36785,171194,49685,187713,67506,4618,104039,17060,195080,50648,33159,19238,67559,134840,28599,157523,17130,38064,117398,94355,31918,13575,34538,40326,13997,3494,348283,62481,26862,3603,104426,244363,153709,112487,304612,199674,41239,35545,54869,293005,28223,26277,26899,4533,18518,15492,38587,80488,70485,160395,263,60162,11382,222152,4696,250751,51921,182609,10707,48463,46243,1227,49111,111564,46502,33342,56846,68541,63559,858,139927,16654,229375,76759,26478,33205,95828,23399,92945,2637,35630,28470,143992,50214,14174,21456,166191,65665,1711,21594,78019,97599,111701,36,147151,110246,189022,43021,30397,40757,131935,42065,73335,48039,26596,28984,15102,2361,7421,202167,69744,43766,52826,3642,83304,33873,75140,63169,192389,36551,92748,13039,123959,233220,21738,84447,77230,20228,187852,19095,25799,92136,108774,29237,53947,2299,118106,2687,8830,42331,202924,33667,2023,73763,30704,19363,19779,16737,35629,48081,24068,101013,162338,291912,13749,24745,328289,167679,70086,48299,23306,16732,17801,43322,54589,3586,63653,43624,53474,925,109177,251316,43805,13082,19511,86565,142182,92461,17117,101033,103319,64589,4022,4351,235897,5352,82705,107142,46391,156084,5860,61365,10558,13045,7717,18357,33922,12590,33065,6928,46993,783,46937,67846,8952,26295,6107,119656,18799,17458,50747,4229,179559,112727,118080,20683,41464,125468,51560,49749,44231,7359,35339,62988,136487,67015,5208,29150,24956,105186,48858,6143,18097,6972,16404,73489,58742,97196,36357,164616,5834,32267,13746,147733,15113,132091,34127,106298,39729,106426,22294,9780,15602,36213,71502,42808,66802,599,60755,5851,39120,67363,108623,126368,72770,91263,32486,30596,151717,7951,52002,43103,11768,68942,40901,39344,24037,127500,116890,48403,16926,86750,17745,48648,159545,34460,58419,5634,114317,67865,31462,23352,24010,98185,125708,69686,68337,13610,26271,70691,2980,4768,27225,102402,75453,28106,8104,6931,1176,6274,6475,112635,22498,6176,238686,26832,28893,90319,14441,15682,15087,39517,45270,109134,104440,45965,47645,81772,7876,52683,87720,12898,4505,185665,2769,113401,15664,57592,105229,137381,97059,119268,6876,43309,33886,128363,35476,144249,67013,143587,83367,25703,91436,59347,53236,2289,16519,19844,46309,58558,99834,23313,218816,231303,36388,51333,183535,109792,139277,54306,90139,18235,8275,32710,37677,82464,86025,92204,88842,117723,37570,128723,234242,76350,73795,34896,148247,58424,11105,11744,45746,63372,17118,49772,199520,81902,38004,22911,33752,3125,1995,53792,4689,26909,108150,146062,69674,41811,161444,84855,8999,28561,16731,93937,3189,21967,24890,22943,1356,145300,51569,28802,517,118679,31703,40607,48098,108854,25003,10233,73969,177495,5248,24516,215347,146192,48712,60626,69188,40735,5866,586,101541,6509,47590,52129,5969,222045,110933,25733,24223,65339,62812,2414,155418,35819,16022,78423,43138,20995,128255,240673,46745,236093,72176,57085,97841,61248,107,36068,193177,105427,55726,215229,20446,47228,100420,87091,14429,121708,23605,21157,187721,21880,2997,203976,99166,95068,25877,7724,98925,83401,4829,13182,18229,13718,239662,38653,116505,153497,30589,89029,38962,181302,43853,78872,180301,4786,248240,7401,106136,112590,77745,19731,60880,77789,125748,135487,5975,48627,34084,12419,215770,47557,254582,10364,106495,21856,67539,88981,38805,21428,48732,42316,12149,16078,52808,25327,51322,33850,51147,12253,122354,46077,56483,254553,115417,81834,150991,94662,86668,7381,12841,100650,18218,15741,22372,68294,50705,15535,84660,61887,22553,72299,31361,24824,17743,46820,64288,31582,77006,111674,116384,30760,80920,86149,77192,51979,79691,60342,122805,103800,240873,160744,233114,78962,54920,8608,3484,316104,72548,24337,5088,230040,21926,10172,36838,26,86221,83458,102176,12062,17571,41929,41170,28428,68239,41750,103930,2634,18313,53019,34825,97837,63115,24606,73157,152474,14715,91439,37033,109806,140259,30668,174760,380,135597,95673,136073,65073,134249,13829,17279,122305,4420,46444,10237,64848,203623,70728,10349,182885,65075,24519,25783,40318,34139,22222,63394,55266,102764,41422,20126,65100,90408,53640,35128,48932,11192,38935,96839,34782,39492,19396,41332,6250,5511,19492,51304,25936,104466,54099,73771,86115,5080,7669,30891,111700,13931,25276,72289,135447,14820,258641,25265,31005,281179,75286,393,95359,14623,13584,6680,101227,80173,44933,76666,54542,13244,39348,458,25379,109451,134348,81143,6959,65554,12027,51311,8716,57589,140731,28467,23316,17272,30458,25980,55229,77197,83798,28302,114784,7428,34548,26241,14712,39336,103304,18928,54080,12870,334,87722,15208,16895,142098,114262,39820,83913,57817,28682,7721,14900,108672,11250,62246,42849,415188,1724,26555,24549,25505,26443,107450,145899,61035,43528,6901,60726,65906,267741,21338,147590,42079,18924,73017,135236,15393,5206,4026,84185,1531,5988,113890,82647,303391,7386,69844,71611,189865,76523,31877,13315,19314,198575,32821,1928,67641,25913,104475,103489,3297,70391,18406,15446,113347,19295,93790,27856,1792,167471,116449,8541,4408,41757,63233,25765,86680,64501,27034,24816,34975,6079,4486,49693,36229,16917,21581,62426,27862,11612,54284,35702,194034,355,24277,48262,87411,70504,310164,118018,12516,47559,43502,57433,107139,9290,66533,80863,14634,34312,91725,28606,21342,67241,72355,43244,375789,37402,174015,105070,8342,44167,67494,1890,16365,11723,271002,1865,47918,8350,45564,27742,25110,125803,8553,49504,81925,62211,4534,15491,19011,80373,206920,667,102405,128623,245524,5553,113309,192739,65766,19567,22832,261958,29679,21293,71134,20962,105123,24721,860,21752,33448,18372,157167,94822,35770,173224,232737,75729,28937,46828,28062,25453,5207,140366,36665,30652,6169,67920,150458,92040,23186,184604,92330,20891,176492,49427,27828,38305,42495,143982,49560,25503,90043,29747,65328,47830,12932,11068,77721,9003,25213,94205,140426,46090,89945,138173,192691,33329,112232,129905,35709,27514,1841,19957,31411,127476,53572,17497,173549,55063,175135,19841,69314,5192,237921,117660,150697,4060,273045,50414,98940,65348,153665,164423,58804,156695,48994,213928,86036,28608,8355,39574,34540,16927,135680,18374,151587,10830,53805,16878,16623,4282,48030,8537,14986,46102,13062,72897,72,33050,108227,39451,45935,651,113320,40535,95176,57450,48843,5003,19019,10407,211163,3848,1068,4988,32091,30095,41692,15099,43602,107434,50744,7627,171349,16313,150832,352665,207750,33937,38256,51091,156e3,87889,90663,84175,24908,114900,50365,31494,83829,5398,169342,47521,54818,18935,8356,43094,41212,174536,10082,92550,6678,60614,23355,69721,14796,34149,128830,58187,3179,208,40325,28399,225029,401412,51150,31580,207268,6657,10993,69818,64282,289845,23308,12961,38447,6681,52944,31855,2572,47646,120728,179148,37240,45196,218274,4816,3695,21961,50084,35209,18073,51452,27004,6100,33941,1377,84831,171214,85,141510,9078,99227,32610,6417,11718,49868,65579,87902,73018,49062,46280,61742,21512,40862,107733,15941,29168,157765,144919,14487,5767,158014,140070,7241,573,71584,16921,223566,40331,179473,35081,47926,140885,41508,52104,59180,42310,32811,29048,123517,102413,80208,10104,14746,12649,153641,126022,37965,113017,4171,83,142592,2809,6362,50416,71323,116894,260776,16204,1524,5760,30351,12658,20703,54403,36083,45408,74772,4946,14485,50759,111222,10890,2195,167147,92962,130534,16283,177256,35016,15472,210156,151187,73922,117691,43250,52051,37392,24811,24358,30830,5775,818,21969,1476,127322,151783,58392,31021,106913,65215,89407,90802,28531,11690,20234,95249,44602,37256,18707,11928,5161,4410,26571,51903,49768,22008,25252,65780,209499,68769,203726,13249,137363,48845,86823,6658,5674,31881,1083,1823,108676,34518,166752,13791,14287,91576,91429,8665,11529,26401,16191,91972,30964,5254,28486,54697,79613,66520,18447,22870,45203,194466,22822,51703,12278,76716,44595,73455,33546,12235,144843,36154,51247,11116,33040,3180,225753,60864,1972,28469,12891,28879,10338,144157,56294,353058,38302,41447,87532,110616,27065,168438,6557,1213,50804,144643,24817,2390,136531,38174,247513,16190,4059,122791,131994,137430,39506,57650,16305,5188,54309,106128,20628,88071,67394,395446,250285,66176,91254,1399,114196,43915,60230,44853,27206,106353,43013,18733,345105,226453,51202,16607,57106,117175,35492,10476,89598,127439,15187,39624,13688,61570,10615,31111,59370,6238,175252,32143,224492,41388,95408,34384,148238,78307,38959,9340,160091,61443,15737,11216,41244,170,38299,102443,113097,26382,14027,33707,3957,76300,66160,19431,18900,6952,1717,108656,82206,188021,257335,27295,43999,41210,31777,46956,57457,12657,11489,15697,48060,204748,53583,82422,284790,30503,137341,8120,19615,220311,15991,10217,63424,9808,67431,70976,98221,4491,15177,28535,144789,751,13230,2394,1504,33977,132104,30316,22230,931,97193,185240,24826,22687,174322,15307,22988,1390,188745,180325,29580,59068,74903,18994,29195,79,15436,7622,38462,11566,138710,44828,45774,37768,99236,68137,84083,19282,22698,17134,74807,126662,173497,46248,16938,119735,3212,28292,213652,49013,9975,32180,45660,86250,4801,68788,95490,77482,113751,11994,44624,94452,46839,128497,100316,5798,58588,73184,202987,65417,37790,88524,1606,43156,97964,105717,34947,11203,100060,37742,130074,93653,107799,94311,196106,41347,8035,10780,16390,27883,118236,167395,1979,25006,19375,31628,18916,144723,78502,114047,103107,86492,107686,5844,20934,206963,23556,22591,16562,146333,20167,10471,117434,33085,2863,9740,36669,41849,37271,22790,18209,28979,8231,12952,54408,21731,25130,45208,55748,138120,75826,414,29593,9925,292865,25999,683,123149,7036,92159,86055,61827,103680,23176,54918,58466,57578,13305,5709,86479,16697,31064,17660,200919,10770,49793,33423,32370,52047,16488,62555,6459,8426,83493,7763,59725,82812,18628,67760,79405,68557,9612,7673,28102,56517,69620,171797,32458,29541,15870,81109,32080,207644,71495,21202,11039,91036,61230,2810,130800,32260,4613,60590,37112,75214,33979,126402,155062,30642,63875,12810,194463,82799,47664,16725,36685,43367,61099,449,172150,102867,21691,301838,36745,7130,18671,57316,34852,38034,54182,35578,65900,99486,19771,3456,2658,16914,99866,28390,28109,8262,21147,34353,20006,4228,137085,1675,203023,283196,198286,214375,163329,290603,152574,40471,83506,30068,14730,23177,131539,34759,27668,32178,71896,104799,116305,85430,119262,42860,25160,8911,23428,49437,105322,6519,16203,6349,74711,1230,38045,8540,75165,44736,25909,51026,317034,4984,32281,91312,27060,44431,17817,45363,155937,239085,35697,59784,91993,29531,126740,213757,76560,167776,285273,24262,8237,65030,41160,74437,48804,118916,13159,37842,1031,75349,1478,11655,108777,23435,277425,101734,67469,70231,124711,43532,28514,65526,54956,1e3,21882,17728,25302,40952,52214,149632,1999,2111,3259,63362,89961,220561,39777,26335,9063,10572,12416,34551,34623,38604,24723,5947,15588,69927,66252,119177,69173,46629,28714,70715,212408,20521,406913,74380,11716,50659,50862,37009,88460,130101,7210,53853,538,65120,151950,55806,163748,52837,13153,21100,16674,64536,6091,138201,44837,58547,3723,163,2177,32288,85454,34033,8497,14282,25742,10535,10741,79559,117493,243787,49337,100718,79495,40139,42956,7551,55433,15421,31509,23034,45081,547,61176,53434,328001,8470,36263,30145,4519,74173,53935,11845,73774,60211,78025,3,4102,73782,109293,315332,48412,26683,13714,6865,20128,18490,104141,325,39470,171970,115860,15707,7268,73301,74336,31370,2368,111827,107757,136231,142844,97138,96638,84053,38691,23801,1588,10573,122098,77039,240,186135,146101,11996,18143,112963,46171,155836,348769,47795,121213,116266,132515,3344,144804,31286,99187,255838,129694,35894,48779,55235,148582,71967,65282,15174,13920,47080,6147,108242,157593,125025,7136,1286,28957,127956,28402,98813,20805,7532,109417,40610,5041,32958,15142,18408,108596,33543,50517,27748,80114,233434,91447,487,37094,100048,30541,43477,10639,89862,155868,37667,8726,60684,237903,73408,99589,12190,38739,97348,3914,13594,2680,149016,13907,30171,28343,23530,115225,61104,35821,147679,14337,4297,244282,24085,326976,56428,7851,21303,131620,71446,83253,68692,111870,5224,15813,38197,49026,45057,13660,3306,76345,40671,27905,91072,996,68527,62085,91351,122634,55109,168209,2024,27560,112707,17352,8306,167115,169921,166958,5031,46020,11844,67284,19130,76185,6920,32849,5450,14610,22451,21002,17392,31872,66682,84796,13709,40210,59898,12029,8719,53564,21462,91884,21647,88379,194428,12754,37797,132826,160016,22567,54383,53186,77611,31107,8339,4694,19185,90355,23597,17222,140675,28442,23668,55977,9128,61555,28774,155229,17658,9390,24379,69357,15752,127381,239631,62460,93181,55913,45133,140155,18676,25249,33164,29581,82837,67223,22362,29975,7317,52813,1943,29613,20012,207130,49617,49651,5636,15334,36313,29226,28084,95247,72072,19e3,224932,15811,114,32127,38097,37508,88507,37225,27359,91626,12193,69279,20608,11055,88156,92808,2152,57259,55275,72789,24475,104414,1708,9882,3818,48661,66897,1631,34806,227930,85815,87753,18321,250664,72733,25107,206797,50891,8082,196411,92596,96764,152823,65514,22819,387277,62176,51225,40329,15563,189,3659,73670,64357,51793,275136,33482,86653,74615,67058,11318,125720,15388,22388,8267,1730,102663,170910,40784,7144,85373,13040,7088,94309,583,44224,140424,77439,18496,164026,36578,4722,9151,5824,63365,26510,35199,40500,79277,32495,44614,35233,9566,203293,152144,7097,2330,183480,98629,13423,330887,44130,68600,30939,97829,31012,345465,56747,94879,4939,160027,149761,99423,46099,32251,15332,8761,96094,128555,5763,235318,222223,55729,30241,55420,201746,3987,81382,8259,49325,23287,7719,24633,251100,92311,18591,110533,64759,170260,393860,7175,21144,132887,3593,75346,101277,91109,16387,259187,11627,57459,173829,44694,55780,49797,89192,120443,62622,3904,14814,23887,1027,112258,64955,99800,11132,66353,36202,48624,18158,88481,96882,43059,11040,2455,7077,21651,181159,99126,100434,61388,68186,19161,110468,120052,8819,55324,41494,7014,37689,3618,87729,92615,207943,9823,128657,12587,15857,6379,67628,51216,71775,157617,63244,1503,3864,218754,110864,5769,21492,7243,1192,87921,85529,31512,18537,42698,35350,73510,84474,34301,8991,21013,35034,566,38832,19838,35586,37216,39413,55006,12178,59742,856,84563,6900,25632,17437,49786,30723,13847,70845,4044,7843,23944,235976,55530,48942,6518,20939,73769,192653,52936,95207,23895,132542,142982,22632,87452,48042,54018,178468,10728,26230,23559,363,81269,142012,5718,346258,31456,84333,246476,51018,66692,101804,120570,39962,30373,70593,2864,60541,19425,54209,104092,7201,31545,48018,25865,15442,46257,40443,8328,6451,111782,47527,97754,33046,470,245116,31095,39,91934,87208,73470,36708,36521,12801,70624,36272,8892,79768,12427,55454,103756,5908,52390,62962,22720,141138,94634,41689,128402,126390,6628,106394,35527,134394,82727,254651,194502,148064,89549,3202,28359,957,21954,27906,49840,142747,8307,24206,48978,1186,71728,133038,71474,91306,6333,110959,74600,70387,18983,62609,56057,22970,1147,135850,1321,28834,3578,59715,102227,32827,81415,99952,55636,257598,390,22702,35701,85872,402916,39216,189795,14929,19467,10112,144422,61514,5279,63421,134686,41436,8424,51925,10598,132295,124416,4604,194739,210929,57866,31829,51626,50007,9976,91878,61906,56168,81906,60918,61859,40017,23059,16887,40927,62064,12785,32893,32913,21782,93965,20169,44387,79084,38463,11457,93950,27127,157050,2697,337088,5116,54128,48255,33279,8821,27352,25515,124022,65710,28906,38557,33390,1722,104435,72215,38551,12094,30978,25113,6671,37355,175109,42862,98024,65406,221276,59624,118012,64637,78760,86697,21426,1639,40350,12584,67193,84144,31396,7863,143011,69629,63112,9454,28666,65798,46372,134721,6314,51402,30837,151922,2847,38676,38008,92823,136245,17540,5504,109295,205242,37606,5211,214892,1586,20670,208711,137743,19328,40652,16995,20023,14657,154919,34422,12996,13918,38221,47690,16398,2959,37680,89122,6721,198469,91876,172043,83898,101992,26084,94570,3635,76958,22853,76497,38266,176590,168403,44464,142840,79180,184594,1984,41806,83147,11985,6546,366068,59732,24533,271505,8736,39084,222992,93429,28962,58985,86665,8432,30028,14548,32439,54424,165029,55175,27458,69046,121277,46168,33732,20661,24581,135574,123110,37556,79260,72611,16957,12939,46162,58238,44907,72936,253758,41324,32518,96480,11949,124438,65280,43256,34107,53533,43531,37037,28366,45970,32741,173438,6121,194202,62969,26355,30314,58370,28455,1848,50519,82830,90393,21761,295490,10936,256940,133568,44050,20269,4089,27457,21610,219460,36743,14821,101388,52005,13124,30979,140816,167362,26054,18458,60789,34917,40447,26606,33422,9066,3452,83614,5761,20263,137238,25038,91310,101,52322,74548,42572,38084,214054,186568,31802,17665,30620,141936,37730,14420,4265,187218,49640,188208,51441,55388,96452,66659,40869,42039,60967,221027,19234,178581,29105,96050,9165,196118,157335,3738,40354,117436,2965,34136,59659,15570,50843,230035,31444,71260,43886,18316,5387,38500,168508,17406,32174,8828,103373,143806,90367,3560,18719,122310,16508,26719,2541,105429,6645,37998,73190,10591,235916,49737,87112,233941,53188,32193,79154,4544,52905,126477,7580,63501,57314,3216,31337,6541,103083,60846,49,9756,15481,1355,43840,14319,13743,27486,10222,73114,230718,418644,16706,6674,279748,23058,45273,295831,86306,2743,5535,88773,21829,35253,120938,31153,3169,16839,42847,8751,80974,33942,36867,35514,16485,26474,77775,56877,5391,48346,3882,108713,31403,27804,55248,26235,43821,136104,40118,175507,28034,203908,18732,1788,34030,106427,36958,54359,7251,44936,15356,69139,455,157915,22173,140291,50348,43275,82066,49621,54952,15216,36226,96695,66855,6936,1987,8227,196087,4631,68827,99004,47541,110265,17953,147605,110242,58520,31312,38724,329975,642,3155,34497,75937,6207,73843,6120,17249,51429,117746,3218,910,68961,319671,14938,29555,34700,1649,66673,72268,9655,76800,153087,6941,210168,27130,35398,1780,73242,3135,56689,19556,165307,8765,35967,121458,13333,70453,17350,117253,22265,13340,44265,39869,441,3742,135025,23581,33309,16543,17731,13291,157637,283005,21408,101360,63887,52312,83873,5338,233779,23759,186949,34531,177320,38069,156465,91004,19353,59852,68160,14891,1338,1072,29823,1950,28901,81407,313445,73038,84807,162348,240257,37162,138934,16111,58013,41253,102951,16457,96056,19541,56402,67217,41638,94381,89674,29481,37456,80815,151579,13937,13683,132537,19699,134545,67020,29816,222341,141235,427578,48868,129557,233342,23077,87871,16213,18728,16184,9469,37913,19680,2798,171356,178328,13216,50049,72690,71904,124644,55455,7504,29052,41036,266546,19899,30391,188755,8659,59469,16,104298,112943,53865,76203,138226,68857,139953,14125,107625,119795,173133,4398,50273,48808,54390,16466,122086,31835,67035,50971,48859,7508,46427,66477,73021,84615,39985,83076,46779,201569,53336,36443,60865,168164,143810,51393,25548,169307,32896,24485,38424,21837,29087,275813,51674,6714,64883,46169,187369,55186,76192,12852,12018,62134,31067,118303,16542,12125,10579,4928,26291,43854,7091,10946,253716,109062,39283,17261,113012,258512,47764,125126,32646,55892,80279,201623,149872,3192,385,1208,48750,5376,58738,22335,5427,82416,47811,32435,143086,38930,94128,59975,156037,37977,38224,62485,7698,50405,71027,16462,21559,136153,34131,107506,162069,63703,3101,215029,40407,4178,3774,9187,80019,17880,97926,67579,2600,18405,8351,47924,86638,70820,92206,86453,29610,42241,119200,3198,15466,67813,57863,35454,4779,99518,4649,104641,144269,33730,38073,65864,6838,109456,193298,154007,5623,45741,30846,182578,25573,157224,1543,58575,138703,146140,44971,49356,18275,59064,20300,13122,11848,24453,11973,9797,86843,2919,25530,49210,1130,161220,76788,75373,85604,34926,36014,17777,17255,51533,11676,92226,51845,119859,21525,5936,18507,28050,1140,31418,14857,34207,47859,10750,36382,32079,106909,59426,87757,38393,110042,15965,97104,33757,35344,97993,53979,33651,45407,41884,82515,173089,7177,58371,35365,47543,51927,35587,10670,23544,29306,84233,39976,76076,62097,9007,8668,28119,78281,120790,19835,143020,54968,18670,64959,20649,34469,42570,33001,136570,87796,120044,1106,58700,63951,127623,12805,83057,40212,31773,49850,7361,54336,347524,101314,23751,19569,48791,29174,49369,20467,7465,75842,38281,623,112457,60210,28849,51003,94720,6426,90047,85560,43761,3579,85105,34607,90410,118528,7224,42907,111163,18168,6960,161135,191298,5247,100584,127552,171568,20121,91173,12636,54615,20199,63730,98105,2396,40387,14438,125012,4765,33235,12865,45299,37728,82098,77872,114037,59253,19675,24838,398016,102561,11446,17069,57508,178277,65836,99941,26114,2585,271882,136866,50126,11027,155648,118367,14585,8910,123015,335383,40434,41016,53021,14439,87098,176860,201543,121888,2358,9286,5739,22666,54270,37884,169381,33984,93859,16124,89364,72207,51639,76366,99029,65812,2198,12147,174891,194289,6986,30252,88822,21284,11445,288337,160821,33034,100869,43852,25761,52882,1144,103809,1924,84458,86079,43411,13542,139276,18141,34978,41298,7276,26481,173800,33210,17951,142652,33616,33677,2210,19941,98568,2486,192414,80136,12058,235883,50963,249638,29572,27221,47034,6124,72107,63346,97620,158513,299699,40388,23235,37176,224244,198386,121323,67992,23827,63170,17838,106622,158590,26807,5345,23489,91891,55474,74834,37981,13058,5977,72552,34706,26828,145172,19904,21367,34043,960,77092,91381,4733,47446,7680,41697,5170,16960,14741,46101,13656,473,51842,37433,11103,11551,121951,13191,97536,165932,50397,51628,129028,9069,44885,6590,59195,47045,32940,225472,90345,21833,13303,29407,96615,141951,5198,6028,18395,7181,3861,14966,156358,167182,36529,55253,25942,173153,30959,27261,50691,150176,162201,38467,48462,80602,42163,118482,168,108756,26011,17166,54149,456538,22512,91374,13816,90358,131615,18132,226707,1824,28139,26860,42253,93877,77351,65575,8980,80574,22020,27948,40422,91324,76376,13528,39281,91685,82215,122541,144066,1983,193851,17283,26320,2739,194978,4790,26845,42627,61300,65815,174612,55133,4200,191130,79771,158321,52280,166796,221620,62461,11278,4067,88152,83409,31717,121367,13522,47325,37945,10406,174348,249321,154101,64912,29938,51775,17220,15776,166138,78890,84425,54121,42861,16368,24572,291647,10197,32073,22651,11677,97509,26952,35787,18424,41910,71614,94977,72318,41594,70024,275419,37702,60199,7335,39107,61315,18271,18394,33768,87884,104277,123724,7277,56288,71981,189803,49320,3352,6798,14240,8954,69220,94433,57372,28620,68863,193727,85575,42309,41667,67689,42081,22543,44824,12719,28540,114236,101553,27638,27296,4300,5353,4663,19379,94098,3758,95888,95144,80344,87320,28447,259518,12718,71391,152731,37063,24132,31911,104896,15672,103782,1521,4945,72541,23717,122632,15619,87175,206120,29428,189780,61416,28350,44457,972,1175,47233,198738,95789,41907,21953,97034,59341,22864,53713,16873,32971,20693,20954,31336,21477,16169,38370,16412,9019,3841,24599,21938,17085,6484,81198,76413,5849,72514,12320,65247,276175,37234,59796,52642,16312,57349,198507,94148,46134,18958,125552,1747,18725,151873,14901,5490,68287,29470,3689,64794,40814,26018,25692,54450,2703,88278,124886,173087,174e3,24159,179477,24276,46004,201876,209202,445,52876,31948,30206,157610,39180,18439,44124,50469,5774,96278,222758,200216,50290,45486,20435,46986,46276,140133,142326,15569,13363,47522,92583,2182,7135,16853,22998,30272,4952,63263,35623,39096,53789,44864,20053,110392,124213,4630,16087,28221,127787,25839,77481,44693,13464,113146,6983,27069,55717,50102,4760,7107,26186,66507,59145,36032,104182,71328,29425,64317,50781,47465,94298,69706,74899,22754,120756,25108,93077,56834,73286,39928,16218,41699,176763,7555,70819,50083,26895,23315,26014,16773,123079,41712,5719,31516,90427,158540,85051,183128,40864,27505,55392,9058,45224,96857,30901,136622,96557,56304,120061,11501,151448,5773,89743,7769,86069,2935,18471,41628,10114,33660,110170,49479,26745,92846,33221,26731,18795,87076,8550,2100,29972,120289,3077,72490,33784,2630,208722,50861,63483,79029,6419,39467,14302,45286,64207,9686,67513,44170,1050,77246,59266,17055,53801,7150,11111,42432,4278,94579,362117,36175,42902,41933,39002,98489,22913,74161,84773,57036,17556,162288,74485,178760,93867,73635,128860,50362,261,67455,80001,46080,35662,4368,25247,19230,74393,22588,1822,27682,235324,13798,85998,13194,235067,23514,71669,147632,23191,134748,214683,105101,1518,25489,247114,7380,54842,26922,3971,26361,20844,68642,170517,77339,123255,8963,77818,150998,48466,36806,2732,23261,11741,236162,18243,126216,28690,50546,16385,92760,197383,246558,201295,88255,67588,71687,176076,172653,169058,33906,63747,24835,157621,43338,30050,46152,132741,2770,51371,94835,6614,15112,11749,56936,1250,19027,399017,58036,100215,23388,55815,308768,124152,94803,9521,64186,8971,28,30427,62163,7616,103838,35079,29203,131235,7743,17389,10882,37420,61460,228512,85363,41581,131077,62822,119647,10130,54445,26925,19968,29016,24446,74028,24176,61448,67185,9254,8563,119129,9771,99184,37716,39514,10532,221512,258753,218630,55980,23394,32141,61924,66749,32411,3741,36475,26678,77010,44946,91203,128749,116953,20476,49625,53116,13735,102335,29376,51946,83407,67892,59212,34685,21083,1546,112982,32972,74397,1078,190545,16082,86140,58591,89611,101531,10061,105104,76319,20035,17551,52611,169061,190842,100780,23907,90413,115619,9675,34710,193435,49443,129734,11183,258877,16318,136182,126808,44635,27304,192375,2599,125648,47051,12091,23814,721,58800,40137,66726,97930,60877,74487,7942,54326,9841,41428,13762,8211,85383,6950,99177,79806,201786,296464,124087,13144,29741,41721,47634,55088,254286,106408,17041,99064,12942,64086,45233,14005,2612,55827,255,7984,13980,38574,12776,46654,73499,249951,2101,26676,25996,132326,116415,119062,50449,31033,23038,11589,179252,20007,14860,129270,21143,17796,144715,60106,70758,69842,34674,282133,44014,16774,57268,38528,24053,46373,201667,28327,471023,51889,102667,21193,114909,84132,69317,96723,67969,16134,68145,15058,28765,32035,2524,101089,98664,25045,76571,14957,86040,118506,262428,154764,81573,39681,283900,73287,127825,544,80448,52347,38512,175971,15180,45467,33086,46552,48894,81107,43213,36672,54025,76703,8053,7608,13299,56619,20752,238099,54164,105133,1444,32942,953,37564,8e3,66316,119463,106817,404,13667,149108,128597,31267,10269,49836,106150,1484,52330,76965,160486,171648,38456,31263,22424,37738,66245,67467,143369,60471,75610,20895,115528,86070,60854,40796,49347,18989,15030,11371,37578,15779,79867,10187,86462,46402,155626,93200,40229,7090,57547,108053,99598,11088,47505,41218,206017,2173,20988,30219,22919,80563,57566,42369,93141,41675,2407,182519,120495,27154,16702,29456,14349,7958,16688,117177,140375,42467,261919,74916,153569,10836,34742,49526,7621,105997,12212,2270,392377,7755,17959,25086,232152,138791,33847,13860,35316,5811,1344,71259,50452,207539,92635,50359,5821,33674,30255,2086,2587,96264,17543,42,6029,9580,43007,139248,82831,12917,29607,25786,51467,42137,85161,100698,31561,88989,121990,278500,3602,109344,37982,15279,116442,28936,30880,87894,58079,128661,126731,67392,28051,146885,4861,16216,97344,42827,147561,153948,22684,21335,47685,1853,43349,15185,59642,10229,25520,187921,108972,5579,98037,24945,6697,19193,63734,137934,75056,89740,19767,224268,56138,63643,151661,39313,70618,84031,89723,84074,13703,85626,35460,8867,64845,3439,57906,99776,63968,49270,81130,34356,16210,23547,36446,34090,140028,72439,2221,22163,57058,363492,113754,18913,95451,48663,54464,54037,176097,68425,3023,34906,29482,117389,341780,80431,58330,16753,92616,60907,94846,147486,4498,48646,7773,46801,7778,18946,464978,47558,33223,177444,7328,15626,63337,94700,11743,9351,255024,39098,16447,42647,96230,39769,58840,10068,63439,35800,65843,58823,413844,9156,51258,7434,61791,85018,6872,3692,28096,7121,33024,6009,75532,31997,192535,9661,3304,9547,14753,31987,25314,55689,15896,20430,39472,31340,99744,25398,115569,54883,28719,205423,23071,57855,64638,149867,25671,82403,37616,20668,39989,77996,74948,140555,175248,64810,36515,46595,4958,248773,24045,28728,136673,168704,20804,114833,100325,27135,21205,96151,153134,45992,7093,13992,76047,1980,19432,145001,75159,87462,17710,1013,45556,34297,144882,20648,26061,11319,129567,108555,18872,464580,33386,22717,65948,167189,5603,135042,79542,8801,202632,18114,91882,5973,5239,67315,4431,60916,47819,71693,32597,32606,18183,45072,80329,76385,24749,51305,40314,156514,14693,130345,13168,66214,18029,12858,34801,27628,14544,10823,40522,40185,33739,148694,23548,9923,61012,28859,17933,19442,34364,99849,164107,141167,30629,21054,6744,36491,8096,42474,41706,155060,30650,10600,163442,1143,96655,61390,52359,7559,51568,64256,203854,4467,22453,14504,436398,7878,6980,8293,63610,293747,16167,35763,19627,147603,15419,18032,110744,51346,33681,54571,40472,48615,39073,21604,13754,173027,92560,11083,47299,63062,11813,52007,29883,9734,139722,15953,1550,20651,13616,49306,16113,90089,92326,7584,30712,72424,164858,6831,152871,55746,197721,34167,196442,6022,112107,55215,7538,123381,4920,43539,77165,8939,50392,34192,20225,79762,22505,58667,40770,29788,97180,82835,4568,8579,13273,363569,35898,49983,436,36598,3237,131691,62418,35591,8101,4073,379438,65218,76072,33887,2968,27573,212619,288680,68278,72851,150504,217896,6913,121339,22017,35340,51072,43616,75043,31437,10833,81487,4364,22968,41454,106687,85446,19863,109625,149241,524,141850,214404,54376,657,237023,9401,108137,53800,32474,49712,53334,126876,27337,45552,177696,8269,15036,12097,42240,2328,125374,119295,99715,2500,19624,39441,27220,102691,60957,94543,39101,18566,67362,13975,78230,25017,34017,239007,90027,39351,41681,35354,43822,1043,916,58587,141983,94818,38799,75459,41114,67432,16195,36606,59568,22272,126769,31424,68659,12287,134302,257977,5756,207285,95637,47248,117689,19583,77451,22373,12200,54993,117118,34244,29386,34562,53819,71267,64172,77665,49368,7716,59301,25749,45426,194789,17297,2650,1766,32501,45198,20403,20984,6600,14171,94604,19037,5402,29896,9938,59935,109708,88081,145182,44844,39167,352626,164173,35374,45982,6122,154,73419,220487,53834,53601,17992,8609,229321,5610,68098,66815,71012,95069,140968,27396,8957,134489,24656,86659,56598,134852,17316,123838,255436,6613,41610,138033,81452,32023,32396,123687,63398,8693,29712,30407,19296,121188,3551,36099,20032,111948,56624,16547,27453,35916,15378,52039,56849,13489,22214,73177,53097,277349,2157,14029,187886,10260,141743,246460,91880,50869,3788,49486,133566,54950,33120,129337,53768,18333,9525,26902,312251,10297,9020,70759,16647,112432,59260,84609,9818,82766,73569,468,46001,75780,55028,52106,11498,43645,108069,17150,17753,29417,16705,31799,9606,289,122254,115975,8620,6133,255357,56908,14456,133464,43554,79224,11247,29630,160,12756,25464,65960,350428,62521,321796,100359,67358,35169,46172,113128,48988,88868,31094,33266,6847,60887,98188,49659,69117,92977,220228,13947,80181,35103,62170,97351,13475,2440,199768,19498,36597,46971,25234,67806,62881,84717,73648,181966,10488,94149,21550,26655,63436,48375,14405,165650,9621,24439,28043,42735,4490,29963,56674,45373,1934,262446,50855,67098,26898,5261,52696,40644,33900,9440,180286,87162,22940,19704,26936,69769,10254,101759,27406,12243,48e3,73926,113215,54935,5726,192787,4312,106216,9366,11550,52949,23457,212271,277152,133895,108374,6191,96477,29980,218916,58024,54696,40853,91124,65894,91170,65908,252552,6793,29212,15389,44516,122515,52617,35058,9017,103536,39510,49136,19242,130652,662077,74699,47024,31422,8517,73351,24399,13867,128360,4810,4434,61779,111983,61036,17798,110240,59722,102960,39688,10001,23803,23039,176498,56659,44814,134295,17188,77577,74466,226175,102472,154333,63900,111747,18062,41171,79669,32773,408933,42562,28931,30907,107388,43487,2946,240310,23938,24354,319,184983,7927,6488,1422,10790,68809,68209,64775,4361,202,17123,59634,51200,44391,18188,17843,2619,74278,3230,9540,47187,21702,36274,56894,43907,16310,34790,16866,6150,5561,13587,107545,108873,126867,86986,28640,33427,19017,5762,80637,17430,46903,2047,131055,25958,13558,5444,47152,13900,44563,122857,45348,70863,39593,54332,38068,33637,318,40310,143467,18502,24520,11377,62013,28942,27246,28269,83545,17999,59015,90707,30065,15161,34720,1263,37008,2012,6060,98575,92933,5721,299,199555,24578,29223,2985,743,115825,109523,136657,47454,26378,53586,3733,174945,93340,244456,5693,37386,28782,89767,27545,23573,18798,136425,34320,84778,20041,48453,38215,7477,71958,40621,8773,5874,187927,105965,51100,43533,18083,8443,10180,43597,2003,183999,69689,12216,129696,146188,62389,34044,68410,12765,43273,26949,266807,3345,34477,79197,5688,47539,213110,21634,22257,50092,32222,42346,39530,63668,98,134978,74022,5152,59088,174145,37220,9934,9545,118937,5724,87240,19875,15784,40143,23263,87513,181654,285152,37881,263241,4966,43934,10433,186657,6470,74416,225854,25908,142677,246262,32280,6192,75890,45546,143264,135305,29742,47013,77787,11732,126658,8763,37950,21806,57557,113464,89465,108995,164574,23894,22996,23169,15369,23117,17642,130607,40503,36239,280990,44666,9981,40427,147487,26869,168452,32886,32991,46798,240839,15111,70502,65697,88548,44145,28701,48767,31139,206777,35659,181164,166262,14554,171445,31786,66523,76607,17956,6507,31279,90476,116611,167918,6560,1243,115324,80128,41867,55897,187323,37069,32596,189444,145931,13390,105530,65709,26805,6999,55714,41300,22915,68951,22138,21120,22264,10058,19945,33635,56123,99085,10032,5818,6016,46649,57476,35264,94413,112522,262288,93686,83038,14341,23204,28807,66084,77987,6101,126673,7133,38126,5923,122091,170240,97772,46874,215746,43948,41622,3272,55596,8332,146411,251315,13533,8561,81521,115449,48616,175175,2063,186556,3036,134537,75772,29728,82360,22973,186559,86348,89100,38388,82297,45610,2613,87082,9986,177812,57884,23591,47485,42543,33582,44713,74439,257444,252451,31825,35631,38540,33066,5147,13973,4343,51830,70378,22827,26448,95560,36896,241741,48067,203953,298860,61620,20450,3220,67272,6586,107662,100160,108684,6929,57226,4762,7457,1320,40404,77204,99309,62750,208653,59977,44e3,74315,34332,5819,172217,64904,114077,18147,84012,1791,98456,90930,21446,116669,103938,7422,85140,59713,5768,326211,16239,75411,13229,29398,10758,236107,1539,112472,95979,152154,151294,306,21196,38146,10700,6891,84282,109646,56492,40539,6589,119491,51354,30685,140209,136906,29622,73617,49553,70525,51671,166869,139616,74395,37439,49595,45678,11959,33211,86560,52434,9282,62690,112155,130810,5243,108261,99970,265613,72551,80049,6391,33365,90721,66737,69872,87011,1860,9032,112544,60905,37371,89015,140351,19076,850,373531,2802,36725,218795,72062,28990,16550,24614,7815,6187,26336,33373,32162,42791,73555,32062,23386,10244,56392,49442,27076,136262,12412,14883,1134,33675,97153,199281,15608,100152,74072,47942,254301,36451,16026,10687,65067,56708,254030,30290,50490,13864,57941,259331,35588,23485,43486,24869,21620,92971,22072,88645,1048,182050,13343,32452,14825,19509,3325,216938,45740,99716,189082,53740,78245,25609,24311,176777,47340,308354,40669,66085,14102,125339,9225,128709,97207,1271,200933,78439,113451,88975,18324,46521,11819,18570,141756,72512,170020,52754,63550,118515,103073,93330,32736,50499,14722,31600,68452,398867,29316,172786,18417,104924,2606,5670,84818,16288,67106,59580,82929,607401,291,85829,359,15897,35830,50696,65630,52672,22115,356968,29895,40837,231192,34024,38957,26722,406,23335,124952,72068,68804,13268,147101,164740,276569,162596,66943,11569,26654,66358,4777,23229,102127,5848,978,2921,59666,5371,28212,90108,42938,39320,2499,4271,108792,33510,125072,71653,65239,38250,66357,38577,13964,86251,35708,50755,36010,29448,12209,3844,38222,206337,100876,67827,137088,14167,252225,84163,195270,1306,5703,54198,779,46802,22028,51124,86759,70560,113164,35685,162145,45471,34561,422,2611,6464,47486,19223,38246,9191,18331,89942,243642,212364,15893,17518,22617,6409,30046,126182,59716,36560,104428,18846,26592,19458,50793,147333,30826,1388,27647,10922,14495,33545,19269,135828,39727,41601,46931,233379,49169,131130,182112,16276,82381,118209,142445,128310,19672,28740,82907,33436,3118,102206,28723,24819,41937,38854,5157,3881,111491,1142,9776,421673,152241,29309,14961,87854,6054,15424,3796,82656,54996,2108,55367,239450,154525,9643,118103,106041,64601,68549,48707,30266,25772,18740,9462,229669,91798,112152,191327,14493,72828,8175,66636,236474,25817,87351,129027,76653,20422,22983,71240,27846,44661,12399,46158,77704,53101,35032,11072,17300,109294,33638,24408,1895,11241,760,17584,82479,125877,63150,141075,34259,23274,81698,15732,43577,48340,91584,14688,16379,24481,150280,96420,262050,48635,43727,61819,56268,72003,88178,17281,79912,13218,122519,125295,166396,11811,2171,118930,67746,17636,178278,174656,95661,173039,83845,79689,17473,98555,127696,203415,54730,22925,232239,9309,12136,175026,20740,180188,10747,39816,314017,266131,10040,175732,112550,220651,31974,37393,888,23008,86799,4303,64905,148467,75337,251,3284,370102,50264,9835,5438,23655,4481,29851,329,12855,7162,64931,78141,12804,42372,296771,83547,18624,34874,86271,3360,48665,77735,88767,11463,63527,28889,22258,29140,194315,113924,25499,6406,31334,1845,4802,49184,43455,35469,127594,92970,61038,115005,38840,87761,106838,8811,20572,55637,11162,96721,132425,108925,2948,125457,36356,3502,75270,27622,127192,2561,123095,49394,61155,16897,110064,9699,89448,53356,19628,220310,21622,83036,9885,112214,6087,26713,17901,161912,91492,3440,68594,9266,92238,8087,6866,150194,72175,80701,13459,31836,43243,239700,95846,44749,50647,21945,230538,120612,132371,244604,5193,105637,34661,41341,68775,85393,1874,8771,33718,49672,77403,595452,99507,6490,58895,128742,7704,39239,73217,43816,62824,37804,199976,22361,80005,87514,94832,14089,4574,139975,59142,75523,100268,43906,53442,15152,2547,186002,17011,19513,204282,3343,60568,128318,119250,4298,51871,41336,71759,21921,45074,98169,145889,99427,11350,1237,5520,28799,7803,53702,21026,136352,38293,128690,12158,90132,44600,10184,26957,39459,126025,78904,82999,59373,39301,150198,120529,153042,20177,50089,14764,271571,30530,123161,38975,101562,22941,5648,124654,109243,69817,71675,49162,106884,21241,107795,30258,16572,188262,141456,7688,60718,8271,11044,32440,104608,103419,236109,93156,43293,128929,42107,67180,25201,115254,185488,130954,72813,167547,20537,39969,38432,22582,184022,1139,27199,5655,17767,97412,122606,209377,27070,35871,326617,188954,42680,73512,80911,22629,3011,95021,315242,157737,383,41821,41808,19335,27950,15674,25677,110950,35375,76835,59108,57370,35262,16569,160415,37706,78086,32041,49691,137143,9782,172080,50148,77917,6323,10110,69172,17711,21795,59511,76184,135114,31046,132319,59105,157578,20549,80778,57649,158421,65143,4575,72235,21899,10797,92745,34035,106079,80159,4508,78304,25350,75457,46458,32937,25623,47,8531,104751,84953,8138,36508,187199,66310,115274,13253,32461,38536,1916,42007,187160,35055,26325,84394,35963,94216,45590,97782],_u=15;class CV{log;peerRouting;routingTable;refreshInterval;refreshQueryTimeout;commonPrefixLengthRefreshedAt;refreshTimeoutId;constructor(e,t){const{peerRouting:n,routingTable:i,refreshInterval:s,refreshQueryTimeout:o,logPrefix:a}=t;this.log=e.logger.forComponent(`${a}:routing-table:refresh`),this.peerRouting=n,this.routingTable=i,this.refreshInterval=s??RF,this.refreshQueryTimeout=o??NF,this.commonPrefixLengthRefreshedAt=[],this.refreshTable=this.refreshTable.bind(this)}async afterStart(){this.log(`refreshing routing table every ${this.refreshInterval}ms`),this.refreshTable(!0)}async stop(){this.refreshTimeoutId!=null&&clearTimeout(this.refreshTimeoutId)}refreshTable(e=!1,t){this.log("refreshing routing table");const n=this._maxCommonPrefix(),i=this._getTrackedCommonPrefixLengthsForRefresh(n);this.log(`max common prefix length ${n}`),this.log(`tracked CPLs [ ${i.map(s=>s.toISOString()).join(", ")} ]`),Promise.all(i.map(async(s,o)=>{try{if(await this._refreshCommonPrefixLength(o,s,e,t),this._numPeersForCpl(n)===0){const a=Math.min(2*(o+1),i.length-1);for(let c=o+1;c<a+1;c++)try{await this._refreshCommonPrefixLength(c,s,e,t)}catch(l){this.log.error("failed to refresh entries with common prefix length %d - %e",c,l)}}}catch(a){this.log.error("failed to refresh entries with common prefix length - %e",a)}})).catch(s=>{this.log.error("failed to refresh table - %e",s)}).then(()=>{this.refreshTimeoutId=setTimeout(this.refreshTable,this.refreshInterval),this.refreshTimeoutId.unref!=null&&this.refreshTimeoutId.unref()}).catch(s=>{this.log.error("failed to set refresh timeout - %e",s)})}async _refreshCommonPrefixLength(e,t,n,i){if(!n&&t.getTime()>Date.now()-this.refreshInterval){this.log("not running refresh for cpl %s as time since last refresh not above interval",e);return}const s=this._generateRandomPeerId(e);this.log("starting refreshing cpl %s with key %p (routing table size was %s)",e,s,this.routingTable.size);const o=Ke([i?.signal,AbortSignal.timeout(this.refreshQueryTimeout)]);try{const a=await Iv(this.peerRouting.getClosestPeers(s.toMultihash().bytes,{signal:o}));this.log(`found ${a} peers that were close to imaginary peer %p`,s),this.log("finished refreshing cpl %s with key %p (routing table size is now %s)",e,s,this.routingTable.size)}finally{o.clear()}}_getTrackedCommonPrefixLengthsForRefresh(e){e>_u&&(e=_u);const t=[];for(let n=0;n<=e;n++)t[n]=this.commonPrefixLengthRefreshedAt[n]??new Date;return t}_generateRandomPeerId(e){if(this.routingTable.kb==null)throw new Error("Routing table not started");if(this.routingTable.kb.localPeer==null)throw new Error("Local peer not set");const t=Ss(2),n=(t[1]<<8)+t[0],i=this._makePeerId(this.routingTable.kb.localPeer.kadId,n,e),s=Zt(i);return ln(s)}_makePeerId(e,t,n){if(n>_u)throw new Error(`Cannot generate peer ID for common prefix length greater than ${_u}`);const o=new DataView(e.buffer,e.byteOffset,e.byteLength).getUint16(0,!1)^32768>>n,a=65535<<16-(n+1),c=o&a|t&~a,l=kV[c],u=new ArrayBuffer(34),d=new DataView(u,0,u.byteLength);return d.setUint8(0,Et.code),d.setUint8(1,32),d.setUint32(2,l,!1),new Uint8Array(d.buffer,d.byteOffset,d.byteLength)}_maxCommonPrefix(){let e=0;for(const t of this._prefixLengths())t>e&&(e=t);return e}_numPeersForCpl(e){let t=0;for(const n of this._prefixLengths())n===e&&t++;return t}*_prefixLengths(){if(this.routingTable.kb?.localPeer!=null)for(const{kadId:e}of this.routingTable.kb.toIterable()){const t=qo(this.routingTable.kb.localPeer.kadId,e);let n=0;for(const i of t)if(i===0)n++;else break;yield n}}}class IV{peerId;providers;peerStore;log;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:add-provider`),this.peerId=e.peerId,this.providers=t.providers,this.peerStore=e.peerStore}async handle(e,t){if(t.key==null||t.key.length===0)throw new Je("Missing key");let n;try{n=ae.decode(t.key)}catch{throw new Je("Invalid CID")}(t.providers==null||t.providers.length===0)&&this.log.error("no providers found in message"),this.log("%p asked us, %p to store provider record for for %c",e,this.peerId,n),await Promise.all(t.providers.map(async i=>{const s=Zt(i.id),o=ln(s),a=i.multiaddrs.map(c=>be(c));if(!e.equals(o)){this.log("invalid provider peer %p from %p",i.id,e);return}if(i.multiaddrs.length<1){this.log("no valid addresses for provider %p. Ignore",e);return}this.log.trace("received provider %p for %s (addrs %s)",e,n,a),await this.providers.addProvider(n,o),await this.peerStore.merge(o,{multiaddrs:a})}))}}class _V{peerRouting;peerInfoMapper;peerId;addressManager;log;constructor(e,t){const{peerRouting:n,logPrefix:i}=t;this.log=e.logger.forComponent(`${i}:rpc:handlers:find-node`),this.peerId=e.peerId,this.addressManager=e.addressManager,this.peerRouting=n,this.peerInfoMapper=t.peerInfoMapper}async handle(e,t){this.log("incoming request from %p for peers close to %b",e,t.key);try{if(t.key==null)throw new Je("Invalid FIND_NODE message received - key was missing");const n=await this.peerRouting.getClosestPeersOffline(t.key,{exclude:[e,this.peerId]});Te(this.peerId.toMultihash().bytes,t.key)&&n.push({id:this.peerId,multiaddrs:this.addressManager.getAddresses().map(s=>s.decapsulateCode(ge))});const i={type:it.FIND_NODE,clusterLevel:t.clusterLevel,closer:n.map(this.peerInfoMapper).filter(({multiaddrs:s})=>s.length).map(s=>({id:s.id.toMultihash().bytes,multiaddrs:s.multiaddrs.map(o=>o.bytes)})),providers:[]};return i.closer.length===0?this.log("could not find any peers closer to %b for %p",t.key,e):this.log("found %d peers close to %b for %p",i.closer.length,t.key,e),i}catch(n){throw this.log("error during finding peers closer to %b for %p - %e",t.key,e,n),n}}}class TV{peerId;peerRouting;providers;peerStore;peerInfoMapper;log;constructor(e,t){const{peerRouting:n,providers:i,logPrefix:s}=t;this.log=e.logger.forComponent(`${s}:rpc:handlers:get-providers`),this.peerId=e.peerId,this.peerStore=e.peerStore,this.peerRouting=n,this.providers=i,this.peerInfoMapper=t.peerInfoMapper}async handle(e,t){if(t.key==null)throw new Je("Invalid GET_PROVIDERS message received - key was missing");let n;try{n=ae.decode(t.key)}catch{throw new Je("Invalid CID")}this.log("%p asking for providers for %s",e,n);const[i,s]=await Promise.all([Vo(Ki(await this.providers.getProviders(n),async a=>{const c=await this.peerStore.get(a);return{id:c.id,multiaddrs:c.addresses.map(({multiaddr:u})=>u)}})),this.peerRouting.getClosestPeersOffline(t.key)]),o={type:it.GET_PROVIDERS,key:t.key,clusterLevel:t.clusterLevel,closer:s.map(this.peerInfoMapper).filter(({id:a,multiaddrs:c})=>c.length>0).map(a=>({id:a.id.toMultihash().bytes,multiaddrs:a.multiaddrs.map(c=>c.bytes)})),providers:i.map(this.peerInfoMapper).filter(({id:a,multiaddrs:c})=>c.length>0).map(a=>({id:a.id.toMultihash().bytes,multiaddrs:a.multiaddrs.map(c=>c.bytes)}))};return this.log("got %s providers %s closerPeers",o.providers.length,o.closer.length),o}async _getAddresses(e){return[]}}class PV{peerStore;datastore;peerRouting;log;datastorePrefix;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:get-value`),this.datastorePrefix=`${t.datastorePrefix}/record`,this.peerStore=e.peerStore,this.datastore=e.datastore,this.peerRouting=t.peerRouting}async handle(e,t){const n=t.key;if(this.log("%p asked for key %b",e,n),n==null||n.length===0)throw new Je("Invalid key");const i={type:it.GET_VALUE,key:n,clusterLevel:t.clusterLevel,closer:[],providers:[]};if(jF(n)){this.log("is public key");const a=GF(n);let c;try{const l=await this.peerStore.get(a);if(l.id.publicKey==null)throw new wt("No public key found in key book");c=En(l.id.publicKey)}catch(l){if(l.name!=="NotFoundError")throw l}if(c!=null)return this.log("returning found public key"),i.record=new Lr(n,c,new Date).serialize(),i}const[s,o]=await Promise.all([this._checkLocalDatastore(n),this.peerRouting.getClosestPeersOffline(n)]);return s!=null&&(this.log("had record for %b in local datastore",n),i.record=s.serialize()),o.length>0&&(this.log("had %s closer peers in routing table",o.length),i.closer=o.map(a=>({id:a.id.toMultihash().bytes,multiaddrs:a.multiaddrs.map(c=>c.bytes)}))),i}async _checkLocalDatastore(e){this.log("checkLocalDatastore looking for %b",e);const t=xc(this.datastorePrefix,e);let n;try{n=await this.datastore.get(t)}catch(s){if(s.name==="NotFoundError")return;throw s}const i=Lr.deserialize(n);if(i.timeReceived==null||Date.now()-i.timeReceived.getTime()>Sv){await this.datastore.delete(t);return}return i}}class RV{log;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:ping`)}async handle(e,t){return this.log("ping from %p",e),t}}class NV{components;validators;log;datastorePrefix;constructor(e,t){const{validators:n}=t;this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:put-value`),this.datastorePrefix=`${t.datastorePrefix}/record`,this.validators=n}async handle(e,t){const n=t.key;if(this.log("%p asked us to store value for key %b",e,n),t.record==null)throw this.log.error("empty record from %p",e),new Je(`Empty record from: ${e}`);try{const i=Lr.deserialize(t.record);await p3(this.validators,i),i.timeReceived=new Date;const s=xc(this.datastorePrefix,i.key);await this.components.datastore.put(s,i.serialize().subarray()),this.log("put record for %b into datastore under key %k",n,s)}catch(i){this.log("did not put record for key %b into datastore %o",n,i)}return t}}class DV{handlers;log;metrics;incomingMessageTimeout;constructor(e,t){this.metrics={operations:e.metrics?.registerCounterGroup(`${t.metricsPrefix}_inbound_rpc_requests_total`),errors:e.metrics?.registerCounterGroup(`${t.metricsPrefix}_inbound_rpc_errors_total`),rpcTime:e.metrics?.registerMetricGroup(`${t.metricsPrefix}_inbound_rpc_time_seconds`,{label:"operation"})},this.log=e.logger.forComponent(`${t.logPrefix}:rpc`),this.incomingMessageTimeout=t.incomingMessageTimeout??1e4,this.handlers={[it.GET_VALUE.toString()]:new PV(e,t),[it.PUT_VALUE.toString()]:new NV(e,t),[it.FIND_NODE.toString()]:new _V(e,t),[it.ADD_PROVIDER.toString()]:new IV(e,t),[it.GET_PROVIDERS.toString()]:new TV(e,t),[it.PING.toString()]:new RV(e,t)}}async handleMessage(e,t){const n=this.handlers[t.type];if(n==null){this.log.error(`no handler found for message type: ${t.type}`);return}try{return this.metrics.operations?.increment({[t.type]:!0}),await n.handle(e,t)}catch{this.metrics.errors?.increment({[t.type]:!0})}}async onIncomingStream(e,t){const n=()=>{e.abort(new Lh)};let i=AbortSignal.timeout(this.incomingMessageTimeout);i.addEventListener("abort",n);const s=Qt(e).pb(_o);for(;;){if(e.readStatus!=="readable"){await e.close({signal:i});break}const o=await s.read({signal:i}),a=this.metrics?.rpcTime?.timer(o.type.toString()),c=this.metrics?.rpcTime?.timer(o.type.toString());let l=!1;try{this.log("incoming %s from %p",o.type,t.remotePeer);const u=await this.handleMessage(t.remotePeer,o);u!=null&&await s.write(u,{signal:i})}catch(u){throw l=!0,c?.(),u}finally{l||a?.()}i.removeEventListener("abort",n),i=AbortSignal.timeout(this.incomingMessageTimeout),i.addEventListener("abort",n)}}}class BV extends Qe{log;components;protocol;running;registrarId;constructor(e,t){super();const{protocol:n,logPrefix:i}=t;this.components=e,this.log=e.logger.forComponent(`${i}:topology-listener`),this.running=!1,this.protocol=n}isStarted(){return this.running}async start(){this.running||(this.running=!0,this.registrarId=await this.components.registrar.register(this.protocol,{onConnect:e=>{this.log("observed peer %p with protocol %s",e,this.protocol),this.dispatchEvent(new CustomEvent("peer",{detail:e}))}}))}async stop(){this.running=!1,this.registrarId!=null&&(this.components.registrar.unregister(this.registrarId),this.registrarId=void 0)}}class LV{dht;constructor(e){this.dht=e}async provide(e,t={}){await Li(this.dht.provide(e,t))}async cancelReprovide(e){await this.dht.cancelReprovide(e)}async*findProviders(e,t={}){for await(const n of this.dht.findProviders(e,t))n.name==="PROVIDER"&&(yield*n.providers.map(i=>({...i,routing:"kad-dht"})))}async put(e,t,n){await Li(this.dht.put(e,t,n))}async get(e,t){for await(const n of this.dht.get(e,t))if(n.name==="VALUE")return n.value;throw new wt("Could not find value for key")}}class OV{dht;constructor(e){this.dht=e}async findPeer(e,t={}){for await(const n of this.dht.findPeer(e,t))if(n.name==="FINAL_PEER")return n.peer;throw new wt("Peer not found")}async*getClosestPeers(e,t={}){for await(const n of this.dht.getClosestPeers(e,t))n.name==="FINAL_PEER"&&(yield n.peer)}}const MV=32,$V=64;class UV extends Qe{k;a;d;protocol;routingTable;providers;network;peerRouting;components;log;running;clientMode;validators;selectors;queryManager;contentFetching;contentRouting;routingTableRefresh;rpc;topologyListener;querySelf;maxInboundStreams;maxOutboundStreams;dhtContentRouting;dhtPeerRouting;peerInfoMapper;reprovider;onPeerConnectTimeout;constructor(e,t={}){super();const n=t.logPrefix??"libp2p:kad-dht",i=t.datastorePrefix??"/dht",s=t.metricsPrefix??"libp2p_kad_dht",o={queries:e.metrics?.registerMetricGroup(`${s}_operations_total`,{label:"operation"}),errors:e.metrics?.registerCounterGroup(`${s}_operation_errors_total`,{label:"operation"}),queryTime:e.metrics?.registerMetricGroup(`${s}_operation_time_seconds`,{label:"operation"}),errorTime:e.metrics?.registerMetricGroup(`${s}_operation_error_time_seconds`,{label:"operation"})};this.running=!1,this.components=e,this.log=e.logger.forComponent(n),this.k=t.kBucketSize??m3,this.a=t.alpha??_f,this.d=t.disjointPaths??this.a,this.protocol=t.protocol??SF,this.clientMode=t.clientMode??!0,this.maxInboundStreams=t.maxInboundStreams??MV,this.maxOutboundStreams=t.maxOutboundStreams??$V,this.peerInfoMapper=t.peerInfoMapper??KF,this.onPeerConnectTimeout=t.onPeerConnectTimeout??IF,this.providers=new eV(e,{...t.providers,logPrefix:n,datastorePrefix:i}),this.validators={...HF,...t.validators},this.selectors={...VF,...t.selectors},this.network=new ZF(e,{protocol:this.protocol,logPrefix:n,metricsPrefix:s}),this.routingTable=new AV(e,{kBucketSize:this.k,pingOldContactTimeout:t.pingOldContactTimeout,pingOldContactConcurrency:t.pingOldContactConcurrency,pingOldContactMaxQueueSize:t.pingOldContactMaxQueueSize,pingNewContactTimeout:t.pingNewContactTimeout,pingNewContactConcurrency:t.pingNewContactConcurrency,pingNewContactMaxQueueSize:t.pingNewContactMaxQueueSize,protocol:this.protocol,logPrefix:n,metricsPrefix:s,prefixLength:t.prefixLength,splitThreshold:t.kBucketSplitThreshold,network:this.network});const a=Ze();t.allowQueryWithZeroPeers===!0&&a.resolve(),this.queryManager=new rV(e,{disjointPaths:this.d,alpha:this.a,logPrefix:n,metricsPrefix:s,initialQuerySelfHasRun:a,routingTable:this.routingTable,allowQueryWithZeroPeers:t.allowQueryWithZeroPeers}),this.peerRouting=new JF(e,{routingTable:this.routingTable,network:this.network,validators:this.validators,queryManager:this.queryManager,logPrefix:n}),this.contentFetching=new YF(e,{validators:this.validators,selectors:this.selectors,peerRouting:this.peerRouting,queryManager:this.queryManager,network:this.network,logPrefix:n,datastorePrefix:i}),this.contentRouting=new XF(e,{network:this.network,peerRouting:this.peerRouting,queryManager:this.queryManager,routingTable:this.routingTable,providers:this.providers,logPrefix:n}),this.routingTableRefresh=new CV(e,{peerRouting:this.peerRouting,routingTable:this.routingTable,logPrefix:n}),this.rpc=new DV(e,{routingTable:this.routingTable,providers:this.providers,peerRouting:this.peerRouting,validators:this.validators,logPrefix:n,metricsPrefix:s,datastorePrefix:i,peerInfoMapper:this.peerInfoMapper}),this.topologyListener=new BV(e,{protocol:this.protocol,logPrefix:n}),this.querySelf=new iV(e,{peerRouting:this.peerRouting,interval:t.querySelfInterval,initialInterval:t.initialQuerySelfInterval,logPrefix:n,initialQuerySelfHasRun:a,operationMetrics:o}),this.reprovider=new sV(e,{...t.reprovide,logPrefix:n,metricsPrefix:s,datastorePrefix:i,contentRouting:this.contentRouting,operationMetrics:o}),this.network.addEventListener("peer",c=>{const l=c.detail;this.onPeerConnect(l).catch(u=>{this.log.error("could not add %p to routing table - %e",l.id,u)}),this.dispatchEvent(new CustomEvent("peer",{detail:l}))}),this.topologyListener.addEventListener("peer",c=>{const l=c.detail;Promise.resolve().then(async()=>{const u=await this.components.peerStore.get(l),d={id:l,multiaddrs:u.addresses.map(({multiaddr:h})=>h),protocols:u.protocols};await this.onPeerConnect(d)}).catch(u=>{this.log.error("could not add %p to routing table - %e",l,u)})}),this.dhtPeerRouting=new OV(this),this.dhtContentRouting=new LV(this),t.clientMode==null&&e.events.addEventListener("self:peer:update",c=>{this.log("received update of self-peer info"),Promise.resolve().then(async()=>{const l=c.detail.peer.addresses.some(({multiaddr:d})=>!Or(d)&&!_n.exactMatch(d)),u=this.getMode();l&&u==="client"?await this.setMode("server"):u==="server"&&!l&&await this.setMode("client")}).catch(l=>{this.log.error("error setting dht server mode - %e",l)})}),this.get=oo(this.get.bind(this),o,"GET_VALUE"),this.findProviders=oo(this.findProviders.bind(this),o,"FIND_PROVIDERS"),this.findPeer=oo(this.findPeer.bind(this),o,"FIND_PEER"),this.getClosestPeers=oo(this.getClosestPeers.bind(this),o,"GET_CLOSEST_PEERS"),this.provide=oo(this.provide.bind(this),o,"PROVIDE"),this.put=oo(this.put.bind(this),o,"PUT_VALUE")}[Symbol.toStringTag]="@libp2p/kad-dht";[It]=["@libp2p/content-routing","@libp2p/peer-routing","@libp2p/peer-discovery","@libp2p/kad-dht"];[ws]=["@libp2p/identify","@libp2p/ping"];get[Rc](){return this.dhtContentRouting}get[Nc](){return this.dhtPeerRouting}get[Qu](){return this}async onPeerConnect(e){if(this.log.trace("peer %p connected",e.id,e.multiaddrs),e=this.peerInfoMapper(e),e.multiaddrs.length===0){this.log.trace("ignoring %p as there were no valid addresses in %s after filtering",e.id,e.multiaddrs.map(n=>n.toString()));return}const t=AbortSignal.timeout(this.onPeerConnectTimeout);try{await this.routingTable.add(e.id,{signal:t})}catch(n){this.log.error("could not add %p to routing table - %e",e.id,n)}}isStarted(){return this.running}getMode(){return this.clientMode?"client":"server"}async setMode(e,t){if(e===this.getMode()&&t?.force!==!0){this.log("already in %s mode",e);return}if(await this.components.registrar.unhandle(this.protocol,t),e===this.getMode()&&t?.force!==!0){this.log("already in %s mode",e);return}e==="client"?(this.log("enabling client mode while in %s mode",this.getMode()),this.clientMode=!0):(this.log("enabling server mode while in %s mode",this.getMode()),this.clientMode=!1,await this.components.registrar.handle(this.protocol,this.rpc.onIncomingStream.bind(this.rpc),{signal:t?.signal,maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams}))}async start(){this.running||(this.running=!0,await this.setMode(this.clientMode?"client":"server",{force:!0}),await Cn(this.routingTable,this.queryManager,this.network,this.topologyListener,this.routingTableRefresh,this.reprovider),await Cn(this.querySelf))}async stop(){this.running=!1,await ni(this.querySelf,this.queryManager,this.network,this.routingTable,this.routingTableRefresh,this.topologyListener,this.reprovider)}async*put(e,t,n={}){yield*this.contentFetching.put(e,t,n)}async*get(e,t={}){yield*this.contentFetching.get(e,t)}async*provide(e,t={}){yield*this.contentRouting.provide(e,this.components.addressManager.getAddresses(),t)}async cancelReprovide(e,t){await this.providers.removeProvider(e,this.components.peerId,t)}async*findProviders(e,t={}){yield*this.contentRouting.findProviders(e,t)}async*findPeer(e,t={}){yield*this.peerRouting.findPeer(e,t)}async*getClosestPeers(e,t={}){yield*this.peerRouting.getClosestPeers(e,t)}async refreshRoutingTable(e){this.routingTableRefresh.refreshTable(!0,e)}}var r6;(function(r){r[r.SEND_QUERY=0]="SEND_QUERY",r[r.PEER_RESPONSE=1]="PEER_RESPONSE",r[r.FINAL_PEER=2]="FINAL_PEER",r[r.QUERY_ERROR=3]="QUERY_ERROR",r[r.PROVIDER=4]="PROVIDER",r[r.VALUE=5]="VALUE",r[r.ADD_PEER=6]="ADD_PEER",r[r.DIAL_PEER=7]="DIAL_PEER",r[r.PATH_ENDED=8]="PATH_ENDED"})(r6||(r6={}));function FV(r={}){return e=>new UV(e,r)}var We;(function(r){r[r.NEW_STREAM=0]="NEW_STREAM",r[r.MESSAGE_RECEIVER=1]="MESSAGE_RECEIVER",r[r.MESSAGE_INITIATOR=2]="MESSAGE_INITIATOR",r[r.CLOSE_RECEIVER=3]="CLOSE_RECEIVER",r[r.CLOSE_INITIATOR=4]="CLOSE_INITIATOR",r[r.RESET_RECEIVER=5]="RESET_RECEIVER",r[r.RESET_INITIATOR=6]="RESET_INITIATOR"})(We||(We={}));const y3=Object.freeze({0:"NEW_STREAM",1:"MESSAGE_RECEIVER",2:"MESSAGE_INITIATOR",3:"CLOSE_RECEIVER",4:"CLOSE_INITIATOR",5:"RESET_RECEIVER",6:"RESET_INITIATOR"}),n6=Object.freeze({NEW_STREAM:We.NEW_STREAM,MESSAGE:We.MESSAGE_INITIATOR,CLOSE:We.CLOSE_INITIATOR,RESET:We.RESET_INITIATOR}),VV=Object.freeze({MESSAGE:We.MESSAGE_RECEIVER,CLOSE:We.CLOSE_RECEIVER,RESET:We.RESET_RECEIVER}),w3=1<<20,_v=4<<20;class zV{_buffer;_headerInfo;_maxMessageSize;_maxUnprocessedMessageQueueSize;constructor(e=w3,t=_v){this._buffer=new me,this._headerInfo=null,this._maxMessageSize=e,this._maxUnprocessedMessageQueueSize=t}write(e){if(e==null||e.length===0)return[];if(this._buffer.append(e),this._buffer.byteLength>this._maxUnprocessedMessageQueueSize)throw new Je("Unprocessed message queue size too large!");const t=[];for(;this._buffer.length!==0;){if(this._headerInfo==null)try{this._headerInfo=this._decodeHeader(this._buffer)}catch(l){if(l.name==="InvalidMessageError")throw l;break}const{id:n,type:i,length:s,offset:o}=this._headerInfo;if(this._buffer.length-o<s)break;const c={id:n,type:i};(i===We.NEW_STREAM||i===We.MESSAGE_INITIATOR||i===We.MESSAGE_RECEIVER)&&(c.data=this._buffer.sublist(o,o+s)),t.push(c),this._buffer.consume(o+s),this._headerInfo=null}return t}_decodeHeader(e){const{value:t,offset:n}=s6(e),{value:i,offset:s}=s6(e,n),o=t&7;if(y3[o]==null)throw new Error(`Invalid type received: ${o}`);if(i>this._maxMessageSize)throw new Je("Message size too large");return{id:t>>3,type:o,offset:n+s,length:i}}}const HV=128,i6=127;function s6(r,e=0){let t=0,n=0,i=e,s;const o=r.length;do{if(i>=o||n>49)throw e=0,new RangeError("Could not decode varint");s=r.get(i++),t+=n<28?(s&i6)<<n:(s&i6)*Math.pow(2,n),n+=7}while(s>=HV);return e=i-e,{value:t,offset:e}}const J1=10*1024;class qV{_pool;_poolOffset;constructor(){this._pool=Ar(J1),this._poolOffset=0}write(e,t){const n=this._pool;let i=this._poolOffset;vn(e.id<<3|e.type,n,i),i+=et(e.id<<3|e.type),(e.type===We.NEW_STREAM||e.type===We.MESSAGE_INITIATOR||e.type===We.MESSAGE_RECEIVER)&&e.data!=null?(vn(e.data.length,n,i),i+=et(e.data.length)):(vn(0,n,i),i+=et(0));const s=n.subarray(this._poolOffset,i);J1-i<100?(this._pool=Ar(J1),this._poolOffset=0):this._poolOffset=i,t.append(s),(e.type===We.NEW_STREAM||e.type===We.MESSAGE_INITIATOR||e.type===We.MESSAGE_RECEIVER)&&e.data!=null&&t.append(e.data)}}const KV=new qV;function Tu(r){const e=new me;return KV.write(r,e),e}class WV extends mg{streamId;types;maxDataSize;muxer;constructor(e){super(e),this.types=e.direction==="outbound"?n6:VV,this.maxDataSize=e.maxDataSize,this.muxer=e.muxer,this.streamId=parseInt(this.id.substring(1)),e.direction==="outbound"&&queueMicrotask(()=>{this.muxer.send(Tu({id:this.streamId,type:n6.NEW_STREAM,data:new me(W(this.id))}))})}sendData(e){const t=new me,n=e.byteLength;for(;e.byteLength>0;){const i=Math.min(e.byteLength,this.maxDataSize),s=e.sublist(0,i);e=e.sublist(i),t.append(Tu({id:this.streamId,type:this.types.MESSAGE,data:s}))}return{sentBytes:n,canSendMore:this.muxer.send(t)}}sendReset(){return this.muxer.send(Tu({id:this.streamId,type:this.types.RESET}))}async sendCloseWrite(e){this.muxer.send(Tu({id:this.streamId,type:this.types.CLOSE})),e?.signal?.throwIfAborted()}async sendCloseRead(e){e?.signal?.throwIfAborted()}sendPause(){}sendResume(){}}function jV(r){const{id:e,muxer:t,direction:n,maxMsgSize:i=w3}=r;return new WV({...r,id:n==="outbound"?`i${e}`:`r${e}`,direction:n,maxDataSize:i,muxer:t,log:r.log.newScope(`${n}:${e}`),protocol:""})}const GV=5;function YV(r){const e={...r,type:`${y3[r.type]} (${r.type})`};return r.type===We.NEW_STREAM&&(e.data=Y(r.data.subarray())),(r.type===We.MESSAGE_INITIATOR||r.type===We.MESSAGE_RECEIVER)&&(e.data=Y(r.data.subarray(),"base16")),e}class QV extends gg{_streamId;rateLimiter;maxMessageSize;maxUnprocessedMessageQueueSize;decoder;constructor(e,t){super(e,{...t,protocol:"/mplex/6.7.0",name:"mplex"}),this._streamId=0,this.maxMessageSize=t.maxMessageSize??w3,this.maxUnprocessedMessageQueueSize=t.maxUnprocessedMessageQueueSize??_v,this.decoder=new zV(this.maxMessageSize,this.maxUnprocessedMessageQueueSize),this.rateLimiter=new dw({points:t.disconnectThreshold??GV,duration:1})}onData(e){for(const t of this.decoder.write(e))this.handleMessage(t)}onCreateStream(e){if(this.status!=="open")throw new fo("Muxer already closed");const t=this._streamId++;return this._newStream(t,"outbound",e)}_newStream(e,t,n){return this.log("new %s stream %s",t,e),jV({...n,id:e,direction:t,maxMsgSize:this.maxMessageSize,log:this.log,muxer:this})}handleMessage(e){if(this.log.enabled&&this.log.trace("incoming message",YV(e)),e.type===We.NEW_STREAM){try{this.rateLimiter.consume("new-stream",1)}catch{this.log("rate limit hit when opening too many new streams over the inbound stream limit - closing remote connection"),this.abort(new Error("Too many open streams"));return}const i=this._newStream(e.id,"inbound",this.streamOptions);this.onRemoteStream(i);return}const t=`${(e.type&1)===1?"i":"r"}${e.id}`,n=this.streams.find(i=>i.id===t);if(n==null){this.log("missing stream %s for message type %s",t,y3[e.type]);try{this.rateLimiter.consume("missing-stream",1)}catch{this.log("rate limit hit when receiving messages for streams that do not exist - closing remote connection"),this.abort(new Error("Too many messages for missing streams"));return}return}try{switch(e.type){case We.MESSAGE_INITIATOR:case We.MESSAGE_RECEIVER:n.onData(e.data);break;case We.CLOSE_INITIATOR:case We.CLOSE_RECEIVER:n.onRemoteCloseWrite();break;case We.RESET_INITIATOR:case We.RESET_RECEIVER:n.onRemoteReset();break;default:this.log("unknown message type")}}catch(i){this.log.error("error while processing message - %e",i),n.abort(i)}}}class XV{protocol="/mplex/6.7.0";_init;constructor(e={}){this._init=e}[Symbol.toStringTag]="@libp2p/mplex";[It]=["@libp2p/stream-multiplexing"];createStreamMuxer(e){return new QV(e,{...this._init})}}function ZV(r={}){return()=>new XV(r)}const o6=32,JV="1.0.0",ez="ping",tz="ipfs",rz=1e4,nz=2,iz=1;class sz{protocol;components;started;timeout;maxInboundStreams;maxOutboundStreams;runOnLimitedConnection;constructor(e,t={}){this.components=e,this.started=!1,this.protocol=`/${t.protocolPrefix??tz}/${ez}/${JV}`,this.timeout=t.timeout??rz,this.maxInboundStreams=t.maxInboundStreams??nz,this.maxOutboundStreams=t.maxOutboundStreams??iz,this.runOnLimitedConnection=t.runOnLimitedConnection??!0,this.handlePing=this.handlePing.bind(this)}[Symbol.toStringTag]="@libp2p/ping";[It]=["@libp2p/ping"];async start(){await this.components.registrar.handle(this.protocol,this.handlePing,{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:this.runOnLimitedConnection}),this.started=!0}async stop(){await this.components.registrar.unhandle(this.protocol),this.started=!1}isStarted(){return this.started}async handlePing(e,t){const n=e.log.newScope("ping");n.trace("ping from %p",t.remotePeer);const i=AbortSignal.timeout(this.timeout);i.addEventListener("abort",()=>{e.abort(new Lh("Ping timed out"))});const s=Date.now();for await(const o of e){if(e.status!=="open"){n("stream status changed to %s",e.status);break}e.send(o)||(n("waiting for stream to drain"),await bt(e,"drain",{rejectionEvents:["close"],signal:i}),n("stream drained"))}n("ping from %p complete in %dms",t.remotePeer,Date.now()-s),await e.close({signal:i})}async ping(e,t={}){const n=Ss(o6),i=await this.components.connectionManager.openStream(e,this.protocol,{runOnLimitedConnection:this.runOnLimitedConnection,...t}),s=i.log.newScope("ping");try{const o=Date.now(),a=Promise.withResolvers(),c=new me,l=u=>{if(c.append(u.data),c.byteLength===o6){i.removeEventListener("message",l);const d=Date.now()-o;Promise.all([i.closeRead(t)]).then(()=>{if(Te(n,c.subarray()))a.resolve(d);else throw new p0(`Received wrong ping ack after ${d}ms`)}).catch(h=>{i.abort(h),a.reject(h)})}};return i.addEventListener("message",l),i.send(n),await i.close(t),await Yt(a.promise,t.signal)}catch(o){throw s.error("error while pinging %o - %e",e,o),i?.abort(o),o}finally{i?.close()}}}function oz(r={}){return e=>new sz(e,r)}var ur;(function(r){(function(n){n.FIN="FIN",n.STOP_SENDING="STOP_SENDING",n.RESET="RESET",n.FIN_ACK="FIN_ACK"})(r.Flag||(r.Flag={}));let e;(function(n){n[n.FIN=0]="FIN",n[n.STOP_SENDING=1]="STOP_SENDING",n[n.RESET=2]="RESET",n[n.FIN_ACK=3]="FIN_ACK"})(e||(e={})),(function(n){n.codec=()=>sr(e)})(r.Flag||(r.Flag={}));let t;r.codec=()=>(t==null&&(t=Ce((n,i,s={})=>{s.lengthDelimited!==!1&&i.fork(),n.flag!=null&&(i.uint32(8),r.Flag.codec().encode(n.flag,i)),n.message!=null&&(i.uint32(18),i.bytes(n.message)),s.lengthDelimited!==!1&&i.ldelim()},(n,i,s={})=>{const o={},a=i==null?n.len:n.pos+i;for(;n.pos<a;){const c=n.uint32();switch(c>>>3){case 1:{o.flag=r.Flag.codec().decode(n);break}case 2:{o.message=n.bytes();break}default:{n.skipType(c&7);break}}}return o})),t),r.encode=n=>ke(n,r.codec()),r.decode=(n,i)=>Ae(n,r.codec(),i)})(ur||(ur={}));const az=["stun:stun.l.google.com:19302","stun:global.stun.twilio.com:3478","stun:stun.cloudflare.com:3478","stun:stun.services.mozilla.com:3478"],a6=Array.from("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890"),cz="libp2p+webrtc+v1/",lz=2*1024*1024,Tf=16*1024;function uz(r=Tf){const e=et(r-et(r)),t=1+et(Object.keys(ur.Flag).length-1),n=1,i=r-e-t-n,s=et(i);return e+t+n+s}const dz=uz(),hz=1e4,Tv="/webrtc",h2="/webrtc-signaling/0.0.1",fz="/libp2p/webrtc-direct/certificate",pz="webrtc-direct-certificate-private-key",gz=12096e5,c6=864e5;var l6=function(r,e,t){if(t||arguments.length===2)for(var n=0,i=e.length,s;n<i;n++)(s||!(n in e))&&(s||(s=Array.prototype.slice.call(e,0,n)),s[n]=e[n]);return r.concat(s||Array.prototype.slice.call(e))},mz=(function(){function r(e,t,n){this.name=e,this.version=t,this.os=n,this.type="browser"}return r})(),yz=(function(){function r(e){this.version=e,this.type="node",this.name="node",this.os=process.platform}return r})(),wz=(function(){function r(e,t,n,i){this.name=e,this.version=t,this.os=n,this.bot=i,this.type="bot-device"}return r})(),bz=(function(){function r(){this.type="bot",this.bot=!0,this.name="bot",this.version=null,this.os=null}return r})(),vz=(function(){function r(){this.type="react-native",this.name="react-native",this.version=null,this.os=null}return r})(),Ez=/alexa|bot|crawl(er|ing)|facebookexternalhit|feedburner|google web preview|nagios|postrank|pingdom|slurp|spider|yahoo!|yandex/,Sz=/(nuhk|curl|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask\ Jeeves\/Teoma|ia_archiver)/,u6=3,xz=[["aol",/AOLShield\/([0-9\._]+)/],["edge",/Edge\/([0-9\._]+)/],["edge-ios",/EdgiOS\/([0-9\._]+)/],["yandexbrowser",/YaBrowser\/([0-9\._]+)/],["kakaotalk",/KAKAOTALK\s([0-9\.]+)/],["samsung",/SamsungBrowser\/([0-9\.]+)/],["silk",/\bSilk\/([0-9._-]+)\b/],["miui",/MiuiBrowser\/([0-9\.]+)$/],["beaker",/BeakerBrowser\/([0-9\.]+)/],["edge-chromium",/EdgA?\/([0-9\.]+)/],["chromium-webview",/(?!Chrom.*OPR)wv\).*Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["chrome",/(?!Chrom.*OPR)Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["phantomjs",/PhantomJS\/([0-9\.]+)(:?\s|$)/],["crios",/CriOS\/([0-9\.]+)(:?\s|$)/],["firefox",/Firefox\/([0-9\.]+)(?:\s|$)/],["fxios",/FxiOS\/([0-9\.]+)/],["opera-mini",/Opera Mini.*Version\/([0-9\.]+)/],["opera",/Opera\/([0-9\.]+)(?:\s|$)/],["opera",/OPR\/([0-9\.]+)(:?\s|$)/],["pie",/^Microsoft Pocket Internet Explorer\/(\d+\.\d+)$/],["pie",/^Mozilla\/\d\.\d+\s\(compatible;\s(?:MSP?IE|MSInternet Explorer) (\d+\.\d+);.*Windows CE.*\)$/],["netfront",/^Mozilla\/\d\.\d+.*NetFront\/(\d.\d)/],["ie",/Trident\/7\.0.*rv\:([0-9\.]+).*\).*Gecko$/],["ie",/MSIE\s([0-9\.]+);.*Trident\/[4-7].0/],["ie",/MSIE\s(7\.0)/],["bb10",/BB10;\sTouch.*Version\/([0-9\.]+)/],["android",/Android\s([0-9\.]+)/],["ios",/Version\/([0-9\._]+).*Mobile.*Safari.*/],["safari",/Version\/([0-9\._]+).*Safari/],["facebook",/FB[AS]V\/([0-9\.]+)/],["instagram",/Instagram\s([0-9\.]+)/],["ios-webview",/AppleWebKit\/([0-9\.]+).*Mobile/],["ios-webview",/AppleWebKit\/([0-9\.]+).*Gecko\)$/],["curl",/^curl\/([0-9\.]+)$/],["searchbot",Ez]],d6=[["iOS",/iP(hone|od|ad)/],["Android OS",/Android/],["BlackBerry OS",/BlackBerry|BB10/],["Windows Mobile",/IEMobile/],["Amazon OS",/Kindle/],["Windows 3.11",/Win16/],["Windows 95",/(Windows 95)|(Win95)|(Windows_95)/],["Windows 98",/(Windows 98)|(Win98)/],["Windows 2000",/(Windows NT 5.0)|(Windows 2000)/],["Windows XP",/(Windows NT 5.1)|(Windows XP)/],["Windows Server 2003",/(Windows NT 5.2)/],["Windows Vista",/(Windows NT 6.0)/],["Windows 7",/(Windows NT 6.1)/],["Windows 8",/(Windows NT 6.2)/],["Windows 8.1",/(Windows NT 6.3)/],["Windows 10",/(Windows NT 10.0)/],["Windows ME",/Windows ME/],["Windows CE",/Windows CE|WinCE|Microsoft Pocket Internet Explorer/],["Open BSD",/OpenBSD/],["Sun OS",/SunOS/],["Chrome OS",/CrOS/],["Linux",/(Linux)|(X11)/],["Mac OS",/(Mac_PowerPC)|(Macintosh)/],["QNX",/QNX/],["BeOS",/BeOS/],["OS/2",/OS\/2/]];function Az(r){return typeof document>"u"&&typeof navigator<"u"&&navigator.product==="ReactNative"?new vz:typeof navigator<"u"?Cz(navigator.userAgent):_z()}function kz(r){return r!==""&&xz.reduce(function(e,t){var n=t[0],i=t[1];if(e)return e;var s=i.exec(r);return!!s&&[n,s]},!1)}function Cz(r){var e=kz(r);if(!e)return null;var t=e[0],n=e[1];if(t==="searchbot")return new bz;var i=n[1]&&n[1].split(".").join("_").split("_").slice(0,3);i?i.length<u6&&(i=l6(l6([],i,!0),Tz(u6-i.length),!0)):i=[];var s=i.join("."),o=Iz(r),a=Sz.exec(r);return a&&a[1]?new wz(t,s,o,a[1]):new mz(t,s,o)}function Iz(r){for(var e=0,t=d6.length;e<t;e++){var n=d6[e],i=n[0],s=n[1],o=s.exec(r);if(o)return i}return null}function _z(){var r=typeof process<"u"&&process.version;return r?new yz(process.version.slice(1)):null}function Tz(r){for(var e=[],t=0;t<r;t++)e.push("0");return e}const h6=Az(),Pv=h6!=null&&h6.name==="firefox";async function f6(r){return r=r??{},typeof r=="function"&&(r=await r()),r.iceServers=r.iceServers??az.map(e=>({urls:[e]})),r}const Pz=(r=32)=>cz+[...Array(r)].map(()=>a6.at(Math.floor(Math.random()*a6.length))).join("");class Rz extends mg{channel;incomingData;maxBufferedAmount;receivedFinAck;finAckTimeout;constructor(e){super({...e,maxMessageSize:(e.maxMessageSize??Tf)-dz}),this.channel=e.channel,this.channel.binaryType="arraybuffer",this.incomingData=ii(),this.maxBufferedAmount=e.maxBufferedAmount??lz,this.finAckTimeout=e.finAckTimeout??hz,this.channel.onclose=()=>{this.log.trace("received datachannel close event"),this.onRemoteCloseWrite(),this.onTransportClosed()},this.channel.onerror=n=>{const i=n.error;this.log.trace("received datachannel error event - %e",i),this.abort(i)},this.channel.onmessage=async n=>{this.log("incoming message %d bytes",n.data.byteLength);const{data:i}=n;i===null||i.byteLength===0||this.incomingData.push(new Uint8Array(i,0,i.byteLength))},this.channel.bufferedAmountLowThreshold=0,this.channel.onbufferedamountlow=()=>{this.writableNeedsDrain&&this.safeDispatchEvent("drain")},Promise.resolve().then(async()=>{for await(const n of wd(this.incomingData))this.processIncomingProtobuf(n)}).catch(n=>{this.log.error("error processing incoming data channel messages - %e",n)});const t=()=>{this.channel.readyState==="open"&&(this.log.trace("stream closed, closing underlying datachannel"),this.channel.close())};this.addEventListener("close",t),this.channel.readyState!=="open"&&(this.log('channel ready state is "%s" and not "open", waiting for "open" event before sending data',this.channel.readyState),bt(this.channel,"open",{rejectionEvents:["close","error"]}).then(()=>{this.log('channel ready state is now "%s", dispatching drain',this.channel.readyState),this.safeDispatchEvent("drain")}).catch(n=>{this.abort(n.error??n)}))}sendNewStream(){}_sendMessage(e){if(this.channel.readyState!=="open")throw new co(`Invalid datachannel state - ${this.channel.readyState}`);if(this.log.trace('sending message, channel state "%s"',this.channel.readyState),Pv){this.channel.send(e.subarray());return}for(const t of e)this.channel.send(t)}sendData(e){return this.channel.readyState!=="open"?{sentBytes:0,canSendMore:!1}:(this._sendMessage(jc.single(ur.encode({message:e.subarray()}))),{sentBytes:e.byteLength,canSendMore:this.channel.bufferedAmount<this.maxBufferedAmount})}sendReset(e){try{this.log.error("sending reset - %e",e),this._sendFlag(ur.Flag.RESET),this.receivedFinAck?.reject(e)}catch(t){this.log.error("failed to send reset - %e",t)}}async sendCloseWrite(e){this._sendFlag(ur.Flag.FIN),e?.signal?.throwIfAborted(),this.receivedFinAck=Promise.withResolvers();const t=e?.signal??AbortSignal.timeout(this.finAckTimeout),n=[bt(this.channel,"close",{signal:t}),bt(this.channel,"error",{signal:t})];await Promise.any([Yt(this.receivedFinAck.promise,t),...n]).finally(()=>{n.forEach(i=>i.cancel())})}async sendCloseRead(e){this._sendFlag(ur.Flag.STOP_SENDING),e?.signal?.throwIfAborted()}processIncomingProtobuf(e){const t=ur.decode(e);t.message!=null&&(this.readStatus==="readable"||this.readStatus==="paused")&&this.onData(new me(t.message)),t.flag!==void 0&&(this.log.trace('incoming flag %s, write status "%s", read status "%s"',t.flag,this.writeStatus,this.readStatus),t.flag===ur.Flag.FIN&&(this._sendFlag(ur.Flag.FIN_ACK),this.onRemoteCloseWrite()),t.flag===ur.Flag.RESET&&(this.receivedFinAck?.reject(new n8("The stream was reset")),this.onRemoteReset()),t.flag===ur.Flag.STOP_SENDING&&this.onRemoteCloseRead(),t.flag===ur.Flag.FIN_ACK&&this.receivedFinAck?.resolve())}_sendFlag(e){if(this.channel.readyState!=="open")return this.log.trace('not sending flag %s because channel is "%s" and not "open"',e.toString(),this.channel.readyState),!1;this.log.trace("sending flag %s",e.toString());const t=ur.encode({flag:e}),n=jc.single(t);try{return this._sendMessage(n),!0}catch(i){this.log.error("could not send flag %s - %e",e.toString(),i)}return!1}sendPause(){}sendResume(){}}function f2(r){const{channel:e,direction:t,isHandshake:n}=r;return new Rz({...r,id:`${e.id}`,log:r.log.newScope(`${n===!0?"handshake":t}:${e.id}`),protocol:""})}class b3{protocol;peerConnection;metrics;dataChannelOptions;earlyDataChannels;constructor(e){this.onEarlyDataChannel=this.onEarlyDataChannel.bind(this),this.peerConnection=e.peerConnection,this.metrics=e.metrics,this.protocol=e.protocol??Tv,this.dataChannelOptions=e.dataChannelOptions??{},this.peerConnection.addEventListener("datachannel",this.onEarlyDataChannel),this.earlyDataChannels=[]}onEarlyDataChannel(e){this.earlyDataChannels.push(e.channel)}createStreamMuxer(e){return this.peerConnection.removeEventListener("datachannel",this.onEarlyDataChannel),new Nz(e,{peerConnection:this.peerConnection,dataChannelOptions:this.dataChannelOptions,metrics:this.metrics,protocol:this.protocol,earlyDataChannels:this.earlyDataChannels})}}class Nz extends gg{peerConnection;dataChannelOptions;constructor(e,t){super(e,{...t,name:"muxer"}),this.peerConnection=t.peerConnection,this.protocol=t.protocol??Tv,this.dataChannelOptions=t.dataChannelOptions??{},this.peerConnection.ondatachannel=({channel:n})=>{this.onDataChannel(n)},queueMicrotask(()=>{if(this.status!=="open"){t.earlyDataChannels.forEach(n=>{n.close()});return}t.earlyDataChannels.forEach(n=>{this.onDataChannel(n)})})}onDataChannel(e){if(this.log("incoming datachannel with channel id %d, protocol %s and status %s",e.id,e.protocol,e.readyState),e.label==="init"){this.log.trace("closing init channel %d",e.id),e.close();return}const t=f2({...this.streamOptions,...this.dataChannelOptions,channel:e,direction:"inbound",log:this.log});this.onRemoteStream(t)}async onCreateStream(e){const t=this.peerConnection.createDataChannel("",{});return this.log("open channel %d for protocol %s",t.id,e?.protocol),f2({...e,...this.dataChannelOptions,channel:t,direction:"outbound",log:this.log})}onData(){}}class Dz extends pg{peerConnection;constructor(e){super(e),this.peerConnection=e.peerConnection;const t=e.peerConnection.connectionState;this.peerConnection.onconnectionstatechange=()=>{this.log.trace("peer connection state change %s initial state %s",this.peerConnection.connectionState,t),(this.peerConnection.connectionState==="disconnected"||this.peerConnection.connectionState==="failed"||this.peerConnection.connectionState==="closed")&&(this.onTransportClosed(),this.peerConnection.close())}}sendData(e){return{sentBytes:e.byteLength,canSendMore:!0}}async sendClose(e){this.peerConnection.close(),e?.signal?.throwIfAborted()}sendReset(){this.peerConnection.close()}sendPause(){}sendResume(){}}const p2=r=>new Dz(r),Rv=globalThis.RTCPeerConnection,Nv=globalThis.RTCSessionDescription,Bz=globalThis.RTCIceCandidate;class Nl extends Error{constructor(e){super(`WebRTC transport error: ${e}`),this.name="WebRTCTransportError"}}class Ai extends Nl{constructor(e="SDP handshake failed"){super(e),this.name="SDPHandshakeFailedError"}}class Lz extends Nl{constructor(e,t){super(`Invalid fingerprint "${e}" within ${t}`),this.name="WebRTC/InvalidFingerprintError"}}class Oz extends Nl{constructor(e){super(`A method (${e}) was called though it has been intentionally left unimplemented.`),this.name="WebRTC/UnimplementedError"}}class Mz extends Nl{constructor(e){super(`unsupported hash algorithm code: ${e} please see the codes at https://github.com/multiformats/multicodec/blob/master/table.csv `),this.name="WebRTC/UnsupportedHashAlgorithmError"}}var Qr;(function(r){(function(n){n.SDP_OFFER="SDP_OFFER",n.SDP_ANSWER="SDP_ANSWER",n.ICE_CANDIDATE="ICE_CANDIDATE"})(r.Type||(r.Type={}));let e;(function(n){n[n.SDP_OFFER=0]="SDP_OFFER",n[n.SDP_ANSWER=1]="SDP_ANSWER",n[n.ICE_CANDIDATE=2]="ICE_CANDIDATE"})(e||(e={})),(function(n){n.codec=()=>sr(e)})(r.Type||(r.Type={}));let t;r.codec=()=>(t==null&&(t=Ce((n,i,s={})=>{s.lengthDelimited!==!1&&i.fork(),n.type!=null&&(i.uint32(8),r.Type.codec().encode(n.type,i)),n.data!=null&&(i.uint32(18),i.string(n.data)),s.lengthDelimited!==!1&&i.ldelim()},(n,i,s={})=>{const o={},a=i==null?n.len:n.pos+i;for(;n.pos<a;){const c=n.uint32();switch(c>>>3){case 1:{o.type=r.Type.codec().decode(n);break}case 2:{o.data=n.string();break}default:{n.skipType(c&7);break}}}return o})),t),r.encode=n=>ke(n,r.codec()),r.decode=(n,i)=>Ae(n,r.codec(),i)})(Qr||(Qr={}));const Dv=async(r,e,t)=>{try{const n=Promise.withResolvers();for($z(r,n);;){const i=await Promise.race([n.promise,e.read({signal:t.signal})]);if(i==null){t.signal?.throwIfAborted();break}if(i.type!==Qr.Type.ICE_CANDIDATE)throw new Je("ICE candidate message expected");const s=JSON.parse(i.data??"null");if(s===""||s===null){t.onProgress?.(new oe("webrtc:end-of-ice-candidates")),t.log.trace("end-of-candidates received");continue}const o=new Bz(s);t.log.trace("%s received new ICE candidate %o",t.direction,s);try{t.onProgress?.(new oe("webrtc:add-ice-candidate",o.candidate)),await r.addIceCandidate(o)}catch(a){t.log.error("%s bad candidate received %o - %e",t.direction,s,a)}}}catch(n){if(t.log.error("%s error parsing ICE candidate - %e",t.direction,n),t.signal?.aborted===!0&&r.connectionState!=="connected")throw n}};function $z(r,e){if(r.connectionState==="connected"){e.resolve();return}r.onconnectionstatechange=t=>{switch(r.connectionState){case"connected":e.resolve();break;case"failed":case"disconnected":case"closed":e.reject(new r8(`RTCPeerConnection connection state became "${r.connectionState}"`));break}}}function Bv(r){let e;for(const t of r.getComponents())t.name==="p2p"&&(e=or(t.value??""));if(e==null)throw new Bh("Remote peerId must be present in multiaddr");return e}async function Uz({rtcConfiguration:r,dataChannel:e,signal:t,metrics:n,multiaddr:i,connectionManager:s,transportManager:o,log:a,logger:c,onProgress:l}){const{circuitAddress:u,targetPeer:d}=zz(i);n?.dialerEvents.increment({open:!0}),a.trace("dialing circuit address: %a",u);const h=s.getConnections(d);let f;h.length===0?(l?.(new oe("webrtc:dial-relay")),f=await o.dial(u,{signal:t,onProgress:l})):(l?.(new oe("webrtc:reuse-relay-connection")),f=h[0]),l?.(new oe("webrtc:open-signaling-stream"));const y=await f.newStream(h2,{signal:t,runOnLimitedConnection:!0}),m=Qt(y).pb(Qr),p=new Rv(r);p.addEventListener("connectionstatechange",()=>{switch(p.connectionState){case"closed":p.close();break}});const b=new b3({peerConnection:p,dataChannelOptions:e});try{const A=p.createDataChannel("init");p.onicecandidate=({candidate:R})=>{if(p.connectionState==="connected"){a.trace("ignore new ice candidate as peer connection is already connected");return}if(R==null||R?.candidate===""){a.trace("initiator detected end of ICE candidates");return}const L=JSON.stringify(R?.toJSON()??null);a.trace("initiator sending ICE candidate %o",R),m.write({type:Qr.Type.ICE_CANDIDATE,data:L},{signal:t}).catch(N=>{a.error("error sending ICE candidate - %e",N)})},p.onicecandidateerror=R=>{a.error("initiator ICE candidate error",R)};const v=await p.createOffer().catch(R=>{throw a.error("could not execute createOffer - %e",R),new Ai("Failed to set createOffer")});a.trace("initiator send SDP offer %s",v.sdp),l?.(new oe("webrtc:send-sdp-offer")),await m.write({type:Qr.Type.SDP_OFFER,data:v.sdp},{signal:t}),await p.setLocalDescription(v).catch(R=>{throw a.error("could not execute setLocalDescription - %e",R),new Ai("Failed to set localDescription")}),l?.(new oe("webrtc:read-sdp-answer")),a.trace("initiator read SDP answer");const C=await m.read({signal:t});if(C.type!==Qr.Type.SDP_ANSWER)throw new Ai("Remote should send an SDP answer");a.trace("initiator received SDP answer %s",C.data);const T=new Nv({type:"answer",sdp:C.data});return await p.setRemoteDescription(T).catch(R=>{throw a.error("could not execute setRemoteDescription - %e",R),new Ai("Failed to set remoteDescription")}),a.trace("initiator read candidates until connected"),l?.(new oe("webrtc:read-ice-candidates")),await Dv(p,m,{direction:"initiator",signal:t,log:a,onProgress:l}),a.trace("initiator connected"),A.readyState!=="open"&&(a.trace("wait for init channel to open"),await bt(A,"open",{signal:t})),a.trace("closing init channel"),A.close(),a.trace("waiting for init channel to close"),await bt(A,"close",{signal:t}),l?.(new oe("webrtc:close-signaling-stream")),a.trace("closing signaling channel"),await y.close({signal:t}),a.trace("initiator connected to remote address %s",i),{remoteAddress:i,peerConnection:p,muxerFactory:b}}catch(A){throw a.error("outgoing signaling error - %e",A),p.close(),y.abort(A),A}finally{p.onicecandidate=null,p.onicecandidateerror=null}}const p6=Ge(Xg.matchers[0],je(da));class v3 extends Qe{transportManager;shutdownController;events;constructor(e,t){super(),this.transportManager=e.transportManager,this.events=e.events,this.shutdownController=t.shutdownController,this.onTransportListening=this.onTransportListening.bind(this)}async listen(){this.events.addEventListener("transport:listening",this.onTransportListening)}onTransportListening(e){e.detail.getAddrs().filter(n=>p6.exactMatch(n)).map(n=>n.encapsulate("/webrtc")).length>0&&this.safeDispatchEvent("listening")}getAddrs(){return this.transportManager.getListeners().filter(e=>!(e instanceof v3)).map(e=>e.getAddrs().filter(t=>p6.exactMatch(t)).map(t=>t.encapsulate("/webrtc"))).flat()}updateAnnounceAddrs(){}async close(){this.events.removeEventListener("transport:listening",this.onTransportListening),this.shutdownController.abort(),queueMicrotask(()=>{this.safeDispatchEvent("close")})}}async function Fz(r,e,{peerConnection:t,signal:n,log:i}){i.trace("new inbound signaling stream");const s=Qt(r).pb(Qr);try{t.onicecandidate=({candidate:d})=>{if(t.connectionState==="connected"){i.trace("ignore new ice candidate as peer connection is already connected");return}if(d==null||d?.candidate===""){i.trace("recipient detected end of ICE candidates");return}const h=JSON.stringify(d?.toJSON()??null);i.trace("recipient sending ICE candidate %s",h),s.write({type:Qr.Type.ICE_CANDIDATE,data:h},{signal:n}).catch(f=>{i.error("error sending ICE candidate - %e",f)})},i.trace("recipient read SDP offer");const c=await s.read({signal:n});if(c.type!==Qr.Type.SDP_OFFER)throw new Ai(`expected message type SDP_OFFER, received: ${c.type??"undefined"} `);i.trace("recipient received SDP offer %s",c.data);const l=new Nv({type:"offer",sdp:c.data});await t.setRemoteDescription(l).catch(d=>{throw i.error("could not execute setRemoteDescription - %e",d),new Ai("Failed to set remoteDescription")});const u=await t.createAnswer().catch(d=>{throw i.error("could not execute createAnswer - %e",d),new Ai("Failed to create answer")});i.trace("recipient send SDP answer %s",u.sdp),await s.write({type:Qr.Type.SDP_ANSWER,data:u.sdp},{signal:n}),await t.setLocalDescription(u).catch(d=>{throw i.error("could not execute setLocalDescription - %e",d),new Ai("Failed to set localDescription")}),i.trace("recipient read candidates until connected"),await Dv(t,s,{direction:"recipient",signal:n,log:i})}catch(c){if(t.connectionState!=="connected")throw i.error("error while handling signaling stream from peer %a - %e",e.remoteAddr,c),t.close(),c;i("error while handling signaling stream from peer %a, ignoring as the RTCPeerConnection is already connected",e.remoteAddr,c)}const o=Bv(e.remoteAddr),a=be(`/webrtc/p2p/${o}`);return i.trace("recipient connected to remote address %s",a),{remoteAddress:a,remotePeer:o}}class Vz{components;init;log;_started=!1;metrics;shutdownController;constructor(e,t={}){this.components=e,this.init=t,this.log=e.logger.forComponent("libp2p:webrtc"),this.shutdownController=new AbortController,this.shutdownController.signal,e.metrics!=null&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_webrtc_dialer_events_total",{label:"event",help:"Total count of WebRTC dialer events by type"}),listenerEvents:e.metrics.registerCounterGroup("libp2p_webrtc_listener_events_total",{label:"event",help:"Total count of WebRTC listener events by type"})})}[$h]=!0;[Symbol.toStringTag]="@libp2p/webrtc";[It]=["@libp2p/transport"];[ws]=["@libp2p/identify","@libp2p/circuit-relay-v2-transport"];isStarted(){return this._started}async start(){await this.components.registrar.handle(h2,(e,t)=>{const n=this.components.upgrader.createInboundAbortSignal(this.shutdownController.signal);this._onProtocol(e,t,n).catch(i=>{this.log.error("failed to handle incoming connect from %p - %e",t.remotePeer,i)}).finally(()=>{n.clear()})},{runOnLimitedConnection:!0}),this._started=!0}async stop(){await this.components.registrar.unhandle(h2),this._started=!1}createListener(e){return new v3(this.components,{shutdownController:this.shutdownController})}listenFilter(e){return e.filter(F0.exactMatch)}dialFilter(e){return this.listenFilter(e)}async dial(e,t){this.log.trace("dialing address: %a",e);const{remoteAddress:n,peerConnection:i,muxerFactory:s}=await Uz({rtcConfiguration:await f6(this.init.rtcConfiguration),dataChannel:this.init.dataChannel,multiaddr:e,dataChannelOptions:this.init.dataChannel,signal:t.signal,connectionManager:this.components.connectionManager,transportManager:this.components.transportManager,log:this.log,logger:this.components.logger,onProgress:t.onProgress}),o=p2({peerConnection:i,remoteAddr:n,metrics:this.metrics?.dialerEvents,direction:"outbound",log:this.components.logger.forComponent("libp2p:webrtc:connection")}),a=await t.upgrader.upgradeOutbound(o,{skipProtection:!0,skipEncryption:!0,remotePeer:Bv(e),muxerFactory:s,onProgress:t.onProgress,signal:t.signal});return this._closeOnShutdown(i,o),a}async _onProtocol(e,t,n){const i=new Rv(await f6(this.init.rtcConfiguration));i.addEventListener("connectionstatechange",()=>{switch(i.connectionState){case"closed":i.close();break}});const s=new b3({peerConnection:i,dataChannelOptions:this.init.dataChannel});try{const{remoteAddress:o,remotePeer:a}=await Fz(e,t,{peerConnection:i,signal:n,log:this.log});await e.close({signal:n});const c=p2({peerConnection:i,remoteAddr:o,metrics:this.metrics?.listenerEvents,direction:"inbound",log:this.components.logger.forComponent("libp2p:webrtc:connection")});await this.components.upgrader.upgradeInbound(c,{skipEncryption:!0,skipProtection:!0,remotePeer:a,muxerFactory:s,signal:n}),this._closeOnShutdown(i,c)}catch(o){throw this.log.error("incoming signaling error - %e",o),i.close(),e.abort(o),o}}_closeOnShutdown(e,t){const n=()=>{t.close().catch(i=>{this.log.error("could not close WebRTCMultiaddrConnection - %e",i)})};this.shutdownController.signal.addEventListener("abort",n),e.addEventListener("close",()=>{this.shutdownController.signal.removeEventListener("abort",n)})}}function zz(r){const e=r.getComponents().filter(({name:n})=>n==="p2p").map(({value:n})=>n).pop();if(e==null)throw new H("Destination peer id was missing");return{circuitAddress:be(r.getComponents().filter(({name:n})=>n!=="webrtc")),targetPeer:or(e)}}var g6={};var m6;function Hz(){if(m6)return g6;m6=1;var r;return(function(e){(function(t){var n=typeof globalThis=="object"?globalThis:typeof b4=="object"?b4:typeof self=="object"?self:typeof this=="object"?this:c(),i=s(e);typeof n.Reflect<"u"&&(i=s(n.Reflect,i)),t(i,n),typeof n.Reflect>"u"&&(n.Reflect=e);function s(l,u){return function(d,h){Object.defineProperty(l,d,{configurable:!0,writable:!0,value:h}),u&&u(d,h)}}function o(){try{return Function("return this;")()}catch{}}function a(){try{return(0,eval)("(function() { return this; })()")}catch{}}function c(){return o()||a()}})(function(t,n){var i=Object.prototype.hasOwnProperty,s=typeof Symbol=="function",o=s&&typeof Symbol.toPrimitive<"u"?Symbol.toPrimitive:"@@toPrimitive",a=s&&typeof Symbol.iterator<"u"?Symbol.iterator:"@@iterator",c=typeof Object.create=="function",l={__proto__:[]}instanceof Array,u=!c&&!l,d={create:c?function(){return u1(Object.create(null))}:l?function(){return u1({__proto__:null})}:function(){return u1({})},has:u?function(P,D){return i.call(P,D)}:function(P,D){return D in P},get:u?function(P,D){return i.call(P,D)?P[D]:void 0}:function(P,D){return P[D]}},h=Object.getPrototypeOf(Function),f=typeof Map=="function"&&typeof Map.prototype.entries=="function"?Map:hS(),y=typeof Set=="function"&&typeof Set.prototype.entries=="function"?Set:fS(),m=typeof WeakMap=="function"?WeakMap:pS(),p=s?Symbol.for("@reflect-metadata:registry"):void 0,b=lS(),A=uS(b);function v(P,D,F,ee){if(X(F)){if(!Yi(P))throw new TypeError;if(!Ra(D))throw new TypeError;return I(P,D)}else{if(!Yi(P))throw new TypeError;if(!fe(D))throw new TypeError;if(!fe(ee)&&!X(ee)&&!Se(ee))throw new TypeError;return Se(ee)&&(ee=void 0),F=_t(F),k(P,D,F,ee)}}t("decorate",v);function C(P,D){function F(ee,ye){if(!fe(ee))throw new TypeError;if(!X(ye)&&!Yl(ye))throw new TypeError;M(P,D,ee,ye)}return F}t("metadata",C);function T(P,D,F,ee){if(!fe(F))throw new TypeError;return X(ee)||(ee=_t(ee)),M(P,D,F,ee)}t("defineMetadata",T);function R(P,D,F){if(!fe(D))throw new TypeError;return X(F)||(F=_t(F)),S(P,D,F)}t("hasMetadata",R);function L(P,D,F){if(!fe(D))throw new TypeError;return X(F)||(F=_t(F)),B(P,D,F)}t("hasOwnMetadata",L);function N(P,D,F){if(!fe(D))throw new TypeError;return X(F)||(F=_t(F)),U(P,D,F)}t("getMetadata",N);function E(P,D,F){if(!fe(D))throw new TypeError;return X(F)||(F=_t(F)),q(P,D,F)}t("getOwnMetadata",E);function O(P,D){if(!fe(P))throw new TypeError;return X(D)||(D=_t(D)),K(P,D)}t("getMetadataKeys",O);function V(P,D){if(!fe(P))throw new TypeError;return X(D)||(D=_t(D)),Q(P,D)}t("getOwnMetadataKeys",V);function $(P,D,F){if(!fe(D))throw new TypeError;if(X(F)||(F=_t(F)),!fe(D))throw new TypeError;X(F)||(F=_t(F));var ee=Na(D,F,!1);return X(ee)?!1:ee.OrdinaryDeleteMetadata(P,D,F)}t("deleteMetadata",$);function I(P,D){for(var F=P.length-1;F>=0;--F){var ee=P[F],ye=ee(D);if(!X(ye)&&!Se(ye)){if(!Ra(ye))throw new TypeError;D=ye}}return D}function k(P,D,F,ee){for(var ye=P.length-1;ye>=0;--ye){var dt=P[ye],vt=dt(D,F,ee);if(!X(vt)&&!Se(vt)){if(!fe(vt))throw new TypeError;ee=vt}}return ee}function S(P,D,F){var ee=B(P,D,F);if(ee)return!0;var ye=l1(D);return Se(ye)?!1:S(P,ye,F)}function B(P,D,F){var ee=Na(D,F,!1);return X(ee)?!1:De(ee.OrdinaryHasOwnMetadata(P,D,F))}function U(P,D,F){var ee=B(P,D,F);if(ee)return q(P,D,F);var ye=l1(D);if(!Se(ye))return U(P,ye,F)}function q(P,D,F){var ee=Na(D,F,!1);if(!X(ee))return ee.OrdinaryGetOwnMetadata(P,D,F)}function M(P,D,F,ee){var ye=Na(F,ee,!0);ye.OrdinaryDefineOwnMetadata(P,D,F,ee)}function K(P,D){var F=Q(P,D),ee=l1(P);if(ee===null)return F;var ye=K(ee,D);if(ye.length<=0)return F;if(F.length<=0)return ye;for(var dt=new y,vt=[],Ie=0,ne=F;Ie<ne.length;Ie++){var ce=ne[Ie],de=dt.has(ce);de||(dt.add(ce),vt.push(ce))}for(var he=0,Pe=ye;he<Pe.length;he++){var ce=Pe[he],de=dt.has(ce);de||(dt.add(ce),vt.push(ce))}return vt}function Q(P,D){var F=Na(P,D,!1);return F?F.OrdinaryOwnMetadataKeys(P,D):[]}function re(P){if(P===null)return 1;switch(typeof P){case"undefined":return 0;case"boolean":return 2;case"string":return 3;case"symbol":return 4;case"number":return 5;case"object":return P===null?1:6;default:return 6}}function X(P){return P===void 0}function Se(P){return P===null}function ve(P){return typeof P=="symbol"}function fe(P){return typeof P=="object"?P!==null:typeof P=="function"}function Fe(P,D){switch(re(P)){case 0:return P;case 1:return P;case 2:return P;case 3:return P;case 4:return P;case 5:return P}var F="string",ee=c4(P,o);if(ee!==void 0){var ye=ee.call(P,F);if(fe(ye))throw new TypeError;return ye}return ot(P)}function ot(P,D){var F,ee,ye;{var dt=P.toString;if(dn(dt)){var ee=dt.call(P);if(!fe(ee))return ee}var F=P.valueOf;if(dn(F)){var ee=F.call(P);if(!fe(ee))return ee}}throw new TypeError}function De(P){return!!P}function ut(P){return""+P}function _t(P){var D=Fe(P);return ve(D)?D:ut(D)}function Yi(P){return Array.isArray?Array.isArray(P):P instanceof Object?P instanceof Array:Object.prototype.toString.call(P)==="[object Array]"}function dn(P){return typeof P=="function"}function Ra(P){return typeof P=="function"}function Yl(P){switch(re(P)){case 3:return!0;case 4:return!0;default:return!1}}function Js(P,D){return P===D||P!==P&&D!==D}function c4(P,D){var F=P[D];if(F!=null){if(!dn(F))throw new TypeError;return F}}function l4(P){var D=c4(P,a);if(!dn(D))throw new TypeError;var F=D.call(P);if(!fe(F))throw new TypeError;return F}function u4(P){return P.value}function d4(P){var D=P.next();return D.done?!1:D}function h4(P){var D=P.return;D&&D.call(P)}function l1(P){var D=Object.getPrototypeOf(P);if(typeof P!="function"||P===h||D!==h)return D;var F=P.prototype,ee=F&&Object.getPrototypeOf(F);if(ee==null||ee===Object.prototype)return D;var ye=ee.constructor;return typeof ye!="function"||ye===P?D:ye}function cS(){var P;!X(p)&&typeof n.Reflect<"u"&&!(p in n.Reflect)&&typeof n.Reflect.defineMetadata=="function"&&(P=dS(n.Reflect));var D,F,ee,ye=new m,dt={registerProvider:vt,getProvider:ne,setProvider:de};return dt;function vt(he){if(!Object.isExtensible(dt))throw new Error("Cannot add provider to a frozen registry.");switch(!0){case P===he:break;case X(D):D=he;break;case D===he:break;case X(F):F=he;break;case F===he:break;default:ee===void 0&&(ee=new y),ee.add(he);break}}function Ie(he,Pe){if(!X(D)){if(D.isProviderFor(he,Pe))return D;if(!X(F)){if(F.isProviderFor(he,Pe))return D;if(!X(ee))for(var Xe=l4(ee);;){var ht=d4(Xe);if(!ht)return;var Fr=u4(ht);if(Fr.isProviderFor(he,Pe))return h4(Xe),Fr}}}if(!X(P)&&P.isProviderFor(he,Pe))return P}function ne(he,Pe){var Xe=ye.get(he),ht;return X(Xe)||(ht=Xe.get(Pe)),X(ht)&&(ht=Ie(he,Pe),X(ht)||(X(Xe)&&(Xe=new f,ye.set(he,Xe)),Xe.set(Pe,ht))),ht}function ce(he){if(X(he))throw new TypeError;return D===he||F===he||!X(ee)&&ee.has(he)}function de(he,Pe,Xe){if(!ce(Xe))throw new Error("Metadata provider not registered.");var ht=ne(he,Pe);if(ht!==Xe){if(!X(ht))return!1;var Fr=ye.get(he);X(Fr)&&(Fr=new f,ye.set(he,Fr)),Fr.set(Pe,Xe)}return!0}}function lS(){var P;return!X(p)&&fe(n.Reflect)&&Object.isExtensible(n.Reflect)&&(P=n.Reflect[p]),X(P)&&(P=cS()),!X(p)&&fe(n.Reflect)&&Object.isExtensible(n.Reflect)&&Object.defineProperty(n.Reflect,p,{enumerable:!1,configurable:!1,writable:!1,value:P}),P}function uS(P){var D=new m,F={isProviderFor:function(ce,de){var he=D.get(ce);return X(he)?!1:he.has(de)},OrdinaryDefineOwnMetadata:vt,OrdinaryHasOwnMetadata:ye,OrdinaryGetOwnMetadata:dt,OrdinaryOwnMetadataKeys:Ie,OrdinaryDeleteMetadata:ne};return b.registerProvider(F),F;function ee(ce,de,he){var Pe=D.get(ce),Xe=!1;if(X(Pe)){if(!he)return;Pe=new f,D.set(ce,Pe),Xe=!0}var ht=Pe.get(de);if(X(ht)){if(!he)return;if(ht=new f,Pe.set(de,ht),!P.setProvider(ce,de,F))throw Pe.delete(de),Xe&&D.delete(ce),new Error("Wrong provider for target.")}return ht}function ye(ce,de,he){var Pe=ee(de,he,!1);return X(Pe)?!1:De(Pe.has(ce))}function dt(ce,de,he){var Pe=ee(de,he,!1);if(!X(Pe))return Pe.get(ce)}function vt(ce,de,he,Pe){var Xe=ee(he,Pe,!0);Xe.set(ce,de)}function Ie(ce,de){var he=[],Pe=ee(ce,de,!1);if(X(Pe))return he;for(var Xe=Pe.keys(),ht=l4(Xe),Fr=0;;){var f4=d4(ht);if(!f4)return he.length=Fr,he;var gS=u4(f4);try{he[Fr]=gS}catch(mS){try{h4(ht)}finally{throw mS}}Fr++}}function ne(ce,de,he){var Pe=ee(de,he,!1);if(X(Pe)||!Pe.delete(ce))return!1;if(Pe.size===0){var Xe=D.get(de);X(Xe)||(Xe.delete(he),Xe.size===0&&D.delete(Xe))}return!0}}function dS(P){var D=P.defineMetadata,F=P.hasOwnMetadata,ee=P.getOwnMetadata,ye=P.getOwnMetadataKeys,dt=P.deleteMetadata,vt=new m,Ie={isProviderFor:function(ne,ce){var de=vt.get(ne);return!X(de)&&de.has(ce)?!0:ye(ne,ce).length?(X(de)&&(de=new y,vt.set(ne,de)),de.add(ce),!0):!1},OrdinaryDefineOwnMetadata:D,OrdinaryHasOwnMetadata:F,OrdinaryGetOwnMetadata:ee,OrdinaryOwnMetadataKeys:ye,OrdinaryDeleteMetadata:dt};return Ie}function Na(P,D,F){var ee=b.getProvider(P,D);if(!X(ee))return ee;if(F){if(b.setProvider(P,D,A))return A;throw new Error("Illegal state.")}}function hS(){var P={},D=[],F=(function(){function Ie(ne,ce,de){this._index=0,this._keys=ne,this._values=ce,this._selector=de}return Ie.prototype["@@iterator"]=function(){return this},Ie.prototype[a]=function(){return this},Ie.prototype.next=function(){var ne=this._index;if(ne>=0&&ne<this._keys.length){var ce=this._selector(this._keys[ne],this._values[ne]);return ne+1>=this._keys.length?(this._index=-1,this._keys=D,this._values=D):this._index++,{value:ce,done:!1}}return{value:void 0,done:!0}},Ie.prototype.throw=function(ne){throw this._index>=0&&(this._index=-1,this._keys=D,this._values=D),ne},Ie.prototype.return=function(ne){return this._index>=0&&(this._index=-1,this._keys=D,this._values=D),{value:ne,done:!0}},Ie})(),ee=(function(){function Ie(){this._keys=[],this._values=[],this._cacheKey=P,this._cacheIndex=-2}return Object.defineProperty(Ie.prototype,"size",{get:function(){return this._keys.length},enumerable:!0,configurable:!0}),Ie.prototype.has=function(ne){return this._find(ne,!1)>=0},Ie.prototype.get=function(ne){var ce=this._find(ne,!1);return ce>=0?this._values[ce]:void 0},Ie.prototype.set=function(ne,ce){var de=this._find(ne,!0);return this._values[de]=ce,this},Ie.prototype.delete=function(ne){var ce=this._find(ne,!1);if(ce>=0){for(var de=this._keys.length,he=ce+1;he<de;he++)this._keys[he-1]=this._keys[he],this._values[he-1]=this._values[he];return this._keys.length--,this._values.length--,Js(ne,this._cacheKey)&&(this._cacheKey=P,this._cacheIndex=-2),!0}return!1},Ie.prototype.clear=function(){this._keys.length=0,this._values.length=0,this._cacheKey=P,this._cacheIndex=-2},Ie.prototype.keys=function(){return new F(this._keys,this._values,ye)},Ie.prototype.values=function(){return new F(this._keys,this._values,dt)},Ie.prototype.entries=function(){return new F(this._keys,this._values,vt)},Ie.prototype["@@iterator"]=function(){return this.entries()},Ie.prototype[a]=function(){return this.entries()},Ie.prototype._find=function(ne,ce){if(!Js(this._cacheKey,ne)){this._cacheIndex=-1;for(var de=0;de<this._keys.length;de++)if(Js(this._keys[de],ne)){this._cacheIndex=de;break}}return this._cacheIndex<0&&ce&&(this._cacheIndex=this._keys.length,this._keys.push(ne),this._values.push(void 0)),this._cacheIndex},Ie})();return ee;function ye(Ie,ne){return Ie}function dt(Ie,ne){return ne}function vt(Ie,ne){return[Ie,ne]}}function fS(){var P=(function(){function D(){this._map=new f}return Object.defineProperty(D.prototype,"size",{get:function(){return this._map.size},enumerable:!0,configurable:!0}),D.prototype.has=function(F){return this._map.has(F)},D.prototype.add=function(F){return this._map.set(F,F),this},D.prototype.delete=function(F){return this._map.delete(F)},D.prototype.clear=function(){this._map.clear()},D.prototype.keys=function(){return this._map.keys()},D.prototype.values=function(){return this._map.keys()},D.prototype.entries=function(){return this._map.entries()},D.prototype["@@iterator"]=function(){return this.keys()},D.prototype[a]=function(){return this.keys()},D})();return P}function pS(){var P=16,D=d.create(),F=ee();return(function(){function ne(){this._key=ee()}return ne.prototype.has=function(ce){var de=ye(ce,!1);return de!==void 0?d.has(de,this._key):!1},ne.prototype.get=function(ce){var de=ye(ce,!1);return de!==void 0?d.get(de,this._key):void 0},ne.prototype.set=function(ce,de){var he=ye(ce,!0);return he[this._key]=de,this},ne.prototype.delete=function(ce){var de=ye(ce,!1);return de!==void 0?delete de[this._key]:!1},ne.prototype.clear=function(){this._key=ee()},ne})();function ee(){var ne;do ne="@@WeakMap@@"+Ie();while(d.has(D,ne));return D[ne]=!0,ne}function ye(ne,ce){if(!i.call(ne,F)){if(!ce)return;Object.defineProperty(ne,F,{value:d.create()})}return ne[F]}function dt(ne,ce){for(var de=0;de<ce;++de)ne[de]=Math.random()*255|0;return ne}function vt(ne){if(typeof Uint8Array=="function"){var ce=new Uint8Array(ne);return typeof crypto<"u"?crypto.getRandomValues(ce):typeof msCrypto<"u"?msCrypto.getRandomValues(ce):dt(ce,ne),ce}return dt(new Array(ne),ne)}function Ie(){var ne=vt(P);ne[6]=ne[6]&79|64,ne[8]=ne[8]&191|128;for(var ce="",de=0;de<P;++de){var he=ne[de];(de===4||de===6||de===8)&&(ce+="-"),he<16&&(ce+="0"),ce+=he.toString(16).toLowerCase()}return ce}}function u1(P){return P.__=void 0,delete P.__,P}})})(r||(r={})),g6}Hz();var z;(function(r){r[r.Sequence=0]="Sequence",r[r.Set=1]="Set",r[r.Choice=2]="Choice"})(z||(z={}));var x;(function(r){r[r.Any=1]="Any",r[r.Boolean=2]="Boolean",r[r.OctetString=3]="OctetString",r[r.BitString=4]="BitString",r[r.Integer=5]="Integer",r[r.Enumerated=6]="Enumerated",r[r.ObjectIdentifier=7]="ObjectIdentifier",r[r.Utf8String=8]="Utf8String",r[r.BmpString=9]="BmpString",r[r.UniversalString=10]="UniversalString",r[r.NumericString=11]="NumericString",r[r.PrintableString=12]="PrintableString",r[r.TeletexString=13]="TeletexString",r[r.VideotexString=14]="VideotexString",r[r.IA5String=15]="IA5String",r[r.GraphicString=16]="GraphicString",r[r.VisibleString=17]="VisibleString",r[r.GeneralString=18]="GeneralString",r[r.CharacterString=19]="CharacterString",r[r.UTCTime=20]="UTCTime",r[r.GeneralizedTime=21]="GeneralizedTime",r[r.DATE=22]="DATE",r[r.TimeOfDay=23]="TimeOfDay",r[r.DateTime=24]="DateTime",r[r.Duration=25]="Duration",r[r.TIME=26]="TIME",r[r.Null=27]="Null"})(x||(x={}));class Pf{constructor(e,t=0){if(this.unusedBits=0,this.value=new ArrayBuffer(0),e)if(typeof e=="number")this.fromNumber(e);else if(J.isBufferSource(e))this.unusedBits=t,this.value=J.toArrayBuffer(e);else throw TypeError("Unsupported type of 'params' argument for BitString")}fromASN(e){if(!(e instanceof ms))throw new TypeError("Argument 'asn' is not instance of ASN.1 BitString");return this.unusedBits=e.valueBlock.unusedBits,this.value=e.valueBlock.valueHex,this}toASN(){return new ms({unusedBits:this.unusedBits,valueHex:this.value})}toSchema(e){return new ms({name:e})}toNumber(){let e="";const t=new Uint8Array(this.value);for(const n of t)e+=n.toString(2).padStart(8,"0");return e=e.split("").reverse().join(""),this.unusedBits&&(e=e.slice(this.unusedBits).padStart(this.unusedBits,"0")),parseInt(e,2)}fromNumber(e){let t=e.toString(2);const n=t.length+7>>3;this.unusedBits=(n<<3)-t.length;const i=new Uint8Array(n);t=t.padStart(n<<3,"0").split("").reverse().join("");let s=0;for(;s<n;)i[s]=parseInt(t.slice(s<<3,(s<<3)+8),2),s++;this.value=i.buffer}}class Le{get byteLength(){return this.buffer.byteLength}get byteOffset(){return 0}constructor(e){typeof e=="number"?this.buffer=new ArrayBuffer(e):J.isBufferSource(e)?this.buffer=J.toArrayBuffer(e):Array.isArray(e)?this.buffer=new Uint8Array(e):this.buffer=new ArrayBuffer(0)}fromASN(e){if(!(e instanceof Yr))throw new TypeError("Argument 'asn' is not instance of ASN.1 OctetString");return this.buffer=e.valueBlock.valueHex,this}toASN(){return new Yr({valueHex:this.buffer})}toSchema(e){return new Yr({name:e})}}const qz={fromASN:r=>r instanceof Yn?null:r.valueBeforeDecodeView,toASN:r=>{if(r===null)return new Yn;const e=Kn(r);if(e.result.error)throw new Error(e.result.error);return e.result}},Kz={fromASN:r=>r.valueBlock.valueHexView.byteLength>=4?r.valueBlock.toString():r.valueBlock.valueDec,toASN:r=>new Wn({value:+r})},Wz={fromASN:r=>r.valueBlock.valueDec,toASN:r=>new df({value:r})},tt={fromASN:r=>r.valueBlock.valueHexView,toASN:r=>new Wn({valueHex:r})},jz={fromASN:r=>r.valueBlock.valueHexView,toASN:r=>new ms({valueHex:r})},Gz={fromASN:r=>r.valueBlock.toString(),toASN:r=>new Vn({value:r})},Yz={fromASN:r=>r.valueBlock.value,toASN:r=>new uf({value:r})},jd={fromASN:r=>r.valueBlock.valueHexView,toASN:r=>new Yr({valueHex:r})},Qz={fromASN:r=>new Le(r.getValue()),toASN:r=>r.toASN()};function Ur(r){return{fromASN:e=>e.valueBlock.value,toASN:e=>new r({value:e})}}const Lv=Ur(oi),Xz=Ur(hf),Zz=Ur(ff),Jz=Ur(pf),eH=Ur(gf),tH=Ur(mf),rH=Ur(yf),nH=Ur(wf),iH=Ur(bf),sH=Ur(Tl),oH=Ur(vf),aH=Ur(Ef),cH={fromASN:r=>r.toDate(),toASN:r=>new Pl({valueDate:r})},lH={fromASN:r=>r.toDate(),toASN:r=>new Sf({valueDate:r})},uH={fromASN:()=>null,toASN:()=>new Yn};function kc(r){switch(r){case x.Any:return qz;case x.BitString:return jz;case x.BmpString:return Xz;case x.Boolean:return Yz;case x.CharacterString:return aH;case x.Enumerated:return Wz;case x.GeneralString:return oH;case x.GeneralizedTime:return lH;case x.GraphicString:return iH;case x.IA5String:return nH;case x.Integer:return Kz;case x.Null:return uH;case x.NumericString:return Jz;case x.ObjectIdentifier:return Gz;case x.OctetString:return jd;case x.PrintableString:return eH;case x.TeletexString:return tH;case x.UTCTime:return cH;case x.UniversalString:return Zz;case x.Utf8String:return Lv;case x.VideotexString:return rH;case x.VisibleString:return sH;default:return null}}function Hn(r){return typeof r=="function"&&r.prototype?r.prototype.toASN&&r.prototype.fromASN?!0:Hn(r.prototype):!!(r&&typeof r=="object"&&"toASN"in r&&"fromASN"in r)}function Ov(r){var e;if(r){const t=Object.getPrototypeOf(r);return((e=t?.prototype)===null||e===void 0?void 0:e.constructor)===Array?!0:Ov(t)}return!1}function dH(r,e){if(!(r&&e)||r.byteLength!==e.byteLength)return!1;const t=new Uint8Array(r),n=new Uint8Array(e);for(let i=0;i<r.byteLength;i++)if(t[i]!==n[i])return!1;return!0}class hH{constructor(){this.items=new WeakMap}has(e){return this.items.has(e)}get(e,t=!1){const n=this.items.get(e);if(!n)throw new Error(`Cannot get schema for '${e.prototype.constructor.name}' target`);if(t&&!n.schema)throw new Error(`Schema '${e.prototype.constructor.name}' doesn't contain ASN.1 schema. Call 'AsnSchemaStorage.cache'.`);return n}cache(e){const t=this.get(e);t.schema||(t.schema=this.create(e,!0))}createDefault(e){const t={type:z.Sequence,items:{}},n=this.findParentSchema(e);return n&&(Object.assign(t,n),t.items=Object.assign({},t.items,n.items)),t}create(e,t){const n=this.items.get(e)||this.createDefault(e),i=[];for(const s in n.items){const o=n.items[s],a=t?s:"";let c;if(typeof o.type=="number"){const u=x[o.type],d=Ub[u];if(!d)throw new Error(`Cannot get ASN1 class by name '${u}'`);c=new d({name:a})}else Hn(o.type)?c=new o.type().toSchema(a):o.optional?this.get(o.type).type===z.Choice?c=new Cs({name:a}):(c=this.create(o.type,!1),c.name=a):c=new Cs({name:a});const l=!!o.optional||o.defaultValue!==void 0;if(o.repeated){c.name="";const u=o.repeated==="set"?kn:yt;c=new u({name:"",value:[new Bd({name:a,value:c})]})}if(o.context!==null&&o.context!==void 0)if(o.implicit)if(typeof o.type=="number"||Hn(o.type)){const u=o.repeated?nr:_l;i.push(new u({name:a,optional:l,idBlock:{tagClass:3,tagNumber:o.context}}))}else{this.cache(o.type);const u=!!o.repeated;let d=u?c:this.get(o.type,!0).schema;d="valueBlock"in d?d.valueBlock.value:d.value,i.push(new nr({name:u?"":a,optional:l,idBlock:{tagClass:3,tagNumber:o.context},value:d}))}else i.push(new nr({optional:l,idBlock:{tagClass:3,tagNumber:o.context},value:[c]}));else c.optional=l,i.push(c)}switch(n.type){case z.Sequence:return new yt({value:i,name:""});case z.Set:return new kn({value:i,name:""});case z.Choice:return new u3({value:i,name:""});default:throw new Error("Unsupported ASN1 type in use")}}set(e,t){return this.items.set(e,t),this}findParentSchema(e){const t=Object.getPrototypeOf(e);return t?this.items.get(t)||this.findParentSchema(t):null}}const Rt=new hH,j=r=>e=>{let t;Rt.has(e)?t=Rt.get(e):(t=Rt.createDefault(e),Rt.set(e,t)),Object.assign(t,r)},w=r=>(e,t)=>{let n;Rt.has(e.constructor)?n=Rt.get(e.constructor):(n=Rt.createDefault(e.constructor),Rt.set(e.constructor,n));const i=Object.assign({},r);if(typeof i.type=="number"&&!i.converter){const s=kc(r.type);if(!s)throw new Error(`Cannot get default converter for property '${t}' of ${e.constructor.name}`);i.converter=s}i.raw=r.raw,n.items[t]=i};class qa extends Error{constructor(){super(...arguments),this.schemas=[]}}class fH{static parse(e,t){const n=Kn(e);if(n.result.error)throw new Error(n.result.error);return this.fromASN(n.result,t)}static fromASN(e,t){try{if(Hn(t))return new t().fromASN(e);const n=Rt.get(t);Rt.cache(t);let i=n.schema;const s=this.handleChoiceTypes(e,n,t,i);if(s?.result)return s.result;s?.targetSchema&&(i=s.targetSchema);const o=this.handleSequenceTypes(e,n,t,i),a=new t;return Ov(t)?this.handleArrayTypes(e,n,t):(this.processSchemaItems(n,o,a),a)}catch(n){throw n instanceof qa&&n.schemas.push(t.name),n}}static handleChoiceTypes(e,t,n,i){if(e.constructor===nr&&t.type===z.Choice&&e.idBlock.tagClass===3)for(const s in t.items){const o=t.items[s];if(o.context===e.idBlock.tagNumber&&o.implicit&&typeof o.type=="function"&&Rt.has(o.type)){const a=Rt.get(o.type);if(a&&a.type===z.Sequence){const c=new yt;if("value"in e.valueBlock&&Array.isArray(e.valueBlock.value)&&"value"in c.valueBlock){c.valueBlock.value=e.valueBlock.value;const l=this.fromASN(c,o.type),u=new n;return u[s]=l,{result:u}}}}}else if(e.constructor===nr&&t.type!==z.Choice){const s=new nr({idBlock:{tagClass:3,tagNumber:e.idBlock.tagNumber},value:t.schema.valueBlock.value});for(const o in t.items)delete e[o];return{targetSchema:s}}return null}static handleSequenceTypes(e,t,n,i){if(t.type===z.Sequence){const s=xi({},e,i);if(!s.verified)throw new qa(`Data does not match to ${n.name} ASN1 schema.${s.result.error?` ${s.result.error}`:""}`);return s}else{const s=xi({},e,i);if(!s.verified)throw new qa(`Data does not match to ${n.name} ASN1 schema.${s.result.error?` ${s.result.error}`:""}`);return s}}static processRepeatedField(e,t,n){let i=e.slice(t);if(i.length===1&&i[0].constructor.name==="Sequence"){const s=i[0];s.valueBlock&&s.valueBlock.value&&Array.isArray(s.valueBlock.value)&&(i=s.valueBlock.value)}if(typeof n.type=="number"){const s=kc(n.type);if(!s)throw new Error(`No converter for ASN.1 type ${n.type}`);return i.filter(o=>o&&o.valueBlock).map(o=>{try{return s.fromASN(o)}catch{return}}).filter(o=>o!==void 0)}else return i.filter(s=>s&&s.valueBlock).map(s=>{try{return this.fromASN(s,n.type)}catch{return}}).filter(s=>s!==void 0)}static processPrimitiveField(e,t){const n=kc(t.type);if(!n)throw new Error(`No converter for ASN.1 type ${t.type}`);return n.fromASN(e)}static isOptionalChoiceField(e){return e.optional&&typeof e.type=="function"&&Rt.has(e.type)&&Rt.get(e.type).type===z.Choice}static processOptionalChoiceField(e,t){try{return{processed:!0,value:this.fromASN(e,t.type)}}catch(n){if(n instanceof qa&&/Wrong values for Choice type/.test(n.message))return{processed:!1};throw n}}static handleArrayTypes(e,t,n){if(!("value"in e.valueBlock&&Array.isArray(e.valueBlock.value)))throw new Error("Cannot get items from the ASN.1 parsed value. ASN.1 object is not constructed.");const i=t.itemType;if(typeof i=="number"){const s=kc(i);if(!s)throw new Error(`Cannot get default converter for array item of ${n.name} ASN1 schema`);return n.from(e.valueBlock.value,o=>s.fromASN(o))}else return n.from(e.valueBlock.value,s=>this.fromASN(s,i))}static processSchemaItems(e,t,n){for(const i in e.items){const s=t.result[i];if(!s)continue;const o=e.items[i],a=o.type;let c;typeof a=="number"||Hn(a)?c=this.processPrimitiveSchemaItem(s,o,a):c=this.processComplexSchemaItem(s,o,a),c&&typeof c=="object"&&"value"in c&&"raw"in c?(n[i]=c.value,n[`${i}Raw`]=c.raw):n[i]=c}}static processPrimitiveSchemaItem(e,t,n){var i;const s=(i=t.converter)!==null&&i!==void 0?i:Hn(n)?new n:null;if(!s)throw new Error("Converter is empty");return t.repeated?this.processRepeatedPrimitiveItem(e,t,s):this.processSinglePrimitiveItem(e,t,n,s)}static processRepeatedPrimitiveItem(e,t,n){if(t.implicit){const i=t.repeated==="sequence"?yt:kn,s=new i;s.valueBlock=e.valueBlock;const o=Kn(s.toBER(!1));if(o.offset===-1)throw new Error(`Cannot parse the child item. ${o.result.error}`);if(!("value"in o.result.valueBlock&&Array.isArray(o.result.valueBlock.value)))throw new Error("Cannot get items from the ASN.1 parsed value. ASN.1 object is not constructed.");const a=o.result.valueBlock.value;return Array.from(a,c=>n.fromASN(c))}else return Array.from(e,i=>n.fromASN(i))}static processSinglePrimitiveItem(e,t,n,i){let s=e;if(t.implicit){let o;if(Hn(n))o=new n().toSchema("");else{const a=x[n],c=Ub[a];if(!c)throw new Error(`Cannot get '${a}' class from asn1js module`);o=new c}o.valueBlock=s.valueBlock,s=Kn(o.toBER(!1)).result}return i.fromASN(s)}static processComplexSchemaItem(e,t,n){if(t.repeated){if(!Array.isArray(e))throw new Error("Cannot get list of items from the ASN.1 parsed value. ASN.1 value should be iterable.");return Array.from(e,i=>this.fromASN(i,n))}else{const i=this.handleImplicitTagging(e,t,n);if(this.isOptionalChoiceField(t))try{return this.fromASN(i,n)}catch(s){if(s instanceof qa&&/Wrong values for Choice type/.test(s.message))return;throw s}else{const s=this.fromASN(i,n);return t.raw?{value:s,raw:e.valueBeforeDecodeView}:s}}}static handleImplicitTagging(e,t,n){if(t.implicit&&typeof t.context=="number"){const i=Rt.get(n);if(i.type===z.Sequence){const s=new yt;if("value"in e.valueBlock&&Array.isArray(e.valueBlock.value)&&"value"in s.valueBlock)return s.valueBlock.value=e.valueBlock.value,s}else if(i.type===z.Set){const s=new kn;if("value"in e.valueBlock&&Array.isArray(e.valueBlock.value)&&"value"in s.valueBlock)return s.valueBlock.value=e.valueBlock.value,s}}return e}}class E3{static serialize(e){return e instanceof $t?e.toBER(!1):this.toASN(e).toBER(!1)}static toASN(e){if(e&&typeof e=="object"&&Hn(e))return e.toASN();if(!(e&&typeof e=="object"))throw new TypeError("Parameter 1 should be type of Object.");const t=e.constructor,n=Rt.get(t);Rt.cache(t);let i=[];if(n.itemType){if(!Array.isArray(e))throw new TypeError("Parameter 1 should be type of Array.");if(typeof n.itemType=="number"){const o=kc(n.itemType);if(!o)throw new Error(`Cannot get default converter for array item of ${t.name} ASN1 schema`);i=e.map(a=>o.toASN(a))}else i=e.map(o=>this.toAsnItem({type:n.itemType},"[]",t,o))}else for(const o in n.items){const a=n.items[o],c=e[o];if(c===void 0||a.defaultValue===c||typeof a.defaultValue=="object"&&typeof c=="object"&&dH(this.serialize(a.defaultValue),this.serialize(c)))continue;const l=E3.toAsnItem(a,o,t,c);if(typeof a.context=="number")if(a.implicit)if(!a.repeated&&(typeof a.type=="number"||Hn(a.type))){const u={};u.valueHex=l instanceof Yn?l.valueBeforeDecodeView:l.valueBlock.toBER(),i.push(new _l({optional:a.optional,idBlock:{tagClass:3,tagNumber:a.context},...u}))}else i.push(new nr({optional:a.optional,idBlock:{tagClass:3,tagNumber:a.context},value:l.valueBlock.value}));else i.push(new nr({optional:a.optional,idBlock:{tagClass:3,tagNumber:a.context},value:[l]}));else a.repeated?i=i.concat(l):i.push(l)}let s;switch(n.type){case z.Sequence:s=new yt({value:i});break;case z.Set:s=new kn({value:i});break;case z.Choice:if(!i[0])throw new Error(`Schema '${t.name}' has wrong data. Choice cannot be empty.`);s=i[0];break}return s}static toAsnItem(e,t,n,i){let s;if(typeof e.type=="number"){const o=e.converter;if(!o)throw new Error(`Property '${t}' doesn't have converter for type ${x[e.type]} in schema '${n.name}'`);if(e.repeated){if(!Array.isArray(i))throw new TypeError("Parameter 'objProp' should be type of Array.");const a=Array.from(i,l=>o.toASN(l)),c=e.repeated==="sequence"?yt:kn;s=new c({value:a})}else s=o.toASN(i)}else if(e.repeated){if(!Array.isArray(i))throw new TypeError("Parameter 'objProp' should be type of Array.");const o=Array.from(i,c=>this.toASN(c)),a=e.repeated==="sequence"?yt:kn;s=new a({value:o})}else s=this.toASN(i);return s}}class qe extends Array{constructor(e=[]){if(typeof e=="number")super(e);else{super();for(const t of e)this.push(t)}}}class Z{static serialize(e){return E3.serialize(e)}static parse(e,t){return fH.parse(e,t)}static toString(e){const t=J.isBufferSource(e)?J.toArrayBuffer(e):Z.serialize(e),n=Kn(t);if(n.offset===-1)throw new Error(`Cannot decode ASN.1 data. ${n.result.error}`);return n.result.toString()}}function g(r,e,t,n){var i=arguments.length,s=i<3?e:n===null?n=Object.getOwnPropertyDescriptor(e,t):n,o;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(r,e,t,n);else for(var a=r.length-1;a>=0;a--)(o=r[a])&&(s=(i<3?o(s):i>3?o(e,t,s):o(e,t))||s);return i>3&&s&&Object.defineProperty(e,t,s),s}function xe(r,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(r):n?n.value:e.get(r)}function nt(r,e,t,n,i){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!i)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!i:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?i.call(r,t):i?i.value=t:e.set(r,t),t}class y6{static isIPv4(e){return/^(\d{1,3}\.){3}\d{1,3}$/.test(e)}static parseIPv4(e){const t=e.split(".");if(t.length!==4)throw new Error("Invalid IPv4 address");return t.map(n=>{const i=parseInt(n,10);if(isNaN(i)||i<0||i>255)throw new Error("Invalid IPv4 address part");return i})}static parseIPv6(e){const n=this.expandIPv6(e).split(":");if(n.length!==8)throw new Error("Invalid IPv6 address");return n.reduce((i,s)=>{const o=parseInt(s,16);if(isNaN(o)||o<0||o>65535)throw new Error("Invalid IPv6 address part");return i.push(o>>8&255),i.push(o&255),i},[])}static expandIPv6(e){if(!e.includes("::"))return e;const t=e.split("::");if(t.length>2)throw new Error("Invalid IPv6 address");const n=t[0]?t[0].split(":"):[],i=t[1]?t[1].split(":"):[],s=8-(n.length+i.length);if(s<0)throw new Error("Invalid IPv6 address");return[...n,...Array(s).fill("0"),...i].join(":")}static formatIPv6(e){const t=[];for(let n=0;n<16;n+=2)t.push((e[n]<<8|e[n+1]).toString(16));return this.compressIPv6(t.join(":"))}static compressIPv6(e){const t=e.split(":");let n=-1,i=0,s=-1,o=0;for(let a=0;a<t.length;a++)t[a]==="0"?(s===-1&&(s=a),o++):(o>i&&(n=s,i=o),s=-1,o=0);if(o>i&&(n=s,i=o),i>1){const a=t.slice(0,n).join(":"),c=t.slice(n+i).join(":");return`${a}::${c}`}return e}static parseCIDR(e){const[t,n]=e.split("/"),i=parseInt(n,10);if(this.isIPv4(t)){if(i<0||i>32)throw new Error("Invalid IPv4 prefix length");return[this.parseIPv4(t),i]}else{if(i<0||i>128)throw new Error("Invalid IPv6 prefix length");return[this.parseIPv6(t),i]}}static decodeIP(e){if(e.length===64&&parseInt(e,16)===0)return"::/0";if(e.length!==16)return e;const t=parseInt(e.slice(8),16).toString(2).split("").reduce((i,s)=>i+ +s,0);let n=e.slice(0,8).replace(/(.{2})/g,i=>`${parseInt(i,16)}.`);return n=n.slice(0,-1),`${n}/${t}`}static toString(e){const t=new Uint8Array(e);if(t.length===4)return Array.from(t).join(".");if(t.length===16)return this.formatIPv6(t);if(t.length===8||t.length===32){const n=t.length/2,i=t.slice(0,n),s=t.slice(n);if(t.every(c=>c===0))return t.length===8?"0.0.0.0/0":"::/0";const a=s.reduce((c,l)=>c+(l.toString(2).match(/1/g)||[]).length,0);return t.length===8?`${Array.from(i).join(".")}/${a}`:`${this.formatIPv6(i)}/${a}`}return this.decodeIP(ue.ToHex(e))}static fromString(e){if(e.includes("/")){const[n,i]=this.parseCIDR(e),s=new Uint8Array(n.length);let o=i;for(let c=0;c<s.length;c++)o>=8?(s[c]=255,o-=8):o>0&&(s[c]=255<<8-o,o=0);const a=new Uint8Array(n.length*2);return a.set(n,0),a.set(s,n.length),a.buffer}const t=this.isIPv4(e)?this.parseIPv4(e):this.parseIPv6(e);return new Uint8Array(t).buffer}}var g2,m2,y2;let Ut=class{constructor(e={}){Object.assign(this,e)}toString(){return this.bmpString||this.printableString||this.teletexString||this.universalString||this.utf8String||""}};g([w({type:x.TeletexString})],Ut.prototype,"teletexString",void 0);g([w({type:x.PrintableString})],Ut.prototype,"printableString",void 0);g([w({type:x.UniversalString})],Ut.prototype,"universalString",void 0);g([w({type:x.Utf8String})],Ut.prototype,"utf8String",void 0);g([w({type:x.BmpString})],Ut.prototype,"bmpString",void 0);Ut=g([j({type:z.Choice})],Ut);let Xo=class extends Ut{constructor(e={}){super(e),Object.assign(this,e)}toString(){return this.ia5String||(this.anyValue?ue.ToHex(this.anyValue):super.toString())}};g([w({type:x.IA5String})],Xo.prototype,"ia5String",void 0);g([w({type:x.Any})],Xo.prototype,"anyValue",void 0);Xo=g([j({type:z.Choice})],Xo);class Rf{constructor(e={}){this.type="",this.value=new Xo,Object.assign(this,e)}}g([w({type:x.ObjectIdentifier})],Rf.prototype,"type",void 0);g([w({type:Xo})],Rf.prototype,"value",void 0);let Zo=g2=class extends qe{constructor(e){super(e),Object.setPrototypeOf(this,g2.prototype)}};Zo=g2=g([j({type:z.Set,itemType:Rf})],Zo);let w2=m2=class extends qe{constructor(e){super(e),Object.setPrototypeOf(this,m2.prototype)}};w2=m2=g([j({type:z.Sequence,itemType:Zo})],w2);let ft=y2=class extends w2{constructor(e){super(e),Object.setPrototypeOf(this,y2.prototype)}};ft=y2=g([j({type:z.Sequence})],ft);const pH={fromASN:r=>y6.toString(jd.fromASN(r)),toASN:r=>jd.toASN(y6.fromString(r))};class rl{constructor(e={}){this.typeId="",this.value=new ArrayBuffer(0),Object.assign(this,e)}}g([w({type:x.ObjectIdentifier})],rl.prototype,"typeId",void 0);g([w({type:x.Any,context:0})],rl.prototype,"value",void 0);class S3{constructor(e={}){this.partyName=new Ut,Object.assign(this,e)}}g([w({type:Ut,optional:!0,context:0,implicit:!0})],S3.prototype,"nameAssigner",void 0);g([w({type:Ut,context:1,implicit:!0})],S3.prototype,"partyName",void 0);let Ee=class{constructor(e={}){Object.assign(this,e)}};g([w({type:rl,context:0,implicit:!0})],Ee.prototype,"otherName",void 0);g([w({type:x.IA5String,context:1,implicit:!0})],Ee.prototype,"rfc822Name",void 0);g([w({type:x.IA5String,context:2,implicit:!0})],Ee.prototype,"dNSName",void 0);g([w({type:x.Any,context:3,implicit:!0})],Ee.prototype,"x400Address",void 0);g([w({type:ft,context:4,implicit:!1})],Ee.prototype,"directoryName",void 0);g([w({type:S3,context:5})],Ee.prototype,"ediPartyName",void 0);g([w({type:x.IA5String,context:6,implicit:!0})],Ee.prototype,"uniformResourceIdentifier",void 0);g([w({type:x.OctetString,context:7,implicit:!0,converter:pH})],Ee.prototype,"iPAddress",void 0);g([w({type:x.ObjectIdentifier,context:8,implicit:!0})],Ee.prototype,"registeredID",void 0);Ee=g([j({type:z.Choice})],Ee);const x3="1.3.6.1.5.5.7",gH=`${x3}.1`,va=`${x3}.3`,Nf=`${x3}.48`,w6=`${Nf}.1`,b6=`${Nf}.2`,v6=`${Nf}.3`,E6=`${Nf}.5`,ai="2.5.29";var b2;const v2=`${gH}.1`;class Dl{constructor(e={}){this.accessMethod="",this.accessLocation=new Ee,Object.assign(this,e)}}g([w({type:x.ObjectIdentifier})],Dl.prototype,"accessMethod",void 0);g([w({type:Ee})],Dl.prototype,"accessLocation",void 0);let wo=b2=class extends qe{constructor(e){super(e),Object.setPrototypeOf(this,b2.prototype)}};wo=b2=g([j({type:z.Sequence,itemType:Dl})],wo);const E2=`${ai}.35`;class A3 extends Le{}class us{constructor(e={}){e&&Object.assign(this,e)}}g([w({type:A3,context:0,optional:!0,implicit:!0})],us.prototype,"keyIdentifier",void 0);g([w({type:Ee,context:1,optional:!0,implicit:!0,repeated:"sequence"})],us.prototype,"authorityCertIssuer",void 0);g([w({type:x.Integer,context:2,optional:!0,implicit:!0,converter:tt})],us.prototype,"authorityCertSerialNumber",void 0);const Mv=`${ai}.19`;class Gd{constructor(e={}){this.cA=!1,Object.assign(this,e)}}g([w({type:x.Boolean,defaultValue:!1})],Gd.prototype,"cA",void 0);g([w({type:x.Integer,optional:!0})],Gd.prototype,"pathLenConstraint",void 0);var S2;let Gt=S2=class extends qe{constructor(e){super(e),Object.setPrototypeOf(this,S2.prototype)}};Gt=S2=g([j({type:z.Sequence,itemType:Ee})],Gt);var x2;let S6=x2=class extends Gt{constructor(e){super(e),Object.setPrototypeOf(this,x2.prototype)}};S6=x2=g([j({type:z.Sequence})],S6);var A2;const $v=`${ai}.32`;let Xn=class{constructor(e={}){Object.assign(this,e)}toString(){return this.ia5String||this.visibleString||this.bmpString||this.utf8String||""}};g([w({type:x.IA5String})],Xn.prototype,"ia5String",void 0);g([w({type:x.VisibleString})],Xn.prototype,"visibleString",void 0);g([w({type:x.BmpString})],Xn.prototype,"bmpString",void 0);g([w({type:x.Utf8String})],Xn.prototype,"utf8String",void 0);Xn=g([j({type:z.Choice})],Xn);class k3{constructor(e={}){this.organization=new Xn,this.noticeNumbers=[],Object.assign(this,e)}}g([w({type:Xn})],k3.prototype,"organization",void 0);g([w({type:x.Integer,repeated:"sequence"})],k3.prototype,"noticeNumbers",void 0);class C3{constructor(e={}){Object.assign(this,e)}}g([w({type:k3,optional:!0})],C3.prototype,"noticeRef",void 0);g([w({type:Xn,optional:!0})],C3.prototype,"explicitText",void 0);let Yd=class{constructor(e={}){Object.assign(this,e)}};g([w({type:x.IA5String})],Yd.prototype,"cPSuri",void 0);g([w({type:C3})],Yd.prototype,"userNotice",void 0);Yd=g([j({type:z.Choice})],Yd);class I3{constructor(e={}){this.policyQualifierId="",this.qualifier=new ArrayBuffer(0),Object.assign(this,e)}}g([w({type:x.ObjectIdentifier})],I3.prototype,"policyQualifierId",void 0);g([w({type:x.Any})],I3.prototype,"qualifier",void 0);class Df{constructor(e={}){this.policyIdentifier="",Object.assign(this,e)}}g([w({type:x.ObjectIdentifier})],Df.prototype,"policyIdentifier",void 0);g([w({type:I3,repeated:"sequence",optional:!0})],Df.prototype,"policyQualifiers",void 0);let Qd=A2=class extends qe{constructor(e){super(e),Object.setPrototypeOf(this,A2.prototype)}};Qd=A2=g([j({type:z.Sequence,itemType:Df})],Qd);let Xd=class{constructor(e=0){this.value=e}};g([w({type:x.Integer})],Xd.prototype,"value",void 0);Xd=g([j({type:z.Choice})],Xd);let x6=class extends Xd{};x6=g([j({type:z.Choice})],x6);var k2;const C2=`${ai}.31`;var Wr;(function(r){r[r.unused=1]="unused",r[r.keyCompromise=2]="keyCompromise",r[r.cACompromise=4]="cACompromise",r[r.affiliationChanged=8]="affiliationChanged",r[r.superseded=16]="superseded",r[r.cessationOfOperation=32]="cessationOfOperation",r[r.certificateHold=64]="certificateHold",r[r.privilegeWithdrawn=128]="privilegeWithdrawn",r[r.aACompromise=256]="aACompromise"})(Wr||(Wr={}));class Uv extends Pf{toJSON(){const e=[],t=this.toNumber();return t&Wr.aACompromise&&e.push("aACompromise"),t&Wr.affiliationChanged&&e.push("affiliationChanged"),t&Wr.cACompromise&&e.push("cACompromise"),t&Wr.certificateHold&&e.push("certificateHold"),t&Wr.cessationOfOperation&&e.push("cessationOfOperation"),t&Wr.keyCompromise&&e.push("keyCompromise"),t&Wr.privilegeWithdrawn&&e.push("privilegeWithdrawn"),t&Wr.superseded&&e.push("superseded"),t&Wr.unused&&e.push("unused"),e}toString(){return`[${this.toJSON().join(", ")}]`}}let Is=class{constructor(e={}){Object.assign(this,e)}};g([w({type:Ee,context:0,repeated:"sequence",implicit:!0})],Is.prototype,"fullName",void 0);g([w({type:Zo,context:1,implicit:!0})],Is.prototype,"nameRelativeToCRLIssuer",void 0);Is=g([j({type:z.Choice})],Is);class Ea{constructor(e={}){Object.assign(this,e)}}g([w({type:Is,context:0,optional:!0})],Ea.prototype,"distributionPoint",void 0);g([w({type:Uv,context:1,optional:!0,implicit:!0})],Ea.prototype,"reasons",void 0);g([w({type:Ee,context:2,optional:!0,repeated:"sequence",implicit:!0})],Ea.prototype,"cRLIssuer",void 0);let To=k2=class extends qe{constructor(e){super(e),Object.setPrototypeOf(this,k2.prototype)}};To=k2=g([j({type:z.Sequence,itemType:Ea})],To);var I2;let A6=I2=class extends To{constructor(e){super(e),Object.setPrototypeOf(this,I2.prototype)}};A6=I2=g([j({type:z.Sequence,itemType:Ea})],A6);class jt{constructor(e={}){this.onlyContainsUserCerts=jt.ONLY,this.onlyContainsCACerts=jt.ONLY,this.indirectCRL=jt.ONLY,this.onlyContainsAttributeCerts=jt.ONLY,Object.assign(this,e)}}jt.ONLY=!1;g([w({type:Is,context:0,optional:!0})],jt.prototype,"distributionPoint",void 0);g([w({type:x.Boolean,context:1,defaultValue:jt.ONLY,implicit:!0})],jt.prototype,"onlyContainsUserCerts",void 0);g([w({type:x.Boolean,context:2,defaultValue:jt.ONLY,implicit:!0})],jt.prototype,"onlyContainsCACerts",void 0);g([w({type:Uv,context:3,optional:!0,implicit:!0})],jt.prototype,"onlySomeReasons",void 0);g([w({type:x.Boolean,context:4,defaultValue:jt.ONLY,implicit:!0})],jt.prototype,"indirectCRL",void 0);g([w({type:x.Boolean,context:5,defaultValue:jt.ONLY,implicit:!0})],jt.prototype,"onlyContainsAttributeCerts",void 0);var Cc;(function(r){r[r.unspecified=0]="unspecified",r[r.keyCompromise=1]="keyCompromise",r[r.cACompromise=2]="cACompromise",r[r.affiliationChanged=3]="affiliationChanged",r[r.superseded=4]="superseded",r[r.cessationOfOperation=5]="cessationOfOperation",r[r.certificateHold=6]="certificateHold",r[r.removeFromCRL=8]="removeFromCRL",r[r.privilegeWithdrawn=9]="privilegeWithdrawn",r[r.aACompromise=10]="aACompromise"})(Cc||(Cc={}));let _2=class{constructor(e=Cc.unspecified){this.reason=Cc.unspecified,this.reason=e}toJSON(){return Cc[this.reason]}toString(){return this.toJSON()}};g([w({type:x.Enumerated})],_2.prototype,"reason",void 0);_2=g([j({type:z.Choice})],_2);var T2;const Fv=`${ai}.37`;let Zd=T2=class extends qe{constructor(e){super(e),Object.setPrototypeOf(this,T2.prototype)}};Zd=T2=g([j({type:z.Sequence,itemType:x.ObjectIdentifier})],Zd);const mH=`${va}.1`,yH=`${va}.2`,wH=`${va}.3`,bH=`${va}.4`,vH=`${va}.8`,EH=`${va}.9`;let P2=class{constructor(e=new ArrayBuffer(0)){this.value=e}};g([w({type:x.Integer,converter:tt})],P2.prototype,"value",void 0);P2=g([j({type:z.Choice})],P2);let R2=class{constructor(e){this.value=new Date,e&&(this.value=e)}};g([w({type:x.GeneralizedTime})],R2.prototype,"value",void 0);R2=g([j({type:z.Choice})],R2);var N2;const Vv=`${ai}.18`;let k6=N2=class extends Gt{constructor(e){super(e),Object.setPrototypeOf(this,N2.prototype)}};k6=N2=g([j({type:z.Sequence})],k6);const zv=`${ai}.15`;var jr;(function(r){r[r.digitalSignature=1]="digitalSignature",r[r.nonRepudiation=2]="nonRepudiation",r[r.keyEncipherment=4]="keyEncipherment",r[r.dataEncipherment=8]="dataEncipherment",r[r.keyAgreement=16]="keyAgreement",r[r.keyCertSign=32]="keyCertSign",r[r.cRLSign=64]="cRLSign",r[r.encipherOnly=128]="encipherOnly",r[r.decipherOnly=256]="decipherOnly"})(jr||(jr={}));class e0 extends Pf{toJSON(){const e=this.toNumber(),t=[];return e&jr.cRLSign&&t.push("crlSign"),e&jr.dataEncipherment&&t.push("dataEncipherment"),e&jr.decipherOnly&&t.push("decipherOnly"),e&jr.digitalSignature&&t.push("digitalSignature"),e&jr.encipherOnly&&t.push("encipherOnly"),e&jr.keyAgreement&&t.push("keyAgreement"),e&jr.keyCertSign&&t.push("keyCertSign"),e&jr.keyEncipherment&&t.push("keyEncipherment"),e&jr.nonRepudiation&&t.push("nonRepudiation"),t}toString(){return`[${this.toJSON().join(", ")}]`}}var D2;class Bf{constructor(e={}){this.base=new Ee,this.minimum=0,Object.assign(this,e)}}g([w({type:Ee})],Bf.prototype,"base",void 0);g([w({type:x.Integer,context:0,defaultValue:0,implicit:!0})],Bf.prototype,"minimum",void 0);g([w({type:x.Integer,context:1,optional:!0,implicit:!0})],Bf.prototype,"maximum",void 0);let Jd=D2=class extends qe{constructor(e){super(e),Object.setPrototypeOf(this,D2.prototype)}};Jd=D2=g([j({type:z.Sequence,itemType:Bf})],Jd);class Hv{constructor(e={}){Object.assign(this,e)}}g([w({type:Jd,context:0,optional:!0,implicit:!0})],Hv.prototype,"permittedSubtrees",void 0);g([w({type:Jd,context:1,optional:!0,implicit:!0})],Hv.prototype,"excludedSubtrees",void 0);class qv{constructor(e={}){Object.assign(this,e)}}g([w({type:x.Integer,context:0,implicit:!0,optional:!0,converter:tt})],qv.prototype,"requireExplicitPolicy",void 0);g([w({type:x.Integer,context:1,implicit:!0,optional:!0,converter:tt})],qv.prototype,"inhibitPolicyMapping",void 0);var B2;class _3{constructor(e={}){this.issuerDomainPolicy="",this.subjectDomainPolicy="",Object.assign(this,e)}}g([w({type:x.ObjectIdentifier})],_3.prototype,"issuerDomainPolicy",void 0);g([w({type:x.ObjectIdentifier})],_3.prototype,"subjectDomainPolicy",void 0);let C6=B2=class extends qe{constructor(e){super(e),Object.setPrototypeOf(this,B2.prototype)}};C6=B2=g([j({type:z.Sequence,itemType:_3})],C6);var L2;const Kv=`${ai}.17`;let O2=L2=class extends Gt{constructor(e){super(e),Object.setPrototypeOf(this,L2.prototype)}};O2=L2=g([j({type:z.Sequence})],O2);let Zn=class{constructor(e={}){this.type="",this.values=[],Object.assign(this,e)}};g([w({type:x.ObjectIdentifier})],Zn.prototype,"type",void 0);g([w({type:x.Any,repeated:"set"})],Zn.prototype,"values",void 0);var M2;let I6=M2=class extends qe{constructor(e){super(e),Object.setPrototypeOf(this,M2.prototype)}};I6=M2=g([j({type:z.Sequence,itemType:Zn})],I6);const Wv=`${ai}.14`;class Di extends A3{}class jv{constructor(e={}){Object.assign(this,e)}}g([w({type:x.GeneralizedTime,context:0,implicit:!0,optional:!0})],jv.prototype,"notBefore",void 0);g([w({type:x.GeneralizedTime,context:1,implicit:!0,optional:!0})],jv.prototype,"notAfter",void 0);var Ic;(function(r){r[r.keyUpdateAllowed=1]="keyUpdateAllowed",r[r.newExtensions=2]="newExtensions",r[r.pKIXCertificate=4]="pKIXCertificate"})(Ic||(Ic={}));class Gv extends Pf{toJSON(){const e=[],t=this.toNumber();return t&Ic.pKIXCertificate&&e.push("pKIXCertificate"),t&Ic.newExtensions&&e.push("newExtensions"),t&Ic.keyUpdateAllowed&&e.push("keyUpdateAllowed"),e}toString(){return`[${this.toJSON().join(", ")}]`}}class Yv{constructor(e={}){this.entrustVers="",this.entrustInfoFlags=new Gv,Object.assign(this,e)}}g([w({type:x.GeneralString})],Yv.prototype,"entrustVers",void 0);g([w({type:Gv})],Yv.prototype,"entrustInfoFlags",void 0);var $2;let _6=$2=class extends qe{constructor(e){super(e),Object.setPrototypeOf(this,$2.prototype)}};_6=$2=g([j({type:z.Sequence,itemType:Dl})],_6);class ie{constructor(e={}){this.algorithm="",Object.assign(this,e)}isEqual(e){return e instanceof ie&&e.algorithm==this.algorithm&&(e.parameters&&this.parameters&&H9(e.parameters,this.parameters)||e.parameters===this.parameters)}}g([w({type:x.ObjectIdentifier})],ie.prototype,"algorithm",void 0);g([w({type:x.Any,optional:!0})],ie.prototype,"parameters",void 0);class Xr{constructor(e={}){this.algorithm=new ie,this.subjectPublicKey=new ArrayBuffer(0),Object.assign(this,e)}}g([w({type:ie})],Xr.prototype,"algorithm",void 0);g([w({type:x.BitString})],Xr.prototype,"subjectPublicKey",void 0);let Dt=class{constructor(e){if(e)if(typeof e=="string"||typeof e=="number"||e instanceof Date){const t=new Date(e);t.getUTCFullYear()>2049?this.generalTime=t:this.utcTime=t}else Object.assign(this,e)}getTime(){const e=this.utcTime||this.generalTime;if(!e)throw new Error("Cannot get time from CHOICE object");return e}};g([w({type:x.UTCTime})],Dt.prototype,"utcTime",void 0);g([w({type:x.GeneralizedTime})],Dt.prototype,"generalTime",void 0);Dt=g([j({type:z.Choice})],Dt);class Bl{constructor(e){this.notBefore=new Dt(new Date),this.notAfter=new Dt(new Date),e&&(this.notBefore=new Dt(e.notBefore),this.notAfter=new Dt(e.notAfter))}}g([w({type:Dt})],Bl.prototype,"notBefore",void 0);g([w({type:Dt})],Bl.prototype,"notAfter",void 0);var U2;let Mr=class Qv{constructor(e={}){this.extnID="",this.critical=Qv.CRITICAL,this.extnValue=new Le,Object.assign(this,e)}};Mr.CRITICAL=!1;g([w({type:x.ObjectIdentifier})],Mr.prototype,"extnID",void 0);g([w({type:x.Boolean,defaultValue:Mr.CRITICAL})],Mr.prototype,"critical",void 0);g([w({type:Le})],Mr.prototype,"extnValue",void 0);let Vi=U2=class extends qe{constructor(e){super(e),Object.setPrototypeOf(this,U2.prototype)}};Vi=U2=g([j({type:z.Sequence,itemType:Mr})],Vi);var _s;(function(r){r[r.v1=0]="v1",r[r.v2=1]="v2",r[r.v3=2]="v3"})(_s||(_s={}));class Ir{constructor(e={}){this.version=_s.v1,this.serialNumber=new ArrayBuffer(0),this.signature=new ie,this.issuer=new ft,this.validity=new Bl,this.subject=new ft,this.subjectPublicKeyInfo=new Xr,Object.assign(this,e)}}g([w({type:x.Integer,context:0,defaultValue:_s.v1})],Ir.prototype,"version",void 0);g([w({type:x.Integer,converter:tt})],Ir.prototype,"serialNumber",void 0);g([w({type:ie})],Ir.prototype,"signature",void 0);g([w({type:ft})],Ir.prototype,"issuer",void 0);g([w({type:Bl})],Ir.prototype,"validity",void 0);g([w({type:ft})],Ir.prototype,"subject",void 0);g([w({type:Xr})],Ir.prototype,"subjectPublicKeyInfo",void 0);g([w({type:x.BitString,context:1,implicit:!0,optional:!0})],Ir.prototype,"issuerUniqueID",void 0);g([w({type:x.BitString,context:2,implicit:!0,optional:!0})],Ir.prototype,"subjectUniqueID",void 0);g([w({type:Vi,context:3,optional:!0})],Ir.prototype,"extensions",void 0);class Ts{constructor(e={}){this.tbsCertificate=new Ir,this.signatureAlgorithm=new ie,this.signatureValue=new ArrayBuffer(0),Object.assign(this,e)}}g([w({type:Ir,raw:!0})],Ts.prototype,"tbsCertificate",void 0);g([w({type:ie})],Ts.prototype,"signatureAlgorithm",void 0);g([w({type:x.BitString})],Ts.prototype,"signatureValue",void 0);class Lf{constructor(e={}){this.userCertificate=new ArrayBuffer(0),this.revocationDate=new Dt,Object.assign(this,e)}}g([w({type:x.Integer,converter:tt})],Lf.prototype,"userCertificate",void 0);g([w({type:Dt})],Lf.prototype,"revocationDate",void 0);g([w({type:Mr,optional:!0,repeated:"sequence"})],Lf.prototype,"crlEntryExtensions",void 0);class ci{constructor(e={}){this.signature=new ie,this.issuer=new ft,this.thisUpdate=new Dt,Object.assign(this,e)}}g([w({type:x.Integer,optional:!0})],ci.prototype,"version",void 0);g([w({type:ie})],ci.prototype,"signature",void 0);g([w({type:ft})],ci.prototype,"issuer",void 0);g([w({type:Dt})],ci.prototype,"thisUpdate",void 0);g([w({type:Dt,optional:!0})],ci.prototype,"nextUpdate",void 0);g([w({type:Lf,repeated:"sequence",optional:!0})],ci.prototype,"revokedCertificates",void 0);g([w({type:Mr,optional:!0,context:0,repeated:"sequence"})],ci.prototype,"crlExtensions",void 0);class T3{constructor(e={}){this.tbsCertList=new ci,this.signatureAlgorithm=new ie,this.signature=new ArrayBuffer(0),Object.assign(this,e)}}g([w({type:ci,raw:!0})],T3.prototype,"tbsCertList",void 0);g([w({type:ie})],T3.prototype,"signatureAlgorithm",void 0);g([w({type:x.BitString})],T3.prototype,"signature",void 0);class Sa{constructor(e={}){this.issuer=new ft,this.serialNumber=new ArrayBuffer(0),Object.assign(this,e)}}g([w({type:ft})],Sa.prototype,"issuer",void 0);g([w({type:x.Integer,converter:tt})],Sa.prototype,"serialNumber",void 0);let Jo=class{constructor(e={}){Object.assign(this,e)}};g([w({type:Di,context:0,implicit:!0})],Jo.prototype,"subjectKeyIdentifier",void 0);g([w({type:Sa})],Jo.prototype,"issuerAndSerialNumber",void 0);Jo=g([j({type:z.Choice})],Jo);var Jn;(function(r){r[r.v0=0]="v0",r[r.v1=1]="v1",r[r.v2=2]="v2",r[r.v3=3]="v3",r[r.v4=4]="v4",r[r.v5=5]="v5"})(Jn||(Jn={}));let nl=class extends ie{};nl=g([j({type:z.Sequence})],nl);let eh=class extends ie{};eh=g([j({type:z.Sequence})],eh);let Tn=class extends ie{};Tn=g([j({type:z.Sequence})],Tn);let th=class extends ie{};th=g([j({type:z.Sequence})],th);let T6=class extends ie{};T6=g([j({type:z.Sequence})],T6);let F2=class extends ie{};F2=g([j({type:z.Sequence})],F2);let xa=class{constructor(e={}){this.attrType="",this.attrValues=[],Object.assign(this,e)}};g([w({type:x.ObjectIdentifier})],xa.prototype,"attrType",void 0);g([w({type:x.Any,repeated:"set"})],xa.prototype,"attrValues",void 0);var V2;class Bn{constructor(e={}){this.version=Jn.v0,this.sid=new Jo,this.digestAlgorithm=new nl,this.signatureAlgorithm=new eh,this.signature=new Le,Object.assign(this,e)}}g([w({type:x.Integer})],Bn.prototype,"version",void 0);g([w({type:Jo})],Bn.prototype,"sid",void 0);g([w({type:nl})],Bn.prototype,"digestAlgorithm",void 0);g([w({type:xa,repeated:"set",context:0,implicit:!0,optional:!0,raw:!0})],Bn.prototype,"signedAttrs",void 0);g([w({type:eh})],Bn.prototype,"signatureAlgorithm",void 0);g([w({type:Le})],Bn.prototype,"signature",void 0);g([w({type:xa,repeated:"set",context:1,implicit:!0,optional:!0})],Bn.prototype,"unsignedAttrs",void 0);let rh=V2=class extends qe{constructor(e){super(e),Object.setPrototypeOf(this,V2.prototype)}};rh=V2=g([j({type:z.Set,itemType:Bn})],rh);let P6=class extends Bn{};P6=g([j({type:z.Sequence})],P6);let R6=class extends Dt{};R6=g([j({type:z.Choice})],R6);class P3{constructor(e={}){this.acIssuer=new Ee,this.acSerial=0,this.attrs=[],Object.assign(this,e)}}g([w({type:Ee})],P3.prototype,"acIssuer",void 0);g([w({type:x.Integer})],P3.prototype,"acSerial",void 0);g([w({type:Zn,repeated:"sequence"})],P3.prototype,"attrs",void 0);var z2;let nh=z2=class extends qe{constructor(e){super(e),Object.setPrototypeOf(this,z2.prototype)}};nh=z2=g([j({type:z.Sequence,itemType:x.ObjectIdentifier})],nh);class Of{constructor(e={}){this.permitUnSpecified=!0,Object.assign(this,e)}}g([w({type:x.Integer,optional:!0})],Of.prototype,"pathLenConstraint",void 0);g([w({type:nh,implicit:!0,context:0,optional:!0})],Of.prototype,"permittedAttrs",void 0);g([w({type:nh,implicit:!0,context:1,optional:!0})],Of.prototype,"excludedAttrs",void 0);g([w({type:x.Boolean,defaultValue:!0})],Of.prototype,"permitUnSpecified",void 0);class Xs{constructor(e={}){this.issuer=new Gt,this.serial=new ArrayBuffer(0),this.issuerUID=new ArrayBuffer(0),Object.assign(this,e)}}g([w({type:Gt})],Xs.prototype,"issuer",void 0);g([w({type:x.Integer,converter:tt})],Xs.prototype,"serial",void 0);g([w({type:x.BitString,optional:!0})],Xs.prototype,"issuerUID",void 0);var H2;(function(r){r[r.publicKey=0]="publicKey",r[r.publicKeyCert=1]="publicKeyCert",r[r.otherObjectTypes=2]="otherObjectTypes"})(H2||(H2={}));class Zs{constructor(e={}){this.digestedObjectType=H2.publicKey,this.digestAlgorithm=new ie,this.objectDigest=new ArrayBuffer(0),Object.assign(this,e)}}g([w({type:x.Enumerated})],Zs.prototype,"digestedObjectType",void 0);g([w({type:x.ObjectIdentifier,optional:!0})],Zs.prototype,"otherObjectTypeID",void 0);g([w({type:ie})],Zs.prototype,"digestAlgorithm",void 0);g([w({type:x.BitString})],Zs.prototype,"objectDigest",void 0);class Mf{constructor(e={}){Object.assign(this,e)}}g([w({type:Gt,optional:!0})],Mf.prototype,"issuerName",void 0);g([w({type:Xs,context:0,implicit:!0,optional:!0})],Mf.prototype,"baseCertificateID",void 0);g([w({type:Zs,context:1,implicit:!0,optional:!0})],Mf.prototype,"objectDigestInfo",void 0);let ea=class{constructor(e={}){Object.assign(this,e)}};g([w({type:Ee,repeated:"sequence"})],ea.prototype,"v1Form",void 0);g([w({type:Mf,context:0,implicit:!0})],ea.prototype,"v2Form",void 0);ea=g([j({type:z.Choice})],ea);class $f{constructor(e={}){this.notBeforeTime=new Date,this.notAfterTime=new Date,Object.assign(this,e)}}g([w({type:x.GeneralizedTime})],$f.prototype,"notBeforeTime",void 0);g([w({type:x.GeneralizedTime})],$f.prototype,"notAfterTime",void 0);class Ll{constructor(e={}){Object.assign(this,e)}}g([w({type:Xs,implicit:!0,context:0,optional:!0})],Ll.prototype,"baseCertificateID",void 0);g([w({type:Gt,implicit:!0,context:1,optional:!0})],Ll.prototype,"entityName",void 0);g([w({type:Zs,implicit:!0,context:2,optional:!0})],Ll.prototype,"objectDigestInfo",void 0);var q2;(function(r){r[r.v2=1]="v2"})(q2||(q2={}));class un{constructor(e={}){this.version=q2.v2,this.holder=new Ll,this.issuer=new ea,this.signature=new ie,this.serialNumber=new ArrayBuffer(0),this.attrCertValidityPeriod=new $f,this.attributes=[],Object.assign(this,e)}}g([w({type:x.Integer})],un.prototype,"version",void 0);g([w({type:Ll})],un.prototype,"holder",void 0);g([w({type:ea})],un.prototype,"issuer",void 0);g([w({type:ie})],un.prototype,"signature",void 0);g([w({type:x.Integer,converter:tt})],un.prototype,"serialNumber",void 0);g([w({type:$f})],un.prototype,"attrCertValidityPeriod",void 0);g([w({type:Zn,repeated:"sequence"})],un.prototype,"attributes",void 0);g([w({type:x.BitString,optional:!0})],un.prototype,"issuerUniqueID",void 0);g([w({type:Vi,optional:!0})],un.prototype,"extensions",void 0);class Uf{constructor(e={}){this.acinfo=new un,this.signatureAlgorithm=new ie,this.signatureValue=new ArrayBuffer(0),Object.assign(this,e)}}g([w({type:un})],Uf.prototype,"acinfo",void 0);g([w({type:ie})],Uf.prototype,"signatureAlgorithm",void 0);g([w({type:x.BitString})],Uf.prototype,"signatureValue",void 0);var ih;(function(r){r[r.unmarked=1]="unmarked",r[r.unclassified=2]="unclassified",r[r.restricted=4]="restricted",r[r.confidential=8]="confidential",r[r.secret=16]="secret",r[r.topSecret=32]="topSecret"})(ih||(ih={}));class K2 extends Pf{}class R3{constructor(e={}){this.type="",this.value=new ArrayBuffer(0),Object.assign(this,e)}}g([w({type:x.ObjectIdentifier,implicit:!0,context:0})],R3.prototype,"type",void 0);g([w({type:x.Any,implicit:!0,context:1})],R3.prototype,"value",void 0);class N3{constructor(e={}){this.policyId="",this.classList=new K2(ih.unclassified),Object.assign(this,e)}}g([w({type:x.ObjectIdentifier})],N3.prototype,"policyId",void 0);g([w({type:K2,defaultValue:new K2(ih.unclassified)})],N3.prototype,"classList",void 0);g([w({type:R3,repeated:"set"})],N3.prototype,"securityCategories",void 0);class Ff{constructor(e={}){Object.assign(this,e)}}g([w({type:Le})],Ff.prototype,"cotets",void 0);g([w({type:x.ObjectIdentifier})],Ff.prototype,"oid",void 0);g([w({type:x.Utf8String})],Ff.prototype,"string",void 0);class Xv{constructor(e={}){this.values=[],Object.assign(this,e)}}g([w({type:Gt,implicit:!0,context:0,optional:!0})],Xv.prototype,"policyAuthority",void 0);g([w({type:Ff,repeated:"sequence"})],Xv.prototype,"values",void 0);var W2;class Vf{constructor(e={}){this.targetCertificate=new Xs,Object.assign(this,e)}}g([w({type:Xs})],Vf.prototype,"targetCertificate",void 0);g([w({type:Ee,optional:!0})],Vf.prototype,"targetName",void 0);g([w({type:Zs,optional:!0})],Vf.prototype,"certDigestInfo",void 0);let ta=class{constructor(e={}){Object.assign(this,e)}};g([w({type:Ee,context:0,implicit:!0})],ta.prototype,"targetName",void 0);g([w({type:Ee,context:1,implicit:!0})],ta.prototype,"targetGroup",void 0);g([w({type:Vf,context:2,implicit:!0})],ta.prototype,"targetCert",void 0);ta=g([j({type:z.Choice})],ta);let j2=W2=class extends qe{constructor(e){super(e),Object.setPrototypeOf(this,W2.prototype)}};j2=W2=g([j({type:z.Sequence,itemType:ta})],j2);var G2;let N6=G2=class extends qe{constructor(e){super(e),Object.setPrototypeOf(this,G2.prototype)}};N6=G2=g([j({type:z.Sequence,itemType:j2})],N6);class Zv{constructor(e={}){Object.assign(this,e)}}g([w({type:Gt,implicit:!0,context:0,optional:!0})],Zv.prototype,"roleAuthority",void 0);g([w({type:Ee,implicit:!0,context:1})],Zv.prototype,"roleName",void 0);class D3{constructor(e={}){this.service=new Ee,this.ident=new Ee,Object.assign(this,e)}}g([w({type:Ee})],D3.prototype,"service",void 0);g([w({type:Ee})],D3.prototype,"ident",void 0);g([w({type:Le,optional:!0})],D3.prototype,"authInfo",void 0);var Y2;class B3{constructor(e={}){this.otherCertFormat="",this.otherCert=new ArrayBuffer(0),Object.assign(this,e)}}g([w({type:x.ObjectIdentifier})],B3.prototype,"otherCertFormat",void 0);g([w({type:x.Any})],B3.prototype,"otherCert",void 0);let ra=class{constructor(e={}){Object.assign(this,e)}};g([w({type:Ts})],ra.prototype,"certificate",void 0);g([w({type:Uf,context:2,implicit:!0})],ra.prototype,"v2AttrCert",void 0);g([w({type:B3,context:3,implicit:!0})],ra.prototype,"other",void 0);ra=g([j({type:z.Choice})],ra);let sh=Y2=class extends qe{constructor(e){super(e),Object.setPrototypeOf(this,Y2.prototype)}};sh=Y2=g([j({type:z.Set,itemType:ra})],sh);class Aa{constructor(e={}){this.contentType="",this.content=new ArrayBuffer(0),Object.assign(this,e)}}g([w({type:x.ObjectIdentifier})],Aa.prototype,"contentType",void 0);g([w({type:x.Any,context:0})],Aa.prototype,"content",void 0);let il=class{constructor(e={}){Object.assign(this,e)}};g([w({type:Le})],il.prototype,"single",void 0);g([w({type:x.Any})],il.prototype,"any",void 0);il=g([j({type:z.Choice})],il);class zf{constructor(e={}){this.eContentType="",Object.assign(this,e)}}g([w({type:x.ObjectIdentifier})],zf.prototype,"eContentType",void 0);g([w({type:il,context:0,optional:!0})],zf.prototype,"eContent",void 0);let sl=class{constructor(e={}){Object.assign(this,e)}};g([w({type:Le,context:0,implicit:!0,optional:!0})],sl.prototype,"value",void 0);g([w({type:Le,converter:Qz,context:0,implicit:!0,optional:!0,repeated:"sequence"})],sl.prototype,"constructedValue",void 0);sl=g([j({type:z.Choice})],sl);class Ol{constructor(e={}){this.contentType="",this.contentEncryptionAlgorithm=new th,Object.assign(this,e)}}g([w({type:x.ObjectIdentifier})],Ol.prototype,"contentType",void 0);g([w({type:th})],Ol.prototype,"contentEncryptionAlgorithm",void 0);g([w({type:sl,optional:!0})],Ol.prototype,"encryptedContent",void 0);class Hf{constructor(e={}){this.keyAttrId="",Object.assign(this,e)}}g([w({type:x.ObjectIdentifier})],Hf.prototype,"keyAttrId",void 0);g([w({type:x.Any,optional:!0})],Hf.prototype,"keyAttr",void 0);var Q2;class qf{constructor(e={}){this.subjectKeyIdentifier=new Di,Object.assign(this,e)}}g([w({type:Di})],qf.prototype,"subjectKeyIdentifier",void 0);g([w({type:x.GeneralizedTime,optional:!0})],qf.prototype,"date",void 0);g([w({type:Hf,optional:!0})],qf.prototype,"other",void 0);let na=class{constructor(e={}){Object.assign(this,e)}};g([w({type:qf,context:0,implicit:!0,optional:!0})],na.prototype,"rKeyId",void 0);g([w({type:Sa,optional:!0})],na.prototype,"issuerAndSerialNumber",void 0);na=g([j({type:z.Choice})],na);class L3{constructor(e={}){this.rid=new na,this.encryptedKey=new Le,Object.assign(this,e)}}g([w({type:na})],L3.prototype,"rid",void 0);g([w({type:Le})],L3.prototype,"encryptedKey",void 0);let oh=Q2=class extends qe{constructor(e){super(e),Object.setPrototypeOf(this,Q2.prototype)}};oh=Q2=g([j({type:z.Sequence,itemType:L3})],oh);class O3{constructor(e={}){this.algorithm=new ie,this.publicKey=new ArrayBuffer(0),Object.assign(this,e)}}g([w({type:ie})],O3.prototype,"algorithm",void 0);g([w({type:x.BitString})],O3.prototype,"publicKey",void 0);let Ps=class{constructor(e={}){Object.assign(this,e)}};g([w({type:Di,context:0,implicit:!0,optional:!0})],Ps.prototype,"subjectKeyIdentifier",void 0);g([w({type:O3,context:1,implicit:!0,optional:!0})],Ps.prototype,"originatorKey",void 0);g([w({type:Sa,optional:!0})],Ps.prototype,"issuerAndSerialNumber",void 0);Ps=g([j({type:z.Choice})],Ps);class ka{constructor(e={}){this.version=Jn.v3,this.originator=new Ps,this.keyEncryptionAlgorithm=new Tn,this.recipientEncryptedKeys=new oh,Object.assign(this,e)}}g([w({type:x.Integer})],ka.prototype,"version",void 0);g([w({type:Ps,context:0})],ka.prototype,"originator",void 0);g([w({type:Le,context:1,optional:!0})],ka.prototype,"ukm",void 0);g([w({type:Tn})],ka.prototype,"keyEncryptionAlgorithm",void 0);g([w({type:oh})],ka.prototype,"recipientEncryptedKeys",void 0);let ia=class{constructor(e={}){Object.assign(this,e)}};g([w({type:Di,context:0,implicit:!0})],ia.prototype,"subjectKeyIdentifier",void 0);g([w({type:Sa})],ia.prototype,"issuerAndSerialNumber",void 0);ia=g([j({type:z.Choice})],ia);class Ml{constructor(e={}){this.version=Jn.v0,this.rid=new ia,this.keyEncryptionAlgorithm=new Tn,this.encryptedKey=new Le,Object.assign(this,e)}}g([w({type:x.Integer})],Ml.prototype,"version",void 0);g([w({type:ia})],Ml.prototype,"rid",void 0);g([w({type:Tn})],Ml.prototype,"keyEncryptionAlgorithm",void 0);g([w({type:Le})],Ml.prototype,"encryptedKey",void 0);class $l{constructor(e={}){this.keyIdentifier=new Le,Object.assign(this,e)}}g([w({type:Le})],$l.prototype,"keyIdentifier",void 0);g([w({type:x.GeneralizedTime,optional:!0})],$l.prototype,"date",void 0);g([w({type:Hf,optional:!0})],$l.prototype,"other",void 0);class Ul{constructor(e={}){this.version=Jn.v4,this.kekid=new $l,this.keyEncryptionAlgorithm=new Tn,this.encryptedKey=new Le,Object.assign(this,e)}}g([w({type:x.Integer})],Ul.prototype,"version",void 0);g([w({type:$l})],Ul.prototype,"kekid",void 0);g([w({type:Tn})],Ul.prototype,"keyEncryptionAlgorithm",void 0);g([w({type:Le})],Ul.prototype,"encryptedKey",void 0);class Fl{constructor(e={}){this.version=Jn.v0,this.keyEncryptionAlgorithm=new Tn,this.encryptedKey=new Le,Object.assign(this,e)}}g([w({type:x.Integer})],Fl.prototype,"version",void 0);g([w({type:F2,context:0,optional:!0})],Fl.prototype,"keyDerivationAlgorithm",void 0);g([w({type:Tn})],Fl.prototype,"keyEncryptionAlgorithm",void 0);g([w({type:Le})],Fl.prototype,"encryptedKey",void 0);class M3{constructor(e={}){this.oriType="",this.oriValue=new ArrayBuffer(0),Object.assign(this,e)}}g([w({type:x.ObjectIdentifier})],M3.prototype,"oriType",void 0);g([w({type:x.Any})],M3.prototype,"oriValue",void 0);let zi=class{constructor(e={}){Object.assign(this,e)}};g([w({type:Ml,optional:!0})],zi.prototype,"ktri",void 0);g([w({type:ka,context:1,implicit:!0,optional:!0})],zi.prototype,"kari",void 0);g([w({type:Ul,context:2,implicit:!0,optional:!0})],zi.prototype,"kekri",void 0);g([w({type:Fl,context:3,implicit:!0,optional:!0})],zi.prototype,"pwri",void 0);g([w({type:M3,context:4,implicit:!0,optional:!0})],zi.prototype,"ori",void 0);zi=g([j({type:z.Choice})],zi);var X2;let ah=X2=class extends qe{constructor(e){super(e),Object.setPrototypeOf(this,X2.prototype)}};ah=X2=g([j({type:z.Set,itemType:zi})],ah);var Z2;class Kf{constructor(e={}){this.otherRevInfoFormat="",this.otherRevInfo=new ArrayBuffer(0),Object.assign(this,e)}}g([w({type:x.ObjectIdentifier})],Kf.prototype,"otherRevInfoFormat",void 0);g([w({type:x.Any})],Kf.prototype,"otherRevInfo",void 0);let ch=class{constructor(e={}){this.other=new Kf,Object.assign(this,e)}};g([w({type:Kf,context:1,implicit:!0})],ch.prototype,"other",void 0);ch=g([j({type:z.Choice})],ch);let lh=Z2=class extends qe{constructor(e){super(e),Object.setPrototypeOf(this,Z2.prototype)}};lh=Z2=g([j({type:z.Set,itemType:ch})],lh);class $3{constructor(e={}){Object.assign(this,e)}}g([w({type:sh,context:0,implicit:!0,optional:!0})],$3.prototype,"certs",void 0);g([w({type:lh,context:1,implicit:!0,optional:!0})],$3.prototype,"crls",void 0);var J2;let ep=J2=class extends qe{constructor(e){super(e),Object.setPrototypeOf(this,J2.prototype)}};ep=J2=g([j({type:z.Set,itemType:xa})],ep);class Vl{constructor(e={}){this.version=Jn.v0,this.recipientInfos=new ah,this.encryptedContentInfo=new Ol,Object.assign(this,e)}}g([w({type:x.Integer})],Vl.prototype,"version",void 0);g([w({type:$3,context:0,implicit:!0,optional:!0})],Vl.prototype,"originatorInfo",void 0);g([w({type:ah})],Vl.prototype,"recipientInfos",void 0);g([w({type:Ol})],Vl.prototype,"encryptedContentInfo",void 0);g([w({type:ep,context:1,implicit:!0,optional:!0})],Vl.prototype,"unprotectedAttrs",void 0);const SH="1.2.840.113549.1.7.2";var tp;let uh=tp=class extends qe{constructor(e){super(e),Object.setPrototypeOf(this,tp.prototype)}};uh=tp=g([j({type:z.Set,itemType:nl})],uh);class Ca{constructor(e={}){this.version=Jn.v0,this.digestAlgorithms=new uh,this.encapContentInfo=new zf,this.signerInfos=new rh,Object.assign(this,e)}}g([w({type:x.Integer})],Ca.prototype,"version",void 0);g([w({type:uh})],Ca.prototype,"digestAlgorithms",void 0);g([w({type:zf})],Ca.prototype,"encapContentInfo",void 0);g([w({type:sh,context:0,implicit:!0,optional:!0})],Ca.prototype,"certificates",void 0);g([w({type:lh,context:1,implicit:!0,optional:!0})],Ca.prototype,"crls",void 0);g([w({type:rh})],Ca.prototype,"signerInfos",void 0);const ol="1.2.840.10045.2.1",U3="1.2.840.10045.4.1",Jv="1.2.840.10045.4.3.1",F3="1.2.840.10045.4.3.2",V3="1.2.840.10045.4.3.3",z3="1.2.840.10045.4.3.4",D6="1.2.840.10045.3.1.7",B6="1.3.132.0.34",L6="1.3.132.0.35";function zl(r){return new ie({algorithm:r})}const xH=zl(U3);zl(Jv);const AH=zl(F3),kH=zl(V3),CH=zl(z3);let al=class{constructor(e={}){Object.assign(this,e)}};g([w({type:x.ObjectIdentifier})],al.prototype,"fieldType",void 0);g([w({type:x.Any})],al.prototype,"parameters",void 0);al=g([j({type:z.Sequence})],al);class IH extends Le{}let sa=class{constructor(e={}){Object.assign(this,e)}};g([w({type:x.OctetString})],sa.prototype,"a",void 0);g([w({type:x.OctetString})],sa.prototype,"b",void 0);g([w({type:x.BitString,optional:!0})],sa.prototype,"seed",void 0);sa=g([j({type:z.Sequence})],sa);var rp;(function(r){r[r.ecpVer1=1]="ecpVer1"})(rp||(rp={}));let ei=class{constructor(e={}){this.version=rp.ecpVer1,Object.assign(this,e)}};g([w({type:x.Integer})],ei.prototype,"version",void 0);g([w({type:al})],ei.prototype,"fieldID",void 0);g([w({type:sa})],ei.prototype,"curve",void 0);g([w({type:IH})],ei.prototype,"base",void 0);g([w({type:x.Integer,converter:tt})],ei.prototype,"order",void 0);g([w({type:x.Integer,optional:!0})],ei.prototype,"cofactor",void 0);ei=g([j({type:z.Sequence})],ei);let Hi=class{constructor(e={}){Object.assign(this,e)}};g([w({type:x.ObjectIdentifier})],Hi.prototype,"namedCurve",void 0);g([w({type:x.Null})],Hi.prototype,"implicitCurve",void 0);g([w({type:ei})],Hi.prototype,"specifiedCurve",void 0);Hi=g([j({type:z.Choice})],Hi);class Wf{constructor(e={}){this.version=1,this.privateKey=new Le,Object.assign(this,e)}}g([w({type:x.Integer})],Wf.prototype,"version",void 0);g([w({type:Le})],Wf.prototype,"privateKey",void 0);g([w({type:Hi,context:0,optional:!0})],Wf.prototype,"parameters",void 0);g([w({type:x.BitString,context:1,optional:!0})],Wf.prototype,"publicKey",void 0);class dh{constructor(e={}){this.r=new ArrayBuffer(0),this.s=new ArrayBuffer(0),Object.assign(this,e)}}g([w({type:x.Integer,converter:tt})],dh.prototype,"r",void 0);g([w({type:x.Integer,converter:tt})],dh.prototype,"s",void 0);const gr="1.2.840.113549.1.1",Rs=`${gr}.1`,_H=`${gr}.7`,TH=`${gr}.9`,_c=`${gr}.10`,PH=`${gr}.2`,RH=`${gr}.4`,hh=`${gr}.5`,NH=`${gr}.14`,np=`${gr}.11`,fh=`${gr}.12`,ph=`${gr}.13`,eE=`${gr}.15`,tE=`${gr}.16`,gh="1.3.14.3.2.26",rE="2.16.840.1.101.3.4.2.4",mh="2.16.840.1.101.3.4.2.1",yh="2.16.840.1.101.3.4.2.2",wh="2.16.840.1.101.3.4.2.3",DH="2.16.840.1.101.3.4.2.5",BH="2.16.840.1.101.3.4.2.6",LH="1.2.840.113549.2.2",OH="1.2.840.113549.2.5",jf=`${gr}.8`;function St(r){return new ie({algorithm:r,parameters:null})}St(LH);St(OH);const Ns=St(gh);St(rE);St(mh);St(yh);St(wh);St(DH);St(BH);const nE=new ie({algorithm:jf,parameters:Z.serialize(Ns)}),iE=new ie({algorithm:TH,parameters:Z.serialize(jd.toASN(new Uint8Array([218,57,163,238,94,107,75,13,50,85,191,239,149,96,24,144,175,216,7,9]).buffer))});St(Rs);St(PH);St(RH);St(hh);St(eE);St(tE);St(fh);St(ph);St(eE);St(tE);class Gf{constructor(e={}){this.hashAlgorithm=new ie(Ns),this.maskGenAlgorithm=new ie({algorithm:jf,parameters:Z.serialize(Ns)}),this.pSourceAlgorithm=new ie(iE),Object.assign(this,e)}}g([w({type:ie,context:0,defaultValue:Ns})],Gf.prototype,"hashAlgorithm",void 0);g([w({type:ie,context:1,defaultValue:nE})],Gf.prototype,"maskGenAlgorithm",void 0);g([w({type:ie,context:2,defaultValue:iE})],Gf.prototype,"pSourceAlgorithm",void 0);new ie({algorithm:_H,parameters:Z.serialize(new Gf)});class Ds{constructor(e={}){this.hashAlgorithm=new ie(Ns),this.maskGenAlgorithm=new ie({algorithm:jf,parameters:Z.serialize(Ns)}),this.saltLength=20,this.trailerField=1,Object.assign(this,e)}}g([w({type:ie,context:0,defaultValue:Ns})],Ds.prototype,"hashAlgorithm",void 0);g([w({type:ie,context:1,defaultValue:nE})],Ds.prototype,"maskGenAlgorithm",void 0);g([w({type:x.Integer,context:2,defaultValue:20})],Ds.prototype,"saltLength",void 0);g([w({type:x.Integer,context:3,defaultValue:1})],Ds.prototype,"trailerField",void 0);new ie({algorithm:_c,parameters:Z.serialize(new Ds)});class Yf{constructor(e={}){this.digestAlgorithm=new ie,this.digest=new Le,Object.assign(this,e)}}g([w({type:ie})],Yf.prototype,"digestAlgorithm",void 0);g([w({type:Le})],Yf.prototype,"digest",void 0);var ip;class Qf{constructor(e={}){this.prime=new ArrayBuffer(0),this.exponent=new ArrayBuffer(0),this.coefficient=new ArrayBuffer(0),Object.assign(this,e)}}g([w({type:x.Integer,converter:tt})],Qf.prototype,"prime",void 0);g([w({type:x.Integer,converter:tt})],Qf.prototype,"exponent",void 0);g([w({type:x.Integer,converter:tt})],Qf.prototype,"coefficient",void 0);let sp=ip=class extends qe{constructor(e){super(e),Object.setPrototypeOf(this,ip.prototype)}};sp=ip=g([j({type:z.Sequence,itemType:Qf})],sp);class Ln{constructor(e={}){this.version=0,this.modulus=new ArrayBuffer(0),this.publicExponent=new ArrayBuffer(0),this.privateExponent=new ArrayBuffer(0),this.prime1=new ArrayBuffer(0),this.prime2=new ArrayBuffer(0),this.exponent1=new ArrayBuffer(0),this.exponent2=new ArrayBuffer(0),this.coefficient=new ArrayBuffer(0),Object.assign(this,e)}}g([w({type:x.Integer})],Ln.prototype,"version",void 0);g([w({type:x.Integer,converter:tt})],Ln.prototype,"modulus",void 0);g([w({type:x.Integer,converter:tt})],Ln.prototype,"publicExponent",void 0);g([w({type:x.Integer,converter:tt})],Ln.prototype,"privateExponent",void 0);g([w({type:x.Integer,converter:tt})],Ln.prototype,"prime1",void 0);g([w({type:x.Integer,converter:tt})],Ln.prototype,"prime2",void 0);g([w({type:x.Integer,converter:tt})],Ln.prototype,"exponent1",void 0);g([w({type:x.Integer,converter:tt})],Ln.prototype,"exponent2",void 0);g([w({type:x.Integer,converter:tt})],Ln.prototype,"coefficient",void 0);g([w({type:sp,optional:!0})],Ln.prototype,"otherPrimeInfos",void 0);class H3{constructor(e={}){this.modulus=new ArrayBuffer(0),this.publicExponent=new ArrayBuffer(0),Object.assign(this,e)}}g([w({type:x.Integer,converter:tt})],H3.prototype,"modulus",void 0);g([w({type:x.Integer,converter:tt})],H3.prototype,"publicExponent",void 0);var op;(function(r){r[r.Transient=0]="Transient",r[r.Singleton=1]="Singleton",r[r.ResolutionScoped=2]="ResolutionScoped",r[r.ContainerScoped=3]="ContainerScoped"})(op||(op={}));const lr=op;var ap=function(r,e){return ap=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var i in n)n.hasOwnProperty(i)&&(t[i]=n[i])},ap(r,e)};function q3(r,e){ap(r,e);function t(){this.constructor=r}r.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}function MH(r,e,t,n){function i(s){return s instanceof t?s:new t(function(o){o(s)})}return new(t||(t=Promise))(function(s,o){function a(u){try{l(n.next(u))}catch(d){o(d)}}function c(u){try{l(n.throw(u))}catch(d){o(d)}}function l(u){u.done?s(u.value):i(u.value).then(a,c)}l((n=n.apply(r,[])).next())})}function $H(r,e){var t={label:0,sent:function(){if(s[0]&1)throw s[1];return s[1]},trys:[],ops:[]},n,i,s,o;return o={next:a(0),throw:a(1),return:a(2)},typeof Symbol=="function"&&(o[Symbol.iterator]=function(){return this}),o;function a(l){return function(u){return c([l,u])}}function c(l){if(n)throw new TypeError("Generator is already executing.");for(;t;)try{if(n=1,i&&(s=l[0]&2?i.return:l[0]?i.throw||((s=i.return)&&s.call(i),0):i.next)&&!(s=s.call(i,l[1])).done)return s;switch(i=0,s&&(l=[l[0]&2,s.value]),l[0]){case 0:case 1:s=l;break;case 4:return t.label++,{value:l[1],done:!1};case 5:t.label++,i=l[1],l=[0];continue;case 7:l=t.ops.pop(),t.trys.pop();continue;default:if(s=t.trys,!(s=s.length>0&&s[s.length-1])&&(l[0]===6||l[0]===2)){t=0;continue}if(l[0]===3&&(!s||l[1]>s[0]&&l[1]<s[3])){t.label=l[1];break}if(l[0]===6&&t.label<s[1]){t.label=s[1],s=l;break}if(s&&t.label<s[2]){t.label=s[2],t.ops.push(l);break}s[2]&&t.ops.pop(),t.trys.pop();continue}l=e.call(r,t)}catch(u){l=[6,u],i=0}finally{n=s=0}if(l[0]&5)throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}}function Pu(r){var e=typeof Symbol=="function"&&Symbol.iterator,t=e&&r[e],n=0;if(t)return t.call(r);if(r&&typeof r.length=="number")return{next:function(){return r&&n>=r.length&&(r=void 0),{value:r&&r[n++],done:!r}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function bh(r,e){var t=typeof Symbol=="function"&&r[Symbol.iterator];if(!t)return r;var n=t.call(r),i,s=[],o;try{for(;(e===void 0||e-- >0)&&!(i=n.next()).done;)s.push(i.value)}catch(a){o={error:a}}finally{try{i&&!i.done&&(t=n.return)&&t.call(n)}finally{if(o)throw o.error}}return s}function rs(){for(var r=[],e=0;e<arguments.length;e++)r=r.concat(bh(arguments[e]));return r}var UH="injectionTokens";function FH(r){var e=Reflect.getMetadata("design:paramtypes",r)||[],t=Reflect.getOwnMetadata(UH,r)||{};return Object.keys(t).forEach(function(n){e[+n]=t[n]}),e}function sE(r){return!!r.useClass}function cp(r){return!!r.useFactory}var oE=(function(){function r(e){this.wrap=e,this.reflectMethods=["get","getPrototypeOf","setPrototypeOf","getOwnPropertyDescriptor","defineProperty","has","set","deleteProperty","apply","construct","ownKeys"]}return r.prototype.createProxy=function(e){var t=this,n={},i=!1,s,o=function(){return i||(s=e(t.wrap()),i=!0),s};return new Proxy(n,this.createHandler(o))},r.prototype.createHandler=function(e){var t={},n=function(i){t[i]=function(){for(var s=[],o=0;o<arguments.length;o++)s[o]=arguments[o];s[0]=e();var a=Reflect[i];return a.apply(void 0,rs(s))}};return this.reflectMethods.forEach(n),t},r})();function ao(r){return typeof r=="string"||typeof r=="symbol"}function VH(r){return typeof r=="object"&&"token"in r&&"multiple"in r}function O6(r){return typeof r=="object"&&"token"in r&&"transform"in r}function zH(r){return typeof r=="function"||r instanceof oE}function qu(r){return!!r.useToken}function Ku(r){return r.useValue!=null}function HH(r){return sE(r)||Ku(r)||qu(r)||cp(r)}var K3=(function(){function r(){this._registryMap=new Map}return r.prototype.entries=function(){return this._registryMap.entries()},r.prototype.getAll=function(e){return this.ensure(e),this._registryMap.get(e)},r.prototype.get=function(e){this.ensure(e);var t=this._registryMap.get(e);return t[t.length-1]||null},r.prototype.set=function(e,t){this.ensure(e),this._registryMap.get(e).push(t)},r.prototype.setAll=function(e,t){this._registryMap.set(e,t)},r.prototype.has=function(e){return this.ensure(e),this._registryMap.get(e).length>0},r.prototype.clear=function(){this._registryMap.clear()},r.prototype.ensure=function(e){this._registryMap.has(e)||this._registryMap.set(e,[])},r})(),qH=(function(r){q3(e,r);function e(){return r!==null&&r.apply(this,arguments)||this}return e})(K3),Ru=(function(){function r(){this.scopedResolutions=new Map}return r})();function KH(r,e){if(r===null)return"at position #"+e;var t=r.split(",")[e].trim();return'"'+t+'" at position #'+e}function WH(r,e,t){return t===void 0&&(t="    "),rs([r],e.message.split(`
`).map(function(n){return t+n})).join(`
`)}function jH(r,e,t){var n=bh(r.toString().match(/constructor\(([\w, ]+)\)/)||[],2),i=n[1],s=i===void 0?null:i,o=KH(s,e);return WH("Cannot inject the dependency "+o+' of "'+r.name+'" constructor. Reason:',t)}function GH(r){if(typeof r.dispose!="function")return!1;var e=r.dispose;return!(e.length>0)}var YH=(function(r){q3(e,r);function e(){return r!==null&&r.apply(this,arguments)||this}return e})(K3),QH=(function(r){q3(e,r);function e(){return r!==null&&r.apply(this,arguments)||this}return e})(K3),XH=(function(){function r(){this.preResolution=new YH,this.postResolution=new QH}return r})(),aE=new Map,ZH=(function(){function r(e){this.parent=e,this._registry=new qH,this.interceptors=new XH,this.disposed=!1,this.disposables=new Set}return r.prototype.register=function(e,t,n){n===void 0&&(n={lifecycle:lr.Transient}),this.ensureNotDisposed();var i;if(HH(t)?i=t:i={useClass:t},qu(i))for(var s=[e],o=i;o!=null;){var a=o.useToken;if(s.includes(a))throw new Error("Token registration cycle detected! "+rs(s,[a]).join(" -> "));s.push(a);var c=this._registry.get(a);c&&qu(c.provider)?o=c.provider:o=null}if((n.lifecycle===lr.Singleton||n.lifecycle==lr.ContainerScoped||n.lifecycle==lr.ResolutionScoped)&&(Ku(i)||cp(i)))throw new Error('Cannot use lifecycle "'+lr[n.lifecycle]+'" with ValueProviders or FactoryProviders');return this._registry.set(e,{provider:i,options:n}),this},r.prototype.registerType=function(e,t){return this.ensureNotDisposed(),ao(t)?this.register(e,{useToken:t}):this.register(e,{useClass:t})},r.prototype.registerInstance=function(e,t){return this.ensureNotDisposed(),this.register(e,{useValue:t})},r.prototype.registerSingleton=function(e,t){if(this.ensureNotDisposed(),ao(e)){if(ao(t))return this.register(e,{useToken:t},{lifecycle:lr.Singleton});if(t)return this.register(e,{useClass:t},{lifecycle:lr.Singleton});throw new Error('Cannot register a type name as a singleton without a "to" token')}var n=e;return t&&!ao(t)&&(n=t),this.register(e,{useClass:n},{lifecycle:lr.Singleton})},r.prototype.resolve=function(e,t,n){t===void 0&&(t=new Ru),n===void 0&&(n=!1),this.ensureNotDisposed();var i=this.getRegistration(e);if(!i&&ao(e)){if(n)return;throw new Error('Attempted to resolve unregistered dependency token: "'+e.toString()+'"')}if(this.executePreResolutionInterceptor(e,"Single"),i){var s=this.resolveRegistration(i,t);return this.executePostResolutionInterceptor(e,s,"Single"),s}if(zH(e)){var s=this.construct(e,t);return this.executePostResolutionInterceptor(e,s,"Single"),s}throw new Error("Attempted to construct an undefined constructor. Could mean a circular dependency problem. Try using `delay` function.")},r.prototype.executePreResolutionInterceptor=function(e,t){var n,i;if(this.interceptors.preResolution.has(e)){var s=[];try{for(var o=Pu(this.interceptors.preResolution.getAll(e)),a=o.next();!a.done;a=o.next()){var c=a.value;c.options.frequency!="Once"&&s.push(c),c.callback(e,t)}}catch(l){n={error:l}}finally{try{a&&!a.done&&(i=o.return)&&i.call(o)}finally{if(n)throw n.error}}this.interceptors.preResolution.setAll(e,s)}},r.prototype.executePostResolutionInterceptor=function(e,t,n){var i,s;if(this.interceptors.postResolution.has(e)){var o=[];try{for(var a=Pu(this.interceptors.postResolution.getAll(e)),c=a.next();!c.done;c=a.next()){var l=c.value;l.options.frequency!="Once"&&o.push(l),l.callback(e,t,n)}}catch(u){i={error:u}}finally{try{c&&!c.done&&(s=a.return)&&s.call(a)}finally{if(i)throw i.error}}this.interceptors.postResolution.setAll(e,o)}},r.prototype.resolveRegistration=function(e,t){if(this.ensureNotDisposed(),e.options.lifecycle===lr.ResolutionScoped&&t.scopedResolutions.has(e))return t.scopedResolutions.get(e);var n=e.options.lifecycle===lr.Singleton,i=e.options.lifecycle===lr.ContainerScoped,s=n||i,o;return Ku(e.provider)?o=e.provider.useValue:qu(e.provider)?o=s?e.instance||(e.instance=this.resolve(e.provider.useToken,t)):this.resolve(e.provider.useToken,t):sE(e.provider)?o=s?e.instance||(e.instance=this.construct(e.provider.useClass,t)):this.construct(e.provider.useClass,t):cp(e.provider)?o=e.provider.useFactory(this):o=this.construct(e.provider,t),e.options.lifecycle===lr.ResolutionScoped&&t.scopedResolutions.set(e,o),o},r.prototype.resolveAll=function(e,t,n){var i=this;t===void 0&&(t=new Ru),n===void 0&&(n=!1),this.ensureNotDisposed();var s=this.getAllRegistrations(e);if(!s&&ao(e)){if(n)return[];throw new Error('Attempted to resolve unregistered dependency token: "'+e.toString()+'"')}if(this.executePreResolutionInterceptor(e,"All"),s){var o=s.map(function(c){return i.resolveRegistration(c,t)});return this.executePostResolutionInterceptor(e,o,"All"),o}var a=[this.construct(e,t)];return this.executePostResolutionInterceptor(e,a,"All"),a},r.prototype.isRegistered=function(e,t){return t===void 0&&(t=!1),this.ensureNotDisposed(),this._registry.has(e)||t&&(this.parent||!1)&&this.parent.isRegistered(e,!0)},r.prototype.reset=function(){this.ensureNotDisposed(),this._registry.clear(),this.interceptors.preResolution.clear(),this.interceptors.postResolution.clear()},r.prototype.clearInstances=function(){var e,t;this.ensureNotDisposed();try{for(var n=Pu(this._registry.entries()),i=n.next();!i.done;i=n.next()){var s=bh(i.value,2),o=s[0],a=s[1];this._registry.setAll(o,a.filter(function(c){return!Ku(c.provider)}).map(function(c){return c.instance=void 0,c}))}}catch(c){e={error:c}}finally{try{i&&!i.done&&(t=n.return)&&t.call(n)}finally{if(e)throw e.error}}},r.prototype.createChildContainer=function(){var e,t;this.ensureNotDisposed();var n=new r(this);try{for(var i=Pu(this._registry.entries()),s=i.next();!s.done;s=i.next()){var o=bh(s.value,2),a=o[0],c=o[1];c.some(function(l){var u=l.options;return u.lifecycle===lr.ContainerScoped})&&n._registry.setAll(a,c.map(function(l){return l.options.lifecycle===lr.ContainerScoped?{provider:l.provider,options:l.options}:l}))}}catch(l){e={error:l}}finally{try{s&&!s.done&&(t=i.return)&&t.call(i)}finally{if(e)throw e.error}}return n},r.prototype.beforeResolution=function(e,t,n){n===void 0&&(n={frequency:"Always"}),this.interceptors.preResolution.set(e,{callback:t,options:n})},r.prototype.afterResolution=function(e,t,n){n===void 0&&(n={frequency:"Always"}),this.interceptors.postResolution.set(e,{callback:t,options:n})},r.prototype.dispose=function(){return MH(this,void 0,void 0,function(){var e;return $H(this,function(t){switch(t.label){case 0:return this.disposed=!0,e=[],this.disposables.forEach(function(n){var i=n.dispose();i&&e.push(i)}),[4,Promise.all(e)];case 1:return t.sent(),[2]}})})},r.prototype.getRegistration=function(e){return this.isRegistered(e)?this._registry.get(e):this.parent?this.parent.getRegistration(e):null},r.prototype.getAllRegistrations=function(e){return this.isRegistered(e)?this._registry.getAll(e):this.parent?this.parent.getAllRegistrations(e):null},r.prototype.construct=function(e,t){var n=this;if(e instanceof oE)return e.createProxy(function(s){return n.resolve(s,t)});var i=(function(){var s=aE.get(e);if(!s||s.length===0){if(e.length===0)return new e;throw new Error('TypeInfo not known for "'+e.name+'"')}var o=s.map(n.resolveParams(t,e));return new(e.bind.apply(e,rs([void 0],o)))})();return GH(i)&&this.disposables.add(i),i},r.prototype.resolveParams=function(e,t){var n=this;return function(i,s){var o,a,c;try{return VH(i)?O6(i)?i.multiple?(o=n.resolve(i.transform)).transform.apply(o,rs([n.resolveAll(i.token,new Ru,i.isOptional)],i.transformArgs)):(a=n.resolve(i.transform)).transform.apply(a,rs([n.resolve(i.token,e,i.isOptional)],i.transformArgs)):i.multiple?n.resolveAll(i.token,new Ru,i.isOptional):n.resolve(i.token,e,i.isOptional):O6(i)?(c=n.resolve(i.transform,e)).transform.apply(c,rs([n.resolve(i.token,e)],i.transformArgs)):n.resolve(i,e)}catch(l){throw new Error(jH(t,s,l))}}},r.prototype.ensureNotDisposed=function(){if(this.disposed)throw new Error("This container has been disposed, you cannot interact with a disposed container")},r})(),Ft=new ZH;function Xf(r){return function(e){aE.set(e,FH(e))}}if(typeof Reflect>"u"||!Reflect.getMetadata)throw new Error(`tsyringe requires a reflect polyfill. Please add 'import "reflect-metadata"' to the top of your entry point.`);var lp;class Zf{constructor(e={}){this.attrId="",this.attrValues=[],Object.assign(e)}}g([w({type:x.ObjectIdentifier})],Zf.prototype,"attrId",void 0);g([w({type:x.Any,repeated:"set"})],Zf.prototype,"attrValues",void 0);let M6=lp=class extends qe{constructor(e){super(e),Object.setPrototypeOf(this,lp.prototype)}};M6=lp=g([j({type:z.Sequence,itemType:Zf})],M6);var up;let $6=up=class extends qe{constructor(e){super(e),Object.setPrototypeOf(this,up.prototype)}};$6=up=g([j({type:z.Sequence,itemType:Aa})],$6);class cE{constructor(e={}){this.certId="",this.certValue=new ArrayBuffer(0),Object.assign(this,e)}}g([w({type:x.ObjectIdentifier})],cE.prototype,"certId",void 0);g([w({type:x.Any,context:0})],cE.prototype,"certValue",void 0);class lE{constructor(e={}){this.crlId="",this.crltValue=new ArrayBuffer(0),Object.assign(this,e)}}g([w({type:x.ObjectIdentifier})],lE.prototype,"crlId",void 0);g([w({type:x.Any,context:0})],lE.prototype,"crltValue",void 0);class uE extends Le{}let Jf=class{constructor(e={}){this.encryptionAlgorithm=new ie,this.encryptedData=new uE,Object.assign(this,e)}};g([w({type:ie})],Jf.prototype,"encryptionAlgorithm",void 0);g([w({type:uE})],Jf.prototype,"encryptedData",void 0);var dp,hp;(function(r){r[r.v1=0]="v1"})(hp||(hp={}));class dE extends Le{}let fp=dp=class extends qe{constructor(e){super(e),Object.setPrototypeOf(this,dp.prototype)}};fp=dp=g([j({type:z.Sequence,itemType:Zn})],fp);class Hl{constructor(e={}){this.version=hp.v1,this.privateKeyAlgorithm=new ie,this.privateKey=new dE,Object.assign(this,e)}}g([w({type:x.Integer})],Hl.prototype,"version",void 0);g([w({type:ie})],Hl.prototype,"privateKeyAlgorithm",void 0);g([w({type:dE})],Hl.prototype,"privateKey",void 0);g([w({type:fp,implicit:!0,context:0,optional:!0})],Hl.prototype,"attributes",void 0);let U6=class extends Hl{};U6=g([j({type:z.Sequence})],U6);let F6=class extends Jf{};F6=g([j({type:z.Sequence})],F6);class hE{constructor(e={}){this.secretTypeId="",this.secretValue=new ArrayBuffer(0),Object.assign(this,e)}}g([w({type:x.ObjectIdentifier})],hE.prototype,"secretTypeId",void 0);g([w({type:x.Any,context:0})],hE.prototype,"secretValue",void 0);class ql{constructor(e={}){this.mac=new Yf,this.macSalt=new Le,this.iterations=1,Object.assign(this,e)}}g([w({type:Yf})],ql.prototype,"mac",void 0);g([w({type:Le})],ql.prototype,"macSalt",void 0);g([w({type:x.Integer,defaultValue:1})],ql.prototype,"iterations",void 0);class e1{constructor(e={}){this.version=3,this.authSafe=new Aa,this.macData=new ql,Object.assign(this,e)}}g([w({type:x.Integer})],e1.prototype,"version",void 0);g([w({type:Aa})],e1.prototype,"authSafe",void 0);g([w({type:ql,optional:!0})],e1.prototype,"macData",void 0);var pp;class t1{constructor(e={}){this.bagId="",this.bagValue=new ArrayBuffer(0),Object.assign(this,e)}}g([w({type:x.ObjectIdentifier})],t1.prototype,"bagId",void 0);g([w({type:x.Any,context:0})],t1.prototype,"bagValue",void 0);g([w({type:Zf,repeated:"set",optional:!0})],t1.prototype,"bagAttributes",void 0);let V6=pp=class extends qe{constructor(e){super(e),Object.setPrototypeOf(this,pp.prototype)}};V6=pp=g([j({type:z.Sequence,itemType:t1})],V6);var gp,mp,yp;const fE="1.2.840.113549.1.9",pE=`${fE}.7`,W3=`${fE}.14`;let vh=class extends Ut{constructor(e={}){super(e)}toString(){return this.ia5String||super.toString()}};g([w({type:x.IA5String})],vh.prototype,"ia5String",void 0);vh=g([j({type:z.Choice})],vh);let z6=class extends Aa{};z6=g([j({type:z.Sequence})],z6);let H6=class extends e1{};H6=g([j({type:z.Sequence})],H6);let q6=class extends Jf{};q6=g([j({type:z.Sequence})],q6);let wp=class{constructor(e=""){this.value=e}toString(){return this.value}};g([w({type:x.IA5String})],wp.prototype,"value",void 0);wp=g([j({type:z.Choice})],wp);let K6=class extends vh{};K6=g([j({type:z.Choice})],K6);let W6=class extends Ut{};W6=g([j({type:z.Choice})],W6);let bp=class{constructor(e=new Date){this.value=e}};g([w({type:x.GeneralizedTime})],bp.prototype,"value",void 0);bp=g([j({type:z.Choice})],bp);let j6=class extends Ut{};j6=g([j({type:z.Choice})],j6);let vp=class{constructor(e="M"){this.value=e}toString(){return this.value}};g([w({type:x.PrintableString})],vp.prototype,"value",void 0);vp=g([j({type:z.Choice})],vp);let Eh=class{constructor(e=""){this.value=e}toString(){return this.value}};g([w({type:x.PrintableString})],Eh.prototype,"value",void 0);Eh=g([j({type:z.Choice})],Eh);let G6=class extends Eh{};G6=g([j({type:z.Choice})],G6);let Y6=class extends Ut{};Y6=g([j({type:z.Choice})],Y6);let Ep=class{constructor(e=""){this.value=e}toString(){return this.value}};g([w({type:x.ObjectIdentifier})],Ep.prototype,"value",void 0);Ep=g([j({type:z.Choice})],Ep);let Q6=class extends Dt{};Q6=g([j({type:z.Choice})],Q6);let Sp=class{constructor(e=0){this.value=e}toString(){return this.value.toString()}};g([w({type:x.Integer})],Sp.prototype,"value",void 0);Sp=g([j({type:z.Choice})],Sp);let X6=class extends Bn{};X6=g([j({type:z.Sequence})],X6);let Sh=class extends Ut{};Sh=g([j({type:z.Choice})],Sh);let Z6=gp=class extends Vi{constructor(e){super(e),Object.setPrototypeOf(this,gp.prototype)}};Z6=gp=g([j({type:z.Sequence})],Z6);let J6=mp=class extends qe{constructor(e){super(e),Object.setPrototypeOf(this,mp.prototype)}};J6=mp=g([j({type:z.Set,itemType:xa})],J6);let xp=class{constructor(e=""){this.value=e}toString(){return this.value}};g([w({type:x.BmpString})],xp.prototype,"value",void 0);xp=g([j({type:z.Choice})],xp);let Ap=class extends ie{};Ap=g([j({type:z.Sequence})],Ap);let e5=yp=class extends qe{constructor(e){super(e),Object.setPrototypeOf(this,yp.prototype)}};e5=yp=g([j({type:z.Sequence,itemType:Ap})],e5);var kp;let xh=kp=class extends qe{constructor(e){super(e),Object.setPrototypeOf(this,kp.prototype)}};xh=kp=g([j({type:z.Sequence,itemType:Zn})],xh);class Ia{constructor(e={}){this.version=0,this.subject=new ft,this.subjectPKInfo=new Xr,this.attributes=new xh,Object.assign(this,e)}}g([w({type:x.Integer})],Ia.prototype,"version",void 0);g([w({type:ft})],Ia.prototype,"subject",void 0);g([w({type:Xr})],Ia.prototype,"subjectPKInfo",void 0);g([w({type:xh,implicit:!0,context:0,optional:!0})],Ia.prototype,"attributes",void 0);class cl{constructor(e={}){this.certificationRequestInfo=new Ia,this.signatureAlgorithm=new ie,this.signature=new ArrayBuffer(0),Object.assign(this,e)}}g([w({type:Ia,raw:!0})],cl.prototype,"certificationRequestInfo",void 0);g([w({type:ie})],cl.prototype,"signatureAlgorithm",void 0);g([w({type:x.BitString})],cl.prototype,"signature",void 0);const Kl="crypto.algorithm";class JH{getAlgorithms(){return Ft.resolveAll(Kl)}toAsnAlgorithm(e){({...e});for(const t of this.getAlgorithms()){const n=t.toAsnAlgorithm(e);if(n)return n}if(/^[0-9.]+$/.test(e.name)){const t=new ie({algorithm:e.name});if("parameters"in e){const n=e;t.parameters=n.parameters}return t}throw new Error("Cannot convert WebCrypto algorithm to ASN.1 algorithm")}toWebAlgorithm(e){for(const n of this.getAlgorithms()){const i=n.toWebAlgorithm(e);if(i)return i}return{name:e.algorithm,parameters:e.parameters}}}const Bs="crypto.algorithmProvider";Ft.registerSingleton(Bs,JH);var Wu;const mr="1.3.36.3.3.2.8.1.1",t5=`${mr}.1`,r5=`${mr}.2`,n5=`${mr}.3`,i5=`${mr}.4`,s5=`${mr}.5`,o5=`${mr}.6`,a5=`${mr}.7`,c5=`${mr}.8`,l5=`${mr}.9`,u5=`${mr}.10`,d5=`${mr}.11`,h5=`${mr}.12`,f5=`${mr}.13`,p5=`${mr}.14`,g5="brainpoolP160r1",m5="brainpoolP160t1",y5="brainpoolP192r1",w5="brainpoolP192t1",b5="brainpoolP224r1",v5="brainpoolP224t1",E5="brainpoolP256r1",S5="brainpoolP256t1",x5="brainpoolP320r1",A5="brainpoolP320t1",k5="brainpoolP384r1",C5="brainpoolP384t1",I5="brainpoolP512r1",_5="brainpoolP512t1",at="ECDSA";let ll=Wu=class{toAsnAlgorithm(e){switch(e.name.toLowerCase()){case at.toLowerCase():if("hash"in e)switch((typeof e.hash=="string"?e.hash:e.hash.name).toLowerCase()){case"sha-1":return xH;case"sha-256":return AH;case"sha-384":return kH;case"sha-512":return CH}else if("namedCurve"in e){let t="";switch(e.namedCurve){case"P-256":t=D6;break;case"K-256":t=Wu.SECP256K1;break;case"P-384":t=B6;break;case"P-521":t=L6;break;case g5:t=t5;break;case m5:t=r5;break;case y5:t=n5;break;case w5:t=i5;break;case b5:t=s5;break;case v5:t=o5;break;case E5:t=a5;break;case S5:t=c5;break;case x5:t=l5;break;case A5:t=u5;break;case k5:t=d5;break;case C5:t=h5;break;case I5:t=f5;break;case _5:t=p5;break}if(t)return new ie({algorithm:ol,parameters:Z.serialize(new Hi({namedCurve:t}))})}}return null}toWebAlgorithm(e){switch(e.algorithm){case U3:return{name:at,hash:{name:"SHA-1"}};case F3:return{name:at,hash:{name:"SHA-256"}};case V3:return{name:at,hash:{name:"SHA-384"}};case z3:return{name:at,hash:{name:"SHA-512"}};case ol:{if(!e.parameters)throw new TypeError("Cannot get required parameters from EC algorithm");switch(Z.parse(e.parameters,Hi).namedCurve){case D6:return{name:at,namedCurve:"P-256"};case Wu.SECP256K1:return{name:at,namedCurve:"K-256"};case B6:return{name:at,namedCurve:"P-384"};case L6:return{name:at,namedCurve:"P-521"};case t5:return{name:at,namedCurve:g5};case r5:return{name:at,namedCurve:m5};case n5:return{name:at,namedCurve:y5};case i5:return{name:at,namedCurve:w5};case s5:return{name:at,namedCurve:b5};case o5:return{name:at,namedCurve:v5};case a5:return{name:at,namedCurve:E5};case c5:return{name:at,namedCurve:S5};case l5:return{name:at,namedCurve:x5};case u5:return{name:at,namedCurve:A5};case d5:return{name:at,namedCurve:k5};case h5:return{name:at,namedCurve:C5};case f5:return{name:at,namedCurve:I5};case p5:return{name:at,namedCurve:_5}}}}return null}};ll.SECP256K1="1.3.132.0.10";ll=Wu=g([Xf()],ll);Ft.registerSingleton(Kl,ll);const gE=Symbol("name"),mE=Symbol("value");class $e{constructor(e,t={},n=""){this[gE]=e,this[mE]=n;for(const i in t)this[i]=t[i]}}$e.NAME=gE;$e.VALUE=mE;class eq{static toTextObject(e){const t=new $e("Algorithm Identifier",{},Wi.toString(e.algorithm));if(e.parameters)switch(e.algorithm){case ol:{const n=new ll().toWebAlgorithm(e);n&&"namedCurve"in n?t["Named Curve"]=n.namedCurve:t.Parameters=e.parameters;break}default:t.Parameters=e.parameters}return t}}class Wi{static toString(e){const t=this.items[e];return t||e}}Wi.items={[gh]:"sha1",[rE]:"sha224",[mh]:"sha256",[yh]:"sha384",[wh]:"sha512",[Rs]:"rsaEncryption",[hh]:"sha1WithRSAEncryption",[NH]:"sha224WithRSAEncryption",[np]:"sha256WithRSAEncryption",[fh]:"sha384WithRSAEncryption",[ph]:"sha512WithRSAEncryption",[ol]:"ecPublicKey",[U3]:"ecdsaWithSHA1",[Jv]:"ecdsaWithSHA224",[F3]:"ecdsaWithSHA256",[V3]:"ecdsaWithSHA384",[z3]:"ecdsaWithSHA512",[mH]:"TLS WWW server authentication",[yH]:"TLS WWW client authentication",[wH]:"Code Signing",[bH]:"E-mail Protection",[vH]:"Time Stamping",[EH]:"OCSP Signing",[SH]:"Signed Data"};class Ls{static serialize(e){return this.serializeObj(e).join(`
`)}static pad(e=0){return"".padStart(2*e," ")}static serializeObj(e,t=0){const n=[];let i=this.pad(t++),s="";const o=e[$e.VALUE];o&&(s=` ${o}`),n.push(`${i}${e[$e.NAME]}:${s}`),i=this.pad(t);for(const a in e){if(typeof a=="symbol")continue;const c=e[a],l=a?`${a}: `:"";if(typeof c=="string"||typeof c=="number"||typeof c=="boolean")n.push(`${i}${l}${c}`);else if(c instanceof Date)n.push(`${i}${l}${c.toUTCString()}`);else if(Array.isArray(c))for(const u of c)u[$e.NAME]=a,n.push(...this.serializeObj(u,t));else if(c instanceof $e)c[$e.NAME]=a,n.push(...this.serializeObj(c,t));else if(J.isBufferSource(c))a?(n.push(`${i}${l}`),n.push(...this.serializeBufferSource(c,t+1))):n.push(...this.serializeBufferSource(c,t));else if("toTextObject"in c){const u=c.toTextObject();u[$e.NAME]=a,n.push(...this.serializeObj(u,t))}else throw new TypeError("Cannot serialize data in text format. Unsupported type.")}return n}static serializeBufferSource(e,t=0){const n=this.pad(t),i=J.toUint8Array(e),s=[];for(let o=0;o<i.length;){const a=[];for(let c=0;c<16&&o<i.length;c++){c===8&&a.push("");const l=i[o++].toString(16).padStart(2,"0");a.push(l)}s.push(`${n}${a.join(" ")}`)}return s}static serializeAlgorithm(e){return this.algorithmSerializer.toTextObject(e)}}Ls.oidSerializer=Wi;Ls.algorithmSerializer=eq;var lo;class ji{get rawData(){return xe(this,lo,"f")||nt(this,lo,Z.serialize(this.asn),"f"),xe(this,lo,"f")}constructor(...e){lo.set(this,void 0),J.isBufferSource(e[0])?(this.asn=Z.parse(e[0],e[1]),nt(this,lo,J.toArrayBuffer(e[0]),"f"),this.onInit(this.asn)):(this.asn=e[0],this.onInit(this.asn))}equal(e){return e instanceof ji?H9(e.rawData,this.rawData):!1}toString(e="text"){switch(e){case"asn":return Z.toString(this.rawData);case"text":return Ls.serialize(this.toTextObject());case"hex":return ue.ToHex(this.rawData);case"base64":return ue.ToBase64(this.rawData);case"base64url":return ue.ToBase64Url(this.rawData);default:throw TypeError("Argument 'format' is unsupported value")}}getTextName(){return this.constructor.NAME}toTextObject(){const e=this.toTextObjectEmpty();return e[""]=this.rawData,e}toTextObjectEmpty(e){return new $e(this.getTextName(),{},e)}}lo=new WeakMap;ji.NAME="ASN";class _r extends ji{constructor(...e){let t;J.isBufferSource(e[0])?t=J.toArrayBuffer(e[0]):t=Z.serialize(new Mr({extnID:e[0],critical:e[1],extnValue:new Le(J.toArrayBuffer(e[2]))})),super(t,Mr)}onInit(e){this.type=e.extnID,this.critical=e.critical,this.value=e.extnValue.buffer}toTextObject(){const e=this.toTextObjectWithoutValue();return e[""]=this.value,e}toTextObjectWithoutValue(){const e=this.toTextObjectEmpty(this.critical?"critical":void 0);return e[$e.NAME]===_r.NAME&&(e[$e.NAME]=Wi.toString(this.type)),e}}var yE;class ki{static isCryptoKeyPair(e){return e&&e.privateKey&&e.publicKey}static isCryptoKey(e){return e&&e.usages&&e.type&&e.algorithm&&e.extractable!==void 0}constructor(){this.items=new Map,this[yE]="CryptoProvider",typeof self<"u"&&typeof crypto<"u"?this.set(ki.DEFAULT,crypto):typeof global<"u"&&global.crypto&&global.crypto.subtle&&this.set(ki.DEFAULT,global.crypto)}clear(){this.items.clear()}delete(e){return this.items.delete(e)}forEach(e,t){return this.items.forEach(e,t)}has(e){return this.items.has(e)}get size(){return this.items.size}entries(){return this.items.entries()}keys(){return this.items.keys()}values(){return this.items.values()}[Symbol.iterator](){return this.items[Symbol.iterator]()}get(e=ki.DEFAULT){const t=this.items.get(e.toLowerCase());if(!t)throw new Error(`Cannot get Crypto by name '${e}'`);return t}set(e,t){if(typeof e=="string"){if(!t)throw new TypeError("Argument 'value' is required");this.items.set(e.toLowerCase(),t)}else this.items.set(ki.DEFAULT,e);return this}}yE=Symbol.toStringTag;ki.DEFAULT="default";const kt=new ki,tq=/^[0-2](?:\.[1-9][0-9]*)+$/;function rq(r){return new RegExp(tq).test(r)}class wE{constructor(e={}){this.items={};for(const t in e)this.register(t,e[t])}get(e){return this.items[e]||null}findId(e){return rq(e)?e:this.get(e)}register(e,t){this.items[e]=t,this.items[t]=e}}const pr=new wE;pr.register("CN","2.5.4.3");pr.register("L","2.5.4.7");pr.register("ST","2.5.4.8");pr.register("O","2.5.4.10");pr.register("OU","2.5.4.11");pr.register("C","2.5.4.6");pr.register("DC","0.9.2342.19200300.100.1.25");pr.register("E","1.2.840.113549.1.9.1");pr.register("G","2.5.4.42");pr.register("I","2.5.4.43");pr.register("SN","2.5.4.4");pr.register("T","2.5.4.12");function nq(r,e){return`\\${ue.ToHex(ue.FromUtf8String(e)).toUpperCase()}`}function iq(r){return r.replace(/([,+"\\<>;])/g,"\\$1").replace(/^([ #])/,"\\$1").replace(/([ ]$)/,"\\$1").replace(/([\r\n\t])/,nq)}class Zr{static isASCII(e){for(let t=0;t<e.length;t++)if(e.charCodeAt(t)>255)return!1;return!0}static isPrintableString(e){return/^[A-Za-z0-9 '()+,-./:=?]*$/g.test(e)}constructor(e,t={}){this.extraNames=new wE,this.asn=new ft;for(const n in t)if(Object.prototype.hasOwnProperty.call(t,n)){const i=t[n];this.extraNames.register(n,i)}typeof e=="string"?this.asn=this.fromString(e):e instanceof ft?this.asn=e:J.isBufferSource(e)?this.asn=Z.parse(e,ft):this.asn=this.fromJSON(e)}getField(e){const t=this.extraNames.findId(e)||pr.findId(e),n=[];for(const i of this.asn)for(const s of i)s.type===t&&n.push(s.value.toString());return n}getName(e){return this.extraNames.get(e)||pr.get(e)}toString(){return this.asn.map(e=>e.map(t=>{const n=this.getName(t.type)||t.type,i=t.value.anyValue?`#${ue.ToHex(t.value.anyValue)}`:iq(t.value.toString());return`${n}=${i}`}).join("+")).join(", ")}toJSON(){var e;const t=[];for(const n of this.asn){const i={};for(const s of n){const o=this.getName(s.type)||s.type;(e=i[o])!==null&&e!==void 0||(i[o]=[]),i[o].push(s.value.anyValue?`#${ue.ToHex(s.value.anyValue)}`:s.value.toString())}t.push(i)}return t}fromString(e){const t=new ft,n=/(\d\.[\d.]*\d|[A-Za-z]+)=((?:"")|(?:".*?[^\\]")|(?:[^,+"\\](?=[,+]|$))|(?:[^,+].*?(?:[^\\][,+]))|(?:))([,+])?/g;let i=null,s=",";for(;i=n.exec(`${e},`);){let[,o,a]=i;const c=a[a.length-1];(c===","||c==="+")&&(a=a.slice(0,a.length-1),i[3]=c);const l=i[3];o=this.getTypeOid(o);const u=this.createAttribute(o,a);s==="+"?t[t.length-1].push(u):t.push(new Zo([u])),s=l}return t}fromJSON(e){const t=new ft;for(const n of e){const i=new Zo;for(const s in n){const o=this.getTypeOid(s),a=n[s];for(const c of a){const l=this.createAttribute(o,c);i.push(l)}}t.push(i)}return t}getTypeOid(e){if(/[\d.]+/.test(e)||(e=this.getName(e)||""),!e)throw new Error(`Cannot get OID for name type '${e}'`);return e}createAttribute(e,t){const n=new Rf({type:e});if(typeof t=="object")for(const i in t)switch(i){case"ia5String":n.value.ia5String=t[i];break;case"utf8String":n.value.utf8String=t[i];break;case"universalString":n.value.universalString=t[i];break;case"bmpString":n.value.bmpString=t[i];break;case"printableString":n.value.printableString=t[i];break}else if(t[0]==="#")n.value.anyValue=ue.FromHex(t.slice(1));else{const i=this.processStringValue(t);e===this.getName("E")||e===this.getName("DC")?n.value.ia5String=i:Zr.isPrintableString(i)?n.value.printableString=i:n.value.utf8String=i}return n}processStringValue(e){const t=/"(.*?[^\\])?"/.exec(e);return t&&(e=t[1]),e.replace(/\\0a/ig,`
`).replace(/\\0d/ig,"\r").replace(/\\0g/ig,"	").replace(/\\(.)/g,"$1")}toArrayBuffer(){return Z.serialize(this.asn)}async getThumbprint(...e){var t;let n,i="SHA-1";return e.length>=1&&!(!((t=e[0])===null||t===void 0)&&t.subtle)?(i=e[0]||i,n=e[1]||kt.get()):n=e[0]||kt.get(),await n.subtle.digest(i,this.toArrayBuffer())}}const bE="Cannot initialize GeneralName from ASN.1 data.",T5=`${bE} Unsupported string format in use.`,sq=`${bE} Value doesn't match to GUID regular expression.`,P5=/^([0-9a-f]{8})-?([0-9a-f]{4})-?([0-9a-f]{4})-?([0-9a-f]{4})-?([0-9a-f]{12})$/i,R5="1.3.6.1.4.1.311.25.1",N5="1.3.6.1.4.1.311.20.2.3",t0="dns",r0="dn",n0="email",i0="ip",s0="url",o0="guid",a0="upn",Nu="id";class Ci extends ji{constructor(...e){let t;if(e.length===2)switch(e[0]){case r0:{const n=new Zr(e[1]).toArrayBuffer(),i=Z.parse(n,ft);t=new Ee({directoryName:i});break}case t0:t=new Ee({dNSName:e[1]});break;case n0:t=new Ee({rfc822Name:e[1]});break;case o0:{const n=new RegExp(P5,"i").exec(e[1]);if(!n)throw new Error("Cannot parse GUID value. Value doesn't match to regular expression");const i=n.slice(1).map((s,o)=>o<3?ue.ToHex(new Uint8Array(ue.FromHex(s)).reverse()):s).join("");t=new Ee({otherName:new rl({typeId:R5,value:Z.serialize(new Le(ue.FromHex(i)))})});break}case i0:t=new Ee({iPAddress:e[1]});break;case Nu:t=new Ee({registeredID:e[1]});break;case a0:{t=new Ee({otherName:new rl({typeId:N5,value:Z.serialize(Lv.toASN(e[1]))})});break}case s0:t=new Ee({uniformResourceIdentifier:e[1]});break;default:throw new Error("Cannot create GeneralName. Unsupported type of the name")}else J.isBufferSource(e[0])?t=Z.parse(e[0],Ee):t=e[0];super(t)}onInit(e){if(e.dNSName!=null)this.type=t0,this.value=e.dNSName;else if(e.rfc822Name!=null)this.type=n0,this.value=e.rfc822Name;else if(e.iPAddress!=null)this.type=i0,this.value=e.iPAddress;else if(e.uniformResourceIdentifier!=null)this.type=s0,this.value=e.uniformResourceIdentifier;else if(e.registeredID!=null)this.type=Nu,this.value=e.registeredID;else if(e.directoryName!=null)this.type=r0,this.value=new Zr(e.directoryName).toString();else if(e.otherName!=null)if(e.otherName.typeId===R5){this.type=o0;const t=Z.parse(e.otherName.value,Le),n=new RegExp(P5,"i").exec(ue.ToHex(t));if(!n)throw new Error(sq);this.value=n.slice(1).map((i,s)=>s<3?ue.ToHex(new Uint8Array(ue.FromHex(i)).reverse()):i).join("-")}else if(e.otherName.typeId===N5)this.type=a0,this.value=Z.parse(e.otherName.value,Ut).toString();else throw new Error(T5);else throw new Error(T5)}toJSON(){return{type:this.type,value:this.value}}toTextObject(){let e;switch(this.type){case r0:case t0:case o0:case i0:case Nu:case a0:case s0:e=this.type.toUpperCase();break;case n0:e="Email";break;default:throw new Error("Unsupported GeneralName type")}let t=this.value;return this.type===Nu&&(t=Wi.toString(t)),new $e(e,void 0,t)}}class Os extends ji{constructor(e){let t;if(e instanceof Gt)t=e;else if(Array.isArray(e)){const n=[];for(const i of e)if(i instanceof Ee)n.push(i);else{const s=Z.parse(new Ci(i.type,i.value).rawData,Ee);n.push(s)}t=new Gt(n)}else if(J.isBufferSource(e))t=Z.parse(e,Gt);else throw new Error("Cannot initialize GeneralNames. Incorrect incoming arguments");super(t)}onInit(e){const t=[];for(const n of e){let i=null;try{i=new Ci(n)}catch{continue}t.push(i)}this.items=t}toJSON(){return this.items.map(e=>e.toJSON())}toTextObject(){const e=super.toTextObjectEmpty();for(const t of this.items){const n=t.toTextObject();let i=e[n[$e.NAME]];Array.isArray(i)||(i=[],e[n[$e.NAME]]=i),i.push(n)}return e}}Os.NAME="GeneralNames";const Tc="-{5}",ul="\\n",oq=`[^${ul}]+`,aq=`${Tc}BEGIN (${oq}(?=${Tc}))${Tc}`,cq=`${Tc}END \\1${Tc}`,oa="\\n",lq=`[^:${ul}]+`,uq=`(?:[^${ul}]+${oa}(?: +[^${ul}]+${oa})*)`,dq="[a-zA-Z0-9=+/]+",hq=`(?:${dq}${oa})+`,D5=`${aq}${oa}(?:((?:${lq}: ${uq})+))?${oa}?(${hq})${cq}`;class Sr{static isPem(e){return typeof e=="string"&&new RegExp(D5,"g").test(e.replace(/\r/g,""))}static decodeWithHeaders(e){e=e.replace(/\r/g,"");const t=new RegExp(D5,"g"),n=[];let i=null;for(;i=t.exec(e);){const s=i[3].replace(new RegExp(`[${ul}]+`,"g"),""),o={type:i[1],headers:[],rawData:ue.FromBase64(s)},a=i[2];if(a){const c=a.split(new RegExp(oa,"g"));let l=null;for(const u of c){const[d,h]=u.split(/:(.*)/);if(h===void 0){if(!l)throw new Error("Cannot parse PEM string. Incorrect header value");l.value+=d.trim()}else l&&o.headers.push(l),l={key:d,value:h.trim()}}l&&o.headers.push(l)}n.push(o)}return n}static decode(e){return this.decodeWithHeaders(e).map(n=>n.rawData)}static decodeFirst(e){const t=this.decode(e);if(!t.length)throw new RangeError("PEM string doesn't contain any objects");return t[0]}static encode(e,t){if(Array.isArray(e)){const n=new Array;return t?e.forEach(i=>{if(!J.isBufferSource(i))throw new TypeError("Cannot encode array of BufferSource in PEM format. Not all items of the array are BufferSource");n.push(this.encodeStruct({type:t,rawData:J.toArrayBuffer(i)}))}):e.forEach(i=>{if(!("type"in i))throw new TypeError("Cannot encode array of PemStruct in PEM format. Not all items of the array are PemStrut");n.push(this.encodeStruct(i))}),n.join(`
`)}else{if(!t)throw new Error("Required argument 'tag' is missed");return this.encodeStruct({type:t,rawData:J.toArrayBuffer(e)})}}static encodeStruct(e){var t;const n=e.type.toLocaleUpperCase(),i=[];if(i.push(`-----BEGIN ${n}-----`),!((t=e.headers)===null||t===void 0)&&t.length){for(const l of e.headers)i.push(`${l.key}: ${l.value}`);i.push("")}const s=ue.ToBase64(e.rawData);let o,a=0;const c=Array();for(;a<s.length&&(s.length-a<64?o=s.substring(a):(o=s.substring(a,a+64),a+=64),o.length!==0);)if(c.push(o),o.length<64)break;return i.push(...c),i.push(`-----END ${n}-----`),i.join(`
`)}}Sr.CertificateTag="CERTIFICATE";Sr.CrlTag="CRL";Sr.CertificateRequestTag="CERTIFICATE REQUEST";Sr.PublicKeyTag="PUBLIC KEY";Sr.PrivateKeyTag="PRIVATE KEY";class ti extends ji{static isAsnEncoded(e){return J.isBufferSource(e)||typeof e=="string"}static toArrayBuffer(e){if(typeof e=="string"){if(Sr.isPem(e))return Sr.decode(e)[0];if(ue.isHex(e))return ue.FromHex(e);if(ue.isBase64(e))return ue.FromBase64(e);if(ue.isBase64Url(e))return ue.FromBase64Url(e);throw new TypeError("Unsupported format of 'raw' argument. Must be one of DER, PEM, HEX, Base64, or Base4Url")}else{const t=J.toUint8Array(e);if(t.length>0&&t[0]===48)return J.toArrayBuffer(e);const n=ue.ToBinary(e);if(Sr.isPem(n))return Sr.decode(n)[0];if(ue.isHex(n))return ue.FromHex(n);if(ue.isBase64(n))return ue.FromBase64(n);if(ue.isBase64Url(n))return ue.FromBase64Url(n);throw new TypeError("Unsupported format of 'raw' argument. Must be one of DER, PEM, HEX, Base64, or Base4Url")}}constructor(...e){ti.isAsnEncoded(e[0])?super(ti.toArrayBuffer(e[0]),e[1]):super(e[0])}toString(e="pem"){switch(e){case"pem":return Sr.encode(this.rawData,this.tag);default:return super.toString(e)}}}class rn extends ti{static async create(e,t=kt.get()){if(e instanceof rn)return e;if(ki.isCryptoKey(e)){if(e.type!=="public")throw new TypeError("Public key is required");const n=await t.subtle.exportKey("spki",e);return new rn(n)}else{if(e.publicKey)return e.publicKey;if(J.isBufferSource(e))return new rn(e);throw new TypeError("Unsupported PublicKeyType")}}constructor(e){ti.isAsnEncoded(e)?super(e,Xr):super(e),this.tag=Sr.PublicKeyTag}async export(...e){let t,n=["verify"],i={hash:"SHA-256",...this.algorithm};e.length>1?(i=e[0]||i,n=e[1]||n,t=e[2]||kt.get()):t=e[0]||kt.get();let s=this.rawData;const o=Z.parse(this.rawData,Xr);return o.algorithm.algorithm===_c&&(s=fq(o,s)),t.subtle.importKey("spki",s,i,!0,n)}onInit(e){const t=Ft.resolve(Bs),n=this.algorithm=t.toWebAlgorithm(e.algorithm);switch(e.algorithm.algorithm){case Rs:{const i=Z.parse(e.subjectPublicKey,H3),s=J.toUint8Array(i.modulus);n.publicExponent=J.toUint8Array(i.publicExponent),n.modulusLength=(s[0]?s:s.slice(1)).byteLength<<3;break}}}async getThumbprint(...e){var t;let n,i="SHA-1";return e.length>=1&&!(!((t=e[0])===null||t===void 0)&&t.subtle)?(i=e[0]||i,n=e[1]||kt.get()):n=e[0]||kt.get(),await n.subtle.digest(i,this.rawData)}async getKeyIdentifier(...e){let t,n="SHA-1";e.length===1?typeof e[0]=="string"?(n=e[0],t=kt.get()):t=e[0]:e.length===2?(n=e[0],t=e[1]):t=kt.get();const i=Z.parse(this.rawData,Xr);return await t.subtle.digest(n,i.subjectPublicKey)}toTextObject(){const e=this.toTextObjectEmpty(),t=Z.parse(this.rawData,Xr);switch(e.Algorithm=Ls.serializeAlgorithm(t.algorithm),t.algorithm.algorithm){case ol:e["EC Point"]=t.subjectPublicKey;break;case Rs:default:e["Raw Data"]=t.subjectPublicKey}return e}}function fq(r,e){return r.algorithm=new ie({algorithm:Rs,parameters:null}),e=Z.serialize(r),e}class dl extends _r{static async create(e,t=!1,n=kt.get()){if("name"in e&&"serialNumber"in e)return new dl(e,t);const s=await(await rn.create(e,n)).getKeyIdentifier(n);return new dl(ue.ToHex(s),t)}constructor(...e){if(J.isBufferSource(e[0]))super(e[0]);else if(typeof e[0]=="string"){const t=new us({keyIdentifier:new A3(ue.FromHex(e[0]))});super(E2,e[1],Z.serialize(t))}else{const t=e[0],n=t.name instanceof Os?Z.parse(t.name.rawData,Gt):t.name,i=new us({authorityCertIssuer:n,authorityCertSerialNumber:ue.FromHex(t.serialNumber)});super(E2,e[1],Z.serialize(i))}}onInit(e){super.onInit(e);const t=Z.parse(e.extnValue,us);t.keyIdentifier&&(this.keyId=ue.ToHex(t.keyIdentifier)),(t.authorityCertIssuer||t.authorityCertSerialNumber)&&(this.certId={name:t.authorityCertIssuer||[],serialNumber:t.authorityCertSerialNumber?ue.ToHex(t.authorityCertSerialNumber):""})}toTextObject(){const e=this.toTextObjectWithoutValue(),t=Z.parse(this.value,us);return t.authorityCertIssuer&&(e["Authority Issuer"]=new Os(t.authorityCertIssuer).toTextObject()),t.authorityCertSerialNumber&&(e["Authority Serial Number"]=t.authorityCertSerialNumber),t.keyIdentifier&&(e[""]=t.keyIdentifier),e}}dl.NAME="Authority Key Identifier";class j3 extends _r{constructor(...e){if(J.isBufferSource(e[0])){super(e[0]);const t=Z.parse(this.value,Gd);this.ca=t.cA,this.pathLength=t.pathLenConstraint}else{const t=new Gd({cA:e[0],pathLenConstraint:e[1]});super(Mv,e[2],Z.serialize(t)),this.ca=e[0],this.pathLength=e[1]}}toTextObject(){const e=this.toTextObjectWithoutValue();return this.ca&&(e.CA=this.ca),this.pathLength!==void 0&&(e["Path Length"]=this.pathLength),e}}j3.NAME="Basic Constraints";var B5;(function(r){r.serverAuth="1.3.6.1.5.5.7.3.1",r.clientAuth="1.3.6.1.5.5.7.3.2",r.codeSigning="1.3.6.1.5.5.7.3.3",r.emailProtection="1.3.6.1.5.5.7.3.4",r.timeStamping="1.3.6.1.5.5.7.3.8",r.ocspSigning="1.3.6.1.5.5.7.3.9"})(B5||(B5={}));class vE extends _r{constructor(...e){if(J.isBufferSource(e[0])){super(e[0]);const t=Z.parse(this.value,Zd);this.usages=t.map(n=>n)}else{const t=new Zd(e[0]);super(Fv,e[1],Z.serialize(t)),this.usages=e[0]}}toTextObject(){const e=this.toTextObjectWithoutValue();return e[""]=this.usages.map(t=>Wi.toString(t)).join(", "),e}}vE.NAME="Extended Key Usages";var L5;(function(r){r[r.digitalSignature=1]="digitalSignature",r[r.nonRepudiation=2]="nonRepudiation",r[r.keyEncipherment=4]="keyEncipherment",r[r.dataEncipherment=8]="dataEncipherment",r[r.keyAgreement=16]="keyAgreement",r[r.keyCertSign=32]="keyCertSign",r[r.cRLSign=64]="cRLSign",r[r.encipherOnly=128]="encipherOnly",r[r.decipherOnly=256]="decipherOnly"})(L5||(L5={}));class EE extends _r{constructor(...e){if(J.isBufferSource(e[0])){super(e[0]);const t=Z.parse(this.value,e0);this.usages=t.toNumber()}else{const t=new e0(e[0]);super(zv,e[1],Z.serialize(t)),this.usages=e[0]}}toTextObject(){const e=this.toTextObjectWithoutValue(),t=Z.parse(this.value,e0);return e[""]=t.toJSON().join(", "),e}}EE.NAME="Key Usages";class r1 extends _r{static async create(e,t=!1,n=kt.get()){const s=await(await rn.create(e,n)).getKeyIdentifier(n);return new r1(ue.ToHex(s),t)}constructor(...e){if(J.isBufferSource(e[0])){super(e[0]);const t=Z.parse(this.value,Di);this.keyId=ue.ToHex(t)}else{const t=typeof e[0]=="string"?ue.FromHex(e[0]):e[0],n=new Di(t);super(Wv,e[1],Z.serialize(n)),this.keyId=ue.ToHex(t)}}toTextObject(){const e=this.toTextObjectWithoutValue(),t=Z.parse(this.value,Di);return e[""]=t,e}}r1.NAME="Subject Key Identifier";class SE extends _r{constructor(...e){J.isBufferSource(e[0])?super(e[0]):super(Kv,e[1],new Os(e[0]||[]).rawData)}onInit(e){super.onInit(e);const t=Z.parse(e.extnValue,O2);this.names=new Os(t)}toTextObject(){const e=this.toTextObjectWithoutValue(),t=this.names.toTextObject();for(const n in t)e[n]=t[n];return e}}SE.NAME="Subject Alternative Name";class Tr{static register(e,t){this.items.set(e,t)}static create(e){const t=new _r(e),n=this.items.get(t.type);return n?new n(e):t}}Tr.items=new Map;class xE extends _r{constructor(...e){var t;if(J.isBufferSource(e[0])){super(e[0]);const n=Z.parse(this.value,Qd);this.policies=n.map(i=>i.policyIdentifier)}else{const n=e[0],i=(t=e[1])!==null&&t!==void 0?t:!1,s=new Qd(n.map(o=>new Df({policyIdentifier:o})));super($v,i,Z.serialize(s)),this.policies=n}}toTextObject(){const e=this.toTextObjectWithoutValue();return e.Policy=this.policies.map(t=>new $e("",{},Wi.toString(t))),e}}xE.NAME="Certificate Policies";Tr.register($v,xE);class AE extends _r{constructor(...e){var t;if(J.isBufferSource(e[0]))super(e[0]);else if(Array.isArray(e[0])&&typeof e[0][0]=="string"){const i=e[0].map(o=>new Ea({distributionPoint:new Is({fullName:[new Ee({uniformResourceIdentifier:o})]})})),s=new To(i);super(C2,e[1],Z.serialize(s))}else{const n=new To(e[0]);super(C2,e[1],Z.serialize(n))}(t=this.distributionPoints)!==null&&t!==void 0||(this.distributionPoints=[])}onInit(e){super.onInit(e);const t=Z.parse(e.extnValue,To);this.distributionPoints=t}toTextObject(){const e=this.toTextObjectWithoutValue();return e["Distribution Point"]=this.distributionPoints.map(t=>{var n;const i={};return t.distributionPoint&&(i[""]=(n=t.distributionPoint.fullName)===null||n===void 0?void 0:n.map(s=>new Ci(s).toString()).join(", ")),t.reasons&&(i.Reasons=t.reasons.toString()),t.cRLIssuer&&(i["CRL Issuer"]=t.cRLIssuer.map(s=>s.toString()).join(", ")),i}),e}}AE.NAME="CRL Distribution Points";class kE extends _r{constructor(...e){var t,n,i,s;if(J.isBufferSource(e[0]))super(e[0]);else if(e[0]instanceof wo){const o=new wo(e[0]);super(v2,e[1],Z.serialize(o))}else{const o=e[0],a=new wo;Bu(a,o,w6,"ocsp"),Bu(a,o,b6,"caIssuers"),Bu(a,o,v6,"timeStamping"),Bu(a,o,E6,"caRepository"),super(v2,e[1],Z.serialize(a))}(t=this.ocsp)!==null&&t!==void 0||(this.ocsp=[]),(n=this.caIssuers)!==null&&n!==void 0||(this.caIssuers=[]),(i=this.timeStamping)!==null&&i!==void 0||(this.timeStamping=[]),(s=this.caRepository)!==null&&s!==void 0||(this.caRepository=[])}onInit(e){super.onInit(e),this.ocsp=[],this.caIssuers=[],this.timeStamping=[],this.caRepository=[],Z.parse(e.extnValue,wo).forEach(n=>{switch(n.accessMethod){case w6:this.ocsp.push(new Ci(n.accessLocation));break;case b6:this.caIssuers.push(new Ci(n.accessLocation));break;case v6:this.timeStamping.push(new Ci(n.accessLocation));break;case E6:this.caRepository.push(new Ci(n.accessLocation));break}})}toTextObject(){const e=this.toTextObjectWithoutValue();return this.ocsp.length&&Du(e,"OCSP",this.ocsp),this.caIssuers.length&&Du(e,"CA Issuers",this.caIssuers),this.timeStamping.length&&Du(e,"Time Stamping",this.timeStamping),this.caRepository.length&&Du(e,"CA Repository",this.caRepository),e}}kE.NAME="Authority Info Access";function Du(r,e,t){if(t.length===1)r[e]=t[0].toTextObject();else{const n=new $e("");t.forEach((i,s)=>{const o=i.toTextObject(),a=`${o[$e.NAME]} ${s+1}`;let c=n[a];Array.isArray(c)||(c=[],n[a]=c),c.push(o)}),r[e]=n}}function Bu(r,e,t,n){const i=e[n];i&&(Array.isArray(i)?i:[i]).forEach(o=>{typeof o=="string"&&(o=new Ci("url",o)),r.push(new Dl({accessMethod:t,accessLocation:Z.parse(o.rawData,Ee)}))})}class CE extends _r{constructor(...e){J.isBufferSource(e[0])?super(e[0]):super(Vv,e[1],new Os(e[0]||[]).rawData)}onInit(e){super.onInit(e);const t=Z.parse(e.extnValue,Gt);this.names=new Os(t)}toTextObject(){const e=this.toTextObjectWithoutValue(),t=this.names.toTextObject();for(const n in t)e[n]=t[n];return e}}CE.NAME="Issuer Alternative Name";class _a extends ji{constructor(...e){let t;if(J.isBufferSource(e[0]))t=J.toArrayBuffer(e[0]);else{const n=e[0],i=Array.isArray(e[1])?e[1].map(s=>J.toArrayBuffer(s)):[];t=Z.serialize(new Zn({type:n,values:i}))}super(t,Zn)}onInit(e){this.type=e.type,this.values=e.values}toTextObject(){const e=this.toTextObjectWithoutValue();return e.Value=this.values.map(t=>new $e("",{"":t})),e}toTextObjectWithoutValue(){const e=this.toTextObjectEmpty();return e[$e.NAME]===_a.NAME&&(e[$e.NAME]=Wi.toString(this.type)),e}}_a.NAME="Attribute";class IE extends _a{constructor(...e){var t;if(J.isBufferSource(e[0]))super(e[0]);else{const n=new Sh({printableString:e[0]});super(pE,[Z.serialize(n)])}(t=this.password)!==null&&t!==void 0||(this.password="")}onInit(e){if(super.onInit(e),this.values[0]){const t=Z.parse(this.values[0],Sh);this.password=t.toString()}}toTextObject(){const e=this.toTextObjectWithoutValue();return e[$e.VALUE]=this.password,e}}IE.NAME="Challenge Password";class G3 extends _a{constructor(...e){var t;if(J.isBufferSource(e[0]))super(e[0]);else{const n=e[0],i=new Vi;for(const s of n)i.push(Z.parse(s.rawData,Mr));super(W3,[Z.serialize(i)])}(t=this.items)!==null&&t!==void 0||(this.items=[])}onInit(e){if(super.onInit(e),this.values[0]){const t=Z.parse(this.values[0],Vi);this.items=t.map(n=>Tr.create(Z.serialize(n)))}}toTextObject(){const e=this.toTextObjectWithoutValue(),t=this.items.map(n=>n.toTextObject());for(const n of t)e[n[$e.NAME]]=n;return e}}G3.NAME="Extensions";class n1{static register(e,t){this.items.set(e,t)}static create(e){const t=new _a(e),n=this.items.get(t.type);return n?new n(e):t}}n1.items=new Map;const Wl="crypto.signatureFormatter";class pq{toAsnSignature(e,t){return J.toArrayBuffer(t)}toWebSignature(e,t){return J.toArrayBuffer(t)}}var ju;let Cp=ju=class{static createPssParams(e,t){const n=ju.getHashAlgorithm(e);return n?new Ds({hashAlgorithm:n,maskGenAlgorithm:new ie({algorithm:jf,parameters:Z.serialize(n)}),saltLength:t}):null}static getHashAlgorithm(e){const t=Ft.resolve(Bs);return typeof e=="string"?t.toAsnAlgorithm({name:e}):typeof e=="object"&&e&&"name"in e?t.toAsnAlgorithm(e):null}toAsnAlgorithm(e){switch(e.name.toLowerCase()){case"rsassa-pkcs1-v1_5":if("hash"in e){let t;if(typeof e.hash=="string")t=e.hash;else if(e.hash&&typeof e.hash=="object"&&"name"in e.hash&&typeof e.hash.name=="string")t=e.hash.name.toUpperCase();else throw new Error("Cannot get hash algorithm name");switch(t.toLowerCase()){case"sha-1":return new ie({algorithm:hh,parameters:null});case"sha-256":return new ie({algorithm:np,parameters:null});case"sha-384":return new ie({algorithm:fh,parameters:null});case"sha-512":return new ie({algorithm:ph,parameters:null})}}else return new ie({algorithm:Rs,parameters:null});break;case"rsa-pss":if("hash"in e){if(!("saltLength"in e&&typeof e.saltLength=="number"))throw new Error("Cannot get 'saltLength' from 'alg' argument");const t=ju.createPssParams(e.hash,e.saltLength);if(!t)throw new Error("Cannot create PSS parameters");return new ie({algorithm:_c,parameters:Z.serialize(t)})}else return new ie({algorithm:_c,parameters:null})}return null}toWebAlgorithm(e){switch(e.algorithm){case Rs:return{name:"RSASSA-PKCS1-v1_5"};case hh:return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-1"}};case np:return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}};case fh:return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-384"}};case ph:return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-512"}};case _c:if(e.parameters){const t=Z.parse(e.parameters,Ds);return{name:"RSA-PSS",hash:Ft.resolve(Bs).toWebAlgorithm(t.hashAlgorithm),saltLength:t.saltLength}}else return{name:"RSA-PSS"}}return null}};Cp=ju=g([Xf()],Cp);Ft.registerSingleton(Kl,Cp);let Ip=class{toAsnAlgorithm(e){switch(e.name.toLowerCase()){case"sha-1":return new ie({algorithm:gh});case"sha-256":return new ie({algorithm:mh});case"sha-384":return new ie({algorithm:yh});case"sha-512":return new ie({algorithm:wh})}return null}toWebAlgorithm(e){switch(e.algorithm){case gh:return{name:"SHA-1"};case mh:return{name:"SHA-256"};case yh:return{name:"SHA-384"};case wh:return{name:"SHA-512"}}return null}};Ip=g([Xf()],Ip);Ft.registerSingleton(Kl,Ip);class Dr{addPadding(e,t){const n=J.toUint8Array(t),i=new Uint8Array(e);return i.set(n,e-n.length),i.buffer}removePadding(e,t=!1){let n=J.toUint8Array(e);for(let i=0;i<n.length;i++)if(n[i]){n=n.slice(i);break}if(t&&n[0]>127){const i=new Uint8Array(n.length+1);return i.set(n,1),i.buffer}return n.buffer}toAsnSignature(e,t){if(e.name==="ECDSA"){const n=e.namedCurve,i=Dr.namedCurveSize.get(n)||Dr.defaultNamedCurveSize,s=new dh,o=J.toUint8Array(t);return s.r=this.removePadding(o.slice(0,i),!0),s.s=this.removePadding(o.slice(i,i+i),!0),Z.serialize(s)}return null}toWebSignature(e,t){if(e.name==="ECDSA"){const n=Z.parse(t,dh),i=e.namedCurve,s=Dr.namedCurveSize.get(i)||Dr.defaultNamedCurveSize,o=this.addPadding(s,this.removePadding(n.r)),a=this.addPadding(s,this.removePadding(n.s));return zO(o,a)}return null}}Dr.namedCurveSize=new Map;Dr.defaultNamedCurveSize=32;const c0="1.3.101.110",O5="1.3.101.111",l0="1.3.101.112",M5="1.3.101.113";let _p=class{toAsnAlgorithm(e){let t=null;switch(e.name.toLowerCase()){case"ed25519":t=l0;break;case"x25519":t=c0;break;case"eddsa":switch(e.namedCurve.toLowerCase()){case"ed25519":t=l0;break;case"ed448":t=M5;break}break;case"ecdh-es":switch(e.namedCurve.toLowerCase()){case"x25519":t=c0;break;case"x448":t=O5;break}}return t?new ie({algorithm:t}):null}toWebAlgorithm(e){switch(e.algorithm){case l0:return{name:"Ed25519"};case M5:return{name:"EdDSA",namedCurve:"Ed448"};case c0:return{name:"X25519"};case O5:return{name:"ECDH-ES",namedCurve:"X448"}}return null}};_p=g([Xf()],_p);Ft.registerSingleton(Kl,_p);var Qa,Xa,Za,Ja,ec,tc,rc,uo;class gq extends ti{get subjectName(){return xe(this,Xa,"f")||nt(this,Xa,new Zr(this.asn.certificationRequestInfo.subject),"f"),xe(this,Xa,"f")}get subject(){return xe(this,Za,"f")||nt(this,Za,this.subjectName.toString(),"f"),xe(this,Za,"f")}get signatureAlgorithm(){if(!xe(this,Ja,"f")){const e=Ft.resolve(Bs);nt(this,Ja,e.toWebAlgorithm(this.asn.signatureAlgorithm),"f")}return xe(this,Ja,"f")}get signature(){return xe(this,ec,"f")||nt(this,ec,this.asn.signature,"f"),xe(this,ec,"f")}get publicKey(){return xe(this,tc,"f")||nt(this,tc,new rn(this.asn.certificationRequestInfo.subjectPKInfo),"f"),xe(this,tc,"f")}get attributes(){return xe(this,rc,"f")||nt(this,rc,this.asn.certificationRequestInfo.attributes.map(e=>n1.create(Z.serialize(e))),"f"),xe(this,rc,"f")}get extensions(){if(!xe(this,uo,"f")){nt(this,uo,[],"f");const e=this.getAttribute(W3);e instanceof G3&&nt(this,uo,e.items,"f")}return xe(this,uo,"f")}get tbs(){return xe(this,Qa,"f")||nt(this,Qa,this.asn.certificationRequestInfoRaw||Z.serialize(this.asn.certificationRequestInfo),"f"),xe(this,Qa,"f")}constructor(e){const t=ti.isAsnEncoded(e)?[e,cl]:[e];super(t[0],t[1]),Qa.set(this,void 0),Xa.set(this,void 0),Za.set(this,void 0),Ja.set(this,void 0),ec.set(this,void 0),tc.set(this,void 0),rc.set(this,void 0),uo.set(this,void 0),this.tag=Sr.CertificateRequestTag}onInit(e){}getAttribute(e){for(const t of this.attributes)if(t.type===e)return t;return null}getAttributes(e){return this.attributes.filter(t=>t.type===e)}getExtension(e){for(const t of this.extensions)if(t.type===e)return t;return null}getExtensions(e){return this.extensions.filter(t=>t.type===e)}async verify(e=kt.get()){const t={...this.publicKey.algorithm,...this.signatureAlgorithm},n=await this.publicKey.export(t,["verify"],e),i=Ft.resolveAll(Wl).reverse();let s=null;for(const a of i)if(s=a.toWebSignature(t,this.signature),s)break;if(!s)throw Error("Cannot convert WebCrypto signature value to ASN.1 format");return await e.subtle.verify(this.signatureAlgorithm,n,s,this.tbs)}toTextObject(){const e=this.toTextObjectEmpty(),t=Z.parse(this.rawData,cl),n=t.certificationRequestInfo,i=new $e("",{Version:`${_s[n.version]} (${n.version})`,Subject:this.subject,"Subject Public Key Info":this.publicKey});if(this.attributes.length){const s=new $e("");for(const o of this.attributes){const a=o.toTextObject();s[a[$e.NAME]]=a}i.Attributes=s}return e.Data=i,e.Signature=new $e("",{Algorithm:Ls.serializeAlgorithm(t.signatureAlgorithm),"":t.signature}),e}}Qa=new WeakMap,Xa=new WeakMap,Za=new WeakMap,Ja=new WeakMap,ec=new WeakMap,tc=new WeakMap,rc=new WeakMap,uo=new WeakMap;gq.NAME="PKCS#10 Certificate Request";var nc,ic,sc,oc,ac,cc,lc,uc,dc,hc,ho,fc;class Y3 extends ti{get publicKey(){return xe(this,fc,"f")||nt(this,fc,new rn(this.asn.tbsCertificate.subjectPublicKeyInfo),"f"),xe(this,fc,"f")}get serialNumber(){if(!xe(this,ic,"f")){const e=this.asn.tbsCertificate;let t=new Uint8Array(e.serialNumber);t.length>1&&t[0]===0&&t[1]>127&&(t=t.slice(1)),nt(this,ic,ue.ToHex(t),"f")}return xe(this,ic,"f")}get subjectName(){return xe(this,sc,"f")||nt(this,sc,new Zr(this.asn.tbsCertificate.subject),"f"),xe(this,sc,"f")}get subject(){return xe(this,oc,"f")||nt(this,oc,this.subjectName.toString(),"f"),xe(this,oc,"f")}get issuerName(){return xe(this,ac,"f")||nt(this,ac,new Zr(this.asn.tbsCertificate.issuer),"f"),xe(this,ac,"f")}get issuer(){return xe(this,cc,"f")||nt(this,cc,this.issuerName.toString(),"f"),xe(this,cc,"f")}get notBefore(){if(!xe(this,lc,"f")){const e=this.asn.tbsCertificate.validity.notBefore.utcTime||this.asn.tbsCertificate.validity.notBefore.generalTime;if(!e)throw new Error("Cannot get 'notBefore' value");nt(this,lc,e,"f")}return xe(this,lc,"f")}get notAfter(){if(!xe(this,uc,"f")){const e=this.asn.tbsCertificate.validity.notAfter.utcTime||this.asn.tbsCertificate.validity.notAfter.generalTime;if(!e)throw new Error("Cannot get 'notAfter' value");nt(this,uc,e,"f")}return xe(this,uc,"f")}get signatureAlgorithm(){if(!xe(this,dc,"f")){const e=Ft.resolve(Bs);nt(this,dc,e.toWebAlgorithm(this.asn.signatureAlgorithm),"f")}return xe(this,dc,"f")}get signature(){return xe(this,hc,"f")||nt(this,hc,this.asn.signatureValue,"f"),xe(this,hc,"f")}get extensions(){return xe(this,ho,"f")||(nt(this,ho,[],"f"),this.asn.tbsCertificate.extensions&&nt(this,ho,this.asn.tbsCertificate.extensions.map(e=>Tr.create(Z.serialize(e))),"f")),xe(this,ho,"f")}get tbs(){return xe(this,nc,"f")||nt(this,nc,this.asn.tbsCertificateRaw||Z.serialize(this.asn.tbsCertificate),"f"),xe(this,nc,"f")}constructor(e){const t=ti.isAsnEncoded(e)?[e,Ts]:[e];super(t[0],t[1]),nc.set(this,void 0),ic.set(this,void 0),sc.set(this,void 0),oc.set(this,void 0),ac.set(this,void 0),cc.set(this,void 0),lc.set(this,void 0),uc.set(this,void 0),dc.set(this,void 0),hc.set(this,void 0),ho.set(this,void 0),fc.set(this,void 0),this.tag=Sr.CertificateTag}onInit(e){}getExtension(e){for(const t of this.extensions)if(typeof e=="string"){if(t.type===e)return t}else if(t instanceof e)return t;return null}getExtensions(e){return this.extensions.filter(t=>typeof e=="string"?t.type===e:t instanceof e)}async verify(e={},t=kt.get()){let n,i;const s=e.publicKey;try{if(!s)n={...this.publicKey.algorithm,...this.signatureAlgorithm},i=await this.publicKey.export(n,["verify"],t);else if("publicKey"in s)n={...s.publicKey.algorithm,...this.signatureAlgorithm},i=await s.publicKey.export(n,["verify"],t);else if(s instanceof rn)n={...s.algorithm,...this.signatureAlgorithm},i=await s.export(n,["verify"],t);else if(J.isBufferSource(s)){const l=new rn(s);n={...l.algorithm,...this.signatureAlgorithm},i=await l.export(n,["verify"],t)}else n={...s.algorithm,...this.signatureAlgorithm},i=s}catch{return!1}const o=Ft.resolveAll(Wl).reverse();let a=null;for(const l of o)if(a=l.toWebSignature(n,this.signature),a)break;if(!a)throw Error("Cannot convert ASN.1 signature value to WebCrypto format");const c=await t.subtle.verify(this.signatureAlgorithm,i,a,this.tbs);if(e.signatureOnly)return c;{const u=(e.date||new Date).getTime();return c&&this.notBefore.getTime()<u&&u<this.notAfter.getTime()}}async getThumbprint(...e){let t,n="SHA-1";return e[0]&&(e[0].subtle?t=e[0]:(n=e[0]||n,t=e[1])),t??(t=kt.get()),await t.subtle.digest(n,this.rawData)}async isSelfSigned(e=kt.get()){return this.subject===this.issuer&&await this.verify({signatureOnly:!0},e)}toTextObject(){const e=this.toTextObjectEmpty(),t=Z.parse(this.rawData,Ts),n=t.tbsCertificate,i=new $e("",{Version:`${_s[n.version]} (${n.version})`,"Serial Number":n.serialNumber,"Signature Algorithm":Ls.serializeAlgorithm(n.signature),Issuer:this.issuer,Validity:new $e("",{"Not Before":n.validity.notBefore.getTime(),"Not After":n.validity.notAfter.getTime()}),Subject:this.subject,"Subject Public Key Info":this.publicKey});if(n.issuerUniqueID&&(i["Issuer Unique ID"]=n.issuerUniqueID),n.subjectUniqueID&&(i["Subject Unique ID"]=n.subjectUniqueID),this.extensions.length){const s=new $e("");for(const o of this.extensions){const a=o.toTextObject();s[a[$e.NAME]]=a}i.Extensions=s}return e.Data=i,e.Signature=new $e("",{Algorithm:Ls.serializeAlgorithm(t.signatureAlgorithm),"":t.signatureValue}),e}}nc=new WeakMap,ic=new WeakMap,sc=new WeakMap,oc=new WeakMap,ac=new WeakMap,cc=new WeakMap,lc=new WeakMap,uc=new WeakMap,dc=new WeakMap,hc=new WeakMap,ho=new WeakMap,fc=new WeakMap;Y3.NAME="Certificate";function mq(r,e=kt.get()){const t=J.toUint8Array(ue.FromHex(r||""));let n=t&&t.length&&t.some(s=>s>0)?new Uint8Array(t):void 0;n||(n=e.getRandomValues(new Uint8Array(16)));let i=0;for(;i<n.length-1&&n[i]===0;)i++;if(n=n.slice(i),n[0]>127){const s=new Uint8Array(n.length+1);s[0]=0,s.set(n,1),n=s}return n.buffer}class yq{static async createSelfSigned(e,t=kt.get()){if(!e.keys.privateKey)throw new Error("Bad field 'keys' in 'params' argument. 'privateKey' is empty");if(!e.keys.publicKey)throw new Error("Bad field 'keys' in 'params' argument. 'publicKey' is empty");return this.create({serialNumber:e.serialNumber,subject:e.name,issuer:e.name,notBefore:e.notBefore,notAfter:e.notAfter,publicKey:e.keys.publicKey,signingKey:e.keys.privateKey,signingAlgorithm:e.signingAlgorithm,extensions:e.extensions},t)}static async create(e,t=kt.get()){var n;let i;e.publicKey instanceof rn?i=e.publicKey.rawData:"publicKey"in e.publicKey?i=e.publicKey.publicKey.rawData:J.isBufferSource(e.publicKey)?i=e.publicKey:i=await t.subtle.exportKey("spki",e.publicKey);const s=mq(e.serialNumber,t),o=e.notBefore||new Date,a=e.notAfter||new Date(o.getTime()+31536e6),c=new Ts({tbsCertificate:new Ir({version:_s.v3,serialNumber:s,validity:new Bl({notBefore:o,notAfter:a}),extensions:new Vi(((n=e.extensions)===null||n===void 0?void 0:n.map(p=>Z.parse(p.rawData,Mr)))||[]),subjectPublicKeyInfo:Z.parse(i,Xr)})});if(e.subject){const p=e.subject instanceof Zr?e.subject:new Zr(e.subject);c.tbsCertificate.subject=Z.parse(p.toArrayBuffer(),ft)}if(e.issuer){const p=e.issuer instanceof Zr?e.issuer:new Zr(e.issuer);c.tbsCertificate.issuer=Z.parse(p.toArrayBuffer(),ft)}const l={hash:"SHA-256"},u="signingKey"in e?{...l,...e.signingAlgorithm,...e.signingKey.algorithm}:{...l,...e.signingAlgorithm},d=Ft.resolve(Bs);c.tbsCertificate.signature=c.signatureAlgorithm=d.toAsnAlgorithm(u);const h=Z.serialize(c.tbsCertificate),f="signingKey"in e?await t.subtle.sign(u,e.signingKey,h):e.signature,y=Ft.resolveAll(Wl).reverse();let m=null;for(const p of y)if(m=p.toAsnSignature(u,f),m)break;if(!m)throw Error("Cannot convert ASN.1 signature value to WebCrypto format");return c.signatureValue=m,new Y3(Z.serialize(c))}}var $5;(function(r){r[r.unspecified=0]="unspecified",r[r.keyCompromise=1]="keyCompromise",r[r.cACompromise=2]="cACompromise",r[r.affiliationChanged=3]="affiliationChanged",r[r.superseded=4]="superseded",r[r.cessationOfOperation=5]="cessationOfOperation",r[r.certificateHold=6]="certificateHold",r[r.removeFromCRL=8]="removeFromCRL",r[r.privilegeWithdrawn=9]="privilegeWithdrawn",r[r.aACompromise=10]="aACompromise"})($5||($5={}));Tr.register(Mv,j3);Tr.register(Fv,vE);Tr.register(zv,EE);Tr.register(Wv,r1);Tr.register(E2,dl);Tr.register(Kv,SE);Tr.register(C2,AE);Tr.register(v2,kE);Tr.register(Vv,CE);n1.register(pE,IE);n1.register(W3,G3);Ft.registerSingleton(Wl,pq);Ft.registerSingleton(Wl,Dr);Dr.namedCurveSize.set("P-256",32);Dr.namedCurveSize.set("K-256",32);Dr.namedCurveSize.set("P-384",48);Dr.namedCurveSize.set("P-521",66);class wq extends Qe{async listen(){throw new Oz("WebRTCTransport.createListener")}getAddrs(){return[]}updateAnnounceAddrs(){}async close(){}}const _E=Object.values(rd).map(r=>r.decoder).reduce((r,e)=>r.or(e)),bq=/^a=fingerprint:(?:\w+-[0-9]+)\s(?<fingerprint>(:?[0-9a-fA-F]{2})+)$/m;function vq(r){return r?.match(bq)?.groups?.fingerprint}function TE(r){const t=r.getComponents().find(n=>n.code===$o)?.value;if(t===void 0||t==="")throw new H(`Couldn't find a certhash component of multiaddr: ${r.toString()}`);return t}function Eq(r){return Zt(_E.decode(r))}function Sq(r){const e=Eq(TE(r)),t=Aq(e.code),n=e.digest.reduce((s,o)=>s+o.toString(16).padStart(2,"0"),""),i=n.match(/.{1,2}/g);if(i==null)throw new Lz(n,r.toString());return`${t} ${i.join(":").toUpperCase()}`}function xq(r){const e=r.split(":").map(i=>parseInt(i,16)),t=Uint8Array.from(e),n=qi(Et.code,t);return be(`/certhash/${Fh.encode(n.bytes)}`)}function Aq(r){switch(r){case 17:return"sha-1";case 18:return"sha-256";case 19:return"sha-512";default:throw new Mz(r)}}function kq(r,e){const{host:t,port:n,type:i}=Ne(r);if(i!=="ip4"&&i!=="ip6")throw new H(`Multiaddr ${r} was not an IPv4 or IPv6 address`);const s=Sq(r);return{type:"answer",sdp:`v=0
o=- 0 0 IN IP${i==="ip4"?4:6} ${t}
s=-
t=0 0
a=ice-lite
m=application ${n} UDP/DTLS/SCTP webrtc-datachannel
c=IN IP${i==="ip4"?4:6} ${t}
a=mid:0
a=ice-options:ice2
a=ice-ufrag:${e}
a=ice-pwd:${e}
a=fingerprint:${s}
a=setup:passive
a=sctp-port:5000
a=max-message-size:${Tf}
a=candidate:1467250027 1 UDP 1467250027 ${t} ${n} typ host
a=end-of-candidates
`}}function Cq(r,e){const{host:t,port:n,type:i}=Ne(r);if(i!=="ip4"&&i!=="ip6")throw new H(`Multiaddr ${r} was not an IPv4 or IPv6 address`);return{type:"offer",sdp:`v=0
o=- 0 0 IN IP${i==="ip4"?4:6} ${t}
s=-
c=IN IP${i==="ip4"?4:6} ${t}
t=0 0
a=ice-options:ice2,trickle
m=application ${n} UDP/DTLS/SCTP webrtc-datachannel
a=mid:0
a=setup:active
a=ice-ufrag:${e}
a=ice-pwd:${e}
a=fingerprint:sha-256 00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00
a=sctp-port:5000
a=max-message-size:${Tf}
a=candidate:1467250027 1 UDP 1467250027 ${t} ${n} typ host
a=end-of-candidates
`}}function U5(r,e){if(r.sdp===void 0)throw new H("Can't munge a missing SDP");const t=r.sdp.includes(`\r
`)?`\r
`:`
`;try{r.sdp=r.sdp.replace(/\na=ice-ufrag:[^\n]*\n/,`
a=ice-ufrag:`+e+t).replace(/\na=ice-pwd:[^\n]*\n/,`
a=ice-pwd:`+e+t)}catch{}return r}const u0=W("libp2p-webrtc-noise:");function Iq(r,e,t){const n=r.trim().toLowerCase().replaceAll(":",""),i=W(n,"hex"),s=qi(Et.code,i),o=_E.decode(TE(e)),a=u0.byteLength+s.bytes.byteLength+o.byteLength;return Ot(t==="server"?[u0,o,s.bytes]:[u0,s.bytes,o],a)}const _q=Pv?"iceconnectionstatechange":"connectionstatechange";function Tq(r,e){return r.role==="server"}async function Pq(r,e,t,n){const i=r.createDataChannel("",{negotiated:!0,id:0});try{if(n.role==="client"){n.log.trace("client creating local offer");const d=await r.createOffer();n.log.trace("client created local offer %s",d.sdp);const h=U5(d,t);n.log.trace("client setting local offer %s",h.sdp),await r.setLocalDescription(h);const f=kq(n.remoteAddr,t);n.log.trace("client setting server description %s",f.sdp),await r.setRemoteDescription(f)}else{const d=Cq(n.remoteAddr,t);n.log.trace("server setting client %s %s",d.type,d.sdp),await r.setRemoteDescription(d),n.log.trace("server creating local answer");const h=await r.createAnswer();n.log.trace("server created local answer");const f=U5(h,t);n.log.trace("server setting local description %s",h.sdp),await r.setLocalDescription(f)}if(i.readyState!=="open"&&(n.log.trace("%s wait for handshake channel to open, starting status %s",n.role,i.readyState),await bt(i,"open",n)),n.log.trace("%s handshake channel opened",n.role),Tq(n,r)){const d=r.remoteFingerprint()?.value??"";n.remoteAddr=n.remoteAddr.encapsulate(xq(d))}const s=vq(r.localDescription?.sdp);if(s==null)throw new Nl("Could not get fingerprint from local description sdp");n.log.trace("%s performing noise handshake",n.role);const o=Iq(s,n.remoteAddr,n.role),a=d3({prologueBytes:o})(n),c=f2({channel:i,direction:"outbound",isHandshake:!0,log:n.log,...n.dataChannel??{}}),l=p2({peerConnection:r,remoteAddr:n.remoteAddr,metrics:n.events,direction:n.role==="client"?"outbound":"inbound",log:n.logger.forComponent("libp2p:webrtc-direct:connection")});if(r.addEventListener(_q,()=>{switch(r.connectionState){case"failed":case"disconnected":case"closed":l.close().catch(d=>{n.log.error("error closing connection - %e",d),l.abort(d)});break;default:break}}),n.events?.increment({peer_connection:!0}),n.role==="client"){n.log.trace("%s secure inbound",n.role);const d=await a.secureInbound(c,{remotePeer:n.remotePeer,signal:n.signal,skipStreamMuxerNegotiation:!0});return n.log.trace("%s upgrade outbound",n.role),await n.upgrader.upgradeOutbound(l,{skipProtection:!0,skipEncryption:!0,remotePeer:d.remotePeer,muxerFactory:e,signal:n.signal})}n.log.trace("%s secure outbound",n.role);const u=await a.secureOutbound(c,{remotePeer:n.remotePeer,signal:n.signal,skipStreamMuxerNegotiation:!0});l.remoteAddr=l.remoteAddr.encapsulate(`/p2p/${u.remotePeer}`),n.log.trace("%s upgrade inbound",n.role),await n.upgrader.upgradeInbound(l,{skipProtection:!0,skipEncryption:!0,remotePeer:u.remotePeer,muxerFactory:e,signal:n.signal})}catch(s){throw i.close(),r.close(),s}}async function Rq(r,e,t={}){let n=t.certificate;n==null&&(n=await RTCPeerConnection.generateCertificate({name:"ECDSA",namedCurve:"P-256"}));const i=typeof t.rtcConfiguration=="function"?await t.rtcConfiguration():t.rtcConfiguration,s=new RTCPeerConnection({...i??{},certificates:[n]}),o=new b3({peerConnection:s,metrics:t.events,dataChannelOptions:t.dataChannel});return{peerConnection:s,muxerFactory:o}}async function Nq(r){const e=await b7(r),t=await crypto.subtle.exportKey("pkcs8",e.privateKey);return["-----BEGIN PRIVATE KEY-----",...Y(new Uint8Array(t),"base64pad").split(/(.{64})/).filter(Boolean),"-----END PRIVATE KEY-----"].join(`
`)}class Dq{log;metrics;components;init;certificate;privateKey;emitter;renewCertificateTask;constructor(e,t={}){if(this.log=e.logger.forComponent("libp2p:webrtc-direct"),this.components=e,this.init=t,this.emitter=new Qe,t.certificateLifespan!=null&&t.certificateRenewalThreshold!=null&&t.certificateRenewalThreshold>=t.certificateLifespan)throw new H("Certificate renewal threshold must be less than certificate lifespan");e.metrics!=null&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_webrtc-direct_dialer_events_total",{label:"event",help:"Total count of WebRTC-direct dial events by type"})})}[$h]=!0;[Symbol.toStringTag]="@libp2p/webrtc-direct";[It]=["@libp2p/transport"];async start(){this.certificate=await this.getCertificate()}async stop(){this.renewCertificateTask!=null&&clearTimeout(this.renewCertificateTask),this.certificate=void 0}async dial(e,t){this.log("dial %a",e),t.signal.throwIfAborted();let n;const i=e.getComponents().findLast(c=>c.code===ge)?.value;i!=null&&(n=or(i));const s=Pz(),{peerConnection:o,muxerFactory:a}=await Rq("client",s,{rtcConfiguration:typeof this.init.rtcConfiguration=="function"?await this.init.rtcConfiguration():this.init.rtcConfiguration??{},dataChannel:this.init.dataChannel});try{return await Pq(o,a,s,{role:"client",log:this.log,logger:this.components.logger,events:this.metrics?.dialerEvents,signal:t.signal,remoteAddr:e,dataChannel:this.init.dataChannel,upgrader:t.upgrader,peerId:this.components.peerId,remotePeer:n,privateKey:this.components.privateKey})}catch(c){throw o.close(),c}}createListener(e){if(this.certificate==null)throw new Po;return new wq(this.components,{...this.init,...e,certificate:this.certificate,emitter:this.emitter})}listenFilter(e){return e.filter(U0.exactMatch)}dialFilter(e){return this.listenFilter(e)}async getCertificate(e){if(Bq(this.init.certificate))return this.log("using provided TLS certificate"),this.init.certificate;const t=await this.loadOrCreatePrivateKey(),{pem:n,certhash:i}=await this.loadOrCreateCertificate(t,e);return{privateKey:await Nq(t),pem:n,certhash:i}}async loadOrCreatePrivateKey(){if(this.privateKey!=null)return this.privateKey;const e=this.init.certificateKeychainName??pz,t=this.getKeychain();try{if(t==null)throw this.log("no keychain configured - not checking for stored private key"),new wt;this.log.trace("checking for stored private key"),this.privateKey=await t.exportKey(e)}catch(n){if(n.name!=="NotFoundError")throw n;this.log.trace("generating private key"),this.privateKey=await cg("ECDSA","P-256"),t!=null?(this.log.trace("storing private key"),await t.importKey(e,this.privateKey)):this.log("no keychain configured - not storing private key")}return this.privateKey}async loadOrCreateCertificate(e,t){if(this.certificate!=null&&t!==!0)return this.certificate;let n;const i=new Ye(this.init.certificateDatastoreKey??fz),s=await b7(e);try{if(t===!0)throw this.log.trace("forcing renewal of TLS certificate"),new wt;this.log.trace("checking for stored TLS certificate"),n=await this.loadCertificate(i,s)}catch(a){if(a.name!=="NotFoundError")throw a;this.log.trace("generating new TLS certificate"),n=await this.createCertificate(i,s)}let o=n.notAfter.getTime()-(this.init.certificateRenewalThreshold??c6)-Date.now();return o<0&&(o=100),this.log("will renew TLS certificate after %d ms",o),this.renewCertificateTask=setTimeout(()=>{this.log("renewing TLS certificate"),this.getCertificate(!0).then(a=>{this.certificate=a,this.emitter.safeDispatchEvent("certificate:renew",{detail:a})}).catch(a=>{this.log.error("could not renew certificate - %e",a)})},o),{pem:n.toString("pem"),certhash:Fh.encode((await Et.digest(new Uint8Array(n.rawData))).bytes)}}async loadCertificate(e,t){const n=await this.components.datastore.get(e),i=new Y3(n),s=i.notAfter.getTime()-(this.init.certificateRenewalThreshold??c6);if(Date.now()>s)throw this.log("stored TLS certificate has expired"),new wt;this.log("loaded certificate, expires in %d ms",s);const o=await i.publicKey.export(crypto),a=await crypto.subtle.exportKey("raw",o),c=await crypto.subtle.exportKey("raw",t.publicKey);if(!Te(new Uint8Array(a,0,a.byteLength),new Uint8Array(c,0,c.byteLength)))throw this.log("stored TLS certificate public key did not match public key from private key"),new wt;return this.log("loaded certificate, expiry time is %o",s),i}async createCertificate(e,t){const n=new Date,i=new Date(Date.now()+(this.init.certificateLifespan??gz));n.setMilliseconds(0),i.setMilliseconds(0);const s=await yq.createSelfSigned({serialNumber:(BigInt(Math.random().toString().replace(".",""))*100000n).toString(16),name:"CN=example.com, C=US, L=CA, O=example, ST=CA",notBefore:n,notAfter:i,keys:t,extensions:[new j3(!1,void 0,!0)]},crypto);return this.getKeychain()!=null?(this.log.trace("storing TLS certificate"),await this.components.datastore.put(e,W(s.toString("pem")))):this.log("no keychain is configured so not storing TLS certificate since the private key will not be reused"),s}getKeychain(){try{return this.components.keychain}catch{}}}function Bq(r){return r==null?!1:typeof r.privateKey=="string"&&typeof r.pem=="string"&&typeof r.certhash=="string"}function Lq(r){return e=>new Dq(e,r)}function PE(r){return e=>new Vz(e,r)}function Oq(){throw new Error("WebSocket Servers can not be created in the browser!")}const Mq=1024*1024*4,$q=10;class Uq extends pg{websocket;maxBufferedAmount;checkBufferedAmountTask;constructor(e){super(e),this.websocket=e.websocket,this.maxBufferedAmount=e.maxBufferedAmount??Mq,this.checkBufferedAmountTask=Mg(this.checkBufferedAmount.bind(this),e.bufferedAmountPollInterval??$q),this.websocket.addEventListener("close",t=>{if(this.log('closed - code %d, reason "%s", wasClean %s',t.code,t.reason,t.wasClean),this.checkBufferedAmountTask.stop(),!t.wasClean){this.onRemoteReset();return}this.onTransportClosed()},{once:!0}),this.websocket.addEventListener("message",t=>{try{let n;if(typeof t.data=="string")n=W(t.data);else if(t.data instanceof ArrayBuffer)n=new Uint8Array(t.data,0,t.data.byteLength);else{this.abort(new Error("Incorrect binary type"));return}this.onData(n)}catch(n){this.log.error("error receiving data - %e",n)}})}sendData(e){for(const n of e)this.websocket.send(n);const t=this.websocket.bufferedAmount<this.maxBufferedAmount;return t||this.checkBufferedAmountTask.start(),{sentBytes:e.byteLength,canSendMore:t}}sendReset(){this.websocket.close(1006)}async sendClose(e){this.websocket.close(),e?.signal?.throwIfAborted()}sendPause(){}sendResume(){}checkBufferedAmount(){this.log("buffered amount now %d",this.websocket.bufferedAmount),this.websocket.bufferedAmount===0&&(this.checkBufferedAmountTask.stop(),this.safeDispatchEvent("drain"))}}function Fq(r){return new Uq(r)}class Vq{log;init;logger;metrics;components;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:websockets"),this.logger=e.logger,this.components=e,this.init=t,e.metrics!=null&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_websockets_dialer_events_total",{label:"event",help:"Total count of WebSockets dialer events by type"})})}[$h]=!0;[Symbol.toStringTag]="@libp2p/websockets";[It]=["@libp2p/transport"];async dial(e,t){this.log("dialing %s",e),t=t??{};const n=Fq({websocket:await this._connect(e,t),remoteAddr:e,metrics:this.metrics?.dialerEvents,direction:"outbound",log:this.components.logger.forComponent("libp2p:websockets:connection"),maxBufferedAmount:this.init.maxBufferedAmount,bufferedAmountPollInterval:this.init.bufferedAmountPollInterval});this.log("new outbound connection %s",n.remoteAddr);const i=await t.upgrader.upgradeOutbound(n,t);return this.log("outbound connection %s upgraded",n.remoteAddr),i}async _connect(e,t){t?.signal?.throwIfAborted();const n=ef(e);this.log("create websocket connection to %s",n);const i=new WebSocket(n);i.binaryType="arraybuffer";try{t.onProgress?.(new oe("websockets:open-connection")),await bt(i,"open",t)}catch(s){if(t.signal?.aborted)throw this.metrics?.dialerEvents.increment({abort:!0}),new r8(`Could not connect to ${n}`);this.metrics?.dialerEvents.increment({error:!0});try{i.close()}catch{}throw s}return this.log("connected %s",e),this.metrics?.dialerEvents.increment({connect:!0}),i}createListener(e){return Oq({logger:this.logger,events:this.components.events,metrics:this.components.metrics},{...this.init,...e})}listenFilter(e){return e.filter(t=>Zc.exactMatch(t)||Cd.exactMatch(t))}dialFilter(e){return this.listenFilter(e)}}function RE(r={}){return e=>new Vq(e,r)}function zq(r,e){const t=e.map((n,i)=>({record:Il(n),index:i}));return t.sort((n,i)=>{const s=n.record.sequence,o=i.record.sequence;if(s>o)return-1;if(s<o)return 1;if(n.record.validityType===tn.ValidityType.EOL&&i.record.validityType===tn.ValidityType.EOL){const a=V0.fromString(n.record.validity).toDate(),c=V0.fromString(i.record.validity).toDate();if(a.getTime()>c.getTime())return-1;if(a.getTime()<c.getTime())return 1}return 0}),t[0].index}const Hq="6.0.13",qq="helia",Kq={list:["/dnsaddr/bootstrap.libp2p.io/p2p/QmNnooDu7bfjPFoTZYxMNLWUQJyrVwtbZg5gBMjTezGAJN","/dnsaddr/bootstrap.libp2p.io/p2p/QmbLHAnMoJPWSCR5Zhtx6BHJX9KiKNN6tpvbUcqanj75Nb","/dnsaddr/bootstrap.libp2p.io/p2p/QmcZf59bWwK5XFi76CZX8cbJ4BhTzzA3gU1ZjYZcYW3dwt","/dnsaddr/va1.bootstrap.libp2p.io/p2p/12D3KooWKnDdG3iXw9eTFijk3EWSunZcFi54Zka4wmtqtt6rPxc8","/ip4/104.131.131.82/tcp/4001/p2p/QmaCpDMGvV2BGHeYERUEnRQAwe3N8SzbUtfsmvsqQLuvuJ"]};function Wq(r={}){const e=`${qq}/${Hq} ${U9()}`;return{privateKey:r.privateKey,dns:r.dns,nodeInfo:{userAgent:e},addresses:{listen:["/p2p-circuit","/webrtc"]},transports:[iv(),PE(),Lq(),RE()],connectionEncrypters:[d3()],streamMuxers:[Jb(),ZV()],peerDiscovery:[ev(Kq)],services:{autoNAT:R$(),dcutr:tU(),delegatedRouting:()=>sB("https://delegated-ipfs.dev",oB()),dht:FV({clientMode:!0,validators:{ipns:f9},selectors:{ipns:zq}}),identify:Ev(),identifyPush:EF(),keychain:Fb(r.keychain),ping:oz(),http:lF()}}}async function jq(r){const e=r.libp2p??{};e.privateKey==null&&r.datastore!=null&&(e.privateKey=await yM(r.datastore,r.keychain));const t=Wq(e);return t.datastore=t.datastore??r.datastore,await V9({...t,...e,start:!1})}async function Gq(r={}){const e=r.datastore??new y9,t=r.blockstore??new BB;let n;return RO(r.libp2p)?n=r.libp2p:n=await jq({...r,libp2p:{dns:r.dns,...r.libp2p,start:void 0},datastore:e}),{...r,libp2p:n,datastore:e,blockstore:t,blockBrokers:r.blockBrokers??[$D(),mD()],routers:r.routers??[RB(n),TB()],metrics:n.metrics}}async function Yq(r={}){const e=await Gq(r),t=new CN(e);return e.start!==!1&&await t.start(),t}function Qq(r){return r[Symbol.asyncIterator]!=null}function NE(r,e=1){return e=Number(e),Qq(r)?(async function*(){let t=[];if(e<1&&(e=1),e!==Math.round(e))throw new Error("Batch size must be an integer");for await(const n of r)for(t.push(n);t.length>=e;)yield t.slice(0,e),t=t.slice(e);for(;t.length>0;)yield t.slice(0,e),t=t.slice(e)})():(function*(){let t=[];if(e<1&&(e=1),e!==Math.round(e))throw new Error("Batch size must be an integer");for(const n of r)for(t.push(n);t.length>=e;)yield t.slice(0,e),t=t.slice(e);for(;t.length>0;)yield t.slice(0,e),t=t.slice(e)})()}async function*DE(r,e=1){for await(const t of NE(r,e)){const n=t.map(async i=>i().then(s=>({ok:!0,value:s}),s=>({ok:!1,err:s})));for(let i=0;i<n.length;i++){const s=await n[i];if(s.ok)yield s.value;else throw s.err}}}const Xq=262144,BE=(r={})=>{const e=r.chunkSize??Xq;return async function*(n){let i=new me,s=0,o=!1;for await(const a of n)for(i.append(a),s+=a.length;s>=e;)if(yield i.slice(0,e),o=!0,e===i.length)i=new me,s=0;else{const c=new me;c.append(i.sublist(e)),i=c,s-=e}(!o||s>0)&&(yield i.subarray(0,s))}};class hl extends Error{static name="InvalidTypeError";static code="ERR_INVALID_TYPE";name=hl.name;code=hl.code;constructor(e="Invalid type"){super(e)}}class Ah extends Error{static name="InvalidUnixFSMessageError";static code="ERR_INVALID_MESSAGE";name=Ah.name;code=Ah.code;constructor(e="Invalid message"){super(e)}}var gn;(function(r){(function(n){n.Raw="Raw",n.Directory="Directory",n.File="File",n.Metadata="Metadata",n.Symlink="Symlink",n.HAMTShard="HAMTShard"})(r.DataType||(r.DataType={}));let e;(function(n){n[n.Raw=0]="Raw",n[n.Directory=1]="Directory",n[n.File=2]="File",n[n.Metadata=3]="Metadata",n[n.Symlink=4]="Symlink",n[n.HAMTShard=5]="HAMTShard"})(e||(e={})),(function(n){n.codec=()=>sr(e)})(r.DataType||(r.DataType={}));let t;r.codec=()=>(t==null&&(t=Ce((n,i,s={})=>{if(s.lengthDelimited!==!1&&i.fork(),n.Type!=null&&(i.uint32(8),r.DataType.codec().encode(n.Type,i)),n.Data!=null&&(i.uint32(18),i.bytes(n.Data)),n.filesize!=null&&(i.uint32(24),i.uint64(n.filesize)),n.blocksizes!=null)for(const o of n.blocksizes)i.uint32(32),i.uint64(o);n.hashType!=null&&(i.uint32(40),i.uint64(n.hashType)),n.fanout!=null&&(i.uint32(48),i.uint64(n.fanout)),n.mode!=null&&(i.uint32(56),i.uint32(n.mode)),n.mtime!=null&&(i.uint32(66),kh.codec().encode(n.mtime,i)),s.lengthDelimited!==!1&&i.ldelim()},(n,i)=>{const s={blocksizes:[]},o=i==null?n.len:n.pos+i;for(;n.pos<o;){const a=n.uint32();switch(a>>>3){case 1:s.Type=r.DataType.codec().decode(n);break;case 2:s.Data=n.bytes();break;case 3:s.filesize=n.uint64();break;case 4:s.blocksizes.push(n.uint64());break;case 5:s.hashType=n.uint64();break;case 6:s.fanout=n.uint64();break;case 7:s.mode=n.uint32();break;case 8:s.mtime=kh.codec().decode(n,n.uint32());break;default:n.skipType(a&7);break}}return s})),t),r.encode=n=>ke(n,r.codec()),r.decode=n=>Ae(n,r.codec())})(gn||(gn={}));var kh;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.Seconds!=null&&(n.uint32(8),n.int64(t.Seconds)),t.FractionalNanoseconds!=null&&(n.uint32(21),n.fixed32(t.FractionalNanoseconds)),i.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{const i={},s=n==null?t.len:t.pos+n;for(;t.pos<s;){const o=t.uint32();switch(o>>>3){case 1:i.Seconds=t.int64();break;case 2:i.FractionalNanoseconds=t.fixed32();break;default:t.skipType(o&7);break}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=t=>Ae(t,r.codec())})(kh||(kh={}));var F5;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.MimeType!=null&&(n.uint32(10),n.string(t.MimeType)),i.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{const i={},s=n==null?t.len:t.pos+n;for(;t.pos<s;){const o=t.uint32();switch(o>>>3){case 1:i.MimeType=t.string();break;default:t.skipType(o&7);break}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=t=>Ae(t,r.codec())})(F5||(F5={}));const V5={Raw:"raw",Directory:"directory",File:"file",Metadata:"metadata",Symlink:"symlink",HAMTShard:"hamt-sharded-directory"},Zq=["directory","hamt-sharded-directory"],z5=parseInt("0644",8),H5=parseInt("0755",8),q5=BigInt(1024);let Oe=class LE{static unmarshal(e){const t=gn.decode(e);if(t.fanout!=null&&t.fanout>q5)throw new Ah(`Fanout size was too large - ${t.fanout} > ${q5}`);const n=new LE({type:V5[t.Type!=null?t.Type.toString():"File"],data:t.Data,blockSizes:t.blocksizes,mode:t.mode,mtime:t.mtime!=null?{secs:t.mtime.Seconds??0n,nsecs:t.mtime.FractionalNanoseconds}:void 0,fanout:t.fanout});return n._originalMode=t.mode??0,n}type;data;blockSizes;hashType;fanout;mtime;_mode;_originalMode;constructor(e={type:"file"}){const{type:t,data:n,blockSizes:i,hashType:s,fanout:o,mtime:a,mode:c}=e;if(t!=null&&!Object.values(V5).includes(t))throw new hl("Type: "+t+" is not valid");this.type=t??"file",this.data=n,this.hashType=s,this.fanout=o,this.blockSizes=i??[],this._originalMode=0,this.mode=c,this.mtime=a}set mode(e){e==null?this._mode=this.isDirectory()?H5:z5:this._mode=e&4095}get mode(){return this._mode}isDirectory(){return Zq.includes(this.type)}addBlockSize(e){this.blockSizes.push(e)}removeBlockSize(e){this.blockSizes.splice(e,1)}fileSize(){if(this.isDirectory())return 0n;let e=0n;return this.blockSizes.forEach(t=>{e+=t}),this.data!=null&&(e+=BigInt(this.data.length)),e}marshal(){let e;switch(this.type){case"raw":e=gn.DataType.Raw;break;case"directory":e=gn.DataType.Directory;break;case"file":e=gn.DataType.File;break;case"metadata":e=gn.DataType.Metadata;break;case"symlink":e=gn.DataType.Symlink;break;case"hamt-sharded-directory":e=gn.DataType.HAMTShard;break;default:throw new hl(`Type: ${e} is not valid`)}let t=this.data;(this.data==null||this.data.length===0)&&(t=void 0);let n;this.mode!=null&&(n=this._originalMode&4294963200|(this.mode??0),n===z5&&!this.isDirectory()&&(n=void 0),n===H5&&this.isDirectory()&&(n=void 0));let i;return this.mtime!=null&&(i={Seconds:this.mtime.secs,FractionalNanoseconds:this.mtime.nsecs}),gn.encode({Type:e,Data:t,filesize:this.isDirectory()?void 0:this.fileSize(),blocksizes:this.blockSizes,hashType:this.hashType,fanout:this.fanout,mode:n,mtime:i})}};const aa=async(r,e,t)=>{t.codec==null&&(t.codec=kl);const n=await Et.digest(r),i=ae.create(t.cidVersion,t.codec.code,n);return await e.put(i,r,t),i};function Jq(r){return async function*(t,n){let i=0n;for await(let s of t.content)yield async()=>{let o;const a={codec:kl,cidVersion:r.cidVersion,onProgress:r.onProgress};r.rawLeaves?(a.codec=p8,a.cidVersion=1):(o=new Oe({type:r.leafType,data:s}),s=pt({Data:o.marshal(),Links:[]}));const c=await aa(s,n,a);return i+=BigInt(s.byteLength),r.onProgress?.(new oe("unixfs:importer:progress:file:write",{bytesWritten:i,cid:c,path:t.path})),{cid:c,unixfs:o,size:BigInt(s.length),block:s}}}}let eK=class Tp extends Error{static name="InvalidParametersError";static code="ERR_INVALID_PARAMS";name=Tp.name;code=Tp.code;constructor(e="Invalid parameters"){super(e)}};class Ms extends Error{static name="InvalidContentError";static code="ERR_INVALID_CONTENT";name=Ms.name;code=Ms.code;constructor(e="Invalid content"){super(e)}}const tK=async(r,e,t)=>{const n=new Oe({type:"directory",mtime:r.mtime,mode:r.mode}),i=pt(kr({Data:n.marshal()})),s=await aa(i,e,t),o=r.path;return{cid:s,path:o,unixfs:n,size:BigInt(i.length),originalPath:r.originalPath,block:i}};async function*rK(r,e,t){let n=-1,i;for await(const s of DE(t.bufferImporter(r,e),t.blockWriteConcurrency)){if(n++,n===0){i={...s,single:!0};continue}else n===1&&i!=null&&(yield{...i,block:void 0,single:void 0},i=void 0);yield{...s,block:void 0}}i!=null&&(yield i)}function K5(r){return r.single===!0}const nK=(r,e,t)=>async function(i){if(i.length===1&&K5(i[0])&&t.reduceSingleLeafToSelf){const u=i[0];let d=u.block;return K5(u)&&(r.mtime!==void 0||r.mode!==void 0)&&(u.unixfs=new Oe({type:"file",mtime:r.mtime,mode:r.mode,data:u.block}),d={Data:u.unixfs.marshal(),Links:[]},u.block=pt(kr(d)),u.cid=await aa(u.block,e,{...t,cidVersion:t.cidVersion}),u.size=BigInt(u.block.length)),t.onProgress?.(new oe("unixfs:importer:progress:file:layout",{cid:u.cid,path:u.originalPath})),{cid:u.cid,path:r.path,unixfs:u.unixfs,size:u.size,originalPath:u.originalPath}}const s=new Oe({type:"file",mtime:r.mtime,mode:r.mode}),o=i.filter(u=>u.cid.code===sn&&u.size>0||u.unixfs!=null&&u.unixfs.data==null&&u.unixfs.fileSize()>0n?!0:!!u.unixfs?.data?.length).map(u=>u.cid.code===sn?(s.addBlockSize(u.size),{Name:"",Tsize:Number(u.size),Hash:u.cid}):(u.unixfs?.data==null?s.addBlockSize(u.unixfs?.fileSize()??0n):s.addBlockSize(BigInt(u.unixfs.data.length)),{Name:"",Tsize:Number(u.size),Hash:u.cid})),a={Data:s.marshal(),Links:o},c=pt(kr(a)),l=await aa(c,e,t);return t.onProgress?.(new oe("unixfs:importer:progress:file:layout",{cid:l,path:r.originalPath})),{cid:l,path:r.path,unixfs:s,size:BigInt(c.length+a.Links.reduce((u,d)=>u+(d.Tsize??0),0)),originalPath:r.originalPath,block:c}},iK=async(r,e,t)=>t.layout(rK(r,e,t),nK(r,e,t));function sK(r){return Symbol.iterator in r}function oK(r){return Symbol.asyncIterator in r}function aK(r){try{if(r instanceof Uint8Array)return(async function*(){yield r})();if(sK(r))return(async function*(){yield*r})();if(oK(r))return r}catch{throw new Ms("Content was invalid")}throw new Ms("Content was invalid")}function cK(r){return async function*(t,n){for await(const i of t){let s;if(i.path!=null&&(s=i.path,i.path=i.path.split("/").filter(o=>o!=null&&o!==".").join("/")),lK(i)){const o={path:i.path,mtime:i.mtime,mode:i.mode,content:(async function*(){let c=0n;for await(const l of r.chunker(r.chunkValidator(aK(i.content)))){const u=BigInt(l.byteLength);c+=u,r.onProgress?.(new oe("unixfs:importer:progress:file:read",{bytesRead:c,chunkSize:u,path:i.path})),yield l}})(),originalPath:s},a=r.fileBuilder??iK;yield async()=>a(o,n,r)}else if(i.path!=null){const o={path:i.path,mtime:i.mtime,mode:i.mode,originalPath:s},a=r.dirBuilder??tK;yield async()=>a(o,n,r)}else throw new Error("Import candidate must have content or path or both")}}}function lK(r){return r.content!=null}const uK=()=>async function*(e){for await(const t of e){if(t.length===void 0)throw new Ms("Content was invalid");if(typeof t=="string"||t instanceof String)yield W(t.toString());else if(Array.isArray(t))yield Uint8Array.from(t);else if(t instanceof Uint8Array)yield t;else throw new Ms("Content was invalid")}},dK=174;function OE(r){const e=r?.maxChildrenPerNode??dK;return async function t(n,i){const s=[];for await(const o of NE(n,e))s.push(await i(o));return s.length>1?t(s,i):s[0]}}let fl=class{options;root;dir;path;dirty;flat;parent;parentKey;unixfs;mode;mtime;cid;size;nodeSize;constructor(e,t){this.options=t??{},this.root=e.root,this.dir=e.dir,this.path=e.path,this.dirty=e.dirty,this.flat=e.flat,this.parent=e.parent,this.parentKey=e.parentKey,this.unixfs=e.unixfs,this.mode=e.mode,this.mtime=e.mtime}};const Pp=ae.parse("QmUNLLsPACCz1vLxQVkXqqLX5R1X345qqfHbsf67hvA3Nn"),Rp=ae.parse("zdj7WbTaiJT1fgatdet9Ei9iDB5hdCxkbVyhyh8YTUnXMiwYi");class Q3 extends fl{_children;constructor(e,t){super(e,t),this._children=new Map}async put(e,t){this.cid=void 0,this.size=void 0,this.nodeSize=void 0,this._children.set(e,t)}async get(e){return Promise.resolve(this._children.get(e))}childCount(){return this._children.size}directChildrenCount(){return this.childCount()}onlyChild(){return this._children.values().next().value}*eachChildSeries(){for(const[e,t]of this._children.entries())yield{key:e,child:t}}estimateNodeSize(){if(this.nodeSize!==void 0)return this.nodeSize;this.nodeSize=0;for(const[e,t]of this._children.entries())t.size!=null&&t.cid!=null&&(this.nodeSize+=e.length+(this.options.cidVersion===1?Rp.bytes.byteLength:Pp.bytes.byteLength));return this.nodeSize}async*flush(e){const t=[];for(const[c,l]of this._children.entries()){let u=l;if(l instanceof fl)for await(const d of l.flush(e))u=d,yield d;u.size!=null&&u.cid!=null&&t.push({Name:c,Tsize:Number(u.size),Hash:u.cid})}const n=new Oe({type:"directory",mtime:this.mtime,mode:this.mode}),i={Data:n.marshal(),Links:t},s=pt(kr(i)),o=await aa(s,e,this.options),a=s.length+i.Links.reduce((c,l)=>c+(l.Tsize??0),0);this.cid=o,this.size=a,yield{cid:o,unixfs:n,path:this.path,size:BigInt(a)}}}var Lu={exports:{}},W5;function hK(){return W5||(W5=1,(function(r,e){(function(t,n){var i={version:"3.0.0",x86:{},x64:{},inputValidation:!0};function s(m){if(!Array.isArray(m)&&!ArrayBuffer.isView(m))return!1;for(var p=0;p<m.length;p++)if(!Number.isInteger(m[p])||m[p]<0||m[p]>255)return!1;return!0}function o(m,p){return(m&65535)*p+(((m>>>16)*p&65535)<<16)}function a(m,p){return m<<p|m>>>32-p}function c(m){return m^=m>>>16,m=o(m,2246822507),m^=m>>>13,m=o(m,3266489909),m^=m>>>16,m}function l(m,p){m=[m[0]>>>16,m[0]&65535,m[1]>>>16,m[1]&65535],p=[p[0]>>>16,p[0]&65535,p[1]>>>16,p[1]&65535];var b=[0,0,0,0];return b[3]+=m[3]+p[3],b[2]+=b[3]>>>16,b[3]&=65535,b[2]+=m[2]+p[2],b[1]+=b[2]>>>16,b[2]&=65535,b[1]+=m[1]+p[1],b[0]+=b[1]>>>16,b[1]&=65535,b[0]+=m[0]+p[0],b[0]&=65535,[b[0]<<16|b[1],b[2]<<16|b[3]]}function u(m,p){m=[m[0]>>>16,m[0]&65535,m[1]>>>16,m[1]&65535],p=[p[0]>>>16,p[0]&65535,p[1]>>>16,p[1]&65535];var b=[0,0,0,0];return b[3]+=m[3]*p[3],b[2]+=b[3]>>>16,b[3]&=65535,b[2]+=m[2]*p[3],b[1]+=b[2]>>>16,b[2]&=65535,b[2]+=m[3]*p[2],b[1]+=b[2]>>>16,b[2]&=65535,b[1]+=m[1]*p[3],b[0]+=b[1]>>>16,b[1]&=65535,b[1]+=m[2]*p[2],b[0]+=b[1]>>>16,b[1]&=65535,b[1]+=m[3]*p[1],b[0]+=b[1]>>>16,b[1]&=65535,b[0]+=m[0]*p[3]+m[1]*p[2]+m[2]*p[1]+m[3]*p[0],b[0]&=65535,[b[0]<<16|b[1],b[2]<<16|b[3]]}function d(m,p){return p%=64,p===32?[m[1],m[0]]:p<32?[m[0]<<p|m[1]>>>32-p,m[1]<<p|m[0]>>>32-p]:(p-=32,[m[1]<<p|m[0]>>>32-p,m[0]<<p|m[1]>>>32-p])}function h(m,p){return p%=64,p===0?m:p<32?[m[0]<<p|m[1]>>>32-p,m[1]<<p]:[m[1]<<p-32,0]}function f(m,p){return[m[0]^p[0],m[1]^p[1]]}function y(m){return m=f(m,[0,m[0]>>>1]),m=u(m,[4283543511,3981806797]),m=f(m,[0,m[0]>>>1]),m=u(m,[3301882366,444984403]),m=f(m,[0,m[0]>>>1]),m}i.x86.hash32=function(m,p){if(i.inputValidation&&!s(m))return n;p=p||0;for(var b=m.length%4,A=m.length-b,v=p,C=0,T=3432918353,R=461845907,L=0;L<A;L=L+4)C=m[L]|m[L+1]<<8|m[L+2]<<16|m[L+3]<<24,C=o(C,T),C=a(C,15),C=o(C,R),v^=C,v=a(v,13),v=o(v,5)+3864292196;switch(C=0,b){case 3:C^=m[L+2]<<16;case 2:C^=m[L+1]<<8;case 1:C^=m[L],C=o(C,T),C=a(C,15),C=o(C,R),v^=C}return v^=m.length,v=c(v),v>>>0},i.x86.hash128=function(m,p){if(i.inputValidation&&!s(m))return n;p=p||0;for(var b=m.length%16,A=m.length-b,v=p,C=p,T=p,R=p,L=0,N=0,E=0,O=0,V=597399067,$=2869860233,I=951274213,k=2716044179,S=0;S<A;S=S+16)L=m[S]|m[S+1]<<8|m[S+2]<<16|m[S+3]<<24,N=m[S+4]|m[S+5]<<8|m[S+6]<<16|m[S+7]<<24,E=m[S+8]|m[S+9]<<8|m[S+10]<<16|m[S+11]<<24,O=m[S+12]|m[S+13]<<8|m[S+14]<<16|m[S+15]<<24,L=o(L,V),L=a(L,15),L=o(L,$),v^=L,v=a(v,19),v+=C,v=o(v,5)+1444728091,N=o(N,$),N=a(N,16),N=o(N,I),C^=N,C=a(C,17),C+=T,C=o(C,5)+197830471,E=o(E,I),E=a(E,17),E=o(E,k),T^=E,T=a(T,15),T+=R,T=o(T,5)+2530024501,O=o(O,k),O=a(O,18),O=o(O,V),R^=O,R=a(R,13),R+=v,R=o(R,5)+850148119;switch(L=0,N=0,E=0,O=0,b){case 15:O^=m[S+14]<<16;case 14:O^=m[S+13]<<8;case 13:O^=m[S+12],O=o(O,k),O=a(O,18),O=o(O,V),R^=O;case 12:E^=m[S+11]<<24;case 11:E^=m[S+10]<<16;case 10:E^=m[S+9]<<8;case 9:E^=m[S+8],E=o(E,I),E=a(E,17),E=o(E,k),T^=E;case 8:N^=m[S+7]<<24;case 7:N^=m[S+6]<<16;case 6:N^=m[S+5]<<8;case 5:N^=m[S+4],N=o(N,$),N=a(N,16),N=o(N,I),C^=N;case 4:L^=m[S+3]<<24;case 3:L^=m[S+2]<<16;case 2:L^=m[S+1]<<8;case 1:L^=m[S],L=o(L,V),L=a(L,15),L=o(L,$),v^=L}return v^=m.length,C^=m.length,T^=m.length,R^=m.length,v+=C,v+=T,v+=R,C+=v,T+=v,R+=v,v=c(v),C=c(C),T=c(T),R=c(R),v+=C,v+=T,v+=R,C+=v,T+=v,R+=v,("00000000"+(v>>>0).toString(16)).slice(-8)+("00000000"+(C>>>0).toString(16)).slice(-8)+("00000000"+(T>>>0).toString(16)).slice(-8)+("00000000"+(R>>>0).toString(16)).slice(-8)},i.x64.hash128=function(m,p){if(i.inputValidation&&!s(m))return n;p=p||0;for(var b=m.length%16,A=m.length-b,v=[0,p],C=[0,p],T=[0,0],R=[0,0],L=[2277735313,289559509],N=[1291169091,658871167],E=0;E<A;E=E+16)T=[m[E+4]|m[E+5]<<8|m[E+6]<<16|m[E+7]<<24,m[E]|m[E+1]<<8|m[E+2]<<16|m[E+3]<<24],R=[m[E+12]|m[E+13]<<8|m[E+14]<<16|m[E+15]<<24,m[E+8]|m[E+9]<<8|m[E+10]<<16|m[E+11]<<24],T=u(T,L),T=d(T,31),T=u(T,N),v=f(v,T),v=d(v,27),v=l(v,C),v=l(u(v,[0,5]),[0,1390208809]),R=u(R,N),R=d(R,33),R=u(R,L),C=f(C,R),C=d(C,31),C=l(C,v),C=l(u(C,[0,5]),[0,944331445]);switch(T=[0,0],R=[0,0],b){case 15:R=f(R,h([0,m[E+14]],48));case 14:R=f(R,h([0,m[E+13]],40));case 13:R=f(R,h([0,m[E+12]],32));case 12:R=f(R,h([0,m[E+11]],24));case 11:R=f(R,h([0,m[E+10]],16));case 10:R=f(R,h([0,m[E+9]],8));case 9:R=f(R,[0,m[E+8]]),R=u(R,N),R=d(R,33),R=u(R,L),C=f(C,R);case 8:T=f(T,h([0,m[E+7]],56));case 7:T=f(T,h([0,m[E+6]],48));case 6:T=f(T,h([0,m[E+5]],40));case 5:T=f(T,h([0,m[E+4]],32));case 4:T=f(T,h([0,m[E+3]],24));case 3:T=f(T,h([0,m[E+2]],16));case 2:T=f(T,h([0,m[E+1]],8));case 1:T=f(T,[0,m[E]]),T=u(T,L),T=d(T,31),T=u(T,N),v=f(v,T)}return v=f(v,[0,m.length]),C=f(C,[0,m.length]),v=l(v,C),C=l(C,v),v=y(v),C=y(C),v=l(v,C),C=l(C,v),("00000000"+(v[0]>>>0).toString(16)).slice(-8)+("00000000"+(v[1]>>>0).toString(16)).slice(-8)+("00000000"+(C[0]>>>0).toString(16)).slice(-8)+("00000000"+(C[1]>>>0).toString(16)).slice(-8)},r.exports&&(e=r.exports=i),e.murmurHash3=i})()})(Lu,Lu.exports)),Lu.exports}var d0,j5;function fK(){return j5||(j5=1,d0=hK()),d0}var pK=fK();const gK=Us(pK),i1=Vh({name:"murmur3-128",code:34,encode:r=>CS(gK.x64.hash128(r))});var h0,G5;function mK(){if(G5)return h0;G5=1;const r=7;h0=class{constructor(){this._bitArrays=[],this._data=[],this._length=0,this._changedLength=!1,this._changedData=!1}set(o,a){let c=this._internalPositionFor(o,!1);if(a===void 0)c!==-1&&(this._unsetInternalPos(c),this._unsetBit(o),this._changedLength=!0,this._changedData=!0);else{let l=!1;c===-1?(c=this._data.length,this._setBit(o),this._changedData=!0):l=!0,this._setInternalPos(c,o,a,l),this._changedLength=!0}}unset(o){this.set(o,void 0)}get(o){this._sortData();const a=this._internalPositionFor(o,!0);if(a!==-1)return this._data[a][1]}push(o){return this.set(this.length,o),this.length}get length(){if(this._sortData(),this._changedLength){const o=this._data[this._data.length-1];this._length=o?o[0]+1:0,this._changedLength=!1}return this._length}forEach(o){let a=0;for(;a<this.length;)o(this.get(a),a,this),a++}map(o){let a=0,c=new Array(this.length);for(;a<this.length;)c[a]=o(this.get(a),a,this),a++;return c}reduce(o,a){let c=0,l=a;for(;c<this.length;){const u=this.get(c);l=o(l,u,c),c++}return l}find(o){let a=0,c,l;for(;a<this.length&&!c;)l=this.get(a),c=o(l),a++;return c?l:void 0}_internalPositionFor(o,a){const c=this._bytePosFor(o,a);if(c>=this._bitArrays.length)return-1;const l=this._bitArrays[c],u=o-c*r;if(!((l&1<<u)>0))return-1;const h=this._bitArrays.slice(0,c).reduce(e,0),f=~(4294967295<<u+1),y=t(l&f);return h+y-1}_bytePosFor(o,a){const c=Math.floor(o/r),l=c+1;for(;!a&&this._bitArrays.length<l;)this._bitArrays.push(0);return c}_setBit(o){const a=this._bytePosFor(o,!1);this._bitArrays[a]|=1<<o-a*r}_unsetBit(o){const a=this._bytePosFor(o,!1);this._bitArrays[a]&=~(1<<o-a*r)}_setInternalPos(o,a,c,l){const u=this._data,d=[a,c];if(l)this._sortData(),u[o]=d;else{if(u.length)if(u[u.length-1][0]>=a)u.push(d);else if(u[0][0]<=a)u.unshift(d);else{const h=Math.round(u.length/2);this._data=u.slice(0,h).concat(d).concat(u.slice(h))}else this._data.push(d);this._changedData=!0,this._changedLength=!0}}_unsetInternalPos(o){this._data.splice(o,1)}_sortData(){this._changedData&&this._data.sort(n),this._changedData=!1}bitField(){const o=[];let a=8,c=0,l=0,u;const d=this._bitArrays.slice();for(;d.length||c;){c===0&&(u=d.shift(),c=7);const f=Math.min(c,a),y=~(255<<f),m=u&y;l|=m<<8-a,u=u>>>f,c-=f,a-=f,(!a||!c&&!d.length)&&(o.push(l),l=0,a=8)}for(var h=o.length-1;h>0&&o[h]===0;h--)o.pop();return o}compactArray(){return this._sortData(),this._data.map(i)}};function e(s,o){return s+t(o)}function t(s){let o=s;return o=o-(o>>1&1431655765),o=(o&858993459)+(o>>2&858993459),(o+(o>>4)&252645135)*16843009>>24}function n(s,o){return s[0]-o[0]}function i(s){return s[1]}return h0}var yK=mK();const Ch=Us(yK);class er{_options;_popCount;_parent;_posAtParent;_children;key;constructor(e,t,n=0){this._options=e,this._popCount=0,this._parent=t,this._posAtParent=n,this._children=new Ch,this.key=null}async put(e,t){const n=await this._findNewBucketAndPos(e);n.bucket._putAt(n,e,t)}async get(e){const t=await this._findChild(e);if(t!=null)return t.value}async del(e){const t=await this._findPlace(e),n=t.bucket._at(t.pos);n!=null&&n.key===e&&t.bucket._delAt(t.pos)}leafCount(){return this._children.compactArray().reduce((t,n)=>n instanceof er?t+n.leafCount():t+1,0)}childrenCount(){return this._children.length}onlyChild(){return this._children.get(0)}*eachLeafSeries(){const e=this._children.compactArray();for(const t of e)t instanceof er?yield*t.eachLeafSeries():yield t}serialize(e,t){const n=[];return t(this._children.reduce((i,s,o)=>(s!=null&&(s instanceof er?i.push(s.serialize(e,t)):i.push(e(s,o))),i),n))}async asyncTransform(e,t){return ME(this,e,t)}toJSON(){return this.serialize(bK,vK)}prettyPrint(){return JSON.stringify(this.toJSON(),null,"  ")}tableSize(){return Math.pow(2,this._options.bits)}async _findChild(e){const t=await this._findPlace(e),n=t.bucket._at(t.pos);if(!(n instanceof er)&&n!=null&&n.key===e)return n}async _findPlace(e){const t=this._options.hash(typeof e=="string"?W(e):e),n=await t.take(this._options.bits),i=this._children.get(n);return i instanceof er?i._findPlace(t):{bucket:this,pos:n,hash:t,existingChild:i}}async _findNewBucketAndPos(e){const t=await this._findPlace(e);if(t.existingChild!=null&&t.existingChild.key!==e){const n=new er(this._options,t.bucket,t.pos);t.bucket._putObjectAt(t.pos,n);const i=await n._findPlace(t.existingChild.hash);return i.bucket._putAt(i,t.existingChild.key,t.existingChild.value),n._findNewBucketAndPos(t.hash)}return t}_putAt(e,t,n){this._putObjectAt(e.pos,{key:t,value:n,hash:e.hash})}_putObjectAt(e,t){this._children.get(e)==null&&this._popCount++,this._children.set(e,t)}_delAt(e){if(e===-1)throw new Error("Invalid position");this._children.get(e)!=null&&this._popCount--,this._children.unset(e),this._level()}_level(){if(this._parent!=null&&this._popCount<=1)if(this._popCount===1){const e=this._children.find(wK);if(e!=null&&!(e instanceof er)){const t=e.hash;t.untake(this._options.bits);const n={pos:this._posAtParent,hash:t,bucket:this._parent};this._parent._putAt(n,e.key,e.value)}}else this._parent._delAt(this._posAtParent)}_at(e){return this._children.get(e)}}function wK(r){return!!r}function bK(r,e){return r.key}function vK(r){return r}async function ME(r,e,t){const n=[];for(const i of r._children.compactArray())if(i instanceof er)await ME(i,e,t);else{const s=await e(i);n.push({bitField:r._children.bitField(),children:s})}return t(n)}const EK=[255,254,252,248,240,224,192,128],SK=[1,3,7,15,31,63,127,255];let xK=class{_value;_currentBytePos;_currentBitPos;constructor(e){this._value=e,this._currentBytePos=e.length-1,this._currentBitPos=7}availableBits(){return this._currentBitPos+1+this._currentBytePos*8}totalBits(){return this._value.length*8}take(e){let t=e,n=0;for(;t>0&&this._haveBits();){const i=this._value[this._currentBytePos],s=this._currentBitPos+1,o=Math.min(s,t),a=AK(i,s-o,o);n=(n<<o)+a,t-=o,this._currentBitPos-=o,this._currentBitPos<0&&(this._currentBitPos=7,this._currentBytePos--)}return n}untake(e){for(this._currentBitPos+=e;this._currentBitPos>7;)this._currentBitPos-=8,this._currentBytePos+=1}_haveBits(){return this._currentBytePos>=0}};function AK(r,e,t){const n=kK(e,t);return(r&n)>>>e}function kK(r,e){return EK[r]&SK[Math.min(e+r-1,7)]}function CK(r){function e(t){return t instanceof Y5?t:new Y5(t,r)}return e}let Y5=class{_value;_hashFn;_depth;_availableBits;_currentBufferIndex;_buffers;constructor(e,t){if(!(e instanceof Uint8Array))throw new Error("can only hash Uint8Arrays");this._value=e,this._hashFn=t,this._depth=-1,this._availableBits=0,this._currentBufferIndex=0,this._buffers=[]}async take(e){let t=e;for(;this._availableBits<t;)await this._produceMoreBits();let n=0;for(;t>0;){const i=this._buffers[this._currentBufferIndex],s=Math.min(i.availableBits(),t),o=i.take(s);n=(n<<s)+o,t-=s,this._availableBits-=s,i.availableBits()===0&&this._currentBufferIndex++}return n}untake(e){let t=e;for(;t>0;){const n=this._buffers[this._currentBufferIndex],i=Math.min(n.totalBits()-n.availableBits(),t);n.untake(i),t-=i,this._availableBits+=i,this._currentBufferIndex>0&&n.totalBits()===n.availableBits()&&(this._depth--,this._currentBufferIndex--)}}async _produceMoreBits(){this._depth++;const e=this._depth>0?Ot([this._value,Uint8Array.from([this._depth])]):this._value,t=await this._hashFn(e),n=new xK(t);this._buffers.push(n),this._availableBits+=n.availableBits()}};function X3(r){if(r==null||r.hashFn==null)throw new Error("please define an options.hashFn");const e={bits:r.bits??8,hash:CK(r.hashFn)};return new er(e)}async function IK(r){return(await i1.encode(r)).slice(0,8).reverse()}const $E=BigInt(34),_K=8;let TK=class extends fl{_bucket;constructor(e,t){super(e,t),this._bucket=X3({hashFn:IK,bits:t.shardFanoutBits??_K})}async put(e,t){this.cid=void 0,this.size=void 0,this.nodeSize=void 0,await this._bucket.put(e,t)}async get(e){return this._bucket.get(e)}childCount(){return this._bucket.leafCount()}directChildrenCount(){return this._bucket.childrenCount()}onlyChild(){return this._bucket.onlyChild()}*eachChildSeries(){for(const{key:e,value:t}of this._bucket.eachLeafSeries())yield{key:e,child:t}}estimateNodeSize(){return this.nodeSize!==void 0?this.nodeSize:(this.nodeSize=FE(this._bucket,this,this.options),this.nodeSize)}async*flush(e){for await(const t of UE(this._bucket,e,this,this.options))yield{...t,path:this.path}}};async function*UE(r,e,t,n){const i=r._children,s=(r.tableSize()-1).toString(16).length,o=[];let a=0n;for(let y=0;y<i.length;y++){const m=i.get(y);if(m==null)continue;const p=y.toString(16).toUpperCase().padStart(s,"0");if(m instanceof er){let b;for await(const A of UE(m,e,null,n))b=A;if(b==null)throw new Error("Could not flush sharded directory, no subshard found");o.push({Name:p,Tsize:Number(b.size),Hash:b.cid}),a+=b.size}else if(PK(m.value)){const b=m.value;let A;for await(const C of b.flush(e))A=C,yield A;if(A==null)throw new Error("Did not flush dir");const v=p+m.key;o.push({Name:v,Tsize:Number(A.size),Hash:A.cid}),a+=A.size}else{const b=m.value;if(b.cid==null)continue;const A=p+m.key,v=b.size;o.push({Name:A,Tsize:Number(v),Hash:b.cid}),a+=BigInt(v??0)}}const c=Uint8Array.from(i.bitField().reverse()),l=new Oe({type:"hamt-sharded-directory",data:c,fanout:BigInt(r.tableSize()),hashType:$E,mtime:t?.mtime,mode:t?.mode}),u={Data:l.marshal(),Links:o},d=pt(kr(u)),h=await aa(d,e,n),f=BigInt(d.byteLength)+a;yield{cid:h,unixfs:l,size:f}}function PK(r){return typeof r.flush=="function"}function FE(r,e,t){const n=r._children,i=(r.tableSize()-1).toString(16).length,s=[];for(let l=0;l<n.length;l++){const u=n.get(l);if(u==null)continue;const d=l.toString(16).toUpperCase().padStart(i,"0");if(u instanceof er){const h=FE(u,null,t);s.push({Name:d,Tsize:Number(h),Hash:t.cidVersion===0?Pp:Rp})}else if(typeof u.value.flush=="function"){const f=u.value.nodeSize();s.push({Name:d+u.key,Tsize:Number(f),Hash:t.cidVersion===0?Pp:Rp})}else{const h=u.value;if(h.cid==null)continue;const f=d+u.key,y=h.size;s.push({Name:f,Tsize:Number(y),Hash:h.cid})}}const o=Uint8Array.from(n.bitField().reverse()),a=new Oe({type:"hamt-sharded-directory",data:o,fanout:BigInt(r.tableSize()),hashType:$E,mtime:e?.mtime,mode:e?.mode});return pt(kr({Data:a.marshal(),Links:s})).length}async function VE(r,e,t,n){let i=e;e instanceof Q3&&e.estimateNodeSize()>t&&(i=await RK(e,n));const s=i.parent;if(s!=null){if(i!==e){if(r!=null&&(r.parent=i),i.parentKey==null)throw new Error("No parent key found");await s.put(i.parentKey,i)}return VE(i,s,t,n)}return i}async function RK(r,e){const t=new TK({root:r.root,dir:!0,parent:r.parent,parentKey:r.parentKey,path:r.path,dirty:r.dirty,flat:!1,mtime:r.mtime,mode:r.mode},e);for(const{key:n,child:i}of r.eachChildSeries())await t.put(n,i);return t}const NK=(r="")=>r.split(new RegExp("(?<!\\\\)\\/")).filter(Boolean);async function DK(r,e,t){const n=NK(r.path??""),i=n.length-1;let s=e,o="";for(let a=0;a<n.length;a++){const c=n[a];o+=`${o!==""?"/":""}${c}`;const l=a===i;if(s.dirty=!0,s.cid=void 0,s.size=void 0,l)await s.put(c,r),e=await VE(null,s,t.shardSplitThresholdBytes,t);else{let u=await s.get(c);(u==null||!(u instanceof fl))&&(u=new Q3({root:!1,dir:!0,parent:s,parentKey:c,path:o,dirty:!0,flat:!0,mtime:u?.unixfs?.mtime,mode:u?.unixfs?.mode},t)),await s.put(c,u),s=u}}return e}async function*Q5(r,e){if(!(r instanceof fl)){r.unixfs?.isDirectory()===!0&&(yield r);return}yield*r.flush(e)}function BK(r){return async function*(t,n){let i=new Q3({root:!0,dir:!0,path:"",dirty:!0,flat:!0},r),s,o=!1;for await(const a of t){if(a==null)continue;const c=`${a.originalPath??""}`.split("/")[0];c!=null&&c!==""&&(s==null?(s=c,o=!0):s!==c&&(o=!1)),i=await DK(a,i,r),a.unixfs?.isDirectory()!==!0&&(yield a)}if(r.wrapWithDirectory||o&&i.childCount()>1)yield*Q5(i,n);else for(const a of i.eachChildSeries())a!=null&&(yield*Q5(a.child,n))}}async function*s1(r,e,t={}){let n;Symbol.asyncIterator in r||Symbol.iterator in r?n=r:n=[r];const i=t.wrapWithDirectory??!1,s=t.shardSplitThresholdBytes??262144,o=t.shardFanoutBits??8,a=t.cidVersion??1,c=t.rawLeaves??!0,l=t.leafType??"file",u=t.fileImportConcurrency??50,d=t.blockWriteConcurrency??10,h=t.reduceSingleLeafToSelf??!0,f=t.chunker??BE(),y=t.chunkValidator??uK(),m=t.dagBuilder??cK({chunker:f,chunkValidator:y,wrapWithDirectory:i,layout:t.layout??OE(),bufferImporter:t.bufferImporter??Jq({cidVersion:a,rawLeaves:c,leafType:l,onProgress:t.onProgress}),blockWriteConcurrency:d,reduceSingleLeafToSelf:h,cidVersion:a,onProgress:t.onProgress,dirBuilder:t.dirBuilder,fileBuilder:t.fileBuilder}),p=t.treeBuilder??BK({wrapWithDirectory:i,shardSplitThresholdBytes:s,shardFanoutBits:o,cidVersion:a,onProgress:t.onProgress});for await(const b of p(DE(m(n,e),u),e))yield{cid:b.cid,path:b.path,unixfs:b.unixfs,size:b.size}}async function zE(r,e,t={}){const n=await Zg(s1([r],e,t));if(n==null)throw new eK("Nothing imported");return n}async function LK(r,e,t={}){return zE({content:r},e,t)}async function OK(r,e,t={}){return zE({content:r},e,t)}function MK(r){return r[Symbol.asyncIterator]!=null}function Ta(r){if(MK(r))return(async()=>{let t;for await(const n of r)t=n;return t})();let e;for(const t of r)e=t;return e}class li extends Error{name;code;constructor(e,t,n){super(e),this.name=t,this.code=n}}let o1=class extends li{constructor(e="not a Unixfs node"){super(e,"NotUnixFSError","ERR_NOT_UNIXFS")}};class $s extends li{constructor(e="invalid PBNode"){super(e,"InvalidPBNodeError","ERR_INVALID_PB_NODE")}}class Z3 extends li{constructor(e="unknown error"){super(e,"InvalidPBNodeError","ERR_UNKNOWN_ERROR")}}class HE extends li{constructor(e="path already exists"){super(e,"AlreadyExistsError","ERR_ALREADY_EXISTS")}}class $K extends li{constructor(e="path does not exist"){super(e,"DoesNotExistError","ERR_DOES_NOT_EXIST")}}class qE extends li{constructor(e="no content"){super(e,"NoContentError","ERR_NO_CONTENT")}}class UK extends li{constructor(e="not a file"){super(e,"NotAFileError","ERR_NOT_A_FILE")}}class J3 extends li{constructor(e="not a directory"){super(e,"NotADirectoryError","ERR_NOT_A_DIRECTORY")}}let nn=class extends li{constructor(e="invalid parameters"){super(e,"InvalidParametersError","ERR_INVALID_PARAMETERS")}};const jl={cidVersion:1,rawLeaves:!0,layout:OE({maxChildrenPerNode:1024}),chunker:BE({chunkSize:1048576})};async function*e4(r,e,t={}){yield*s1(r,e,{...jl,...t})}async function FK(r,e,t={}){const{cid:n}=await LK(r,e,{...jl,...t});return n}async function VK(r,e,t={}){const{cid:n}=await OK(r,e,{...jl,...t});return n}async function zK(r,e,t={}){if(r.path==null)throw new nn("path is required");if(r.content==null)throw new nn("content is required");const n=await Ta(e4([r],e,{...jl,...t,wrapWithDirectory:!0}));if(n==null)throw new nn("Nothing imported");return n.cid}async function HK(r,e,t={}){if(r.content!=null)throw new nn("Directories cannot have content, use addFile instead");const i=await(r.path==null?Zg:Ta)(e4([{...r,path:r.path??"-"}],e,{...jl,...t,wrapWithDirectory:r.path!=null}));if(i==null)throw new nn("Nothing imported");return i.cid}class Ih extends Error{static name="BadPathError";static code="ERR_BAD_PATH";name=Ih.name;code=Ih.code;constructor(e="Bad path"){super(e)}}class ri extends Error{static name="NotFoundError";static code="ERR_NOT_FOUND";name=ri.name;code=ri.code;constructor(e="Not found"){super(e)}}class _h extends Error{static name="NoResolverError";static code="ERR_NO_RESOLVER";name=_h.name;code=_h.code;constructor(e="No resolver"){super(e)}}class Bt extends Error{static name="NotUnixFSError";static code="ERR_NOT_UNIXFS";name=Bt.name;code=Bt.code;constructor(e="Not UnixFS"){super(e)}}class Th extends Error{static name="OverReadError";static code="ERR_OVER_READ";name=Th.name;code=Th.code;constructor(e="Over read"){super(e)}}class Ph extends Error{static name="UnderReadError";static code="ERR_UNDER_READ";name=Ph.name;code=Ph.code;constructor(e="Under read"){super(e)}}class Rh extends Error{static name="NoPropError";static code="ERR_NO_PROP";name=Rh.name;code=Rh.code;constructor(e="No Property found"){super(e)}}class ds extends Error{static name="InvalidParametersError";static code="ERR_INVALID_PARAMS";name=ds.name;code=ds.code;constructor(e="Invalid parameters"){super(e)}}function t4(r,e,t,n,i,s,o){let a=r,c=i;for(;s.length>0;){const l=s[0];if(l in a){s.shift(),c=`${c}/${l}`;const u=ae.asCID(a[l]);if(u!=null)return{entry:{type:"object",name:n,path:i,cid:t,node:e,depth:o,size:BigInt(e.length),content:async function*(){yield r}},next:{cid:u,name:l,path:c,toResolve:s}};a=a[l]}else throw new Rh(`No property named ${l} found in node ${t}`)}return{entry:{type:"object",name:n,path:i,cid:t,node:e,depth:o,size:BigInt(e.length),content:async function*(){yield r}}}}const qK=async(r,e,t,n,i,s,o,a)=>{const c=await Jt(o.get(r,a)),l=Rw(c);return t4(l,c,r,e,t,n,s)},KK=async(r,e,t,n,i,s,o,a)=>{const c=await Jt(o.get(r,a)),l=Fg(c);return t4(l,c,r,e,t,n,s)};function Nh(r,e,t,n){const i=BigInt(r.length),s=BigInt(e+i);return t>=s||n<e?new Uint8Array(0):(n>=e&&n<s&&(r=r.subarray(0,Number(n-e))),t>=e&&t<s&&(r=r.subarray(Number(t-e))),r)}const r4=(r,e=0,t=r)=>{const n=BigInt(r),i=BigInt(e??0);let s=BigInt(t);if(s!==n&&(s=i+s),s>n&&(s=n),i<0n)throw new ds("Offset must be greater than or equal to 0");if(i>n)throw new ds("Offset must be less than the file size");if(s<0n)throw new ds("Length must be greater than or equal to 0");if(s>n)throw new ds("Length must be less than the file size");return{start:i,end:s}},WK=r=>{async function*e(t={}){const{start:n,end:i}=r4(r.length,t.offset,t.length),s=Nh(r,0n,n,i);t.onProgress?.(new oe("unixfs:exporter:progress:identity",{bytesRead:BigInt(s.byteLength),totalBytes:i-n,fileSize:BigInt(r.byteLength)})),yield s}return e},jK=async(r,e,t,n,i,s,o,a)=>{if(n.length>0)throw new ri(`No link named ${t} found in raw node ${r}`);const c=Zt(r.multihash.bytes);return{entry:{type:"identity",name:e,path:t,cid:r,content:WK(c.digest),depth:s,size:BigInt(c.digest.length),node:c.digest}}},GK=async(r,e,t,n,i,s,o,a)=>{const c=await Jt(o.get(r,a)),l=f8(c);return t4(l,c,r,e,t,n,s)},YK=r=>{async function*e(t={}){const{start:n,end:i}=r4(r.length,t.offset,t.length),s=Nh(r,0n,n,i);t.onProgress?.(new oe("unixfs:exporter:progress:raw",{bytesRead:BigInt(s.byteLength),totalBytes:i-n,fileSize:BigInt(r.byteLength)})),yield s}return e},QK=async(r,e,t,n,i,s,o,a)=>{if(n.length>0)throw new ri(`No link named ${t} found in raw node ${r}`);const c=await Jt(o.get(r,a));return{entry:{type:"raw",name:e,path:t,cid:r,content:YK(c),depth:s,size:BigInt(c.length),node:c}}},XK=async function(r){return(await i1.encode(r)).slice(0,8).reverse()},ZK=async(r,e,t)=>{const n=(e.tableSize()-1).toString(16).length;await Promise.all(r.map(async i=>{if(i.Name==null)throw new Error("Unexpected Link without a Name");if(i.Name.length===n){const s=parseInt(i.Name,16);e._putObjectAt(s,new er({hash:t._options.hash,bits:t._options.bits},e,s));return}await t.put(i.Name.substring(2),!0)}))},X5=(r,e)=>r.toString(16).toUpperCase().padStart(e,"0").substring(0,e),JK=r=>{let e=r.bucket;const t=[];for(;e._parent!=null;)t.push(e),e=e._parent;return t.push(e),t.reverse()},KE=async(r,e,t,n,i)=>{if(n==null){if(r.Data==null)throw new Bt("no data in PBNode");let d;try{d=Oe.unmarshal(r.Data)}catch(f){throw new Bt(f.message)}if(d.type!=="hamt-sharded-directory")throw new Bt("not a HAMT");if(d.fanout==null)throw new Bt("missing fanout");const h=X3({hashFn:XK,bits:Math.log2(Number(d.fanout))});n={rootBucket:h,hamtDepth:1,lastBucket:h}}const s=(n.lastBucket.tableSize()-1).toString(16).length;await ZK(r.Links,n.lastBucket,n.rootBucket);const o=await n.rootBucket._findNewBucketAndPos(e);let a=X5(o.pos,s);const c=JK(o);c.length>n.hamtDepth&&(n.lastBucket=c[n.hamtDepth],a=X5(n.lastBucket._posAtParent,s));const l=r.Links.find(d=>{if(d.Name==null)return!1;const h=d.Name.substring(0,s),f=d.Name.substring(s);return!(h!==a||f!==""&&f!==e)});if(l==null)return;if(l.Name!=null&&l.Name.substring(s)===e)return l.Hash;n.hamtDepth++;const u=await Jt(t.get(l.Hash,i));return r=cn(u),KE(r,e,t,n,i)};function n4(r){return r?.extended===!1}const eW=(r,e,t,n,i,s,o)=>{async function*a(c={}){const l=c.offset??0,u=c.length??e.Links.length,d=e.Links.slice(l,u);c.onProgress?.(new oe("unixfs:exporter:walk:directory",{cid:r})),yield*zs(d,h=>Ki(h,f=>async()=>{const y=f.Name??"",m=`${n}/${y}`;return n4(c)?{cid:f.Hash,name:y,path:m}:(await i(f.Hash,y,m,[],s+1,o,c)).entry}),h=>Ys(h,{ordered:!0,concurrency:c.blockReadConcurrency}),h=>bi(h,f=>f!=null))}return a};async function WE(r,e,t,n,i,s,o){if(e instanceof Uint8Array){const l=Nh(e,n,i,s);t.push(l);return}if(e.Data==null)throw new Bt("no data in PBNode");let a;try{a=Oe.unmarshal(e.Data)}catch(l){throw new Bt(l.message)}if(a.data!=null){const l=a.data,u=Nh(l,n,i,s);t.push(u),n+=BigInt(u.byteLength)}const c=[];if(e.Links.length!==a.blockSizes.length)throw new Bt("Inconsistent block sizes and dag links");for(let l=0;l<e.Links.length;l++){const u=e.Links[l],d=n,h=d+a.blockSizes[l];if((i>=d&&i<h||s>=d&&s<=h||i<d&&s>h)&&c.push({link:u,blockStart:n}),n=h,n>s)break}await zs(c,l=>Ki(l,u=>async()=>{const d=await Jt(r.get(u.link.Hash,o));return{...u,block:d}}),l=>Ys(l,{ordered:!0,concurrency:o.blockReadConcurrency}),async l=>{for await(const{link:u,block:d,blockStart:h}of l){let f;switch(u.Hash.code){case Rn:f=cn(d);break;case sn:f=d;break;default:t.end(new Bt(`Unsupported codec: ${u.Hash.code}`));return}const y=new Fp({concurrency:1});y.on("error",m=>{t.end(m)}),y.add(async()=>{o.onProgress?.(new oe("unixfs:exporter:walk:file",{cid:u.Hash})),await WE(r,f,t,h,i,s,o)}),await y.onIdle()}}),n>=s&&t.end()}const Z5=(r,e,t,n,i,s,o)=>{async function*a(c={}){const l=t.fileSize();if(l===void 0)throw new Error("File was a directory");const{start:u,end:d}=r4(l,c.offset,c.length);if(d===0n)return;let h=0n;const f=d-u,y=ii();c.onProgress?.(new oe("unixfs:exporter:walk:file",{cid:r})),WE(o,e,y,0n,u,d,c).catch(m=>{y.end(m)});for await(const m of y)if(m!=null){if(h+=BigInt(m.byteLength),h>f)throw y.end(),new Th("Read too many bytes - the file size reported by the UnixFS data in the root node may be incorrect");h===f&&y.end(),c.onProgress?.(new oe("unixfs:exporter:progress:unixfs:file",{bytesRead:h,totalBytes:f,fileSize:l})),yield m}if(h<f)throw new Ph("Traversed entire DAG but did not read enough bytes")}return a},tW=(r,e,t,n,i,s,o)=>{function a(c={}){return c.onProgress?.(new oe("unixfs:exporter:walk:hamt-sharded-directory",{cid:r})),jE(e,n,i,s,o,c)}return a};async function*jE(r,e,t,n,i,s){const o=r.Links;if(r.Data==null)throw new Bt("no data in PBNode");let a;try{a=Oe.unmarshal(r.Data)}catch(u){throw new Bt(u.message)}if(a.fanout==null)throw new Bt("missing fanout");const c=(a.fanout-1n).toString(16).length,l=zs(o,u=>Ki(u,d=>async()=>{const h=d.Name!=null?d.Name.substring(c):null;if(h!=null&&h!==""){const f=`${e}/${h}`;return n4(s)?{entries:[{cid:d.Hash,name:h,path:f}]}:{entries:[(await t(d.Hash,h,f,[],n+1,i,s)).entry].filter(Boolean)}}else{const f=await Jt(i.get(d.Hash,s));return r=cn(f),s.onProgress?.(new oe("unixfs:exporter:walk:hamt-sharded-directory",{cid:d.Hash})),{entries:jE(r,e,t,n,i,s)}}}),u=>Ys(u,{ordered:!0,concurrency:s.blockReadConcurrency}));for await(const{entries:u}of l)yield*u}const rW=(r,e)=>r.Links.find(n=>n.Name===e)?.Hash,nW={raw:Z5,file:Z5,directory:eW,"hamt-sharded-directory":tW,metadata:(r,e,t,n,i,s,o)=>()=>[],symlink:(r,e,t,n,i,s,o)=>()=>[]},iW=async(r,e,t,n,i,s,o,a)=>{if(n4(a)&&n.length===0)return{entry:{cid:r,name:e,path:t}};const c=await Jt(o.get(r,a));let l;try{l=cn(c)}catch(f){throw new Bt(f.message)}let u,d;if(e==null&&(e=r.toString()),l.Data==null)throw new Bt("no data in PBNode");try{u=Oe.unmarshal(l.Data)}catch(f){throw new Bt(f.message)}if(t==null&&(t=e),n.length>0){let f;if(u?.type==="hamt-sharded-directory"?f=await KE(l,n[0],o):f=rW(l,n[0]),f==null)throw new ri("file does not exist");const y=n.shift(),m=`${t}/${y}`;d={cid:f,toResolve:n,name:y??"",path:m}}const h=nW[u.type](r,l,u,t,i,s,o);if(h==null)throw new ri("could not find content exporter");return u.isDirectory()?{entry:{type:"directory",name:e,path:t,cid:r,content:h,unixfs:u,depth:s,node:l,size:u.fileSize()},next:d}:{entry:{type:"file",name:e,path:t,cid:r,content:h,unixfs:u,depth:s,node:l,size:u.fileSize()},next:d}},sW={[Rn]:iW,[sn]:QK,[$g]:qK,[Ug]:KK,[jn.code]:jK,[Vp]:GK},GE=async(r,e,t,n,i,s,o)=>{const a=sW[r.code];if(a==null)throw new _h(`No resolver for code ${r.code}`);return a(r,e,t,n,GE,i,s,o)},oW=(r="")=>(r.trim().match(/([^\\^/]|\\\/)+/g)??[]).filter(Boolean),aW=r=>{if(r instanceof Uint8Array)return{cid:ae.decode(r),toResolve:[]};const e=ae.asCID(r);if(e!=null)return{cid:e,toResolve:[]};if(typeof r=="string"){r.indexOf("/ipfs/")===0&&(r=r.substring(6));const t=oW(r);return{cid:ae.parse(t[0]),toResolve:t.slice(1)}}throw new Ih(`Unknown path type ${r}`)};async function*YE(r,e,t={}){let{cid:n,toResolve:i}=aW(r),s=n.toString(),o=s;const a=i.length;for(;;){const c=await GE(n,s,o,i,a,e,t);if(c.entry==null&&c.next==null)throw new ri(`Could not resolve ${r}`);if(c.entry!=null&&(yield c.entry),c.next==null)return;i=c.next.toResolve,n=c.next.cid,s=c.next.name,o=c.next.path}}async function Gi(r,e,t={}){const n=await Ta(YE(r,e,t));if(n==null)throw new ri(`Could not resolve ${r}`);return n}async function*QE(r,e,t={}){const n=await Gi(r,e,t);if(n==null)return;if(yield n,n.type==="directory")for await(const s of i(n,t))yield s;async function*i(s,o){for await(const a of s.content(o))yield a,!(a instanceof Uint8Array)&&a.type==="directory"&&(yield*i(a,o))}}const XE=1,ZE=262144;function JE(r){function e(t){return t instanceof J5?t:new J5(t,r)}return e}class J5{_value;_hashFn;_depth;_availableBits;_currentBufferIndex;_buffers;constructor(e,t){if(!(e instanceof Uint8Array))throw new Error("can only hash Uint8Arrays");this._value=e,this._hashFn=t,this._depth=-1,this._availableBits=0,this._currentBufferIndex=0,this._buffers=[]}async take(e){let t=e;for(;this._availableBits<t;)await this._produceMoreBits();let n=0;for(;t>0;){const i=this._buffers[this._currentBufferIndex],s=Math.min(i.availableBits(),t),o=i.take(s);n=(n<<s)+o,t-=s,this._availableBits-=s,i.availableBits()===0&&this._currentBufferIndex++}return n}untake(e){let t=e;for(;t>0;){const n=this._buffers[this._currentBufferIndex],i=Math.min(n.totalBits()-n.availableBits(),t);n.untake(i),t-=i,this._availableBits+=i,this._currentBufferIndex>0&&n.totalBits()===n.availableBits()&&(this._depth--,this._currentBufferIndex--)}}async _produceMoreBits(){this._depth++;const e=this._depth>0?Ot([this._value,Uint8Array.from([this._depth])]):this._value,t=await this._hashFn(e),n=new uW(t);this._buffers.push(n),this._availableBits+=n.availableBits()}}const cW=[255,254,252,248,240,224,192,128],lW=[1,3,7,15,31,63,127,255];class uW{_value;_currentBytePos;_currentBitPos;constructor(e){this._value=e,this._currentBytePos=e.length-1,this._currentBitPos=7}availableBits(){return this._currentBitPos+1+this._currentBytePos*8}totalBits(){return this._value.length*8}take(e){let t=e,n=0;for(;t>0&&this._haveBits();){const i=this._value[this._currentBytePos],s=this._currentBitPos+1,o=Math.min(s,t),a=dW(i,s-o,o);n=(n<<o)+a,t-=o,this._currentBitPos-=o,this._currentBitPos<0&&(this._currentBitPos=7,this._currentBytePos--)}return n}untake(e){for(this._currentBitPos+=e;this._currentBitPos>7;)this._currentBitPos-=8,this._currentBytePos+=1}_haveBits(){return this._currentBytePos>=0}}function dW(r,e,t){const n=hW(e,t);return(r&n)>>>e}function hW(r,e){return cW[r]&lW[Math.min(e+r-1,7)]}const i4=BigInt(i1.code),Pc=8;async function s4(r){return(await i1.encode(r)).subarray(0,8).reverse()}const Pa=async(r,e,t)=>{t.codec==null&&(t.codec=kl);const n=await Et.digest(r),i=ae.create(t.cidVersion??XE,t.codec.code,n);return await e.put(i,r,{...t,signal:t.signal}),i};class fW{options;root;dir;path;dirty;flat;parent;parentKey;unixfs;mode;mtime;cid;size;nodeSize;constructor(e,t){this.options=t??{},this.root=e.root,this.dir=e.dir,this.path=e.path,this.dirty=e.dirty,this.flat=e.flat,this.parent=e.parent,this.parentKey=e.parentKey,this.unixfs=e.unixfs,this.mode=e.mode,this.mtime=e.mtime}}class pW extends fW{_bucket;constructor(e,t){super(e,t),this._bucket=X3({hashFn:s4,bits:8})}async put(e,t){this.cid=void 0,this.size=void 0,this.nodeSize=void 0,await this._bucket.put(e,t)}async get(e){return this._bucket.get(e)}childCount(){return this._bucket.leafCount()}directChildrenCount(){return this._bucket.childrenCount()}onlyChild(){return this._bucket.onlyChild()}async*eachChildSeries(){for(const{key:e,value:t}of this._bucket.eachLeafSeries())yield{key:e,child:t}}estimateNodeSize(){return this.nodeSize!==void 0?this.nodeSize:(this.nodeSize=tS(this._bucket,this,this.options),this.nodeSize)}async*flush(e){for await(const t of eS(this._bucket,e,this,this.options))yield{...t,path:this.path}}}async function*eS(r,e,t,n){const i=r._children,s=[];let o=0n;for(let f=0;f<i.length;f++){const y=i.get(f);if(y==null)continue;const m=f.toString(16).toUpperCase().padStart(2,"0");if(y instanceof er){let p;for await(const b of eS(y,e,null,n))p=b;if(p==null)throw new Error("Could not flush sharded directory, no sub-shard found");s.push({Name:m,Tsize:Number(p.size),Hash:p.cid}),o+=p.size}else if(gW(y.value)){const p=y.value;let b;for await(const v of p.flush(e))b=v,yield b;if(b==null)throw new Error("Did not flush dir");const A=m+y.key;s.push({Name:A,Tsize:Number(b.size),Hash:b.cid}),o+=b.size}else{const p=y.value;if(p.cid==null)continue;const b=m+y.key,A=p.size;s.push({Name:b,Tsize:Number(A),Hash:p.cid}),o+=BigInt(A??0)}}const a=Uint8Array.from(i.bitField().reverse()),c=new Oe({type:"hamt-sharded-directory",data:a,fanout:BigInt(r.tableSize()),hashType:i4,mtime:t?.mtime,mode:t?.mode}),l={Data:c.marshal(),Links:s},u=pt(kr(l)),d=await Pa(u,e,n),h=BigInt(u.byteLength)+o;yield{cid:d,unixfs:c,size:h}}function gW(r){return typeof r.flush=="function"}function tS(r,e,t){const n=r._children,i=[];for(let c=0;c<n.length;c++){const l=n.get(c);if(l==null)continue;const u=c.toString(16).toUpperCase().padStart(2,"0");if(l instanceof er){const d=tS(l,null,t);i.push({Name:u,Tsize:Number(d),Hash:t.cidVersion===0?Np:Dp})}else if(typeof l.value.flush=="function"){const h=l.value.nodeSize();i.push({Name:u+l.key,Tsize:Number(h),Hash:t.cidVersion===0?Np:Dp})}else{const d=l.value;if(d.cid==null)continue;const h=u+l.key,f=d.size;i.push({Name:h,Tsize:Number(f),Hash:d.cid})}}const s=Uint8Array.from(n.bitField().reverse()),o=new Oe({type:"hamt-sharded-directory",data:s,fanout:BigInt(r.tableSize()),hashType:i4,mtime:e?.mtime,mode:e?.mode});return pt(kr({Data:o.marshal(),Links:i})).length}const Np=ae.parse("QmUNLLsPACCz1vLxQVkXqqLX5R1X345qqfHbsf67hvA3Nn"),Dp=ae.parse("zdj7WbTaiJT1fgatdet9Ei9iDB5hdCxkbVyhyh8YTUnXMiwYi"),Bp=Xt("helia:unixfs:commands:utils:hamt-utils"),Lp=r=>r.toString(16).toUpperCase().padStart(2,"0").substring(0,2),mW=async(r,e,t)=>{const n=new pW({root:!0,dir:!0,parent:void 0,parentKey:void 0,path:"",dirty:!0,flat:!1,mtime:t.mtime,mode:t.mode},t);for(let s=0;s<e.length;s++)await n._bucket.put(e[s].name,{size:e[s].size,cid:e[s].cid});const i=await Ta(n.flush(r));if(i==null)throw new Error("Flushing shard yielded no result");return i},rS=async(r,e,t)=>{const n=Oe.unmarshal(r[0].node.Data??new Uint8Array(0)),i=BigInt(Math.pow(2,Pc));r.reverse();let s,o;for(let a=0;a<r.length;a++){const c=a===r.length-1,l=r[a],u=Uint8Array.from(l.children.bitField().reverse()),d=new Oe({type:"hamt-sharded-directory",data:u,fanout:i,hashType:i4});c&&(d.mtime=n.mtime,d.mode=n.mode),o={Data:d.marshal(),Links:l.node.Links};const h=pt(kr(o));if(s=await Pa(h,e,t),!c){const f=r[a+1];if(f==null)throw new Error("Was not operating on shard root but also had no parent?");Bp("updating link in parent sub-shard with prefix %s",f.prefix),f.node.Links=f.node.Links.filter(y=>y.Name!==f.prefix),f.node.Links.push({Name:f.prefix,Hash:s,Tsize:l.node.Links.reduce((y,m)=>y+(m.Tsize??0),h.byteLength)})}}if(s==null||o==null)throw new Error("Noting persisted");return{cid:s,node:o}},nS=async(r,e,t,n)=>{const s=JE(s4)(W(e)),o=[];for(;;){const a=await Jt(t.get(r,n)),c=cn(a),l=new Ch,u=await s.take(Pc),d=Lp(u);o.push({prefix:d,children:l,node:c});let h;for(const y of c.Links){const m=y.Name??"";if(m.length<2)throw new Error("Invalid HAMT - link name was too short");const p=parseInt(m.substring(0,2),16);l.set(p,!0),m.startsWith(d)&&(h=y)}if(h==null){Bp("no link found with prefix %s for %s",d,e);break}const f=h.Name??"";if(f.length<2)throw new Error("Invalid HAMT - link name was too short");if(f.length===2){r=h.Hash,Bp("descend into sub-shard with prefix %s",f);continue}break}return{path:o,hash:s}};async function iS(r,e,t,n){if(r.Data==null)throw new Error("DagPB node had no data");const i=Oe.unmarshal(r.Data);let s;if(i.type==="directory")s=yW(r);else if(i.type==="hamt-sharded-directory")s=await sS(r,0,t,e,n);else throw new Error("Can only estimate the size of directories or shards");return s>t}function yW(r){let e=0;for(const t of r.Links)e+=(t.Name??"").length,e+=t.Hash.version===1?Dp.bytes.byteLength:Np.bytes.byteLength;return e}async function sS(r,e,t,n,i){if(e>t)return t;if(r.Data==null||!Oe.unmarshal(r.Data).isDirectory())return e;for(const o of r.Links){let a=o.Name??"";if(a=a.substring(2),e+=a.length,e+=o.Hash.bytes.byteLength,o.Hash.code===Rn){const c=await Jt(n.get(o.Hash,i)),l=cn(c);e+=await sS(l,e,t,n,i)}}return e}const yn=Xt("helia:unixfs:components:utils:add-link");async function o4(r,e,t,n){if(r.node.Data==null)throw new nn("Invalid parent passed to addLink");if(Oe.unmarshal(r.node.Data).type==="hamt-sharded-directory")return yn("adding link to sharded directory"),vW(r,e,t,n);yn(`adding ${e.Name} (${e.Hash}) to regular directory`);const s=await bW(r,e,t,n);if(await iS(s.node,t,n.shardSplitThresholdBytes??ZE,n)){yn("converting directory to sharded directory");const o=await wW(s,t);s.cid=o.cid,s.node=cn(await Jt(t.get(o.cid,n)))}return s}const wW=async(r,e)=>{if(r.node.Data==null)throw new nn("Invalid parent passed to convertToShardedDirectory");const t=Oe.unmarshal(r.node.Data),n=await mW(e,r.node.Links.map(i=>({name:i.Name??"",size:BigInt(i.Tsize??0),cid:i.Hash})),{mode:t.mode,mtime:t.mtime,cidVersion:r.cid.version});return yn(`converted directory to sharded directory ${n.cid}`),n},bW=async(r,e,t,n)=>{const i=r.node.Links.filter(u=>{const d=u.Name===e.Name;if(d&&!n.allowOverwriting)throw new HE;return!d});if(i.push(e),r.node.Data==null)throw new $s("Parent node with no data passed to addToDirectory");const s=Oe.unmarshal(r.node.Data);let o;if(s.mtime!=null){const u=Date.now(),d=Math.floor(u/1e3);s.mtime={secs:BigInt(d),nsecs:(u-d*1e3)*1e3},o=s.marshal()}else o=r.node.Data;r.node=kr({Data:o,Links:i});const a=pt(r.node),c=await Et.digest(a),l=ae.create(r.cid.version,Rn,c);return await t.put(l,a),{node:r.node,cid:l}},vW=async(r,e,t,n)=>{const{path:i,hash:s}=await nS(r.cid,e.Name,t,n),o=i[i.length-1];if(o==null)throw new Error("Invalid HAMT, could not generate path");const a=o.prefix,c=parseInt(a,16);yn("next prefix for %s is %s",e.Name,a);const l=`${a}${e.Name}`,u=o.node.Links.find(d=>(d.Name??"").startsWith(a));if(u!=null)if(yn("link %s was present in shard",l),u.Name===l){if(!n.allowOverwriting)throw new HE;yn("overwriting %s in sub-shard",e.Name),o.node.Links=o.node.Links.filter(d=>d.Name!==l),o.node.Links.push({Name:l,Hash:e.Hash,Tsize:e.Tsize})}else{if(u.Name?.length===2)throw new Error("Existing link was sub-shard?!");{yn("prefix %s already exists, creating new sub-shard",a);const d=o.node.Links.findIndex(p=>p.Name?.startsWith(a)),h=o.node.Links.splice(d,1)[0],f=(h.Name??"").substring(2),m=JE(s4)(W(f));for(let p=0;p<i.length;p++)await m.take(Pc);for(;;){const p=await m.take(Pc),b=Lp(p);h.Name=`${b}${f}`;const A=await s.take(Pc),v=Lp(A);if(b===v){const T=new Ch;T.set(A,!0),i.push({prefix:v,children:T,node:{Links:[]}});continue}const C=new Ch;C.set(A,!0),C.set(p,!0),i.push({prefix:a,children:C,node:{Links:[h,{Name:`${v}${e.Name}`,Hash:e.Hash,Tsize:e.Tsize}]}});break}}}else yn("link %s was not present in sub-shard",l),e.Name=l,o.node.Links.push(e),o.children.set(c,!0),yn("adding %s to existing sub-shard",l);return rS(i,t,n)};async function a1(r,e,t={}){const n=await Gi(r,e,t);if(n.type!=="directory")throw new J3(`${r.toString()} was not a UnixFS directory`);return{cid:r,node:n.node}}async function a4(r,e,t,n){const i=await Gi(r,t,n);if(i.type!=="directory"&&i.type!=="file"&&i.type!=="raw")throw new o1(`${r.toString()} was not a UnixFS node`);return{Name:e,Tsize:i.node instanceof Uint8Array?i.node.byteLength:EW(i.node),Hash:r}}function EW(r){const e=r.Links.reduce((t,n)=>t+(n.Tsize??0),0);return pt(r).byteLength+e}const SW=Xt("helia:unixfs:components:utils:resolve");async function Gl(r,e,t,n){if(e==null||e==="")return{cid:r};const i=`/ipfs/${r}${e==null?"":`/${e}`}`,s=await Vo(YE(i,t,n));if(s.length===0)throw new $K("Could not find path in directory");return SW("resolved %s to %c",e,r),{cid:s[s.length-1].cid,path:e,segments:s}}async function Dh(r,e,t,n){if(e.segments==null||e.segments.length===0)return r;let i=e.segments.pop();if(i==null)throw new Error("Insufficient segments");i.cid=r,e.segments.reverse();for(const s of e.segments){const[o,a]=await Promise.all([a1(s.cid,t,n),a4(i.cid,i.name,t,n)]);r=(await o4(o,a,t,{...n,allowOverwriting:!0,cidVersion:r.version})).cid,s.cid=r,i=s}return r}async function*xW(r,e,t={}){const n=await Gl(r,t.path,e,t),i=await Gi(n.cid,e,t);if(i.type!=="file"&&i.type!=="raw")throw new UK;if(i.content==null)throw new qE;yield*i.content(t)}const AW=Xt("helia:unixfs:chmod");async function kW(r,e,t,n={}){const i=await Gl(r,n.path,t,n);if(AW("chmod %c %d",i.cid,e),n.recursive===!0){const d=await zs(async function*(){for await(const h of QE(i.cid,t,n)){let f,y=[];if(h.type==="raw")f=new Oe({type:"file",data:h.node});else if(h.type==="file"||h.type==="directory")f=h.unixfs,y=h.node.Links;else throw new o1;f.mode=e;const m={Data:f.marshal(),Links:y};yield{path:h.path,content:m}}},h=>s1(h,t,{...n,dagBuilder:async function*(f,y){for await(const m of f)yield async function(){const p=m.content,b=pt(p),A=await Pa(b,y,{...n,cidVersion:r.version});if(p.Data==null)throw new $s(`${A} had no data`);const v=Oe.unmarshal(p.Data);return{cid:A,size:BigInt(b.length),path:m.path,unixfs:v}}}}),async h=>Ta(h));if(d==null)throw new Z3(`Could not chmod ${i.cid.toString()}`);return Dh(d.cid,i,t,n)}const s=await Jt(t.get(i.cid,n));let o,a=[];if(i.cid.code===sn)o=new Oe({type:"file",data:s});else{const d=cn(s);if(d.Data==null)throw new $s(`${i.cid.toString()} had no data`);a=d.Links,o=Oe.unmarshal(d.Data)}o.mode=e;const c=pt({Data:o.marshal(),Links:a}),l=await Et.digest(c),u=ae.create(i.cid.version,Rn,l);return await t.put(u,c),Dh(u,i,t,n)}const CW=Xt("helia:unixfs:cp");async function IW(r,e,t,n,i={}){if(t.includes("/"))throw new nn("Name must not have slashes");const[s,o]=await Promise.all([a1(e,n,i),a4(r,t,n,i)]);return CW('Adding %c as "%s" to %c',r,t,e),(await o4(s,o,n,{allowOverwriting:i.force,cidVersion:e.version,...i})).cid}async function*_W(r,e,t={}){const n=await Gl(r,t.path,e,t),i=await Gi(n.cid,e,{...t,extended:!0});if(i.type==="file"||i.type==="raw"){t.extended===!1?yield{name:i.name,path:i.path,cid:i.cid}:yield i;return}if(i.content==null)throw new qE;if(i.type!=="directory")throw new J3;yield*i.content(t)}const e8=Xt("helia:unixfs:mkdir");async function TW(r,e,t,n={}){if(e.includes("/"))throw new nn("Path must not have slashes");if((await Gi(r,t,n)).type!=="directory")throw new J3(`${r.toString()} was not a UnixFS directory`);e8("creating %s",e);const o={Data:new Oe({type:"directory",mode:n.mode,mtime:n.mtime}).marshal(),Links:[]},a=pt(o),c=await Et.digest(a),l=ae.create(n.cidVersion??XE,Rn,c);await t.put(l,a);const[u,d]=await Promise.all([a1(r,t,n),a4(l,e,t,n)]);return e8("adding empty dir called %s to %c",e,r),(await o4(u,d,t,{...n,allowOverwriting:n.force})).cid}const Gu=Xt("helia:unixfs:utils:remove-link");async function PW(r,e,t,n){if(r.node.Data==null)throw new $s("Parent node had no data");if(Oe.unmarshal(r.node.Data).type==="hamt-sharded-directory"){Gu(`removing ${e} from sharded directory`);const s=await NW(r,e,t,n);return await iS(s.node,t,n.shardSplitThresholdBytes??ZE,n)?s:(Gu("converting shard to flat directory %c",r.cid),DW(s,t,n))}return Gu(`removing link ${e} regular directory`),RW(r,e,t,n)}const RW=async(r,e,t,n)=>{r.node.Links=r.node.Links.filter(o=>o.Name!==e);const i=pt(r.node),s=await Pa(i,t,{...n,cidVersion:r.cid.version});return Gu(`Updated regular directory ${s}`),{node:r.node,cid:s}},NW=async(r,e,t,n)=>{const{path:i}=await nS(r.cid,e,t,n),s=i[i.length-1];if(s==null)throw new Error("Invalid HAMT, could not generate path");const o=s.node.Links.filter(l=>(l.Name??"").substring(2)===e).map(l=>l.Name).pop();if(o==null)throw new Error("File not found");const a=o.substring(0,2),c=parseInt(a,16);if(s.node.Links=s.node.Links.filter(l=>l.Name!==o),s.children.unset(c),s.node.Links.length===1)for(;i.length!==1;){const l=i[i.length-1];if(l==null||l.node.Links.length>1)break;i.pop();const u=i[i.length-1];if(u==null)break;const d=l.node.Links[0];u.node.Links=u.node.Links.filter(h=>!(h.Name??"").startsWith(u.prefix)),u.node.Links.push({Hash:d.Hash,Name:`${u.prefix}${(d.Name??"").substring(2)}`,Tsize:d.Tsize})}return rS(i,t,n)},DW=async(r,e,t)=>{if(r.node.Data==null)throw new nn("Invalid parent passed to convertToFlatDirectory");const n={Links:[]},i=await Gi(r.cid,e);if(i.type!=="directory")throw new Error("Unexpected node type");for await(const c of i.content()){let l=0;c.node instanceof Uint8Array?l=c.node.byteLength:l=pt(c.node).length,n.Links.push({Hash:c.cid,Name:c.name,Tsize:l})}const s=Oe.unmarshal(r.node.Data);n.Data=new Oe({type:"directory",mode:s.mode,mtime:s.mtime}).marshal();const o=pt(kr(n));return{cid:await Pa(o,e,{codec:kl,cidVersion:r.cid.version,signal:t.signal}),node:n}},BW=Xt("helia:unixfs:rm");async function LW(r,e,t,n={}){if(e.includes("/"))throw new nn("Name must not have slashes");const i=await a1(r,t,n);return BW("Removing %s from %c",e,r),(await PW(i,e,t,{...n,cidVersion:r.version})).cid}const oS=1877,c1=1604,OW=Xt("helia:unixfs:stat");async function MW(r,e,t={}){const n=await Gl(r,t.path,e,t);OW("stat %c",n.cid);const i=await Gi(n.cid,e,t);if(i.type==="raw")return t.extended===!0?VW(i):FW(i);if(i.type==="file"||i.type==="directory")return t.extended===!0?UW(i,e,t.filter??new C7({filterSize:1024}),t):$W(i);throw new o1}function $W(r){return{type:r.type,cid:r.cid,unixfs:r.unixfs,mode:r.unixfs.mode??(r.unixfs.isDirectory()?oS:c1),mtime:r.unixfs.mtime,size:r.unixfs.fileSize()}}async function UW(r,e,t,n){const i=await aS(r.cid,e,!1,t,n);return{type:r.type,cid:r.cid,unixfs:r.unixfs,size:r.unixfs.isDirectory()?i.dirSize:r.unixfs.fileSize(),mode:r.unixfs.mode??(r.unixfs.isDirectory()?oS:c1),mtime:r.unixfs.mtime,localSize:i.localSize,dagSize:i.dagSize,deduplicatedDagSize:i.deduplicatedDagSize,blocks:i.blocks,uniqueBlocks:i.uniqueBlocks}}function FW(r){return{type:r.type,cid:r.cid,unixfs:void 0,mode:c1,mtime:void 0,size:BigInt(r.node.byteLength)}}function VW(r){return{type:r.type,cid:r.cid,unixfs:void 0,mode:c1,mtime:void 0,size:BigInt(r.node.byteLength),localSize:BigInt(r.node.byteLength),dagSize:BigInt(r.node.byteLength),deduplicatedDagSize:BigInt(r.node.byteLength),blocks:1n,uniqueBlocks:1n}}async function aS(r,e,t,n,i){const s={dirSize:0n,localSize:0n,dagSize:0n,deduplicatedDagSize:0n,blocks:0n,uniqueBlocks:0n};try{const o=n.has(r.bytes);n.add(r.bytes);const a=await Jt(e.get(r,i));if(s.blocks++,s.dagSize+=BigInt(a.byteLength),o||(s.uniqueBlocks++,s.deduplicatedDagSize+=BigInt(a.byteLength)),r.code===sn)s.localSize+=BigInt(a.byteLength),t&&(s.dirSize+=BigInt(a.byteLength));else if(r.code===Rn){const c=cn(a);let l;if(c.Data!=null&&(l=Oe.unmarshal(c.Data)),c.Links.length>0){for(const u of c.Links){const d=await aS(u.Hash,e,zW(u,l),n,i);s.localSize+=d.localSize,s.dagSize+=d.dagSize,s.deduplicatedDagSize+=d.deduplicatedDagSize,s.blocks+=d.blocks,s.uniqueBlocks+=d.uniqueBlocks,s.dirSize+=d.dirSize}t&&l!=null&&(s.dirSize+=l.fileSize())}else{if(l==null)throw new $s(`PBNode ${r.toString()} had no data`);l.data!=null&&(s.localSize+=BigInt(l.data.byteLength??0)),t&&(s.dirSize+=l.fileSize())}}else throw new Z3(`${r.toString()} was neither DAG_PB nor RAW`)}catch(o){if(o.name!=="NotFoundError"&&o.name!=="BlockNotFoundWhileOfflineError"||i.offline!==!0)throw o}return s}function zW(r,e){if(e==null)return!1;const t=r.Name;return t==null?!1:e.type==="directory"?!0:e.type==="hamt-sharded-directory"&&t.length>2}const HW=Xt("helia:unixfs:touch");async function qW(r,e,t={}){const n=await Gl(r,t.path,e,t),i=t.mtime??{secs:BigInt(Math.round(Date.now()/1e3)),nsecs:0};if(HW("touch %c %o",n.cid,i),t.recursive){const d=await zs(async function*(){for await(const h of QE(n.cid,e)){let f,y;if(h.type==="raw")f=new Oe({data:h.node}),y=[];else if(h.type==="file"||h.type==="directory")f=h.unixfs,y=h.node.Links;else throw new o1;f.mtime=i;const m={Data:f.marshal(),Links:y};yield{path:h.path,content:m}}},h=>s1(h,e,{...t,dagBuilder:async function*(f,y){for await(const m of f)yield async function(){const p=m.content,b=pt(p),A=await Pa(b,y,{...t,cidVersion:r.version});if(p.Data==null)throw new $s(`${A} had no data`);const v=Oe.unmarshal(p.Data);return{cid:A,size:BigInt(b.length),path:m.path,unixfs:v}}}}),async h=>Ta(h));if(d==null)throw new Z3(`Could not chmod ${n.cid.toString()}`);return Dh(d.cid,n,e,t)}const s=await Jt(e.get(n.cid,t));let o,a=[];if(n.cid.code===sn)o=new Oe({data:s});else{const d=cn(s);if(a=d.Links,d.Data==null)throw new $s(`${n.cid.toString()} had no data`);o=Oe.unmarshal(d.Data)}o.mtime=i;const c=pt({Data:o.marshal(),Links:a}),l=await Et.digest(c),u=ae.create(n.cid.version,Rn,l);return await e.put(u,c),Dh(u,n,e,t)}class KW{components;constructor(e){this.components=e}async*addAll(e,t={}){yield*e4(e,this.components.blockstore,t)}async addBytes(e,t={}){return FK(e,this.components.blockstore,t)}async addByteStream(e,t={}){return VK(e,this.components.blockstore,t)}async addFile(e,t={}){return zK(e,this.components.blockstore,t)}async addDirectory(e={},t={}){return HK(e,this.components.blockstore,t)}async*cat(e,t={}){yield*xW(e,this.components.blockstore,t)}async chmod(e,t,n={}){return kW(e,t,this.components.blockstore,n)}async cp(e,t,n,i={}){return IW(e,t,n,this.components.blockstore,i)}async*ls(e,t={}){yield*_W(e,this.components.blockstore,t)}async mkdir(e,t,n={}){return TW(e,t,this.components.blockstore,n)}async rm(e,t,n={}){return LW(e,t,this.components.blockstore,n)}async stat(e,t={}){return MW(e,this.components.blockstore,t)}async touch(e,t={}){return qW(e,this.components.blockstore,t)}}function WW(r){return new KW(r)}window.createHelia=Yq;window.unixfs=WW;window.createLibp2p=V9;window.webSockets=RE;window.webRTC=PE;window.circuitRelayTransport=iv;window.noise=d3;window.yamux=Jb;window.identify=Ev;window.bootstrap=ev;console.log("Vendor bundle cargado");
